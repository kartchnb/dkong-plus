0001   0000             ; Adding a secret stage to Donkey Kong...
0002   0000             
0003   0000             #include "vars+.h"
0001+  0000             
0002+  0000             LADDER_TILE							= 0
0003+  0000             BRK_LADDER_TILE						= 1
0004+  0000             SLP_GIRDER_TILE						= 2
0005+  0000             SQR_GIRDER_TILE						= 3
0006+  0000             BLANK_TILE							= 4
0007+  0000             CIR_GIRDER_TILE						= 5
0008+  0000             X_TILE								= 6
0009+  0000             
0010+  0000             NUM_PLAYS	                 		= $6001		; The number of game plays that have been paid for
0011+  0000             NUM_COINS_PENDING           		= $6002  	; Keeps track of the number of coins entered until there are enough for a credit
0012+  0000             COIN_VALID                    		= $6003  	; Prevents 1 coin entry from being processed more than once
0013+  0000             
0014+  0000             GAME_STATE             				= $6005  
0015+  0000             GAME_STATE_INIT							= 0		; Preparing the game
0016+  0000             GAME_STATE_ATTRACT						= 1		; Running attract mode
0017+  0000             GAME_STATE_COIN							= 2		; Coin(s) inserted, waiting for player to push start
0018+  0000             GAME_STATE_PLAY							= 3		; The game is being played
0019+  0000                 
0020+  0000             NO_COINS_INSERTED           		= $6007  	; becomes 0 when a coin is inserted
0021+  0000             MAJOR_TIMER                 		= $6008
0022+  0000             MINOR_TIMER                 		= $6009
0023+  0000             
0024+  0000             GAME_SUBSTATE						= $600a
0025+  0000             ; If GAME_STATE == GAME_STATE_ATTRACT
0026+  0000             GAME_SUBSTATE_ATTRACT_COIN				= 0		; Display insert coin screen
0027+  0000             GAME_SUBSTATE_ATTRACT_INIT				= 1		; Initialize the attract mode
0028+  0000             GAME_SUBSTATE_ATTRACT_MARIO		 		= 2 	; Initialize the Mario sprite 
0029+  0000             GAME_SUBSTATE_ATTRACT_RUN				= 3		; Run the attract mode
0030+  0000             	
0031+  0000             ; If GAME_STATE == GAME_STATE_COIN_INSERTED
0032+  0000             
0033+  0000             ; If GAME_STATE == GAME_STATE_PLAYING
0034+  0000             GAME_SUBSTATE_PLAY_ORIENT				= 0		; Orienting the screen
0035+  0000             GAME_SUBSTATE_PLAY_INIT_P1				= 1		; Initialize player 1
0036+  0000             GAME_SUBSTATE_PLAY_START_P1				= 2		; Display player 1 start prompt
0037+  0000             GAME_SUBSTATE_PLAY_INIT_P2				= 3 	; Initialize player 2
0038+  0000             GAME_SUBSTATE_PLAY_START_P2				= 4		; Display player 2 start prompt
0039+  0000             GAME_SUBSTATE_PLAY_PLAYER_INFO			= 5		; Display information for the player
0040+  0000             GAME_SUBSTATE_PLAY_PREPARE				= 6		; Prepare to display either intro or intermission
0041+  0000             GAME_SUBSTATE_PLAY_INTRO				= 7		; Run the introduction screen
0042+  0000             GAME_SUBSTATE_PLAY_INTERMISSION			= 8		; Run the intermission screen
0043+  0000             GAME_SUBSTATE_PLAY_STAGE				= 10	; Display the current stage
0044+  0000             GAME_SUBSTATE_PLAY_MARIO				= 11	; Initialize the Mario sprite
0045+  0000             	
0046+  0000             CURRENT_PLAYER						= $600d
0047+  0000             PLAYER_1								= 0		; Player 1's turn
0048+  0000             PLAYER_2								= 1		; Player 2's turn
0049+  0000             
0050+  0000             SECOND_PLAYER						= $600e		; 1 if the second player is the current player
0051+  0000             TWO_PLAYERS							= $600f		; = 1 if two players are playing
0052+  0000             PLAYER_INPUT						= $6010
0053+  0000             PLAYER_INPUT_JUMP_BIT					= 7
0054+  0000             PLAYER_INPUT_DOWN_BIT					= 3
0055+  0000             PLAYER_INPUT_UP_BIT						= 2
0056+  0000             PLAYER_INPUT_LEFT_BIT					= 1
0057+  0000             PLAYER_INPUT_RIGHT_BIT					= 0
0058+  0000             PLAYER_INPUT_LAG					= $6011		; Prevents input (specifically the jump button) from being processed twice
0059+  0000             
0060+  0000             RANDOM_NUMBER						= $6018		
0061+  0000             COUNTER_1							= $6019
0062+  0000             COUNTER_2							= $601a		; Decremented on every interrupt
0063+  0000             
0064+  0000             DIP_NUM_LIVES						= $6020		; The number of lives setting from the DIP switches
0065+  0000             DIP_BONUS_LIFE						= $6021		; The number of points for the life bonus from the DIP switches
0066+  0000             NUM_COINS_FOR_1P					= $6022		; The number of coins required for 1 player to play
0067+  0000             NUM_COINS_FOR_2P					= $6023		; The number of coins required for 2 players to play
0068+  0000             DIP_COINS_PER_CREDIT				= $6024		; The number of coins required for 1 credit
0069+  0000             DIP_PLAYS_PER_CREDIT				= $6025		; The number of plays given for each credit earned
0070+  0000             CABINET_TYPE						= $6026
0071+  0000             CABINET_TYPE_COCKTAIL					= 0
0072+  0000             CABINET_TYPE_UPRIGHT					= 1
0073+  0000             
0074+  0000             JOYSTICK_INPUT_DELAY				= $6030	; Prevents the joystick from scrolling through the letters too quickly on the high score initials entry screen
0075+  0000             BLANK_CP_HIGH_SCORE					= $6031	; Makes the score display blink (0 = display score, 1 = blank it)
0076+  0000             BLINK_SCORE_TIMER					= $6032	; The score starts to blink when this reaches 0
0077+  0000             INITIALS_TIMER_VALUE				= $6033	; The time remaining to enter initials
0078+  0000             INITIALS_TIMER_DELAY				= $6034	; The delay between ticks of the initials timer
0079+  0000             SELECTED_LETTER						= $6035	; The letter currently selected for high score entry
0080+  0000             INITIALS_COORD						= $6036	; 2 byte screen coordinate the next initial letter will be displayed at for high score entry
0081+  0000             PLAYER_ID_ADDRESS					= $6038	; 2 byte address of the player's high score entry - determined when it's time for the player to enter initials
0082+  0000             INITIALS_ADDRESS					= $603a	; The memory address to write the player's initials to for the high score
0083+  0000             
0084+  0000             P1_DATA								= $6040
0085+  0000             	; This is an 8 byte block of data for player 1
0086+  0000             	; The individual data items are listed below
0087+  0000             P1_NUMBER_LIVES						= $6040	; The number of lives for player 1
0088+  0000             P1_LEVEL_NUMBER						= $6041	; Player 1's level number
0089+  0000             P1_STAGE_ORDER_POINTER				= $6042	; The address of the stage data for player 1's current stage
0090+  0000             P1_INTRO_NOT_DISPLAYED				= $6044	; 1 if the intro has not been displayed for player 1
0091+  0000             P1_BONUS_AWARDED					= $6045	; 1 if player 1 has been awarded a bonus life
0092+  0000             P1_HEIGHT_INDEX						= $6046	; The index to the current height that player 1 has achieved
0093+  0000             P1_STAGE_ORDER_POINTER_LAG			= $6047
0094+  0000             P2_DATA								= $6048
0095+  0000             	; This is an 8 byte block of data for player 2
0096+  0000             	; The individual data items are listed below
0097+  0000             P2_NUMBER_LIVES						= $6048	; The number of lives for player 2
0098+  0000             P2_LEVEL_NUMBER						= $6049	; Player 2's level number
0099+  0000             P2_STAGE_ORDER_POINTER				= $604a	; The address of the stage data for player 2's current stage
0100+  0000             P2_INTRO_NOT_DISPLAYED				= $604c	; 1 if the intro has not been displayed
0101+  0000             P2_BONUS_AWARDED					= $604d	; 1 if player 2 has been awarded a bonus life
0102+  0000             P2_HEIGHT_INDEX						= $604e	; The index to the current height that player 2 has achieved
0103+  0000             P2_STAGE_ORDER_POINTER_LAG			= $604f
0104+  0000             
0105+  0000             WALK_SOUND_TRIGGER					= $6080	; Triggers the Mario walking sound
0106+  0000             JUMP_SOUND_TRIGGER					= $6081	; Triggers the Mario jumping sound
0107+  0000             STOMP_SOUND_TRIGGER					= $6082	; Triggers the Donkey Kong stomping sound
0108+  0000             SPRING_SOUND_TRIGGER				= $6083	; Triggers the spring bounce sound
0109+  0000             FALL_SOUND_TRIGGER					= $6084	; Triggers the falling spring sound
0110+  0000             AWARD_SOUND_TRIGGER					= $6085	; Triggers the point award sound (Mario jumps a barrel, smashes a barrel/fire, grabs the hammer)
0111+  0000             
0112+  0000             DEATH_SOUND_TRIGGER					= $6088
0113+  0000             SONG_TRIGGER						= $6089	; Songs are played whenever this is set to non-zero
0114+  0000             SONG_TRIGGER_NONE						= 0
0115+  0000             SONG_TRIGGER_INTRODUCTION				= 1
0116+  0000             SONG_TRIGGER_INTERMISSION				= 2
0117+  0000             SONG_TRIGGER_OUT_OF_TIME				= 3
0118+  0000             SONG_TRIGGER_HAMMER						= 4
0119+  0000             SONG_TRIGGER_LEVEL_END_2				= 5
0120+  0000             SONG_TRIGGER_HAMMER_HIT					= 6
0121+  0000             SONG_TRIGGER_STAGE_END					= 7
0122+  0000             SONG_TRIGGER_BG_BARRELS					= 8	
0123+  0000             SONG_TRIGGER_BG_MIXER					= 9
0124+  0000             SONG_TRIGGER_BG_ELEVATORS				= 10
0125+  0000             SONG_TRIGGER_BG_RIVETS					= 11
0126+  0000             SONG_TRIGGER_LEVEL_END_1				= 12
0127+  0000             SONG_TRIGGER_RIVET_REMOVED				= 13
0128+  0000             SONG_TRIGGER_RIVET_END					= 14
0129+  0000             SONG_TRIGGER_ROAR						= 15
0130+  0000             PENDING_SONG_TRIGGER				= $608a	; The current song being played
0131+  0000             PENDING_SONG_TRIGGER_REPEAT			= $608b		; The number of times to repeat the pending song trigger
0132+  0000             
0133+  0000             ACTION_BUFFER_WRITE_POS				= $60b0
0134+  0000             ACTION_BUFFER_READ_POS				= $60b1
0135+  0000             PREV_P1_SCORE						= $60b2		; The remembered player 1 score displayed during attract mode
0136+  0000             PREV_P2_SCORE						= $60b5		; The remembered player 2 score
0137+  0000             PREV_HIGH_SCORE						= $60b8		; The remembered high score
0138+  0000             
0139+  0000             HIGH_SCORE_TABLE					= $6100
0140+  0000             	; Each entry in the table has the following format
0141+  0000             	; Bytes 0-1 = Coord of the high score string representation
0142+  0000             	; Bytes 2-27 = High score string representation
0143+  0000             	; Byte 28 = Player ID
0144+  0000             	;	0 = No current player
0145+  0000             	;	1 = Player 1
0146+  0000             	;	2 = Player 2
0147+  0000             	; Bytes 29-31 = High score entry (BCD)
0148+  0000             	; Bytes 32-33 = High score coord
0149+  0000             HIGH_SCORE_TABLE_ENTRY_1			= $6100
0150+  0000             HIGH_SCORE_TABLE_ENTRY_2			= $6122
0151+  0000             HIGH_SCORE_TABLE_ENTRY_3			= $6144
0152+  0000             HIGH_SCORE_TABLE_ENTRY_4			= $6166
0153+  0000             HIGH_SCORE_TABLE_ENTRY_5			= $6188
0154+  0000             
0155+  0000             CURRENT_SCORE_STRING				= $61b1	; The string representation of the current player's score including room for initials (18 bytes long) (ends at $61c3)
0156+  0000             
0157+  0000             MARIO_DATA_STRUCT					= $6200
0158+  0000             	; This is the start of Mario's 39 byte data structure
0159+  0000             	; The structure consists of the following data items
0160+  0000             	; (Each item also has a separate variable defined below):
0161+  0000             	;  0 - Mario is alive (1 or 0)
0162+  0000             	; 
0163+  0000             	;  3 - Mario's x coordinate
0164+  0000             	; 
0165+  0000             	;  5 - Mario's y coordinate
0166+  0000             	;
0167+  0000             	;  7 - Mario's sprite number
0168+  0000             	;  8 - Mario's palette
0169+  0000             	;
0170+  0000             	; 14 - The y coordinate that Mario started jumping from
0171+  0000             	;
0172+  0000             	; 16 - Mario is jumping left if this equals $FF
0173+  0000             	; 17 - Mario is jumping right if this equals $80
0174+  0000             	;
0175+  0000             	; 21 - Mario is climbing a ladder (1 or 0)
0176+  0000             	; 22 - Mario is jumping (1 or 0)
0177+  0000             	; 23 - The hammer cycle is active (1 or 0)
0178+  0000             	; 24 - The hammer has been grabbed (1 or 0)
0179+  0000             	; 
0180+  0000             	; 27 - The y coordinate of the top of the ladder being currently climbed
0181+  0000             	; 28 - The y coordinate of the bottom of the ladder being currently climbed
0182+  0000             	;
0183+  0000             	; 33 - Mario is falling (1 or 0)
0184+  0000             MARIO_ALIVE							= $6200
0185+  0000             
0186+  0000             MARIO_X								= $6203
0187+  0000             
0188+  0000             MARIO_Y								= $6205			
0189+  0000             
0190+  0000             MARIO_DATA_SPRITE_NUM				= $6207
0191+  0000             MARIO_DATA_PALETTE					= $6208
0192+  0000             
0193+  0000             MARIO_JUMP_Y_COORD					= $620e	; The y coordinate of the start of Mario's current jump
0194+  0000             
0195+  0000             MARIO_JUMPING_LEFT					= $6210	; $FF if Mario is jumping left
0196+  0000             MARIO_JUMPING_RIGHT				 	= $6211	; $80 if Mario is jumping right
0197+  0000             
0198+  0000             MARIO_IS_CLIMBING					= $6215 ; 1 if Mario is climbing a ladder
0199+  0000             MARIO_IS_JUMPING					= $6216	; 1 if Mario is jumping
0200+  0000             HAMMER_CYCLE_ACTIVE					= $6217	; This is set to 1 if Mario has the hammer and the up/down cycle is active
0201+  0000             HAMMER_GRABBED						= $6218 ; This is set to 1 when Mario initially jumps up and grabs the hammer, and is set to 0 when Mario comes back down and the hammer cycle starts
0202+  0000             
0203+  0000             TOP_OF_CURRENT_LADDER				= $621b	; The y coordinate of the top of the current ladder being climbed
0204+  0000             BOT_OF_CURRENT_LADDER				= $621c	; The y coordinate of the bottom of the current ladder being climbed
0205+  0000             
0206+  0000             MARIO_HAMMER_CYCLE_DELAY			= $621e	; Small delay between when the hammer is grabbed and the hammer cycle begins (countdown from 4 to 0)
0207+  0000             
0208+  0000             MARIO_IS_FALLING					= $6221	; 1 when Mario is in free fall
0209+  0000             
0210+  0000             CURRENT_STAGE						= $6227	; The stage that the current player is at
0211+  0000             STAGE_BARRELS							= 1		
0212+  0000             STAGE_MIXER								= 2
0213+  0000             STAGE_ELEVATORS							= 3
0214+  0000             STAGE_RIVETS							= 4
0215+  0000             
0216+  0000             CP_DATA								= $6228
0217+  0000             	; This is an 8 byte block of data for the current player
0218+  0000             	; The individual data items are listed below
0219+  0000             CP_NUMBER_LIVES						= $6228	; The number of lives for the current player
0220+  0000             CP_LEVEL_NUMBER						= $6229	; The level number for the current player
0221+  0000             CP_STAGE_ORDER_POINTER				= $622a
0222+  0000             CP_INTRO_NOT_DISPLAYED				= $622c ; 1 if the current player has seen the intro screen
0223+  0000             CP_BONUS_LIFE_AWARDED				= $622d	; 1 if the current player has earned the bonus life
0224+  0000             CP_HEIGHT_INDEX						= $622e
0225+  0000             HEIGHT_25M								= 0
0226+  0000             HEIGHT_50M								= 1
0227+  0000             HEIGHT_75M								= 2
0228+  0000             HEIGHT_100M								= 3
0229+  0000             HEIGHT_125M								= 4
0230+  0000             HEIGHT_150M								= 5
0231+  0000             CP_STAGE_ORDER_POINTER_LAG			= $622f
0232+  0000             
0233+  0000             ; This is the start of 64 bytes of data used in the stage game play
0234+  0000             STAGE_DATA_BLOCK					= $6280
0235+  0000             
0236+  0000             RETRACTABLE_LADDER_DATA				= $6280		
0237+  0000             ; The start of the 8 byte data for the two retractable ladders on the mixer stage
0238+  0000             ; The data structure is as follows:
0239+  0000             ;
0240+  0000             ;  0 - The ladder state
0241+  0000             ;		0 = ladder in up position
0242+  0000             ;		1 = ladder moving down
0243+  0000             ;		2 = ladder in down position
0244+  0000             ;		3 = ladder moving up
0245+  0000             ;  1 - The ladder up delay - the time before the ladder starts to descend
0246+  0000             ;  2 - The ladder x coordinate
0247+  0000             ;  3 - 
0248+  0000             ;  4 - The ladder move delay - the ladder is moved down one pixel when
0249+  0000             ;		this reaches 0
0250+  0000             L_RETRACT_LADDER_DATA				= $6280
0251+  0000             L_RETRACT_LADDER_STATE				= $6280
0252+  0000             L_RETRACT_LADDER_DELAY				= $6281
0253+  0000             L_RETRACT_LADDER_X					= $6282
0254+  0000             L_RETRACT_LADDER_Y					= $6283
0255+  0000             L_RETRACT_LADDER_MOVE_DELAY			= $6284
0256+  0000             
0257+  0000             R_RETRACT_LADDER_STATE				= $6288
0258+  0000             R_RETRACT_LADDER_DELAY				= $6289
0259+  0000             R_RETRACT_LADDER_X					= $628a
0260+  0000             R_RETRACT_LADDER_Y					= $628b
0261+  0000             R_RETRACT_LADDER_MOVE_DELAY			= $628c
0262+  0000             
0263+  0000             REMAINING_RIVETS					= $6290	; The number of rivets that have not been removed
0264+  0000             ACTIVATE_SECRET_STAGE				= $6290 ; The secret stage is activated if this is 1 at the end of a stage
0265+  0000             
0266+  0000             TOP_MASTER_REVERSE_TIMER			= $62a0	; When this reaches 0, the mixer stage conveyer directions are reversed
0267+  0000             TOP_MASTER_CONVEYER_DIR				= $62a1	; The direction of the top conveyer belt in the mixer stage
0268+  0000             MID_MASTER_REVERSE_TIMER			= $62a2	; When this reaches 0, the middle conveyers (left and right) change direction
0269+  0000             RIGHT_MASTER_CONVEYER_DIR			= $62a3	; The direction of the right conveyer belt
0270+  0000             LEFT_MASTER_CONVEYER_DIR			= $62a4	; The direction of the left conveyer belt
0271+  0000             SECRET_ELEVATOR_DIR					= $62a4	; The direction of the elevators on the secret level (0 = cw, 1 = ccw)
0272+  0000             BOT_MASTER_REVERSE_TIMER			= $62a5	; When this reaches 0, the bottom conveyer change direction
0273+  0000             BOT_MASTER_CONVEYER_DIR				= $62a6	; The direction of the bottom conveyer belt in the mixer stage
0274+  0000             ELEVATOR_SPAWN_TIMER				= $62a7	; Counts down from 52 to 0 and then a new elevator is spawned in the left column on the elevators stage
0275+  0000             
0276+  0000             DK_CLIMBING_COUNTER					= $62af	; Used to delay between advancing Donkey Kong's climbing animation
0277+  0000             DK_REACHING_COUNTER					= $62af	; Used to move Donkey Kong's arm in the secret stage win animation
0278+  0000             
0279+  0000             INTERNAL_TIMER						= $62b0	; The internal stage timer (in hex)
0280+  0000             
0281+  0000             SECRET_ELEVATOR_MOVE_COUNT			= $62b6	; The number of times the secret stage elevators have moved in the current quadrant (count up to 24)
0282+  0000             SECRET_ELEVATOR_QUAD				= $62b7	; The current quadrant of the elevators on the secret stage
0283+  0000             											;         3 | 0
0284+  0000             											;	      --+--
0285+  0000             											;	      2 | 1
0286+  0000             BARREL_FIRE_FREEZE					= $62b8	; Counts down from 4 to 0 between updates of the barrel fire
0287+  0000             CAGE_BARS_REMAINING					= $62b8 ; Keeps track of the number of bars remaining on Penelope's cage (on the secret stage)
0288+  0000             BARREL_FIRE_STATE					= $62b9		
0289+  0000             	; 3 = Initial flare up
0290+  0000             	; 1 = Normal burning
0291+  0000             	; 0 = Not burning
0292+  0000             BARREL_FIRE_FLARE_UP_TIME			= $62ba	; The time remaining until the initial flare up subsides
0293+  0000             SECRET_ELEVATOR_PAUSE_COUNT			= $62ba	; Counter that keeps the secret stage elevators paused for a time before moving to the next quadrant
0294+  0000             SECRET_ELEVATOR_REVERSE				= $62bb	; The elevators reverse directions when this is 1
0295+  0000             
0296+  0000             NORMAL_LADDER_X_COORD_DATA			= $6300	; The start of x coordinate data for the normal ladders in the current stage
0297+  0000             	; 15 bytes total (max of 15 normal ladders)
0298+  0000             BROKEN_LADDER_X_COORD_DATA			= $6310	; The start of x coordinate data for the broken ladders in the current stage
0299+  0000             	; 5 bytes total (max of 5 broken ladders)
0300+  0000             NORMAL_LADDER_Y1_COORD_DATA			= $6315	; The start of y1 coordinate data for the normal ladders in the current stage
0301+  0000             	; 15 bytes total (max of 15 broken ladders)
0302+  0000             BROKEN_LADDER_Y1_COORD_DATA			= $6325	; The start of y1 coordinate data for broken ladders in the current stage
0303+  0000             	; 5 bytes total (max of 5 broken ladders)
0304+  0000             NORMAL_LADDER_Y2_COORD_DATA			= $632A	; The start of y2 coordinate data for the normal ladders in the current stage
0305+  0000             	; 15 bytes total (max of 15 normal ladders)
0306+  0000             BROKEN_LADDER_Y2_COORD_DATA			= $633A	; The start of y2 coordinate data for the broken ladders in the current stage
0307+  0000             	; 5 bytes total (max of 5 broken ladders)
0308+  0000             POINT_AWARD_STATE					= $6340		
0309+  0000             	; 0 = No points have been awarded
0310+  0000             	; 1 = Award points to the player
0311+  0000             	; 2 = Display the point award
0312+  0000             POINT_AWARD_DISPLAY_TIMER			= $6341	; The current point award sprite is displayed until this timer reaches 0	
0313+  0000             POINT_AWARD_TYPE					= $6342 ; The type of point award that Mario has earned
0314+  0000             	; 0 = award points based on the level number
0315+  0000             	;	level 1 = 300 points
0316+  0000             	;	level 2 = 500 points
0317+  0000             	;	level 3+ = 800 points
0318+  0000             	; 1 = 200 points
0319+  0000             	; 2 = 300 points
0320+  0000             	; 3 = 300 points
0321+  0000             	; 4 = random 300, 500, or 800
0322+  0000             	; 5 = 500 points (800 point sprite is displayed)
0323+  0000             SMASHED_SPRITE_POINTER				= $6343	; The address of the sprite that was smashed by the hammer(2 bytes)
0324+  0000             SMASH_ANIMATION_STATE				= $6345	; The state of the smash animation
0325+  0000             	; 0 = 
0326+  0000             	; 1 = 
0327+  0000             	; 2 = 
0328+  0000             SMASH_ANIMATION_FRAME_DELAY			= $6346	; The current animation frame is displayed until this counts down to 0
0329+  0000             SMASH_ANIMATION_CYCLE_COUNTER		= $6347	; The smash animation cycles between the first two sprite images in the smash animation until this counts down to 0
0330+  0000             BARREL_FIRE_STATUS					= $6348	; 1 if the barrel fire has been lit
0331+  0000             
0332+  0000             SMASH_ANIMATION_ACTIVE				= $6350	; 1 when an object has been smashed and the animation is in effect (everything else pauses)
0333+  0000             SMASH_ENEMY_CLASS_POINTER			= $6351 ; (2 bytes) pointer to the start of the data structures for the enemy's class (used to find the correct enemy data structure)
0334+  0000             SMASH_ENEMY_DATA_SIZE				= $6353	; The size of the data structure of the enemy that was struck by the hammer (used to find the correct enemy data structure)
0335+  0000             SMASH_ANIMATION_ENEMY_INDEX			= $6354	; The index number (within the enemy's class) of the enemy that was struck by the hammer
0336+  0000             
0337+  0000             CP_DIFFICULTY						= $6380
0338+  0000             MAJOR_COUNTER						= $6381
0339+  0000             
0340+  0000             MINOR_COUNTER						= $6384
0341+  0000             INTRODUCTION_STATE					= $6385
0342+  0000             	; 0 = display introduction screen
0343+  0000             	; 1 = prepare sprites
0344+  0000             	; 2 = animate the climbing sequence
0345+  0000             	; 3 = pause
0346+  0000             	; 4 = animate intro screen
0347+  0000             	; 5 = pause
0348+  0000             	; 6 = animate Donkey Kong jumping
0349+  0000             	; 7 = Donkey Kong grins and laughs
0350+  0000             	
0351+  0000             WIN_ANIMATION_STATE					= $6388	; State of the win stage animation
0352+  0000             PRE_HAMMER_TUNE						= $6389 ; Saves the tune that was playing before the hammer was grabbed
0353+  0000             TITLE_PALETTE_CYCLE_COUNTER			= $638a	; Used to cycle the palette colors on the "DONKEY KONG" title screen
0354+  0000             TITLE_PALETTE_PATTERN				= $638b	; The currently used palette on the "DONKEY KONG" title screen
0355+  0000             ONSCREEN_TIMER						= $638c	; The internal timer converted to BCD for display
0356+  0000             STAGE_DEFORM_INDEX					= $638d	; Keeps track of the next stage data to display when Donkey Kong completes a jump in the introduction stage and causes the platforms to deform
0357+  0000             LADDER_ROW_TO_ERASE					= $638e	; The ladder row to erase as the ladder is being pulled up on the introduction stage
0358+  0000             ANIMATION_TIMER						= $6390	; Manages the animation state for Donkey Kong and Pauline
0359+  0000             TIME_FOR_DK_ACTION					= $6391	; Indicates that a Donkey Kong action is being animated
0360+  0000             
0361+  0000             DK_STOMPING							= $6393	; Donkey Kong starts stomping when this is 1
0362+  0000             HAMMER_CYCLE_COUNTER				= $6394	; Counter that controls the cycle of raising and lowering the hammer cycle when Mario has the hammer
0363+  0000             HAMMER_CYCLE_WRAP_COUNTER			= $6395	; Keeps track of the number of times the hammer cycle counter wraps back around to 0 - the hammer is released after 2 wraps
0364+  0000             RELEASE_SPRING						= $6396
0365+  0000             
0366+  0000             MARIO_ON_ELEVATOR					= $6398	; 1 if Mario is riding up or down an elevator platform
0367+  0000             
0368+  0000             DEATH_ANIMATION_STATE				= $639d
0369+  0000             DEATH_ANIMATION_COUNTER				= $639e
0370+  0000             
0371+  0000             RELEASE_A_FIREBALL					= $63a0	; A fireball is released when this equals 1
0372+  0000             ACTIVE_FIREBALL_COUNT				= $63a1 ; The number of fireballs active on the current level
0373+  0000             UPDATED_FIREBALL_COUNT				= $63a2	; The number of fireballs that have been updated (counts up to 5)
0374+  0000             TOP_CONVEYER_DIR					= $63a3	; The direction that the top conveyer belt on the mixer level is moving
0375+  0000             LEFT_CONVEYER_DIR					= $63a4
0376+  0000             RIGHT_CONVEYER_DIR					= $63a5
0377+  0000             BOT_CONVEYER_DIR					= $63a6
0378+  0000             
0379+  0000             INTERM_HEIGHT_STRING_INDEX			= $63a7	; Index to the string representing the current height in the height string table for the intermission screen
0380+  0000             INTERM_HEIGHT_STRING_COORD			= $63a8	; (2 bytes) The coordinate that the current height string should be displayed at on the intermission screen
0381+  0000             
0382+  0000             STAGE_DATA_START_ADDRESS			= $63ab	; The tile memory address where the first tile in a tile line is to be drawn
0383+  0000             STAGE_DATA_END_ADDRESS				= $63ad	; The tile memory address where the last tile in a tile line is to be drawn
0384+  0000             STAGE_DATA_FIRST_Y_OFFSET			= $63af
0385+  0000             STAGE_DATA_LAST_Y_OFFSET			= $63b0
0386+  0000             STAGE_DATA_X_DIFF					= $63b1
0387+  0000             STAGE_DATA_Y_DIFF					= $63b2
0388+  0000             STAGE_DATA_TILE_ID					= $63b3
0389+  0000             STAGE_DATA_UNKNOWN					= $63b4
0390+  0000             STAGE_DATA_CURRENT_TILE				= $63b5
0391+  0000             
0392+  0000             DK_DISTANCE_TO_LADDER				= $63b7 ; The distance between Donkey Kongs head? and the ladder on the mixer level
0393+  0000             TIMER_HAS_RUN_DOWN					= $63b8	; Set to 1 to distinguish between the onscreen timer being zero because it needs to be initialized and being zero because it has legitimately run down
0394+  0000             NUM_ENEMIES_OF_CURRENT_CLASS		= $63b9	; The number of enemies in the enemy class that was struck by the hammer (used to identify which enemy data structure was struck)
0395+  0000             
0396+  0000             CURRENT_STATE_VAR_POINTER			= $63c0	; Points to the variable that controls the current game state
0397+  0000             
0398+  0000             LADDER_JUMP_VECTOR_POINTER			= $63c2	; Points to the current vector data for Donkey Kong's jump from the ladder to the platform on the introduction stage
0399+  0000             PLATFORM_JUMP_VECTOR_POINTER		= $63c4	; Points to the current vector data for Donkey Kong's jumps across the platform on the introduction stage
0400+  0000             
0401+  0000             CURRENT_FIREBALL					= $63c8	; Points to the fireball currently being processed (2 bytes)
0402+  0000             
0403+  0000             DEMO_INPUT_INDEX					= $63cc
0404+  0000             DEMO_INPUT_REPEAT					= $63cd
0405+  0000             
0406+  0000             FIREBALL_STRUCTS					= $6400
0407+  0000             	; This is the start of a series of 5 32-byte data structures representing 
0408+  0000             	; the state of the active fire balls on a stage
0409+  0000             	; The structure layout is as follows:
0410+  0000             	;
0411+  0000             	;  0 - Fire ball active (0 or 1)?
0412+  0000             	;
0413+  0000             	;  3 - x coordinate of the fire ball
0414+  0000             	;  
0415+  0000             	;  5 - y coordinate of the fire ball
0416+  0000             	;
0417+  0000             	;  7 - The sprite number of the fire ball sprite
0418+  0000             	;  8 - The sprite palette 
0419+  0000             	;  9 - The radial width of the fireball's collision boundary
0420+  0000             	; 10 - The radial height of the fireball's collision boundary
0421+  0000             	;
0422+  0000             	; 13 - The fireball direction
0423+  0000             	;		0 - standing still
0424+  0000             	;		1 - moving right
0425+  0000             	;		2 - moving left
0426+  0000             	;		4 - moving down
0427+  0000             	;		8 - moving up
0428+  0000             	; 14 - The next intended x coordinate
0429+  0000             	; 15 - The next intended y coordinate
0430+  0000             	;
0431+  0000             	; 19 - The bob table index - controls how the fireball seems to bob as it moves
0432+  0000             	; 20 - The climb update counter - the fireball is moved up or down the current ladder when this reaches 0
0433+  0000             	; 21 - The sprite update counter - the sprite image is updated when this reaches 0
0434+  0000             	; 22 - The direction counter - the fireball continues in the current diection (left or right) until this reaches 0 - it may still go up and down ladders, however
0435+  0000             	;
0436+  0000             	; 24 - Not initialized - the fireball has not been initialized yet if this is 1
0437+  0000             	; 25 - Pause mode - the fireball pauses for a while when this equals 2
0438+  0000             	; 26,27 - The oil barrel jump pointer - pointer to the entry in a table of y coodinates for the fireball as it initially jumps out of the oil barrel on the barrels stage
0439+  0000             	; 28 - Pause timer - the fireball stops being paused when this reaches 0
0440+  0000             	; 29 - Pause mode (2) - the fireball is paused when this equals 1
0441+  0000             	;
0442+  0000             	; 31 - The y coordinate of the other end of the ladder currently being climbed
0443+  0000             FIREBALL_STRUCT_1					= $6400
0444+  0000             FIREBALL_STRUCT_2					= $6420
0445+  0000             FIREBALL_STRUCT_3					= $6440
0446+  0000             FIREBALL_STRUCT_4					= $6460
0447+  0000             FIREBALL_STRUCT_5					= $6480
0448+  0000             
0449+  0000             COLLISION_AREA_STRUCTS				= $64a0
0450+  0000             	; This is the start of 2 32-byte data structures representing 
0451+  0000             	; invisible collision detection sprites
0452+  0000             	;
0453+  0000             	;  0 - Sprite active (0 or 1)?
0454+  0000             	;
0455+  0000             	;  3 - x coordinate of the sprite
0456+  0000             	;  
0457+  0000             	;  5 - y coordinate of the sprite
0458+  0000             	;
0459+  0000             	;  7 - The sprite number of the fire ball sprite
0460+  0000             	;  8 - The sprite palette 
0461+  0000             	;  9 - The radial width of the collision boundary
0462+  0000             	; 10 - The radial height of the collision boundary
0463+  0000             COLLISION_AREA_STRUCT_1				= $64a0
0464+  0000             COLLISION_AREA_STRUCT_2				= $64c0
0465+  0000             CAGE_TRIGGER_STRUCT					= $64a0
0466+  0000             	; This is the start of 4 16-byte data structures representing 
0467+  0000             	; the triggers that open each bar of Penelope's cage on the
0468+  0000             	; secret stage
0469+  0000             	;
0470+  0000             	;  0 - Trigger active
0471+  0000             	; 
0472+  0000             	;  3 - x coordinate of the trigger
0473+  0000             	;
0474+  0000             	;  5 - y coordinate of the trigger
0475+  0000             	;
0476+  0000             	;  7 - The sprite number of the trigger
0477+  0000             	;  8 - The sprite palette
0478+  0000             	
0479+  0000             SPRING_STRUCTS						= $6500
0480+  0000             	; This is the start of a series of 10 16-byte data structures representing 
0481+  0000             	; the state of the active springs on the elevators stage
0482+  0000             	; The structure layout is as follows:
0483+  0000             	;
0484+  0000             	;  0 - Spring active (0 or 1)?
0485+  0000             	;
0486+  0000             	;  3 - x coordinate of the spring?
0487+  0000             	;  
0488+  0000             	;  5 - y coordinate of the spring
0489+  0000             	;
0490+  0000             	;  7 - The sprite number of the spring sprite
0491+  0000             	;  8 - The sprite palette 
0492+  0000             	; 
0493+  0000             	; 13 - The spring state
0494+  0000             	;	1 = bouncing
0495+  0000             	;	4 = falling
0496+  0000             	; 14 - The most significant byte of the address of the next bounce vector
0497+  0000             	; 15 - The least significant byte of the address of the next bounce vector
0498+  0000             
0499+  0000             PIE_STRUCTS							= $65A0
0500+  0000             	; This is the start of a series of 6 16-byte data structures representing 
0501+  0000             	; the state of the pies on the mixer stage
0502+  0000             	; The structure layout is as follows:
0503+  0000             	;
0504+  0000             	;  0 - pie active (0 or 1)
0505+  0000             	; 
0506+  0000             	;  3 - x coordinate of the pie
0507+  0000             	;  
0508+  0000             	;  5 - y coordinate of the pie
0509+  0000             	;
0510+  0000             	;  7 - The sprite number of the pie sprite
0511+  0000             	;  8 - The sprite palette 
0512+  0000             	;
0513+  0000             	
0514+  0000             ELEVATOR_STRUCTS					= $6600
0515+  0000             	; This is the start of a series of 6 16-byte data structures representing 
0516+  0000             	; the state of the elevator platforms on a stage
0517+  0000             	; The structure layout is as follows:
0518+  0000             	;
0519+  0000             	;  0 - elevator active (0 or 1)
0520+  0000             	; 
0521+  0000             	;  3 - x coordinate of the elevator
0522+  0000             	;  
0523+  0000             	;  5 - y coordinate of the elevator
0524+  0000             	;
0525+  0000             	;  7 - The sprite number of the elevator sprite
0526+  0000             	;  8 - The sprite palette 
0527+  0000             	;  9 - The radial width of the elevator's collision boundary
0528+  0000             	; 10 - The radial height of the elevator's collision boundary
0529+  0000             	;
0530+  0000             	; 12 - The move counter of the elevators on the secret stage
0531+  0000             	; 13 - The direction (8 if the elevator is moving up, 4 if it is moving down)
0532+  0000             ELEVATOR_STRUCT_1					= $6600
0533+  0000             ELEVATOR_STRUCT_2					= $6610
0534+  0000             ELEVATOR_STRUCT_3					= $6620
0535+  0000             ELEVATOR_STRUCT_4					= $6630
0536+  0000             ELEVATOR_STRUCT_5					= $6640
0537+  0000             ELEVATOR_STRUCT_6					= $6650
0538+  0000             
0539+  0000             HAMMER_STRUCTS						= $6680
0540+  0000             	; This is the start of a series of 2 16-byte data structures representing 
0541+  0000             	; the state of the hammers on a stage
0542+  0000             	; The structure layout is as follows:
0543+  0000             	;
0544+  0000             	;  0 - hammer active (0 or 1)
0545+  0000             	;  1 - Mario has hammer (0 or 1) 
0546+  0000             	; 
0547+  0000             	;  3 - x coordinate of the hammer
0548+  0000             	;  
0549+  0000             	;  5 - y coordinate of the hammer
0550+  0000             	;
0551+  0000             	;  7 - The sprite number of the hammer sprite
0552+  0000             	;  8 - The sprite palette 
0553+  0000             	;  9 - Collision boundary x radius (distance from the center of the sprite)
0554+  0000             	; 10 - Collision boundary y radius (distance from the center of the sprite)
0555+  0000             	;
0556+  0000             	; 14 - X coordinate offset from Mario (-16 = to Mario's left, 16 = to Mario's right, 0 = above Mario)
0557+  0000             	; 15 - Y coordinate offset from Mario (-16 = above Mario, 0 = to Mario's left or right)
0558+  0000             	; 
0559+  0000             HAMMER_STRUCT_1						= $6680	
0560+  0000             HAMMER_STRUCT_2						= $6690
0561+  0000             BARREL_FIRE_STRUCT					= $66a0
0562+  0000             	; This is a 32-byte data structure representing the state of the barrel fire
0563+  0000             	; on the barrels and mixer stages
0564+  0000             	; The structure layout is as follows:
0565+  0000             	;
0566+  0000             	;  0 - Barrel fire active (0 or 1)?
0567+  0000             	;
0568+  0000             	;  3 - Barrel fire sprite x coordinate
0569+  0000             	;
0570+  0000             	;  5 - Barrel fire sprite y coordinate
0571+  0000             	;
0572+  0000             	;  7 - Barrel fire sprite number
0573+  0000             	;  8 - Barrel fire sprite palette
0574+  0000             
0575+  0000             BARREL_STRUCTS						= $6700
0576+  0000             	; This is the start of 10 32-byte data structures 
0577+  0000             	; representing the state of the barrels on the barrels stage
0578+  0000             	; The structure layout is as follows:
0579+  0000             	;
0580+  0000             	;  0 - Barrel active (0 or 1)?
0581+  0000             	;
0582+  0000             	;  3 - Barrel sprite x coordinate
0583+  0000             	;
0584+  0000             	;  5 - Barrel sprite y coordinate
0585+  0000             	;
0586+  0000             	;  7 - Barrel sprite number
0587+  0000             	;  8 - Barrel sprite palette
0588+  0000             	;
0589+  0000             	; 21 - Barrel type (0 = normal barrel, 1 = oil barrel)
0590+  0000             
0591+  0000             SPRITE_STRUCTS						= $6900
0592+  0000             	; This is the start of a series of ??? 4-byte data structures for the 
0593+  0000             	; active sprites in the game.
0594+  0000             	; The Sprite data structures continue to $6a7f
0595+  0000             	; The structure layout is as follows:
0596+  0000             	;
0597+  0000             	;  0 - The x coordinate of the sprite
0598+  0000             	;  1 - The sprite graphic number
0599+  0000             	;      If bit 1 of this byte is 1 then the graphic is flipped horizontally
0600+  0000             	;  2 - The palette to use for the sprite
0601+  0000             	;      If bit 1 of this byte is 1 then the graphic is flipped vertically
0602+  0000             	;  3 - The y coordinate of the sprite
0603+  0000             
0604+  0000             PAULINE_SPRITES						= $6900
0605+  0000             	; The 2 sprites that make up PAULINE
0606+  0000             PAULINE_UPPER_SPRITE_X				= $6900
0607+  0000             PAULINE_UPPER_SPRITE_NUM			= $6901
0608+  0000             PAULINE_UPPER_SPRITE_PAL			= $6902
0609+  0000             PAULINE_UPPER_SPRITE_Y				= $6903
0610+  0000             PAULINE_LOWER_SPRITE_X				= $6904
0611+  0000             PAULINE_LOWER_SPRITE_NUM			= $6905
0612+  0000             PAULINE_LOWER_SPRITE_PAL			= $6906
0613+  0000             PAULINE_LOWER_SPRITE_Y				= $6907
0614+  0000             
0615+  0000             DK_SPRITES							= $6908
0616+  0000             	; This marks the start of the 10 sprites that 
0617+  0000             	; make up Donkey Kong.  The last sprite ends at
0618+  0000             	; $6929.
0619+  0000             DK_SPRITE_1_X						= $6908
0620+  0000             DK_SPRITE_1_NUM						= $6909
0621+  0000             DK_SPRITE_1_PAL						= $690a
0622+  0000             DK_SPRITE_1_Y						= $690b
0623+  0000             DK_SPRITE_2_X						= $690c
0624+  0000             DK_SPRITE_2_NUM						= $690d
0625+  0000             DK_SPRITE_2_PAL						= $690e
0626+  0000             DK_SPRITE_2_Y						= $690f
0627+  0000             DK_SPRITE_3_X						= $6910
0628+  0000             DK_SPRITE_3_NUM						= $6911
0629+  0000             DK_SPRITE_3_PAL						= $6912
0630+  0000             DK_SPRITE_3_Y						= $6913
0631+  0000             DK_SPRITE_4_X						= $6914
0632+  0000             DK_SPRITE_4_NUM						= $6915
0633+  0000             DK_SPRITE_4_PAL						= $6916
0634+  0000             DK_SPRITE_4_Y						= $6917
0635+  0000             DK_SPRITE_5_X						= $6918
0636+  0000             DK_SPRITE_5_NUM						= $6919
0637+  0000             DK_SPRITE_5_PAL						= $691a
0638+  0000             DK_SPRITE_5_Y						= $691b
0639+  0000             DK_SPRITE_6_X						= $691c
0640+  0000             DK_SPRITE_6_NUM						= $691d
0641+  0000             DK_SPRITE_6_PAL						= $691e
0642+  0000             DK_SPRITE_6_Y						= $691f
0643+  0000             DK_SPRITE_7_X						= $6920
0644+  0000             DK_SPRITE_7_NUM						= $6921
0645+  0000             DK_SPRITE_7_PAL						= $6922
0646+  0000             DK_SPRITE_7_Y						= $6923
0647+  0000             DK_SPRITE_8_X						= $6924
0648+  0000             DK_SPRITE_8_NUM						= $6925
0649+  0000             DK_SPRITE_8_PAL						= $6926
0650+  0000             DK_SPRITE_8_Y						= $6927
0651+  0000             DK_SPRITE_9_X						= $6928
0652+  0000             DK_SPRITE_9_NUM						= $6929
0653+  0000             DK_SPRITE_9_PAL						= $692a
0654+  0000             DK_SPRITE_9_Y						= $692b
0655+  0000             DK_SPRITE_10_X						= $692c
0656+  0000             DK_SPRITE_10_NUM					= $692d
0657+  0000             DK_SPRITE_10_PAL					= $692e
0658+  0000             DK_SPRITE_10_Y						= $692f
0659+  0000             ; Start of the two retractable ladder sprites on the mixer level
0660+  0000             RETRACTABLE_LADDER_SPRITES			= $6944
0661+  0000             L_RETRACT_LADDER_SPRITE				= $6944
0662+  0000             L_RETRACT_LADDER_SPRITE_X			= $6944
0663+  0000             L_RETRACT_LADDER_SPRITE_NUM			= $6945
0664+  0000             L_RETRACT_LADDER_SPRITE_PAL			= $6946
0665+  0000             L_RETRACT_LADDER_SPRITE_Y			= $6947
0666+  0000             R_RETRACT_LADDER_SPRITE				= $6948
0667+  0000             R_RETRACT_LADDER_SPRITE_X			= $6948
0668+  0000             R_RETRACT_LADDER_SPRITE_NUM			= $6949
0669+  0000             R_RETRACT_LADDER_SPRITE_PAL			= $694a
0670+  0000             R_RETRACT_LADDER_SPRITE_Y			= $694b
0671+  0000             ; Start of Mario's sprite
0672+  0000             MARIO_SPRITE						= $694c
0673+  0000             MARIO_SPRITE_X						= $694c
0674+  0000             MARIO_SPRITE_NUM					= $694d
0675+  0000             MARIO_SPRITE_PAL					= $694e
0676+  0000             MARIO_SPRITE_Y						= $694f
0677+  0000             ; Sprite data for two invisible collision detection sprites
0678+  0000             COLLISION_AREA_SPRITES				= $6950
0679+  0000             COLLISION_AREA_SPRITE_1				= $6950
0680+  0000             COLLISION_AREA_SPRITE_2				= $6954
0681+  0000             ; Sprite data for the elevator platforms on the elevators stage
0682+  0000             ; 6 sprites
0683+  0000             ELEVATOR_PLATFORM_SPRITES			= $6958
0684+  0000             ELEVATOR_PLATFORM_SPRITE_1			= $6958
0685+  0000             ELEVATOR_PLATFORM_SPRITE_2			= $695c
0686+  0000             ELEVATOR_PLATFORM_SPRITE_3			= $6960
0687+  0000             ELEVATOR_PLATFORM_SPRITE_4			= $6964
0688+  0000             ELEVATOR_PLATFORM_SPRITE_5			= $6968
0689+  0000             ELEVATOR_PLATFORM_SPRITE_6			= $696c
0690+  0000             ; Sprite data for the 4 evelator motors on the elevators stage
0691+  0000             ; 16 bytes
0692+  0000             ELEVATOR_MOTOR_SPRITE_DATA			= $6970
0693+  0000             ELEVATOR_MOTOR_SPRITE_1				= $6970
0694+  0000             ELEVATOR_MOTOR_SPRITE_1_X			= $6970
0695+  0000             ELEVATOR_MOTOR_SPRITE_1_NUM			= $6971
0696+  0000             ELEVATOR_MOTOR_SPRITE_1_PAL			= $6972
0697+  0000             ELEVATOR_MOTOR_SPRITE_1_Y			= $6973
0698+  0000             ELEVATOR_MOTOR_SPRITE_2				= $6974
0699+  0000             ELEVATOR_MOTOR_SPRITE_2_X			= $6974
0700+  0000             ELEVATOR_MOTOR_SPRITE_2_NUM			= $6975
0701+  0000             ELEVATOR_MOTOR_SPRITE_2_PAL			= $6976
0702+  0000             ELEVATOR_MOTOR_SPRITE_2_Y			= $6977
0703+  0000             ELEVATOR_MOTOR_SPRITE_3				= $6978
0704+  0000             ELEVATOR_MOTOR_SPRITE_3_X			= $6978
0705+  0000             ELEVATOR_MOTOR_SPRITE_3_NUM			= $6979
0706+  0000             ELEVATOR_MOTOR_SPRITE_3_PAL			= $697a
0707+  0000             ELEVATOR_MOTOR_SPRITE_3_Y			= $697b
0708+  0000             ELEVATOR_MOTOR_SPRITE_4				= $697c
0709+  0000             ELEVATOR_MOTOR_SPRITE_4_X			= $697c
0710+  0000             ELEVATOR_MOTOR_SPRITE_4_NUM			= $697d
0711+  0000             ELEVATOR_MOTOR_SPRITE_4_PAL			= $697e
0712+  0000             ELEVATOR_MOTOR_SPRITE_4_Y			= $697f
0713+  0000             ; Sprite data for the 4 cage trigger sprites on the secret stage
0714+  0000             ; 16 bytes
0715+  0000             TRIGGER_SPRITES						= $6970
0716+  0000             TRIGGER_SPRITE_1					= $6970
0717+  0000             TRIGGER_SPRITE_2					= $6974
0718+  0000             TRIGGER_SPRITE_3					= $6978
0719+  0000             TRIGGER_SPRITE_4					= $697C
0720+  0000             ; Start of the 10 spring sprites
0721+  0000             SPRING_SPRITES						= $6980		; This is the start of the spring sprite data
0722+  0000             SPRING_SPRITE_1						= $6980		
0723+  0000             SPRING_SPRITE_2						= $6984		
0724+  0000             SPRING_SPRITE_3						= $6988		
0725+  0000             SPRING_SPRITE_4						= $698c		
0726+  0000             SPRING_SPRITE_5						= $6990		
0727+  0000             SPRING_SPRITE_6						= $6994		
0728+  0000             SPRING_SPRITE_7						= $6998		
0729+  0000             SPRING_SPRITE_8						= $699c		
0730+  0000             SPRING_SPRITE_9						= $69a0		
0731+  0000             SPRING_SPRITE_10					= $69a4
0732+  0000             ; Sprite data for the four standing barrels on the barrels stage
0733+  0000             STANDING_BARREL_SPRITE_DATA			= $69a8
0734+  0000             STANDING_BARREL_SPRITE_1			= $69a8
0735+  0000             STANDING_BARREL_SPRITE_1_X			= $69a8
0736+  0000             STANDING_BARREL_SPRITE_1_NUM		= $69a9
0737+  0000             STANDING_BARREL_SPRITE_1_PAL		= $69aa
0738+  0000             STANDING_BARREL_SPRITE_1_Y			= $69ab
0739+  0000             STANDING_BARREL_SPRITE_2			= $69ac
0740+  0000             STANDING_BARREL_SPRITE_2_X			= $69ac
0741+  0000             STANDING_BARREL_SPRITE_2_NUM		= $69ad
0742+  0000             STANDING_BARREL_SPRITE_2_PAL		= $69ae
0743+  0000             STANDING_BARREL_SPRITE_2_Y			= $69af
0744+  0000             STANDING_BARREL_SPRITE_3			= $69b0
0745+  0000             STANDING_BARREL_SPRITE_3_X			= $69b0
0746+  0000             STANDING_BARREL_SPRITE_3_NUM		= $69b1
0747+  0000             STANDING_BARREL_SPRITE_3_PAL		= $69b2
0748+  0000             STANDING_BARREL_SPRITE_3_Y			= $69b3
0749+  0000             STANDING_BARREL_SPRITE_4			= $69b4
0750+  0000             STANDING_BARREL_SPRITE_4_X			= $69b4
0751+  0000             STANDING_BARREL_SPRITE_4_NUM		= $69b5
0752+  0000             STANDING_BARREL_SPRITE_4_PAL		= $69b6
0753+  0000             STANDING_BARREL_SPRITE_4_Y			= $69b7
0754+  0000             ; Pie sprites (6 sprites in all)
0755+  0000             PIE_SPRITES							= $69b8
0756+  0000             PIE_SPRITE_1						= $69b8
0757+  0000             PIE_SPRITE_2						= $69bc
0758+  0000             PIE_SPRITE_3						= $69c0
0759+  0000             PIE_SPRITE_4						= $69c4
0760+  0000             PIE_SPRITE_5						= $69c8
0761+  0000             PIE_SPRITE_6						= $69cc
0762+  0000             ; Fireball sprites (5 sprites in all)
0763+  0000             FIREBALL_SPRITES					= $69d0
0764+  0000             FIREBALL_SPRITE_1					= $69d0
0765+  0000             FIREBALL_SPRITE_2					= $69d4
0766+  0000             FIREBALL_SPRITE_3					= $69d8
0767+  0000             FIREBALL_SPRITE_4					= $69dc
0768+  0000             FIREBALL_SPRITE_5					= $69e0
0769+  0000             ; Conveyer belt motor sprites (6 sprites)
0770+  0000             CONVEYER_MOTOR_SPRITES				= $69e4
0771+  0000             ; Top left conveyer motor
0772+  0000             CONV_MOTOR_SPRITE_TL				= $69e4
0773+  0000             CONV_MOTOR_SPRITE_TL_X				= $69e4
0774+  0000             CONV_MOTOR_SPRITE_TL_NUM			= $69e5
0775+  0000             CONV_MOTOR_SPRITE_TL_PAL			= $69e6
0776+  0000             CONV_MOTOR_SPRITE_TL_Y				= $69e7
0777+  0000             ; Top right conveyer motor
0778+  0000             CONV_MOTOR_SPRITE_TR				= $69e8
0779+  0000             CONV_MOTOR_SPRITE_TR_X				= $69e8
0780+  0000             CONV_MOTOR_SPRITE_TR_NUM			= $69e9
0781+  0000             CONV_MOTOR_SPRITE_TR_PAL			= $69ea
0782+  0000             CONV_MOTOR_SPRITE_TR_Y				= $69eb
0783+  0000             ; Middle right conveyer motor
0784+  0000             CONV_MOTOR_SPRITE_MR				= $69ec
0785+  0000             CONV_MOTOR_SPRITE_MR_X				= $69ec
0786+  0000             CONV_MOTOR_SPRITE_MR_NUM			= $69ed
0787+  0000             CONV_MOTOR_SPRITE_MR_PAL			= $69ee
0788+  0000             CONV_MOTOR_SPRITE_MR_Y				= $69ef
0789+  0000             ; Middle left conveyer motor
0790+  0000             CONV_MOTOR_SPRITE_ML				= $69f0
0791+  0000             CONV_MOTOR_SPRITE_ML_X				= $69f0
0792+  0000             CONV_MOTOR_SPRITE_ML_NUM			= $69f1
0793+  0000             CONV_MOTOR_SPRITE_ML_PAL			= $69f2
0794+  0000             CONV_MOTOR_SPRITE_ML_Y				= $69f3
0795+  0000             ; Bottom left conveyer motor
0796+  0000             CONV_MOTOR_SPRITE_BL				= $69f4
0797+  0000             CONV_MOTOR_SPRITE_BL_X				= $69f4
0798+  0000             CONV_MOTOR_SPRITE_BL_NUM			= $69f5
0799+  0000             CONV_MOTOR_SPRITE_BL_PAL			= $69f6
0800+  0000             CONV_MOTOR_SPRITE_BL_Y				= $69f7
0801+  0000             ; Bottom right conveyer motor
0802+  0000             CONV_MOTOR_SPRITE_BR				= $69f8
0803+  0000             CONV_MOTOR_SPRITE_BR_X				= $69f8
0804+  0000             CONV_MOTOR_SPRITE_BR_NUM			= $69f9
0805+  0000             CONV_MOTOR_SPRITE_BR_PAL			= $69fa
0806+  0000             CONV_MOTOR_SPRITE_BR_Y				= $69fb
0807+  0000             ; The oil barrel sprite
0808+  0000             OIL_BARREL_SPRITE					= $69fc
0809+  0000             OIL_BARREL_SPRITE_X					= $69fc
0810+  0000             OIL_BARREL_SPRITE_NUM				= $69fd
0811+  0000             OIL_BARREL_SPRITE_PAL				= $69fe
0812+  0000             OIL_BARREL_SPRITE_Y					= $69ff
0813+  0000             
0814+  0000             ; Prize sprites (3 sprites)
0815+  0000             PRIZE_SPRITES						= $6a0c
0816+  0000             PRIZE_SPRITE_1						= $6a0c
0817+  0000             PRIZE_SPRITE_2						= $6a10
0818+  0000             PRIZE_SPRITE_3						= $6a14
0819+  0000             ; The start of the two hammer sprites on a level
0820+  0000             HAMMER_SPRITES						= $6a18
0821+  0000             HAMMER_SPRITE_1						= $6a18
0822+  0000             HAMMER_SPRITE_2						= $6a1c
0823+  0000             
0824+  0000             HEART_SPRITE						= $6a20
0825+  0000             HEART_SPRITE_X						= $6a20
0826+  0000             HEART_SPRITE_NUM					= $6a21
0827+  0000             HEART_SPRITE_PAL					= $6a22
0828+  0000             HEART_SPRITE_Y						= $6a23
0829+  0000             DK_STARS_SPRITE						= $6a24
0830+  0000             DK_STARS_SPRITE_X					= $6a24
0831+  0000             DK_STARS_SPRITE_NUM					= $6a25
0832+  0000             DK_STARS_SPRITE_PAL					= $6a26
0833+  0000             DK_STARS_SPRITE_Y					= $6a27
0834+  0000             BARREL_FIRE_SPRITE					= $6a28	; The oil barrel fire sprite
0835+  0000             BARREL_FIRE_SPRITE_X				= $6a28			
0836+  0000             BARREL_FIRE_SPRITE_NUM				= $6a29
0837+  0000             BARREL_FIRE_SPRITE_PAL				= $6a2a
0838+  0000             BARREL_FIRE_SPRITE_Y				= $6a2b
0839+  0000             SMASH_SPRITE						= $6a2c	; The smash animation sprite (displayed when Mario hits an enemy with the hammer)
0840+  0000             SMASH_SPRITE_X						= $6a2c
0841+  0000             SMASH_SPRITE_NUM					= $6a2d
0842+  0000             SMASH_SPRITE_PAL					= $6a2e
0843+  0000             SMASH_SPRITE_Y						= $6a2f
0844+  0000             AWARD_SPRITE						= $6a30
0845+  0000             AWARD_SPRITE_X						= $6a30
0846+  0000             AWARD_SPRITE_NUM					= $6a31
0847+  0000             AWARD_SPRITE_PAL					= $6a32
0848+  0000             AWARD_SPRITE_Y						= $6a33
0849+  0000             	
0850+  0000             P1_INPUT							= $7c00
0851+  0000             P1_INPUT_RESET_BIT						= 6		; Reset game?
0852+  0000             P1_INPUT_JUMP_BIT						= 5		; Jump button
0853+  0000             P1_INPUT_DOWN_BIT						= 3
0854+  0000             P1_INPUT_UP_BIT							= 2
0855+  0000             P1_INPUT_LEFT_BIT						= 1
0856+  0000             P1_INPUT_RIGHT_BIT						= 0
0857+  0000             
0858+  0000             SONG_OUTPUT							= $7c00
0859+  0000             
0860+  0000             P2_INPUT							= $7c80
0861+  0000             P2_INPUT_RESET_BIT						= 6		; Reset game?
0862+  0000             P2_INPUT_JUMP_BIT						= 5		; Jump button
0863+  0000             P2_INPUT_DOWN_BIT						= 3
0864+  0000             P2_INPUT_UP_BIT							= 2
0865+  0000             P2_INPUT_LEFT_BIT						= 1
0866+  0000             P2_INPUT_RIGHT_BIT						= 0
0867+  0000             
0868+  0000             MISC_INPUT							= $7d00
0869+  0000             MISC_INPUT_COIN_BIT						= 7		; Coin entered
0870+  0000             MISC_INPUT_START_2P_BIT					= 3		; 2 player start
0871+  0000             MISC_INPUT_START_1P_BIT					= 2		; 1 player start
0872+  0000             MISC_INPUT_TAMPER_BIT					= 0		; If this is 1, the code jumps to l4000
0873+  0000             
0874+  0000             WALK_SOUND_OUTPUT					= $7d00		; Causes the walking sound to play
0875+  0000             JUMP_SOUND_OUTPUT					= $7d01		; Causes the jumping sound to play
0876+  0000             STOMP_SOUND_OUTPUT					= $7d02		; Causes the Donkey Kong stomping sound to play
0877+  0000             SPRING_SOUND_OUTPUT					= $7d03		; Causes the spring bounce sound to play
0878+  0000             FALL_SOUND_OUTPUT					= $7d04		; Causes the falling spring sound to play
0879+  0000             
0880+  0000             TIME_RUNNING_OUT_SOUND_OUTPUT		= $7d09		; Causes the time running out sound to play
0881+  0000             
0882+  0000             DIP_INPUT							= $7d80
0883+  0000             	; Bit 7 Cocktail (0) or Upright (1)
0884+  0000             	; Bit 6 \ 000 = 1 coin/1 play  001 = 1 coin/2 play  010 = 1 coin/3 play
0885+  0000             	; Bit 5 | 011 = 1 coin/4 play  100 = 2 coin/1 play  101 = 3 coin/1 play
0886+  0000             	; Bit 4 / 110 = 4 coin/1 play  111 = 5 coin/1 play
0887+  0000             	; Bit 3 \ Bonus at
0888+  0000             	; Bit 2 / 00 = 7000  01 = 10000  10 = 15000  11 = 20000
0889+  0000             	; Bit 1 \ 00 = 3 lives  01 = 4 lives
0890+  0000             	; Bit 0 / 10 = 5 lives  11 = 6 lives
0891+  0000             
0892+  0000             DEATH_SOUND_OUTPUT					= $7d80
0893+  0000             
0894+  0000             SCREEN_ORIENTATION					= $7d82
0895+  0000             	; 0 = flipped
0896+  0000             	; 1 = standard
0897+  0000             
0898+  0000             INTERRUPT_ENABLE            		= $7d84
0899+  0000             
0900+  0000             PALETTE_1_OUTPUT					= $7d86
0901+  0000             PALETTE_2_OUTPUT					= $7d87
0902+  0000             
0004   0000             #include "constants+.h"
0001+  0000             ; Various constants used in Donkey Kong
0002+  0000             
0003+  0000             ; The following macro allows tile coordinates to be entered as x,y coordinates rather
0004+  0000             ; than bare memory addresses
0005+  0000             #define		TILE_COORD(x,y)			$7400 + (x * 32) + y
0006+  0000             
0007+  0000             ; The following macro combines two bytes into a single word
0008+  0000             ;#define		TWO_BYTES(a,b)			(b & $ff) | ((a & $ff) << 8) & $ffff
0009+  0000             #define		TWO_BYTES(a,b)			(a * 256) + b
0010+  0000             
0011+  0000             ; The following macro assembles a block of stage data given:
0012+  0000             ;	t - the tile type
0013+  0000             ;	x1, y1 - the starting coordinate of the line of tiles
0014+  0000             ;	x2, y2 - the ending coordinate of the line of tiles
0015+  0000             #define		STAGE_DATA(t,x1,y1,x2,y2) .byte (t)\ .word ((y1<<11) | (x1<<3) & $ffff) \ .word ((y2<<11) + (x2<<3) & $ffff)
0016+  0000             #define		NRM_LAD_STAGE_DATA(x1,y1,x2,y2) .byte 0\ .word ((y1<<11) | (x1<<3 | 0011) & $ffff) \ .word ((y2<<11) | (x2<<3 | 0011) & $ffff)
0017+  0000             #define		BRK_LAD_STAGE_DATA(x1,y1,x2,y2) .byte 1\ .word ((y1<<11) | (x1<<3 | 0011) & $ffff) \ .word ((y2<<11) | (x2<<3 | 0011) & $ffff)
0018+  0000             #define		X_STAGE_DATA(x1,y1,x2,y2) .byte 6\ .word ((y1<<11) | (x1<<3 | 0011) & $ffff) \ .word ((y2<<11) | (x2<<3 | 0011) & $ffff)
0019+  0000             ; The following macro converts an x,y coordinate into a stage data location
0020+  0000             #define		STAGE_COORD(x,y)		((y<<11) | (x<<3)) & $ffff
0021+  0000             #define		STAGE_DATA_END 			.byte 	$AA
0022+  0000             
0023+  0000             ; Collision area sprites
0024+  0000             K_COLLISION_SPRITE_NUM				= $3f	; The sprite number used for the collision sprites aroung Donkey Kong
0025+  0000             K_COLLISION_SPRITE_PAL				= $0c
0026+  0000             K_COLLISION_SPRITE_WIDTH			= 8
0027+  0000             K_COLLISION_SPRITE_HEIGHT			= 8
0028+  0000             
0029+  0000             K_COLLISION_1_X_RIVETS				= 115	; X coordinate of the 1st collision sprite
0030+  0000             K_COLLISION_1_Y_RIVETS				= 80	; Y coordinate of the 1st collision sprite
0031+  0000             K_COLLISION_2_X_RIVETS				= 141	; X coordinate of the 2nd collision sprite
0032+  0000             K_COLLISION_2_Y_RIVETS				= 80	; Y coordinate of the 2nd collision sprite
0033+  0000             
0034+  0000             K_COLLISION_X_BARRELS				= 70	; X coordinate of the collision sprite on the barrels and elevators stages
0035+  0000             K_COLLISION_Y_BARRELS				= 76	; Y coordinate of the collision sprite on the barrels and elevators stages
0036+  0000             
0037+  0000             K_COLLISION_X_ELEVATORS				= 70	; X coordinate of the collision sprite on the barrels and elevators stages
0038+  0000             K_COLLISION_Y_ELEVATORS				= 80	; Y coordinate of the collision sprite on the barrels and elevators stages
0039+  0000             
0040+  0000             ; Mario's starting coordinate on the barrels, mixer, and rivets stages
0041+  0000             MARIO_START_COORD					= TWO_BYTES(240,63) ; (63,240)
0042+  0000             
0043+  0000             ; Mario's starting coordinate on the elevators stage
0044+  0000             MARIO_START_COORD_ELEVATORS			= TWO_BYTES(224,22)	; (22,224)
0005   0000             
0006   0000             		.org	$00
0007   0000             		
0008   0000             ;------------------------------------------------------------------------------
0009   0000             ; Program entry point
0010   0000 AF          L_ORG:  xor     a                       	; Disable interrupts
0011   0001 32 84 7D            ld      (INTERRUPT_ENABLE),a        ; ''
0012   0004 C3 52 02            jp      L_INIT_GAME              	; Initialize the game
0013   0007             ;------------------------------------------------------------------------------
0014   0007             
0015   0007             
0016   0007             
0017   0007             ;------------------------------------------------------------------------------
0018   0007             ; Check if demo mode is active (no coins have been inserted).  
0019   0007             ; If it is, abort the calling function        
0020   0007             ; Note: This code MUST start at address 0008h.
0021   0008             		.org	$08
0022   0008 3A 07 60    l0008:  ld      a,(NO_COINS_INSERTED)
0023   000B 0F                  rrca    
0024   000C D0                  ret     nc							; Return if NO_COINS_INSERTED == 0
0025   000D 33                  inc     sp		
0026   000E 33                  inc     sp							; Return from calling function otherwise
0027   000F C9                  ret     						
0028   0010             ;------------------------------------------------------------------------------
0029   0010             
0030   0010             
0031   0010             		
0032   0010             ;------------------------------------------------------------------------------
0033   0010             ; Check if Mario is dead.  If he is, abort the calling function
0034   0010             ; NOTE: This code MUST start at address 0010h.
0035   0010             		.org	$10
0036   0010 3A 00 62    l0010:  ld      a,(MARIO_ALIVE)
0037   0013 0F                  rrca    							; Return if MARIO_ALIVE == 1
0038   0014 D8                  ret     c
0039   0015 E1                  pop		hl							; Return from calling function otherwise
0040   0016 C9                  ret     
0041   0017             ;------------------------------------------------------------------------------
0042   0017             
0043   0017             
0044   0017             
0045   0017             ;------------------------------------------------------------------------------
0046   0017             ; Decrement the minor timer.  If it has not reached 0, abort the calling function
0047   0018             		.org $18
0048   0018 21 09 60    l0018:  ld      hl,MINOR_TIMER				; -- MINOR_TIMER
0049   001B 35                  dec     (hl)
0050   001C C8                  ret     z							; Return if MINOR_TIMER has reached 0
0051   001D E1                  pop		hl							; Return from the calling function otherwise
0052   001E C9                  ret     
0053   001F             ;------------------------------------------------------------------------------
0054   001F             
0055   001F             
0056   001F             
0057   001F             ;------------------------------------------------------------------------------
0058   001F             ; Decrement the major timer.  If it has not reached 0, abort the calling function
0059   001F             ; If it has reached 0, decrement MINOR_TIMER and return from the calling function 
0060   001F             ; if it has not reached 0.
0061   001F             ; NOTE: This function MUST start at address $0020
0062   0020             		.org	$20
0063   0020 21 08 60            ld      hl,MAJOR_TIMER
0064   0023 35                  dec     (hl)						; --MAJOR_TIMER
0065   0024 28 F2               jr      z,l0018
0066   0026 E1          l0026:  pop     hl
0067   0027 C9                  ret     
0068   0028             ;------------------------------------------------------------------------------
0069   0028             
0070   0028             
0071   0028             
0072   0028             ;------------------------------------------------------------------------------
0073   0028             ; Retrieve an address in a jump table immediately following the instruction
0074   0028             ; that called this function and jump to the address.
0075   0028             ; NOTE: This function MUST start at address 0028h.
0076   0028             ;
0077   0028             ; passed: a - the table index to jump to 
0078   0028                     .org    $28
0079   0028 87                  add     a,a							; A *= 2
0080   0029 E1                  pop     hl							; HL = the address of the instruction that called this function
0081   002A 5F                  ld      e,a							
0082   002B 16 00               ld      d,0							; DE = table index offset
0083   002D C3 32 00            jp      l0032						; Skip the next instruction
0084   0030             		
0085   0030             ; The following instruction is not part of the previous function
0086   0030             ; NOTE: This instruction MUST be at address $0030		
0087   0030             		.org	$30
0088   0030 18 12               jr      l0044
0089   0032             		
0090   0032 19          l0032:  add     hl,de						; HL = address of table entry
0091   0033 5E                  ld      e,(hl)						
0092   0034 23                  inc     hl
0093   0035 56                  ld      d,(hl)
0094   0036 EB                  ex      de,hl						; HL = entry in table
0095   0037 E9                  jp      (hl)						; Jump to the address
0096   0038             ;------------------------------------------------------------------------------
0097   0038             
0098   0038             
0099   0038             
0100   0038             ;------------------------------------------------------------------------------
0101   0038             ; Move the 10 sprites that make up Donkey Kong either horizontally or
0102   0038             ; vertically by adding the amount in c to every 4th byte starting at the
0103   0038             ; address in hl.
0104   0038             ;
0105   0038             ; NOTE: This function MUST start at address 0038h.
0106   0038             ;
0107   0038             ; passed: 	hl - the address of the first sprites x or y coord
0108   0038             ;			c - the amount to move the sprite 
0109   0038             		.org $38
0110   0038 06 0A       l0038:  ld      b,10
0111   003A             L_MOVE_N_SPRITES:  
0112   003A 11 04 00    		ld      de,4
0113   003D             l_move_n_sprites_1:
0114   003D 79                  ld      a,c
0115   003E 86                  add     a,(hl)
0116   003F 77                  ld      (hl),a
0117   0040 19                  add     hl,de
0118   0041 10 FA               djnz    l_move_n_sprites_1
0119   0043 C9                  ret     
0120   0044             ;------------------------------------------------------------------------------
0121   0044             
0122   0044             
0123   0044             
0124   0044             ;------------------------------------------------------------------------------
0125   0044             ; Return from the calling function unless the stage is one of the stages of 
0126   0044             ; interest.
0127   0044             ; Checks if the bit in a corresponding to the current stage is set.  This
0128   0044             ; allows multiple stages to be checked for.
0129   0044             ; passed:	a - the stage bit mask
0130   0044 21 27 62    l0044:  ld      hl,CURRENT_STAGE
0131   0047 46                  ld      b,(hl)
0132   0048 0F          l0048:  rrca    
0133   0049 10 FD               djnz    l0048
0134   004B D8                  ret     c
0135   004C E1                  pop     hl
0136   004D C9                  ret     
0137   004E             ;------------------------------------------------------------------------------
0138   004E             
0139   004E             
0140   004E             
0141   004E             ;------------------------------------------------------------------------------
0142   004E             ; Copy Donkey Kong sprites from a ROM address into the Donkey Kong sprite 
0143   004E             ; memory
0144   004E             ; passed:  hl - source address
0145   004E             L_LOAD_DK_SPRITES:  
0146   004E 11 08 69    		ld      de,DK_SPRITE_1_X
0147   0051 01 28 00            ld      bc,40   
0148   0054 ED B0               ldir    
0149   0056 C9                  ret     
0150   0057             ;------------------------------------------------------------------------------
0151   0057             
0152   0057             
0153   0057             
0154   0057             ;------------------------------------------------------------------------------
0155   0057             ; Update the random number by adding the values of the two counters to the 
0156   0057             ; current random number
0157   0057             ; 
0158   0057             ; passed:	none
0159   0057             ; return:	a - random number
0160   0057             ;			hl - COUNTER_1 
0161   0057             L_UPDATE_RAND_NUM:  
0162   0057 3A 18 60    		ld      a,(RANDOM_NUMBER)
0163   005A 21 1A 60            ld      hl,COUNTER_2
0164   005D 86                  add     a,(hl)
0165   005E 21 19 60            ld      hl,COUNTER_1
0166   0061 86                  add     a,(hl)
0167   0062 32 18 60            ld      (RANDOM_NUMBER),a
0168   0065 C9                  ret 
0169   0066             ;------------------------------------------------------------------------------
0170   0066                 
0171   0066             		
0172   0066             
0173   0066             ;------------------------------------------------------------------------------
0174   0066             ; Interrupt handler
0175   0066             ; Called periodically to update the game state		
0176   0066             		.org	$66
0177   0066             L_INTERRUPT_HANDLER:  
0178   0066             		; Push the registers onto the stack
0179   0066 F5          		push    af
0180   0067 C5                  push    bc
0181   0068 D5                  push    de
0182   0069 E5                  push    hl
0183   006A DD E5               push    ix
0184   006C FD E5               push    iy
0185   006E             		
0186   006E AF                  xor     a
0187   006F 32 84 7D            ld      (INTERRUPT_ENABLE),a		; Disable interrupts
0188   0072             		
0189   0072 3A 00 7D            ld      a,(MISC_INPUT)				; If bit 0 of INPUT2 is 0, abort the game 
0190   0075 E6 01               and     1
0191   0077 C2 00 40            jp      nz,l4000
0192   007A             		
0193   007A             ; Configure the P8257		
0194   007A 21 2B 01            ld      hl,L_P8257_REGISTER_DATA
0195   007D CD 34 01            call    L_CONFIG_P8257
0196   0080             		
0197   0080             		; Skip player handling if no coin has been inserted (attract mode is active)
0198   0080 3A 07 60            ld      a,(NO_COINS_INSERTED)
0199   0083 A7                  and     a
0200   0084 20 26               jr      nz,l00b5
0201   0086             		
0202   0086             		; Ignore player 2 input if this is an upright cabinet
0203   0086 3A 26 60            ld      a,(CABINET_TYPE)
0204   0089 A7                  and     a
0205   008A 20 09               jr      nz,l0098
0206   008C             		
0207   008C             		; If player 2 is active, get player 2 input
0208   008C 3A 0E 60            ld      a,(SECOND_PLAYER)
0209   008F A7                  and     a
0210   0090 3A 80 7C            ld      a,(P2_INPUT)
0211   0093 20 03               jr      nz,l009b
0212   0095             		
0213   0095             		; Get player 1 input
0214   0095 3A 00 7C    l0098:  ld      a,(P1_INPUT)
0215   0098             
0216   0098             		; Read the input and save the old input in PLAYER_INPUT_LAG
0217   0098 47          l009b:  ld      b,a
0218   0099 E6 0F               and     $0f
0219   009B 4F                  ld      c,a
0220   009C 3A 11 60            ld      a,(PLAYER_INPUT_LAG)
0221   009F 2F                  cpl     
0222   00A0 A0                  and     b
0223   00A1 E6 10               and     $10
0224   00A3 17                  rla     
0225   00A4 17                  rla     
0226   00A5 17                  rla     
0227   00A6 B1                  or      c
0228   00A7 60                  ld      h,b
0229   00A8 6F                  ld      l,a
0230   00A9 22 10 60            ld      (PLAYER_INPUT),hl		; Save player input and player input lag
0231   00AC             		
0232   00AC             		; Decrement COUNTER_2 on every interrupt
0233   00AC 21 1A 60    l00b5:  ld      hl,COUNTER_2
0234   00AF 35                  dec     (hl)
0235   00B0             		
0236   00B0 CD 57 00            call    L_UPDATE_RAND_NUM		; Update the random number
0237   00B3 CD 6E 01            call    L_CHECK_FOR_COIN		; Check for coins
0238   00B6 CD D7 00            call    L_PLAY_SOUNDS			; Play sounds
0239   00B9                     
0240   00B9             		; Make sure registers are popped from the stack after the next function
0241   00B9 21 C9 00    		ld      hl,L_POP_REGISTERS_FROM_STACK				
0242   00BC E5                  push    hl
0243   00BD             		
0244   00BD             		; Jump to a function based on the current game state
0245   00BD 3A 05 60            ld      a,(GAME_STATE)
0246   00C0 EF                  rst     $28							; Jump to local table address
0247   00C1             		; Jump table
0248   00C1 B4 01       		.word	L_INIT_ATTRACT_MODE ; 0 = Prepare attract mode
0249   00C3 0E 07       		.word	L_IMPLEMENT_ATTRACT_MODE ; 1 = Implement attract mode
0250   00C5 77 08       		.word	L_WAITING_FOR_START_MODE	; 2 = Start game
0251   00C7 DA 06       		.word	L_IMPLEMENT_GAME_PLAY	; 3 = Display current game screen
0252   00C9             ;------------------------------------------------------------------------------
0253   00C9             
0254   00C9             
0255   00C9                     
0256   00C9             ;------------------------------------------------------------------------------
0257   00C9             ; Pop the registers from the stack
0258   00C9             L_POP_REGISTERS_FROM_STACK:  
0259   00C9 FD E1       		pop     iy
0260   00CB DD E1               pop     ix
0261   00CD E1                  pop     hl
0262   00CE D1                  pop     de
0263   00CF C1                  pop     bc
0264   00D0 3E 01               ld      a,$01
0265   00D2 32 84 7D            ld      (INTERRUPT_ENABLE),a
0266   00D5 F1                  pop     af
0267   00D6 C9                  ret 
0268   00D7             ;------------------------------------------------------------------------------
0269   00D7             
0270   00D7             
0271   00D7             ;------------------------------------------------------------------------------
0272   00D7             ; Play sounds if not in attract mode
0273   00D7             L_PLAY_SOUNDS:  
0274   00D7 21 80 60    		ld      hl,WALK_SOUND_TRIGGER
0275   00DA 11 00 7D            ld      de,WALK_SOUND_OUTPUT
0276   00DD             		
0277   00DD             		; Don't play sounds if attract mode is active
0278   00DD 3A 07 60            ld      a,(NO_COINS_INSERTED)
0279   00E0 A7                  and     a
0280   00E1 C0                  ret     nz
0281   00E2             
0282   00E2             		; Pass each sound trigger to the sound chip
0283   00E2 06 08               ld      b,8				; For b = 8 to 1
0284   00E4 7E          l00ed:  ld      a,(hl)			; a > 0 if the current sound should be played
0285   00E5 A7                  and     a
0286   00E6             		
0287   00E6             		; If this sound has not been triggered, jump ahead
0288   00E6 28 03               jr      z,l00f5		
0289   00E8             		
0290   00E8 35                  dec     (hl)			; Decrement the sound trigger value
0291   00E9 3E 01               ld      a,1
0292   00EB 12          l00f5:  ld      (de),a			; Turn the sound on or off
0293   00EC 1C                  inc     e				; Advance to the next sound and trigger
0294   00ED 2C                  inc     l
0295   00EE 10 F4               djnz    l00ed			; Next b
0296   00F0             		
0297   00F0             		; If the current song needs to be triggered, jump ahead
0298   00F0 21 8B 60            ld      hl,PENDING_SONG_TRIGGER_REPEAT
0299   00F3 7E                  ld      a,(hl)
0300   00F4 A7                  and     a
0301   00F5 20 05               jr      nz,l0108
0302   00F7             		
0303   00F7             		; Set or clear the SONG_TRIGGER
0304   00F7 2D                  dec     l
0305   00F8 2D                  dec     l
0306   00F9 7E                  ld      a,(hl)
0307   00FA 18 03               jr      l010b
0308   00FC             		
0309   00FC             		; Turn on the song trigger
0310   00FC 35          l0108:  dec     (hl)
0311   00FD 2D                  dec     l
0312   00FE 7E                  ld      a,(hl)
0313   00FF             		
0314   00FF             		; Turn on or off the song
0315   00FF 32 00 7C    l010b:  ld      (SONG_OUTPUT),a
0316   0102                     
0317   0102             		; If the death sound is not playing, jump ahead
0318   0102 21 88 60    		ld      hl,DEATH_SOUND_TRIGGER
0319   0105 AF                  xor     a				; a = 0
0320   0106 BE                  cp      (hl)
0321   0107 28 02               jr      z,l0118
0322   0109             		
0323   0109             		; Decrement the death sound counter to not trigger the sound
0324   0109 35                  dec     (hl)
0325   010A 3C                  inc     a				; a = 1
0326   010B             		
0327   010B             		; Trigger or turn off the death sound
0328   010B 32 80 7D    l0118:  ld      (DEATH_SOUND_OUTPUT),a
0329   010E C9                  ret   
0330   010F             ;------------------------------------------------------------------------------
0331   010F               
0332   010F             
0333   010F             
0334   010F             ;------------------------------------------------------------------------------
0335   010F             ; Turn off all sounds 
0336   010F             L_SOUNDS_OFF:  
0337   010F             		; All sound triggers and sound outputs
0338   010F 06 08       		ld      b,8		; For b = 8 to 1
0339   0111 AF                  xor     a			; a = 0
0340   0112 21 00 7D            ld      hl,WALK_SOUND_OUTPUT
0341   0115 11 80 60            ld      de,WALK_SOUND_TRIGGER
0342   0118 77          l0125:  ld      (hl),a
0343   0119 12                  ld      (de),a
0344   011A 2C                  inc     l
0345   011B 1C                  inc     e
0346   011C 10 FA               djnz    l0125		; Next b
0347   011E             
0348   011E             		; Clear ($7d08-$7d0c)
0349   011E 06 04               ld      b,4		; For b = 4 to 1
0350   0120 12          l012d:  ld      (de),a
0351   0121 1C                  inc     e
0352   0122 10 FC               djnz    l012d		; Next b
0353   0124             
0354   0124             		; Clear song outputs
0355   0124 32 80 7D            ld      (DEATH_SOUND_OUTPUT),a
0356   0127 32 00 7C            ld      (SONG_OUTPUT),a
0357   012A C9                  ret     
0358   012B             ;------------------------------------------------------------------------------
0359   012B             
0360   012B             
0361   012B             		
0362   012B             ;------------------------------------------------------------------------------
0363   012B             ; P8257 control register settings
0364   012B             L_P8257_REGISTER_DATA:
0365   012B 53          		.byte	$53		; Sent to $7808
0366   012C 00          		.byte	$00		; Sent to $7800
0367   012D 69          		.byte	$69		; Sent to $7800
0368   012E 80          		.byte	$80		; Sent to $7801
0369   012F 41          		.byte	$41		; Sent to $7801
0370   0130 00          		.byte	$00		; Sent to $7802
0371   0131 70          		.byte	$70		; Sent to $7802
0372   0132 80          		.byte	$80		; Sent to $7803
0373   0133 81          		.byte	$81		; Send to $7803
0374   0134             ;------------------------------------------------------------------------------
0375   0134             
0376   0134             		
0377   0134             
0378   0134             ;------------------------------------------------------------------------------
0379   0134             ; Set P8257 control registers
0380   0134             ; passed:	hl - set to point to L_P8257_REGISTER_DATA
0381   0134             L_CONFIG_P8257:  
0382   0134 AF          		xor     a
0383   0135 32 85 7D            ld      ($7d85),a
0384   0138 7E                  ld      a,(hl)
0385   0139 32 08 78            ld      ($7808),a
0386   013C 23                  inc     hl
0387   013D 7E                  ld      a,(hl)
0388   013E 32 00 78            ld      ($7800),a
0389   0141 23                  inc     hl
0390   0142 7E                  ld      a,(hl)
0391   0143 32 00 78            ld      ($7800),a
0392   0146 23                  inc     hl
0393   0147 7E                  ld      a,(hl)
0394   0148 32 01 78            ld      ($7801),a
0395   014B 23                  inc     hl
0396   014C 7E                  ld      a,(hl)
0397   014D 32 01 78            ld      ($7801),a
0398   0150 23                  inc     hl
0399   0151 7E                  ld      a,(hl)
0400   0152 32 02 78            ld      ($7802),a
0401   0155 23                  inc     hl
0402   0156 7E                  ld      a,(hl)
0403   0157 32 02 78            ld      ($7802),a
0404   015A 23                  inc     hl
0405   015B 7E                  ld      a,(hl)
0406   015C 32 03 78            ld      ($7803),a
0407   015F 23                  inc     hl
0408   0160 7E                  ld      a,(hl)
0409   0161 32 03 78            ld      ($7803),a
0410   0164 3E 01               ld      a,$01
0411   0166 32 85 7D            ld      ($7d85),a
0412   0169 AF                  xor     a
0413   016A 32 85 7D            ld      ($7d85),a
0414   016D C9                  ret     
0415   016E             ;------------------------------------------------------------------------------
0416   016E             
0417   016E             
0418   016E             
0419   016E             ;------------------------------------------------------------------------------
0420   016E             ; Check for and handle coin insertion
0421   016E             L_CHECK_FOR_COIN:  
0422   016E 3A 00 7D    		ld      a,(MISC_INPUT)
0423   0171 CB 7F               bit     MISC_INPUT_COIN_BIT,a
0424   0173 21 03 60            ld      hl,COIN_VALID
0425   0176             		; Jump ahead if a coin is being insered
0426   0176 20 03               jr      nz,l0189
0427   0178             		
0428   0178             		; Mark the next coin insertion as valid
0429   0178 36 01               ld      (hl),1
0430   017A C9                  ret     
0431   017B             
0432   017B             		; Return if this coin has already been registered
0433   017B 7E          l0189:  ld      a,(hl)
0434   017C A7                  and     a
0435   017D C8                  ret     z
0436   017E             		
0437   017E E5                  push    hl					; Save COIN_VALID address to the stack
0438   017F             		
0439   017F             		; If the player is playing skip sound stuff
0440   017F 3A 05 60            ld      a,(GAME_STATE)
0441   0182 FE 03               cp      GAME_STATE_PLAY
0442   0184 28 08               jr      z,l019d
0443   0186             		
0444   0186 CD 0F 01            call    L_SOUNDS_OFF		; Turn off all sounds
0445   0189             		
0446   0189             		; Trigger coin insertion sound
0447   0189 3E 03               ld      a,3
0448   018B 32 83 60            ld      (SPRING_SOUND_TRIGGER),a
0449   018E             		
0450   018E             		; Mark this coin insertion as invalid so that it is not reprocessed
0451   018E E1          l019d:  pop     hl					; Restore COIN_VALID address from the stack
0452   018F 36 00               ld      (hl),$00
0453   0191             
0454   0191             		; Add this coin to the coins waiting to be processed
0455   0191 2B          		dec     hl					; hl = NUM_COINS_PENDING
0456   0192 34                  inc     (hl)
0457   0193             		
0458   0193             		; Return if there are not enough coins for one credit
0459   0193 11 24 60            ld      de,DIP_COINS_PER_CREDIT
0460   0196 1A                  ld      a,(de)
0461   0197 96                  sub     (hl)
0462   0198 C0                  ret     nz
0463   0199             		
0464   0199             		; Convert coins to credits
0465   0199 77                  ld      (hl),a				; Spend all the pending coins
0466   019A 13                  inc     de					; de = DIP_PLAYS_PER_CREDIT
0467   019B 2B                  dec     hl					; hl = NUM_PLAYS
0468   019C EB                  ex      de,hl				
0469   019D 1A                  ld      a,(de)
0470   019E             		
0471   019E             		; Return if 90 credits have been paid for (the max that can be handled)
0472   019E FE 90               cp      $90
0473   01A0 D0                  ret     nc
0474   01A1             		
0475   01A1             		; Add the number of plays that have been earned for the credits that have been paid for
0476   01A1 86                  add     a,(hl)
0477   01A2 27                  daa     					; Adjust a to BCD digits
0478   01A3 12                  ld      (de),a				; Save the number of plays
0479   01A4             		
0480   01A4             		; Update the number of plays that are displayed
0481   01A4 11 00 04            ld      de,$0400
0482   01A7 CD 36 31            call    L_ADD_EVENT
0483   01AA C9                  ret     
0484   01AB             ;------------------------------------------------------------------------------
0485   01AB             
0486   01AB             
0487   01AB             
0488   01AB             ;------------------------------------------------------------------------------
0489   01AB             ; The default initial score values
0490   01AB             L_INITIAL_SCORE_DATA:
0491   01AB 00 37 00    		.byte	$00, $37, $00	; Player 1 score = 003700
0492   01AE AA AA       		.byte	$aa, $aa, 		; Player 2 score = blank
0493   01B0             L_BLANK_SCORE_DATA:	; The $aa bytes display a blank score
0494   01B0 AA          			.byte $aa
0495   01B1 50 76 00    		.byte	$50, $76, $00	; High score = 007650
0496   01B4             ;------------------------------------------------------------------------------
0497   01B4             		
0498   01B4             
0499   01B4             
0500   01B4             ;------------------------------------------------------------------------------
0501   01B4             ; Initialize the attract mode
0502   01B4             L_INIT_ATTRACT_MODE:  
0503   01B4 CD 3D 08    		call    L_CLEAR_STAGE_SCREEN
0504   01B7             
0505   01B7             		; Load the initially displayed scores from ROM
0506   01B7 21 AB 01            ld      hl,L_INITIAL_SCORE_DATA
0507   01BA 11 B2 60            ld      de,PREV_P1_SCORE
0508   01BD 01 09 00            ld      bc,9
0509   01C0 ED B0               ldir    
0510   01C2             		
0511   01C2             		; Initialize the attract mode
0512   01C2 3E 01               ld      a,1
0513   01C4 32 07 60            ld      (NO_COINS_INSERTED),a		; In attract mode, waiting for coins
0514   01C7 32 29 62            ld      (CP_LEVEL_NUMBER),a			; Level 1
0515   01CA 32 28 62            ld      (CP_NUMBER_LIVES),a			; 1 life
0516   01CD             		
0517   01CD CD 96 06            call    L_DISPLAY_LIVES_AND_LEVEL									; Display lives and level
0518   01D0 CD F8 01            call    L_LOAD_DIP_SETTINGS
0519   01D3             
0520   01D3 3E 01               ld      a,1
0521   01D5 32 82 7D            ld      (SCREEN_ORIENTATION),a		; Orient the screen normally
0522   01D8 32 05 60    		ld      (GAME_STATE),a				; In attract mode
0523   01DB 32 27 62            ld      (CURRENT_STAGE),a			; Starting on the barrels stage
0524   01DE             
0525   01DE AF                  xor     a
0526   01DF 32 0A 60            ld      (GAME_SUBSTATE),a			; Displaying the coin entry screen
0527   01E2 CD 10 0A            call    L_DISPLAY_1UP
0528   01E5 11 04 03            ld      de,$0304
0529   01E8 CD 36 31            call    L_ADD_EVENT					; Display "HIGH SCORE"
0530   01EB 11 02 02            ld      de,$0202
0531   01EE CD 36 31            call    L_ADD_EVENT					; Display the high score
0532   01F1 11 00 02            ld      de,$0200
0533   01F4 CD 36 31            call    L_ADD_EVENT					; Display player 1's score
0534   01F7 C9                  ret     
0535   01F8             ;------------------------------------------------------------------------------
0536   01F8             
0537   01F8             
0538   01F8             
0539   01F8             ;------------------------------------------------------------------------------
0540   01F8             ; Load DIP settings and default high score table
0541   01F8             L_LOAD_DIP_SETTINGS:  
0542   01F8             		; Read the number of lives setting
0543   01F8 3A 80 7D    		ld      a,(DIP_INPUT)
0544   01FB 4F                  ld      c,a
0545   01FC 21 20 60            ld      hl,DIP_NUM_LIVES
0546   01FF E6 03               and     %00000011
0547   0201 C6 03               add     a,3
0548   0203 77                  ld      (hl),a
0549   0204             
0550   0204             		; Read the bonus life setting
0551   0204 23                  inc     hl
0552   0205 79                  ld      a,c
0553   0206 0F                  rrca    
0554   0207 0F                  rrca    
0555   0208 E6 03               and     %00000011
0556   020A 47                  ld      b,a
0557   020B 3E 07               ld      a,7
0558   020D 28 07               jr      z,l0226
0559   020F 3E 05               ld      a,5
0560   0211 C6 05       l0221:  add     a,5
0561   0213 27                  daa     
0562   0214 10 FB               djnz    l0221
0563   0216 77          l0226:  ld      (hl),a
0564   0217             
0565   0217             		; 
0566   0217 23                  inc     hl
0567   0218 79                  ld      a,c
0568   0219 01 01 01            ld      bc,$0101
0569   021C 11 02 01            ld      de,$0102
0570   021F E6 70               and     %01110000
0571   0221 17                  rla     
0572   0222 17                  rla     
0573   0223 17                  rla     
0574   0224 17                  rla     
0575   0225 28 0D               jr      z,l0247
0576   0227 38 05               jr      c,l0241
0577   0229 3C                  inc     a
0578   022A 4F                  ld      c,a
0579   022B 5A                  ld      e,d
0580   022C 18 06               jr      l0247
0581   022E C6 02       l0241:  add     a,2
0582   0230 47                  ld      b,a
0583   0231 57                  ld      d,a
0584   0232 87                  add     a,a
0585   0233 5F                  ld      e,a
0586   0234 72          l0247:  ld      (hl),d
0587   0235             
0588   0235 23                  inc     hl
0589   0236 73                  ld      (hl),e
0590   0237 23                  inc     hl
0591   0238 70                  ld      (hl),b
0592   0239 23                  inc     hl
0593   023A 71                  ld      (hl),c
0594   023B 23                  inc     hl
0595   023C             
0596   023C             		; Read the cabinet type
0597   023C 3A 80 7D            ld      a,(DIP_INPUT)
0598   023F 07                  rlca    
0599   0240 3E 01               ld      a,1
0600   0242 38 01               jr      c,l0259
0601   0244 3D                  dec     a
0602   0245 77          l0259:  ld      (hl),a
0603   0246             
0604   0246             		; Load the default high score table
0605   0246 21 76 35            ld      hl,L_DEFAULT_HIGH_SCORE_DATA
0606   0249 11 00 61            ld      de,HIGH_SCORE_TABLE
0607   024C 01 AA 00            ld      bc,170
0608   024F ED B0               ldir    
0609   0251 C9                  ret     
0610   0252             ;------------------------------------------------------------------------------
0611   0252             
0612   0252             
0613   0252             
0614   0252             ;------------------------------------------------------------------------------
0615   0252             ; Initialization code
0616   0252             L_INIT_GAME:  
0617   0252             		; Clear 4096 bytes of RAM ($6000 to $6FFF) to $00        
0618   0252 06 10       		ld      b,16			
0619   0254 21 00 60            ld      hl,$6000
0620   0257 AF                  xor     a
0621   0258 4F          l026c:  ld      c,a
0622   0259 77          l026d:  ld      (hl),a
0623   025A 23                  inc     hl
0624   025B 0D                  dec     c
0625   025C 20 FB               jr      nz,l026d
0626   025E 10 F8               djnz    l026c
0627   0260                     
0628   0260             		; Clear 1024 bytes of RAM ($7000 to $73ff) to $00        
0629   0260 06 04               ld      b,4
0630   0262 21 00 70            ld      hl,$7000
0631   0265 4F          l0279:  ld      c,a
0632   0266 77          l027a:  ld      (hl),a
0633   0267 23                  inc     hl
0634   0268 0D                  dec     c
0635   0269 20 FB               jr      nz,l027a
0636   026B 10 F8               djnz    l0279
0637   026D                     
0638   026D             		; Clear 1024 bytes of tile RAM ($7400 to $77ff) to $10 (blank space character)
0639   026D 06 04               ld      b,4
0640   026F 3E 10               ld      a,$10
0641   0271 21 00 74            ld      hl,TILE_COORD(0,0)
0642   0274 0E 00       l0288:  ld      c,0
0643   0276 77          l028a:  ld      (hl),a
0644   0277 23                  inc     hl
0645   0278 0D                  dec     c
0646   0279 20 FB               jr      nz,l028a
0647   027B 10 F7               djnz    l0288
0648   027D                     
0649   027D             		; Clear 64 byte circular event buffer ($60c0 to $60ff) to $ff (invalid value)    
0650   027D             		; Can hold 32 events with their parameters
0651   027D 21 C0 60            ld      hl,$60c0
0652   0280 06 40               ld      b,64
0653   0282 3E FF               ld      a,$ff
0654   0284 77          l0298:  ld      (hl),a
0655   0285 23                  inc     hl
0656   0286 10 FC               djnz    l0298
0657   0288                     
0658   0288             		; Initialize the circular event buffer write pointer to $c0 ($60c0)
0659   0288 3E C0               ld      a,$c0
0660   028A 32 B0 60            ld      (ACTION_BUFFER_WRITE_POS),a
0661   028D 32 B1 60            ld      (ACTION_BUFFER_READ_POS),a
0662   0290                     
0663   0290             		; Initialize the display palette to 00
0664   0290 AF                  xor     a
0665   0291 32 83 7D            ld      ($7d83),a   ; ($7d83) = 0
0666   0294 32 86 7D            ld      (PALETTE_1_OUTPUT),a 
0667   0297 32 87 7D            ld      (PALETTE_2_OUTPUT),a
0668   029A             
0669   029A             		; Initialize the screen orientation
0670   029A 3C                  inc     a
0671   029B 32 82 7D            ld      (SCREEN_ORIENTATION),a   ; (SCREEN_ORIENTATION) = 1
0672   029E             
0673   029E             		; Initialize the stack
0674   029E 31 00 6C            ld      sp,$6c00    ; Stack starts at $6c00
0675   02A1             
0676   02A1             		; Turn off sounds
0677   02A1 CD 0F 01            call    L_SOUNDS_OFF       ; Turn off sounds and music
0678   02A4             
0679   02A4             		; Reenable interrupts
0680   02A4 3E 01               ld      a,1       
0681   02A6 32 84 7D            ld      (INTERRUPT_ENABLE),a    ; Reenable interrupts
0682   02A9             ; End of initialization
0683   02A9             ;------------------------------------------------------------------------------
0684   02A9                     
0685   02A9             
0686   02A9             
0687   02A9             ;------------------------------------------------------------------------------
0688   02A9             ; Main program loop
0689   02A9             ; Checks if there are events waiting in the event buffer and processes them
0690   02A9             ; until the buffer is empty.
0691   02A9             L_MAIN_LOOP:  
0692   02A9             		; Check for actions in the action buffer
0693   02A9 26 60       		ld      h,$60
0694   02AB 3A B1 60            ld      a,(ACTION_BUFFER_READ_POS)   ; A = (readPtr)
0695   02AE 6F                  ld      l,a
0696   02AF 7E                  ld      a,(hl)
0697   02B0             		
0698   02B0             		; Double a to turn it into a 2-byte offset
0699   02B0 87                  add     a,a
0700   02B1 30 1C               jr      nc,L_PROCESS_ACTION_BUFFER    ; If A is a valid buffer byte, jump ahead (skipping 'nUp' display and timer incrementing)
0701   02B3                     
0702   02B3 CD 01 03    		call    L_DISPLAY_NUP ; Flash the current player's 'nUp' line
0703   02B6 CD 3C 03            call    L_AWARD_BONUS_LIFE ; Pre-turn stuff: Award bonus life, display lives and level number
0704   02B9 21 19 60            ld      hl,COUNTER_1
0705   02BC 34                  inc     (hl)        ; ++counter2
0706   02BD 21 83 63            ld      hl,$6383
0707   02C0 3A 1A 60            ld      a,(COUNTER_2)
0708   02C3 BE                  cp      (hl)
0709   02C4 28 E3               jr      z,L_MAIN_LOOP
0710   02C6 77                  ld      (hl),a
0711   02C7 CD 6B 03            call    L_INCREASE_DIFFICULTY
0712   02CA CD 8E 03            call    L_IMPLEMENT_BARREL_FIRE
0713   02CD 18 DA               jr      L_MAIN_LOOP
0714   02CF             ;------------------------------------------------------------------------------
0715   02CF             
0716   02CF             
0717   02CF             
0718   02CF             ;------------------------------------------------------------------------------
0719   02CF             ; Process actions from the action buffer
0720   02CF             ;
0721   02CF             ; passed:	a - the offset of the action function to jump to in 
0722   02CF             ;				the table below
0723   02CF             ;			hl - pointer to the location of the action buffer read
0724   02CF             ;				position
0725   02CF             L_PROCESS_ACTION_BUFFER:  
0726   02CF             		; Parse the action jump table index
0727   02CF E6 1F       		and     %00011111
0728   02D1 5F                  ld      e,a
0729   02D2 16 00               ld      d,$00
0730   02D4 36 FF               ld      (hl),$ff					; Clear this action
0731   02D6             
0732   02D6             		; Read the action parameter
0733   02D6 2C                  inc     l
0734   02D7 4E                  ld      c,(hl)
0735   02D8 36 FF               ld      (hl),$ff					; Clear this parameter
0736   02DA             
0737   02DA             		; Advance the action buffer read pointer (wrapping around if needed)
0738   02DA 2C                  inc     l
0739   02DB 7D                  ld      a,l
0740   02DC FE C0               cp      $c0
0741   02DE 30 02               jr      nc,l02f6
0742   02E0 3E C0               ld      a,$c0
0743   02E2 32 B1 60    l02f6:  ld      (ACTION_BUFFER_READ_POS),a
0744   02E5             
0745   02E5 79                  ld      a,c							; a = action parameter
0746   02E6             
0747   02E6             		; Make sure execution returns to the main loop after the action is processed
0748   02E6 21 A9 02            ld      hl,L_MAIN_LOOP
0749   02E9 E5                  push    hl
0750   02EA             
0751   02EA             		; Jump to the correct offset in the jump table below
0752   02EA 21 F3 02            ld      hl,l0307
0753   02ED 19                  add     hl,de
0754   02EE 5E                  ld      e,(hl)
0755   02EF 23                  inc     hl
0756   02F0 56                  ld      d,(hl)
0757   02F1 EB                  ex      de,hl
0758   02F2 E9                  jp      (hl)
0759   02F3             
0760   02F3                     ; Jump table
0761   02F3 06 05       l0307   .word   L_AWARD_POINTS ; 0 = Award points
0762   02F5 87 05               .word   L_ZERO_SCORES ; 1 = Clear scores
0763   02F7 AE 05               .word   L_DISPLAY_SCORES ; 2 = Display all scores
0764   02F9 CD 05               .word   L_DISPLAY_STRING ; 3 = Display string
0765   02FB F5 05               .word   L_DISPLAY_CREDITS ; 4 = Display the number of credits
0766   02FD 0E 06               .word   L_PROCESS_TIMER ; 5 = Display timer
0767   02FF 96 06               .word   L_DISPLAY_LIVES_AND_LEVEL ; 6 = Display lives and level
0768   0301             ;------------------------------------------------------------------------------
0769   0301             
0770   0301             
0771   0301             
0772   0301             ;------------------------------------------------------------------------------
0773   0301             ; Display "1UP" and "2UP" (if two players are playing)
0774   0301             ; The string for the current player is flashed
0775   0301             L_DISPLAY_NUP:  
0776   0301             		; Only proceed once every 16 counter cycles
0777   0301 3A 1A 60    		ld      a,(COUNTER_2)
0778   0304 47                  ld      b,a
0779   0305 E6 0F               and     $0f
0780   0307 C0                  ret     nz
0781   0308             
0782   0308             		; Abort if in attract mode
0783   0308 CF                  rst     $08
0784   0309             
0785   0309             		; Get the coordinate for this player's "nUP" string
0786   0309 3A 0D 60            ld      a,(CURRENT_PLAYER)
0787   030C CD 33 03            call    L_RETURN_NUP_COORD
0788   030F             
0789   030F             		; Display the "nUP" line every other time
0790   030F             		; (on for 16 cycles, off for 16 cycles)
0791   030F 11 E0 FF            ld      de,-32
0792   0312 CB 60               bit     4,b
0793   0314 28 14               jr      z,l033e					; Display "1UP" or "2UP"
0794   0316             
0795   0316             		; Clear the "nUP" string
0796   0316 3E 10               ld      a,$10
0797   0318 77                  ld      (hl),a
0798   0319 19                  add     hl,de
0799   031A 77                  ld      (hl),a
0800   031B 19                  add     hl,de
0801   031C 77                  ld      (hl),a
0802   031D             
0803   031D             		; If two players, display the other "nUP" line without blinking
0804   031D 3A 0F 60            ld      a,(TWO_PLAYERS)
0805   0320 A7                  and     a
0806   0321 C8                  ret     z
0807   0322 3A 0D 60            ld      a,(CURRENT_PLAYER)
0808   0325 EE 01               xor     $01							; a = inactive player
0809   0327 CD 33 03            call    L_RETURN_NUP_COORD			; Get coordinate of inactive player's "nUP" line
0810   032A             
0811   032A             		; Display "1UP" or "2UP'
0812   032A 3C          l033e:  inc     a							; Convert player ID (0 or 1) to player number (1 or 2)
0813   032B 77                  ld      (hl),a
0814   032C 19                  add     hl,de						; Move 1 column right
0815   032D 36 25               ld      (hl),$25					; 'U'
0816   032F 19                  add     hl,de						; Move 1 column right
0817   0330 36 20               ld      (hl),$20					;'P'
0818   0332 C9                  ret     
0819   0333             ;------------------------------------------------------------------------------
0820   0333             
0821   0333             
0822   0333             
0823   0333             ;------------------------------------------------------------------------------
0824   0333             ; Return the coordinate of either "1UP" (a = 0) or "2UP" (a = 1)
0825   0333             ;
0826   0333             ; passed:	a - 0 (player 1) or 1 (player 2)
0827   0333             L_RETURN_NUP_COORD:  
0828   0333 21 40 77    		ld      hl,TILE_COORD(26,0)
0829   0336 A7                  and     a
0830   0337 C8                  ret     z
0831   0338 21 E0 74            ld      hl,TILE_COORD(7,0)
0832   033B C9                  ret     
0833   033C             ;------------------------------------------------------------------------------
0834   033C             
0835   033C             
0836   033C             
0837   033C             ;------------------------------------------------------------------------------
0838   033C             ; Handle awarding bonus life
0839   033C             L_AWARD_BONUS_LIFE:  
0840   033C             		; Return if the player has already received a bonus life
0841   033C 3A 2D 62    		ld      a,(CP_BONUS_LIFE_AWARDED)
0842   033F A7                  and     a
0843   0340 C0                  ret     nz
0844   0341             
0845   0341             		; Get the 2nd and 3rd digits of the player's score
0846   0341 21 B3 60            ld      hl,PREV_P1_SCORE+1
0847   0344 3A 0D 60            ld      a,(CURRENT_PLAYER)
0848   0347 A7                  and     a
0849   0348 28 03               jr      z,l0361
0850   034A 21 B6 60            ld      hl,PREV_P2_SCORE+1
0851   034D 7E          l0361:  ld      a,(hl)
0852   034E E6 F0               and     $f0
0853   0350 47                  ld      b,a							; b = 3rd digit of current player's score
0854   0351 23                  inc     hl
0855   0352 7E                  ld      a,(hl)
0856   0353 E6 0F               and     $0f							; a = 2nd digit of current player's score
0857   0355 B0                  or      b
0858   0356 0F                  rrca    
0859   0357 0F                  rrca    
0860   0358 0F                  rrca    
0861   0359 0F                  rrca    							; a = 2nd and 3rd digits of current player's score
0862   035A             
0863   035A             		; Return if the player has not earned an extra life
0864   035A 21 21 60            ld      hl,DIP_BONUS_LIFE
0865   035D BE                  cp      (hl)
0866   035E D8                  ret     c
0867   035F             
0868   035F             		; Award a bonus life
0869   035F 3E 01               ld      a,1
0870   0361 32 2D 62            ld      (CP_BONUS_LIFE_AWARDED),a
0871   0364 21 28 62            ld      hl,CP_NUMBER_LIVES
0872   0367 34                  inc     (hl)
0873   0368 C3 96 06            jp      L_DISPLAY_LIVES_AND_LEVEL
0874   036B             ;------------------------------------------------------------------------------
0875   036B             
0876   036B             
0877   036B             
0878   036B             ;------------------------------------------------------------------------------
0879   036B             ; Increment the minor and major counters
0880   036B             ; The difficulty starts out equal to the level number and increases by 1 every 2048 
0881   036B             ; counter cycles to a maximum of 5.
0882   036B             L_INCREASE_DIFFICULTY:  
0883   036B             		; Increment the minor counter
0884   036B 21 84 63    		ld      hl,MINOR_COUNTER
0885   036E 7E                  ld      a,(hl)
0886   036F 34                  inc     (hl)
0887   0370             
0888   0370             		; Return if the minor counter has not rolled over
0889   0370 A7                  and     a
0890   0371 C0                  ret     nz
0891   0372             
0892   0372             		; Increment the major counter
0893   0372 21 81 63            ld      hl,MAJOR_COUNTER
0894   0375 7E                  ld      a,(hl)
0895   0376 47                  ld      b,a
0896   0377 34                  inc     (hl)
0897   0378             
0898   0378             		; Return if the 3 LSBs have not rolled over
0899   0378 E6 07               and     %00000111
0900   037A C0                  ret     nz
0901   037B             
0902   037B             		; Isolate the 5 MSBs
0903   037B 78                  ld      a,b
0904   037C 0F                  rrca    
0905   037D 0F                  rrca    
0906   037E 0F                  rrca    
0907   037F 47                  ld      b,a
0908   0380             
0909   0380             		; Increase the difficulty level to a maximum or 5
0910   0380 3A 29 62            ld      a,(CP_LEVEL_NUMBER)
0911   0383 80                  add     a,b
0912   0384 FE 05               cp      5
0913   0386 38 02               jr      c,l039e
0914   0388 3E 05               ld      a,5
0915   038A 32 80 63    l039e:  ld      (CP_DIFFICULTY),a
0916   038D C9                  ret     
0917   038E             ;------------------------------------------------------------------------------
0918   038E             
0919   038E             
0920   038E             
0921   038E             ;------------------------------------------------------------------------------
0922   038E             ; Handle the barrel fire animation on the barrels and mixer levels.  This 
0923   038E             ; includes displaying the initial flare up when an oil barrel is thrown and
0924   038E             ; the normal burning afterwards.
0925   038E             L_IMPLEMENT_BARREL_FIRE:  
0926   038E 3E 03       		ld      a,%0011
0927   0390 F7                  rst     $30							; Return unless this is the barrels stage or mixer stage
0928   0391                     ; Return if Mario is dead
0929   0391 D7                  rst     $10
0930   0392             
0931   0392             		; Return if the smash animation is playing
0932   0392 3A 50 63            ld      a,(SMASH_ANIMATION_ACTIVE)
0933   0395 0F                  rrca    
0934   0396 D8                  ret     c
0935   0397             
0936   0397             		; Return if it is not time to update the barrel fire
0937   0397 21 B8 62            ld      hl,BARREL_FIRE_FREEZE
0938   039A 35                  dec     (hl)
0939   039B C0                  ret     nz
0940   039C             
0941   039C             		; Reset the barrel fire delay to 4
0942   039C 36 04               ld      (hl),4
0943   039E             
0944   039E             		; Return if the oil barrel is not burning
0945   039E 3A B9 62            ld      a,(BARREL_FIRE_STATE)
0946   03A1 0F                  rrca    
0947   03A2 D0                  ret     nc
0948   03A3             
0949   03A3             		; Prepare the sprite
0950   03A3 21 29 6A            ld      hl,BARREL_FIRE_SPRITE_NUM
0951   03A6 06 40               ld      b,$40						; Basic fire sprite
0952   03A8 DD 21 A0 66         ld      ix,BARREL_FIRE_STRUCT
0953   03AC             		
0954   03AC             		; If the barrel fire is not in its initial flare up, jump ahead
0955   03AC 0F                  rrca    
0956   03AD 30 20               jr      nc,l03e4
0957   03AF             		
0958   03AF             		; Display the flared up barrel fire sprite
0959   03AF DD 36 09 02         ld      (ix+9),2
0960   03B3 DD 36 0A 02         ld      (ix+10),2
0961   03B7 04                  inc     b
0962   03B8 04                  inc     b							; b = $42, the first flared up sprite
0963   03B9 CD DC 03            call    L_TOGGLE_FIRE_SPRITES
0964   03BC             		
0965   03BC             		; Return if the flare up time has not run out
0966   03BC 21 BA 62            ld      hl,BARREL_FIRE_FLARE_UP_TIME
0967   03BF 35                  dec     (hl)
0968   03C0 C0                  ret     nz
0969   03C1             
0970   03C1             		; The barrel fire is now burning normally
0971   03C1 3E 01               ld      a,1
0972   03C3 32 B9 62            ld      (BARREL_FIRE_STATE),a
0973   03C6 32 A0 63            ld      (RELEASE_A_FIREBALL),a
0974   03C9 3E 10       l03de:  ld      a,16
0975   03CB 32 BA 62            ld      (BARREL_FIRE_FLARE_UP_TIME),a
0976   03CE C9                  ret     
0977   03CF             
0978   03CF             		; Display the normal barrel fire sprite
0979   03CF DD 36 09 02 l03e4:  ld      (ix+9),2
0980   03D3 DD 36 0A 00         ld      (ix+10),0
0981   03D7 CD DC 03            call    L_TOGGLE_FIRE_SPRITES
0982   03DA 18 ED               jr      l03de
0983   03DC             ;------------------------------------------------------------------------------
0984   03DC             		
0985   03DC             
0986   03DC             		
0987   03DC             ;------------------------------------------------------------------------------
0988   03DC             ; Alternate between the sprite number in b and the next sprite up
0989   03DC             ; passed:	b - the first sprite number 
0990   03DC             ;			hl - the sprite number memory address
0991   03DC             ; return:	(hl) - the resulting sprite number
0992   03DC             L_TOGGLE_FIRE_SPRITES:  
0993   03DC 70          		ld      (hl),b
0994   03DD 3A 19 60            ld      a,(COUNTER_1)
0995   03E0 0F                  rrca    
0996   03E1 D8                  ret     c
0997   03E2 04                  inc     b
0998   03E3 70                  ld      (hl),b
0999   03E4 C9                  ret     
1000   03E5             ;------------------------------------------------------------------------------
1001   03E5             
1002   03E5             
1003   03E5             
1004   03E5             ;------------------------------------------------------------------------------
1005   03E5             ; Animate Donkey Kong (stomping, grabbing barrels, etc) and Pauline (yelling 
1006   03E5             ; HELP! and being frantic)
1007   03E5             L_ANIMATE_DK_AND_PAULINE:  
1008   03E5             		; If this is not the mixer stage, skip ahead
1009   03E5 3A 27 62    		ld      a,(CURRENT_STAGE)
1010   03E8 FE 02               cp      2
1011   03EA 20 10               jr      nz,l0413
1012   03EC             
1013   03EC             		; Move Donkey Kong along the top conveyer
1014   03EC 21 08 69            ld      hl,DK_SPRITE_1_X
1015   03EF 3A A3 63            ld      a,(TOP_CONVEYER_DIR)
1016   03F2 4F                  ld      c,a
1017   03F3 FF                  rst     $38						; Move Donkey Kong horizontally
1018   03F4             
1019   03F4             		; Calculate and save Donkey Kong's distance from the ladder
1020   03F4 3A 10 69            ld      a,(DK_SPRITE_3_X)
1021   03F7 D6 3B               sub     59
1022   03F9 32 B7 63            ld      (DK_DISTANCE_TO_LADDER),a
1023   03FC             
1024   03FC             		
1025   03FC             l0413:  
1026   03FC             		; If this is the secret stage, jump ahead to skip animating
1027   03FC             		; Donkey Kong
1028   03FC FE 05       		cp		5
1029   03FE CA F2 04    		jp		z,l_animate_dk_and_pauline_1
1030   0401             		
1031   0401             		; If Donkey Kong is in an action, jump ahead to perform it
1032   0401 3A 91 63    		ld      a,(TIME_FOR_DK_ACTION)
1033   0404 A7                  and     a
1034   0405 20 0B               jr      nz,l0426
1035   0407             
1036   0407             		; If counter 2 has not yet run down, then jump ahead to skip Donkey Kong
1037   0407             		; animation and animate Pauline
1038   0407 3A 1A 60            ld      a,(COUNTER_2)
1039   040A A7                  and     a
1040   040B 20 5C               jr      nz,l0486
1041   040D             
1042   040D             		; If counter 2 has run down, it is time for Donkey Kong to act 
1043   040D 3E 01               ld      a,1
1044   040F 32 91 63            ld      (TIME_FOR_DK_ACTION),a
1045   0412             
1046   0412             		; If ++ANIMATION_TIMER == 128, jump ahead
1047   0412 21 90 63    l0426:  ld      hl,ANIMATION_TIMER
1048   0415 34                  inc     (hl)
1049   0416 7E                  ld      a,(hl)
1050   0417 FE 80               cp      128
1051   0419 28 2F               jr      z,l0464
1052   041B             
1053   041B             		; If Donkey Kong is not stomping, then jump ahead to animate Pauline
1054   041B 3A 93 63            ld      a,(DK_STOMPING)
1055   041E A7                  and     a
1056   041F 20 48               jr      nz,l0486
1057   0421             
1058   0421             		; If it is not time to update Donkey Kong's stomp animation,
1059   0421             		; skip ahead to animate Pauline
1060   0421 7E                  ld      a,(hl)
1061   0422 47                  ld      b,a
1062   0423 E6 1F               and     %00011111
1063   0425 20 42               jr      nz,l0486
1064   0427             
1065   0427             		; Toggle between Donkey Kong stomping sprites
1066   0427 21 E0 39            ld      hl,L_DK_SPRITES_GRIN_L_STOMP
1067   042A CB 68               bit     5,b
1068   042C 20 03               jr      nz,l0448
1069   042E 21 08 3A            ld      hl,L_DK_SPRITES_GRIN_R_STOMP
1070   0431 CD 4E 00    l0448:  call    L_LOAD_DK_SPRITES
1071   0434             
1072   0434             		; Trigger stomp sound
1073   0434 3E 03               ld      a,3
1074   0436 32 82 60            ld      (STOMP_SOUND_TRIGGER),a
1075   0439             
1076   0439             		; Jump ahead if the current stage is mixer or rivets
1077   0439 3A 27 62    l0450:  ld      a,(CURRENT_STAGE)
1078   043C 0F                  rrca    
1079   043D 30 1D               jr      nc,l0478
1080   043F             
1081   043F             		; Jump ahead if this is the elevators stage
1082   043F 0F                  rrca    
1083   0440 38 27               jr      c,l0486
1084   0442             
1085   0442             		; If this is the barrels stage, move Donkey Kong 4 pixels left
1086   0442 21 0B 69            ld      hl,DK_SPRITE_1_Y
1087   0445 0E FC               ld      c,-4
1088   0447 FF                  rst     $38
1089   0448 18 1F               jr      l0486
1090   044A             
1091   044A             		; Set ANIMATION_TIMER and TIME_FOR_DK_ACTION to 0
1092   044A AF          l0464:  xor     a
1093   044B 77                  ld      (hl),a
1094   044C 23                  inc     hl
1095   044D 77                  ld      (hl),a
1096   044E             
1097   044E             		; If Donkey Kong is not stomping, then skip ahead to animate Pauline
1098   044E 3A 93 63            ld      a,(DK_STOMPING)
1099   0451 A7                  and     a
1100   0452 20 15               jr      nz,l0486
1101   0454             
1102   0454 21 6D 38            ld      hl,L_DK_SPRITES_L_ARM_RAISED
1103   0457 CD 4E 00            call    L_LOAD_DK_SPRITES
1104   045A 18 DD               jr      l0450
1105   045C             
1106   045C             		; Move Donkey Kong to the ladder?
1107   045C 21 08 69    l0478:  ld      hl,DK_SPRITE_1_X
1108   045F 0E 44               ld      c,68
1109   0461             
1110   0461             		; If the current stage is mixer, jump ahead
1111   0461 0F                  rrca    
1112   0462 30 04               jr      nc,l0485
1113   0464             
1114   0464 3A B7 63            ld      a,(DK_DISTANCE_TO_LADDER)
1115   0467 4F                  ld      c,a
1116   0468 FF          l0485:  rst     $38
1117   0469             
1118   0469             ; Animate Pauline on the barrels, mixer, and elevators level
1119   0469             ; The HELP! tiles are periodically displayed and erased
1120   0469             ; and Pauline is animated as frantic
1121   0469             		; Prepare the location of the Help! tiles
1122   0469 21 C4 75    l0486:	ld      hl,TILE_COORD(14,4)
1123   046C 06 EF       		ld		b,$ef
1124   046E             
1125   046E 3A 90 63    l0493:  ld      a,(ANIMATION_TIMER)
1126   0471 4F                  ld      c,a
1127   0472             
1128   0472             		; If the current stage is rivets
1129   0472 3A 27 62            ld      a,(CURRENT_STAGE)
1130   0475 FE 04               cp      4
1131   0477 28 26               jr      z,l04be
1132   0479             
1133   0479             l0496:
1134   0479             		; If ANIMATION_TIMER is zero, then clear the HElP! tiles next to Pauline
1135   0479 79                  ld      a,c
1136   047A A7                  and     a
1137   047B 28 05               jr      z,l04a1
1138   047D             
1139   047D             		; If bit 6 of ANIMATION_TIMER is set, display the HELP! tiles
1140   047D 78                  ld      a,b
1141   047E CB 71               bit     6,c
1142   0480 20 02               jr      nz,l04a3
1143   0482             
1144   0482 3E 10       l04a1:  ld      a,$10						; Blank tile
1145   0484             		; Display or clear the HElP! tiles next to Pauline
1146   0484 11 20 00    l04a3:  ld      de,32						; Used to move tile address one column left
1147   0487 CD FE 04    		call    L_DISPLAY_OR_CLEAR_HELP		; Display or clear HELP!
1148   048A             
1149   048A 3A 05 69            ld      a,(PAULINE_LOWER_SPRITE_NUM)
1150   048D             		; Record Paulines lower sprite number
1151   048D 32 05 69    l04ac:  ld      (PAULINE_LOWER_SPRITE_NUM),a
1152   0490             		; All done if bit 6 of ANIMATION_TIMER is not set
1153   0490 CB 71               bit     6,c
1154   0492 C8                  ret     z
1155   0493             
1156   0493             		; Return if lower three bits of ANIMATION_TIMER are not 0
1157   0493 47                  ld      b,a						; b = pauline lower sprite number
1158   0494 79                  ld      a,c						; a = ANIMATION_TIMER
1159   0495 E6 07               and     %00000111
1160   0497 C0                  ret     nz
1161   0498             
1162   0498             		; Animate Pauline frantic by swapping her lower sprite number 
1163   0498             		; between $11 and $12
1164   0498 78                  ld      a,b
1165   0499 EE 03               xor     %00000011
1166   049B 32 05 69            ld      (PAULINE_LOWER_SPRITE_NUM),a
1167   049E C9                  ret     
1168   049F             
1169   049F             ; Animate Pauline on the rivets stage
1170   049F             		; Clear the HELP! tiles from both sides of Pauline
1171   049F 11 20 00    l04be:  ld      de,32						; Used to move tile address one column left
1172   04A2 3E 10       		ld      a,$10
1173   04A4 21 23 76            ld      hl,TILE_COORD(17,3)
1174   04A7 CD FE 04            call    L_DISPLAY_OR_CLEAR_HELP						; Display or clear HELP!
1175   04AA 21 83 75            ld      hl,TILE_COORD(12,3)
1176   04AD CD FE 04            call    L_DISPLAY_OR_CLEAR_HELP						; Display or clear HELP!
1177   04B0             
1178   04B0             		; If bit 6 of ANIMATION_TIMER is 0, jump ahead
1179   04B0 CB 71               bit     6,c
1180   04B2 28 35               jr      z,l0509
1181   04B4             
1182   04B4             		; If Mario is right of center, jump ahead
1183   04B4 3A 03 62            ld      a,(MARIO_X)
1184   04B7 FE 80               cp      128
1185   04B9 30 17               jr      nc,l04f1
1186   04BB             
1187   04BB             		; Mario is left of center, so face Pauline left and display the HELP! tiles to Pauline's left
1188   04BB 3E DF               ld      a,$df						; Last of the three HELP! tiles
1189   04BD 21 23 76            ld      hl,TILE_COORD(17,3)
1190   04C0 CD FE 04            call    L_DISPLAY_OR_CLEAR_HELP						; Display HELP!
1191   04C3 3A 01 69    l04e1:  ld      a,(PAULINE_UPPER_SPRITE_NUM)	; Face pauline left
1192   04C6 F6 80               or      %10000000
1193   04C8 32 01 69            ld      (PAULINE_UPPER_SPRITE_NUM),a
1194   04CB 3A 05 69            ld      a,(PAULINE_LOWER_SPRITE_NUM)
1195   04CE F6 80               or      %10000000
1196   04D0 18 BB               jr      l04ac						; Animate Pauline
1197   04D2             
1198   04D2             		; Mario is right of center, so face Pauline right and display the HELP! tiles to Pauline's right
1199   04D2 3E EF       l04f1:  ld      a,$ef						; Last of the three HELP! tiles
1200   04D4 21 83 75            ld      hl,TILE_COORD(12,3)
1201   04D7 CD FE 04            call    L_DISPLAY_OR_CLEAR_HELP						; Display HELP!
1202   04DA 3A 01 69    l04f9:  ld      a,(PAULINE_UPPER_SPRITE_NUM)
1203   04DD E6 7F               and     %01111111
1204   04DF 32 01 69            ld      (PAULINE_UPPER_SPRITE_NUM),a
1205   04E2 3A 05 69            ld      a,(PAULINE_LOWER_SPRITE_NUM)
1206   04E5 E6 7F               and     %01111111
1207   04E7 18 A4               jr      l04ac						; Animate Pauline
1208   04E9             
1209   04E9             		; If Mario is right of center, face Pauline right
1210   04E9 3A 03 62    l0509:  ld      a,(MARIO_X)
1211   04EC FE 80               cp      128
1212   04EE 30 EA               jr      nc,l04f9
1213   04F0             
1214   04F0             		; If Mario is left of center, face Pauline left
1215   04F0 18 D1               jr      l04e1
1216   04F2             		
1217   04F2             		
1218   04F2             		
1219   04F2             l_animate_dk_and_pauline_1:
1220   04F2             		; Increment the animation timer
1221   04F2 21 90 63    		ld      hl,ANIMATION_TIMER
1222   04F5 34                  inc     (hl)
1223   04F6             		
1224   04F6             		; Clear or display the Help! tiles next to Pauline
1225   04F6 21 9C 74    		ld      hl,TILE_COORD(4,28)
1226   04F9 06 DF       		ld		b,$df
1227   04FB C3 6E 04    		jp		l0493
1228   04FE             ;------------------------------------------------------------------------------
1229   04FE             
1230   04FE             
1231   04FE             
1232   04FE             ;------------------------------------------------------------------------------
1233   04FE             ; Display or clear the HELP! tiles to Pauline's left or right
1234   04FE             ; passed:	a - the last tile of a 3 tile set 
1235   04FE             ;				($10 to clear the tiles, or $df or $ef to display HELP!)
1236   04FE             ;			hl - the right-most screen coordinate for the set of 3 tiles
1237   04FE             ;			de - 32 to move left 1 column before displaying the next tile
1238   04FE             L_DISPLAY_OR_CLEAR_HELP:  
1239   04FE 06 03       		ld      b,3							; b = 3 to 1
1240   0500 77          l0516:  ld      (hl),a						; Display the current tile
1241   0501 19                  add     hl,de						; Move left one column
1242   0502 3D                  dec     a							; Decrement the tile
1243   0503 10 FB               djnz    l0516						; Next b
1244   0505 C9                  ret     
1245   0506             ;------------------------------------------------------------------------------
1246   0506             
1247   0506             
1248   0506             
1249   0506             ;------------------------------------------------------------------------------
1250   0506             ; Award points to the player
1251   0506             ; passed:  a - the points award table entry number of the points to award
1252   0506             L_AWARD_POINTS:  
1253   0506 4F          		ld      c,a
1254   0507 CF                  rst     $08							; Return if in attract mode
1255   0508             
1256   0508             		; Get pointer to the current playe's score in de
1257   0508 CD 4B 05            call    L_GET_PLAYER_SCORE
1258   050B             
1259   050B             		; Convert the point table entry number to a table offset
1260   050B             ;        ld      a,c
1261   050B             ;        add     a,c
1262   050B             ;        add     a,c
1263   050B             ;        ld      c,a
1264   050B             
1265   050B             		; Get pointer to the table entry
1266   050B 21 62 35            ld      hl,L_POINT_AWARD_TABLE
1267   050E 06 00               ld      b,$00
1268   0510 09                  add     hl,bc
1269   0511             
1270   0511             		; Add the points to the player's score
1271   0511 A7                  and     a
1272   0512 06 03               ld      b,3							; For b = 3 to 1
1273   0514 1A          l052e:  ld      a,(de)
1274   0515 8E                  adc     a,(hl)
1275   0516 27                  daa     
1276   0517 12                  ld      (de),a
1277   0518 13                  inc     de
1278   0519 23                  inc     hl
1279   051A 10 F8               djnz    l052e						; Next b
1280   051C A7          		and		a							; Clear flags
1281   051D 13          		inc		de							; Point to second byte of player's score
1282   051E 1A          		ld		a,(de)
1283   051F 8E          		adc		a,(hl)
1284   0520 27          		daa
1285   0521 12          		ld		(de),a
1286   0522 13          		inc		de
1287   0523 13          		inc		de
1288   0524             
1289   0524             		; Display the current player's score
1290   0524 D5                  push    de
1291   0525 1B                  dec     de
1292   0526 3A 0D 60            ld      a,(CURRENT_PLAYER)
1293   0529 CD 57 05            call    L_DISPLAY_PLAYER_SCORE
1294   052C             
1295   052C             		; Check if the player's score is higher than the high score
1296   052C D1                  pop     de
1297   052D 1B                  dec     de
1298   052E 21 BA 60            ld      hl,PREV_HIGH_SCORE+2
1299   0531 06 03               ld      b,3							; For b = 3 to 1
1300   0533 1A          l0545:  ld      a,(de)
1301   0534 BE                  cp      (hl)
1302   0535 D8                  ret     c
1303   0536             		; If the score is higher, jump ahead
1304   0536 20 05               jr      nz,l0550
1305   0538 1B                  dec     de
1306   0539 2B                  dec     hl
1307   053A 10 F7               djnz    l0545						; Next b
1308   053C C9                  ret
1309   053D             
1310   053D             		; Replace the high score with player's score
1311   053D CD 4B 05    l0550:  call    L_GET_PLAYER_SCORE
1312   0540 21 B8 60            ld      hl,PREV_HIGH_SCORE
1313   0543 1A          l0556:  ld      a,(de)
1314   0544 77                  ld      (hl),a
1315   0545 13                  inc     de
1316   0546 23                  inc     hl
1317   0547 10 FA               djnz    l0556						; Next b
1318   0549 18 74               jr      l05da						; Display the high score
1319   054B             ;------------------------------------------------------------------------------
1320   054B             
1321   054B             
1322   054B             
1323   054B             ;------------------------------------------------------------------------------
1324   054B             ; Return the current player's stored score
1325   054B             ; Return:  de - PREV_P1_SCORE or PREV_P2_SCORE
1326   054B             ;          a - CURRENT_PLAYER
1327   054B             L_GET_PLAYER_SCORE:  
1328   054B 11 B2 60    		ld      de,PREV_P1_SCORE
1329   054E 3A 0D 60            ld      a,(CURRENT_PLAYER)
1330   0551 A7                  and     a
1331   0552 C8                  ret     z
1332   0553 11 B5 60            ld      de,PREV_P2_SCORE
1333   0556 C9                  ret     
1334   0557             ;------------------------------------------------------------------------------
1335   0557             
1336   0557             
1337   0557             
1338   0557             ;------------------------------------------------------------------------------
1339   0557             ; Display the player's score (0 for player 1, or 1 for player 2)
1340   0557             ; pssed:  a - the player number (0 = player 1, 1 = player 2)
1341   0557             ;         de - pointer to player's score:  
1342   0557             L_DISPLAY_PLAYER_SCORE:
1343   0557             		; Determine the screen coordinate to display the score at
1344   0557 DD 21 81 77 		ld      ix,TILE_COORD(28,1)
1345   055B A7                  and     a
1346   055C 28 0A               jr      z,L_DISPLAY_HIGH_SCORE_2
1347   055E DD 21 21 75         ld      ix,TILE_COORD(9,1)
1348   0562 18 04               jr      L_DISPLAY_HIGH_SCORE_2
1349   0564             
1350   0564             		; Get the screen coordinate to display the high score at
1351   0564             L_DISPLAY_HIGH_SCORE:  
1352   0564 DD 21 41 76 		ld      ix,TILE_COORD(18,1)
1353   0568             
1354   0568 EB          L_DISPLAY_HIGH_SCORE_2:  ex      de,hl
1355   0569 11 E0 FF            ld      de,-32
1356   056C 01 04 03            ld      bc,$0304					; For b = 3 to 1
1357   056F             
1358   056F             		; Display each digit of the score
1359   056F 7E          l0583:  ld      a,(hl)
1360   0570 0F                  rrca    
1361   0571 0F                  rrca    
1362   0572 0F                  rrca    
1363   0573 0F                  rrca    
1364   0574 CD 7F 05            call    L_DISPLAY_SCORE_DIGIT
1365   0577 7E                  ld      a,(hl)
1366   0578 CD 7F 05            call    L_DISPLAY_SCORE_DIGIT
1367   057B 2B                  dec     hl
1368   057C 10 F1               djnz    l0583					; Next b
1369   057E C9                  ret     
1370   057F             ;------------------------------------------------------------------------------
1371   057F             
1372   057F             
1373   057F             
1374   057F             ;------------------------------------------------------------------------------
1375   057F             ; Display one digit of the score and move 1 column to the right
1376   057F             ; passed:  a - digit to display in BCD.  Only the least-significant nibble is looked at.
1377   057F             ;          de - -32
1378   057F             ;          ix - the screen coordinate to display at
1379   057F             L_DISPLAY_SCORE_DIGIT:  
1380   057F E6 0F       		and     %00001111
1381   0581 DD 77 00            ld      (ix+0),a
1382   0584 DD 19               add     ix,de
1383   0586 C9                  ret     
1384   0587             ;------------------------------------------------------------------------------
1385   0587             
1386   0587             
1387   0587             
1388   0587             ;------------------------------------------------------------------------------
1389   0587             ; Zero-out scores
1390   0587             ; passed: A - score ID
1391   0587             ;             (0 = player 1, 
1392   0587             ;              1 = player 2,
1393   0587             ;              2 = high score,
1394   0587             ;              3 = all scores)
1395   0587             L_ZERO_SCORES:
1396   0587             		; If a is 3, jump ahead to zero all scores
1397   0587 FE 03       		cp      3
1398   0589 30 1A       		jr      nc,l05bd
1399   058B             
1400   058B             		; Get the address of the requested score
1401   058B F5          		push    af
1402   058C 21 B2 60    		ld      hl,PREV_P1_SCORE
1403   058F A7          		and     a
1404   0590 28 03       		jr      z,l05ab
1405   0592 21 B5 60    		ld      hl,PREV_P2_SCORE
1406   0595 FE 02       l05ab:  cp      2
1407   0597 20 03       		jr      nz,l05b3
1408   0599 21 B8 60    		ld      hl,PREV_HIGH_SCORE
1409   059C             
1410   059C             		; Zero the selected score
1411   059C AF          l05b3:  xor     a
1412   059D 77          		ld      (hl),a
1413   059E 23          		inc     hl
1414   059F 77          		ld      (hl),a
1415   05A0 23          		inc     hl
1416   05A1 77          		ld      (hl),a
1417   05A2 F1          		pop     af
1418   05A3 18 09       		jr      L_DISPLAY_SCORES
1419   05A5             
1420   05A5             		; Zero each score in turn
1421   05A5             		; (High score, player 2, player 1)
1422   05A5 3D          l05bd:  dec	 a
1423   05A6 F5          		push    af
1424   05A7 CD 87 05    		call    L_ZERO_SCORES
1425   05AA F1          		pop     af
1426   05AB C8          		ret     z
1427   05AC 18 F7       		jr      l05bd
1428   05AE             ;------------------------------------------------------------------------------
1429   05AE             
1430   05AE             
1431   05AE             
1432   05AE             ;------------------------------------------------------------------------------
1433   05AE             ; Display scores
1434   05AE             ; passed: A - score ID
1435   05AE             ;             (0 = player 1, 
1436   05AE             ;              1 = player 2,
1437   05AE             ;              2 = high score,
1438   05AE             ;              3 = all scores)
1439   05AE             L_DISPLAY_SCORES:  		
1440   05AE             		; If a is 3, jump ahead to display all scores
1441   05AE FE 03       		cp	  3
1442   05B0 28 12       		jr      z,l05e0
1443   05B2 11 B4 60    l05cb:  ld      de,PREV_P1_SCORE+2
1444   05B5 A7                  and     a
1445   05B6 28 03               jr      z,l05d5
1446   05B8 11 B7 60            ld      de,PREV_P2_SCORE+2
1447   05BB FE 02       l05d5:  cp      2
1448   05BD 20 98               jr      nz,L_DISPLAY_PLAYER_SCORE
1449   05BF 11 BA 60    l05da:  ld      de,PREV_HIGH_SCORE+2
1450   05C2             
1451   05C2             		; Display the score
1452   05C2 18 A0               jr      L_DISPLAY_HIGH_SCORE
1453   05C4             
1454   05C4             		; Display each score in turn
1455   05C4             		; (High score, player 2, player 1)
1456   05C4 3D          l05e0:  dec     a
1457   05C5 F5                  push    af
1458   05C6 CD AE 05            call    L_DISPLAY_SCORES
1459   05C9 F1                  pop     af
1460   05CA C8                  ret     z
1461   05CB 18 F7               jr      l05e0
1462   05CD             ;------------------------------------------------------------------------------
1463   05CD             
1464   05CD             
1465   05CD             
1466   05CD             ;------------------------------------------------------------------------------
1467   05CD             ; Display a string from the string table
1468   05CD             ; passed: a - string table entry number
1469   05CD             ;			if the entry number is negative, the string is erased
1470   05CD             L_DISPLAY_STRING:  
1471   05CD             		; Look up the string address in the string table
1472   05CD 21 5C 36    		ld      hl,L_STRING_TABLE
1473   05D0 87                  add     a,a
1474   05D1 F5                  push    af
1475   05D2 E6 7F               and     %01111111
1476   05D4 5F                  ld      e,a
1477   05D5 16 00               ld      d,$00
1478   05D7 19                  add     hl,de
1479   05D8 5E                  ld      e,(hl)
1480   05D9 23                  inc     hl
1481   05DA 56                  ld      d,(hl)
1482   05DB EB                  ex      de,hl
1483   05DC             
1484   05DC             		; Get the screen coordinate of the string
1485   05DC 5E                  ld      e,(hl)
1486   05DD 23                  inc     hl
1487   05DE 56                  ld      d,(hl)
1488   05DF 23                  inc     hl
1489   05E0             
1490   05E0             		; Display each character in the string 
1491   05E0             		; (string ends when $3f is found)
1492   05E0 01 E0 FF            ld      bc,-32
1493   05E3 EB                  ex      de,hl
1494   05E4 1A          l0600:  ld      a,(de)
1495   05E5 FE 3F               cp      $3f
1496   05E7 CA 26 00            jp      z,l0026						; Exceeds relative branch
1497   05EA 77                  ld      (hl),a
1498   05EB F1                  pop     af
1499   05EC             		
1500   05EC             		; If the string is to be erased, display a space instead
1501   05EC 30 02               jr      nc,l060c
1502   05EE 36 10               ld      (hl),$10
1503   05F0             
1504   05F0             		; Move to the next character
1505   05F0 F5          l060c:  push    af
1506   05F1 13                  inc     de
1507   05F2 09                  add     hl,bc
1508   05F3 18 EF               jr      l0600
1509   05F5             ;------------------------------------------------------------------------------
1510   05F5             
1511   05F5             
1512   05F5             
1513   05F5             ;------------------------------------------------------------------------------
1514   05F5             ; Display the number of plays that have been paid for
1515   05F5             L_DISPLAY_CREDITS:  
1516   05F5             		; Return if no coins have been inserted
1517   05F5 3A 07 60    		ld      a,(NO_COINS_INSERTED)
1518   05F8 0F                  rrca    
1519   05F9 D0                  ret     nc
1520   05FA             		
1521   05FA             		; Display the number of credits paid for
1522   05FA             L_DISPLAY_CREDITS_2:  
1523   05FA 3E 05       		ld      a,5
1524   05FC CD CD 05            call    L_DISPLAY_STRING
1525   05FF 21 01 60            ld      hl,NUM_PLAYS
1526   0602 11 E0 FF            ld      de,-32
1527   0605 DD 21 BF 74         ld      ix,TILE_COORD(5, 31)
1528   0609 06 01               ld      b,1
1529   060B             		; Use the score display code to display the number of credits
1530   060B C3 6F 05            jp      l0583						; Exceeds relative branch
1531   060E             ;------------------------------------------------------------------------------
1532   060E             
1533   060E             
1534   060E             
1535   060E             ;------------------------------------------------------------------------------
1536   060E             ; Process the timer either initializing it, displaying it, or adding it to
1537   060E             ; the player's score.
1538   060E             ; passed:	a - 0: Add the timer to the player's score without displaying it
1539   060E             ;				1: Simply display the timer
1540   060E             L_PROCESS_TIMER:  
1541   060E             		; If a = 0, jump ahead to add the timer to the player's score
1542   060E A7          		and     a
1543   060F 28 5F               jr      z,l0691
1544   0611             		
1545   0611             		; If ONSCREEN_TIMER is not reached 0, jump ahead
1546   0611 3A 8C 63            ld      a,(ONSCREEN_TIMER)
1547   0614 A7                  and     a
1548   0615 20 70               jr      nz,l06a8
1549   0617             		
1550   0617             		; Return unless the timer is 0 because it hasn't been initialized yet
1551   0617 3A B8 63            ld      a,(TIMER_HAS_RUN_DOWN)
1552   061A A7                  and     a
1553   061B C0                  ret     nz
1554   061C             		
1555   061C             		; Convert the hex timer number to hex BCD for display
1556   061C 3A B0 62            ld      a,(INTERNAL_TIMER)
1557   061F 01 0A 00            ld      bc,TWO_BYTES(0,10)
1558   0622             		
1559   0622             		; Determine the number of 10's in the timer
1560   0622             		; (Because the displayed timer counts down by 100's, this will be
1561   0622             		; displayed as the 1,000's digit)
1562   0622 04          l0640:  inc     b
1563   0623 91                  sub     c
1564   0624 20 FC               jr      nz,l0640
1565   0626 78                  ld      a,b
1566   0627             		
1567   0627             		; Shift the digit to the most-significant nibble in store in the onscreen timer
1568   0627 07                  rlca    
1569   0628 07                  rlca    
1570   0629 07                  rlca    
1571   062A 07                  rlca    
1572   062B 32 8C 63            ld      (ONSCREEN_TIMER),a
1573   062E             		
1574   062E             		; Display the timer box
1575   062E 21 5B 38            ld      hl,L_TIMER_BOX_TILE_DATA
1576   0631 11 65 74            ld      de,TILE_COORD(3, 5)
1577   0634 3E 06               ld      a,6							; For a = 6 to 1
1578   0636 DD 21 1D 00 l0655:  ld      ix,29
1579   063A 01 03 00            ld      bc,3						; 3 bytes of data to display
1580   063D ED B0               ldir    
1581   063F DD 19               add     ix,de						; Advance to the next column
1582   0641 DD E5               push    ix
1583   0643 D1                  pop     de							; Load ix into de
1584   0644 3D                  dec     a							
1585   0645 20 EF               jr      nz,l0655					; Next a
1586   0647             		
1587   0647             		; Determine the number of 1's in the timer
1588   0647             		; (Because the displayed timer counts down by 100's, this will be
1589   0647             		; displayed as the 100's digit)
1590   0647 3A 8C 63            ld      a,(ONSCREEN_TIMER)
1591   064A 4F          l066a:  ld      c,a
1592   064B E6 0F               and     %00001111
1593   064D 47                  ld      b,a
1594   064E             		
1595   064E             		; If the timer is greater than or equal to 1,000, then jump ahead to
1596   064E             		; skip the time running out warning
1597   064E 79                  ld      a,c
1598   064F 0F                  rrca    
1599   0650 0F                  rrca    
1600   0651 0F                  rrca    
1601   0652 0F                  rrca    
1602   0653 E6 0F               and     %00001111
1603   0655 20 11               jr      nz,l0689
1604   0657             		
1605   0657             		; Trigger the time running out warning sound
1606   0657 3E 03               ld      a,SONG_TRIGGER_OUT_OF_TIME
1607   0659 32 89 60            ld      (SONG_TRIGGER),a
1608   065C             		
1609   065C             		; Display the last two '0's of the timer in red
1610   065C 3E 70               ld      a,$70						; Red '0'
1611   065E 32 86 74            ld      (TILE_COORD(4,6)),a			; 1's digit of displayed score
1612   0661 32 A6 74            ld      (TILE_COORD(5,6)),a			; 10's digit of displayed score
1613   0664             
1614   0664             		; Clear the 1,000's digit and display the 100's digit in red
1615   0664 80                  add     a,b
1616   0665 47                  ld      b,a
1617   0666 3E 10               ld      a,$10						; ' '
1618   0668             		
1619   0668             		; Display the 1,000's digit			
1620   0668 32 E6 74    l0689:  ld      (TILE_COORD(7,6)),a			; 1,000's digit of displayed score
1621   066B             
1622   066B             		; Display the 100's digit
1623   066B 78                  ld      a,b
1624   066C 32 C6 74            ld      (TILE_COORD(6,6)),a			; 100's digit of displayed score
1625   066F C9                  ret     
1626   0670             
1627   0670             		; Award the 100's points to the player
1628   0670 3A 8C 63    l0691:  ld      a,(ONSCREEN_TIMER)
1629   0673 47                  ld      b,a
1630   0674 E6 0F               and     %00001111
1631   0676 C5                  push    bc
1632   0677 CD 06 05            call    L_AWARD_POINTS
1633   067A C1                  pop     bc
1634   067B             		
1635   067B             		; Award the 1000's points to the player
1636   067B 78                  ld      a,b
1637   067C 0F                  rrca    
1638   067D 0F                  rrca    
1639   067E 0F                  rrca    
1640   067F 0F                  rrca    
1641   0680 E6 0F               and     %00001111
1642   0682 C6 0A               add     a,10
1643   0684 C3 06 05            jp      L_AWARD_POINTS				; Exceeds relative branch
1644   0687             		
1645   0687             		; Decrement the timer
1646   0687 D6 01       l06a8:  sub     1
1647   0689             
1648   0689             		; If the timer has not reached 0, then skip ahead
1649   0689 20 05               jr      nz,l06b1
1650   068B             		
1651   068B             		; Indicate that the timer is 0 because it has run down, not that it
1652   068B             		; needs to be initialized
1653   068B 21 B8 63            ld      hl,TIMER_HAS_RUN_DOWN
1654   068E 36 01               ld      (hl),1
1655   0690             		
1656   0690             		; Resave the onscreen timer and jump back up to display it
1657   0690 27          l06b1:  daa     
1658   0691 32 8C 63            ld      (ONSCREEN_TIMER),a
1659   0694 18 B4               jr      l066a
1660   0696             ;------------------------------------------------------------------------------
1661   0696             
1662   0696             
1663   0696             
1664   0696             ;------------------------------------------------------------------------------
1665   0696             ; Display the number of lives and the current level number
1666   0696             ; passed:	a - The number of lives to subtract before the lives are displayed
1667   0696             L_DISPLAY_LIVES_AND_LEVEL:  
1668   0696 4F          		ld      c,a
1669   0697 CF                  rst     $08							; Return if attract mode is not active
1670   0698             
1671   0698             		; Blank (28,3)-(22,3)
1672   0698 06 06               ld      b,6							; For b = 6 to 1
1673   069A 11 E0 FF            ld      de,-32						
1674   069D 21 83 77            ld      hl,TILE_COORD(28,3)
1675   06A0 36 10       l06c2:  ld      (hl),$10					; Display ' '
1676   06A2 19                  add     hl,de						; Move 1 column right
1677   06A3 10 FB               djnz    l06c2						; Next b
1678   06A5             
1679   06A5             		; Subtract a life if a = 1
1680   06A5 3A 28 62            ld      a,(CP_NUMBER_LIVES)
1681   06A8 91                  sub     c
1682   06A9             
1683   06A9 28 09               jr      z,l06d7						; If there are no lives left, jump ahead
1684   06AB             
1685   06AB             		; Display the number of lives
1686   06AB 47                  ld      b,a							; For b = number of lives to 1
1687   06AC 21 83 77            ld      hl,TILE_COORD(28,3)
1688   06AF 36 FF       l06d2:  ld      (hl),$ff					; Display the life icon
1689   06B1 19                  add     hl,de						; Move 1 column right
1690   06B2 10 FB               djnz    l06d2						; Next b
1691   06B4             
1692   06B4             		; Display "L="
1693   06B4 21 03 75    l06d7:  ld      hl,TILE_COORD(8,3)
1694   06B7 36 1C               ld      (hl),$1c					; Display 'L'
1695   06B9 21 E3 74            ld      hl,TILE_COORD(7,3)
1696   06BC 36 34               ld      (hl),$34					; Display '='
1697   06BE 3A 29 62            ld      a,(CP_LEVEL_NUMBER)
1698   06C1                     
1699   06C1             		; Limit level number to 99
1700   06C1 FE 64       		cp      100
1701   06C3 38 05               jr      c,l06ed
1702   06C5 3E 63               ld      a,99
1703   06C7 32 29 62            ld      (CP_LEVEL_NUMBER),a
1704   06CA             
1705   06CA             		; Convert the level number to 10's digit (in b) and 1's digit (in a)
1706   06CA 01 0A FF    l06ed:  ld      bc,$ff0a
1707   06CD 04          l06f0:  inc     b
1708   06CE 91                  sub     c
1709   06CF 30 FC               jr      nc,l06f0
1710   06D1 81                  add     a,c
1711   06D2 32 A3 74            ld      (TILE_COORD(5,3)),a			; Display 1's digit
1712   06D5 78                  ld      a,b
1713   06D6 32 C3 74            ld      (TILE_COORD(6,3)),a			; Display 10's digit
1714   06D9 C9                  ret     
1715   06DA             ;------------------------------------------------------------------------------
1716   06DA             
1717   06DA             
1718   06DA             
1719   06DA             ;------------------------------------------------------------------------------
1720   06DA             ; Called when the GAME_STATE == 3 (player is playing)
1721   06DA             ; Jump to one of the following table entries based on the current game screen
1722   06DA             L_IMPLEMENT_GAME_PLAY:  
1723   06DA 3A 0A 60    		ld      a,(GAME_SUBSTATE)
1724   06DD EF                  rst     $28							; Jump to local table address
1725   06DE             		; Jump table
1726   06DE 46 09       		.word	L_ORIENT_SCREEN				; 0 = orient the screen
1727   06E0 69 09       		.word	L_INIT_P1					; 1 = initialize player 1
1728   06E2 93 09       		.word	L_P1_PROMPT_SCREEN			; 2 = display player 1 prompt
1729   06E4 BB 09       		.word	L_INIT_P2					; 3 = intialize player 2
1730   06E6 D8 09       		.word	L_P2_PROMPT_SCREEN			; 4 = display player 2 prompt
1731   06E8 F4 09       		.word	L_DISPLAY_TURN_DATA			; 5 = display data for this turn
1732   06EA 20 0A       		.word	L_PREPARE_SCREEN_FOR_TURN	; 6 = trigger introduction or intermission
1733   06EC 33 0A       		.word	L_IMPLEMENT_INTRO_STAGE		; 7 = show introduction stage
1734   06EE 93 0B       		.word	L_DISPLAY_INTERMISSION		; 8 = show intermission
1735   06F0 00 00       		.word	L_ORG						; 9 = reset game
1736   06F2 46 0C       		.word	L_DISPLAY_CURRENT_STAGE		; 10 = display current stage
1737   06F4 A3 12       		.word	L_INIT_MARIO				; 11 = initialize Mario sprite
1738   06F6 88 1A       		.word	L_RUN_GAME					; 12 = run game
1739   06F8 E2 12       		.word	L_IMPLEMENT_DEATH_ANIM		; 13 = display Mario death animation
1740   06FA 54 13       		.word	L_POST_DEATH_PROCESSING_P1	; 14 = end turn player 1
1741   06FC A4 13       		.word	L_POST_DEATH_PROCESSING_P2	; 15 = end turn player 2
1742   06FE ED 13       		.word	L_ADV_FROM_P1_GAME_OVER		; 16 = start player 2 or end the game
1743   0700 FE 13       		.word	L_ADV_FROM_P2_GAME_OVER		; 17 = start player 1 or end the game
1744   0702 06 14       		.word	L_PREPARE_FOR_P2_TURN		; 18 = activate player 2
1745   0704 17 14       		.word	L_PREPARE_FOR_P1_TURN		; 19 = activate player 1
1746   0706 7A 14       		.word	L_CHECK_FOR_HS_INITIALS		; 20 = check for high scores
1747   0708 DB 14       		.word	L_IMPLEMENT_HS_INITIAL_ENTRY ; 21 = get initials for high scores
1748   070A 51 16       		.word	L_IMPLEMENT_STAGE_WIN_ANIM	; 22 = show win animation for barrels, mixer, and elevator stages
1749   070C 79 1A       		.word	L_PREP_FOR_NEXT_PLAYER		; 23 = activate next player
1750   070E             ;------------------------------------------------------------------------------
1751   070E             
1752   070E             
1753   070E             
1754   070E             ;------------------------------------------------------------------------------
1755   070E             ; Called when GAME_STATE == 1 (attract mode)
1756   070E             ; If credits have been paid for, just wait for the player to push start, otherwise
1757   070E             ; run through the attract sequence.
1758   070E             L_IMPLEMENT_ATTRACT_MODE: 	
1759   070E 21 0A 60    		ld      hl,GAME_SUBSTATE
1760   0711 3A 01 60    		ld      a,(NUM_PLAYS)
1761   0714 A7                  and     a
1762   0715 20 12       		jr		nz,L_PROMPT_FOR_START					; If coins have been entered, just show the start prompt
1763   0717 7E          		ld		a,(hl)
1764   0718 EF          		rst		$28
1765   0719             		; Jump table
1766   0719 46 07       		.word	L_INSERT_COINS_SCREEN ; 0 = display insert coin screen
1767   071B 30 07       		.word	L_PREPARE_DEMO_MODE ; 1 = prepare for attract mode
1768   071D A3 12       		.word	L_INIT_MARIO ; 2 = initialize Mario sprite
1769   071F 85 1A       		.word	L_RUN_GAME_DEMO ; 3 = run demo
1770   0721 E2 12       		.word	L_IMPLEMENT_DEATH_ANIM ; 4 = display Mario death animation
1771   0723 8F 07       		.word	L_CLEAN_UP_DEMO_MODE ; 5 = clear the screen
1772   0725 97 07       		.word	L_FLASH_DK_TITLE_SCREEN ; 6 = display the title screen with "DONKEY KONG" letters and cycle the palette
1773   0727 16 08       		.word	L_FREEZE_DK_TITLE_SCREEN ; 7 = display the title screen until it times out
1774   0729             ;------------------------------------------------------------------------------
1775   0729             
1776   0729             		
1777   0729             		
1778   0729             ;------------------------------------------------------------------------------
1779   0729             ; Prompt the player to push start
1780   0729             ; passed - hl - GAME_SUBSTATE
1781   0729             L_PROMPT_FOR_START:  
1782   0729 36 00       		ld      (hl),$00					; Set GAME_SUBSTATE to 0
1783   072B 21 05 60            ld      hl,GAME_STATE
1784   072E 34                  inc     (hl)						; GAME_STATE = 2 (waiting for player to push start)
1785   072F C9                  ret     
1786   0730             ;------------------------------------------------------------------------------
1787   0730             
1788   0730             
1789   0730             
1790   0730             ;------------------------------------------------------------------------------
1791   0730             ; Prepare for the demonstration mode by setting the stage, level and number of
1792   0730             ; lives, and displaying the stage.
1793   0730             L_PREPARE_DEMO_MODE:  
1794   0730             		; Return until the timers decrement to 0
1795   0730 E7          		rst     $20						
1796   0731                     
1797   0731             		; Clear $6392 and the fireball release trigger
1798   0731 AF          		xor     a
1799   0732 32 92 63            ld      ($6392),a
1800   0735 32 A0 63            ld      (RELEASE_A_FIREBALL),a
1801   0738             
1802   0738             		; Demo occurs on barrels stage, level 1 with 1 life
1803   0738 3E 01               ld      a,1
1804   073A 32 27 62            ld      (CURRENT_STAGE),a
1805   073D 32 29 62            ld      (CP_LEVEL_NUMBER),a
1806   0740 32 28 62            ld      (CP_NUMBER_LIVES),a
1807   0743             
1808   0743             		; Display and initialize the current stage
1809   0743 C3 47 0C            jp      L_DISPLAY_CURRENT_STAGE_2	; Exceeds relative branch
1810   0746             ;------------------------------------------------------------------------------
1811   0746             
1812   0746             
1813   0746             
1814   0746             ;------------------------------------------------------------------------------
1815   0746             ; Display the initial screen in attract mode.  The string "INSERT COIN" is shown
1816   0746             ; and the number of coins required for 1 and 2 players is also displayed.  The
1817   0746             ; previous game's score(s) is shown as well.
1818   0746             L_INSERT_COINS_SCREEN:  
1819   0746             		; Initialize pallette to 00
1820   0746 21 86 7D    		ld      hl,PALETTE_1_OUTPUT						
1821   0749 36 00               ld      (hl),$00
1822   074B 23                  inc     hl
1823   074C 36 00               ld      (hl),$00
1824   074E             		
1825   074E 11 1B 03    		ld      de,$031b
1826   0751 CD 36 31            call    L_ADD_EVENT				; Display "INSERT COIN"
1827   0754 1C                  inc     e
1828   0755 CD 36 31            call    L_ADD_EVENT				; Display "  PLAYER    COIN"
1829   0758 CD 25 09            call    L_DISPLAY_HIGH_SCORES
1830   075B             
1831   075B             		; Set MINOR_TIMER to 2
1832   075B 21 09 60            ld      hl,MINOR_TIMER
1833   075E 36 02               ld      (hl),2
1834   0760             		
1835   0760             		; Set GAME_SUBSTATE to 1 (initializing the attract mode)
1836   0760 23                  inc     hl
1837   0761 34                  inc     (hl)
1838   0762             		
1839   0762             		; Clear the game section of the screen and display "1UP"
1840   0762 CD 3D 08            call    L_CLEAR_STAGE_SCREEN
1841   0765 CD 10 0A            call    L_DISPLAY_1UP
1842   0768             		
1843   0768             		; If the last game had two players, then display "2UP" as well
1844   0768 3A 0F 60            ld      a,(TWO_PLAYERS)
1845   076B FE 01               cp      1
1846   076D CC AB 09            call    z,L_DISPLAY_2UP		
1847   0770             		
1848   0770             		; Display the number of coins required for 1 player to play
1849   0770 ED 5B 22 60         ld      de,(NUM_COINS_FOR_1P)
1850   0774 21 6C 75            ld      hl,TILE_COORD(11,12)
1851   0777 CD 7A 07            call    l07ad
1852   077A             		
1853   077A             		; Display e at the tile address in hl and d in the next row down
1854   077A 73          l07ad:  ld      (hl),e
1855   077B 23                  inc     hl
1856   077C 23                  inc     hl
1857   077D 72                  ld      (hl),d
1858   077E 7A                  ld      a,d
1859   077F             		; If the coins required for two players >= 10, then display both digits
1860   077F D6 0A               sub     10
1861   0781 20 05               jr      nz,l07bc
1862   0783 77                  ld      (hl),a
1863   0784 3C                  inc     a
1864   0785 32 8E 75            ld      (TILE_COORD(12,14)),a
1865   0788             		
1866   0788             		; Display '1' and '2' for 1 and 2 players
1867   0788 11 01 02    l07bc:  ld      de,$0201
1868   078B 21 8C 76            ld      hl,TILE_COORD(20,12)
1869   078E C9                  ret     
1870   078F             ;------------------------------------------------------------------------------
1871   078F             
1872   078F             
1873   078F             
1874   078F             ;------------------------------------------------------------------------------
1875   078F             ; Clean up the demonstration mode by clearing the stage tiles and advancing to 
1876   078F             ; the next substate
1877   078F             L_CLEAN_UP_DEMO_MODE:  
1878   078F CD 3D 08    		call    L_CLEAR_STAGE_SCREEN
1879   0792             		
1880   0792             		; Attract mode substate = 6
1881   0792 21 0A 60            ld      hl,GAME_SUBSTATE
1882   0795 34                  inc     (hl)
1883   0796 C9                  ret     
1884   0797             ;------------------------------------------------------------------------------
1885   0797             
1886   0797             
1887   0797             
1888   0797             ;------------------------------------------------------------------------------
1889   0797             ; Display the DONKEY KONG title screen
1890   0797             ; The palette is cycled to make the screen flash excitingly
1891   0797             L_FLASH_DK_TITLE_SCREEN:  
1892   0797             		; If the palette cycle counter has already been initialized, jump ahead
1893   0797 3A 8A 63    		ld      a,(TITLE_PALETTE_CYCLE_COUNTER)
1894   079A FE 00               cp      0
1895   079C 20 5B               jr      nz,l082d
1896   079E             		
1897   079E             		; Initialize the palette cycle counter to 96 
1898   079E 3E 60               ld      a,96
1899   07A0 32 8A 63            ld      (TITLE_PALETTE_CYCLE_COUNTER),a
1900   07A3             
1901   07A3             		; Set the palette cycle pattern
1902   07A3 0E 5F               ld      c,%01011111
1903   07A5             
1904   07A5             		; If the palette cycle counter has reached zero, then advance to the next
1905   07A5             		; submode
1906   07A5 FE 00       l07da:  cp      0
1907   07A7 28 5D               jr      z,l083b
1908   07A9             		
1909   07A9             		; Rotate the palette and set PALETTE_1_OUTPUT to the previous value of bit 7
1910   07A9 21 86 7D            ld      hl,PALETTE_1_OUTPUT
1911   07AC 36 00               ld      (hl),0
1912   07AE 79          		ld      a,c
1913   07AF CB 07               rlc     a
1914   07B1 30 02               jr      nc,l07eb
1915   07B3 36 01               ld      (hl),1
1916   07B5             		
1917   07B5             		; Rotate the palette and set PALETTE_2_OUTPUT to the previous value of bit 7
1918   07B5 23          l07eb:  inc     hl
1919   07B6 36 00               ld      (hl),0
1920   07B8 CB 07               rlc     a
1921   07BA 30 02               jr      nc,l07f4
1922   07BC 36 01               ld      (hl),1
1923   07BE             		
1924   07BE             		; Draw the large "DONKEY KONG" letters
1925   07BE 32 8B 63    l07f4:  ld      (TITLE_PALETTE_PATTERN),a
1926   07C1 21 6F 3D            ld      hl,L_LARGE_DK_LETTER_DATA
1927   07C4             		
1928   07C4             		; Draw one line of tiles
1929   07C4 3E B0       l07fa:  ld      a,$b0						; Girder tile with large round hole
1930   07C6 46          		ld      b,(hl)						; for b = the number of tiles to draw to 1
1931   07C7 23                  inc     hl
1932   07C8 5E                  ld      e,(hl)						; de = the first tile screen coordinate
1933   07C9 23                  inc     hl
1934   07CA 56                  ld      d,(hl)
1935   07CB 12          l0801:  ld      (de),a						; Display the rivet tile at the current coordinate
1936   07CC 13                  inc     de							; Move down one row
1937   07CD 10 FC               djnz    l0801						; Next b
1938   07CF             		
1939   07CF             		; If this is not the end of the letter data, then repeat
1940   07CF 23                  inc     hl
1941   07D0 7E                  ld      a,(hl)
1942   07D1 FE 00               cp      $00
1943   07D3 20 EF               jr      nz,l07fa
1944   07D5             		
1945   07D5             		; Display "PLUS!"
1946   07D5 11 1D 03    		ld		de,$031d
1947   07D8 CD 36 31    		call	L_ADD_EVENT
1948   07DB             		
1949   07DB             		; Display "1981" and "NINTENDO OF AMERICA"
1950   07DB 13                  inc		de
1951   07DC CD 36 31    		call    L_ADD_EVENT
1952   07DF 13                  inc     de
1953   07E0 CD 36 31            call    L_ADD_EVENT
1954   07E3             		
1955   07E3             		; Load Donkey Kong sprites
1956   07E3 21 E0 39            ld      hl,L_DK_SPRITES_GRIN_L_STOMP
1957   07E6 CD 4E 00            call    L_LOAD_DK_SPRITES
1958   07E9             		
1959   07E9             		; Display "(TM)"
1960   07E9 CD B4 3F            call    L_DISPLAY_TM
1961   07EC             		
1962   07EC             		; Position and display Donkey Kong 
1963   07EC 21 08 69            ld      hl,DK_SPRITE_1_X
1964   07EF 0E 44               ld      c,68
1965   07F1 FF                  rst     $38
1966   07F2 21 0B 69            ld      hl,DK_SPRITE_1_Y
1967   07F5 0E 78               ld      c,120
1968   07F7 FF                  rst     $38
1969   07F8 C9                  ret     
1970   07F9             
1971   07F9             		; Load the previous palette pattern
1972   07F9 3A 8B 63    l082d:  ld      a,(TITLE_PALETTE_PATTERN)
1973   07FC 4F                  ld      c,a
1974   07FD             		
1975   07FD             		; Decrement the cycle counter
1976   07FD 3A 8A 63            ld      a,(TITLE_PALETTE_CYCLE_COUNTER)
1977   0800 3D                  dec     a
1978   0801 32 8A 63            ld      (TITLE_PALETTE_CYCLE_COUNTER),a
1979   0804             
1980   0804             		; Implement the palette cycling
1981   0804 18 9F               jr      l07da
1982   0806             		
1983   0806             		; Clean up and move to the next substate
1984   0806 21 09 60    l083b:  ld      hl,MINOR_TIMER
1985   0809 36 02               ld      (hl),2					; Set MINOR_TIMER to 2
1986   080B 23                  inc     hl
1987   080C 34                  inc     (hl)						; Advance the substate
1988   080D 21 8A 63            ld      hl,TITLE_PALETTE_CYCLE_COUNTER
1989   0810 36 00               ld      (hl),0						; Set TITLE_PALETTE_CYCLE_COUNTER to 0
1990   0812 23                  inc     hl
1991   0813 36 00               ld      (hl),0						; Set TITLE_PALETTE_PATTERN to 0
1992   0815 C9                  ret     
1993   0816             ;------------------------------------------------------------------------------
1994   0816             
1995   0816             
1996   0816             
1997   0816             ;------------------------------------------------------------------------------
1998   0816             ; Pause on the DONKEY KONG title screen and then restart the attract mode
1999   0816             L_FREEZE_DK_TITLE_SCREEN:  
2000   0816             		; Return until the timers run down
2001   0816 E7          		rst     $20
2002   0817             
2003   0817             		; Reset the attract mode substate to 0
2004   0817 21 0A 60            ld      hl,GAME_SUBSTATE
2005   081A 36 00               ld      (hl),0
2006   081C C9                  ret     
2007   081D             ;------------------------------------------------------------------------------
2008   081D             
2009   081D             
2010   081D             
2011   081D             ;------------------------------------------------------------------------------
2012   081D             ; Clear the entire screen and all the sprite
2013   081D             L_CLEAR_SCREEN_AND_SPRITES:  
2014   081D             		; Clear the entire screen
2015   081D 21 00 74    		ld      hl,TILE_COORD(0,0)
2016   0820 0E 04               ld      c,4						; For c = 4 to 1
2017   0822 06 00       l0857:  ld      b,0						; For b = 256 to 1
2018   0824 3E 10               ld      a,$10					; ' '
2019   0826 77          l085b:  ld      (hl),a
2020   0827 23                  inc     hl
2021   0828 10 FC               djnz    l085b					; Next b
2022   082A 0D                  dec     c		
2023   082B 20 F5               jr      nz,l0857				; Next c
2024   082D                     
2025   082D                     ; Clear all 96 sprites
2026   082D 21 00 69            ld      hl,SPRITE_STRUCTS
2027   0830 0E 02               ld      c,2						; For c = 2 to 1
2028   0832 06 C0       l0868:  ld      b,192					; For b = 192 to 1
2029   0834 AF                  xor     a
2030   0835 77          l086b:  ld      (hl),a					; 0 this sprite byte
2031   0836 23                  inc     hl
2032   0837 10 FC               djnz    l086b					; Next b
2033   0839 0D                  dec     c
2034   083A 20 F6               jr      nz,l0868				; Next c
2035   083C C9                  ret     
2036   083D             ;------------------------------------------------------------------------------
2037   083D             
2038   083D             
2039   083D             
2040   083D             ;------------------------------------------------------------------------------
2041   083D             ; Clear the screen tiles (all but the top 4 rows)
2042   083D             L_CLEAR_STAGE_SCREEN:  
2043   083D 21 04 74    		ld      hl,TILE_COORD(0,4)
2044   0840 0E 20               ld      c,32					; For c = 32 to 1 (32 columns)
2045   0842 06 1C       l0879:  ld      b,28					; For b = 28 to 1 (the lower 28 rows)
2046   0844 3E 10               ld      a,$10					; ' '
2047   0846 11 04 00            ld      de,4
2048   0849 77          l0880:  ld      (hl),a					; Clear this screen coord
2049   084A 23                  inc     hl						; Advance 1 row down
2050   084B 10 FC               djnz    l0880					; Next b
2051   084D 19                  add     hl,de					; Skip the top 4 rows
2052   084E 0D                  dec     c						
2053   084F 20 F1               jr      nz,l0879				; Next c
2054   0851             		
2055   0851             		; Clear (9,2) to (22,3)
2056   0851 21 22 75            ld      hl,TILE_COORD(9,2)
2057   0854 11 20 00            ld      de,32			
2058   0857 0E 02               ld      c,2						; For c = 2 to 1 (2 rows)
2059   0859 3E 10               ld      a,$10				
2060   085B 06 0E       l0893:  ld      b,14					; For b = 14 to 1
2061   085D 77          l0895:  ld      (hl),a					; Clear this screen coord
2062   085E 19                  add     hl,de					; Advance 1 column left
2063   085F 10 FC               djnz    l0895					; Next b
2064   0861 21 23 75            ld      hl,TILE_COORD(9,3)
2065   0864 0D                  dec     c						
2066   0865 20 F4               jr      nz,l0893				; Next c
2067   0867             		
2068   0867             		; Clear sprites
2069   0867 21 00 69            ld      hl,SPRITE_STRUCTS
2070   086A AF                  xor		a
2071   086B 47          		ld		b,a
2072   086C 77          l08a7:  ld      (hl),a
2073   086D 23                  inc     hl
2074   086E 10 FC               djnz    l08a7
2075   0870 06 80               ld      b,128
2076   0872 77          l08ad:  ld      (hl),a
2077   0873 23                  inc     hl
2078   0874 10 FC               djnz    l08ad
2079   0876             		
2080   0876 C9                  ret     
2081   0877             ;------------------------------------------------------------------------------
2082   0877             
2083   0877             
2084   0877             
2085   0877             ;------------------------------------------------------------------------------
2086   0877             ; Game processing once a coin has been entered.  The attract mode no longer runs, 
2087   0877             ; and the screen prompts the player to just push start already...
2088   0877 3A 0A 60    L_WAITING_FOR_START_MODE:  ld      a,(GAME_SUBSTATE)
2089   087A EF                  rst     $28							; Jump to local table address
2090   087B 7F 08               .word	L_DISPLAY_PUSH_START_SCREEN	; 0 = display start prompt
2091   087D BB 08       		.word	L_HANDLE_START_BUTTONS	; 1 = start 1 or 2 players
2092   087F             ;------------------------------------------------------------------------------
2093   087F             
2094   087F             
2095   087F             		
2096   087F             ;------------------------------------------------------------------------------
2097   087F             ; Display the "push 1 player" or "push 1 or 2 player" screen
2098   087F             ; 
2099   087F             ; passed:	none
2100   087F             ; return:	the state of misc input in a
2101   087F             L_DISPLAY_PUSH_START_SCREEN:  
2102   087F CD 3D 08    		call    L_CLEAR_STAGE_SCREEN
2103   0882             		
2104   0882             		; Coins have been inserted
2105   0882 AF                  xor     a
2106   0883 32 07 60            ld      (NO_COINS_INSERTED),a
2107   0886                     
2108   0886                     ; Display "PUSH"
2109   0886 11 0C 03            ld      de,$030c
2110   0889 CD 36 31            call    L_ADD_EVENT
2111   088C                     
2112   088C                     ; Advance to the next substate
2113   088C 21 0A 60            ld      hl,GAME_SUBSTATE
2114   088F 34                  inc     (hl)
2115   0890                     
2116   0890 CD 25 09            call    L_DISPLAY_HIGH_SCORES
2117   0893                     
2118   0893                     ; Initialize the palette to 00
2119   0893 AF                  xor     a
2120   0894 21 86 7D            ld      hl,PALETTE_1_OUTPUT
2121   0897 77                  ld      (hl),a
2122   0898 2C                  inc     l
2123   0899 77                  ld      (hl),a
2124   089A                            
2125   089A                     ; If only 1 play has been paid for, jump ahead to only offer 1 player option
2126   089A 06 04       l08d5:  ld      b,%00000100					; Filter out every input but 1 player start
2127   089C 1E 09               ld      e,$09						; = "ONLY 1 PlAYER BUTTON"
2128   089E 3A 01 60            ld      a,(NUM_PLAYS)
2129   08A1 FE 01               cp      1
2130   08A3 28 03               jr      z,l08e4
2131   08A5                     
2132   08A5                     ; If more than 1 play has been paid for, offer 1 or 2 player
2133   08A5 06 0C               ld      b,%00001100					; Filter out every input but 1 and 2 player start
2134   08A7 1C                  inc     e							; "1 OR 2 PLAYERS BUTTON"
2135   08A8                     
2136   08A8                     ; Only display 1, or 1 or 2 player prompt when the 3 LSBs of COUNTER_2 are zero?
2137   08A8 3A 1A 60    l08e4:  ld      a,(COUNTER_2)
2138   08AB E6 07               and     %00000111
2139   08AD 20 07               jr      nz,l08f3
2140   08AF                     
2141   08AF 7B                  ld      a,e
2142   08B0 CD CD 05            call    L_DISPLAY_STRING
2143   08B3 CD FA 05            call    L_DISPLAY_CREDITS_2
2144   08B6                     
2145   08B6                     ; Filter MISC_INPUT
2146   08B6 3A 00 7D    l08f3:  ld      a,(MISC_INPUT)
2147   08B9 A0                  and     b
2148   08BA C9                  ret     
2149   08BB             ;------------------------------------------------------------------------------
2150   08BB             
2151   08BB             
2152   08BB             ;------------------------------------------------------------------------------
2153   08BB             ; Wait for the player to press either 1 player start or 2 player start and
2154   08BB             ; start the game when one of them is pressed.
2155   08BB             ;
2156   08BB             ; passed:	none
2157   08BB             ; return:	none
2158   08BB             L_HANDLE_START_BUTTONS:  
2159   08BB             		; Display "ONLY 1 PLAYER BUTTON" or "1 or 2 PLAYERS BUTTON" and filter
2160   08BB             		; player input accordingly
2161   08BB CD 9A 08    		call    l08d5						; a = misc input
2162   08BE             
2163   08BE             		; If the 1 PLAYER START has been pressed, jump ahead to start 1 player
2164   08BE FE 04               cp      $04
2165   08C0 28 05               jr      z,l0906
2166   08C2             		
2167   08C2             		; If the 2 PLAYER START has been pressed, jump ahead to start 2 players
2168   08C2 FE 08               cp      $08	
2169   08C4 28 13               jr      z,l0919
2170   08C6 C9                  ret     
2171   08C7             		
2172   08C7             		; Subtract one play from the number of plays that have been paid for
2173   08C7 CD 37 09    l0906:  call    L_SUBTRACT_ONE_PLAY
2174   08CA             
2175   08CA             		; Clear player 2 data
2176   08CA 21 48 60            ld      hl,P2_DATA
2177   08CD 06 08               ld      b,$08
2178   08CF AF                  xor     a
2179   08D0 77          l090f:  ld      (hl),a
2180   08D1 2C                  inc     l
2181   08D2 10 FC               djnz    l090f
2182   08D4             		
2183   08D4             		; Jump ahead to set SECOND_PLAYER to 0 (indicating that the current player is player 1)
2184   08D4             		; and set TWO_PLAYERS to 0 (indicating that one player is playing)
2185   08D4 21 00 00            ld      hl,$0000
2186   08D7 18 1F               jr      l0938
2187   08D9             		
2188   08D9             		; Subtract two plays from the number of plays that have been paid for
2189   08D9 CD 37 09    l0919:  call    L_SUBTRACT_ONE_PLAY
2190   08DC CD 37 09            call    L_SUBTRACT_ONE_PLAY
2191   08DF             		
2192   08DF             		; Initialize player 2's number of lives to the initial number of lives
2193   08DF             		; (from the DIP settings)
2194   08DF 11 48 60            ld      de,P2_NUMBER_LIVES
2195   08E2 3A 20 60            ld      a,(DIP_NUM_LIVES)
2196   08E5 12                  ld      (de),a
2197   08E6             		
2198   08E6             		; Fill player 2's data with the initial data values
2199   08E6 1C                  inc     e							; de = P2_LEVEL_NUMBER
2200   08E7 21 1E 09            ld      hl,L_INITIAL_PLAYER_DATA_TABLE
2201   08EA 01 07 00            ld      bc,7						; 7 bytes of data to copy
2202   08ED ED B0               ldir    
2203   08EF             		
2204   08EF             		; Zero player 2's score
2205   08EF 11 01 01            ld      de,$0101
2206   08F2 CD 36 31            call    L_ADD_EVENT
2207   08F5             		
2208   08F5             		; Set SECOND_PLAYER to 0 (indicating that the current player is player 1)
2209   08F5             		; and set TWO_PLAYERS to 1 (indicating that two players are playing)
2210   08F5 21 00 01            ld      hl,$0100
2211   08F8             		
2212   08F8             		; Set the values of SECOND_PLAYER (to the value of l) 
2213   08F8             		; and TWO_PLAYERS (to the value of h)
2214   08F8 22 0E 60    l0938:  ld      (SECOND_PLAYER),hl
2215   08FB             
2216   08FB             		; Clear the entire stage portion of the screen
2217   08FB CD 3D 08            call    L_CLEAR_STAGE_SCREEN
2218   08FE             		
2219   08FE             		; Initialize player 1's number of lives to the initial number of lives
2220   08FE             		; (from the DIP settings)
2221   08FE 11 40 60            ld      de,P1_NUMBER_LIVES
2222   0901 3A 20 60            ld      a,(DIP_NUM_LIVES)
2223   0904 12                  ld      (de),a
2224   0905             		
2225   0905             		; Fill player 1's data with the initial data values
2226   0905 1C                  inc     e							; de = P1_LEVEL_NUMBER
2227   0906 21 1E 09            ld      hl,L_INITIAL_PLAYER_DATA_TABLE
2228   0909 01 07 00            ld      bc,7						; 7 bytes of data to copy
2229   090C ED B0               ldir    
2230   090E             		
2231   090E             		; Zero player 1's score
2232   090E 11 00 01            ld      de,$0100
2233   0911 CD 36 31            call    L_ADD_EVENT
2234   0914             		
2235   0914             		; Set the game state to playing and game substate to orienting the screen
2236   0914 AF                  xor     a
2237   0915 32 0A 60            ld      (GAME_SUBSTATE),a
2238   0918 3E 03               ld      a,3
2239   091A 32 05 60            ld      (GAME_STATE),a
2240   091D C9                  ret 
2241   091E             ;------------------------------------------------------------------------------
2242   091E             
2243   091E             
2244   091E             
2245   091E             ;------------------------------------------------------------------------------
2246   091E             ; The following table contains the initial values for player data when the game
2247   091E             ; is first beginning
2248   091E             L_INITIAL_PLAYER_DATA_TABLE:  
2249   091E 01          		.byte	1		; LEVEL_NUMBER - Start on level one
2250   091F 76 3A       		.word	L_STAGE_ORDER_TABLE	; STAGE_ORDER_POINTER - Address of the stage order for level 1
2251   0921 01          		.byte	1		; INTRO_NOT_DISPLAYED - The introduction stage has not been displayed
2252   0922 00          		.byte	0		; BONUS_AWARDED - The bonus life has not been awarded
2253   0923 00          		.byte	0		; HEIGHT_INDEX - Still working on 25 meters
2254   0924 00          		.byte	0		; STAGE_ORDER_POINTER_LAG - Not initialized
2255   0925             ;------------------------------------------------------------------------------
2256   0925             
2257   0925             
2258   0925             
2259   0925             ;------------------------------------------------------------------------------
2260   0925             ; Display the high score table
2261   0925             L_DISPLAY_HIGH_SCORES:  
2262   0925             		; Display the number of plays that have been paid for
2263   0925 11 00 04    		ld      de,$0400
2264   0928 CD 36 31            call    L_ADD_EVENT	
2265   092B             
2266   092B             		; Display the high score table			
2267   092B 11 14 03            ld      de,$0314
2268   092E 06 06               ld      b,$06
2269   0930 CD 36 31    l0970:  call    L_ADD_EVENT
2270   0933 1C                  inc     e
2271   0934 10 FA               djnz    l0970
2272   0936 C9                  ret     
2273   0937             ;------------------------------------------------------------------------------
2274   0937             
2275   0937             
2276   0937             
2277   0937             ;------------------------------------------------------------------------------
2278   0937             ; Subtract one play from the number of plays that have been paid for.
2279   0937             ; 
2280   0937             ; passed:	none
2281   0937             ; return: 	none
2282   0937             L_SUBTRACT_ONE_PLAY:  
2283   0937             		; Interesting way to subtract one play...
2284   0937 21 01 60    		ld      hl,NUM_PLAYS
2285   093A 3E 99               ld      a,$99
2286   093C 86                  add     a,(hl)
2287   093D 27                  daa     
2288   093E 77                  ld      (hl),a
2289   093F             		
2290   093F             		; Redisplay the number of credits paid for
2291   093F 11 00 04            ld      de,$0400
2292   0942 CD 36 31            call    L_ADD_EVENT
2293   0945             		
2294   0945 C9                  ret     
2295   0946             ;------------------------------------------------------------------------------
2296   0946             
2297   0946             
2298   0946             
2299   0946             ;------------------------------------------------------------------------------
2300   0946             ; Orient the screen for the next player.
2301   0946             ; This really only applies to cocktail cabinets, where the screen is flipped
2302   0946             ; when it is the second player's turn.
2303   0946             L_ORIENT_SCREEN:  
2304   0946 CD 1D 08    		call    L_CLEAR_SCREEN_AND_SPRITES
2305   0949 CD 0F 01            call    L_SOUNDS_OFF
2306   094C                     
2307   094C                     ; Orient the screen right side up
2308   094C 11 82 7D            ld      de,SCREEN_ORIENTATION
2309   094F 3E 01               ld      a,1
2310   0951 12                  ld      (de),a
2311   0952                     
2312   0952                     ; If the second player is active, jump ahead to invert the screen, if needed
2313   0952 21 0A 60            ld      hl,GAME_SUBSTATE
2314   0955 3A 0E 60            ld      a,(SECOND_PLAYER)
2315   0958 A7                  and     a
2316   0959 20 03               jr      nz,l099f
2317   095B                     
2318   095B                     ; If this is the first player, set substate to 1
2319   095B 36 01               ld      (hl),1
2320   095D C9                  ret     
2321   095E                     
2322   095E                     ; If this is an upright cabinet, don't flip the screen 
2323   095E                     ; for the second player
2324   095E 3A 26 60    l099f:  ld      a,(CABINET_TYPE)
2325   0961 3D                  dec     a
2326   0962 28 02               jr      z,l09a8
2327   0964                     
2328   0964                     ; If this is a cocktail cabinet, flip the screen for 
2329   0964                     ; the second player
2330   0964 AF                  xor     a
2331   0965 12                  ld      (de),a
2332   0966                     
2333   0966                     ; This is the second player, so set the substate to 3
2334   0966 36 03       l09a8:  ld      (hl),3
2335   0968 C9                  ret     
2336   0969             ;------------------------------------------------------------------------------
2337   0969             
2338   0969             
2339   0969             
2340   0969             ;------------------------------------------------------------------------------
2341   0969             ; Initialize player 1 and cause the player 1 prompt to be shown if there are 
2342   0969             ; two players in the game
2343   0969             L_INIT_P1:  
2344   0969             		; Copy player 1 data to the current player data
2345   0969 21 40 60    		ld      hl,P1_DATA
2346   096C 11 28 62            ld      de,CP_DATA
2347   096F 01 08 00            ld      bc,8
2348   0972 ED B0               ldir    
2349   0974                     
2350   0974                     ; Record the current stage
2351   0974 2A 2A 62            ld      hl,(CP_STAGE_ORDER_POINTER)
2352   0977 7E                  ld      a,(hl)
2353   0978 32 27 62            ld      (CURRENT_STAGE),a
2354   097B                     
2355   097B                     ; If this is a two player game,
2356   097B                     ; set the minor timer to 120 and substate to 2 
2357   097B                     ; to display the 1 player prompt
2358   097B 3A 0F 60            ld      a,(TWO_PLAYERS)
2359   097E A7                  and     a
2360   097F 21 09 60            ld      hl,MINOR_TIMER
2361   0982 11 0A 60            ld      de,GAME_SUBSTATE
2362   0985 28 06               jr      z,l09d0
2363   0987 36 78               ld      (hl),120
2364   0989 EB                  ex      de,hl
2365   098A 36 02               ld      (hl),2
2366   098C C9                  ret     
2367   098D                      
2368   098D                     ; If this is a one player game,
2369   098D                     ; set the minor timer to 1 and substate to 5
2370   098D                     ; to skip the 1 player prompt
2371   098D 36 01       l09d0:  ld      (hl),1
2372   098F EB                  ex      de,hl
2373   0990 36 05               ld      (hl),5
2374   0992 C9                  ret     
2375   0993             ;------------------------------------------------------------------------------
2376   0993             
2377   0993             
2378   0993             
2379   0993             ;------------------------------------------------------------------------------
2380   0993             ; Display the player 1 prompt.
2381   0993             ; This is only done in two player games.
2382   0993             L_P1_PROMPT_SCREEN:  
2383   0993             		; Set the palette to 00
2384   0993 AF          		xor     a
2385   0994 32 86 7D            ld      (PALETTE_1_OUTPUT),a
2386   0997 32 87 7D            ld      (PALETTE_2_OUTPUT),a
2387   099A                     
2388   099A                     ; Display "PLAYER (I)"
2389   099A 11 02 03            ld      de,$0302
2390   099D CD 36 31            call    L_ADD_EVENT
2391   09A0                     
2392   09A0                     ; Display player 2's score?
2393   09A0 11 01 02            ld      de,$0201
2394   09A3 CD 36 31            call    L_ADD_EVENT
2395   09A6                     
2396   09A6                     ; Advance to substate 5
2397   09A6 3E 05               ld      a,5
2398   09A8 32 0A 60            ld      (GAME_SUBSTATE),a
2399   09AB             		
2400   09AB             L_DISPLAY_2UP:  
2401   09AB             		; Display "2UP"
2402   09AB 3E 02       		ld      a,$02						; '2'
2403   09AD 32 E0 74            ld      (TILE_COORD(7,0)),a
2404   09B0 3E 25               ld      a,$25						; 'U'
2405   09B2 32 C0 74            ld      (TILE_COORD(6,0)),a
2406   09B5 3E 20               ld      a,$20						; 'P'
2407   09B7 32 A0 74            ld      (TILE_COORD(5,0)),a
2408   09BA C9                  ret     
2409   09BB             ;------------------------------------------------------------------------------
2410   09BB             
2411   09BB             
2412   09BB             
2413   09BB             ;------------------------------------------------------------------------------
2414   09BB             ; Initialize player 2 and cause the player 2 prompt to be shown 
2415   09BB             L_INIT_P2:  
2416   09BB             		; Copy player 2 data to the current player data
2417   09BB 21 48 60    		ld      hl,P2_NUMBER_LIVES
2418   09BE 11 28 62            ld      de,CP_NUMBER_LIVES
2419   09C1 01 08 00            ld      bc,8
2420   09C4 ED B0               ldir    
2421   09C6                    
2422   09C6                     ; Record the current stage		
2423   09C6 2A 2A 62            ld      hl,(CP_STAGE_ORDER_POINTER)
2424   09C9 7E                  ld      a,(hl)
2425   09CA 32 27 62            ld      (CURRENT_STAGE),a
2426   09CD                     
2427   09CD                     ; Set the minor timer to 120 and substate to 4 to display the player 2 prompt
2428   09CD 3E 78               ld      a,120
2429   09CF 32 09 60            ld      (MINOR_TIMER),a
2430   09D2 3E 04               ld      a,GAME_SUBSTATE_PLAY_START_P2
2431   09D4 32 0A 60            ld      (GAME_SUBSTATE),a
2432   09D7 C9                  ret     
2433   09D8             ;------------------------------------------------------------------------------
2434   09D8             
2435   09D8             
2436   09D8             
2437   09D8             ;------------------------------------------------------------------------------
2438   09D8             ; Display the player 2 prompt.
2439   09D8             L_P2_PROMPT_SCREEN:  
2440   09D8             		; Set palette 00
2441   09D8 AF          		xor     a
2442   09D9 32 86 7D            ld      (PALETTE_1_OUTPUT),a
2443   09DC 32 87 7D            ld      (PALETTE_2_OUTPUT),a
2444   09DF                     
2445   09DF                     ; Display "PLAYER (II)"
2446   09DF 11 03 03            ld      de,$0303
2447   09E2 CD 36 31            call    L_ADD_EVENT
2448   09E5                     
2449   09E5                     ; Display player 2 score
2450   09E5 11 01 02            ld      de,$0201
2451   09E8 CD 36 31            call    L_ADD_EVENT
2452   09EB CD AB 09            call    L_DISPLAY_2UP
2453   09EE                     
2454   09EE                     ; Set substate to 5
2455   09EE 3E 05               ld      a,5
2456   09F0 32 0A 60            ld      (GAME_SUBSTATE),a
2457   09F3 C9                  ret     
2458   09F4             ;------------------------------------------------------------------------------
2459   09F4             
2460   09F4             
2461   09F4             
2462   09F4             ;------------------------------------------------------------------------------
2463   09F4             ; Display the high score, player 1 score and lives and level
2464   09F4             L_DISPLAY_TURN_DATA:  
2465   09F4             		; Display "HIGH SCORE"
2466   09F4 11 04 03    		ld      de,$0304
2467   09F7 CD 36 31            call    L_ADD_EVENT
2468   09FA                     
2469   09FA                     ; Display the high score
2470   09FA 11 02 02            ld      de,$0202
2471   09FD CD 36 31            call    L_ADD_EVENT
2472   0A00                     
2473   0A00                     ; Display player 1 score
2474   0A00 11 00 02            ld      de,$0200
2475   0A03 CD 36 31            call    L_ADD_EVENT
2476   0A06                     
2477   0A06                     ; Display lives and level (w/o subtracting a life)
2478   0A06 11 00 06            ld      de,$0600
2479   0A09 CD 36 31            call    L_ADD_EVENT
2480   0A0C                     
2481   0A0C                     ; Advance the substate (to 6)
2482   0A0C 21 0A 60            ld      hl,GAME_SUBSTATE
2483   0A0F 34                  inc     (hl)
2484   0A10             		
2485   0A10             L_DISPLAY_1UP:  
2486   0A10             		; Display "1UP"
2487   0A10 3E 01       		ld      a,$01						; '1'
2488   0A12 32 40 77            ld      (TILE_COORD(26,0)),a
2489   0A15 3E 25               ld      a,$25						; 'U'
2490   0A17 32 20 77            ld      (TILE_COORD(25,0)),a
2491   0A1A 3E 20               ld      a,$20						; 'P'
2492   0A1C 32 00 77            ld      (TILE_COORD(24,0)),a
2493   0A1F C9                  ret     
2494   0A20             ;------------------------------------------------------------------------------
2495   0A20             
2496   0A20             
2497   0A20             
2498   0A20             ;------------------------------------------------------------------------------
2499   0A20             ; Prepare for the next turn by clearing the screen and triggering the stage display
2500   0A20             ; or the intro, if needed.
2501   0A20             L_PREPARE_SCREEN_FOR_TURN:  
2502   0A20 DF          		rst     $18						; Return until the minor timer runs down
2503   0A21                     
2504   0A21 CD 3D 08            call    L_CLEAR_STAGE_SCREEN
2505   0A24                     
2506   0A24                     ; Set the minor timer to 1
2507   0A24 21 09 60            ld      hl,MINOR_TIMER
2508   0A27 36 01               ld      (hl),1
2509   0A29                     
2510   0A29                     ; Advance the substate
2511   0A29 2C                  inc     l
2512   0A2A 34                  inc     (hl)
2513   0A2B                     
2514   0A2B                     ; If the intro has already been displayed, return
2515   0A2B 11 2C 62            ld      de,CP_INTRO_NOT_DISPLAYED
2516   0A2E 1A                  ld      a,(de)
2517   0A2F A7                  and     a
2518   0A30 C0                  ret     nz
2519   0A31                     
2520   0A31                     ; Intro needs to be displayed, so advance the substate again
2521   0A31 34                  inc     (hl)
2522   0A32 C9                  ret     
2523   0A33             ;------------------------------------------------------------------------------
2524   0A33             
2525   0A33             
2526   0A33             
2527   0A33             ;------------------------------------------------------------------------------
2528   0A33             ; Called when GAME_STATE == 3 (player is playing) and GAME_SUBSTATE == 7
2529   0A33             ;
2530   0A33             ; Display each part of the introduction animation
2531   0A33             L_IMPLEMENT_INTRO_STAGE:  
2532   0A33 3A 85 63    		ld      a,(INTRODUCTION_STATE)
2533   0A36 EF                  rst     $28							; Jump to local table address
2534   0A37             		; Jump table
2535   0A37 47 0A       		.word	L_DISPLAY_INTRODUCTION_STAGE	; 0 = display introduction screen
2536   0A39 7C 0A       		.word	L_DISPLAY_DK_CLIMBING	; 1 = prepare sprites
2537   0A3B A5 0A       		.word	L_IMPLEMENT_DK_CLIMB_ANIM	; 2 = animate climbing sequence
2538   0A3D 00 31       		.word	L_PAUSE_CURRENT_STATE	; 3 = pause
2539   0A3F C3 0A       		.word	L_ANIMATE_DK_JUMP_FROM_LAD	; 4 = animate introduction screen
2540   0A41 00 31       		.word	L_PAUSE_CURRENT_STATE	; 5 = pause
2541   0A43 23 0B       		.word	L_ANIMATE_DK_PLAT_JUMPS	; 6 = animate Donkey Kong jumping
2542   0A45 6D 0B       		.word	L_ANIMATE_DK_GRIN_TAUNT	; 7 = Donkey Kong grins and laughs
2543   0A47             ;------------------------------------------------------------------------------
2544   0A47             
2545   0A47             
2546   0A47             
2547   0A47             ;------------------------------------------------------------------------------
2548   0A47             ; Display the introduction stage (with straight girders before they are warped
2549   0A47             ; by Donkey Kong) and prepare for Donkey Kong's jumps.
2550   0A47             L_DISPLAY_INTRODUCTION_STAGE:  
2551   0A47             		; Set palette 01
2552   0A47 AF          		xor     a
2553   0A48 32 86 7D            ld      (PALETTE_1_OUTPUT),a
2554   0A4B 3C                  inc     a
2555   0A4C 32 87 7D            ld      (PALETTE_2_OUTPUT),a
2556   0A4F                     
2557   0A4F                     ; Display the introduction stage (girder straight before they are warped 
2558   0A4F             		; by Donkey Kong)
2559   0A4F 11 1E 38            ld      de,L_INTRO_STAGE_DATA
2560   0A52 CD AD 0D            call    L_DISPLAY_STAGE
2561   0A55             		
2562   0A55             		; Blank the tiles at the top of Donkey Kong's escape ladders
2563   0A55             		; Otherwise, girders are drawn at the top of each one
2564   0A55 3E 10               ld      a,$10						; Blank tile
2565   0A57 32 A3 76            ld      (TILE_COORD(21,3)),a
2566   0A5A 32 63 76            ld      (TILE_COORD(19,3)),a
2567   0A5D             		
2568   0A5D             		; Draw a girder at the bottom of the ladder to Pauline's platform
2569   0A5D             		; Otherwise, it is just another ladder
2570   0A5D 3E D4               ld      a,$d4
2571   0A5F 32 AA 75            ld      (TILE_COORD(13,10)),a
2572   0A62             		
2573   0A62             		; Clear the climbing counter to 0
2574   0A62 AF                  xor     a
2575   0A63 32 AF 62            ld      (DK_CLIMBING_COUNTER),a
2576   0A66             		
2577   0A66             		; Initialize Donkey Kong's ladder jump vector pointer to the beginning of the 
2578   0A66             		; vector data
2579   0A66 21 C5 38            ld      hl,L_DK_JUMP_FROM_LADDER_DATA
2580   0A69 22 C2 63            ld      (LADDER_JUMP_VECTOR_POINTER),hl
2581   0A6C             		
2582   0A6C             		; Initialize Donkey Kong's platform jump vector pointer to the beginning of the
2583   0A6C             		; vector data
2584   0A6C 21 DC 38            ld      hl,L_DK_JUMP_ACROSS_PLAT_DATA
2585   0A6F 22 C4 63            ld      (PLATFORM_JUMP_VECTOR_POINTER),hl
2586   0A72             		
2587   0A72             		; Set the minor timer to 64
2588   0A72 3E 40               ld      a,64
2589   0A74 32 09 60            ld      (MINOR_TIMER),a
2590   0A77             		
2591   0A77             		; Advance to the next state in the introduction display
2592   0A77 21 85 63            ld      hl,INTRODUCTION_STATE
2593   0A7A 34                  inc     (hl)
2594   0A7B C9                  ret     
2595   0A7C             ;------------------------------------------------------------------------------
2596   0A7C             
2597   0A7C             
2598   0A7C             
2599   0A7C             ;------------------------------------------------------------------------------
2600   0A7C             ; Load and position Donkey Kong's climbing sprites, and begin playing the 
2601   0A7C             ; introduction song.
2602   0A7C             L_DISPLAY_DK_CLIMBING:  
2603   0A7C DF          		rst     $18							; Return if the minor timer has not reached 0
2604   0A7D             
2605   0A7D             		; Load the Donkey Kong climbing sprites and move them into position
2606   0A7D 21 9D 38            ld      hl,L_DK_SPRITES_CLIMBING
2607   0A80 CD 4E 00            call    L_LOAD_DK_SPRITES
2608   0A83 21 08 69            ld      hl,DK_SPRITE_1_X
2609   0A86 0E 30               ld      c,48
2610   0A88 FF                  rst     $38
2611   0A89 21 0B 69            ld      hl,DK_SPRITE_1_Y
2612   0A8C 0E 99               ld      c,-103
2613   0A8E FF                  rst     $38
2614   0A8F             		
2615   0A8F 3E 1F               ld      a,31
2616   0A91 32 8E 63            ld      (LADDER_ROW_TO_ERASE),a
2617   0A94             		
2618   0A94 AF                  xor     a
2619   0A95 32 0C 69            ld      (DK_SPRITE_2_X),a
2620   0A98             		
2621   0A98             		; Trigger the introduction song to play (once)
2622   0A98 21 8A 60            ld      hl,PENDING_SONG_TRIGGER
2623   0A9B 36 01               ld      (hl),SONG_TRIGGER_INTRODUCTION
2624   0A9D 23                  inc     hl							; PENDING_SONG_TRIGGER_REPEAT
2625   0A9E 36 03               ld      (hl),3
2626   0AA0             		
2627   0AA0             		; Advance to the next introduction state
2628   0AA0 21 85 63            ld      hl,INTRODUCTION_STATE
2629   0AA3 34                  inc     (hl)
2630   0AA4 C9                  ret     
2631   0AA5             ;------------------------------------------------------------------------------
2632   0AA5             
2633   0AA5             
2634   0AA5             
2635   0AA5             ;------------------------------------------------------------------------------
2636   0AA5             ; Animate Donkey Kong climbing the ladders on the introduction stage, including 
2637   0AA5             ; pulling the ladders up behind him
2638   0AA5             L_IMPLEMENT_DK_CLIMB_ANIM:  
2639   0AA5             		; Display the next part of the climbing animation
2640   0AA5 CD 06 31    		call    L_ANIMATE_CLIMBING_LADDERS
2641   0AA8             		
2642   0AA8             		; If Donkey Kong has climbed 8 pixels (up an entire tile of the ladder)
2643   0AA8             		; then animate the ladder being pulled up behind him
2644   0AA8 3A AF 62            ld      a,(DK_CLIMBING_COUNTER)
2645   0AAB E6 0F               and     %1111
2646   0AAD CC E1 30            call    z,L_ANIMATE_LADDER_PULL_UP
2647   0AB0                     
2648   0AB0                     ; If Donkey Kong has not reached the top of the ladders, then return
2649   0AB0 3A 0B 69            ld      a,(DK_SPRITE_1_Y)
2650   0AB3 FE 5D               cp      93
2651   0AB5 D0                  ret     nc
2652   0AB6                     
2653   0AB6                     ; Set the minor timer to 32
2654   0AB6 3E 20               ld      a,32
2655   0AB8 32 09 60            ld      (MINOR_TIMER),a
2656   0ABB                     
2657   0ABB                     ; Advance to the next introduction state
2658   0ABB 21 85 63            ld      hl,INTRODUCTION_STATE
2659   0ABE 34                  inc     (hl)
2660   0ABF                     
2661   0ABF                     ; Save INTRODUCTION_STATE as the current state variable
2662   0ABF 22 C0 63            ld      (CURRENT_STATE_VAR_POINTER),hl
2663   0AC2 C9                  ret     
2664   0AC3             ;------------------------------------------------------------------------------
2665   0AC3             
2666   0AC3             
2667   0AC3             
2668   0AC3             ;------------------------------------------------------------------------------
2669   0AC3             ; Animate Donkey Kong's jump from the ladder onto the top platform on the 
2670   0AC3             ; introduction stage
2671   0AC3             L_ANIMATE_DK_JUMP_FROM_LAD:  
2672   0AC3             		; Return until counter 2 reaches 0
2673   0AC3 3A 1A 60    		ld      a,(COUNTER_2)
2674   0AC6 0F                  rrca    
2675   0AC7 D8                  ret     c
2676   0AC8                     
2677   0AC8                     ; Get the next jump vector
2678   0AC8 2A C2 63            ld      hl,(LADDER_JUMP_VECTOR_POINTER)
2679   0ACB 7E                  ld      a,(hl)
2680   0ACC                     
2681   0ACC                     ; If the end of the vector data has been reached, jump ahead
2682   0ACC                     ; to complete the jump
2683   0ACC FE 7F               cp      $7f
2684   0ACE 28 0A               jr      z,l0b1e
2685   0AD0                      
2686   0AD0                     ; Advance the vector pointer
2687   0AD0 23                  inc     hl
2688   0AD1 22 C2 63            ld      (LADDER_JUMP_VECTOR_POINTER),hl
2689   0AD4                     
2690   0AD4                     ; Move Donkey Kong's sprites up by the vector amount
2691   0AD4 4F                  ld      c,a
2692   0AD5 21 0B 69            ld      hl,DK_SPRITE_1_Y
2693   0AD8 FF                  rst     $38
2694   0AD9 C9                  ret     
2695   0ADA                     
2696   0ADA                     ; Complete the jump
2697   0ADA                     ; Load Donkey Kong sprites
2698   0ADA 21 6D 38    l0b1e:  ld      hl,L_DK_SPRITES_L_ARM_RAISED
2699   0ADD CD 4E 00            call    L_LOAD_DK_SPRITES
2700   0AE0                     
2701   0AE0                     ; Load Pauline's sprites
2702   0AE0 11 00 69            ld      de,PAULINE_SPRITES
2703   0AE3 01 08 00            ld      bc,8
2704   0AE6 ED B0               ldir    
2705   0AE8                     
2706   0AE8                     ; Position Donkey Kong
2707   0AE8 21 08 69            ld      hl,DK_SPRITE_1_X
2708   0AEB 0E 50               ld      c,80
2709   0AED FF                  rst     $38
2710   0AEE 21 0B 69            ld      hl,DK_SPRITE_1_Y
2711   0AF1 0E FC               ld      c,-4
2712   0AF3 FF                  rst     $38
2713   0AF4                     
2714   0AF4                     ; Pull up the rest of the ladder
2715   0AF4 CD E1 30    l0b38:  call    L_ANIMATE_LADDER_PULL_UP
2716   0AF7 3A 8E 63            ld      a,(LADDER_ROW_TO_ERASE)
2717   0AFA FE 0A               cp      10
2718   0AFC 20 F6               jr      nz,l0b38
2719   0AFE                     
2720   0AFE                     ; Trigger the stomp sound
2721   0AFE 3E 03               ld      a,3
2722   0B00 32 82 60            ld      (STOMP_SOUND_TRIGGER),a
2723   0B03                     
2724   0B03                     ; Deform the 6th platform
2725   0B03 11 3D 39            ld      de,L_INTRO_DATA_SLOPE6
2726   0B06 CD AD 0D            call    L_DISPLAY_STAGE
2727   0B09 3E 10               ld      a,$10						; Blank tile
2728   0B0B 32 AA 74    		ld      (TILE_COORD(5,10)),a
2729   0B0E 32 8A 74    		ld      (TILE_COORD(4,10)),a
2730   0B11             		
2731   0B11             		; Mark platform 5 as the next to deform when Donkey Kong jumps again
2732   0B11 3E 05               ld      a,5
2733   0B13 32 8D 63            ld      (STAGE_DEFORM_INDEX),a
2734   0B16                     
2735   0B16                     ; Set the minor timer to 32
2736   0B16 3E 20               ld      a,32
2737   0B18 32 09 60            ld      (MINOR_TIMER),a
2738   0B1B                     
2739   0B1B                     ; Advance the current state
2740   0B1B 21 85 63            ld      hl,INTRODUCTION_STATE
2741   0B1E 34                  inc     (hl)
2742   0B1F 22 C0 63            ld      (CURRENT_STATE_VAR_POINTER),hl
2743   0B22 C9                  ret     
2744   0B23             ;------------------------------------------------------------------------------
2745   0B23             
2746   0B23             
2747   0B23             		
2748   0B23             ;------------------------------------------------------------------------------
2749   0B23             ; Animate Donkey Kong's jumps across the top platform and the deformations that
2750   0B23             ; result
2751   0B23             L_ANIMATE_DK_PLAT_JUMPS:  
2752   0B23             		; Return until counter 2 reaches 0
2753   0B23 3A 1A 60    		ld      a,(COUNTER_2)
2754   0B26 0F                  rrca    
2755   0B27 D8                  ret     c
2756   0B28                     
2757   0B28                     ; If the end of the vector data has been reached,
2758   0B28                     ; then advance to the next state 
2759   0B28 2A C4 63            ld      hl,(PLATFORM_JUMP_VECTOR_POINTER)
2760   0B2B 7E                  ld      a,(hl)
2761   0B2C FE 7F               cp      $7f
2762   0B2E 28 10               jr      z,l0b86
2763   0B30                     
2764   0B30                     ; Advance the vector data pointer
2765   0B30 23                  inc     hl
2766   0B31 22 C4 63            ld      (PLATFORM_JUMP_VECTOR_POINTER),hl
2767   0B34                     
2768   0B34                     ; Make Donkey Kong jump
2769   0B34 21 0B 69            ld      hl,DK_SPRITE_1_Y
2770   0B37 4F                  ld      c,a
2771   0B38 FF                  rst     $38						; Move Donkey Kong up or down
2772   0B39 21 08 69            ld      hl,DK_SPRITE_1_X
2773   0B3C 0E FF               ld      c,-1
2774   0B3E FF                  rst     $38						; Move Donkey Kong left
2775   0B3F C9                  ret     
2776   0B40                     
2777   0B40             l0b86:  
2778   0B40             		; Reset the vector data pointer to the start of the vector data
2779   0B40 21 DC 38    		ld      hl,L_DK_JUMP_ACROSS_PLAT_DATA
2780   0B43 22 C4 63            ld      (PLATFORM_JUMP_VECTOR_POINTER),hl
2781   0B46                     
2782   0B46                     ; Trigger the stomp sound
2783   0B46 3E 03               ld      a,3
2784   0B48 32 82 60            ld      (STOMP_SOUND_TRIGGER),a
2785   0B4B                     
2786   0B4B                     ; Convert the stage deform index to an offset
2787   0B4B 21 ED 38            ld      hl,l38dc
2788   0B4E 3A 8D 63            ld      a,(STAGE_DEFORM_INDEX)
2789   0B51 3D                  dec     a
2790   0B52 07                  rlca    
2791   0B53 07                  rlca    
2792   0B54 07                  rlca    
2793   0B55 07                  rlca    
2794   0B56 5F                  ld      e,a
2795   0B57 16 00               ld      d,$00
2796   0B59 19                  add     hl,de
2797   0B5A EB                  ex      de,hl
2798   0B5B                     
2799   0B5B                     ; Display the deformed platform
2800   0B5B CD AD 0D            call    L_DISPLAY_STAGE
2801   0B5E                     
2802   0B5E                     ; Decrement the deform index to the next lower platform
2803   0B5E 21 8D 63            ld      hl,STAGE_DEFORM_INDEX
2804   0B61 35                  dec     (hl)
2805   0B62                     
2806   0B62                     ; Return if the next platform is valid
2807   0B62 C0                  ret     nz
2808   0B63                     
2809   0B63                     ; Set the timer
2810   0B63 3E B0               ld      a,176
2811   0B65 32 09 60            ld      (MINOR_TIMER),a
2812   0B68                     
2813   0B68                     ; Advance to the next (and last) introduction state
2814   0B68 21 85 63            ld      hl,INTRODUCTION_STATE
2815   0B6B 34                  inc     (hl)
2816   0B6C C9                  ret     
2817   0B6D             ;------------------------------------------------------------------------------
2818   0B6D             
2819   0B6D             
2820   0B6D             
2821   0B6D             ;------------------------------------------------------------------------------
2822   0B6D             ; Animate Donkey Kong's grin and laugh taunt at the end of the introduction stage
2823   0B6D             L_ANIMATE_DK_GRIN_TAUNT:  
2824   0B6D             		; If the minor timer has not run down to 144, jump ahead
2825   0B6D 21 8A 60    		ld      hl,PENDING_SONG_TRIGGER
2826   0B70 3A 09 60            ld      a,(MINOR_TIMER)
2827   0B73 FE 90               cp      144
2828   0B75 20 0B               jr      nz,l0bc8
2829   0B77                     
2830   0B77                     ; Trigger the roaring "song"
2831   0B77 36 0F               ld      (hl),SONG_TRIGGER_ROAR
2832   0B79 23                  inc     hl
2833   0B7A 36 03               ld      (hl),3
2834   0B7C                     
2835   0B7C                     ; Show Donkey Kong grinning
2836   0B7C 21 19 69            ld      hl,DK_SPRITE_5_NUM
2837   0B7F 34                  inc     (hl)
2838   0B80 18 08               jr      l0bd1
2839   0B82                     
2840   0B82                     ; If the minor timer has not decremented to 24, skip ahead
2841   0B82 FE 18       l0bc8:  cp      24
2842   0B84 20 04               jr      nz,l0bd1
2843   0B86                     
2844   0B86                     ; Show Donkey Kong not grinning
2845   0B86 21 19 69            ld      hl,DK_SPRITE_5_NUM
2846   0B89 35                  dec     (hl)
2847   0B8A                     
2848   0B8A                     ; Return until the minor timer reaches 0
2849   0B8A DF          l0bd1:  rst     $18
2850   0B8B             
2851   0B8B             		; Reset the introduction state
2852   0B8B AF                  xor     a
2853   0B8C 32 85 63            ld      (INTRODUCTION_STATE),a
2854   0B8F                     
2855   0B8F                     ; Show Donkey Kong grinning
2856   0B8F 34                  inc     (hl)
2857   0B90                     
2858   0B90                     ; Raise Donkey Kong's right arm (to match his left)
2859   0B90 23                  inc     hl
2860   0B91 34                  inc     (hl)
2861   0B92 C9                  ret     
2862   0B93             ;------------------------------------------------------------------------------
2863   0B93             
2864   0B93             
2865   0B93             
2866   0B93             ;------------------------------------------------------------------------------
2867   0B93             ; Display the intermission screen showing the height that the player has reached
2868   0B93             L_DISPLAY_INTERMISSION:  
2869   0B93             		; Turn off sounds and return until the minor timer reaches 0
2870   0B93 CD 0F 01    		call    L_SOUNDS_OFF
2871   0B96 DF                  rst     $18
2872   0B97                     
2873   0B97                     ; Display Mario's lives
2874   0B97 CD 3D 08            call    L_CLEAR_STAGE_SCREEN
2875   0B9A 16 06               ld      d,$06
2876   0B9C 3A 00 62            ld      a,(MARIO_ALIVE)
2877   0B9F 5F                  ld      e,a
2878   0BA0 CD 36 31            call    L_ADD_EVENT
2879   0BA3                     
2880   0BA3                     ; Palette 10
2881   0BA3 21 86 7D            ld      hl,PALETTE_1_OUTPUT
2882   0BA6 36 01               ld      (hl),$01
2883   0BA8 23                  inc     hl
2884   0BA9 36 00               ld      (hl),$00
2885   0BAB                     
2886   0BAB                     ; Trigger the intermission song
2887   0BAB 21 8A 60            ld      hl,PENDING_SONG_TRIGGER
2888   0BAE 36 02               ld      (hl),SONG_TRIGGER_INTERMISSION
2889   0BB0 23                  inc     hl
2890   0BB1 36 03               ld      (hl),3
2891   0BB3                     
2892   0BB3                     ; Initialize the height string index to the first entry in the table
2893   0BB3 21 A7 63            ld      hl,INTERM_HEIGHT_STRING_INDEX
2894   0BB6 36 00               ld      (hl),0
2895   0BB8                     
2896   0BB8                     ; Initialize the height string coord to the bottom of the "stack"
2897   0BB8 21 DC 76            ld      hl,TILE_COORD(22,28)
2898   0BBB 22 A8 63            ld      (INTERM_HEIGHT_STRING_COORD),hl
2899   0BBE                     
2900   0BBE                     ; Limit the height index to 5
2901   0BBE 3A 2E 62            ld      a,(CP_HEIGHT_INDEX)
2902   0BC1 FE 06               cp      6
2903   0BC3 38 05               jr      c,l0c11
2904   0BC5 3E 05               ld      a,5
2905   0BC7 32 2E 62            ld      (CP_HEIGHT_INDEX),a
2906   0BCA                     
2907   0BCA                     ; If the player has not advanced in height 
2908   0BCA                     ; (completed a stage), then jump ahead
2909   0BCA 3A 2F 62    l0c11:  ld      a,(CP_STAGE_ORDER_POINTER_LAG)
2910   0BCD 47                  ld      b,a
2911   0BCE 3A 2A 62            ld      a,(CP_STAGE_ORDER_POINTER)
2912   0BD1 B8                  cp      b
2913   0BD2 28 04               jr      z,l0c1f
2914   0BD4             		
2915   0BD4                     ; Increase the players height by 1 (25 m)
2916   0BD4 21 2E 62            ld      hl,CP_HEIGHT_INDEX
2917   0BD7 34                  inc     (hl)
2918   0BD8                     
2919   0BD8                     ; Update the stage order pointer lag
2920   0BD8 32 2F 62    l0c1f:  ld      (CP_STAGE_ORDER_POINTER_LAG),a
2921   0BDB             
2922   0BDB             		; Get the current player's height
2923   0BDB 3A 2E 62            ld      a,(CP_HEIGHT_INDEX)
2924   0BDE 47                  ld      b,a
2925   0BDF                     
2926   0BDF                     ; Start drawing the intermission gorilla at
2927   0BDF 21 BC 75            ld      hl,TILE_COORD(13,28)
2928   0BE2 0E 50       l0c29:  ld      c,$50
2929   0BE4             
2930   0BE4             		; Draw one column of the gorilla
2931   0BE4 3E 03       l0c29a:	ld		a,3
2932   0BE6 71          l0c2b:  ld      (hl),c
2933   0BE7 0C                  inc     c
2934   0BE8 2B                  dec     hl
2935   0BE9 3D          		dec		a
2936   0BEA 20 FA       		jr		nz,l0c2b
2937   0BEC 71                  ld      (hl),c
2938   0BED                     
2939   0BED                     ; If this is the last of the gorilla tiles, jump ahead
2940   0BED 79                  ld      a,c
2941   0BEE FE 67               cp      $67
2942   0BF0 28 07               jr      z,l0c43
2943   0BF2                     
2944   0BF2                     ; Advance to the bottom of the next column and continue drawing tiles
2945   0BF2 0C                  inc     c
2946   0BF3 11 23 00            ld      de,35
2947   0BF6 19                  add     hl,de
2948   0BF7 18 EB               jr      l0c29a
2949   0BF9                     
2950   0BF9                     ; Convert the currently displayed height index to an offset in the height string table
2951   0BF9 3A A7 63    l0c43:  ld      a,(INTERM_HEIGHT_STRING_INDEX)
2952   0BFC 3C                  inc     a
2953   0BFD 32 A7 63            ld      (INTERM_HEIGHT_STRING_INDEX),a
2954   0C00 3D                  dec     a
2955   0C01 CB 27               sla     a
2956   0C03 CB 27               sla     a
2957   0C05 E5                  push    hl
2958   0C06 21 57 3D            ld      hl,L_HEIGHT_STRING_TABLE
2959   0C09                     
2960   0C09 C5                  push    bc
2961   0C0A DD 2A A8 63         ld      ix,(INTERM_HEIGHT_STRING_COORD)
2962   0C0E                     
2963   0C0E                     ; Convert the height string offset into a table address
2964   0C0E 4F                  ld      c,a
2965   0C0F 06 00               ld      b,0
2966   0C11 09                  add     hl,bc
2967   0C12                     
2968   0C12                     ; Display the height string
2969   0C12 7E                  ld      a,(hl)
2970   0C13 DD 77 60            ld      (ix+96),a
2971   0C16 23                  inc     hl
2972   0C17 7E                  ld      a,(hl)
2973   0C18 DD 77 40            ld      (ix+64),a
2974   0C1B 23                  inc     hl
2975   0C1C 7E                  ld      a,(hl)
2976   0C1D DD 77 20            ld      (ix+32),a
2977   0C20 DD 36 E0 8B         ld      (ix-32),$8b					; 'm'
2978   0C24                     
2979   0C24                     ; Advance to the coord of the next height string to be displayed
2980   0C24 C1                  pop     bc
2981   0C25 DD E5               push    ix
2982   0C27 E1                  pop     hl
2983   0C28 11 FC FF            ld      de,-4
2984   0C2B 19                  add     hl,de
2985   0C2C 22 A8 63            ld      (INTERM_HEIGHT_STRING_COORD),hl
2986   0C2F                     
2987   0C2F                     ; Advance to the coordinate to draw the next gorilla up
2988   0C2F E1                  pop     hl
2989   0C30 11 5F FF            ld      de,-161
2990   0C33 19                  add     hl,de
2991   0C34                     
2992   0C34                     ; If there are more heights to be displayed, jump back up to display them
2993   0C34 05                  dec     b
2994   0C35 20 AB               jr      nz,l0c29
2995   0C37                     
2996   0C37                     ; Display "HOW HIGH CAN YOU GET ? "
2997   0C37 11 07 03            ld      de,$0307
2998   0C3A CD 36 31            call    L_ADD_EVENT
2999   0C3D                     
3000   0C3D                     ; Set the minor timer to 160
3001   0C3D 21 09 60            ld      hl,MINOR_TIMER
3002   0C40 36 A0               ld      (hl),160
3003   0C42                     
3004   0C42                     ; Advance the game substate by two
3005   0C42 23                  inc     hl
3006   0C43 34                  inc     (hl)
3007   0C44 34                  inc     (hl)
3008   0C45 C9                  ret     
3009   0C46             ;------------------------------------------------------------------------------
3010   0C46             
3011   0C46             
3012   0C46             
3013   0C46             ;------------------------------------------------------------------------------
3014   0C46             ; Display the current stage
3015   0C46             L_DISPLAY_CURRENT_STAGE:  
3016   0C46             		; Return until the minor timer has reached 0
3017   0C46 DF          		rst     $18
3018   0C47             L_DISPLAY_CURRENT_STAGE_2:  
3019   0C47 CD 3D 08    		call    L_CLEAR_STAGE_SCREEN
3020   0C4A             
3021   0C4A             		; Display the onscreen timer (forces it to drawn on screen)
3022   0C4A AF                  xor     a
3023   0C4B 32 8C 63            ld      (ONSCREEN_TIMER),a
3024   0C4E 11 01 05            ld      de,$0501
3025   0C51 CD 36 31            call    L_ADD_EVENT
3026   0C54             
3027   0C54             		; Select palette 01
3028   0C54 21 86 7D            ld      hl,PALETTE_1_OUTPUT
3029   0C57 36 00               ld      (hl),0
3030   0C59 23                  inc     hl
3031   0C5A 36 01               ld      (hl),1
3032   0C5C             
3033   0C5C             		; If on the barrels stage, jump ahead to display it
3034   0C5C 3A 27 62            ld      a,(CURRENT_STAGE)
3035   0C5F 3D                  dec     a
3036   0C60 28 25               jr      z,l0cd4
3037   0C62             
3038   0C62             		; If on the mixer stage, jump ahead to display it
3039   0C62 3D                  dec     a
3040   0C63 28 2C               jr      z,l0cdf
3041   0C65             
3042   0C65             		; If on the elevators stage, jump ahead to display it
3043   0C65 3D                  dec     a
3044   0C66 28 3B               jr      z,l0cf2
3045   0C68             		
3046   0C68             		; pallette 11
3047   0C68 21 86 7D    		ld		hl,PALETTE_1_OUTPUT
3048   0C6B 36 01       		ld		(hl),1
3049   0C6D             
3050   0C6D             		; Display the rivets stage
3051   0C6D 3D          		dec		a
3052   0C6E 28 40       		jr		z,ldisplaycurrentstage1
3053   0C70             		
3054   0C70             		; Must be on the secret stage
3055   0C70             		; Draw X's in elevator column
3056   0C70             		; ld		de,13
3057   0C70             		; ld		hl,TILE_COORD(12,13)
3058   0C70             		; ld		c,8
3059   0C70             ; l_display_current_stage_1:
3060   0C70             		; ld		b,19
3061   0C70             ; l_display_current_stage_2:
3062   0C70             		; ld		(hl),$FE
3063   0C70             		; inc		hl
3064   0C70             		; djnz	l_display_current_stage_2
3065   0C70             
3066   0C70             		; add		hl,de
3067   0C70             		; dec		c
3068   0C70             		; jr		nz,l_display_current_stage_1		
3069   0C70             		
3070   0C70             		; Display the secret stage
3071   0C70 CD 20 0D    		call	L_DRAW_SECRET_CAGE
3072   0C73 11 01 3D    		ld		de,L_SECRET_STAGE_DATA
3073   0C76                     
3074   0C76 CD AD 0D    l0cc6:  call    L_DISPLAY_STAGE
3075   0C79             		
3076   0C79             		; If the current stage is the rivets stage
3077   0C79 3A 27 62            ld      a,(CURRENT_STAGE)
3078   0C7C FE 04               cp      4
3079   0C7E CC C2 0C            call    z,L_DISPLAY_RIVETS
3080   0C81                     
3081   0C81                     ; Jump ahead to fully initialize the stage
3082   0C81             ;        jp      L_WEIRD_DISPLAY_STAGE_FN	; Exceeds relative branch
3083   0C81 CD C0 3F       		call	L_DISPLAY_MIXER_LADDERS
3084   0C84 C3 38 0D    		jp		L_COMPLETE_STAGE_INIT		; Exceeds relative branch
3085   0C87             
3086   0C87                     ; Display the barrels stage 
3087   0C87 11 F5 3A    l0cd4:  ld      de,L_BARRELS_STAGE_DATA
3088   0C8A 3E 08               ld      a,SONG_TRIGGER_BG_BARRELS
3089   0C8C 32 89 60            ld      (SONG_TRIGGER),a
3090   0C8F 18 E5               jr      l0cc6
3091   0C91                     
3092   0C91                     ; Display the mixer stage
3093   0C91 11 6E 3B    l0cdf:  ld      de,L_MIXER_STAGE_DATA
3094   0C94 21 86 7D            ld      hl,PALETTE_1_OUTPUT
3095   0C97 36 01               ld      (hl),1
3096   0C99 23                  inc     hl
3097   0C9A 36 00               ld      (hl),0
3098   0C9C 3E 09               ld      a,SONG_TRIGGER_BG_MIXER
3099   0C9E 32 89 60            ld      (SONG_TRIGGER),a
3100   0CA1 18 D3               jr      l0cc6
3101   0CA3                     
3102   0CA3                     ; Display the elevators stage
3103   0CA3 CD E8 0C    l0cf2:  call    L_DRAW_ELEVATOR_SUPPORTS
3104   0CA6 3E 0A               ld      a,SONG_TRIGGER_BG_ELEVATORS
3105   0CA8 32 89 60            ld      (SONG_TRIGGER),a
3106   0CAB 11 F6 3B            ld      de,L_ELEVATORS_STAGE_DATA
3107   0CAE 18 C6               jr      l0cc6
3108   0CB0             		
3109   0CB0             ldisplaycurrentstage1:
3110   0CB0 CD 04 0D    		call    L_DRAW_PAULINE_PLAT_POSTS
3111   0CB3             
3112   0CB3             		; Palette 11
3113   0CB3 21 86 7D    		ld      hl,PALETTE_1_OUTPUT
3114   0CB6 36 01               ld      (hl),1
3115   0CB8             
3116   0CB8 3E 0B               ld      a,SONG_TRIGGER_BG_RIVETS
3117   0CBA 32 89 60            ld      (SONG_TRIGGER),a
3118   0CBD                     
3119   0CBD                     ; Display the rivets stage
3120   0CBD 11 9C 3C            ld      de,L_RIVETS_STAGE_DATA
3121   0CC0 18 B4               jr      l0cc6
3122   0CC2             ;------------------------------------------------------------------------------
3123   0CC2             
3124   0CC2             
3125   0CC2             
3126   0CC2             ;------------------------------------------------------------------------------
3127   0CC2             ; Display the rivets on the rivets level
3128   0CC2             L_DISPLAY_RIVETS:  
3129   0CC2 06 08       		ld      b,8							; For b = 8 to 1
3130   0CC4 21 D8 0C            ld      hl,L_RIVET_COORD_DATA					; hl = address of rivet coordinates
3131   0CC7 3E B8       l0d05:  ld      a,$b8						; a = rivet tile
3132   0CC9 0E 02               ld      c,2							; For c = 2 to 1
3133   0CCB 5E                  ld      e,(hl)						; de = coordinate from table
3134   0CCC 23                  inc     hl
3135   0CCD 56                  ld      d,(hl)
3136   0CCE 23                  inc     hl							; hl = next table entry
3137   0CCF 12          l0d0d:  ld      (de),a						; display the rivet tile at the coordinate in de
3138   0CD0 3D                  dec     a							; --a
3139   0CD1 13                  inc     de							; de = next row down
3140   0CD2 0D                  dec     c							
3141   0CD3 20 FA               jr      nz,l0d0d					; Next c
3142   0CD5 10 F0               djnz    l0d05						; Next b
3143   0CD7 C9                  ret     
3144   0CD8             ;------------------------------------------------------------------------------
3145   0CD8             
3146   0CD8             
3147   0CD8             
3148   0CD8             ;------------------------------------------------------------------------------
3149   0CD8             ; Coordinates of rivets
3150   0CD8             L_RIVET_COORD_DATA:	
3151   0CD8 CA 76       		.word	TILE_COORD(22,10)
3152   0CDA CF 76       		.word	TILE_COORD(22,15)
3153   0CDC D4 76       		.word	TILE_COORD(22,20)
3154   0CDE D9 76       		.word	TILE_COORD(22,25)
3155   0CE0 2A 75       		.word	TILE_COORD(9,10)
3156   0CE2 2F 75       		.word	TILE_COORD(9,15)
3157   0CE4 34 75       		.word	TILE_COORD(9,20)
3158   0CE6 39 75       		.word	TILE_COORD(9,25)
3159   0CE8             ;------------------------------------------------------------------------------
3160   0CE8             
3161   0CE8             
3162   0CE8             
3163   0CE8             ;------------------------------------------------------------------------------
3164   0CE8             ; Draw the elevator supports on the elevators stage
3165   0CE8             L_DRAW_ELEVATOR_SUPPORTS:  
3166   0CE8 21 0D 77    		ld      hl,TILE_COORD(24,13)
3167   0CEB CD F1 0C            call    l0d30
3168   0CEE             		
3169   0CEE             		; Draw the right side of the elevator support
3170   0CEE 21 0D 76            ld      hl,TILE_COORD(16,13)
3171   0CF1 06 11       l0d30:  ld      b,17						; For b = 17 to 1 (17 tiles high)
3172   0CF3 36 FD       l0d32:  ld      (hl),$fd					
3173   0CF5 23                  inc     hl
3174   0CF6 10 FB               djnz    l0d32						; Next b
3175   0CF8             		
3176   0CF8             		; Draw the left side of the elevator support
3177   0CF8 11 0F 00            ld      de,15						; Enough to move back to the top of the left side
3178   0CFB 19                  add     hl,de
3179   0CFC 06 11               ld      b,17						; For b = 17 to 1 (17 tiles high)
3180   0CFE 36 FC       l0d3d:  ld      (hl),$fc
3181   0D00 23                  inc     hl
3182   0D01 10 FB               djnz    l0d3d						; Next b
3183   0D03 C9                  ret     
3184   0D04             ;------------------------------------------------------------------------------
3185   0D04             
3186   0D04             
3187   0D04             
3188   0D04             ;------------------------------------------------------------------------------
3189   0D04             ; Draw the posts that support Pauline's platform on the rivets stage
3190   0D04             L_DRAW_PAULINE_PLAT_POSTS:  
3191   0D04             		; Draw the post at (20,7)-(21,10)
3192   0D04 21 87 76    		ld      hl,TILE_COORD(20,7)
3193   0D07 CD 0D 0D            call    l0d4c
3194   0D0A             
3195   0D0A             		; Draw the post at (10,7)-(11,10)
3196   0D0A 21 47 75            ld      hl,TILE_COORD(10,7)
3197   0D0D             
3198   0D0D             		; Draw the right half of the post supporting Pauline's platform on the rivets stage
3199   0D0D 06 04       l0d4c:  ld      b,4						; For b = 4 to 1
3200   0D0F 36 FD       l0d4e:  ld      (hl),$fd
3201   0D11 23                  inc     hl
3202   0D12 10 FB               djnz    l0d4e						; Next b
3203   0D14             
3204   0D14             		; Draw the left half of the post
3205   0D14 11 1C 00            ld      de,28						; Move 1 column left
3206   0D17 19                  add     hl,de
3207   0D18 06 04               ld      b,4							; For b = 4 to 1
3208   0D1A 36 FC       l0d59:  ld      (hl),$fc
3209   0D1C 23                  inc     hl
3210   0D1D 10 FB               djnz    l0d59						; Next b
3211   0D1F C9                  ret     
3212   0D20             ;------------------------------------------------------------------------------
3213   0D20             
3214   0D20             
3215   0D20             
3216   0D20             ;------------------------------------------------------------------------------
3217   0D20             ; Draw the cage that holds Pauline on the secret stage
3218   0D20             L_DRAW_SECRET_CAGE:  
3219   0D20             		; Draw the 4 bars starting at (10,26)-(6,30)
3220   0D20 21 5A 75    		ld      hl,TILE_COORD(10,26)
3221   0D23 0E 03       		ld		c,3
3222   0D25 11 DB FF    		ld		de,-37
3223   0D28 3E 7D       		ld		a,$7d						; Bar tile
3224   0D2A             lsecret0d4b:
3225   0D2A CD 31 0D    		call	lsecret0d4c
3226   0D2D 19          		add		hl,de
3227   0D2E 0D          		dec		c
3228   0D2F 20 F9       		jr		nz,lsecret0d4b
3229   0D31             		
3230   0D31             lsecret0d4c:
3231   0D31 06 05       		ld      b,5							; For b = 5 to 1 (each bar is 5 sprites high)
3232   0D33             
3233   0D33             lsecret0d4e:
3234   0D33 77          		ld      (hl),a
3235   0D34 23          		inc     hl
3236   0D35 10 FC       		djnz    lsecret0d4e					; Next b
3237   0D37             
3238   0D37 C9                  ret     
3239   0D38             ;------------------------------------------------------------------------------
3240   0D38             
3241   0D38             
3242   0D38             
3243   0D38             ;------------------------------------------------------------------------------
3244   0D38             ; Complete the initialization of the current stage
3245   0D38             ; Initializes the ladder data and positions Donkey Kong and Pauline for the stage
3246   0D38             L_COMPLETE_STAGE_INIT:  
3247   0D38 CD 44 0F    		call    L_INIT_CURRENT_STAGE
3248   0D3B CD 1B 25            call    L_PARSE_STAGE_LADDER_DATA
3249   0D3E                     
3250   0D3E                     ; Initialize the minor timer to 64
3251   0D3E 21 09 60            ld      hl,MINOR_TIMER
3252   0D41 36 40               ld      (hl),64
3253   0D43                     
3254   0D43                     ; Advance the submode
3255   0D43 23                  inc     hl
3256   0D44 34                  inc     (hl)
3257   0D45             		
3258   0D45             		; If the current stage is the secret stage,
3259   0D45             		; jump ahead to skip loading Donkey Kong
3260   0D45 3A 27 62    		ld		a,(CURRENT_STAGE)
3261   0D48 FE 05       		cp		5
3262   0D4A 28 3A       		jr		z,lpaulinesecret
3263   0D4C             		
3264   0D4C                     ; Load the Donkey Kong and Pauline sprites
3265   0D4C 21 6D 38            ld      hl,L_DK_SPRITES_L_ARM_RAISED
3266   0D4F CD 4E 00            call    L_LOAD_DK_SPRITES
3267   0D52 11 00 69            ld      de,PAULINE_UPPER_SPRITE_X
3268   0D55 01 08 00            ld      bc,8
3269   0D58 ED B0               ldir    
3270   0D5A                     
3271   0D5A                     ; If the current stage is the rivets stage, jump ahead
3272   0D5A 3A 27 62            ld      a,(CURRENT_STAGE)
3273   0D5D FE 04               cp      4
3274   0D5F 28 0C               jr      z,l0d8b
3275   0D61             		
3276   0D61             		; If the current stage is the secret stage, jump ahead
3277   0D61 30 23       		jr		nc,lpaulinesecret
3278   0D63                     
3279   0D63                     ; Return if the stage is the mixer or elevators
3280   0D63 0F                  rrca    
3281   0D64 0F                  rrca    
3282   0D65 D8                  ret     c
3283   0D66                     
3284   0D66                     ; Move Donkey Kong in place for the barrels stage
3285   0D66 21 0B 69            ld      hl,DK_SPRITE_1_Y
3286   0D69 0E FC               ld      c,-4
3287   0D6B FF                  rst     $38
3288   0D6C C9                  ret     
3289   0D6D                     
3290   0D6D                     ; Move Donkey Kong into position for the rivets stage
3291   0D6D 21 08 69    l0d8b:  ld      hl,DK_SPRITE_1_X
3292   0D70 0E 44               ld      c,68
3293   0D72 FF                  rst     $38
3294   0D73                     
3295   0D73                     ; Move Pauline into place for the rivets stage
3296   0D73             ;        ld      de,4						; 4 bytes per sprite structure
3297   0D73 01 10 02            ld      bc,TWO_BYTES(2,16)			; 2 sprites to copy, move by 16 pixels
3298   0D76 21 00 69            ld      hl,PAULINE_UPPER_SPRITE_X
3299   0D79 CD 3A 00            call    L_MOVE_N_SPRITES
3300   0D7C 01 F8 02            ld      bc,TWO_BYTES(2,$f8)			; 2 sprites to copy, move -8 pixels 
3301   0D7F 21 03 69            ld      hl,PAULINE_UPPER_SPRITE_Y
3302   0D82 CD 3A 00            call    L_MOVE_N_SPRITES
3303   0D85 C9                  ret     
3304   0D86             		
3305   0D86             lpaulinesecret:
3306   0D86 21 95 38            ld      hl,L_PAULINE_SPRITES_FACE_RIGHT
3307   0D89 11 00 69            ld      de,PAULINE_UPPER_SPRITE_X
3308   0D8C 01 08 00            ld      bc,8
3309   0D8F ED B0               ldir    
3310   0D91             
3311   0D91 3E 90       		ld      a,90h
3312   0D93 32 01 69    		ld      (PAULINE_UPPER_SPRITE_NUM),a
3313   0D96 3C          		inc		a
3314   0D97 32 05 69    		ld      (PAULINE_LOWER_SPRITE_NUM),a
3315   0D9A             		
3316   0D9A             ;		ld		de,4						; 4 bytes per sprite 
3317   0D9A 01 78 02    		ld		bc,TWO_BYTES(2,120)			; 2 sprites to copy, move ??? pixels
3318   0D9D 21 00 69    		ld		hl,PAULINE_UPPER_SPRITE_X
3319   0DA0 CD 3A 00    		call	L_MOVE_N_SPRITES
3320   0DA3 01 C0 02    		ld		bc,TWO_BYTES(2,192)		; 2 sprites to copy, move ??? pixels
3321   0DA6 21 03 69    		ld		hl,PAULINE_UPPER_SPRITE_Y
3322   0DA9 CD 3A 00    		call	L_MOVE_N_SPRITES
3323   0DAC C9          		ret
3324   0DAD             ;------------------------------------------------------------------------------
3325   0DAD             
3326   0DAD             
3327   0DAD             
3328   0DAD             ;------------------------------------------------------------------------------
3329   0DAD             ; Display the game screen for the current stage
3330   0DAD             ;
3331   0DAD             ; The screen data is read in starting at the memory location in de and ending when
3332   0DAD             ; $aa is read in.
3333   0DAD             ;
3334   0DAD             ; The stage data consists of 5 byte entries.  Each entry causes a line of tiles 
3335   0DAD             ; to be drawn on the screen between two coordinates.
3336   0DAD             ;
3337   0DAD             ;	byte 0 = Identifies the type of line to display
3338   0DAD             ;		 0 = ladder (vertical)
3339   0DAD             ;		 1 = broken ladder (vertical)
3340   0DAD             ;		 2 = girders in the barrel's stage
3341   0DAD             ;        3 = Girders with square holes
3342   0DAD             ;        4 = Blank tiles
3343   0DAD             ;        5 = Girders with circular holes
3344   0DAD             ;        6 = X's (tile number $FE)
3345   0DAD             ;		$aa = marks the end of the screen data
3346   0DAD             ;
3347   0DAD             ;	byte 1 = x1 coord
3348   0DAD             ;		5 msbs = the tile x coord
3349   0DAD             ;		3 lsbs = unknown
3350   0DAD             ;		(with the 3 lsbs masked out, this is actually the pixel x coord of the upper left corner of the tile)
3351   0DAD             ;
3352   0DAD             ;	byte 2 = y1 coord
3353   0DAD             ;		5 msbs = the tile y coord
3354   0DAD             ;		3 lsbs = the tile offset (0-7) of the first tile (barrel girders and ladders only)
3355   0DAD             ;		(with the 3 lsbs masked out, this is actually the pixel y coord of the upper left corner of the tile)
3356   0DAD             
3357   0DAD             ;	byte 3 = x2 coord
3358   0DAD             ;		5 msbs = the tile x coord
3359   0DAD             ;		3 lsbs = unknown
3360   0DAD             ;		(with the 3 lsbs masked out, this is actually the pixel x coord of the upper left corner of the tile)
3361   0DAD             ;
3362   0DAD             ;	byte 4 = y2 coord
3363   0DAD             ;		5 msbs = the tile y coord
3364   0DAD             ;		3 lsbs = the tile offset (0-7) of the last tile (barrel girders and ladders only)
3365   0DAD             ;		(with the 3 lsbs masked out, this is actually the pixel y coord of the upper left corner of the tile)
3366   0DAD             ;
3367   0DAD             ; passed:	de - starting ROM address for screen data
3368   0DAD             L_DISPLAY_STAGE:  
3369   0DAD             		; Read in the next tile ID
3370   0DAD 1A          		ld      a,(de)
3371   0DAE 32 B3 63            ld      (STAGE_DATA_TILE_ID),a
3372   0DB1             
3373   0DB1             		; Return if an $aa was found
3374   0DB1 FE AA               cp      $aa
3375   0DB3 C8                  ret     z
3376   0DB4             
3377   0DB4             		; Read in the first stage location
3378   0DB4 13                  inc     de
3379   0DB5 1A                  ld      a,(de)
3380   0DB6 67                  ld      h,a
3381   0DB7 44                  ld      b,h						; b = x coord
3382   0DB8 13                  inc     de
3383   0DB9 1A                  ld      a,(de)
3384   0DBA 6F                  ld      l,a
3385   0DBB 4D                  ld      c,l						; c = y coord
3386   0DBC             
3387   0DBC             		; Convert the location data in hl to a tile memory address
3388   0DBC D5                  push    de
3389   0DBD CD 8E 30            call    L_STAGE_LOC_TO_ADDRESS
3390   0DC0 D1                  pop     de
3391   0DC1 22 AB 63            ld      (STAGE_DATA_START_ADDRESS),hl
3392   0DC4             
3393   0DC4             		; Isolate and save ??? (no idea what this is used for)
3394   0DC4 78                  ld      a,b
3395   0DC5 E6 07               and     %00000111
3396   0DC7 32 B4 63            ld      (STAGE_DATA_UNKNOWN),a
3397   0DCA             
3398   0DCA             		; Isolate and save the y offset of the first tile
3399   0DCA 79                  ld      a,c
3400   0DCB E6 07               and     %00000111
3401   0DCD 32 AF 63            ld      (STAGE_DATA_FIRST_Y_OFFSET),a
3402   0DD0             
3403   0DD0             		; Read in the ending x location
3404   0DD0 13                  inc     de
3405   0DD1 1A                  ld      a,(de)
3406   0DD2 67                  ld      h,a
3407   0DD3                     
3408   0DD3                     ; Calculate the x difference between the start and end x coordinates
3409   0DD3 90                  sub     b
3410   0DD4 30 02               jr      nc,l0dd3
3411   0DD6 ED 44               neg    
3412   0DD8 32 B1 63    l0dd3:  ld      (STAGE_DATA_X_DIFF),a
3413   0DDB             
3414   0DDB             		; Read the ending y location
3415   0DDB 13                  inc     de
3416   0DDC 1A                  ld      a,(de)
3417   0DDD 6F                  ld      l,a
3418   0DDE                     
3419   0DDE                     ; Calculate the y difference
3420   0DDE 91                  sub     c
3421   0DDF 32 B2 63            ld      (STAGE_DATA_Y_DIFF),a
3422   0DE2                     
3423   0DE2                     ; Determine the bottom y offset?
3424   0DE2 1A                  ld      a,(de)
3425   0DE3 E6 07               and     %00000111
3426   0DE5 32 B0 63            ld      (STAGE_DATA_LAST_Y_OFFSET),a
3427   0DE8                     
3428   0DE8                     ; Convert the ending location to a tile memory address
3429   0DE8 D5                  push    de
3430   0DE9 CD 8E 30            call    L_STAGE_LOC_TO_ADDRESS
3431   0DEC D1                  pop     de
3432   0DED 22 AD 63            ld      (STAGE_DATA_END_ADDRESS),hl
3433   0DF0             
3434   0DF0             		; If ladders are not being drawn, jump ahead
3435   0DF0 3A B3 63            ld      a,(STAGE_DATA_TILE_ID)
3436   0DF3 FE 02               cp      2
3437   0DF5 F2 4F 0E            jp      p,l0e4f
3438   0DF8             
3439   0DF8             		; Subtract the two tiles that are being drawn
3440   0DF8             		; (the girder and the ladder below it)
3441   0DF8 3A B2 63            ld      a,(STAGE_DATA_Y_DIFF)
3442   0DFB D6 10               sub     16						; = 2 tiles
3443   0DFD 47                  ld      b,a
3444   0DFE 3A AF 63            ld      a,(STAGE_DATA_FIRST_Y_OFFSET)
3445   0E01 80                  add     a,b
3446   0E02 32 B2 63            ld      (STAGE_DATA_Y_DIFF),a
3447   0E05                     
3448   0E05                     ; Display the correctly offset girder tile at this location
3449   0E05 3A AF 63            ld      a,(STAGE_DATA_FIRST_Y_OFFSET)
3450   0E08 C6 F0               add     a,-16
3451   0E0A 2A AB 63            ld      hl,(STAGE_DATA_START_ADDRESS)
3452   0E0D 77                  ld      (hl),a
3453   0E0E                     
3454   0E0E                     ; Display the correctly offset top of ladder tile on the next row down
3455   0E0E 2C                  inc     l							; ++y
3456   0E0F D6 30               sub     48
3457   0E11 77                  ld      (hl),a
3458   0E12                     
3459   0E12                     ; If this is not a broken ladder, skip ahead
3460   0E12 3A B3 63            ld      a,(STAGE_DATA_TILE_ID)
3461   0E15 FE 01               cp      1
3462   0E17 20 04               jr      nz,l0e19
3463   0E19                     
3464   0E19                     ; If this is a broken ladder, then force the rest of the ladder to be skipped
3465   0E19 AF                  xor     a
3466   0E1A 32 B2 63            ld      (STAGE_DATA_Y_DIFF),a
3467   0E1D                     
3468   0E1D                     ; Subtract the next tile that is being drawn
3469   0E1D 3A B2 63    l0e19:  ld      a,(STAGE_DATA_Y_DIFF)
3470   0E20 D6 08               sub     8							; = 1 tile
3471   0E22 32 B2 63            ld      (STAGE_DATA_Y_DIFF),a
3472   0E25                     
3473   0E25                     ; If this is the bottom of the ladder, jump ahead to draw the bottom of the ladder
3474   0E25 38 05               jr      c,l0e2a
3475   0E27                     
3476   0E27                     ; Draw a ladder tile on the next row
3477   0E27 2C                  inc     l
3478   0E28 36 C0               ld      (hl),$c0
3479   0E2A                     
3480   0E2A                     ; Continue drawing the ladder
3481   0E2A 18 F1               jr      l0e19
3482   0E2C                     
3483   0E2C                     ; Determine the correct bottom ladder tile 
3484   0E2C 3A B0 63    l0e2a:  ld      a,(STAGE_DATA_LAST_Y_OFFSET)
3485   0E2F C6 D0               add     a,$d0
3486   0E31                     
3487   0E31                     ; Draw the bottom tile at the ending screen memory address
3488   0E31 2A AD 63            ld      hl,(STAGE_DATA_END_ADDRESS)
3489   0E34 77                  ld      (hl),a
3490   0E35                     
3491   0E35                     ; If not drawing a broken ladder, jump ahead
3492   0E35 3A B3 63            ld      a,(STAGE_DATA_TILE_ID)
3493   0E38 FE 01               cp      1
3494   0E3A 20 04               jr      nz,l0e3f
3495   0E3C                     
3496   0E3C                     ; If drawing a broken ladder, draw one extra ladder tile
3497   0E3C                     ; just above the bottom
3498   0E3C 2D                  dec     l							; --y
3499   0E3D 36 C0               ld      (hl),$c0
3500   0E3F 2C                  inc     l							; ++y
3501   0E40                     
3502   0E40                     ; If the bottom tile is not offset, jump ahead
3503   0E40 3A B0 63    l0e3f:  ld      a,(STAGE_DATA_LAST_Y_OFFSET)
3504   0E43 FE 00               cp      $00
3505   0E45 28 04               jr      z,l0e4b
3506   0E47                     
3507   0E47                     ; Draw the rest of the lower girder on the next row
3508   0E47 C6 E0               add     a,$e0
3509   0E49 2C                  inc     l
3510   0E4A 77                  ld      (hl),a
3511   0E4B                     
3512   0E4B                     ; Move on to the next group of stage data
3513   0E4B 13          l0e4b:  inc     de
3514   0E4C C3 AD 0D            jp      L_DISPLAY_STAGE				; Exceeds relative branch
3515   0E4F                     
3516   0E4F                     ; If barrel stage girders are not being drawn, jump ahead 
3517   0E4F 3A B3 63    l0e4f:  ld      a,(STAGE_DATA_TILE_ID)
3518   0E52 FE 02               cp      2
3519   0E54 C2 DE 0E            jp      nz,l0ee8					; Exceeds relative branch
3520   0E57                     
3521   0E57                     ; Determine the first tile to draw based on the tile offset
3522   0E57 3A AF 63            ld      a,(STAGE_DATA_FIRST_Y_OFFSET)
3523   0E5A C6 F0               add     a,$f0
3524   0E5C 32 B5 63            ld      (STAGE_DATA_CURRENT_TILE),a
3525   0E5F                     
3526   0E5F                     ; Get the first screen memory location to draw the tile to
3527   0E5F 2A AB 63            ld      hl,(STAGE_DATA_START_ADDRESS)
3528   0E62                     
3529   0E62                     ; Draw the tile at the current screen address
3530   0E62 3A B5 63    l0e62:  ld      a,(STAGE_DATA_CURRENT_TILE)
3531   0E65 77                  ld      (hl),a
3532   0E66                     
3533   0E66                     ; If this is the bottom of the screen, jump ahead
3534   0E66 23                  inc     hl
3535   0E67 7D                  ld      a,l
3536   0E68 E6 1F               and     %00011111
3537   0E6A 28 0A               jr      z,l0e78
3538   0E6C                     
3539   0E6C                     ; If the the girder tile was not offset, jump ahead
3540   0E6C 3A B5 63            ld      a,(STAGE_DATA_CURRENT_TILE)
3541   0E6F FE F0               cp      $f0
3542   0E71 28 03               jr      z,l0e78
3543   0E73                     
3544   0E73                     ; Draw the tile to complete the girder
3545   0E73 D6 10               sub     $10
3546   0E75 77                  ld      (hl),a
3547   0E76                     
3548   0E76                     ; Advance to the next column
3549   0E76 01 1F 00    l0e78:  ld      bc,31
3550   0E79 09                  add     hl,bc
3551   0E7A                     
3552   0E7A                     ; If the end of the line has been reached, jump ahead to operate on the next stage data group
3553   0E7A 3A B1 63            ld      a,(STAGE_DATA_X_DIFF)
3554   0E7D D6 08               sub     8							; = 1 tile
3555   0E7F 38 45               jr      c,l0ecf
3556   0E81                     
3557   0E81                     ; If the line is horizontal, jump back up to continue drawing tiles
3558   0E81 32 B1 63            ld      (STAGE_DATA_X_DIFF),a
3559   0E84 3A B2 63            ld      a,(STAGE_DATA_Y_DIFF)
3560   0E87 FE 00               cp      0
3561   0E89 28 D7               jr      z,l0e62
3562   0E8B                     
3563   0E8B                     ; Display the tile at the current screen address
3564   0E8B 3A B5 63            ld      a,(STAGE_DATA_CURRENT_TILE)
3565   0E8E 77                  ld      (hl),a
3566   0E8F                     
3567   0E8F                     ; If this is the bottom of the screen, jump ahead
3568   0E8F 23                  inc     hl
3569   0E90 7D                  ld      a,l
3570   0E91 E6 1F               and     %00011111
3571   0E93 28 06               jr      z,l0ea0
3572   0E95                     
3573   0E95                     ; Draw the tile to complete the girder
3574   0E95 3A B5 63            ld      a,(STAGE_DATA_CURRENT_TILE)
3575   0E98 D6 10               sub     16
3576   0E9A 77                  ld      (hl),a
3577   0E9B                     
3578   0E9B                     ; Advance to the next column right
3579   0E9B 01 1F 00    l0ea0:  ld      bc,$001f
3580   0E9E 09                  add     hl,bc
3581   0E9F                     
3582   0E9F                     ; If the end of the line has been reached, jump ahead to operate on the next stage data group
3583   0E9F 3A B1 63            ld      a,(STAGE_DATA_X_DIFF)
3584   0EA2 D6 08               sub     8							; = 1 tile
3585   0EA4 38 20               jr      c,l0ecf
3586   0EA6                     
3587   0EA6                     ; If the line is sloping up, jump ahead
3588   0EA6 32 B1 63            ld      (STAGE_DATA_X_DIFF),a
3589   0EA9 3A B2 63            ld      a,(STAGE_DATA_Y_DIFF)
3590   0EAC CB 7F               bit     7,a
3591   0EAE 20 1A               jr      nz,l0ed3
3592   0EB0                     
3593   0EB0                     ; Handle lines sloping down
3594   0EB0                     
3595   0EB0                     ; Change the tile to the next offset down
3596   0EB0 3A B5 63            ld      a,(STAGE_DATA_CURRENT_TILE)
3597   0EB3 3C                  inc     a
3598   0EB4 32 B5 63            ld      (STAGE_DATA_CURRENT_TILE),a
3599   0EB7                     
3600   0EB7                     ; If it's not time to advance to the next row down, jump ahead
3601   0EB7 FE F8               cp      $f8
3602   0EB9 20 06               jr      nz,l0ec9
3603   0EBB                     
3604   0EBB                     ; Advance to the next row down and reset the tile to the first full girder
3605   0EBB 23                  inc     hl
3606   0EBC 3E F0               ld      a,$f0
3607   0EBE 32 B5 63            ld      (STAGE_DATA_CURRENT_TILE),a
3608   0EC1                     
3609   0EC1                     ; If this is not the bottom of the screen, jump back to continue drawing the line
3610   0EC1 7D          l0ec9:  ld      a,l
3611   0EC2 E6 1F               and     %00011111
3612   0EC4 20 9C               jr      nz,l0e62
3613   0EC6                     
3614   0EC6                     ; Move on to the next group of stage data
3615   0EC6 13          l0ecf:  inc     de
3616   0EC7 C3 AD 0D            jp      L_DISPLAY_STAGE				; Exceeds relative branch
3617   0ECA                     
3618   0ECA             		; Handle lines sloping up
3619   0ECA             		
3620   0ECA             		; Change the tile to the next offset up
3621   0ECA 3A B5 63    l0ed3:  ld      a,(STAGE_DATA_CURRENT_TILE)
3622   0ECD 3D                  dec     a
3623   0ECE 32 B5 63            ld      (STAGE_DATA_CURRENT_TILE),a
3624   0ED1                     
3625   0ED1                     ; If it's not time to advance to the next row up, jump ahead
3626   0ED1 FE F0               cp      $f0
3627   0ED3 F2 DC 0E            jp      p,l0ee5
3628   0ED6                     
3629   0ED6                     ; Advance to the next row up and reset the tile to the first full girder
3630   0ED6 2B                  dec     hl
3631   0ED7 3E F7               ld      a,$f7
3632   0ED9 32 B5 63            ld      (STAGE_DATA_CURRENT_TILE),a
3633   0EDC                     
3634   0EDC                     ; Jump back up to continue drawing the line
3635   0EDC 18 84       l0ee5:  jr      l0e62
3636   0EDE             
3637   0EDE             		; If not drawing ???, jump ahead
3638   0EDE 3A B3 63    l0ee8:  ld      a,(STAGE_DATA_TILE_ID)
3639   0EE1 FE 03               cp      3
3640   0EE3 20 29               jr      nz,l0f1b
3641   0EE5                     
3642   0EE5                     ; Draw a blank tile at this screen address
3643   0EE5 2A AB 63            ld      hl,(STAGE_DATA_START_ADDRESS)
3644   0EE8 3E B3               ld      a,$b3					; blank tile
3645   0EEA 77                  ld      (hl),a
3646   0EEB                     
3647   0EEB                     ; Advance to the next column right
3648   0EEB 01 20 00            ld      bc,32
3649   0EEE 09                  add     hl,bc
3650   0EEF                     
3651   0EEF                     ; If this is the end of the line, jump ahead
3652   0EEF 3A B1 63            ld      a,(STAGE_DATA_X_DIFF)
3653   0EF2 D6 10               sub     16						; = 2 tiles
3654   0EF4 38 11       l0eff:  jr      c,l0f14
3655   0EF6 32 B1 63            ld      (STAGE_DATA_X_DIFF),a
3656   0EF9                     
3657   0EF9                     ; Draw a square-hole girder at this screen address
3658   0EF9 3E B1               ld      a,$b1
3659   0EFB 77                  ld      (hl),a
3660   0EFC                     
3661   0EFC                     ; Advance to the next column right
3662   0EFC 01 20 00            ld      bc,32
3663   0EFF 09                  add     hl,bc
3664   0F00                     
3665   0F00                     ; If this is the end of the line, jump ahead
3666   0F00 3A B1 63            ld      a,(STAGE_DATA_X_DIFF)
3667   0F03 D6 08               sub     8							; = 1 tile
3668   0F05                     
3669   0F05                     ; Jump back up to continue drawing the line
3670   0F05 18 ED               jr      l0eff
3671   0F07                     
3672   0F07                     ; Draw a blank tile at the current screen address
3673   0F07 3E B2       l0f14:  ld      a,$b2
3674   0F09 77                  ld      (hl),a
3675   0F0A                     
3676   0F0A                     ; Jump back to process the next stage data group
3677   0F0A 13                  inc     de
3678   0F0B C3 AD 0D            jp      L_DISPLAY_STAGE				; Exceeds relative branch
3679   0F0E                     
3680   0F0E                     ; If tile is ???, then jump back to handle the next group of stage data
3681   0F0E 3A B3 63    l0f1b:  ld      a,(STAGE_DATA_TILE_ID)
3682   0F11 FE 07               cp      7
3683   0F13 F2 C6 0E            jp      p,l0ecf	
3684   0F16                     
3685   0F16                     ; If drawing blank tiles, jump ahead
3686   0F16 FE 04               cp      4
3687   0F18 28 22               jr      z,l0f4c
3688   0F1A                     
3689   0F1A                     ; If drawing circular-hole girders, jump ahead
3690   0F1A FE 05               cp      5
3691   0F1C 28 22               jr      z,l0f51
3692   0F1E                     
3693   0F1E                     ; Draw X's, 
3694   0F1E                     
3695   0F1E                     ; Select the 'X' tile
3696   0F1E 3E FE               ld      a,$fe
3697   0F20 32 B5 63    l0f2f:  ld      (STAGE_DATA_CURRENT_TILE),a
3698   0F23             
3699   0F23             		; Draw the til to the current screen address
3700   0F23 2A AB 63            ld      hl,(STAGE_DATA_START_ADDRESS)
3701   0F26 3A B5 63    l0f35:  ld      a,(STAGE_DATA_CURRENT_TILE)
3702   0F29 77                  ld      (hl),a
3703   0F2A                     
3704   0F2A                     ; Advance to the next column right
3705   0F2A 01 20 00            ld      bc,32
3706   0F2D 09                  add     hl,bc
3707   0F2E                     
3708   0F2E                     ; Subtract one tile from the line
3709   0F2E 3A B1 63            ld      a,(STAGE_DATA_X_DIFF)
3710   0F31 D6 08               sub     8						; = 1 tile
3711   0F33 32 B1 63            ld      (STAGE_DATA_X_DIFF),a
3712   0F36                     
3713   0F36                     ; If this is not the end of the line, jump up to continue processing it
3714   0F36 30 EE               jr      nc,l0f35
3715   0F38                     
3716   0F38                     ; Jump up to process the next group of stage data
3717   0F38 13                  inc     de
3718   0F39 C3 AD 0D            jp      L_DISPLAY_STAGE				; Exceeds relative branch
3719   0F3C                     
3720   0F3C                     ; Draw blank tiles?
3721   0F3C 3E E0       l0f4c:  ld      a,$e0
3722   0F3E 18 E0               jr      l0f2f
3723   0F40                     
3724   0F40                     ; Draw girders with circular holes
3725   0F40 3E B0       l0f51:  ld      a,$b0
3726   0F42 18 DC               jr      l0f2f
3727   0F44             ;------------------------------------------------------------------------------
3728   0F44             
3729   0F44             
3730   0F44             
3731   0F44             ;------------------------------------------------------------------------------
3732   0F44             ; Initialize the current stage
3733   0F44             L_INIT_CURRENT_STAGE:  
3734   0F44             		; Zero all of Mario's data
3735   0F44 06 27       		ld      b,39						; For b = 39 to 1
3736   0F46 21 00 62            ld      hl,MARIO_DATA_STRUCT
3737   0F49 AF          l0f5b:  xor     a						; a = 0
3738   0F4A 77          l0f5c:  ld      (hl),a					; Zero the current address
3739   0F4B 2C                  inc     l
3740   0F4C 10 FC               djnz    l0f5c					; Next b
3741   0F4E                     
3742   0F4E                     ; Zero $6280 to $6aff
3743   0F4E                     ; (includes all stage data and sprite data structures)
3744   0F4E 0E 11               ld      c,17						; For c = 17 to 1
3745   0F50 16 80               ld      d,128
3746   0F52 21 80 62            ld      hl,STAGE_DATA_BLOCK
3747   0F55 42          l0f67:  ld      b,d						; For b = 128 to 1
3748   0F56 77          l0f68:  ld      (hl),a					; Zero the current address
3749   0F57 23                  inc     hl
3750   0F58 10 FC               djnz    l0f68					; next b
3751   0F5A 0D                  dec     c
3752   0F5B 20 F8               jr      nz,l0f67					; Next c
3753   0F5D                    
3754   0F5D             		; Load the stage variables with their initial values
3755   0F5D 21 03 3E            ld      hl,L_INITIAL_STAGE_DATA_TABLE
3756   0F60 11 80 62            ld      de,STAGE_DATA_BLOCK
3757   0F63 01 40 00            ld      bc,64					; 64 bytes of data
3758   0F66 ED B0               ldir    
3759   0F68                     
3760   0F68                     ; Initialize the timer to the (current level number x 10) + 40
3761   0F68 3A 29 62            ld      a,(CP_LEVEL_NUMBER)
3762   0F6B 47                  ld      b,a
3763   0F6C A7                  and     a
3764   0F6D 17                  rla     
3765   0F6E A7                  and     a
3766   0F6F 17                  rla     
3767   0F70 A7                  and     a
3768   0F71 17                  rla     
3769   0F72 80                  add     a,b
3770   0F73 80                  add     a,b						; a = level number x 10
3771   0F74 C6 28               add     a,40
3772   0F76                     
3773   0F76                     ; Cap the timer at 80
3774   0F76 FE 51               cp      81
3775   0F78 38 02               jr      c,l0f8e
3776   0F7A 3E 50               ld      a,80
3777   0F7C                     
3778   0F7C 21 B0 62    l0f8e:  ld      hl,INTERNAL_TIMER
3779   0F7F                     
3780   0F7F                     ; Save the timer value to the internal timer, $62b1, and $62b2
3781   0F7F 06 03               ld      b,3						; for b = 3 to 1
3782   0F81 77          l0f93:  ld      (hl),a
3783   0F82 2C                  inc     l
3784   0F83 10 FC               djnz    l0f93					; Next b
3785   0F85                     
3786   0F85                     ; Initialize $62b3
3787   0F85 87                  add     a,a
3788   0F86 47                  ld      b,a
3789   0F87 3E DC               ld      a,220
3790   0F89 90                  sub     b
3791   0F8A                     
3792   0F8A                     ; Cap $62b3 at 40
3793   0F8A FE 28               cp      40
3794   0F8C 30 02               jr      nc,l0fa2
3795   0F8E 3E 28               ld      a,40
3796   0F90 77          l0fa2:  ld      (hl),a
3797   0F91             
3798   0F91             		; Initialize $62b4
3799   0F91 2C                  inc     l
3800   0F92 77                  ld      (hl),a
3801   0F93                     
3802   0F93 21 09 62            ld      hl,$6209
3803   0F96 36 04               ld      (hl),4
3804   0F98                     
3805   0F98 2C                  inc     l						; $620a
3806   0F99 36 08               ld      (hl),8
3807   0F9B                     
3808   0F9B                     ; If current stage is not rivets, jump ahead
3809   0F9B 3A 27 62            ld      a,(CURRENT_STAGE)
3810   0F9E 4F                  ld      c,a
3811   0F9F CB 57               bit     2,a
3812   0FA1 20 16               jr      nz,l0fcb
3813   0FA3                     
3814   0FA3                     ; Initialize 3 sprites
3815   0FA3 21 00 6A            ld      hl,$6a00
3816   0FA6 3E 4F               ld      a,79
3817   0FA8 06 03               ld      b,3						; For b = 3 to 1
3818   0FAA 77          l0fbc:  ld      (hl),a					; Sprite x 
3819   0FAB 2C                  inc     l
3820   0FAC 36 3A               ld      (hl),$3a					; Sprite number = solid block?
3821   0FAE 2C                  inc     l
3822   0FAF 36 0F               ld      (hl),$0f					; Sprite palette
3823   0FB1 2C                  inc     l
3824   0FB2 36 18               ld      (hl),24					; Sprite y				
3825   0FB4 2C                  inc     l
3826   0FB5 C6 10               add     a,16						; Move the next sprite right 16 pixels
3827   0FB7 10 F1               djnz    l0fbc						; Next b
3828   0FB9                     
3829   0FB9                     ; Jump to a function in the table based on the current stage 
3830   0FB9                     ; to setup the current stage
3831   0FB9 79          l0fcb:  ld      a,c
3832   0FBA EF                  rst     $28							; Jump to local table address
3833   0FBB             		; Jump table
3834   0FBB 00 00       		.word	L_ORG	; 0 = reset game
3835   0FBD C7 0F       		.word	L_INIT_BARRELS_STAGE_SPRITES	; 1 = setup barrels stage sprites
3836   0FBF 0B 10       		.word	L_INIT_MIXER_STAGE_SPRITES	; 2 = setup mixer stage sprites
3837   0FC1 5E 10       		.word	L_INIT_ELEVATOR_STAGE_SPRITES	; 3 = setup elevators stage sprites
3838   0FC3 05 11       		.word	L_INIT_RIVETS_STAGE_SPRITES	; 4 = setup rivets stage sprites
3839   0FC5 AF 11       		.word 	L_INIT_SECRET_STAGE_SPRITES ; 5 = setup secret stage
3840   0FC7             ;------------------------------------------------------------------------------
3841   0FC7             
3842   0FC7             
3843   0FC7             
3844   0FC7             ;------------------------------------------------------------------------------
3845   0FC7             ; Initialize the sprites for the barrels stage
3846   0FC7             L_INIT_BARRELS_STAGE_SPRITES:	
3847   0FC7             		; Load the sprite data for the four standing barrels next to Donkey Kong
3848   0FC7 21 43 3E    		ld      hl,L_STANDING_BARRELS_SPRITE_DATA
3849   0FCA 11 A8 69            ld      de,STANDING_BARREL_SPRITE_DATA
3850   0FCD 01 10 00            ld      bc,16
3851   0FD0 ED B0               ldir    
3852   0FD2             
3853   0FD2             		; Load the initial data for the oil barrel fire
3854   0FD2             		; (fire not lit)
3855   0FD2 21 65 3E            ld      hl,L_BARRELS_FIRE_SPRITE_DATA
3856   0FD5 CD 61 12            call    L_LOAD_BARREL_FIRE_DATA
3857   0FD8                     
3858   0FD8                     ; Initialize the hammers
3859   0FD8 21 7D 3E            ld      hl,L_BARRELS_HAMMER_COORDS
3860   0FDB CD 82 11            call    L_INIT_HAMMER_SPRITES
3861   0FDE                     
3862   0FDE                     ; Initialize 10 barrel sprites
3863   0FDE 21 07 10            ld      hl,L_INITIAL_BARREL_DATA
3864   0FE1 11 07 67            ld      de,BARREL_STRUCTS+7			; Sprite number entry
3865   0FE4 01 1C 0A            ld      bc,TWO_BYTES(10,28)			; 8 blocks, 32 byte data structures
3866   0FE7 CD 91 12            call    L_LD_SPRITE_DATA_TO_STRUCT
3867   0FEA                     
3868   0FEA                     ; Load the oil barrel sprite
3869   0FEA 21 71 3E            ld      hl,L_OIL_BARREL_SPRITE_DATA_1
3870   0FED             l_init_barrels_stage_sprites_1:
3871   0FED 11 FC 69            ld      de,OIL_BARREL_SPRITE
3872   0FF0 01 04 00            ld      bc,4						; 4 bytes of data
3873   0FF3 ED B0               ldir    
3874   0FF5             
3875   0FF5                     ; Initialize the fire ball data structures
3876   0FF5 21 53 3E            ld      hl,L_FIREBALL_SPRITE_DATA
3877   0FF8 11 07 64            ld      de,FIREBALL_STRUCTS+7	; Sprite number entry
3878   0FFB 01 1C 05            ld		bc,TWO_BYTES(5,28)		; 5 blocks to copy, 32 byte data structures
3879   0FFE CD 91 12            call    L_LD_SPRITE_DATA_TO_STRUCT
3880   1001             
3881   1001                     ; Initialize the two (invisible) collision detection sprites on either 
3882   1001                     ; side of Donkey Kong
3883   1001 21 5A 11            ld      hl,L_BARREL_COL_SPRITE_COORD_DATA
3884   1004             		; Use the rivets stage initialization code to load the 
3885   1004             		; collision detection sprite data
3886   1004 C3 25 11    		jp		l_init_rivets_stage_sprites_1
3887   1007             ;------------------------------------------------------------------------------
3888   1007             
3889   1007             
3890   1007             
3891   1007             ;------------------------------------------------------------------------------
3892   1007             ; The initial barrel data for barrels on the barrels stage
3893   1007             ; The barrels are initially inactive
3894   1007             L_INITIAL_BARREL_DATA:  
3895   1007 00          		.byte	0						; Sprite number					; Sprite number
3896   1008 00          		.byte	0						; Palette
3897   1009 02          		.byte	2						
3898   100A 02          		.byte	2
3899   100B             ;------------------------------------------------------------------------------
3900   100B             
3901   100B             
3902   100B             
3903   100B             ;------------------------------------------------------------------------------
3904   100B             ; Initialize the sprites for the mixer stage
3905   100B             L_INIT_MIXER_STAGE_SPRITES:  
3906   100B                     ; Initialize pie sprites
3907   100B 21 89 3E            ld      hl,L_PIE_SPRITE_DATA
3908   100E 11 A7 65            ld      de,PIE_STRUCTS+7				; Sprite number entry
3909   1011 01 0C 06            ld      bc,TWO_BYTES(6,12)		; 6 blocks, 16 byte data structures
3910   1014 CD 91 12            call    L_LD_SPRITE_DATA_TO_STRUCT
3911   1017 DD 21 A0 65         ld      ix,PIE_STRUCTS
3912   101B 21 B8 69            ld      hl,PIE_SPRITES
3913   101E 11 10 00            ld      de,16					; 16 byte data structures
3914   1021 06 06               ld      b,6						; 6 sprites
3915   1023 CD 3A 12            call    L_COPY_STRUCT_TO_SPRITE
3916   1026                     
3917   1026                     ; Load the initial data for the oil barrel fire
3918   1026                     ; (Initially lit)
3919   1026 21 6B 3E    		ld      hl,L_MIXER_FIRE_SPRITE_DATA
3920   1029 CD 61 12            call    L_LOAD_BARREL_FIRE_DATA
3921   102C                     
3922   102C                     ; Initialize the retractable ladder sprites
3923   102C 21 8D 3E            ld      hl,L_RETRACT_LADDER_SPRITE_DATA
3924   102F 11 44 69            ld      de,RETRACTABLE_LADDER_SPRITES
3925   1032 01 08 00            ld      bc,8						; 2 sprites
3926   1035 ED B0               ldir    
3927   1037                     
3928   1037                     ; Initialize the conveyer belt motor sprites
3929   1037 21 95 3E            ld      hl,L_MIXER_MOTOR_SPRITE_DATA
3930   103A 11 E4 69            ld      de,CONVEYER_MOTOR_SPRITES
3931   103D 01 18 00            ld      bc,24					; 6 sprites
3932   1040 ED B0               ldir    
3933   1042                     
3934   1042                     ; Initialize the hammers
3935   1042 21 81 3E            ld      hl,L_MIXER_HAMMER_COORDS
3936   1045 CD 82 11            call    L_INIT_HAMMER_SPRITES
3937   1048                     
3938   1048                     ; Initialize the prize sprites
3939   1048 21 AD 3E            ld      hl,L_MIXER_PRIZE_SPRITE_DATA
3940   104B 11 0C 6A            ld      de,PRIZE_SPRITES
3941   104E 01 0C 00            ld      bc,12				; 3 sprites
3942   1051 ED B0               ldir    
3943   1053                     
3944   1053                     ; Mark the oil barrel fire as burning
3945   1053 3E 01               ld      a,1
3946   1055 32 B9 62            ld      (BARREL_FIRE_STATE),a
3947   1058                             
3948   1058                     ; Load the oil barrel sprite (using code from the barrels
3949   1058             		; stage initialization function)
3950   1058 21 75 3E            ld      hl,L_OIL_BARREL_SPRITE_DATA_2
3951   105B C3 ED 0F    		jp		l_init_barrels_stage_sprites_1
3952   105E             ;------------------------------------------------------------------------------
3953   105E             
3954   105E             
3955   105E             		
3956   105E             ;------------------------------------------------------------------------------
3957   105E             ; Initialize the sprites for the elevators stage
3958   105E             L_INIT_ELEVATOR_STAGE_SPRITES:  
3959   105E             		; Initialize the fire ball data structures
3960   105E 21 53 3E    		ld      hl,L_FIREBALL_SPRITE_DATA
3961   1061 11 07 64            ld      de,FIREBALL_STRUCTS+7			; Sprite number entry
3962   1064 01 1C 05            ld      bc,TWO_BYTES(5,28)				; 5 bytes, 32 byte data structures
3963   1067 CD 91 12            call    L_LD_SPRITE_DATA_TO_STRUCT
3964   106A                     
3965   106A                     ; Initialize the springs
3966   106A CD 62 11            call    L_INIT_SPRING_DATA
3967   106D                     
3968   106D                     ; Mark the elevator platforms as active
3969   106D 21 00 66            ld      hl,ELEVATOR_STRUCTS
3970   1070 11 10 00            ld      de,16					; 16 byte data structures
3971   1073 3E 01               ld      a,1
3972   1075 06 06               ld      b,6						; For b = 6 to 1
3973   1077 77          l10a0:  ld      (hl),a
3974   1078 19                  add     hl,de
3975   1079 10 FC               djnz    l10a0						; Next b
3976   107B                     
3977   107B 3E 08               ld      a,8
3978   107D 06 03       l10a8:  ld      b,3						; For b = 3 to 1
3979   107F 21 0D 66            ld      hl,ELEVATOR_STRUCTS+13
3980   1082 77          l10ad:  ld      (hl),a
3981   1083 19                  add     hl,de
3982   1084 10 FC               djnz    l10ad					; Next b
3983   1086                     
3984   1086                     ; Initialize the coordinates of the elevator platforms
3985   1086 21 F1 3E            ld      hl,L_ELEVATOR_COORDS
3986   1089 11 03 66            ld      de,ELEVATOR_STRUCTS+3		; X coordinate entry
3987   108C 01 0E 06            ld      bc,TWO_BYTES(6,14)			; 6 sprites, 16 byte data structures
3988   108F CD 53 12            call    L_COPY_COORDS_TO_STRUCTS
3989   1092                     
3990   1092 21 ED 3E    l10c3:  ld      hl,L_ELEVATOR_SPRITE_DATA
3991   1095 11 07 66            ld      de,ELEVATOR_STRUCTS+7		; Sprite number entry
3992   1098 01 0C 06            ld      bc,TWO_BYTES(6,12)			; 6 sprites, 16 byte data structs
3993   109B CD 91 12            call    L_LD_SPRITE_DATA_TO_STRUCT
3994   109E                     
3995   109E                     ; Copy elevator data to the sprites
3996   109E DD 21 00 66         ld      ix,ELEVATOR_STRUCTS
3997   10A2 21 58 69            ld      hl,ELEVATOR_PLATFORM_SPRITES
3998   10A5 06 06               ld      b,6
3999   10A7 11 10 00            ld      de,16
4000   10AA CD 3A 12            call    L_COPY_STRUCT_TO_SPRITE
4001   10AD                     
4002   10AD                     ; Load the prize sprites for the elevator stage
4003   10AD 21 B9 3E            ld      hl,L_ELEV_PRIZE_SPRITE_DATA
4004   10B0 11 0C 6A            ld      de,PRIZE_SPRITES
4005   10B3 01 0C 00            ld      bc,12						; 3 sprites
4006   10B6 ED B0               ldir    
4007   10B8                     
4008   10B8 DD 21 00 64         ld      ix,FIREBALL_STRUCTS
4009   10BC DD 36 00 01         ld      (ix+0),1				; Fireball active
4010   10C0 DD 36 03 58         ld      (ix+3),88				; Fireball x coordinate
4011   10C4 DD 36 0E 58         ld      (ix+14),88				; Next x coordinate
4012   10C8 DD 36 05 80         ld      (ix+5),128				; Fireball y coordinate
4013   10CC DD 36 0F 80         ld      (ix+15),128				; Next y coordinate
4014   10D0                     
4015   10D0 DD 36 20 01         ld      (ix+32),1				; Fireball active
4016   10D4 DD 36 23 EB         ld      (ix+35),235				; Fireball x coordinate
4017   10D8 DD 36 2E EB         ld      (ix+46),235
4018   10DC DD 36 25 60         ld      (ix+37),96				; Fireball y coordinate
4019   10E0 DD 36 2F 60         ld      (ix+47),96
4020   10E4                     
4021   10E4                     ; Load the elevator motor sprites
4022   10E4 11 70 69            ld      de,ELEVATOR_MOTOR_SPRITE_DATA
4023   10E7 21 F5 10            ld      hl,L_ELEV_MOTOR_SPRITE_DATA
4024   10EA 01 10 00            ld      bc,16					; 4 sprites
4025   10ED ED B0               ldir    
4026   10EF             
4027   10EF                     ; Initialize the two (invisible) collision detection sprites on either 
4028   10EF                     ; side of Donkey Kong
4029   10EF 21 5E 11            ld      hl,L_ELEV_COL_SPRITE_COORD_DATA
4030   10F2             		; Use the rivets stage initialization code to load the 
4031   10F2             		; collision detection sprite data
4032   10F2 C3 25 11    		jp		l_init_rivets_stage_sprites_1
4033   10F5             ;------------------------------------------------------------------------------
4034   10F5             
4035   10F5             
4036   10F5             
4037   10F5             ;------------------------------------------------------------------------------
4038   10F5             ; Sprite data for each of the elevator motors on the elevator level
4039   10F5             L_ELEV_MOTOR_SPRITE_DATA:	
4040   10F5 37          		.byte	55	; X coordinate
4041   10F6 45          		.byte	$45	; Sprite number
4042   10F7 0F          		.byte	$0f	; Palette
4043   10F8 60          		.byte	96	; Y coordinate
4044   10F9             		
4045   10F9 37          		.byte	55	; X coordinate
4046   10FA 45          		.byte	$45	; Sprite number
4047   10FB 8F          		.byte	$8f	; Palette (Flipped vertically)
4048   10FC F7          		.byte	247	; Y coordinate
4049   10FD             		
4050   10FD 77          		.byte	119	; X coordinate
4051   10FE 45          		.byte	$45	; Sprite number
4052   10FF 0F          		.byte	$0f	; Palette
4053   1100 60          		.byte	96	; Y coordinate
4054   1101             		
4055   1101 77          		.byte	119	; X coordinate
4056   1102 45          		.byte	$45	; Sprite number
4057   1103 8F          		.byte	$8f	; Palette (Flipped vertically)
4058   1104 F7          		.byte	247	; Y coordinate
4059   1105             ; ------------------------------------------------------------------------------
4060   1105             
4061   1105              
4062   1105              
4063   1105             ;------------------------------------------------------------------------------
4064   1105             ; Initialize the sprites for the rivets stage
4065   1105             L_INIT_RIVETS_STAGE_SPRITES:  
4066   1105             		; Initialize the firefox sprites
4067   1105 21 57 3E    		ld      hl,L_FIREFOX_SPRITE_DATA
4068   1108 11 07 64            ld      de,FIREBALL_STRUCTS+7	; Sprite num entry
4069   110B 01 1C 05            ld      bc,TWO_BYTES(5,28)		; 5 sprites, 32 byte data structures
4070   110E CD 91 12            call    L_LD_SPRITE_DATA_TO_STRUCT
4071   1111                     
4072   1111                     ; Initialize the hammers
4073   1111 21 85 3E            ld      hl,L_RIVETS_HAMMER_COORDS
4074   1114 CD 82 11            call    L_INIT_HAMMER_SPRITES
4075   1117                     
4076   1117                     ; Initialize the prize sprites
4077   1117 21 C5 3E            ld      hl,L_RIVETS_PRIZE_SPRITE_DATA
4078   111A 11 0C 6A            ld      de,PRIZE_SPRITES
4079   111D 01 0C 00            ld      bc,12					; 3 sprites
4080   1120 ED B0               ldir    
4081   1122                     
4082   1122                     ; Initialize the two (invisible) collision detection sprites on either 
4083   1122                     ; side of Donkey Kong
4084   1122 21 56 11            ld      hl,L_RIVETS_COL_SPRITE_COORD_DATA
4085   1125             l_init_rivets_stage_sprites_1:
4086   1125 11 A3 64            ld      de,COLLISION_AREA_STRUCTS+3	; X coordinate entry
4087   1128 01 1E 02            ld      bc,TWO_BYTES(2,30)		; 2 sprites, 32 byte data structures
4088   112B CD 53 12            call    L_COPY_COORDS_TO_STRUCTS 
4089   112E 21 52 11            ld      hl,L_COL_SPRITE_DATA
4090   1131 11 A7 64            ld      de,COLLISION_AREA_STRUCTS+7	; Sprite number entry
4091   1134 01 1C 02            ld      bc,TWO_BYTES(2,28)		; 2 sprites, 32 byte data structures
4092   1137 CD 91 12            call    L_LD_SPRITE_DATA_TO_STRUCT
4093   113A                     
4094   113A                     ; Misc data
4095   113A DD 21 A0 64         ld      ix,COLLISION_AREA_STRUCTS
4096   113E DD 36 00 01         ld      (ix+0),1					; Sprite active
4097   1142 DD 36 20 01         ld      (ix+32),1
4098   1146                     
4099   1146                     ; Copy the collision sprite data to the sprite data structures
4100   1146 21 50 69            ld      hl,COLLISION_AREA_SPRITES
4101   1149 06 02               ld      b,2						; 2 sprites
4102   114B 11 20 00            ld      de,32						; 32 byte data structures
4103   114E CD 3A 12            call    L_COPY_STRUCT_TO_SPRITE
4104   1151 C9                  ret     
4105   1152             ;------------------------------------------------------------------------------
4106   1152             
4107   1152             
4108   1152             
4109   1152             ;------------------------------------------------------------------------------
4110   1152             ; The following data is for the collision detection sprites on either side of
4111   1152             ; Donkey Kong on the rivets stage
4112   1152             L_COL_SPRITE_DATA:	
4113   1152 3F          		.byte	K_COLLISION_SPRITE_NUM
4114   1153 0C          		.byte	K_COLLISION_SPRITE_PAL
4115   1154 08          		.byte	K_COLLISION_SPRITE_WIDTH
4116   1155 08          		.byte	K_COLLISION_SPRITE_HEIGHT
4117   1156             ;------------------------------------------------------------------------------
4118   1156             
4119   1156             
4120   1156             
4121   1156             ;------------------------------------------------------------------------------
4122   1156             ; The following coordinates define the position of the collision detection 
4123   1156             ; sprites on either side of Donkey Kong on the rivets stage 
4124   1156             L_RIVETS_COL_SPRITE_COORD_DATA:	
4125   1156 73          		.byte	K_COLLISION_1_X_RIVETS
4126   1157 50          		.byte	K_COLLISION_1_Y_RIVETS
4127   1158             		
4128   1158 8D          		.byte	K_COLLISION_2_X_RIVETS
4129   1159 50          		.byte	K_COLLISION_2_Y_RIVETS
4130   115A             ;------------------------------------------------------------------------------
4131   115A             
4132   115A             
4133   115A             
4134   115A             ;------------------------------------------------------------------------------
4135   115A             ; The following coordinates define the position of the collision detection 
4136   115A             ; sprites on either side of Donkey Kong on the barrels stage
4137   115A             L_BARREL_COL_SPRITE_COORD_DATA:	
4138   115A 46          		.byte	K_COLLISION_X_BARRELS
4139   115B 4C          		.byte	K_COLLISION_Y_BARRELS
4140   115C             		
4141   115C 46          		.byte	K_COLLISION_X_BARRELS
4142   115D 4C          		.byte	K_COLLISION_Y_BARRELS
4143   115E             ;------------------------------------------------------------------------------
4144   115E             
4145   115E             
4146   115E             
4147   115E             ;------------------------------------------------------------------------------
4148   115E             ; The following coordinates define the position of the collision detection 
4149   115E             ; sprites on either side of Donkey Kong on the elevators stage
4150   115E             L_ELEV_COL_SPRITE_COORD_DATA:	
4151   115E 46          		.byte	K_COLLISION_X_ELEVATORS
4152   115F 50          		.byte	K_COLLISION_Y_ELEVATORS
4153   1160             		
4154   1160 46          		.byte	K_COLLISION_X_ELEVATORS
4155   1161 50          		.byte	K_COLLISION_Y_ELEVATORS
4156   1162             ;------------------------------------------------------------------------------
4157   1162             
4158   1162             
4159   1162             
4160   1162             ;------------------------------------------------------------------------------
4161   1162             ; Initialize the spring data for the springs on the elevators stage
4162   1162             L_INIT_SPRING_DATA:  
4163   1162             		; Initialize the spring structure data
4164   1162 21 7E 11    		ld      hl,L_INITIAL_SPRING_DATA
4165   1165 11 07 65            ld      de,SPRING_STRUCTS+7				; Sprite number entry
4166   1168 01 0C 0A            ld      bc,TWO_BYTES(10,12)				; 10 blocks, 16 byte data structures
4167   116B CD 91 12            call    L_LD_SPRITE_DATA_TO_STRUCT
4168   116E                     
4169   116E                     ; Initialize the spring sprites from the spring data structures
4170   116E DD 21 00 65         ld      ix,SPRING_STRUCTS
4171   1172 21 80 69            ld      hl,SPRING_SPRITES
4172   1175 06 0A               ld      b,10
4173   1177 11 10 00            ld      de,16
4174   117A CD 3A 12            call    L_COPY_STRUCT_TO_SPRITE
4175   117D C9                  ret     
4176   117E             ;---------------------------------------------- 
4177   117E             
4178   117E             
4179   117E             ;------------------------------------------------------
4180   117E             ; Initial values for some of the spring structure data such as the initial 
4181   117E             ; spring sprite number...
4182   117E             L_INITIAL_SPRING_DATA:	
4183   117E 3B          		.byte	$3b	; Normal spring sprite
4184   117F 00          		.byte	$00	; The sprite palette
4185   1180 02          		.byte	2
4186   1181 02          		.byte	2
4187   1182             ;------------------------------------------------------------------------------
4188   1182             
4189   1182             
4190   1182             
4191   1182             ;-------------------------------------------------------------------
4192   1182             ; Initialize the hammer sprites for the current stage
4193   1182             ;
4194   1182             ; passed:	hl - the ROM address of the two hammer's coordinates
4195   1182             L_INIT_HAMMER_SPRITES:  
4196   1182             		; Initialize the hammer data structures
4197   1182 11 83 66    		ld      de,HAMMER_STRUCTS+3					; First x coord position
4198   1185 01 0E 02            ld      bc,TWO_BYTES(2,14)			; 2 blocks, 14
4199   1188 CD 53 12            call    L_COPY_COORDS_TO_STRUCTS
4200   118B 21 79 3E            ld      hl,L_HAMMER_SPRITE_DATA
4201   118E 11 87 66            ld      de,HAMMER_STRUCTS+7			; Sprite number entry
4202   1191 01 0C 02            ld      bc,TWO_BYTES(2,12)	; 2 blocks, 16 bytes apart
4203   1194 CD 91 12            call    L_LD_SPRITE_DATA_TO_STRUCT
4204   1197 DD 21 80 66         ld      ix,HAMMER_STRUCTS
4205   119B                     
4206   119B                     ; Mark both hammers as active
4207   119B DD 36 00 01         ld      (ix+0),1
4208   119F DD 36 10 01         ld      (ix+16),1
4209   11A3                     
4210   11A3                     ; Copy hammer sprite data from the data structures to the sprite structures
4211   11A3 21 18 6A            ld      hl,HAMMER_SPRITES
4212   11A6 06 02               ld      b,2						; 2 sprites
4213   11A8 11 10 00            ld      de,16					; Source data structure are 16 bytes long
4214   11AB CD 3A 12            call    L_COPY_STRUCT_TO_SPRITE
4215   11AE C9                  ret     
4216   11AF             ;------------------------------------------------------------------------------
4217   11AF             
4218   11AF             
4219   11AF             		
4220   11AF             ;------------------------------------------------------------------------------
4221   11AF             ; Initialize the sprites for the secret stage
4222   11AF             L_INIT_SECRET_STAGE_SPRITES: 
4223   11AF             		; One fireball for each level number (max of 5)
4224   11AF 21 53 3E    		ld		hl,L_FIREBALL_SPRITE_DATA
4225   11B2 E5          		push	hl
4226   11B3 3A 29 62    		ld		a,(CP_LEVEL_NUMBER)
4227   11B6 FE 06       		cp		6
4228   11B8 38 02       		jr		c,l_init_secret_stage_sprites_0
4229   11BA             		; Cap the fireball number at five
4230   11BA 3E 05       		ld		a,5
4231   11BC             				
4232   11BC             l_init_secret_stage_sprites_0:
4233   11BC 47          		ld		b,a
4234   11BD 0E 1E       		ld		c,30						; 32 byte structures
4235   11BF C5          		push	bc
4236   11C0             
4237   11C0             		; Initialize the coordinates of the fireballs
4238   11C0 21 5B 3E    		ld		hl,L_SECRET_FIREBALL_COORDS
4239   11C3 11 03 64    		ld		de,FIREBALL_STRUCTS+3		; X coordinate entry
4240   11C6 01 1E 05    		ld		bc,TWO_BYTES(5,30)			; 5 sprites, 32 byte structures
4241   11C9 CD 53 12            call    L_COPY_COORDS_TO_STRUCTS
4242   11CC             
4243   11CC             		; Activate all the fireballs and copy the starting coordinate
4244   11CC             		; to the next coordinate
4245   11CC C1          		pop		bc
4246   11CD DD 21 00 64 		ld		ix,FIREBALL_STRUCTS
4247   11D1 11 20 00    		ld		de,32						; 32 byte data structures
4248   11D4             l_init_secret_stage_sprites_1:
4249   11D4 DD 36 00 01 		ld		(ix+0),1
4250   11D8 DD 7E 03    		ld		a,(ix+3)
4251   11DB DD 77 0E    		ld		(ix+14),a
4252   11DE DD 7E 05    		ld		a,(ix+5)
4253   11E1 DD 77 0F    		ld		(ix+15),a
4254   11E4 DD 19       		add		ix,de
4255   11E6 10 EC       		djnz	l_init_secret_stage_sprites_1
4256   11E8             		
4257   11E8             		; Initialize the fire ball data structures
4258   11E8 E1          		pop		hl
4259   11E9 11 07 64            ld      de,FIREBALL_STRUCTS+7			; Sprite number entry
4260   11EC 01 1C 05            ld      bc,TWO_BYTES(5,28)				; 5 sprites, 32 byte data structures
4261   11EF CD 91 12            call    L_LD_SPRITE_DATA_TO_STRUCT
4262   11F2             
4263   11F2                     ; Mark the elevator platforms as active
4264   11F2 DD 21 00 66 		ld 		ix,ELEVATOR_STRUCTS
4265   11F6 3E 01       		ld		a,1
4266   11F8 DD 77 00    		ld		(ix+0),a					; Elevator 1 active
4267   11FB DD 77 10    		ld		(ix+16),a					; Elevator 2 active
4268   11FE             		
4269   11FE                     ; Initialize the coordinates of the elevator
4270   11FE 21 FD 3E            ld      hl,L_SECRET_ELEVATOR_COORDS
4271   1201 11 03 66            ld      de,ELEVATOR_STRUCTS+3		; X coordinate entry
4272   1204 01 0E 02            ld      bc,TWO_BYTES(2,14)			; 2 sprites, 16 byte data structures
4273   1207 CD 53 12            call    L_COPY_COORDS_TO_STRUCTS
4274   120A                     
4275   120A             lsecret10c3:  
4276   120A 21 ED 3E    		ld      hl,L_ELEVATOR_SPRITE_DATA
4277   120D 11 07 66            ld      de,ELEVATOR_STRUCTS+7		; Sprite number entry
4278   1210 01 0C 02            ld      bc,TWO_BYTES(2,12)			; 2 sprites, 16 byte data structs
4279   1213 CD 91 12            call    L_LD_SPRITE_DATA_TO_STRUCT
4280   1216                     
4281   1216                     ; Copy elevator data to the sprites
4282   1216 DD 21 00 66         ld      ix,ELEVATOR_STRUCTS
4283   121A 21 58 69            ld      hl,ELEVATOR_PLATFORM_SPRITES
4284   121D 06 02               ld      b,2							; 2 elevators
4285   121F 11 10 00            ld      de,16						; 16 byte structures
4286   1222 CD 3A 12            call    L_COPY_STRUCT_TO_SPRITE
4287   1225                     
4288   1225                     ; Load the prize sprites for the secret stage
4289   1225 21 D1 3E            ld      hl,L_SECRET_PRIZE_SPRITE_DATA
4290   1228 11 0C 6A            ld      de,PRIZE_SPRITES
4291   122B 0E 0C               ld      c,12						; 3 sprites
4292   122D ED B0               ldir    
4293   122F                     
4294   122F             		; Load the trigger sprites for the secret stage
4295   122F 21 DD 3E    		ld		hl,L_SECRET_TRIGGER_DATA
4296   1232 11 70 69    		ld		de,TRIGGER_SPRITES
4297   1235 0E 10       		ld		c,16						; 4 sprites
4298   1237 ED B0       		ldir
4299   1239             		
4300   1239 C9                  ret     
4301   123A             ;------------------------------------------------------------------------------
4302   123A             
4303   123A             
4304   123A             
4305   123A             ;------------------------------------------------------------------------------
4306   123A             ; Copy sprite information from a data structure (ie the spring data structures)
4307   123A             ; to a sprite data structure.
4308   123A             ; For example, this function copies the x and y coordinates, and the sprite 
4309   123A             ; number and palette from the spring data structures to the spring sprites.
4310   123A             ;
4311   123A             ; passed:	hl - address of the sprite to copy to
4312   123A             ;			ix - address of the data structure to copy from
4313   123A             ;			b - the number of data structures to copy
4314   123A             ;			de - the distance between source data structures
4315   123A             L_COPY_STRUCT_TO_SPRITE:  
4316   123A             		; Copy the x coordinate
4317   123A DD 7E 03    		ld      a,(ix+3)
4318   123D 77                  ld      (hl),a
4319   123E                     
4320   123E                     ; Copy the sprite number
4321   123E 2C                  inc     l
4322   123F DD 7E 07            ld      a,(ix+7)
4323   1242 77                  ld      (hl),a
4324   1243                     
4325   1243                     ; Copy the sprite palette
4326   1243 2C                  inc     l
4327   1244 DD 7E 08            ld      a,(ix+8)
4328   1247 77                  ld      (hl),a
4329   1248                     
4330   1248                     ; Copy the y coordinate
4331   1248 2C                  inc     l
4332   1249 DD 7E 05            ld      a,(ix+5)
4333   124C 77                  ld      (hl),a
4334   124D                     
4335   124D                     ; Process the next structure
4336   124D 2C                  inc     l
4337   124E DD 19               add     ix,de
4338   1250 10 E8               djnz    L_COPY_STRUCT_TO_SPRITE
4339   1252                     
4340   1252 C9                  ret     
4341   1253             ;------------------------------------------------------------------------------
4342   1253             
4343   1253             
4344   1253             
4345   1253             ;------------------------------------------------------------------------------
4346   1253             ; Load x and y coordinates into one or more data structures
4347   1253             ; The x and y coordinates are spaced two bytes apart
4348   1253             ; passed:	hl - source address
4349   1253             ;			de - destination address
4350   1253             ;			b - the number of 2 byte blocks to copy
4351   1253             ;			c - the distance between the destination blocks (- 2 bytes)
4352   1253             L_COPY_COORDS_TO_STRUCTS:  
4353   1253             		; Copy the x coordinate to the destination structure
4354   1253 7E          		ld      a,(hl)
4355   1254 12                  ld      (de),a
4356   1255 23                  inc     hl
4357   1256                     
4358   1256             		; Copy the y coordinate to the destination structure
4359   1256 1C                  inc     e
4360   1257 1C                  inc     e
4361   1258 7E                  ld      a,(hl)
4362   1259 12                  ld      (de),a
4363   125A                     
4364   125A                     ; Advance to the next data structure
4365   125A 23                  inc     hl
4366   125B 7B                  ld      a,e
4367   125C 81                  add     a,c
4368   125D 5F                  ld      e,a
4369   125E                     
4370   125E 10 F3               djnz    L_COPY_COORDS_TO_STRUCTS						; Next b
4371   1260 C9                  ret     
4372   1261             ;------------------------------------------------------------------------------
4373   1261             
4374   1261             
4375   1261             
4376   1261             ;------------------------------------------------------------------------------
4377   1261             ; Load oil fire data into the oil fire sprite and data structure
4378   1261             ; passed:	hl - source address
4379   1261             L_LOAD_BARREL_FIRE_DATA:  
4380   1261 DD 21 A0 66 		ld      ix,BARREL_FIRE_STRUCT
4381   1265 11 28 6A            ld      de,BARREL_FIRE_SPRITE
4382   1268                     
4383   1268                     ; Set the barrel fire structure active
4384   1268 DD 36 00 01         ld      (ix+0),1
4385   126C                     
4386   126C                     ; Load the fire x coordinate
4387   126C 7E                  ld      a,(hl)
4388   126D DD 77 03            ld      (ix+3),a
4389   1270 12                  ld      (de),a
4390   1271                     
4391   1271                     ; Load the fire tile number
4392   1271 1C                  inc     e
4393   1272 23                  inc     hl
4394   1273 7E                  ld      a,(hl)
4395   1274 DD 77 07            ld      (ix+7),a
4396   1277 12                  ld      (de),a
4397   1278                     
4398   1278                     ; Load the fire palette
4399   1278 1C                  inc     e
4400   1279 23                  inc     hl
4401   127A 7E                  ld      a,(hl)
4402   127B DD 77 08            ld      (ix+8),a
4403   127E 12                  ld      (de),a
4404   127F                     
4405   127F                     ; Load the fire y coordinate
4406   127F 1C                  inc     e
4407   1280 23                  inc     hl
4408   1281 7E                  ld      a,(hl)
4409   1282 DD 77 05            ld      (ix+5),a
4410   1285 12                  ld      (de),a
4411   1286                     
4412   1286                     ; Load the fire's radial width
4413   1286 23                  inc     hl
4414   1287 7E                  ld      a,(hl)
4415   1288 DD 77 09            ld      (ix+9),a
4416   128B                     
4417   128B                     ; Load the fire's radial height
4418   128B 23                  inc     hl
4419   128C 7E                  ld      a,(hl)
4420   128D DD 77 0A            ld      (ix+10),a
4421   1290 C9                  ret     
4422   1291             ;------------------------------------------------------------------------------
4423   1291             
4424   1291             
4425   1291             
4426   1291             ;------------------------------------------------------------------------------
4427   1291             ; Load 4 bytes of basic sprite data (sprite number, palette, etc) from a ROM 
4428   1291             ; address into sequential data structure.
4429   1291             ; The same 4 byte block is copied to each destination
4430   1291             ; passed:	hl - starting source address
4431   1291             ;			de - starting destination address
4432   1291             ;			b - the number of blocks to load
4433   1291             ;			c - the size of the data structure (- 4 bytes)
4434   1291             L_LD_SPRITE_DATA_TO_STRUCT:  
4435   1291 E5          		push    hl
4436   1292 C5                  push    bc
4437   1293                     
4438   1293                     ; Copy 4 bytes from the the source to the destination
4439   1293 06 04               ld      b,4						; For b = 4 to 1
4440   1295 7E          l122e:  ld      a,(hl)
4441   1296 12                  ld      (de),a
4442   1297 23                  inc     hl
4443   1298 1C                  inc     e
4444   1299 10 FA               djnz    l122e					; Next b
4445   129B                     
4446   129B                     ; Restore the original source address and 
4447   129B C1                  pop     bc
4448   129C E1                  pop     hl
4449   129D                     
4450   129D                     ; Advance to the next destination address and continue
4451   129D 7B                  ld      a,e
4452   129E 81                  add     a,c
4453   129F 5F                  ld      e,a
4454   12A0 10 EF               djnz    L_LD_SPRITE_DATA_TO_STRUCT
4455   12A2 C9                  ret     
4456   12A3             ;------------------------------------------------------------------------------
4457   12A3             
4458   12A3             
4459   12A3             
4460   12A3             ;------------------------------------------------------------------------------
4461   12A3             ; Initialize Mario (position and sprite number).  The number of lives are also 
4462   12A3             ; displayed (after the current life is deducted)
4463   12A3             L_INIT_MARIO:  
4464   12A3             		; Return until the minor timer has run down
4465   12A3 DF          		rst     $18
4466   12A4             		
4467   12A4             		; If current stage is elevators, set Mario's coordinate to (22,224)
4468   12A4 3A 27 62            ld      a,(CURRENT_STAGE)
4469   12A7 FE 03               cp      3
4470   12A9 01 16 E0            ld      bc,MARIO_START_COORD_ELEVATORS
4471   12AC 28 03               jr      z,l124b
4472   12AE                     
4473   12AE                     ; If current stage is not elevators, set Mario's coordinate to (63,240)
4474   12AE 01 3F F0            ld      bc,MARIO_START_COORD
4475   12B1                     
4476   12B1                     ; ix = first byte of Mario structure
4477   12B1 DD 21 00 62 l124b:  ld      ix,MARIO_DATA_STRUCT
4478   12B5 21 4C 69            ld      hl,MARIO_SPRITE
4479   12B8 DD 36 00 01         ld      (ix+0),1					; Mario is alive
4480   12BC                     
4481   12BC                     ; Set Mario's x coordinate
4482   12BC DD 71 03            ld      (ix+3),c					; X coordinate
4483   12BF 71                  ld      (hl),c
4484   12C0                     
4485   12C0                     ; Set Mario's sprite to $00, facing right 
4486   12C0 2C                  inc     l
4487   12C1 DD 36 07 80         ld      (ix+7),$80				; Sprite number
4488   12C5 36 80               ld      (hl),$80
4489   12C7                     
4490   12C7                     ; Set Mario's palette to $02
4491   12C7 2C                  inc     l
4492   12C8 DD 36 08 02         ld      (ix+8),$02				; Sprite palette
4493   12CC 36 02               ld      (hl),$02
4494   12CE                     
4495   12CE                     ; Set Mario's y coordinate
4496   12CE 2C                  inc     l
4497   12CF DD 70 05            ld      (ix+5),b					; Y coordinate
4498   12D2 70                  ld      (hl),b
4499   12D3                     
4500   12D3                     ; 
4501   12D3 DD 36 0F 01         ld      (ix+15),1
4502   12D7                     
4503   12D7                     ; Advance to the next substate
4504   12D7 21 0A 60            ld      hl,GAME_SUBSTATE
4505   12DA 34                  inc     (hl)
4506   12DB                     
4507   12DB                     ; Decrement and display the number of lives
4508   12DB 11 01 06            ld      de,$0601
4509   12DE CD 36 31            call    L_ADD_EVENT
4510   12E1 C9                  ret     
4511   12E2             ;------------------------------------------------------------------------------
4512   12E2             
4513   12E2             
4514   12E2             
4515   12E2             ;------------------------------------------------------------------------------
4516   12E2             ; Implement Mario's death animation
4517   12E2             L_IMPLEMENT_DEATH_ANIM:  
4518   12E2             		; Award any pending pointdfs 
4519   12E2 CD C4 1E    		call    L_IMPLEMENT_POINT_AWARD
4520   12E5             		
4521   12E5             		; Jump based on the current animation state
4522   12E5 3A 9D 63            ld      a,(DEATH_ANIMATION_STATE)
4523   12E8 EF                  rst     $28							; Jump to local table address
4524   12E9             		; Jump table
4525   12E9 EF 12       		.word	L_PREPARE_DEATH_ANIMATION	; 0 = start death sequence animation
4526   12EB 10 13       		.word	L_ROTATE_MARIO_DEAD_SPRITE	; 1 = advance death sequence
4527   12ED 41 13       		.word	L_CLEAN_UP_DEATH_ANIMATION	; 2 = complete death sequence
4528   12EF             ;------------------------------------------------------------------------------
4529   12EF             
4530   12EF             
4531   12EF             
4532   12EF             ;------------------------------------------------------------------------------
4533   12EF             ; Prepare the death animation
4534   12EF             L_PREPARE_DEATH_ANIMATION:  
4535   12EF DF          		rst     $18						; Return until minor timer times out
4536   12F0             		
4537   12F0             		; Determine if the Mario sprite needs to be flipped horizontally
4538   12F0 21 4D 69            ld      hl,MARIO_SPRITE_NUM
4539   12F3 3E F0               ld      a,$f0
4540   12F5 CB 16               rl      (hl)
4541   12F7 1F                  rra     
4542   12F8 77                  ld      (hl),a
4543   12F9                     
4544   12F9                     ; Advance to the next animation state
4545   12F9 21 9D 63            ld      hl,DEATH_ANIMATION_STATE
4546   12FC 34                  inc     (hl)
4547   12FD                     
4548   12FD                     ; Set the death animation counter to 13
4549   12FD 3E 0D               ld      a,13
4550   12FF 32 9E 63            ld      (DEATH_ANIMATION_COUNTER),a
4551   1302                     
4552   1302                     ; Set the minor timer to 8
4553   1302 3E 08               ld      a,8
4554   1304 32 09 60            ld      (MINOR_TIMER),a
4555   1307                     
4556   1307 CD 52 31            call    L_CLEAR_SPRITES_WHEN_DEAD
4557   130A                     
4558   130A                     ; Trigger the death song
4559   130A 3E 03               ld      a,3
4560   130C 32 88 60            ld      (DEATH_SOUND_TRIGGER),a
4561   130F C9                  ret     
4562   1310             ;------------------------------------------------------------------------------
4563   1310             
4564   1310             
4565   1310             
4566   1310             ;------------------------------------------------------------------------------
4567   1310             ; Rotate Mario's death sprite to animate him spinning
4568   1310             L_ROTATE_MARIO_DEAD_SPRITE:  
4569   1310 DF          		rst     $18						; Return until minor timer runs out
4570   1311             		
4571   1311             		; Set the minor timer to 8
4572   1311 3E 08               ld      a,8
4573   1313 32 09 60            ld      (MINOR_TIMER),a
4574   1316                     
4575   1316                     
4576   1316 21 9E 63            ld      hl,DEATH_ANIMATION_COUNTER
4577   1319 35                  dec     (hl)
4578   131A 28 12               jr      z,l12cb
4579   131C                     
4580   131C 21 4D 69            ld      hl,MARIO_SPRITE_NUM
4581   131F 7E                  ld      a,(hl)
4582   1320 1F                  rra     
4583   1321 3E 02               ld      a,$02
4584   1323 1F                  rra     
4585   1324 47                  ld      b,a
4586   1325 AE                  xor     (hl)
4587   1326 77                  ld      (hl),a
4588   1327                     
4589   1327 2C                  inc     l
4590   1328 78                  ld      a,b
4591   1329 E6 80               and     %10000000
4592   132B AE                  xor     (hl)
4593   132C 77                  ld      (hl),a
4594   132D C9                  ret    
4595   132E             		
4596   132E             		; Set Mario's sprite to lying flat on his back,
4597   132E             		; vertically flipped as appropriate 
4598   132E 21 4D 69    l12cb:  ld      hl,MARIO_SPRITE_NUM
4599   1331 3E F4               ld      a,$f4
4600   1333 CB 16               rl      (hl)
4601   1335 1F                  rra     
4602   1336 77                  ld      (hl),a
4603   1337                     
4604   1337                     ; Advance the death animation state
4605   1337 21 9D 63            ld      hl,DEATH_ANIMATION_STATE
4606   133A 34                  inc     (hl)
4607   133B                     
4608   133B                     ; Initialize the minor timer to 128
4609   133B 3E 80               ld      a,128
4610   133D 32 09 60            ld      (MINOR_TIMER),a
4611   1340                     
4612   1340 C9                  ret     
4613   1341             ;------------------------------------------------------------------------------
4614   1341             
4615   1341             
4616   1341             
4617   1341             ;------------------------------------------------------------------------------
4618   1341             ; Clean up the death animation and advance to the next state
4619   1341             L_CLEAN_UP_DEATH_ANIMATION:	
4620   1341 DF          		rst     $18						; Return until minor timer runs out
4621   1342             		
4622   1342             		; Clear out Mario's sprite
4623   1342 CD 6F 31            call    L_CLEAR_MARIO_SPRITE
4624   1345                     
4625   1345                     ; If this is a one player game, advance the substate by one
4626   1345 21 0A 60            ld      hl,GAME_SUBSTATE
4627   1348 3A 0E 60            ld      a,(SECOND_PLAYER)
4628   134B A7                  and     a
4629   134C 28 01               jr      z,l12ed
4630   134E                     
4631   134E                     ; If this is a two player game, advance the substate by two
4632   134E 34                  inc     (hl)
4633   134F                     
4634   134F                     ; Advance the substate
4635   134F 34          l12ed:  inc     (hl)
4636   1350             
4637   1350             		; Set the minor timer to 1
4638   1350 2B                  dec     hl
4639   1351 36 01               ld      (hl),1
4640   1353 C9                  ret     
4641   1354             ;------------------------------------------------------------------------------
4642   1354             
4643   1354             
4644   1354             
4645   1354             ;------------------------------------------------------------------------------
4646   1354             ; After death processing for player 1.  Remove a life, and end the player's 
4647   1354             ; game if there are no more lives left.
4648   1354             L_POST_DEATH_PROCESSING_P1:  
4649   1354 CD 0F 01    		call    L_SOUNDS_OFF
4650   1357                     
4651   1357                     ; Set the intro as having been displayed for the current player
4652   1357 AF                  xor     a
4653   1358 32 2C 62            ld      (CP_INTRO_NOT_DISPLAYED),a
4654   135B                     
4655   135B                     ; Subtract a life
4656   135B 21 28 62            ld      hl,CP_NUMBER_LIVES
4657   135E 35                  dec     (hl)
4658   135F 7E                  ld      a,(hl)
4659   1360                     
4660   1360                     ; Save the current player data to the first player data
4661   1360 11 40 60            ld      de,P1_DATA
4662   1363 01 08 00            ld      bc,8
4663   1366 ED B0               ldir    
4664   1368                     
4665   1368                     ; If player 1 has more lives, jump ahead
4666   1368 A7                  and     a
4667   1369 20 2A               jr      nz,l1334
4668   136B                     
4669   136B                     ; Check if player 1's score qualifies for the high score list
4670   136B 3E 01               ld      a,1						; Player 1 ID
4671   136D 21 B2 60            ld      hl,PREV_P1_SCORE
4672   1370 CD 26 14            call    L_ADD_SCORE_TO_HS_TABLE
4673   1373                     
4674   1373                     ; If there is only 1 player, jump ahead to skip displaying the player I prompt
4675   1373 21 D4 76            ld      hl,TILE_COORD(22,20)
4676   1376 3A 0F 60            ld      a,(TWO_PLAYERS)
4677   1379 A7                  and     a
4678   137A 28 07               jr      z,l1322
4679   137C                     
4680   137C                     ; Display the player I string
4681   137C 11 02 03            ld      de,$0302
4682   137F CD 36 31            call    L_ADD_EVENT
4683   1382 2B                  dec     hl
4684   1383 CD A1 18    l1322:  call    L_CLEAR_AROUND_GAME_OVER
4685   1386             
4686   1386             		; Display "GAME OVER"
4687   1386 11 00 03            ld      de,$0300
4688   1389 CD 36 31            call    L_ADD_EVENT
4689   138C                     
4690   138C                     ; Set the minor timer to 192
4691   138C 21 09 60            ld      hl,MINOR_TIMER
4692   138F 36 C0               ld      (hl),192
4693   1391                     
4694   1391                     ; Set game substate to 16 and return
4695   1391 23                  inc     hl
4696   1392 36 10               ld      (hl),16
4697   1394 C9                  ret     
4698   1395                     
4699   1395                     ; If there is only 1 player, jump ahead to advance to substate 8
4700   1395 0E 08       l1334:  ld      c,8
4701   1397 3A 0F 60            ld      a,(TWO_PLAYERS)
4702   139A A7                  and     a
4703   139B 28 02               jr      z,l133f
4704   139D                     
4705   139D                     ; If there are 2 players, advance the substate to 23
4706   139D 0E 17               ld      c,23
4707   139F                     
4708   139F 79          l133f:  ld      a,c
4709   13A0 32 0A 60            ld      (GAME_SUBSTATE),a
4710   13A3 C9                  ret     
4711   13A4             ;------------------------------------------------------------------------------
4712   13A4             
4713   13A4             
4714   13A4             ;------------------------------------------------------------------------------
4715   13A4             ; After death processing for player 1.  Remove a life, and end the player's 
4716   13A4             ; game if there are no more lives left.  
4717   13A4             L_POST_DEATH_PROCESSING_P2:  
4718   13A4 CD 0F 01    		call    L_SOUNDS_OFF
4719   13A7                     
4720   13A7                     ; Set the intro as having been displayed for the current player
4721   13A7 AF                  xor     a
4722   13A8 32 2C 62            ld      (CP_INTRO_NOT_DISPLAYED),a
4723   13AB                     
4724   13AB                     ; Subtract a life
4725   13AB 21 28 62            ld      hl,CP_NUMBER_LIVES
4726   13AE 35                  dec     (hl)
4727   13AF 7E                  ld      a,(hl)
4728   13B0                     
4729   13B0                     ; Save the current player data to the first player data
4730   13B0 11 48 60            ld      de,P2_NUMBER_LIVES
4731   13B3 01 08 00            ld      bc,8
4732   13B6 ED B0               ldir    
4733   13B8                     
4734   13B8                     ; If player 1 has more lives, jump ahead
4735   13B8 A7                  and     a
4736   13B9 20 23               jr      nz,l137f
4737   13BB                     
4738   13BB                     ; Check if player 1's score qualifies for the high score list
4739   13BB 3E 03               ld      a,3						; Player 2 ID
4740   13BD 21 B5 60            ld      hl,PREV_P2_SCORE
4741   13C0 CD 26 14            call    L_ADD_SCORE_TO_HS_TABLE
4742   13C3                     
4743   13C3                     ; Display the player II string
4744   13C3 11 03 03            ld      de,$0303
4745   13C6 CD 36 31            call    L_ADD_EVENT
4746   13C9                     
4747   13C9                     ; Display "GAME OVER"
4748   13C9 11 00 03            ld      de,$0300
4749   13CC CD 36 31            call    L_ADD_EVENT
4750   13CF 21 D3 76            ld      hl,TILE_COORD(22,19)
4751   13D2 CD A1 18            call    L_CLEAR_AROUND_GAME_OVER
4752   13D5                     
4753   13D5                     ; Set the minor timer to 192
4754   13D5 21 09 60            ld      hl,MINOR_TIMER
4755   13D8 36 C0               ld      (hl),192
4756   13DA                     
4757   13DA                     ; Set game substate to 17 and return
4758   13DA 23                  inc     hl
4759   13DB 36 11               ld      (hl),$11
4760   13DD C9                  ret     
4761   13DE                     
4762   13DE                     ; If player 1 has lives left, jump ahead to advance to game substate 23
4763   13DE 0E 17       l137f:  ld      c,$17
4764   13E0 3A 40 60            ld      a,(P1_NUMBER_LIVES)
4765   13E3 A7                  and     a
4766   13E4 20 02               jr      nz,l138a
4767   13E6                     
4768   13E6                     ; If player 1 has no more lives, advance to substate 8
4769   13E6 0E 08               ld      c,8
4770   13E8 79          l138a:  ld      a,c
4771   13E9 32 0A 60            ld      (GAME_SUBSTATE),a
4772   13EC C9                  ret     
4773   13ED             ;------------------------------------------------------------------------------
4774   13ED             
4775   13ED             
4776   13ED             
4777   13ED             ;------------------------------------------------------------------------------
4778   13ED             ; This function is called when Player 1's game is over.
4779   13ED             ; It checks if Player 2 has lives left and advances to the appropriate substate
4780   13ED             L_ADV_FROM_P1_GAME_OVER:  
4781   13ED             		; Return until the minor timer runs down
4782   13ED DF          		rst     $18
4783   13EE             		
4784   13EE             		; If player 2 has more lives, jump ahead to advance to substate 23
4785   13EE             		; (move on to the next player)
4786   13EE 0E 17               ld      c,23
4787   13F0 3A 48 60            ld      a,(P2_NUMBER_LIVES)
4788   13F3 34          l1395:  inc     (hl)						; MINOR_TIMER = 1
4789   13F4 A7                  and     a
4790   13F5 20 02               jr      nz,l139c
4791   13F7                     
4792   13F7                     ; If player 2 has no more lives, advance to substate 20
4793   13F7                     ; (Check if high scores need to be entered)
4794   13F7 0E 14               ld      c,20
4795   13F9 79          l139c:  ld      a,c
4796   13FA 32 0A 60            ld      (GAME_SUBSTATE),a
4797   13FD C9                  ret     
4798   13FE             ;------------------------------------------------------------------------------
4799   13FE             
4800   13FE             
4801   13FE             
4802   13FE             ;------------------------------------------------------------------------------
4803   13FE             ; This function is called when Player 2's game is over.
4804   13FE             ; It checks if Player 1 has lives left and advances to the appropriate substate
4805   13FE             L_ADV_FROM_P2_GAME_OVER:  
4806   13FE             		; Return until the minor timer runs down
4807   13FE DF          		rst     $18
4808   13FF             		
4809   13FF                     ; If player 1 has more lives, jump ahead to advance to substate 23
4810   13FF             		; (move on to the next player)
4811   13FF             		; If player 1 has no more lives left, advance to substate 20 
4812   13FF             		; (Check if high scores need to be entered)
4813   13FF 0E 17       		ld      c,23
4814   1401 3A 40 60            ld      a,(P1_NUMBER_LIVES)
4815   1404 18 ED               jr      l1395
4816   1406             ;------------------------------------------------------------------------------
4817   1406             
4818   1406             
4819   1406             
4820   1406             ;------------------------------------------------------------------------------
4821   1406             ; Prepare for player 2's turn.  
4822   1406             ; Orient the screen and activate player 2. 
4823   1406             L_PREPARE_FOR_P2_TURN:  
4824   1406             		; Orient the screen for player 2
4825   1406             		; (Flipped vertically for cocktail cabinets) 
4826   1406 3A 26 60    		ld      a,(CABINET_TYPE)
4827   1409 32 82 7D            ld      (SCREEN_ORIENTATION),a
4828   140C                     
4829   140C                     ; Set substate to 0
4830   140C AF                  xor     a
4831   140D 32 0A 60            ld      (GAME_SUBSTATE),a
4832   1410                     
4833   1410                     ; Activate player 2
4834   1410                     ; Set CURRENT_PLAYER to 1 (player 2)
4835   1410                     ; and SECOND_PLAYER to 1
4836   1410 21 01 01            ld      hl,TWO_BYTES(1,1)
4837   1413 22 0D 60            ld      (CURRENT_PLAYER),hl
4838   1416 C9                  ret     
4839   1417             ;------------------------------------------------------------------------------
4840   1417             
4841   1417             
4842   1417             
4843   1417             ;------------------------------------------------------------------------------
4844   1417             ; Prepare for player 2's turn.  
4845   1417             ; Orient the screen and activate player 2. 
4846   1417             L_PREPARE_FOR_P1_TURN:  
4847   1417             		; Activate player 1
4848   1417 AF          		xor     a
4849   1418 32 0D 60            ld      (CURRENT_PLAYER),a
4850   141B 32 0E 60            ld      (SECOND_PLAYER),a
4851   141E                     
4852   141E                     ; Set substate to 0
4853   141E 32 0A 60            ld      (GAME_SUBSTATE),a
4854   1421                     
4855   1421                     ; Orient the screen upright
4856   1421 3C          		inc     a
4857   1422 32 82 7D            ld      (SCREEN_ORIENTATION),a
4858   1425 C9                  ret     
4859   1426             ;------------------------------------------------------------------------------
4860   1426             
4861   1426             
4862   1426             
4863   1426             ;------------------------------------------------------------------------------
4864   1426             ; Check if the player's score needs to be added to the high score table and
4865   1426             ; insert it.
4866   1426             ; I won't pretend that I've actually analyzed this code enough to really 
4867   1426             ; understand what it's doing...
4868   1426             ; passed:	a - the number of the player whose score is being checked
4869   1426             ;				(1 for player 1, 3 for player 2)
4870   1426             ;			hl - the address of the player's score
4871   1426             L_ADD_SCORE_TO_HS_TABLE:  
4872   1426             		
4873   1426 11 C6 61    		ld      de,$61c6
4874   1429 12                  ld      (de),a
4875   142A                     
4876   142A                     ; Return if the demo mode is active
4877   142A CF                  rst     $08
4878   142B                     
4879   142B                     ; Copy the current player's score to $61c7
4880   142B 13                  inc     de
4881   142C 01 03 00            ld      bc,3						; 3 bytes to copy
4882   142F ED B0               ldir    
4883   1431                     
4884   1431                     ; Separate and store each digit in the score
4885   1431 06 03               ld      b,3						; For b = 3 to 1
4886   1433 21 B1 61            ld      hl,CURRENT_SCORE_STRING
4887   1436                     
4888   1436                     ; Isolate the MS nibble of the previous byte of the score
4889   1436 1B          l13da:  dec     de
4890   1437 1A                  ld      a,(de)
4891   1438 0F                  rrca    
4892   1439 0F                  rrca    
4893   143A 0F                  rrca    
4894   143B 0F                  rrca    
4895   143C E6 0F               and     %00001111
4896   143E                     
4897   143E                     ; Save this digit 
4898   143E 77                  ld      (hl),a
4899   143F 23                  inc     hl
4900   1440                     
4901   1440                     ; Isolate the LS nibble
4902   1440 1A                  ld      a,(de)
4903   1441 E6 0F               and     %00001111
4904   1443                     
4905   1443                     ; Save the digit
4906   1443 77                  ld      (hl),a
4907   1444 23                  inc     hl
4908   1445                     
4909   1445 10 EF               djnz    l13da						; Next b
4910   1447                     
4911   1447                     ; Clear the next 14 bytes of the score string
4912   1447 06 0E               ld      b,14
4913   1449 36 10       l13ed:  ld      (hl),$10					; Space
4914   144B 23                  inc     hl
4915   144C 10 FB               djnz    l13ed
4916   144E                     
4917   144E                     ; Mark the end of the high score string
4918   144E 36 3F               ld      (hl),$3F
4919   1450                     
4920   1450 06 05               ld      b,5
4921   1452                     
4922   1452                     ; Subtract the current high score entry from the current player's score
4923   1452                     ; Return if the high score is higher than the player's score
4924   1452 21 A5 61            ld      hl,$61a5
4925   1455 11 C7 61            ld      de,$61c7
4926   1458 1A          l13fc:  ld      a,(de)
4927   1459 96                  sub     (hl)
4928   145A 23                  inc     hl
4929   145B 13                  inc     de
4930   145C 1A                  ld      a,(de)
4931   145D 9E                  sbc     a,(hl)
4932   145E 23                  inc     hl
4933   145F 13                  inc     de
4934   1460 1A                  ld      a,(de)
4935   1461 9E                  sbc     a,(hl)
4936   1462 D8                  ret     c
4937   1463                     
4938   1463                     ; Add the player's score to the high score table
4939   1463 C5                  push    bc
4940   1464 06 19               ld      b,25
4941   1466 4E          l140a:  ld      c,(hl)
4942   1467 1A                  ld      a,(de)
4943   1468 77                  ld      (hl),a
4944   1469 79                  ld      a,c
4945   146A 12                  ld      (de),a
4946   146B 2B                  dec     hl
4947   146C 1B                  dec     de
4948   146D 10 F7               djnz    l140a
4949   146F                     
4950   146F 01 F5 FF            ld      bc,-11
4951   1472 09                  add     hl,bc
4952   1473 EB                  ex      de,hl
4953   1474 09                  add     hl,bc
4954   1475 EB                  ex      de,hl
4955   1476 C1                  pop     bc
4956   1477 10 DF               djnz    l13fc
4957   1479 C9                  ret     
4958   147A             ;------------------------------------------------------------------------------
4959   147A             
4960   147A             
4961   147A             ;------------------------------------------------------------------------------
4962   147A             ; Determines if either player needs to enter high score initials
4963   147A             L_CHECK_FOR_HS_INITIALS:  
4964   147A CD FA 05    		call    L_DISPLAY_CREDITS_2
4965   147D                     
4966   147D                     ; Return until the minor timer runs down
4967   147D DF          		rst     $18
4968   147E                     
4969   147E CD 3D 08            call    L_CLEAR_STAGE_SCREEN
4970   1481                     
4971   1481                     ; Activate player 1
4972   1481 AF                  xor     a
4973   1482 32 0E 60            ld      (SECOND_PLAYER),a
4974   1485 32 0D 60            ld      (CURRENT_PLAYER),a
4975   1488                     
4976   1488 21 1C 61            ld      hl,HIGH_SCORE_TABLE_ENTRY_1+28	; Player ID
4977   148B 11 22 00            ld      de,34					; 34 byte data structure
4978   148E 06 05               ld      b,5						; For b = 5 to 1 (5 high score entries)
4979   1490                     
4980   1490                     ; If this score was earned by player 1, jump ahead
4981   1490 3E 01               ld      a,1						; Player 1 ID
4982   1492 BE          l1437:  cp      (hl)
4983   1493 28 1C               jr      z,l1459
4984   1495                     
4985   1495                     ; Check the next high score entry
4986   1495 19                  add     hl,de
4987   1496 10 FA               djnz    l1437						; Next b
4988   1498                     
4989   1498 21 1C 61            ld      hl,HIGH_SCORE_TABLE_ENTRY_1+28	; Player ID
4990   149B 06 05               ld      b,5						; For b = 5 to 1 (5 high score entries)
4991   149D                     
4992   149D                     ; If this score was earned by player 2, jump ahead
4993   149D 3E 03               ld      a,3						; Player 2 ID   
4994   149F BE          l1445:  cp      (hl)
4995   14A0 28 06               jr      z,l144f
4996   14A2                     
4997   14A2                     ; Check the next high score entry
4998   14A2 19                  add     hl,de
4999   14A3 10 FA               djnz    l1445						; Next b
5000   14A5                     
5001   14A5                     ; If neither player earned a high score, start the game
5002   14A5 C3 CC 14            jp      L_RESTART_GAME				; Exceeds relative branch
5003   14A8                     
5004   14A8                     ; Activate player 2
5005   14A8 3E 01       l144f:  ld      a,1
5006   14AA 32 0E 60            ld      (SECOND_PLAYER),a
5007   14AD 32 0D 60            ld      (CURRENT_PLAYER),a
5008   14B0                     
5009   14B0                     ; Orient the screen for the player with the high score
5010   14B0 AF                  xor     a
5011   14B1 21 26 60    l1459:  ld      hl,CABINET_TYPE
5012   14B4 B6                  or      (hl)
5013   14B5 32 82 7D            ld      (SCREEN_ORIENTATION),a
5014   14B8                     
5015   14B8                     ; Advance to the next substate
5016   14B8 AF                  xor     a
5017   14B9 32 09 60            ld      (MINOR_TIMER),a
5018   14BC 21 0A 60            ld      hl,GAME_SUBSTATE
5019   14BF 34                  inc     (hl)
5020   14C0                     
5021   14C0                     ; Display 
5022   14C0                     ; "NAME REGISTRATION"
5023   14C0                     ; "NAME:"
5024   14C0             		; "---         "
5025   14C0             		; "A B C D E F G H I J"
5026   14C0             		; "K L M N O P Q R S T"
5027   14C0             		; "U V W X Y Z . -RUBEND "
5028   14C0             		; "REGI TIME  (30) "
5029   14C0             		; and the 5 high scores
5030   14C0 11 0D 03    		ld      de,$030d
5031   14C3 06 0C               ld      b,12						; For b = 12 to 1 (12 strings to display)
5032   14C5 CD 36 31    l146e:  call    L_ADD_EVENT
5033   14C8 13                  inc     de						; Next string
5034   14C9 10 FA               djnz    l146e					; Next b
5035   14CB C9                  ret     
5036   14CC             ;------------------------------------------------------------------------------
5037   14CC             
5038   14CC             
5039   14CC             
5040   14CC             ;------------------------------------------------------------------------------
5041   14CC             ; Restart the game to waiting for a coin
5042   14CC             L_RESTART_GAME:  
5043   14CC AF                  xor		a
5044   14CD 32 0A 60            ld      (GAME_SUBSTATE),a
5045   14D0 3C          		inc		a
5046   14D1 32 82 7D            ld      (SCREEN_ORIENTATION),a
5047   14D4 32 05 60            ld      (GAME_STATE),a
5048   14D7 32 07 60            ld      (NO_COINS_INSERTED),a
5049   14DA C9                  ret     
5050   14DB             ;------------------------------------------------------------------------------
5051   14DB             
5052   14DB             
5053   14DB             
5054   14DB             ;------------------------------------------------------------------------------
5055   14DB             ; This function implements the high score initial entry screen
5056   14DB             ; The user is allowed to navigate through the initial letters and enter their 
5057   14DB             ; initials.
5058   14DB             ;
5059   14DB             ; Note: it appears that it would not be difficult to alter this code to allow
5060   14DB             ;	   names of up to 12 characters to be entered
5061   14DB             L_IMPLEMENT_HS_INITIAL_ENTRY:  
5062   14DB CD FA 05    		call    L_DISPLAY_CREDITS_2
5063   14DE             
5064   14DE             		; Jump ahead if the minor timer has not run out
5065   14DE 21 09 60            ld      hl,MINOR_TIMER
5066   14E1 7E                  ld      a,(hl)
5067   14E2 A7                  and     a
5068   14E3 20 4A               jr      nz,l14dc
5069   14E5                     
5070   14E5                     ; Palette 00
5071   14E5 32 86 7D            ld      (PALETTE_1_OUTPUT),a
5072   14E8 32 87 7D            ld      (PALETTE_2_OUTPUT),a
5073   14EB                     
5074   14EB                     ; Set minor timer to 1
5075   14EB 36 01               ld      (hl),1
5076   14ED                     
5077   14ED                     ; Initialize JOYSTICK_INPUT_DELAY to 10
5078   14ED 21 30 60            ld      hl,JOYSTICK_INPUT_DELAY
5079   14F0 36 0A               ld      (hl),10
5080   14F2                     
5081   14F2                     ; Set 
5082   14F2 23                  inc     hl
5083   14F3 36 00               ld      (hl),0					; BLANK_CP_HIGH_SCORE
5084   14F5                     
5085   14F5 23                  inc     hl
5086   14F6 36 10               ld      (hl),16					; BLINK_SCORE_TIMER
5087   14F8                     
5088   14F8 23                  inc     hl
5089   14F9 36 1E               ld      (hl),30					; INITIALS_TIMER_VALUE
5090   14FB                     
5091   14FB 23                  inc     hl
5092   14FC 36 3E               ld      (hl),62					; INITIALS_TIMER_DELAY				
5093   14FE                     
5094   14FE 23                  inc     hl
5095   14FF 36 00               ld      (hl),0					; SELECTED_LETTER
5096   1501                     
5097   1501 21 E8 75            ld      hl,TILE_COORD(15,8)
5098   1504 22 36 60            ld      (INITIALS_COORD),hl
5099   1507                     
5100   1507                     ; Determine this player's ID (1 = player 1, 3 = player 2)
5101   1507 21 1C 61            ld      hl,HIGH_SCORE_TABLE_ENTRY_1+28 ; Player ID
5102   150A 3A 0E 60            ld      a,(SECOND_PLAYER)
5103   150D 07                  rlca    
5104   150E 3C                  inc     a
5105   150F 4F                  ld      c,a
5106   1510                     
5107   1510                     ; Check each high score entry to find the one for this player
5108   1510 11 22 00            ld      de,34						; 34 byte high score data structure
5109   1513 06 04               ld      b,4						; For b = 4 to 1
5110   1515 7E          l14c1:  ld      a,(hl)
5111   1516 B9                  cp      c
5112   1517 28 03               jr      z,l14c9
5113   1519 19                  add     hl,de						; Next high score entry
5114   151A 10 F9               djnz    l14c1						; Next b
5115   151C                     
5116   151C                     ; Save the address of the high score entry player ID
5117   151C 22 38 60    l14c9:  ld      (PLAYER_ID_ADDRESS),hl
5118   151F             
5119   151F             		; Save the position in the string to write the player's initials to
5120   151F 11 F3 FF            ld      de,-13
5121   1522 19                  add     hl,de
5122   1523 22 3A 60            ld      (INITIALS_ADDRESS),hl
5123   1526             		
5124   1526             		; Display the letter selection box over the currently selected letter 
5125   1526             		; (initially 'A')
5126   1526 06 00               ld      b,0
5127   1528 3A 35 60            ld      a,(SELECTED_LETTER)
5128   152B 4F                  ld      c,a
5129   152C CD 36 16            call    L_UPDATE_LETTER_SEL_BOX
5130   152F             		
5131   152F             		; If the initials timer delay has not run down, jump ahead to skip
5132   152F             		; decrementing and displaying the initials timer value
5133   152F 21 34 60    l14dc:  ld      hl,INITIALS_TIMER_DELAY
5134   1532 35                  dec     (hl)
5135   1533 20 18               jr      nz,l14fc
5136   1535             		
5137   1535             		; Reset the initials timer delay
5138   1535 36 3E               ld      (hl),62
5139   1537             		
5140   1537             		; Decrement the initials countdown timer and jump ahead, if it has reached zero
5141   1537 2B                  dec     hl
5142   1538 35                  dec     (hl)
5143   1539 CA 02 16            jp      z,l15c6						; Exceeds relative branch
5144   153C                     
5145   153C             		; Determine the 10's (a) and 1's (b) digit of the initials timer value
5146   153C 7E          		ld      a,(hl)
5147   153D 06 FF               ld      b,255
5148   153F 04          l14ed:  inc     b
5149   1540 D6 0A               sub     10
5150   1542 30 FB               jr      nc,l14ed
5151   1544 C6 0A               add     a,10
5152   1546             		
5153   1546             		; Display the 10's digit
5154   1546 32 52 75            ld      (TILE_COORD(10,18)),a
5155   1549             		
5156   1549             		; Display the 1's digit
5157   1549 78                  ld      a,b
5158   154A 32 72 75            ld      (TILE_COORD(11,18)),a
5159   154D             		
5160   154D             		; Initialize the joystick input delay to 10
5161   154D 21 30 60    l14fc:  ld      hl,JOYSTICK_INPUT_DELAY
5162   1550 46                  ld      b,(hl)
5163   1551 36 0A               ld      (hl),10
5164   1553             		
5165   1553             		; If the player has pushed the JUMP button (to select the current letter),
5166   1553             		; jump ahead to process it
5167   1553 3A 10 60            ld      a,(PLAYER_INPUT)
5168   1556 CB 7F               bit     7,a
5169   1558 20 33               jr      nz,l1546
5170   155A             		
5171   155A             		; If the player has pushed the joystick either LEFT or RIGHT (to change the
5172   155A             		; current letter), jump ahead to process it
5173   155A E6 03               and     %00000011
5174   155C 20 04               jr      nz,l1514
5175   155E             		
5176   155E             		; The joystick is not currently being pressed in any direction
5177   155E             		; so set the joystick input delay to 1 so the next time the joystick
5178   155E             		; is used, it will be processed immediately 
5179   155E 3C                  inc     a							; a = 1
5180   155F 77                  ld      (hl),a
5181   1560             		
5182   1560             		; Jump ahead to blink the current player's high score
5183   1560 18 68               jr      l158a
5184   1562             		
5185   1562             		; Decrement the joystick input delay
5186   1562             		; Jump ahead to handle the input only if the delay has reached 0
5187   1562             		; (Otherwise the input is ignored)
5188   1562 05          l1514:  dec     b
5189   1563 28 04               jr      z,l151d
5190   1565 78                  ld      a,b
5191   1566 77                  ld      (hl),a
5192   1567             		
5193   1567             		; Jump ahead to blink the current player's high score
5194   1567 18 61               jr      l158a
5195   1569             		
5196   1569             		; If the player pushed the joystick LEFT, jump ahead to process it
5197   1569 CB 4F       l151d:  bit     1,a
5198   156B 20 14               jr      nz,l1539
5199   156D             		
5200   156D             		; The player pushed the joystick RIGHT
5201   156D             		; Select the next letter to the right
5202   156D 3A 35 60            ld      a,(SELECTED_LETTER)
5203   1570 3C                  inc     a
5204   1571                     
5205   1571                     ; If the letter selection does not need to wrap, jump ahead 
5206   1571 FE 1E               cp      30
5207   1573 20 01               jr      nz,l152d
5208   1575                     
5209   1575                     ; Wrap the letter selection back to the first letter
5210   1575 AF                  xor     a
5211   1576                     
5212   1576                     ; Move the letter selection sprite to the newly selected letter
5213   1576 32 35 60    l152d:  ld      (SELECTED_LETTER),a
5214   1579 4F                  ld      c,a
5215   157A 06 00               ld      b,0
5216   157C CD 36 16            call    L_UPDATE_LETTER_SEL_BOX
5217   157F                     
5218   157F                     ; Jump ahead to blink the current player's high score
5219   157F 18 49               jr      l158a
5220   1581                     
5221   1581                     ; The player pushed thw joystick LEFT
5222   1581                     ; Select the next letter to the left
5223   1581 3A 35 60    l1539:  ld      a,(SELECTED_LETTER)
5224   1584 D6 01               sub     1
5225   1586                     
5226   1586                     ; If the letter selection does not need to be wrapped around, 
5227   1586                     ; jump back up to update the letter selection box sprite
5228   1586 F2 76 15            jp      p,l152d
5229   1589                     
5230   1589                     ; Wrap the letter selection box around to the last letter
5231   1589 3E 1D               ld      a,29
5232   158B                     
5233   158B                     ; Jump back up to update the letter selection box sprite
5234   158B 18 E9               jr      l152d
5235   158D                     
5236   158D                     ; The player pushed the JUMP button
5237   158D                     ; If "RUB" was selected, jump ahead to process it
5238   158D 3A 35 60    l1546:  ld      a,(SELECTED_LETTER)
5239   1590 FE 1C               cp      28
5240   1592 28 1C               jr      z,l156d
5241   1594                     
5242   1594                     ; If "END" was selected, jump ahead to process it
5243   1594 FE 1D               cp      29
5244   1596 28 6A               jr      z,l15c6
5245   1598                     
5246   1598                     ; If the last initial entry position has been reached, 
5247   1598                     ; jump ahead to skip the letter selection and blink the current player's score
5248   1598 2A 36 60            ld      hl,(INITIALS_COORD)
5249   159B 01 88 75            ld      bc,TILE_COORD(12,8)
5250   159E A7                  and     a						; Clear the carry flag
5251   159F ED 42               sbc     hl,bc
5252   15A1 28 27               jr      z,l158a
5253   15A3                     
5254   15A3                     ; Convert the selected letter index to the actual letter
5255   15A3 09                  add     hl,bc
5256   15A4 C6 11               add     a,17
5257   15A6                     
5258   15A6                     ; Display the selected letter
5259   15A6 77                  ld      (hl),a
5260   15A7                     
5261   15A7                     ; Advance to the next initial letter entry coordinate
5262   15A7 01 E0 FF            ld      bc,-32
5263   15AA 09                  add     hl,bc
5264   15AB 22 36 60    l1567:  ld      (INITIALS_COORD),hl
5265   15AE             
5266   15AE             		; Jump ahead to blink the current player's high score
5267   15AE 18 1A               jr      l158a
5268   15B0                     
5269   15B0                     ; "RUB" was selected
5270   15B0                     ; Move left one initial letter entry coordinate
5271   15B0 2A 36 60    l156d:  ld      hl,(INITIALS_COORD)
5272   15B3 01 20 00            ld      bc,32
5273   15B6 09                  add     hl,bc
5274   15B7                     
5275   15B7                     ; If the first initial entry coordinate has not been reached,
5276   15B7                     ; jump ahead  
5277   15B7 A7                  and     a						; Clear the carry flag
5278   15B8 01 08 76            ld      bc,TILE_COORD(16,8)
5279   15BB ED 42               sbc     hl,bc
5280   15BD 20 08               jr      nz,l1586
5281   15BF                     
5282   15BF                     ; Keep the initial letter entry from going past the first entry coordinate
5283   15BF 21 E8 75            ld      hl,TILE_COORD(15,8)
5284   15C2                     
5285   15C2                     ; Erase the initial letter
5286   15C2 3E 10       l1580:  ld      a,$10
5287   15C4 77                  ld      (hl),a
5288   15C5 18 E4               jr      l1567
5289   15C7                     
5290   15C7                     ; Erase the initial letter to the left
5291   15C7 09          l1586:  add     hl,bc
5292   15C8 18 F8               jr      l1580
5293   15CA             				
5294   15CA             		; If the blink timer has not run down, jump ahead
5295   15CA 21 32 60    l158a:  ld      hl,BLINK_SCORE_TIMER
5296   15CD 35                  dec     (hl)
5297   15CE 20 65               jr      nz,l15f9
5298   15D0             		
5299   15D0             		; If the blank score toggle is currently off, jump ahead to turn it on
5300   15D0             		; and display the current player's high score
5301   15D0 3A 31 60            ld      a,(BLANK_CP_HIGH_SCORE)
5302   15D3 A7                  and     a
5303   15D4 20 1F               jr      nz,l15b8
5304   15D6             		
5305   15D6             		; Turn the blank score toggle on to cause the score to be blinked off
5306   15D6 3E 01               ld      a,1
5307   15D8 32 31 60            ld      (BLANK_CP_HIGH_SCORE),a
5308   15DB             		
5309   15DB             		; Load the address of blank score data
5310   15DB 11 B0 01            ld      de,L_BLANK_SCORE_DATA
5311   15DE             		
5312   15DE             		; Load the screen coordinate to display the current player's high score
5313   15DE FD 2A 38 60 l15a0:  ld      iy,(PLAYER_ID_ADDRESS)
5314   15E2 FD 6E 04            ld      l,(iy+4)
5315   15E5 FD 66 05            ld      h,(iy+5)
5316   15E8             		
5317   15E8             		; Display the high score (or the blank score data)
5318   15E8 E5                  push    hl
5319   15E9 DD E1               pop     ix							; The screen coordinate
5320   15EB CD 68 05            call    L_DISPLAY_HIGH_SCORE_2
5321   15EE             		
5322   15EE             		; Reset the blink score timer to 16
5323   15EE 3E 10               ld      a,16
5324   15F0 32 32 60            ld      (BLINK_SCORE_TIMER),a
5325   15F3             		
5326   15F3 18 40               jr      l15f9
5327   15F5             		
5328   15F5             		; Toggle display of the score off
5329   15F5 AF          l15b8:  xor     a
5330   15F6 32 31 60            ld      (BLANK_CP_HIGH_SCORE),a
5331   15F9             		
5332   15F9             		; Set DE to the last byte of the high score BCD entry
5333   15F9 ED 5B 38 60         ld      de,(PLAYER_ID_ADDRESS)
5334   15FD 13                  inc     de
5335   15FE 13                  inc     de
5336   15FF 13                  inc     de
5337   1600             		
5338   1600             		; Jump back up to blank the score
5339   1600 18 DC               jr      l15a0
5340   1602             		
5341   1602             		; Clear the player ID, for this high score entry as it is no longer needed
5342   1602 ED 5B 38 60 l15c6:  ld      de,(PLAYER_ID_ADDRESS)
5343   1606 AF                  xor     a
5344   1607 12                  ld      (de),a
5345   1608             		
5346   1608             		; Reset the minor timer to 128
5347   1608 21 09 60            ld      hl,MINOR_TIMER
5348   160B 36 80               ld      (hl),128
5349   160D             		
5350   160D             		; Decrement the game substate
5351   160D 23          l15d1:  inc     hl
5352   160E 35                  dec     (hl)
5353   160F             		
5354   160F             		; Copy the initials the player entered to the high score entry
5355   160F             		; NOTE: Although only 3 initials are accepted, 12 characters are copied
5356   160F             		;		Is it possible, the programmers originally intended to use all 12
5357   160F             		;		characters for the player's name?
5358   160F 06 0C               ld      b,12						; For b = 12 to 1 (12 characters to copy)
5359   1611 21 E8 75            ld      hl,TILE_COORD(15,8)
5360   1614 FD 2A 3A 60         ld      iy,(INITIALS_ADDRESS)
5361   1618 11 E0 FF            ld      de,-32
5362   161B 7E          l15df:  ld      a,(hl)
5363   161C FD 77 00            ld      (iy+0),a
5364   161F FD 23               inc     iy
5365   1621 19                  add     hl,de
5366   1622 10 F7               djnz    l15df						; Next b
5367   1624             		
5368   1624             		; Redisplay the high score table
5369   1624 06 05               ld      b,5							; For b = 5 to 1 (5 high scores to redisplay)
5370   1626 11 14 03            ld      de,$0314
5371   1629 CD 36 31    l15ed:  call    L_ADD_EVENT
5372   162C 13                  inc     de
5373   162D 10 FA               djnz    l15ed						; Next b
5374   162F             		
5375   162F             		; Display "YOUR NAME WAS REGISTERED"
5376   162F 11 1A 03            ld      de,$031a					
5377   1632 CD 36 31            call    L_ADD_EVENT
5378   1635             		
5379   1635 C9          l15f9:  ret     
5380   1636             ;------------------------------------------------------------------------------
5381   1636             
5382   1636             
5383   1636             
5384   1636             ;------------------------------------------------------------------------------
5385   1636             ; Update the letter selection sprite on the High Score entry screen over the
5386   1636             ; currently selected letter
5387   1636             ;
5388   1636             ; passed:	bc - the index number of the currently selected letter in the 
5389   1636             ;				high score letter coordinate table
5390   1636             L_UPDATE_LETTER_SEL_BOX:  
5391   1636 D5          		push    de
5392   1637 E5                  push    hl
5393   1638             		
5394   1638             		; Multiply the letter index by two to convert it to a table offset
5395   1638 CB 21               sla     c
5396   163A             		
5397   163A             		; Look up the letter coordinates in the table
5398   163A 21 20 36            ld      hl,L_HS_LETTER_COORD_TABLE
5399   163D 09                  add     hl,bc
5400   163E EB                  ex      de,hl
5401   163F             		
5402   163F             		; Position the letter selection box sprite over the selected letter
5403   163F 21 74 69            ld      hl,ELEVATOR_MOTOR_SPRITE_2_X	; Used in this case for the letter selection box sprite
5404   1642 1A                  ld      a,(de)
5405   1643 13                  inc     de
5406   1644 77                  ld      (hl),a						; X coordinate
5407   1645 23                  inc     hl
5408   1646 36 72               ld      (hl),$72					; Letter selection box sprite
5409   1648 23                  inc     hl
5410   1649 36 0C               ld      (hl),$0c					; Palette
5411   164B 23                  inc     hl
5412   164C 1A                  ld      a,(de)						; Y coordinate
5413   164D 77                  ld      (hl),a
5414   164E             		
5415   164E E1                  pop     hl
5416   164F D1                  pop     de
5417   1650                     
5418   1650 C9          		ret     
5419   1651             ;------------------------------------------------------------------------------
5420   1651             
5421   1651             
5422   1651             
5423   1651             ;------------------------------------------------------------------------------
5424   1651             ; Display each stage of the standard stage win animation
5425   1651             ; The win animations for the mixer and rivets stages are handled elsewhere
5426   1651             L_IMPLEMENT_STAGE_WIN_ANIM:  
5427   1651 CD 52 31    		call    L_CLEAR_SPRITES_WHEN_DEAD
5428   1654             		
5429   1654             		; If the current stage is secret, 
5430   1654             		; jump ahead to animate its win animation
5431   1654 3A 27 62            ld      a,(CURRENT_STAGE)
5432   1657 FE 05       		cp		5
5433   1659 28 37       		jr		z,L_IMPLEMENT_SECRET_WIN_ANIM
5434   165B             		
5435   165B             		; If the current stage is mixer or rivets, jump ahead for 
5436   165B             		; their win animations
5437   165B 0F                  rrca    
5438   165C 30 10               jr      nc,L_IMPLEMENT_MIXER_WIN_ANIM
5439   165E                     
5440   165E                     ; Jump based on the state of the win animation
5441   165E 3A 88 63            ld      a,(WIN_ANIMATION_STATE)
5442   1661 EF          l1622:  rst     $28							; Jump to local table address
5443   1662             		; Jump table
5444   1662 A6 16               .word	L_WIN_STAGE_ANIM_0	; 0 = Donkey Kong climbing animation 0
5445   1664 C2 16       		.word	L_WIN_STAGE_ANIM_1	; 1 = Donkey Kong climbing animation 1
5446   1666 DC 16       		.word	L_WIN_STAGE_ANIM_2	; 2 = Donkey Kong climbing animation 2
5447   1668 8B 17       		.word	L_WIN_STAGE_ANIM_3	; 3 = Donkey Kong climbing animation 3 (Donkey Kong grabs Pauline)
5448   166A BC 17       		.word	L_WIN_STAGE_ANIM_4	; 4 = Donkey Kong climbing animation 4
5449   166C F2 17       		.word	L_ADVANCE_TO_NEXT_STAGE	; 5 = Donkey Kong climbing animation 5
5450   166E             ;------------------------------------------------------------------------------
5451   166E             
5452   166E             
5453   166E             
5454   166E             ;------------------------------------------------------------------------------
5455   166E             ; Display each stage of the mixer stage win animation
5456   166E             ; The win animations for the rivets stage is handled elsewhere
5457   166E             L_IMPLEMENT_MIXER_WIN_ANIM:  
5458   166E             		; If this is the rivets stage, jump ahead to implement that win animation
5459   166E 0F          		rrca    
5460   166F 30 0E               jr 		nc,L_IMPLEMENT_RIVETS_WIN_ANIM
5461   1671                     
5462   1671 3A 88 63            ld      a,(WIN_ANIMATION_STATE)
5463   1674 EF                  rst     $28							; Jump to local table address
5464   1675             		; Jump table
5465   1675 F4 16       		.word	L_MIXER_WIN_STAGE_ANIM_0	; 0 = 
5466   1677 0C 17       		.word	L_WAIT_FOR_DK_TO_REACH_LADDERS	; 1 = 
5467   1679 8B 17       		.word	L_WIN_STAGE_ANIM_3	; 2 = 
5468   167B BC 17       		.word	L_WIN_STAGE_ANIM_4	; 3 = 
5469   167D F2 17       		.word	L_ADVANCE_TO_NEXT_STAGE	; 4 = 
5470   167F             ;------------------------------------------------------------------------------
5471   167F             
5472   167F             
5473   167F             
5474   167F             ;------------------------------------------------------------------------------
5475   167F             L_IMPLEMENT_RIVETS_WIN_ANIM:  
5476   167F CD C4 1E    		call    L_IMPLEMENT_POINT_AWARD
5477   1682 3A 88 63            ld      a,(WIN_ANIMATION_STATE)
5478   1685 EF                  rst     $28							; Jump to local table address
5479   1686             		; Jump table
5480   1686 32 18       		.word	L_RIVETS_WIN_STAGE_ANIM_0	; 0 = 
5481   1688 00 31       		.word	L_PAUSE_CURRENT_STATE		; 1 = 
5482   168A B3 18       		.word	L_RIVETS_WIN_STAGE_ANIM_1	; 2 = 
5483   168C E8 18       		.word	L_RIVETS_WIN_STAGE_ANIM_2	; 3 = 
5484   168E F9 18       		.word	L_RIVETS_WIN_STAGE_ANIM_3	; 4 = 
5485   1690 3B 19       		.word	L_RIVETS_WIN_STAGE_ANIM_4	; 5 = 
5486   1692             ;------------------------------------------------------------------------------
5487   1692             
5488   1692             
5489   1692             
5490   1692             ;------------------------------------------------------------------------------
5491   1692             ; Display each phase of the secret stage win animation
5492   1692             L_IMPLEMENT_SECRET_WIN_ANIM:
5493   1692 3A 88 63    		ld		a,(WIN_ANIMATION_STATE)
5494   1695 EF          		rst		$28							; Jump to local table address
5495   1696             		; Jump table
5496   1696 DB 19       		.word	L_SECRET_WIN_ANIM_0
5497   1698 00 31       		.word	L_PAUSE_CURRENT_STATE
5498   169A 05 1A       		.word	L_SECRET_WIN_ANIM_1
5499   169C 00 31       		.word	L_PAUSE_CURRENT_STATE
5500   169E 29 1A       		.word	L_SECRET_WIN_ANIM_2
5501   16A0 00 31       		.word	L_PAUSE_CURRENT_STATE
5502   16A2 52 1A       		.word	L_SECRET_WIN_ANIM_3
5503   16A4 F2 17       		.word	L_ADVANCE_TO_NEXT_STAGE
5504   16A6             ;------------------------------------------------------------------------------
5505   16A6             
5506   16A6             
5507   16A6             
5508   16A6             ;------------------------------------------------------------------------------
5509   16A6             L_WIN_STAGE_ANIM_0:	
5510   16A6             		; Display Pauline standing with a heart next to her
5511   16A6             		; Also start playing the standard win stage tune
5512   16A6 CD 54 17    		call 	L_WIN_ANIM_DISPLAY_PAULINE
5513   16A9             		
5514   16A9             		; Display Donkey Kong with his left arm raised
5515   16A9 21 6D 38            ld      hl,L_DK_SPRITES_L_ARM_RAISED
5516   16AC CD 4E 00            call    L_LOAD_DK_SPRITES
5517   16AF                     
5518   16AF                     ; Initialize the minor timer to 32
5519   16AF 3E 20               ld      a,32
5520   16B1 32 09 60            ld      (MINOR_TIMER),a
5521   16B4             
5522   16B4             		; Advance to the next stage of the animation
5523   16B4 21 88 63    l1662:  ld      hl,WIN_ANIMATION_STATE
5524   16B7 34                  inc     (hl)
5525   16B8             
5526   16B8             		; Return unless this is the barrels stage
5527   16B8 3E 01               ld      a,%00000001
5528   16BA F7                  rst     $30							; Return unless this is the barrels stage
5529   16BB                     
5530   16BB                     ; Move Donkey Kong up 4 pixels
5531   16BB 21 0B 69            ld      hl,DK_SPRITE_1_Y
5532   16BE 0E FC               ld      c,$fc
5533   16C0 FF                  rst     $38
5534   16C1 C9                  ret     
5535   16C2             ;------------------------------------------------------------------------------
5536   16C2             
5537   16C2             
5538   16C2             
5539   16C2             ;------------------------------------------------------------------------------
5540   16C2             L_WIN_STAGE_ANIM_1:	
5541   16C2             		; Return until the minor timer has reached 0
5542   16C2 DF          		rst     $18
5543   16C3                     
5544   16C3                     ; Change Donkey Kong's sprites
5545   16C3 21 43 39            ld      hl,L_DK_SPRITES_THROW_BARREL
5546   16C6 CD 4E 00            call    L_LOAD_DK_SPRITES
5547   16C9                     
5548   16C9                     ; Reset the minor timer to 32
5549   16C9 3E 20               ld      a,32
5550   16CB 32 09 60            ld      (MINOR_TIMER),a
5551   16CE                     
5552   16CE                     ; Advance to the next animation stage
5553   16CE 21 88 63            ld      hl,WIN_ANIMATION_STATE
5554   16D1 34                  inc     (hl)
5555   16D2                     
5556   16D2                     ; Return unless this is the elevators stage
5557   16D2 3E 04               ld      a,%00000100
5558   16D4 F7                  rst     $30
5559   16D5                     
5560   16D5                     ; Move Donkey Kong up 4 pixels
5561   16D5 21 0B 69            ld      hl,DK_SPRITE_1_Y
5562   16D8 0E 04       l1686:  ld      c,4
5563   16DA FF                  rst     $38
5564   16DB                     
5565   16DB C9                  ret     
5566   16DC             ;------------------------------------------------------------------------------
5567   16DC             
5568   16DC             
5569   16DC             
5570   16DC             ;------------------------------------------------------------------------------
5571   16DC             L_WIN_STAGE_ANIM_2:  
5572   16DC             		; Return until the minor timer has reached 0
5573   16DC DF          		rst     $18
5574   16DD                     
5575   16DD                     ; Change the Donkey Kong sprites
5576   16DD 21 9D 38            ld      hl,L_DK_SPRITES_CLIMBING
5577   16E0 CD 4E 00            call    L_LOAD_DK_SPRITES
5578   16E3                     
5579   16E3                     ; Show Donkey Kong's right arm climbing the ladder
5580   16E3 3E 66               ld      a,102
5581   16E5 32 0C 69            ld      (DK_SPRITE_2_X),a
5582   16E8                     
5583   16E8                     ; Hide the sprites showing Donkey Kong carrying Pauline
5584   16E8 AF                  xor     a						; a = 0
5585   16E9 32 24 69            ld      (DK_SPRITE_8_X),a
5586   16EC 32 2C 69            ld      (DK_SPRITE_10_X),a
5587   16EF 32 AF 62            ld      (DK_CLIMBING_COUNTER),a
5588   16F2                     
5589   16F2                     ; Jump back to advance the animation state and
5590   16F2                     ; move Donkey Kong into position
5591   16F2 18 C0               jr      l1662
5592   16F4             ;------------------------------------------------------------------------------
5593   16F4             
5594   16F4             
5595   16F4             
5596   16F4             ;------------------------------------------------------------------------------
5597   16F4             L_MIXER_WIN_STAGE_ANIM_0:  
5598   16F4             		; Display Pauline standing with a heart next to her
5599   16F4 CD 54 17    		call    L_WIN_ANIM_DISPLAY_PAULINE
5600   16F7             		
5601   16F7             		; Determine where the conveyer has moved Donkey Kong
5602   16F7 3A 10 69            ld      a,(DK_SPRITE_3_X)
5603   16FA D6 3B               sub     59
5604   16FC                     
5605   16FC                     ; Load new Donkey Kong sprites
5606   16FC 21 6D 38            ld      hl,L_DK_SPRITES_L_ARM_RAISED
5607   16FF CD 4E 00    		call    L_LOAD_DK_SPRITES
5608   1702             		
5609   1702             		; Move Donkey Kong back to where the conveyer has moved him
5610   1702 21 08 69            ld      hl,DK_SPRITE_1_X
5611   1705 4F                  ld      c,a
5612   1706 FF                  rst     $38
5613   1707                     
5614   1707                     ; Advance to the next animation state
5615   1707 21 88 63            ld      hl,WIN_ANIMATION_STATE
5616   170A 34                  inc     (hl)
5617   170B C9                  ret     
5618   170C             ;------------------------------------------------------------------------------
5619   170C             
5620   170C             
5621   170C             ;------------------------------------------------------------------------------
5622   170C             ; Wait for the conveyer belt to move Donkey Kong to the escape ladders
5623   170C             L_WAIT_FOR_DK_TO_REACH_LADDERS:  
5624   170C             		; Set the conveyer reverse timer to 256 (maximum)
5625   170C AF          		xor     a
5626   170D 32 A0 62            ld      (TOP_MASTER_REVERSE_TIMER),a
5627   1710                     
5628   1710                     ; Save the top conveyer's direction
5629   1710 3A A3 63            ld      a,(TOP_CONVEYER_DIR)
5630   1713 4F                  ld      c,a
5631   1714                     
5632   1714                     ; If Donkey Kong is to the right of x coordinate 90,
5633   1714                     ; jump ahead
5634   1714 3A 10 69            ld      a,(DK_SPRITE_3_X)
5635   1717 FE 5A               cp      90
5636   1719 30 15               jr      nc,l16e1
5637   171B                     
5638   171B                     ; If Donkey Kong is to the left of x coordinate 90 and
5639   171B             		; the conveyer is moving right, jump ahead
5640   171B CB 79               bit     7,c
5641   171D 28 05               jr      z,l16d5
5642   171F                     
5643   171F                     ; Set the conveyer reverse timer to 1 so that it will reverse
5644   171F             		; immediately
5645   171F 3E 01       l16d0:  ld      a,1
5646   1721 32 A0 62            ld      (TOP_MASTER_REVERSE_TIMER),a
5647   1724             		
5648   1724 CD AE 26    l16d5:  call    L_IMPLEMENT_TOP_CONVEYER
5649   1727             	
5650   1727             		; Move Donkey Kong along the conveyer belt
5651   1727 3A A3 63            ld      a,(TOP_CONVEYER_DIR)
5652   172A 4F                  ld      c,a
5653   172B 21 08 69            ld      hl,DK_SPRITE_1_X
5654   172E FF                  rst     $38
5655   172F C9                  ret     
5656   1730             		
5657   1730             		; If Donkey Kong is to the left of x coordinate 93,
5658   1730             		; jump ahead because he's in the sweet spot
5659   1730 FE 5D       l16e1:  cp      93
5660   1732 38 06               jr      c,l16ee
5661   1734                     
5662   1734                     ; If Donkey Kong is to the right of x coordinate 93 and
5663   1734             		; the conveyer is moving right, jump ahead
5664   1734 CB 79               bit     7,c
5665   1736 28 E7               jr      z,l16d0
5666   1738                     
5667   1738             		; Jump back up to reverse the conveyer belt
5668   1738 18 EA               jr      l16d5
5669   173A                     
5670   173A             		; Change Donkey Kong's sprites to climbing
5671   173A 21 9D 38    l16ee:  ld      hl,L_DK_SPRITES_CLIMBING
5672   173D CD 4E 00            call    L_LOAD_DK_SPRITES
5673   1740             		
5674   1740             		; Display Donkey Kong's right climbing arm
5675   1740 3E 66               ld      a,102
5676   1742 32 0C 69            ld      (DK_SPRITE_2_X),a
5677   1745             		
5678   1745             		; Hide Donkey Kong's right carrying arm and Pauline being carried
5679   1745 AF                  xor     a
5680   1746 32 24 69            ld      (DK_SPRITE_8_X),a
5681   1749 32 2C 69            ld      (DK_SPRITE_10_X),a
5682   174C             		
5683   174C             		; Zero the climbing counter
5684   174C 32 AF 62            ld      (DK_CLIMBING_COUNTER),a
5685   174F             		
5686   174F             		; Advance the win animation state
5687   174F 21 88 63            ld      hl,WIN_ANIMATION_STATE
5688   1752 34                  inc     (hl)
5689   1753 C9                  ret     
5690   1754             ;------------------------------------------------------------------------------
5691   1754             
5692   1754             
5693   1754             
5694   1754             ;------------------------------------------------------------------------------
5695   1754             ; Update Pauline for the stage win animation
5696   1754             ; Pauline is displayed with a heart next to her
5697   1754             L_WIN_ANIM_DISPLAY_PAULINE:  
5698   1754 CD 0F 01    		call    L_SOUNDS_OFF
5699   1757             
5700   1757                     ; Clear the "HELP!" tiles to Pauline's right
5701   1757 21 C4 75            ld      hl,TILE_COORD(14,4)
5702   175A 11 20 00            ld      de,32
5703   175D 3E 10               ld      a,$10						; Blank tile
5704   175F CD FE 04            call    L_DISPLAY_OR_CLEAR_HELP		; Clear HELP!
5705   1762             		
5706   1762             		; If not advancing to the secret stage, then jump ahead
5707   1762             		; to skip displaying the question mark next to Pauline
5708   1762 3A 90 62    		ld		a,(ACTIVATE_SECRET_STAGE)
5709   1765 A7          		and		a
5710   1766 28 07       		jr		z,l_win_anim_display_pauline_1
5711   1768             		
5712   1768             		; Display question mark next to Pauline
5713   1768             		; (This is for advancement to the secret stage)
5714   1768 21 04 76    		ld		hl,TILE_COORD(16,4)
5715   176B 36 FB       		ld		(hl),$FB					; Question mark
5716   176D             		
5717   176D             		; Jump ahead to skip displaying the heart sprite
5718   176D 18 0E       		jr		l_win_anim_display_pauline_2
5719   176F             		
5720   176F             l_win_anim_display_pauline_1:		
5721   176F             		; Initialize the heart sprite that appears next to Pauline during the
5722   176F             		; win stage animation
5723   176F 21 20 6A            ld      hl,HEART_SPRITE_X
5724   1772 36 80               ld      (hl),128
5725   1774 23                  inc     hl
5726   1775 36 76               ld      (hl),$76					; HEART_SPRITE_NUM
5727   1777 23                  inc     hl
5728   1778 36 09               ld      (hl),$09					; HEART_SPRITE_PAL
5729   177A 23                  inc     hl
5730   177B 36 20               ld      (hl),32						; HEART_SPRITE_Y
5731   177D                     
5732   177D             l_win_anim_display_pauline_2:
5733   177D                     ; Display Pauline standing calmly
5734   177D 21 05 69            ld      hl,PAULINE_LOWER_SPRITE_NUM
5735   1780 36 13               ld      (hl),$13
5736   1782                     
5737   1782                     ; Play the standard win stage song (triggered three times)
5738   1782 21 8A 60            ld      hl,PENDING_SONG_TRIGGER
5739   1785 36 07               ld      (hl),SONG_TRIGGER_STAGE_END
5740   1787 23                  inc     hl
5741   1788 36 03               ld      (hl),3
5742   178A C9                  ret     
5743   178B             ;------------------------------------------------------------------------------
5744   178B             
5745   178B             
5746   178B             
5747   178B             ;------------------------------------------------------------------------------
5748   178B             L_WIN_STAGE_ANIM_3:  
5749   178B             		; Animate Donkey Kong climbing up the exit ladders
5750   178B CD 06 31    		call    L_ANIMATE_CLIMBING_LADDERS
5751   178E                     
5752   178E                     ; Return if Donkey Kong hasn't yet reached Pauline's platform
5753   178E 3A 13 69            ld      a,(DK_SPRITE_3_Y)
5754   1791 FE 2C               cp      44
5755   1793 D0                  ret     nc
5756   1794                     
5757   1794                     ; Hide Pauline's sprites
5758   1794 AF                  xor     a
5759   1795 32 00 69            ld      (PAULINE_UPPER_SPRITE_X),a
5760   1798 32 04 69            ld      (PAULINE_LOWER_SPRITE_X),a
5761   179B                     
5762   179B                     ; Hide Donkey Kong's climbing right arm sprite
5763   179B 32 0C 69            ld      (DK_SPRITE_2_X),a
5764   179E                     
5765   179E                     ; Display Donkey Kong's right arm carrying sprite
5766   179E 3E 6B               ld      a,107
5767   17A0 32 24 69            ld      (DK_SPRITE_8_X),a
5768   17A3                     
5769   17A3                     ; Display Pauline being carrying sprite
5770   17A3 3D                  dec     a
5771   17A4 32 2C 69            ld      (DK_SPRITE_10_X),a
5772   17A7                     
5773   17A7                     ; Advance to the next win animation state
5774   17A7 21 88 63            ld      hl,WIN_ANIMATION_STATE
5775   17AA 34                  inc     (hl)
5776   17AB             
5777   17AB             		; If not advancing to the secret stage, then jump ahead
5778   17AB             		; to skip displaying the exclamation marks
5779   17AB 3A 90 62    		ld		a,(ACTIVATE_SECRET_STAGE)
5780   17AE A7          		and		a
5781   17AF 28 06       		jr		z,l_win_stage_anim_3_1
5782   17B1             		
5783   17B1             		; Display excalamation marks where the question mark was
5784   17B1             		; (This is for advancement to the secret stage)
5785   17B1 21 04 76    		ld		hl,TILE_COORD(16,4)
5786   17B4 36 37       		ld		(hl),$37					; Question mark
5787   17B6             
5788   17B6 C9          		ret
5789   17B7             		
5790   17B7             l_win_stage_anim_3_1:
5791   17B7                     ; Replace the heart sprite with the broken heart sprite
5792   17B7 21 21 6A            ld      hl,HEART_SPRITE_NUM
5793   17BA 34                  inc     (hl)
5794   17BB             
5795   17BB C9                  ret     
5796   17BC             ;------------------------------------------------------------------------------
5797   17BC             
5798   17BC             
5799   17BC             
5800   17BC             ;------------------------------------------------------------------------------
5801   17BC             L_WIN_STAGE_ANIM_4:  
5802   17BC             		; Animate Donkey Kong climbing off the stage
5803   17BC CD 06 31    		call    L_ANIMATE_CLIMBING_LADDERS
5804   17BF CD D1 17            call    L_HIDE_OFFSCREEN_DK_SPRITES
5805   17C2                     
5806   17C2                     ; Return until all of Donkey Kong's sprites are hidden 
5807   17C2                     ; (Donkey Kong has climbed completely offscreen)
5808   17C2 23                  inc     hl						; hl = x coordinate of first Donkey Kong sprite
5809   17C3 13                  inc     de						; de = 4
5810   17C4 CD E7 17            call    L_CHECK_IF_DK_SPRITES_HIDDEN
5811   17C7                     
5812   17C7                     ; Set minor timer to 64
5813   17C7 3E 40               ld      a,64
5814   17C9 32 09 60            ld      (MINOR_TIMER),a
5815   17CC                     
5816   17CC                     ; Advance to the next animation state
5817   17CC 21 88 63            ld      hl,WIN_ANIMATION_STATE
5818   17CF 34                  inc     (hl)
5819   17D0 C9                  ret     
5820   17D1             ;------------------------------------------------------------------------------
5821   17D1             
5822   17D1             
5823   17D1             
5824   17D1             ;------------------------------------------------------------------------------
5825   17D1             ; This function hidesach sprite in Donkey Kong as it goes off screen
5826   17D1             L_HIDE_OFFSCREEN_DK_SPRITES:  
5827   17D1             		; Check each sprite in Donkey Kong
5828   17D1 11 03 00    		ld      de,3
5829   17D4 21 2F 69            ld      hl,DK_SPRITE_10_Y
5830   17D7 06 0A               ld      b,10						; For b = 10 to 1 (10 sprites in Donkey Kong)
5831   17D9             
5832   17D9             		; If this Donkey Kong sprite has not gone off the screen yet,
5833   17D9             		; jump ahead to process the next sprite
5834   17D9 A7          l1774:  and     a							; Clear carry flag
5835   17DA 7E                  ld      a,(hl)						; a = sprite y coordinate
5836   17DB ED 52               sbc     hl,de						; hl = sprite x coordinate
5837   17DD FE 19               cp      25
5838   17DF 30 02               jr      nc,l177f
5839   17E1                     
5840   17E1                     ; Hide this sprite
5841   17E1 36 00               ld      (hl),0
5842   17E3                     
5843   17E3                     ; Move on to the next sprite
5844   17E3 2B          l177f:  dec     hl
5845   17E4 10 F3               djnz    l1774						; Next b
5846   17E6 C9                  ret     
5847   17E7             ;------------------------------------------------------------------------------
5848   17E7             
5849   17E7             
5850   17E7             
5851   17E7             ;------------------------------------------------------------------------------
5852   17E7             ; This function checks each sprite in Donkey Kong to see if they've been hidden
5853   17E7             ; If all the sprites have been hidden, the function simply returns
5854   17E7             ; If there are still unhidden sprites, the calling function is aborted
5855   17E7             L_CHECK_IF_DK_SPRITES_HIDDEN:  
5856   17E7             		; Check each Donkey Kong sprite
5857   17E7 06 0A       		ld      b,10						; For b = 10 to 1 (10 sprites in Donkey Kong)
5858   17E9             
5859   17E9             		; If this sprite has not been hidden, return from the calling function
5860   17E9 7E          l1785:  ld      a,(hl)
5861   17EA A7                  and     a
5862   17EB C2 26 00            jp      nz,l0026					; Exceeds relative branch
5863   17EE                     
5864   17EE                     ; Next sprite
5865   17EE 19                  add     hl,de
5866   17EF 10 F8               djnz    l1785						; Next b
5867   17F1 C9                  ret     
5868   17F2             ;------------------------------------------------------------------------------
5869   17F2             
5870   17F2             
5871   17F2             
5872   17F2             ;------------------------------------------------------------------------------
5873   17F2             L_ADVANCE_TO_NEXT_STAGE:  
5874   17F2             		; Return until the minor timer expires
5875   17F2 DF          		rst     $18
5876   17F3             		
5877   17F3             		; If the secret stage does not need to be activated,
5878   17F3             		; jump ahead
5879   17F3 3A 90 62    		ld		a,(ACTIVATE_SECRET_STAGE)
5880   17F6 A7          		and		a
5881   17F7 28 08       		jr		z,l_advance_to_next_stage_1
5882   17F9             		
5883   17F9             		; Activate the secret stage next
5884   17F9 3E 05       		ld		a,5
5885   17FB             		
5886   17FB             		; Force the player's height to advance by forcing a
5887   17FB             		; mismatch between CP_STAGE_ORDER_POINTER_LAG and
5888   17FB             		; CP_STAGE_ORDER_POINTER
5889   17FB 21 2F 62    		ld		hl,CP_STAGE_ORDER_POINTER_LAG
5890   17FE 35          		dec		(hl)
5891   17FF             		
5892   17FF 18 1B       		jr		l17a0
5893   1801             
5894   1801             l_advance_to_next_stage_1:		
5895   1801             		; Advance to the next stage
5896   1801 2A 2A 62            ld      hl,(CP_STAGE_ORDER_POINTER)
5897   1804 23                  inc     hl
5898   1805                     
5899   1805                     ; If the end of the stage order data has not been reached, 
5900   1805             		; jump ahead
5901   1805 7E                  ld      a,(hl)
5902   1806 FE 7F               cp      $7f
5903   1808 20 04               jr      nz,l_advance_to_next_stage_2
5904   180A                     
5905   180A                     ; Repeat level 5's stage order indefinately
5906   180A 21 84 3A            ld      hl,L_STAGE_ORDER_TABLE_LAST
5907   180D 7E                  ld      a,(hl)
5908   180E             	
5909   180E             l_advance_to_next_stage_2:	
5910   180E             		; If not advancing from the secret stage,
5911   180E             		; jump ahead
5912   180E 3A 27 62    		ld		a,(CURRENT_STAGE)
5913   1811 FE 05       		cp		5
5914   1813 7E          		ld		a,(hl)
5915   1814 20 03       		jr		nz,l179d
5916   1816             		
5917   1816             		; Prevent the player's height from advancing by forcing
5918   1816             		; CP_STAGE_ORDER_POINTER_LAG and CP_STAGE_ORDER_POINTER
5919   1816             		; to match
5920   1816 22 2F 62    		ld		(CP_STAGE_ORDER_POINTER_LAG),hl		
5921   1819                     
5922   1819                     ; Update the current stage
5923   1819 22 2A 62    l179d:  ld      (CP_STAGE_ORDER_POINTER),hl
5924   181C 32 27 62    l17a0:  ld      (CURRENT_STAGE),a
5925   181F                     
5926   181F                     ; Display the timer and add it to the player's score
5927   181F 11 00 05            ld      de,$0500
5928   1822 CD 36 31            call    L_ADD_EVENT
5929   1825                     
5930   1825                     ; Reset the win animation state
5931   1825 AF                  xor     a
5932   1826 32 88 63            ld      (WIN_ANIMATION_STATE),a
5933   1829                     
5934   1829                     ; Set the minor timer to 48
5935   1829 21 09 60            ld      hl,MINOR_TIMER
5936   182C 36 30               ld      (hl),48
5937   182E                     
5938   182E                     ; Set the game substate to 8
5939   182E                     ; (Intermission)
5940   182E 23                  inc     hl
5941   182F 36 08               ld      (hl),8
5942   1831 C9                  ret     
5943   1832             ;------------------------------------------------------------------------------
5944   1832             
5945   1832             	
5946   1832             
5947   1832             ;------------------------------------------------------------------------------
5948   1832             L_RIVETS_WIN_STAGE_ANIM_0:  
5949   1832             		; Trigger the rivet stageg end song
5950   1832 CD 0F 01    		call    L_SOUNDS_OFF
5951   1835 21 8A 60            ld      hl,PENDING_SONG_TRIGGER
5952   1838 36 0E               ld      (hl),SONG_TRIGGER_RIVET_END
5953   183A 23                  inc     hl
5954   183B 36 03               ld      (hl),3
5955   183D                     
5956   183D                     ; Clear all "HELP!" tiles around Pauline
5957   183D 3E 10               ld      a,$10						; Blank tile
5958   183F 11 20 00            ld      de,32
5959   1842 21 23 76            ld      hl,TILE_COORD(17,3)
5960   1845 CD FE 04            call    L_DISPLAY_OR_CLEAR_HELP		; Clear HELP!
5961   1848 21 83 75            ld      hl,TILE_COORD(12,3)
5962   184B CD FE 04            call    L_DISPLAY_OR_CLEAR_HELP		; Clear HELP!
5963   184E                     
5964   184E                     ; Clear each detached platform and redisplay it as fallen
5965   184E 21 DA 76            ld      hl,TILE_COORD(22,26)
5966   1851 CD A1 18            call    L_CLEAR_AROUND_GAME_OVER
5967   1854 11 58 3A            ld      de,L_RIVETS_DATA_FALL1
5968   1857 CD AD 0D            call    L_DISPLAY_STAGE
5969   185A 21 D5 76            ld      hl,TILE_COORD(22,21)
5970   185D CD A1 18            call    L_CLEAR_AROUND_GAME_OVER
5971   1860 11 5E 3A            ld      de,L_RIVETS_DATA_FALL2
5972   1863 CD AD 0D            call    L_DISPLAY_STAGE
5973   1866 21 D0 76            ld      hl,TILE_COORD(22,16)
5974   1869 CD A1 18            call    L_CLEAR_AROUND_GAME_OVER
5975   186C 11 64 3A            ld      de,L_RIVETS_DATA_FALL3
5976   186F CD AD 0D            call    L_DISPLAY_STAGE
5977   1872 21 CB 76            ld      hl,TILE_COORD(22,11)
5978   1875 CD A1 18            call    L_CLEAR_AROUND_GAME_OVER
5979   1878 11 6A 3A            ld      de,L_RIVETS_DATA_FALL4
5980   187B CD AD 0D            call    L_DISPLAY_STAGE
5981   187E                     
5982   187E                     ; Change Donkey Kong's sprites
5983   187E 21 6D 38            ld      hl,L_DK_SPRITES_L_ARM_RAISED
5984   1881 CD 4E 00            call    L_LOAD_DK_SPRITES
5985   1884 21 08 69            ld      hl,DK_SPRITE_1_X
5986   1887 0E 44               ld      c,68
5987   1889 FF                  rst     $38
5988   188A                     
5989   188A                     ; Update Pauline
5990   188A 21 05 69            ld      hl,PAULINE_LOWER_SPRITE_NUM
5991   188D 36 13               ld      (hl),$13
5992   188F                     
5993   188F                     ; Set the minor timer to 32
5994   188F 3E 20               ld      a,32
5995   1891 32 09 60            ld      (MINOR_TIMER),a
5996   1894                     
5997   1894                     ; Set the animation timer to 128 to control Donkey Kong and Pauline's animation
5998   1894 3E 80               ld      a,128
5999   1896 32 90 63            ld      (ANIMATION_TIMER),a
6000   1899                     
6001   1899                     ; Increment the animation state
6002   1899 21 88 63            ld      hl,WIN_ANIMATION_STATE
6003   189C 34                  inc     (hl)
6004   189D 22 C0 63            ld      (CURRENT_STATE_VAR_POINTER),hl
6005   18A0 C9                  ret     
6006   18A1             ;------------------------------------------------------------------------------
6007   18A1             
6008   18A1             
6009   18A1             
6010   18A1             ;------------------------------------------------------------------------------
6011   18A1             ; Clear the section of the screen around the game over message
6012   18A1             ; passed:	hl - the starting tile coordinate
6013   18A1             L_CLEAR_AROUND_GAME_OVER:  
6014   18A1 11 DB FF    		ld      de,-37
6015   18A4 0E 0E               ld      c,14						; For c = 14 to 1 
6016   18A6 3E 10               ld      a,$10					; Space
6017   18A8 06 05       l182d:  ld      b,5						; For b = 5 to 1
6018   18AA 77          l182f:  ld      (hl),a
6019   18AB 23                  inc     hl
6020   18AC 10 FC               djnz    l182f
6021   18AE 19                  add     hl,de					; 
6022   18AF 0D                  dec     c
6023   18B0 20 F6               jr      nz,l182d					; Next c
6024   18B2                     
6025   18B2 C9                  ret     
6026   18B3             ;------------------------------------------------------------------------------
6027   18B3             
6028   18B3             
6029   18B3             
6030   18B3             ;------------------------------------------------------------------------------
6031   18B3             L_RIVETS_WIN_STAGE_ANIM_1:  
6032   18B3             		; If the animation timer has rolled over, jump ahead
6033   18B3 21 90 63    		ld      hl,ANIMATION_TIMER
6034   18B6 34                  inc     (hl)
6035   18B7 28 19               jr      z,l1859
6036   18B9                     
6037   18B9                     ; Return if the lowest 3 bits are not 0s
6038   18B9 7E                  ld      a,(hl)
6039   18BA E6 07               and     %0000111
6040   18BC C0                  ret     nz
6041   18BD                     
6042   18BD                     ; If bit 3 of the animation timer is 1,
6043   18BD                     ; jump ahead to make Donkey Kong stomp on his left foot
6044   18BD 11 E0 39            ld      de,L_DK_SPRITES_GRIN_L_STOMP
6045   18C0 CB 5E               bit     3,(hl)
6046   18C2 20 03               jr      nz,l184e
6047   18C4                     
6048   18C4                     ; Bit 3 of theganimation timer is 0,
6049   18C4                     ; make Donkey Kongfstomp on his right foot 
6050   18C4 11 08 3A            ld      de,L_DK_SPRITES_GRIN_R_STOMP
6051   18C7                     
6052   18C7                     ; Change Donkey Kong's sprites
6053   18C7 EB          l184e:  ex      de,hl
6054   18C8 CD 4E 00            call    L_LOAD_DK_SPRITES
6055   18CB 21 08 69            ld      hl,DK_SPRITE_1_X
6056   18CE 0E 44               ld      c,68
6057   18D0 FF                  rst     $38
6058   18D1 C9                  ret     
6059   18D2                     
6060   18D2                     ; Change Donkey Kong's sprites
6061   18D2 21 6D 38    l1859:  ld      hl,L_DK_SPRITES_L_ARM_RAISED
6062   18D5 CD 4E 00            call    L_LOAD_DK_SPRITES
6063   18D8 21 08 69            ld      hl,DK_SPRITE_1_X
6064   18DB 0E 44               ld      c,68
6065   18DD FF                  rst     $38
6066   18DE                     
6067   18DE                     ; Set the minor timer to 32
6068   18DE 3E 20               ld      a,32
6069   18E0 32 09 60            ld      (MINOR_TIMER),a
6070   18E3                     
6071   18E3                     ; Advance to the next animation state
6072   18E3 21 88 63            ld      hl,WIN_ANIMATION_STATE
6073   18E6 34                  inc     (hl)
6074   18E7 C9                  ret 
6075   18E8             ;------------------------------------------------------------------------------
6076   18E8             
6077   18E8                         
6078   18E8             
6079   18E8             ;------------------------------------------------------------------------------
6080   18E8             L_RIVETS_WIN_STAGE_ANIM_2:  
6081   18E8             		; Return until the minor timer times out
6082   18E8 DF          		rst     $18
6083   18E9             		
6084   18E9                     ; Change Donkey Kong's sprites
6085   18E9 21 30 3A            ld      hl,L_DK_SPRITES_GRIN_UD
6086   18EC CD 4E 00            call    L_LOAD_DK_SPRITES
6087   18EF                     
6088   18EF                     ; Trigger the falling sound
6089   18EF 3E 03               ld      a,3
6090   18F1 32 84 60            ld      (FALL_SOUND_TRIGGER),a
6091   18F4                     
6092   18F4                     ; Advance to the next animation state
6093   18F4 21 88 63            ld      hl,WIN_ANIMATION_STATE
6094   18F7 34                  inc     (hl)
6095   18F8 C9                  ret  
6096   18F9             ;------------------------------------------------------------------------------
6097   18F9             
6098   18F9                        
6099   18F9             
6100   18F9             ;------------------------------------------------------------------------------
6101   18F9             L_RIVETS_WIN_STAGE_ANIM_3:  
6102   18F9             		; Move Donkey Kong down 1 pixel
6103   18F9 21 0B 69    		ld      hl,DK_SPRITE_1_Y
6104   18FC 0E 01               ld      c,1
6105   18FE FF                  rst     $38
6106   18FF                     
6107   18FF                     ; Return if Donkey Kong has not reached the fallen platforms
6108   18FF 3A 1B 69            ld      a,(DK_SPRITE_5_Y)
6109   1902 FE D0               cp      208
6110   1904 C0                  ret     nz
6111   1905                     
6112   1905                     ; Change Donkey Kong's head sprite
6113   1905 3E 20               ld      a,$20
6114   1907 32 19 69            ld      (DK_SPRITE_5_NUM),a
6115   190A                     
6116   190A                     ; Create the stars sprite just below Donkey Kong's head
6117   190A 21 24 6A            ld      hl,DK_STARS_SPRITE_X
6118   190D 36 7F               ld      (hl),127					; X coordinate
6119   190F 2C                  inc     l
6120   1910 36 39               ld      (hl),$39					; Sprite numbet
6121   1912 2C                  inc     l
6122   1913 36 01               ld      (hl),$01					; Palette
6123   1915 2C                  inc     l
6124   1916 36 D8               ld      (hl),216					; Y coordinate
6125   1918                     
6126   1918                     ; Clear Pauline's platform and redraw it lower down
6127   1918 21 C6 76            ld      hl,TILE_COORD(22,6)
6128   191B CD A1 18            call    L_CLEAR_AROUND_GAME_OVER
6129   191E 11 70 3A            ld      de,L_RIVETS_DATA_FALL_TOP
6130   1921 CD AD 0D            call    L_DISPLAY_STAGE
6131   1924                     
6132   1924                     ; Reposition Pauline
6133   1924             ;        ld      de,4						; 4 byte sprite struct
6134   1924 01 28 02            ld      bc,TWO_BYTES(2,40)			; 2 sprites, 40 pixels
6135   1927 21 03 69            ld      hl,PAULINE_UPPER_SPRITE_Y
6136   192A CD 3A 00            call    L_MOVE_N_SPRITES
6137   192D                     
6138   192D                     ; Set the climbing counter to 256 (0) 
6139   192D                     ; (used in the animation)
6140   192D AF                  xor     a
6141   192E 32 AF 62            ld      (DK_CLIMBING_COUNTER),a
6142   1931                     
6143   1931                     ; Trigger the stomp sound
6144   1931 3E 03               ld      a,3
6145   1933 32 82 60            ld      (STOMP_SOUND_TRIGGER),a
6146   1936                     
6147   1936                     ; Advance to the next animation state
6148   1936 21 88 63            ld      hl,WIN_ANIMATION_STATE
6149   1939 34                  inc     (hl)
6150   193A C9                  ret     
6151   193B             ;------------------------------------------------------------------------------
6152   193B             
6153   193B                     
6154   193B             
6155   193B             ;------------------------------------------------------------------------------
6156   193B             L_RIVETS_WIN_STAGE_ANIM_4:  
6157   193B             		; If the climbing counter has reached 0, jump ahead
6158   193B 21 AF 62    		ld      hl,DK_CLIMBING_COUNTER
6159   193E 35                  dec     (hl)
6160   193F 28 6D               jr      z,l193d
6161   1941                     
6162   1941                     ; Return if the 3 lowest bits are not 0
6163   1941 7E                  ld      a,(hl)
6164   1942 E6 07               and     %00000111
6165   1944 C0                  ret     nz
6166   1945                     
6167   1945                     ; Flip the star sprite horizontally
6168   1945 21 25 6A            ld      hl,DK_STARS_SPRITE_NUM
6169   1948 7E                  ld      a,(hl)
6170   1949 EE 80               xor     %10000000
6171   194B 77                  ld      (hl),a
6172   194C                     
6173   194C                     ; Convert Donkey Kong's head sprite into the number 0 - 2
6174   194C 21 19 69    		ld      hl,DK_SPRITE_5_NUM
6175   194F 46                  ld      b,(hl)
6176   1950 CB A8               res     5,b
6177   1952                     
6178   1952             		; The following function essentially advances a from 0 to 1, 1 to 2, and 2 to 0
6179   1952             		; in an extraordinarily complicated way 
6180   1952 AF          		xor     a							; a = 0
6181   1953 CD A7 30            call    l3009
6182   1956             		
6183   1956             		; Convert a (0-2) to Donkey Kong's stunned head sprite ($20-$22)
6184   1956 F6 20               or      %00100000
6185   1958 77                  ld      (hl),a
6186   1959             		
6187   1959             		; If the animation counter has not reached 224
6188   1959             		; jump ahead to trigger the level end song
6189   1959 21 AF 62            ld      hl,DK_CLIMBING_COUNTER
6190   195C 7E                  ld      a,(hl)
6191   195D FE E0               cp      224
6192   195F 20 20               jr      nz,l1910
6193   1961             		
6194   1961             		; If Mario was on the right side of the screen,
6195   1961             		; then display Mario to Pauline's right
6196   1961 3E 50               ld      a,80
6197   1963 32 4F 69            ld      (MARIO_SPRITE_Y),a
6198   1966 AF                  xor     a
6199   1967 32 4D 69            ld      (MARIO_SPRITE_NUM),a
6200   196A 3E 9F               ld      a,159
6201   196C 32 4C 69            ld      (MARIO_SPRITE_X),a
6202   196F 3A 03 62            ld      a,(MARIO_X)
6203   1972 FE 80               cp      128
6204   1974 30 0A               jr      nc,l190f
6205   1976             		
6206   1976             		; Mario was on the left side of the screen,
6207   1976             		; display Mario to Pauline's left
6208   1976 3E 80               ld      a,$80
6209   1978 32 4D 69            ld      (MARIO_SPRITE_NUM),a
6210   197B 3E 5F               ld      a,$5f
6211   197D 32 4C 69            ld      (MARIO_SPRITE_X),a
6212   1980             		
6213   1980             		; Return if the animation counter has not reached 192
6214   1980 7E          l190f:  ld      a,(hl)
6215   1981 FE C0       l1910:  cp      192
6216   1983 C0                  ret     nz
6217   1984             		
6218   1984             		; If the current level is odd, trigger the first level end tune
6219   1984 21 8A 60            ld      hl,PENDING_SONG_TRIGGER
6220   1987 36 0C               ld      (hl),SONG_TRIGGER_LEVEL_END_1
6221   1989 3A 29 62            ld      a,(CP_LEVEL_NUMBER)
6222   198C 0F                  rrca    
6223   198D 38 02               jr      c,l1920
6224   198F             		
6225   198F             		; The current level is even, trigger the second level end tune
6226   198F 36 05               ld      (hl),SONG_TRIGGER_LEVEL_END_2
6227   1991             		
6228   1991 23          l1920:  inc     hl
6229   1992 36 03               ld      (hl),3
6230   1994             		
6231   1994             		; If Mario was on the Pauline's right, 
6232   1994             		; then display the heart sprite to Pauline's right
6233   1994 21 23 6A            ld      hl,HEART_SPRITE_Y
6234   1997 36 40               ld      (hl),64
6235   1999 2B                  dec     hl
6236   199A 36 09               ld      (hl),9						; Palette
6237   199C 2B                  dec     hl
6238   199D 36 76               ld      (hl),$76					; Sprite number
6239   199F 2B                  dec     hl
6240   19A0 36 8F               ld      (hl),143					; Y coordinate
6241   19A2 3A 03 62            ld      a,(MARIO_X)
6242   19A5 FE 80               cp      128
6243   19A7 D0                  ret     nc
6244   19A8             
6245   19A8             		; Else if Mario was on Pauline's left,
6246   19A8             		; then display the heart sprite to Pauline's left
6247   19A8 3E 6F               ld      a,111
6248   19AA 32 20 6A            ld      (HEART_SPRITE_X),a
6249   19AD C9                  ret     
6250   19AE             		
6251   19AE             		; Advance to the start of the next level's stage order list
6252   19AE 2A 2A 62    l193d:  ld      hl,(CP_STAGE_ORDER_POINTER)
6253   19B1 23                  inc     hl
6254   19B2             		
6255   19B2             		; If the stage order pointer does not need to be wrapped,
6256   19B2             		; jump ahead
6257   19B2 7E                  ld      a,(hl)
6258   19B3 FE 7F               cp      $7f
6259   19B5 20 04               jr      nz,l194b
6260   19B7             		
6261   19B7             		; Point the stage order pointer to the level 5 stage order
6262   19B7 21 84 3A            ld      hl,L_STAGE_ORDER_TABLE_LAST
6263   19BA 7E                  ld      a,(hl)
6264   19BB 22 2A 62    l194b:  ld      (CP_STAGE_ORDER_POINTER),hl
6265   19BE             
6266   19BE             		; Set the current stage to the first stage in the new level
6267   19BE 32 27 62            ld      (CURRENT_STAGE),a
6268   19C1             		
6269   19C1             		; Advance the level number
6270   19C1 21 29 62            ld      hl,CP_LEVEL_NUMBER
6271   19C4 34                  inc     (hl)
6272   19C5             		
6273   19C5             		; Display the timer and add the value to the player's score
6274   19C5 11 00 05            ld      de,$0500
6275   19C8 CD 36 31            call    L_ADD_EVENT
6276   19CB             		
6277   19CB             		; Reset the height index
6278   19CB AF                  xor     a							; a = 0
6279   19CC 32 2E 62            ld      (CP_HEIGHT_INDEX),a
6280   19CF             		
6281   19CF             		; Reset the animation state
6282   19CF 32 88 63            ld      (WIN_ANIMATION_STATE),a
6283   19D2             		
6284   19D2             		; Set the minor timer to 
6285   19D2 21 09 60            ld      hl,MINOR_TIMER
6286   19D5 36 E0               ld      (hl),224
6287   19D7             		
6288   19D7             		; Set the game substate to 8
6289   19D7 23                  inc     hl
6290   19D8 36 08               ld      (hl),8
6291   19DA C9                  ret     
6292   19DB             ;------------------------------------------------------------------------------
6293   19DB             
6294   19DB             
6295   19DB             
6296   19DB             ;------------------------------------------------------------------------------
6297   19DB             L_SECRET_WIN_ANIM_0:	
6298   19DB             		; Display Pauline standing with a heart next to her
6299   19DB             		; Also start playing the standard win stage tune
6300   19DB CD 54 17    		call L_WIN_ANIM_DISPLAY_PAULINE
6301   19DE             		
6302   19DE             		; Move the heart sprite into the correct position
6303   19DE 21 20 6A    		ld		hl,HEART_SPRITE_X
6304   19E1 36 D0       		ld		(hl),208
6305   19E3 23          		inc		hl
6306   19E4 23          		inc		hl
6307   19E5 23          		inc		hl
6308   19E6 36 D8       		ld		(hl),216
6309   19E8             
6310   19E8                     ; Clear the "HELP!" tiles to Pauline's right
6311   19E8 21 C4 75            ld      hl,TILE_COORD(14,4)
6312   19EB 11 20 00            ld      de,32
6313   19EE 3E 10               ld      a,$10						; Blank tile
6314   19F0 CD FE 04            call    L_DISPLAY_OR_CLEAR_HELP		; Clear HELP!
6315   19F3                     
6316   19F3             		; Prepare to have Donkey Kong's arm move to grab Pauline
6317   19F3 3E F8       		ld		a,248
6318   19F5 32 AF 62    		ld		(DK_REACHING_COUNTER),a
6319   19F8             		
6320   19F8                     ; Initialize the minor timer to 32
6321   19F8 3E 60               ld      a,96
6322   19FA 32 09 60            ld      (MINOR_TIMER),a
6323   19FD             
6324   19FD             		; Advance to the next stage of the animation
6325   19FD 21 88 63    		ld      hl,WIN_ANIMATION_STATE
6326   1A00 34                  inc     (hl)
6327   1A01 22 C0 63            ld      (CURRENT_STATE_VAR_POINTER),hl
6328   1A04 C9                  ret     
6329   1A05             ;------------------------------------------------------------------------------
6330   1A05             
6331   1A05             
6332   1A05             
6333   1A05             ;------------------------------------------------------------------------------
6334   1A05             L_SECRET_WIN_ANIM_1:	
6335   1A05 3A 1A 60    		ld		a,(COUNTER_2)
6336   1A08 1F          		rra		
6337   1A09 D0          		ret		nc
6338   1A0A             
6339   1A0A             		; Display Donkey Kong's arm grabbing for Pauline
6340   1A0A 21 AF 62    		ld		hl,DK_REACHING_COUNTER
6341   1A0D 35          		dec		(hl)
6342   1A0E 7E          		ld		a,(hl)
6343   1A0F FE E7       		cp		231
6344   1A11             
6345   1A11 21 08 69    		ld		hl,DK_SPRITE_1_X
6346   1A14 77          		ld		(hl),a
6347   1A15 23          		inc		hl
6348   1A16 36 A8       		ld		(hl),$A8
6349   1A18 23          		inc		hl
6350   1A19 36 08       		ld		(hl),$08
6351   1A1B 23          		inc		hl
6352   1A1C 36 EE       		ld		(hl),238
6353   1A1E             		
6354   1A1E             		; Return if the arm hasn't reached Pauline yet
6355   1A1E C0          		ret		nz
6356   1A1F                     
6357   1A1F                     ; Initialize the minor timer to 32
6358   1A1F 3E 20               ld      a,32
6359   1A21 32 09 60            ld      (MINOR_TIMER),a
6360   1A24             
6361   1A24             		; Advance to the next stage of the animation
6362   1A24 21 88 63    		ld      hl,WIN_ANIMATION_STATE
6363   1A27 34                  inc     (hl)
6364   1A28 C9                  ret     
6365   1A29             ;------------------------------------------------------------------------------
6366   1A29             
6367   1A29             
6368   1A29             
6369   1A29             ;------------------------------------------------------------------------------
6370   1A29             L_SECRET_WIN_ANIM_2:	
6371   1A29             		; Change the heart to a broken heart
6372   1A29 21 21 6A    		ld		hl,HEART_SPRITE_NUM
6373   1A2C 36 77       		ld		(hl),$77
6374   1A2E             
6375   1A2E             		; Display Donkey Kong's arm grabbing Pauline
6376   1A2E 21 09 69    		ld		hl,DK_SPRITE_1_NUM
6377   1A31 36 B1       		ld		(hl),$B1
6378   1A33             
6379   1A33             		; Display Pauline in Donkey Kong's arm
6380   1A33 21 0C 69    		ld		hl,DK_SPRITE_2_X
6381   1A36 36 EA       		ld		(hl),234
6382   1A38 23          		inc		hl
6383   1A39 36 14       		ld		(hl),$14
6384   1A3B 23          		inc		hl
6385   1A3C 36 0A       		ld		(hl),$0A
6386   1A3E 23          		inc		hl
6387   1A3F 36 F2       		ld		(hl), 242
6388   1A41             		
6389   1A41             		; Remove the old Pauline sprites
6390   1A41 AF          		xor     a
6391   1A42 32 00 69    		ld		(PAULINE_UPPER_SPRITE_X),a
6392   1A45 32 04 69    		ld		(PAULINE_LOWER_SPRITE_X),a
6393   1A48             		
6394   1A48                     ; Initialize the minor timer to 32
6395   1A48 3E 10               ld      a,16
6396   1A4A 32 09 60            ld      (MINOR_TIMER),a
6397   1A4D             
6398   1A4D             		; Advance to the next stage of the animation
6399   1A4D 21 88 63    		ld      hl,WIN_ANIMATION_STATE
6400   1A50 34                  inc     (hl)
6401   1A51 C9                  ret     
6402   1A52             ;------------------------------------------------------------------------------
6403   1A52             
6404   1A52             
6405   1A52             
6406   1A52             ;------------------------------------------------------------------------------
6407   1A52             L_SECRET_WIN_ANIM_3:	
6408   1A52             		; Display Donkey Kong pulling Pauline off-screen
6409   1A52 21 AF 62    		ld		hl,DK_REACHING_COUNTER
6410   1A55 34          		inc		(hl)
6411   1A56 7E          		ld		a,(hl)
6412   1A57 FE F8       		cp		248
6413   1A59             		
6414   1A59 32 08 69    		ld		(DK_SPRITE_1_X),a
6415   1A5C C6 02       		add		a,2
6416   1A5E 32 0C 69    		ld		(DK_SPRITE_2_X),a
6417   1A61             		
6418   1A61 C0          		ret		nz
6419   1A62             
6420   1A62             		; Hide Donkey Kong and Pauline
6421   1A62 06 04       		ld		b,4
6422   1A64 21 00 69    		ld		hl,PAULINE_UPPER_SPRITE_X
6423   1A67 11 04 00    		ld		de,4
6424   1A6A             l_secret_win_anim_3_1:		
6425   1A6A 36 00       		ld		(hl),0
6426   1A6C 19          		add		hl,de
6427   1A6D 10 FB       		djnz	l_secret_win_anim_3_1
6428   1A6F                     
6429   1A6F                     ; Initialize the minor timer to 32
6430   1A6F 3E 40               ld      a,64
6431   1A71 32 09 60            ld      (MINOR_TIMER),a
6432   1A74             		
6433   1A74             		; Advance to the next stage of the animation
6434   1A74 21 88 63    		ld      hl,WIN_ANIMATION_STATE
6435   1A77 34                  inc     (hl)
6436   1A78 C9                  ret     
6437   1A79             ;------------------------------------------------------------------------------
6438   1A79             
6439   1A79             
6440   1A79             
6441   1A79             ;------------------------------------------------------------------------------
6442   1A79             ; Clear the screen (everything) and move on to the next player
6443   1A79             L_PREP_FOR_NEXT_PLAYER:  
6444   1A79 CD 1D 08    		call    L_CLEAR_SCREEN_AND_SPRITES
6445   1A7C 3A 0E 60            ld      a,(SECOND_PLAYER)
6446   1A7F C6 12               add     a,18
6447   1A81 32 0A 60            ld      (GAME_SUBSTATE),a
6448   1A84 C9                  ret     
6449   1A85             ;------------------------------------------------------------------------------
6450   1A85             
6451   1A85             
6452   1A85             
6453   1A85             ;------------------------------------------------------------------------------
6454   1A85             ; This function runs the game, optionally simulating the player's input
6455   1A85             L_RUN_GAME_DEMO:  
6456   1A85 CD E1 22    		call    L_SIMULATE_DEMO_INPUT
6457   1A88             
6458   1A88             L_RUN_GAME:  
6459   1A88 CD C4 1E    		call    L_IMPLEMENT_POINT_AWARD
6460   1A8B CD A9 1F            call    L_CHECK_FOR_SMASH_ANIM
6461   1A8E CD EB 1B            call    l1ac3
6462   1A91 CD 88 20            call    l1f72
6463   1A94 CD 39 2D            call    l2c8f
6464   1A97 CD B6 2C            call    l2c03
6465   1A9A CD 81 31            call    L_IMPLEMENT_FIREBALLS
6466   1A9D CD B9 2E            call    L_IMPLEMENT_SPRINGS
6467   1AA0 CD B0 25            call    l24ea
6468   1AA3 CD 90 2E            call    L_RANDOMLY_RELEASE_FIREBALL
6469   1AA6 CD 7F 2F            call    L_ANIMATE_HAMMER_CYCLE
6470   1AA9 CD FA 22            call    L_IMPLEMENT_RET_LADDERS
6471   1AAC CD 66 1B            call    l1a33
6472   1AAF CD 61 2B            call    l2a85
6473   1AB2 CD 5C 20            call    l1f46
6474   1AB5 CD 6E 27            call    L_IMPLEMENT_ELEVATORS
6475   1AB8 CD 63 28    		call	L_IMPLEMENT_SECRET_ELEVATORS
6476   1ABB CD 9E 26            call    L_IMPLEMENT_CONVEYERS
6477   1ABE CD EB 1A            call    L_CHECK_IF_PRIZE_REACHED
6478   1AC1 CD 18 1B    		call	L_CHECK_IF_TRIGGER_REACHED
6479   1AC4 CD E5 03            call    L_ANIMATE_DK_AND_PAULINE
6480   1AC7 CD 23 29            call    L_CHECK_FOR_ENEMY_COLLISION
6481   1ACA CD 38 29            call    L_CHECK_FOR_HAMMER_KILL
6482   1ACD CD 4D 1F            call    L_CHECK_FOR_WIN_CONDITIONS
6483   1AD0 CD 3C 1B            call    l1a07
6484   1AD3 CD 69 30            call    l2fcb
6485   1AD6                     
6486   1AD6                     ; Return if Mario is still alive
6487   1AD6 3A 00 62            ld      a,(MARIO_ALIVE)
6488   1AD9 A7                  and     a
6489   1ADA C0                  ret     nz
6490   1ADB             		
6491   1ADB             		; Play the stomping sound
6492   1ADB CD 0F 01            call    L_SOUNDS_OFF
6493   1ADE 21 82 60            ld      hl,STOMP_SOUND_TRIGGER
6494   1AE1 36 03               ld      (hl),3
6495   1AE3             		
6496   1AE3             		; Advance to the next game substate
6497   1AE3 21 0A 60    l19d2:  ld      hl,GAME_SUBSTATE
6498   1AE6 34                  inc     (hl)
6499   1AE7             		
6500   1AE7             		; Set the minor timer to 64
6501   1AE7 2B                  dec     hl							; MINOR_TIMER
6502   1AE8 36 40               ld      (hl),64	
6503   1AEA C9                  ret     
6504   1AEB             ;------------------------------------------------------------------------------
6505   1AEB             
6506   1AEB             
6507   1AEB             
6508   1AEB             ;------------------------------------------------------------------------------
6509   1AEB             ; This function checks if Mario is on top of a prize sprite
6510   1AEB             ; If so, it triggers the point award system
6511   1AEB             ;
6512   1AEB             ; return:	a - 1 if a prize was reached, 0 otherwise
6513   1AEB             L_CHECK_IF_PRIZE_REACHED:  
6514   1AEB             		; Check each prize sprite to see if Mario has reached it
6515   1AEB             
6516   1AEB             		; If Mario's x coordinate matches this prize sprite's x coordinate
6517   1AEB             		; jump ahead
6518   1AEB 21 0C 6A            ld      hl,PRIZE_SPRITES
6519   1AEE 06 04               ld      b,4							; For b = 3 to 1 (3 prize sprites)
6520   1AF0             
6521   1AF0             lcheckifreached:
6522   1AF0 3A 03 62    		ld      a,(MARIO_X)
6523   1AF3             
6524   1AF3 BE          l19e2:  cp      (hl)
6525   1AF4 28 08               jr      z,l19ed
6526   1AF6             		
6527   1AF6             		; Examine the next prize sprite
6528   1AF6 2C                  inc     l
6529   1AF7 2C                  inc     l
6530   1AF8 2C                  inc     l
6531   1AF9 2C                  inc     l
6532   1AFA 10 F7               djnz    l19e2
6533   1AFC             		
6534   1AFC             		; Return if there are no more prize sprites
6535   1AFC AF          		xor		a
6536   1AFD C9                  ret     
6537   1AFE             
6538   1AFE             		; Return if Mario's y coordinate does not match the prize sprite's
6539   1AFE             		; y coordinate
6540   1AFE 3A 05 62    l19ed:  ld      a,(MARIO_Y)
6541   1B01 2C                  inc     l
6542   1B02 2C                  inc     l
6543   1B03 2C                  inc     l							; x coordinate
6544   1B04 BE                  cp      (hl)
6545   1B05 C0                  ret     nz
6546   1B06             
6547   1B06             		; Return if this prize sprite has already been awarded
6548   1B06             		; (The sprite number is one of the point award sprites)
6549   1B06 2D                  dec     l
6550   1B07 2D                  dec     l							; sprite number
6551   1B08 CB 5E               bit     3,(hl)
6552   1B0A C0                  ret     nz
6553   1B0B             		
6554   1B0B             		; Record this sprite address as the point award sprite address
6555   1B0B 2D                  dec     l							; start of the sprite data
6556   1B0C 22 43 63            ld      (SMASHED_SPRITE_POINTER),hl
6557   1B0F             		
6558   1B0F AF                  xor     a							; 0
6559   1B10 32 42 63            ld      (POINT_AWARD_TYPE),a
6560   1B13             		
6561   1B13 3C                  inc     a							; 1
6562   1B14 32 40 63            ld      (POINT_AWARD_STATE),a
6563   1B17 C9                  ret     
6564   1B18             ;------------------------------------------------------------------------------
6565   1B18             
6566   1B18             
6567   1B18             
6568   1B18             ;------------------------------------------------------------------------------
6569   1B18             ; Check if a cage trigger has been reached on the secret stage
6570   1B18             L_CHECK_IF_TRIGGER_REACHED:
6571   1B18             		; Return if this is not the secret stage
6572   1B18 3E 10       		ld		a,%00010000
6573   1B1A F7          		rst		$30
6574   1B1B             		
6575   1B1B             		; Use the prize collision detection routine to detect
6576   1B1B             		; collision with the trigger sprites
6577   1B1B 06 04       		ld		b,4							; 4 trigger sprites
6578   1B1D 21 70 69    		ld		hl,TRIGGER_SPRITES
6579   1B20 CD F0 1A    		call	lcheckifreached
6580   1B23             		
6581   1B23             		; If a trigger was not reached, return
6582   1B23 3D          		dec		a
6583   1B24 C0          		ret		nz
6584   1B25             		
6585   1B25             		; Reverse the direction of the elevators
6586   1B25 3C          		inc		a
6587   1B26 32 BB 62    		ld		(SECRET_ELEVATOR_REVERSE),a
6588   1B29             		
6589   1B29             		; Determine the starting coordinate of the right most cage
6590   1B29             		; bar 
6591   1B29 21 B8 62    		ld		hl,CAGE_BARS_REMAINING
6592   1B2C 46          		ld		b,(hl)
6593   1B2D 35          		dec		(hl)
6594   1B2E 21 7A 75    		ld		hl,TILE_COORD(11,26)
6595   1B31 11 E0 FF    		ld		de,-32
6596   1B34             
6597   1B34             l_check_if_trigger_reached_1:
6598   1B34 19          		add		hl,de
6599   1B35 10 FD       		djnz	l_check_if_trigger_reached_1
6600   1B37             		
6601   1B37             		; Remove the right most cage bar
6602   1B37 3E 10       		ld		a,$10						; Blank tile
6603   1B39 C3 31 0D    		jp		lsecret0d4c					
6604   1B3C             ;------------------------------------------------------------------------------
6605   1B3C             
6606   1B3C             
6607   1B3C             
6608   1B3C             ;------------------------------------------------------------------------------
6609   1B3C             l1a07:  
6610   1B3C 3A 86 63    		ld      a,($6386)
6611   1B3F EF                  rst     $28							; Jump to local table address
6612   1B40             		; Jump table
6613   1B40 51 1B       		.word 	l1a1e	; 0 = 
6614   1B42 48 1B       		.word	l1a15	; 1 = 
6615   1B44 52 1B       		.word	l1a1f	; 2 = 
6616   1B46 5D 1B       		.word	l1a2a	; 3 = 
6617   1B48             ;------------------------------------------------------------------------------
6618   1B48             
6619   1B48             
6620   1B48                     
6621   1B48             ;------------------------------------------------------------------------------
6622   1B48             l1a15:	
6623   1B48 AF          		xor     a
6624   1B49 32 87 63            ld      ($6387),a
6625   1B4C 3E 02               ld      a,$02
6626   1B4E 32 86 63            ld      ($6386),a
6627   1B51 C9          l1a1e:  ret     
6628   1B52             ;------------------------------------------------------------------------------
6629   1B52                     
6630   1B52             
6631   1B52             
6632   1B52             ;------------------------------------------------------------------------------
6633   1B52             l1a1f:	
6634   1B52 21 87 63    		ld      hl,$6387
6635   1B55 35                  dec     (hl)
6636   1B56 C0                  ret     nz
6637   1B57                     
6638   1B57 3E 03       		ld      a,$03
6639   1B59 32 86 63            ld      ($6386),a
6640   1B5C C9                  ret     
6641   1B5D             ;------------------------------------------------------------------------------
6642   1B5D                     
6643   1B5D             
6644   1B5D             
6645   1B5D             ;------------------------------------------------------------------------------
6646   1B5D             l1a2a:	
6647   1B5D 3A 16 62    		ld      a,(MARIO_IS_JUMPING)
6648   1B60 A7                  and     a
6649   1B61 C0                  ret     nz
6650   1B62             		
6651   1B62 E1                  pop     hl
6652   1B63 C3 E3 1A            jp      l19d2
6653   1B66             		
6654   1B66             		; Return unless this is the rivets stage
6655   1B66 3E 08       l1a33:  ld      a,%00001000
6656   1B68 F7                  rst     $30							
6657   1B69 3A 03 62            ld      a,(MARIO_X)
6658   1B6C FE 4B               cp      $4b
6659   1B6E 28 0B               jr      z,l1a4b
6660   1B70 FE B3               cp      $b3
6661   1B72 28 07               jr      z,l1a4b
6662   1B74 3A 91 62            ld      a,($6291)
6663   1B77 3D                  dec     a
6664   1B78 28 07               jr      z,l1a51
6665   1B7A C9                  ret     
6666   1B7B             
6667   1B7B 3E 01       l1a4b:  ld      a,$01
6668   1B7D 32 91 62            ld      ($6291),a
6669   1B80 C9                  ret     
6670   1B81             
6671   1B81 32 91 62    l1a51:  ld      ($6291),a
6672   1B84 47                  ld      b,a
6673   1B85 3A 05 62            ld      a,(MARIO_Y)
6674   1B88 3D                  dec     a
6675   1B89 FE D0               cp      $d0
6676   1B8B D0                  ret     nc
6677   1B8C             		
6678   1B8C 07                  rlca    
6679   1B8D 30 02               jr      nc,l1a62
6680   1B8F CB D0               set     2,b
6681   1B91 07          l1a62:  rlca    
6682   1B92 07                  rlca    
6683   1B93 30 02               jr      nc,l1a69
6684   1B95 CB C8               set     1,b
6685   1B97 E6 07       l1a69:  and     $07
6686   1B99 FE 06               cp      $06
6687   1B9B 20 02               jr      nz,l1a72
6688   1B9D CB C8               set     1,b
6689   1B9F 3A 03 62    l1a72:  ld      a,(MARIO_X)
6690   1BA2 07                  rlca    
6691   1BA3 30 02               jr      nc,l1a7b
6692   1BA5 CB C0               set     0,b
6693   1BA7 21 92 62    l1a7b:  ld      hl,$6292
6694   1BAA 78                  ld      a,b
6695   1BAB 85                  add     a,l
6696   1BAC 6F                  ld      l,a
6697   1BAD 7E                  ld      a,(hl)
6698   1BAE A7                  and     a
6699   1BAF C8                  ret     z
6700   1BB0 36 00               ld      (hl),$00
6701   1BB2 21 90 62            ld      hl,REMAINING_RIVETS
6702   1BB5 35                  dec     (hl)
6703   1BB6 78                  ld      a,b
6704   1BB7 01 05 00            ld      bc,$0005
6705   1BBA 1F                  rra     
6706   1BBB 38 29               jr      c,l1abd
6707   1BBD 21 CB 02            ld      hl,$02cb
6708   1BC0 A7          l1a95:  and     a
6709   1BC1 28 04               jr      z,l1a9e
6710   1BC3 09          l1a99:  add     hl,bc
6711   1BC4 3D                  dec     a
6712   1BC5 20 FC               jr      nz,l1a99
6713   1BC7 01 00 74    l1a9e:  ld      bc,TILE_COORD(0,0)
6714   1BCA 09                  add     hl,bc
6715   1BCB 3E 10               ld      a,$10
6716   1BCD 77                  ld      (hl),a
6717   1BCE 2D                  dec     l
6718   1BCF 77                  ld      (hl),a
6719   1BD0 2C                  inc     l
6720   1BD1 2C                  inc     l
6721   1BD2 77                  ld      (hl),a
6722   1BD3 3E 01               ld      a,1
6723   1BD5 32 40 63            ld      (POINT_AWARD_STATE),a
6724   1BD8 32 42 63            ld      (POINT_AWARD_TYPE),a
6725   1BDB 32 25 62            ld      ($6225),a
6726   1BDE 3A 16 62            ld      a,(MARIO_IS_JUMPING)
6727   1BE1 A7                  and     a
6728   1BE2 CC 9C 1E            call    z,l1d95
6729   1BE5 C9                  ret     
6730   1BE6             		
6731   1BE6 21 2B 01    l1abd:  ld      hl,$012b
6732   1BE9 18 D5               jr      l1a95
6733   1BEB             ;------------------------------------------------------------------------------
6734   1BEB             
6735   1BEB             		
6736   1BEB             
6737   1BEB             ;------------------------------------------------------------------------------
6738   1BEB             l1ac3:  
6739   1BEB             		; If Mario is still in a jump, 
6740   1BEB             		; jump ahead
6741   1BEB 3A 16 62    		ld      a,(MARIO_IS_JUMPING)
6742   1BEE 3D                  dec     a
6743   1BEF CA D2 1C            jp      z,l1bb2						; Exceeds relative branch
6744   1BF2                     
6745   1BF2                     ; If the hammer cycle delay is active, jump ahead to handle it
6746   1BF2 3A 1E 62            ld      a,(MARIO_HAMMER_CYCLE_DELAY)
6747   1BF5 A7                  and     a
6748   1BF6 20 7A               jr      nz,l1b55
6749   1BF8                     
6750   1BF8                     ; If the hammer cycle is active, jump ahead
6751   1BF8 3A 17 62            ld      a,(HAMMER_CYCLE_ACTIVE)
6752   1BFB 3D                  dec     a
6753   1BFC 28 0D               jr      z,l1ae6
6754   1BFE                     
6755   1BFE                     ; If Mario is climbing, jump ahead
6756   1BFE 3A 15 62            ld      a,(MARIO_IS_CLIMBING)
6757   1C01 3D                  dec     a
6758   1C02 28 52               jr      z,l1b38
6759   1C04                     
6760   1C04                     ; If the jump button is pressed, jump ahead
6761   1C04 3A 10 60            ld      a,(PLAYER_INPUT)
6762   1C07 17                  rla     
6763   1C08 DA 8B 1C            jp      c,l1b6e						; Exceeds relative branch
6764   1C0B                     
6765   1C0B                     ; d will be 1 if Mario can't move left
6766   1C0B                     ; e will be 1 if Mario can't move right
6767   1C0B CD F3 24    l1ae6:  call    L_IMPLEMENT_BARRIERS
6768   1C0E                     
6769   1C0E                     ; If Mario is blocked to the right, 
6770   1C0E                     ; jump ahead to ignore the joystick right input  
6771   1C0E 3A 10 60            ld      a,(PLAYER_INPUT)
6772   1C11 1D                  dec     e
6773   1C12 28 05               jr      z,l1af5
6774   1C14                     
6775   1C14                     ; If the joystick is pressed to the right, jump ahead to process it
6776   1C14 CB 47               bit     0,a							; right input
6777   1C16 C2 A5 1D            jp      nz,l1c8f					; Exceeds relative branch
6778   1C19                     
6779   1C19                     ; If Mario is blocked to the left, 
6780   1C19                     ; jump ahead to ignore the joystick left input  
6781   1C19 15          l1af5:  dec     d
6782   1C1A 28 05               jr      z,l1afe
6783   1C1C                     
6784   1C1C                     ; If the joystick is pressed to the left, jump ahead to process it
6785   1C1C CB 4F               bit     1,a
6786   1C1E C2 BF 1D            jp      nz,l1cab					; Exceeds relative branch
6787   1C21                     
6788   1C21                     ; If the hammer cycle is active (can't climb ladders), 
6789   1C21             		; then return
6790   1C21 3A 17 62    l1afe:  ld      a,(HAMMER_CYCLE_ACTIVE)
6791   1C24 3D                  dec     a
6792   1C25 C8          		ret     z
6793   1C26             		
6794   1C26             		; Add 8 pixels to Mario's y coordinate to where his feet are
6795   1C26 3A 05 62            ld      a,(MARIO_Y)
6796   1C29 C6 08               add     a,8
6797   1C2B 57                  ld      d,a
6798   1C2C                     
6799   1C2C                     ; Fudge Mario's x coordinate a bit to make it easier to get 
6800   1C2C             		; on a ladder
6801   1C2C 3A 03 62            ld      a,(MARIO_X)
6802   1C2F F6 03               or      %00000011
6803   1C31 CB 97               res     2,a
6804   1C33                     
6805   1C33                     ; Check if Mario is on a ladder
6806   1C33                     ; a will be 0 if at the bottom, 1 if at the top
6807   1C33                     ; This function will be aborted if no ladder
6808   1C33 CD 46 24            call    L_CHECK_IF_ON_LADDER
6809   1C36                     
6810   1C36                     ; Set Mario's sprite to $06, flipped horizontally 
6811   1C36                     ; to match the current sprite number
6812   1C36 F5                  push    af
6813   1C37 21 07 62            ld      hl,MARIO_DATA_SPRITE_NUM
6814   1C3A 7E                  ld      a,(hl)
6815   1C3B E6 80               and     %10000000
6816   1C3D F6 06               or      %00000110
6817   1C3F 77                  ld      (hl),a
6818   1C40                     
6819   1C40                     ; If Mario is standing over a normal ladder,
6820   1C40                     ; set $621a to 1
6821   1C40 21 1A 62            ld      hl,$621a
6822   1C43 3E 04               ld      a,4
6823   1C45 B9                  cp      c
6824   1C46 36 01               ld      (hl),1
6825   1C48 30 01               jr      nc,l1b2c
6826   1C4A                     
6827   1C4A                     ; If Mario is standing over a broken ladder,
6828   1C4A                     ; set $621a to 0
6829   1C4A 35                  dec     (hl)
6830   1C4B                     
6831   1C4B                     ; If Mario is at the bottom of a ladder,
6832   1C4B                     ; jump ahead
6833   1C4B F1          l1b2c:  pop     af
6834   1C4C A7                  and     a
6835   1C4D 28 1D               jr      z,l1b4e
6836   1C4F                     
6837   1C4F                     ; Mario is at the top of a ladder
6838   1C4F                     ; If this is a normal ladder, return
6839   1C4F 7E                  ld      a,(hl)
6840   1C50 A7                  and     a
6841   1C51 C0                  ret     nz
6842   1C52                     
6843   1C52                     ; Save the coordinate of the top of the ladder
6844   1C52 2C                  inc     l							; TOP_OF_CURRENT_LADDER
6845   1C53 72                  ld      (hl),d
6846   1C54                     
6847   1C54                     ; Save the coordinate of the bottom of the ladder
6848   1C54 2C                  inc     l							; BOT_OF_CURRENT_LADDER
6849   1C55 70                  ld      (hl),b
6850   1C56                     
6851   1C56                     ; If the joystick is being pressed down, jump ahead
6852   1C56 3A 10 60    l1b38:  ld      a,(PLAYER_INPUT)
6853   1C59 CB 5F               bit     3,a
6854   1C5B C2 04 1E            jp      nz,l1cf2					; Exceeds relative branch
6855   1C5E                     
6856   1C5E                     ; Return if Mario is not climbing a ladder
6857   1C5E 3A 15 62            ld      a,(MARIO_IS_CLIMBING)
6858   1C61 A7                  and     a
6859   1C62 C8                  ret     z
6860   1C63             		
6861   1C63             		; If the joystick is being pressed up, jump ahead
6862   1C63 3A 10 60    l1b45:  ld      a,(PLAYER_INPUT)
6863   1C66 CB 57               bit     2,a
6864   1C68 C2 14 1E            jp      nz,l1d03					; Exceeds relative branch
6865   1C6B C9                  ret     
6866   1C6C             		
6867   1C6C             		; Mario is at the bottom of a ladder
6868   1C6C 2C          l1b4e:  inc     l							; TOP_OF_CURRENT_LADDER
6869   1C6D 70                  ld      (hl),b
6870   1C6E 2C                  inc     l							; BOT_OF_CURRENT_LADDER
6871   1C6F 72                  ld      (hl),d
6872   1C70 18 F1               jr      l1b45
6873   1C72                     
6874   1C72             		; Decrement the hammer cycle delay and return if it hasn't
6875   1C72             		; reached 0
6876   1C72 21 1E 62    l1b55:  ld      hl,MARIO_HAMMER_CYCLE_DELAY
6877   1C75 35                  dec     (hl)
6878   1C76 C0                  ret     nz
6879   1C77             		
6880   1C77             		; Activate the hammer cycle
6881   1C77 3A 18 62            ld      a,(HAMMER_GRABBED)
6882   1C7A 32 17 62            ld      (HAMMER_CYCLE_ACTIVE),a
6883   1C7D             		
6884   1C7D             		; Face Mario's sprite in the correct direction
6885   1C7D 21 07 62            ld      hl,MARIO_DATA_SPRITE_NUM
6886   1C80 7E                  ld      a,(hl)
6887   1C81 E6 80               and     $80
6888   1C83 77                  ld      (hl),a
6889   1C84 AF                  xor     a
6890   1C85 32 02 62            ld      ($6202),a
6891   1C88                     
6892   1C88                     ; Jump ahead to update Mario's coordinate and sprite data
6893   1C88                     ; and return
6894   1C88 C3 AD 1E            jp      l1da6						; Exceeds relative branch
6895   1C8B                     
6896   1C8B                     ; Jump button is pressed
6897   1C8B             		
6898   1C8B             		; Flag Mario as jumping
6899   1C8B 3E 01       l1b6e:  ld      a,1
6900   1C8D 32 16 62            ld      (MARIO_IS_JUMPING),a
6901   1C90             		
6902   1C90             		; Make sure the Mario on elevator flag is cleared
6903   1C90 AF          		xor		a
6904   1C91 32 98 63    		ld		(MARIO_ON_ELEVATOR),a ; SECRET STAGE
6905   1C94             		
6906   1C94             		; If the joystick is pressed right, 
6907   1C94             		; set MARIO_JUMPING_LEFT to $00 
6908   1C94             		; and MARIO_JUMPING_RIGHT to $80
6909   1C94 21 10 62            ld      hl,MARIO_JUMPING_LEFT
6910   1C97 3A 10 60            ld      a,(PLAYER_INPUT)
6911   1C9A 01 80 00            ld      bc,$0080
6912   1C9D 1F                  rra     
6913   1C9E 38 0A               jr      c,l1b8a
6914   1CA0             		; If the joystick is pressed left
6915   1CA0             		; set MARIO_JUMPING_LEFT to $ff 
6916   1CA0             		; and MARIO_JUMPING_RIGHT to $80
6917   1CA0 01 80 FF            ld      bc,$ff80
6918   1CA3 1F                  rra     
6919   1CA4 DA AA 1C            jp      c,l1b8a						; Exceeds relative branch
6920   1CA7             		; If the joystick is centered
6921   1CA7             		; set MARIO_JUMPING_LEFT to $00 
6922   1CA7             		; and MARIO_JUMPING_RIGHT to $00
6923   1CA7 01 00 00            ld      bc,$0000
6924   1CAA AF          l1b8a:  xor     a
6925   1CAB 70                  ld      (hl),b
6926   1CAC 2C                  inc     l							; MARIO_JUMPING_RIGHT
6927   1CAD 71                  ld      (hl),c
6928   1CAE             		
6929   1CAE 2C                  inc     l							; $6212
6930   1CAF 36 01               ld      (hl),$01
6931   1CB1 2C                  inc     l							; $6213
6932   1CB2 36 48               ld      (hl),$48
6933   1CB4 2C                  inc     l							; $6214
6934   1CB5 77                  ld      (hl),a
6935   1CB6 32 04 62            ld      ($6204),a
6936   1CB9 32 06 62            ld      ($6206),a
6937   1CBC                     
6938   1CBC             		; Change Mario's sprite to him jumping, flipped to the correct direction
6939   1CBC 3A 07 62    		ld      a,(MARIO_DATA_SPRITE_NUM)
6940   1CBF E6 80               and     %10000000
6941   1CC1 F6 0E               or      $0e							; Jumping sprite
6942   1CC3 32 07 62            ld      (MARIO_DATA_SPRITE_NUM),a
6943   1CC6             		
6944   1CC6             		; Save the y coordinate of the start of the jump
6945   1CC6 3A 05 62            ld      a,(MARIO_Y)
6946   1CC9 32 0E 62            ld      (MARIO_JUMP_Y_COORD),a
6947   1CCC             		
6948   1CCC             		; Trigger the jumping sound
6949   1CCC 21 81 60            ld      hl,JUMP_SOUND_TRIGGER
6950   1CCF 36 03               ld      (hl),3
6951   1CD1 C9                  ret    
6952   1CD2             		
6953   1CD2             		; Mario is jumping
6954   1CD2             		
6955   1CD2 DD 21 00 62 l1bb2:  ld      ix,MARIO_DATA_STRUCT
6956   1CD6 3A 03 62            ld      a,(MARIO_X)
6957   1CD9 DD 77 0B            ld      (ix+11),a
6958   1CDC 3A 05 62            ld      a,(MARIO_Y)
6959   1CDF DD 77 0C            ld      (ix+12),a
6960   1CE2                     
6961   1CE2 CD 71 24            call    l239c
6962   1CE5                     
6963   1CE5             		; Check for barriers
6964   1CE5 CD F3 24            call    L_IMPLEMENT_BARRIERS
6965   1CE8                     
6966   1CE8                     ; If Mario can move left, jump ahead
6967   1CE8 15                  dec     d
6968   1CE9 20 24               jr      nz,l1bf2
6969   1CEB                     
6970   1CEB             		; Mario is blocked to the left
6971   1CEB             		; Force Mario to bounce to the right
6972   1CEB DD 36 10 00         ld      (ix+16),0					; MARIO_JUMPING_LEFT
6973   1CEF DD 36 11 80         ld      (ix+17),$80					; MARIO_JUMPING_RIGHT
6974   1CF3 DD CB 07 FE         set     7,(ix+7)					; Sprite number
6975   1CF7                     
6976   1CF7 3A 20 62    l1bd8:  ld      a,($6220)
6977   1CFA 3D                  dec     a
6978   1CFB 28 0D               jr      z,l1bec
6979   1CFD                     
6980   1CFD CD DB 24            call    l2407
6981   1D00                     
6982   1D00 DD 74 12            ld      (ix+18),h
6983   1D03 DD 75 13            ld      (ix+19),l
6984   1D06 DD 36 14 00         ld      (ix+20),0
6985   1D0A                     
6986   1D0A CD 71 24    l1bec:  call    l239c
6987   1D0D 18 11               jr      l1c05
6988   1D0F                     
6989   1D0F                     ; If Mario can move right, jump ahead
6990   1D0F 1D          l1bf2:  dec     e
6991   1D10 20 0E               jr      nz,l1c05
6992   1D12                     
6993   1D12             		; Mario is blocked to the right
6994   1D12             		; Force Mario to bounce to the left
6995   1D12 DD 36 10 FF         ld      (ix+16),$FF					; MARIO_JUMPING_LEFT
6996   1D16 DD 36 11 80         ld      (ix+17),$80					; MARIO_JUMPING_RIGHT
6997   1D1A DD CB 07 BE         res     7,(ix+7)					; Mario's sprite number
6998   1D1E 18 D7               jr      l1bd8
6999   1D20                     
7000   1D20                     
7001   1D20 CD E2 2B    l1c05:  call    l2b1c
7002   1D23 3D                  dec     a
7003   1D24 28 2B               jr      z,l1c3a
7004   1D26 3A 1F 62            ld      a,($621f)
7005   1D29 3D                  dec     a
7006   1D2A 28 60               jr      z,l1c76
7007   1D2C 3A 14 62            ld      a,($6214)
7008   1D2F D6 14               sub     $14
7009   1D31 20 17               jr      nz,l1c33
7010   1D33 3E 01               ld      a,$01
7011   1D35 32 1F 62            ld      ($621f),a
7012   1D38 CD 6D 29            call    L_CHECK_FOR_ENEMY_JUMP
7013   1D3B A7                  and     a
7014   1D3C                     
7015   1D3C                     ; If an enemy has not been jumped,
7016   1D3C             		; jump ahead to update Mario's coordinate and sprite data
7017   1D3C                     ; and return
7018   1D3C CA AD 1E            jp      z,l1da6						; Exceeds relative branch
7019   1D3F                     
7020   1D3F             		; Initiate a point reward for jumping an enemy
7021   1D3F 32 42 63            ld      (POINT_AWARD_TYPE),a
7022   1D42 3E 01               ld      a,1
7023   1D44 32 40 63            ld      (POINT_AWARD_STATE),a
7024   1D47 32 25 62            ld      ($6225),a
7025   1D4A             		
7026   1D4A 3C          l1c33:  inc     a
7027   1D4B CC 43 2A            call    z,L_IMPLEMENT_HAMMER_GRAB
7028   1D4E                     
7029   1D4E                     ; Jump ahead to update Mario's coordinate and sprite data
7030   1D4E                     ; and return
7031   1D4E C3 AD 1E            jp      l1da6						; Exceeds relative branch
7032   1D51                     
7033   1D51 05          l1c3a:  dec     b
7034   1D52 28 11               jr      z,l1c4f
7035   1D54 3C                  inc     a
7036   1D55 32 1F 62            ld      ($621f),a
7037   1D58 AF                  xor     a
7038   1D59 21 10 62            ld      hl,MARIO_JUMPING_LEFT
7039   1D5C 06 05               ld      b,$05
7040   1D5E 77          l1c48:  ld      (hl),a
7041   1D5F 2C                  inc     l
7042   1D60 10 FC               djnz    l1c48
7043   1D62                     
7044   1D62                     ; Jump ahead to update Mario's coordinate and sprite data
7045   1D62                     ; and return
7046   1D62 C3 AD 1E            jp      l1da6						; Exceeds relative branch
7047   1D65                     
7048   1D65 32 16 62    l1c4f:  ld      (MARIO_IS_JUMPING),a
7049   1D68 3A 20 62            ld      a,($6220)
7050   1D6B EE 01               xor     1
7051   1D6D 32 00 62            ld      (MARIO_ALIVE),a
7052   1D70 21 07 62            ld      hl,MARIO_DATA_SPRITE_NUM
7053   1D73 7E                  ld      a,(hl)
7054   1D74 E6 80               and     $80
7055   1D76 F6 0F               or      $0f
7056   1D78 77                  ld      (hl),a
7057   1D79 3E 04               ld      a,$04
7058   1D7B 32 1E 62            ld      (MARIO_HAMMER_CYCLE_DELAY),a
7059   1D7E AF                  xor     a
7060   1D7F 32 1F 62            ld      ($621f),a
7061   1D82 3A 25 62            ld      a,($6225)
7062   1D85 3D                  dec     a
7063   1D86 CC 9C 1E            call    z,l1d95
7064   1D89                     
7065   1D89                     ; Jump ahead to update Mario's coordinate and sprite data
7066   1D89                     ; and return
7067   1D89 C3 AD 1E            jp      l1da6
7068   1D8C                     
7069   1D8C 3A 05 62    l1c76:  ld      a,(MARIO_Y)
7070   1D8F 21 0E 62            ld      hl,MARIO_JUMP_Y_COORD
7071   1D92 D6 0F               sub     $0f
7072   1D94 BE                  cp      (hl)
7073   1D95                     
7074   1D95                     ; Jump ahead to update Mario's coordinate and sprite data
7075   1D95                     ; and return
7076   1D95 DA AD 1E            jp      c,l1da6						; Exceeds relative branch
7077   1D98                     
7078   1D98 3E 01               ld      a,$01
7079   1D9A 32 20 62            ld      ($6220),a
7080   1D9D 21 84 60            ld      hl,FALL_SOUND_TRIGGER
7081   1DA0 36 03               ld      (hl),$03
7082   1DA2                     
7083   1DA2                     ; Jump ahead to update Mario's coordinate and sprite data
7084   1DA2                     ; and return
7085   1DA2 C3 AD 1E            jp      l1da6						; Exceeds relative branch
7086   1DA5                     
7087   1DA5 06 01       l1c8f:  ld      b,1
7088   1DA7 3A 0F 62            ld      a,($620f)
7089   1DAA A7                  and     a
7090   1DAB 20 38               jr      nz,l1cd2
7091   1DAD 3A 02 62            ld      a,($6202)
7092   1DB0 47                  ld      b,a
7093   1DB1 3E 05               ld      a,5
7094   1DB3 CD A7 30            call    l3009
7095   1DB6 32 02 62            ld      ($6202),a
7096   1DB9 E6 03               and     $03
7097   1DBB F6 80               or      $80
7098   1DBD 18 16               jr      l1cc2
7099   1DBF 06 FF       l1cab:  ld      b,$ff
7100   1DC1 3A 0F 62            ld      a,($620f)
7101   1DC4 A7                  and     a
7102   1DC5 20 1E               jr      nz,l1cd2
7103   1DC7 3A 02 62            ld      a,($6202)
7104   1DCA 47                  ld      b,a
7105   1DCB 3E 01               ld      a,1
7106   1DCD CD A7 30            call    l3009
7107   1DD0 32 02 62            ld      ($6202),a
7108   1DD3 E6 03               and     $03
7109   1DD5 21 07 62    l1cc2:  ld      hl,MARIO_DATA_SPRITE_NUM
7110   1DD8 77                  ld      (hl),a
7111   1DD9 1F                  rra     
7112   1DDA DC 96 1E            call    c,l1d8f
7113   1DDD 3E 02               ld      a,$02
7114   1DDF 32 0F 62            ld      ($620f),a
7115   1DE2                     
7116   1DE2                     ; Jump ahead to update Mario's coordinate and sprite data
7117   1DE2                     ; and return
7118   1DE2 C3 AD 1E            jp      l1da6						; Exceeds relative branch
7119   1DE5                     
7120   1DE5 21 03 62    l1cd2:  ld      hl,MARIO_X
7121   1DE8 7E                  ld      a,(hl)
7122   1DE9 80                  add     a,b
7123   1DEA 77                  ld      (hl),a
7124   1DEB 3A 27 62            ld      a,(CURRENT_STAGE)
7125   1DEE 3D                  dec     a
7126   1DEF 20 0C               jr      nz,l1ceb
7127   1DF1 66                  ld      h,(hl)
7128   1DF2 3A 05 62            ld      a,(MARIO_Y)
7129   1DF5 6F                  ld      l,a
7130   1DF6 CD 13 24            call    L_MOVE_SPRITE_ALONG_PLAT
7131   1DF9 7D                  ld      a,l
7132   1DFA 32 05 62            ld      (MARIO_Y),a
7133   1DFD 21 0F 62    l1ceb:  ld      hl,$620f
7134   1E00 35                  dec     (hl)
7135   1E01                     
7136   1E01                     ; Jump ahead to update Mario's coordinate and sprite data
7137   1E01                     ; and return
7138   1E01 C3 AD 1E            jp      l1da6						; Exceeds relative branch
7139   1E04                     
7140   1E04                     ; If $620f is not 0, jump ahead
7141   1E04 3A 0F 62    l1cf2:  ld      a,($620f)
7142   1E07 A7                  and     a
7143   1E08 C2 91 1E            jp      nz,l1d8a					; Exceeds relative branch
7144   1E0B                     
7145   1E0B                     ; Reset $620f to 3
7146   1E0B 3E 03               ld      a,3
7147   1E0D 32 0F 62            ld      ($620f),a
7148   1E10                     
7149   1E10                     ; Jump ahead to move Mario Mario down 2 pixels
7150   1E10 3E 02               ld      a,2
7151   1E12 18 0D               jr      l1d11
7152   1E14                     
7153   1E14 3A 0F 62    l1d03:  ld      a,($620f)
7154   1E17 A7                  and     a
7155   1E18 20 64               jr      nz,l1d76
7156   1E1A 3E 04               ld      a,$04
7157   1E1C 32 0F 62            ld      ($620f),a
7158   1E1F 3E FE               ld      a,-2
7159   1E21                     
7160   1E21                     ; Move Mario up or down the ladder
7161   1E21 21 05 62    l1d11:  ld      hl,MARIO_Y
7162   1E24 86                  add     a,(hl)
7163   1E25 77                  ld      (hl),a
7164   1E26                     
7165   1E26 47                  ld      b,a
7166   1E27 3A 22 62            ld      a,($6222)
7167   1E2A EE 01               xor     %00000001
7168   1E2C 32 22 62            ld      ($6222),a
7169   1E2F                     
7170   1E2F 20 2A               jr      nz,l1d51
7171   1E31                     
7172   1E31                     ; If Mario (Mario's y coordinate + 8) has reached the bottom of the ladder,
7173   1E31                     ; jump ahead
7174   1E31 78                  ld      a,b
7175   1E32 C6 08               add     a,8
7176   1E34 21 1C 62            ld      hl,BOT_OF_CURRENT_LADDER
7177   1E37 BE                  cp      (hl)
7178   1E38 28 36               jr      z,l1d67
7179   1E3A                     
7180   1E3A                     ; If Mario (Mario's y coordinate + 8) has reached the top of the ladder,
7181   1E3A                     ; jump ahead
7182   1E3A 2D                  dec     l						; TOP_OF_CURRENT_LADDER
7183   1E3B 96                  sub     (hl)
7184   1E3C 28 32               jr      z,l1d67
7185   1E3E                     
7186   1E3E                     ; Determine what Mario sprite to use
7187   1E3E                     ; If Mario is still near the top of the ladder, 
7188   1E3E                     ; one of the "just starting to climb down the ladder"
7189   1E3E                     ; sprites is used; otherwise the "climbing the ladder"
7190   1E3E                     ; sprite is used
7191   1E3E 06 05               ld      b,$05
7192   1E40 D6 08               sub     8
7193   1E42 28 06               jr      z,l1d3f
7194   1E44 05                  dec     b	; $04
7195   1E45 D6 04               sub     4
7196   1E47 28 01               jr      z,l1d3f
7197   1E49 05                  dec     b	; $03
7198   1E4A                     
7199   1E4A                     ; Set Mario's sprite number flipped horizontally to match the 
7200   1E4A                     ; current sprite's orientation
7201   1E4A 3E 80       l1d3f:  ld      a,%10000000
7202   1E4C 21 07 62            ld      hl,MARIO_DATA_SPRITE_NUM
7203   1E4F A6                  and     (hl)
7204   1E50 EE 80               xor     $80
7205   1E52 B0                  or      b
7206   1E53 77                  ld      (hl),a
7207   1E54                     
7208   1E54                     ; Flag Mario as climbing a ladder
7209   1E54 3E 01       l1d49:  ld      a,1
7210   1E56 32 15 62            ld      (MARIO_IS_CLIMBING),a
7211   1E59                     
7212   1E59                     ; Jump ahead to update Mario's coordinate and sprite data
7213   1E59                     ; and return
7214   1E59 18 52               jr      l1da6
7215   1E5B                     
7216   1E5B 2D          l1d51:  dec     l
7217   1E5C 2D                  dec     l
7218   1E5D 7E                  ld      a,(hl)
7219   1E5E F6 03               or      $03
7220   1E60 CB 97               res     2,a
7221   1E62 77                  ld      (hl),a
7222   1E63 3A 24 62            ld      a,($6224)
7223   1E66 EE 01               xor     $01
7224   1E68 32 24 62            ld      ($6224),a
7225   1E6B CC 96 1E            call    z,l1d8f
7226   1E6E 18 E4               jr      l1d49
7227   1E70 3E 06       l1d67:  ld      a,$06
7228   1E72 32 07 62            ld      (MARIO_DATA_SPRITE_NUM),a
7229   1E75 AF                  xor     a
7230   1E76 32 19 62            ld      ($6219),a
7231   1E79 32 15 62            ld      (MARIO_IS_CLIMBING),a
7232   1E7C                     
7233   1E7C                     ; Jump ahead to update Mario's coordinate and sprite data
7234   1E7C                     ; and return
7235   1E7C 18 2F               jr      l1da6
7236   1E7E                     
7237   1E7E 3A 1A 62    l1d76:  ld      a,($621a)
7238   1E81 A7                  and     a
7239   1E82 28 0D               jr      z,l1d8a
7240   1E84 32 19 62            ld      ($6219),a
7241   1E87 3A 1C 62            ld      a,(BOT_OF_CURRENT_LADDER)
7242   1E8A D6 13               sub     $13
7243   1E8C 21 05 62            ld      hl,MARIO_Y
7244   1E8F BE                  cp      (hl)
7245   1E90 D0                  ret     nc
7246   1E91             		
7247   1E91 21 0F 62    l1d8a:  ld      hl,$620f
7248   1E94 35                  dec     (hl)
7249   1E95 C9                  ret     
7250   1E96             		
7251   1E96 3E 03       l1d8f:  ld      a,$03
7252   1E98 32 80 60            ld      (WALK_SOUND_TRIGGER),a
7253   1E9B C9                  ret     
7254   1E9C             
7255   1E9C 32 25 62    l1d95:  ld      ($6225),a
7256   1E9F 3A 27 62            ld      a,(CURRENT_STAGE)
7257   1EA2 3D                  dec     a
7258   1EA3 C8                  ret     z
7259   1EA4             		
7260   1EA4 21 8A 60            ld      hl,PENDING_SONG_TRIGGER
7261   1EA7 36 0D               ld      (hl),SONG_TRIGGER_RIVET_REMOVED
7262   1EA9 2C                  inc     l
7263   1EAA 36 03               ld      (hl),3
7264   1EAC C9                  ret     
7265   1EAD             		
7266   1EAD             		; Update Mario's x coordinate
7267   1EAD 21 4C 69    l1da6:  ld      hl,MARIO_SPRITE_X
7268   1EB0 3A 03 62            ld      a,(MARIO_X)
7269   1EB3 77                  ld      (hl),a
7270   1EB4                     
7271   1EB4                     ; Update Mario's sprite number
7272   1EB4 3A 07 62            ld      a,(MARIO_DATA_SPRITE_NUM)
7273   1EB7 2C                  inc     l						; MARIO_SPRITE_NUM
7274   1EB8 77                  ld      (hl),a
7275   1EB9                     
7276   1EB9                     ; Update Mario's palette
7277   1EB9 3A 08 62            ld      a,(MARIO_DATA_PALETTE)
7278   1EBC 2C                  inc     l						; MARIO_SPRITE_PAL
7279   1EBD 77                  ld      (hl),a
7280   1EBE                     
7281   1EBE                     ; Update Mario's y coordinate
7282   1EBE 3A 05 62            ld      a,(MARIO_Y)
7283   1EC1 2C                  inc     l						; MARIO_SPRITE_Y
7284   1EC2 77                  ld      (hl),a
7285   1EC3 C9                  ret   
7286   1EC4             ;------------------------------------------------------------------------------
7287   1EC4             
7288   1EC4             
7289   1EC4             	
7290   1EC4             ;------------------------------------------------------------------------------
7291   1EC4             ; Implement the awarding of points to the player.
7292   1EC4             L_IMPLEMENT_POINT_AWARD:  
7293   1EC4 3A 40 63    		ld      a,(POINT_AWARD_STATE)
7294   1EC7 EF                  rst     $28							; Jump to local table address
7295   1EC8             		; Jump table
7296   1EC8 3F 1F       		.word	L_NO_POINTS_TO_DISPLAY	; 0 = no points to award
7297   1ECA CE 1E       		.word	L_GIVE_POINT_AWARD	; 1 = award points
7298   1ECC 40 1F       		.word	L_DISPLAY_POINT_AWARD_SPRITE	; 2 = display points until timeout
7299   1ECE             ;------------------------------------------------------------------------------
7300   1ECE             
7301   1ECE             
7302   1ECE             
7303   1ECE             ;------------------------------------------------------------------------------
7304   1ECE             ; Determine how many points should be awarded to the player and
7305   1ECE             ; award them and display the award sprite
7306   1ECE             L_GIVE_POINT_AWARD:  
7307   1ECE             		; Initialize the point award display timer
7308   1ECE 3E 40       		ld      a,64
7309   1ED0 32 41 63            ld      (POINT_AWARD_DISPLAY_TIMER),a
7310   1ED3             		
7311   1ED3             		; Advance the point award state (display points)
7312   1ED3 3E 02               ld      a,2
7313   1ED5 32 40 63            ld      (POINT_AWARD_STATE),a
7314   1ED8             		
7315   1ED8             		; If the point award type is 1, 
7316   1ED8             		; jump ahead
7317   1ED8 3A 42 63            ld      a,(POINT_AWARD_TYPE)
7318   1EDB 1F                  rra    
7319   1EDC DA 01 3F            jp      c,DETERMINE_POINT_AWARD_AMT	; Exceeds relative branch
7320   1EDF             		
7321   1EDF             		; If the point award type is 2, 
7322   1EDF             		; jump ahead to award 300 points
7323   1EDF 1F                  rra     
7324   1EE0 38 1C               jr      c,l1e00
7325   1EE2             		
7326   1EE2             		; If the point award type is 4, 
7327   1EE2             		; jump ahead to award random points
7328   1EE2 1F                  rra     
7329   1EE3 38 10               jr      c,l1df5
7330   1EE5             		
7331   1EE5             		
7332   1EE5             		; The point award type is 0
7333   1EE5             		
7334   1EE5             		; Trigger the award sound
7335   1EE5 21 85 60            ld      hl,AWARD_SOUND_TRIGGER
7336   1EE8 36 03               ld      (hl),3
7337   1EEA             		
7338   1EEA             		; If the level number is 1, 
7339   1EEA             		; award 300 points
7340   1EEA 3A 29 62            ld      a,(CP_LEVEL_NUMBER)
7341   1EED 3D                  dec     a
7342   1EEE 28 0E               jr      z,l1e00
7343   1EF0             		
7344   1EF0             		; If the level number is 2,
7345   1EF0             		; Award 500 points
7346   1EF0 3D                  dec     a
7347   1EF1 28 12               jr      z,l1e08
7348   1EF3             		
7349   1EF3             		; Jump ahead to award 800 points
7350   1EF3 18 17               jr      l1e10
7351   1EF5             		
7352   1EF5             		
7353   1EF5             		
7354   1EF5             		; Randomly award 300, 500, or 800 points
7355   1EF5 3A 18 60    l1df5:  ld      a,(RANDOM_NUMBER)
7356   1EF8 1F                  rra     
7357   1EF9 38 0A               jr      c,l1e08						; Award 500 points
7358   1EFB 1F                  rra     
7359   1EFC 38 0E               jr      c,l1e10						; Award 800 points
7360   1EFE             		
7361   1EFE             		
7362   1EFE             		
7363   1EFE             		; Award 300 points
7364   1EFE 06 7D       l1e00:  ld      b,$7d
7365   1F00 11 03 00            ld      de,$0003					; Award 300 points
7366   1F03 18 0C               jr      l1e15
7367   1F05             		
7368   1F05             		
7369   1F05             		
7370   1F05             		; Award 500 points
7371   1F05 06 7E       l1e08:  ld      b,$7e
7372   1F07 11 05 00            ld      de,$0005					; Award 500 points
7373   1F0A 18 05               jr      l1e15
7374   1F0C             		
7375   1F0C             		
7376   1F0C             		
7377   1F0C             		; Award 800 points
7378   1F0C 06 7F       l1e10:  ld      b,$7f
7379   1F0E 11 08 00            ld      de,$0008					; Award 800 points
7380   1F11             		
7381   1F11             		
7382   1F11             		
7383   1F11             		; Award the points
7384   1F11 CD 36 31    l1e15:  call    L_ADD_EVENT
7385   1F14             
7386   1F14             		; Get the x and y coordinate of the smashed sprite
7387   1F14 2A 43 63            ld      hl,(SMASHED_SPRITE_POINTER)
7388   1F17 7E                  ld      a,(hl)						; X coordinate
7389   1F18 36 00               ld      (hl),0						; Hide the sprite
7390   1F1A 2C                  inc     l
7391   1F1B 2C                  inc     l
7392   1F1C 2C                  inc     l
7393   1F1D 4E                  ld      c,(hl)						; Y coordinate
7394   1F1E             		
7395   1F1E 18 0C               jr      l1e36
7396   1F20                     
7397   1F20             		; Award the points
7398   1F20 CD 36 31    l1e28:  call    L_ADD_EVENT
7399   1F23             
7400   1F23             		; Get Mario's x and y coordinates (+20 pixels down)
7401   1F23 3A 05 62            ld      a,(MARIO_Y)
7402   1F26 C6 14               add     a,20
7403   1F28 4F                  ld      c,a
7404   1F29 3A 03 62            ld      a,(MARIO_X)
7405   1F2C             		
7406   1F2C             		; At this point:
7407   1F2C             		; 	a = x coordinate of award sprite
7408   1F2C             		;	b = award sprite image
7409   1F2C             		;	c = y coordinate of award sprite
7410   1F2C             		
7411   1F2C             		; Initialize the award sprite
7412   1F2C 21 30 6A    l1e36:  ld      hl,AWARD_SPRITE
7413   1F2F 77                  ld      (hl),a						; X coordinate
7414   1F30 2C                  inc     l
7415   1F31 70                  ld      (hl),b						; Sprite image
7416   1F32 2C                  inc     l
7417   1F33 36 07               ld      (hl),7						; Sprite palette
7418   1F35 2C                  inc     l
7419   1F36 71                  ld      (hl),c						; Y coordinate
7420   1F37             		
7421   1F37                     ; Return unless this is the barrels stage or elevator stage
7422   1F37 3E 05       		ld      a,%00000101
7423   1F39 F7                  rst     $30							
7424   1F3A             		
7425   1F3A             		; Trigger the award sound
7426   1F3A 21 85 60            ld      hl,AWARD_SOUND_TRIGGER
7427   1F3D 36 03               ld      (hl),3
7428   1F3F             		
7429   1F3F             		; Return
7430   1F3F             L_NO_POINTS_TO_DISPLAY:  
7431   1F3F C9          		ret     
7432   1F40             ;------------------------------------------------------------------------------
7433   1F40             
7434   1F40             
7435   1F40             ;------------------------------------------------------------------------------
7436   1F40             ; This function continues to display the point award sprite until
7437   1F40             ; the display timer runs down
7438   1F40             L_DISPLAY_POINT_AWARD_SPRITE:  
7439   1F40             		; If the point display timer has not reached 0,
7440   1F40             		; return
7441   1F40 21 41 63    		ld      hl,POINT_AWARD_DISPLAY_TIMER
7442   1F43 35                  dec     (hl)
7443   1F44 C0                  ret     nz
7444   1F45             		
7445   1F45             		; Remove the sprite
7446   1F45 AF                  xor     a
7447   1F46 32 30 6A            ld      (AWARD_SPRITE_X),a
7448   1F49             		
7449   1F49             		; Reset the point award state
7450   1F49 32 40 63            ld      (POINT_AWARD_STATE),a
7451   1F4C C9                  ret     
7452   1F4D             ;------------------------------------------------------------------------------
7453   1F4D             
7454   1F4D             
7455   1F4D             
7456   1F4D             ;------------------------------------------------------------------------------
7457   1F4D             ; Check if the current stage win conditions have been met
7458   1F4D             L_CHECK_FOR_WIN_CONDITIONS:
7459   1F4D             		; Jump ahead if this is the rivets stage or secret stage
7460   1F4D 3A 27 62    		ld      a,(CURRENT_STAGE)
7461   1F50 CB 57               bit     2,a
7462   1F52 20 37               jr      nz,l1e80		
7463   1F54             		
7464   1F54             		; Jump ahead if this is the barrels stage or elevators stage
7465   1F54 1F                  rra     
7466   1F55 3A 05 62            ld      a,(MARIO_Y)
7467   1F58 38 14               jr      c,l1e7a						
7468   1F5A             		
7469   1F5A             		; Processing for mixer stage
7470   1F5A             		; Check if Mario has reached the top conveyer
7471   1F5A FE 51               cp      81
7472   1F5C D0                  ret     nc							; Return if Mario y coordinate is below the top platform
7473   1F5D             		
7474   1F5D             		; Face Mario left if he is on the right side of the screen
7475   1F5D 3A 03 62            ld      a,(MARIO_X)
7476   1F60 17                  rla     
7477   1F61 AF          l1e6d:  xor		a
7478   1F62 32 90 62    		ld 		(ACTIVATE_SECRET_STAGE),a
7479   1F65 38 02               jr      c,l1e74						
7480   1F67             		
7481   1F67             		; Face Mario right if he is on the left side of the screen
7482   1F67 3E 80               ld      a,$80
7483   1F69             		
7484   1F69 32 4D 69    l1e74:  ld      (MARIO_SPRITE_NUM),a
7485   1F6C 18 26               jr      l1e85
7486   1F6E             		
7487   1F6E             		; Processing for barrels stage and elevators stage
7488   1F6E             		; Check if Mario has reached Pauline's platform
7489   1F6E 3A 03 62    l1e7a:  ld		a,(MARIO_X)
7490   1F71 FE 93       		cp		147
7491   1F73 20 08       		jr		nz,l1e7b
7492   1F75 3A 05 62    		ld		a,(MARIO_Y)
7493   1F78 FE 31       		cp		49
7494   1F7A D0          		ret		nc
7495   1F7B 18 E4       		jr		l1e6d						; Face Mario left and begin win animation
7496   1F7D             
7497   1F7D             		; Return if Mario is to the right of Pauline's platform
7498   1F7D D0          l1e7b:	ret		nc
7499   1F7E             		
7500   1F7E             		; Check if Mario has reached the top of the escape ladders
7501   1F7E 3A 05 62    		ld		a,(MARIO_Y)
7502   1F81 FE 19       		cp		25
7503   1F83 D0          		ret		nc
7504   1F84             		
7505   1F84             		; Activate the secret stage
7506   1F84 3E 01       		ld		a,1
7507   1F86 32 90 62    		ld		(ACTIVATE_SECRET_STAGE),a
7508   1F89 18 09       		jr		l1e85						; Trigger stage win
7509   1F8B             		
7510   1F8B             l1e80:  
7511   1F8B             		; If this is the secret stage,
7512   1F8B             		; jump ahead
7513   1F8B CB 47       		bit		0,a
7514   1F8D 20 0C       		jr		nz,l1e86
7515   1F8F             
7516   1F8F             		; Processing for rivets stage
7517   1F8F             		; Check if all rivets have been removed
7518   1F8F 3A 90 62    		ld      a,(REMAINING_RIVETS)
7519   1F92 A7                  and     a
7520   1F93 C0                  ret     nz							; Return if there are still rivets to be removed
7521   1F94             		
7522   1F94 3E 16       l1e85:  ld      a,22
7523   1F96 32 0A 60            ld      (GAME_SUBSTATE),a
7524   1F99 E1                  pop     hl
7525   1F9A C9                  ret     
7526   1F9B             		
7527   1F9B             l1e86:	
7528   1F9B             		; If Mario has passed the cage bars, then win
7529   1F9B 3A 05 62    		ld		a,(MARIO_Y)
7530   1F9E FE D8       		cp		216
7531   1FA0 D8          		ret		c
7532   1FA1 3A 03 62    		ld		a,(MARIO_X)
7533   1FA4 FE C8       		cp		200
7534   1FA6 D8          		ret		c
7535   1FA7 18 B8       		jr		l1e6d
7536   1FA9             ;------------------------------------------------------------------------------
7537   1FA9             
7538   1FA9             
7539   1FA9             
7540   1FA9             ;------------------------------------------------------------------------------
7541   1FA9             ; Check if the smash animation is running.  If it is, implement it and abort
7542   1FA9             ; any other game processing.
7543   1FA9             L_CHECK_FOR_SMASH_ANIM:  
7544   1FA9             		; Return if a smash animation is not active
7545   1FA9 3A 50 63    		ld      a,(SMASH_ANIMATION_ACTIVE)
7546   1FAC A7                  and     a
7547   1FAD C8                  ret     z
7548   1FAE                     
7549   1FAE                     ; Return 
7550   1FAE CD B3 1F            call    L_IMPLEMENT_SMASH_ANIM
7551   1FB1                     
7552   1FB1                     ; Return from the calling function
7553   1FB1 E1                  pop     hl
7554   1FB2 C9                  ret     
7555   1FB3             ;------------------------------------------------------------------------------
7556   1FB3             
7557   1FB3             
7558   1FB3             
7559   1FB3             ;------------------------------------------------------------------------------
7560   1FB3             ; Implement the smash animation
7561   1FB3             L_IMPLEMENT_SMASH_ANIM:  
7562   1FB3 3A 45 63    		ld      a,(SMASH_ANIMATION_STATE)
7563   1FB6 EF                  rst     $28							; Jump to local table address
7564   1FB7             		; Jump table
7565   1FB7 BD 1F       		.word	L_INIT_SMASH_ANIM	; 0 = smash animation 0
7566   1FB9 21 20       		.word	L_SMASH_ANIM_PHASE_1	; 1 = smash animation 1
7567   1FBB 3A 20       		.word	L_COMPLETE_SMASH_ANIM	; 2 = smash animation 2
7568   1FBD             ;------------------------------------------------------------------------------
7569   1FBD             
7570   1FBD             
7571   1FBD             
7572   1FBD             ;------------------------------------------------------------------------------
7573   1FBD             ; This function initializes the smash animation
7574   1FBD             L_INIT_SMASH_ANIM:  
7575   1FBD             		; If the lower byte of the smash enemy class pointer
7576   1FBD             		; == $65, set hl to point to the pie sprites
7577   1FBD 3A 52 63    		ld      a,(SMASH_ENEMY_CLASS_POINTER+1)
7578   1FC0 FE 65               cp      $65
7579   1FC2 21 B8 69            ld      hl,PIE_SPRITES
7580   1FC5 28 08               jr      z,l1eb4
7581   1FC7                     
7582   1FC7                     ; If the lower byte of the smash enemy class pointer
7583   1FC7             		; == $65, set hl to point to the fireball sprites 
7584   1FC7 21 D0 69            ld      hl,FIREBALL_SPRITES
7585   1FCA 38 03               jr      c,l1eb4
7586   1FCC                     
7587   1FCC                     ; If the lower byte of the smash enemy class pointer
7588   1FCC             		; == $65, set hl to point to the spring sprites
7589   1FCC 21 80 69            ld      hl,SPRING_SPRITES
7590   1FCF                     
7591   1FCF                     ; Prepare to locate the smashed sprite
7592   1FCF DD 2A 51 63 l1eb4:  ld      ix,(SMASH_ENEMY_CLASS_POINTER)
7593   1FD3 16 00               ld      d,0
7594   1FD5 3A 53 63            ld      a,(SMASH_ENEMY_DATA_SIZE)
7595   1FD8 5F                  ld      e,a							; de = size of the enemy data structure
7596   1FD9 01 04 00            ld      bc,4						; bc = size of sprite data
7597   1FDC             
7598   1FDC             		; If the enemy index is 0, nothing more needs to be done so
7599   1FDC             		; jump ahead
7600   1FDC 3A 54 63            ld      a,(SMASH_ANIMATION_ENEMY_INDEX)
7601   1FDF A7                  and     a
7602   1FE0 28 06               jr      z,l1ecf
7603   1FE2                     
7604   1FE2             		; Advance to the sprite and data structure of the enemy
7605   1FE2             		; that was smashed
7606   1FE2 09          l1ec8:  add     hl,bc
7607   1FE3 DD 19               add     ix,de
7608   1FE5 3D                  dec     a
7609   1FE6 20 FA               jr      nz,l1ec8
7610   1FE8             
7611   1FE8             		; Mark the enemy data structure as inactive
7612   1FE8 DD 36 00 00 l1ecf:  ld      (ix+0),0					; Inactive
7613   1FEC             
7614   1FEC             		; If this is not a special sprite, 
7615   1FEC             		; award 300 points
7616   1FEC DD 7E 15            ld      a,(ix+21)
7617   1FEF A7                  and     a
7618   1FF0 3E 02               ld      a,2
7619   1FF2 28 02               jr      z,l1ede
7620   1FF4             		
7621   1FF4             		; If this is a special sprite,
7622   1FF4             		; randomly award 300, 500, or 800 points
7623   1FF4 3E 04               ld      a,4
7624   1FF6             		
7625   1FF6             		; Record the type of award
7626   1FF6 32 42 63    l1ede:  ld      (POINT_AWARD_TYPE),a
7627   1FF9             
7628   1FF9             		; Set the smash sprite's x coordinate to that of the
7629   1FF9             		; smashed enemy
7630   1FF9 01 2C 6A            ld      bc,SMASH_SPRITE
7631   1FFC 7E                  ld      a,(hl)
7632   1FFD 36 00               ld      (hl),0						; Hide the enemy sprite
7633   1FFF 02                  ld      (bc),a
7634   2000             		
7635   2000             		; Set the smash sprite's image to the first image in the
7636   2000             		; smash sprite animation
7637   2000 0C                  inc     c
7638   2001 2C                  inc     l
7639   2002 3E 60               ld      a,$60
7640   2004 02                  ld      (bc),a
7641   2005             		
7642   2005             		; Set the smash sprite's palette to 12
7643   2005 0C                  inc     c
7644   2006 2C                  inc     l
7645   2007 3E 0C               ld      a,12
7646   2009 02                  ld      (bc),a
7647   200A             		
7648   200A             		; Set the smash sprite's y coordinate to that of the
7649   200A             		; smashed enemy
7650   200A 0C                  inc     c
7651   200B 2C                  inc     l
7652   200C 7E                  ld      a,(hl)
7653   200D 02                  ld      (bc),a
7654   200E             
7655   200E             		; Advance the smash animation state
7656   200E 21 45 63            ld      hl,SMASH_ANIMATION_STATE
7657   2011 34                  inc     (hl)
7658   2012             		
7659   2012             		; Set the smash animation frame delay to 6
7660   2012 2C                  inc     l							; SMASH_ANIMATION_FRAME_DELAY
7661   2013 36 06               ld      (hl),6
7662   2015             
7663   2015             		; Set the smash animation cycle counter to 5
7664   2015 2C                  inc     l							; SMASH_ANIMATION_CYCLE_COUNTER
7665   2016 36 05               ld      (hl),5	
7666   2018             		
7667   2018             		; Trigger the hammet hit song
7668   2018 21 8A 60            ld      hl,PENDING_SONG_TRIGGER
7669   201B 36 06               ld      (hl),SONG_TRIGGER_HAMMER_HIT
7670   201D 2C                  inc     l
7671   201E 36 03               ld      (hl),3
7672   2020             		
7673   2020 C9                  ret     
7674   2021             ;------------------------------------------------------------------------------
7675   2021             
7676   2021             
7677   2021             
7678   2021             ;------------------------------------------------------------------------------
7679   2021             ; This function displays the first phase of the smash animation by cycling 
7680   2021             ; between the first two images in the animation until the cycle counter
7681   2021             ; reaches 0
7682   2021             L_SMASH_ANIM_PHASE_1:  
7683   2021             		; If the smash animation frame delay has not reached 0, 
7684   2021             		; return
7685   2021 21 46 63    		ld      hl,SMASH_ANIMATION_FRAME_DELAY
7686   2024 35                  dec     (hl)
7687   2025 C0                  ret     nz
7688   2026             		
7689   2026             		; Reset the smash animation frame delay to 6
7690   2026 36 06               ld      (hl),6
7691   2028             		
7692   2028             		; If the smash animation cycle counter has reached 0,
7693   2028             		; jump ahead
7694   2028 2C                  inc     l
7695   2029 35                  dec     (hl)
7696   202A 28 08               jr      z,l1f1d
7697   202C             		
7698   202C             		; Cycle between the first two sprite images in the smash
7699   202C             		; animation
7700   202C 21 2D 6A            ld      hl,SMASH_SPRITE_NUM
7701   202F 7E                  ld      a,(hl)
7702   2030 EE 01               xor     1
7703   2032 77                  ld      (hl),a
7704   2033 C9                  ret     
7705   2034             		
7706   2034             		; Reset the smash animation cycle counter
7707   2034 36 04       l1f1d:  ld      (hl),4
7708   2036             
7709   2036             		; Advance the smash animation state
7710   2036 2D                  dec     l
7711   2037 2D                  dec     l
7712   2038 34                  inc     (hl)
7713   2039             		
7714   2039 C9                  ret     
7715   203A             ;------------------------------------------------------------------------------
7716   203A             
7717   203A             
7718   203A             ;------------------------------------------------------------------------------
7719   203A             ; This function completes the smash animation by advancing through the rest of 
7720   203A             ; the images in the animation
7721   203A             L_COMPLETE_SMASH_ANIM:  
7722   203A             		; If the smah animation frame delay has not reached 0,
7723   203A             		; return
7724   203A 21 46 63    		ld      hl,SMASH_ANIMATION_FRAME_DELAY
7725   203D 35                  dec     (hl)
7726   203E C0                  ret     nz
7727   203F             		
7728   203F             		; Reset the frame delay to 12
7729   203F 36 0C               ld      (hl),12
7730   2041             		
7731   2041             		; If the smash animation cycle counter has reached 0,
7732   2041             		; jump ahead
7733   2041 2C                  inc     l							; SMASH_ANIMATION_CYCLE_COUNTER
7734   2042 35                  dec     (hl)
7735   2043 28 05               jr      z,l1f34
7736   2045             		
7737   2045             		; Advance to the next sprite in the animation 
7738   2045 21 2D 6A            ld      hl,SMASH_SPRITE_NUM
7739   2048 34                  inc     (hl)
7740   2049 C9                  ret     
7741   204A             		
7742   204A             		; Reset the smash animation
7743   204A 2D          l1f34:  dec     l
7744   204B 2D                  dec     l							; SMASH_ANIMATION_STATE
7745   204C AF                  xor     a
7746   204D 77                  ld      (hl),a
7747   204E 32 50 63            ld      (SMASH_ANIMATION_ACTIVE),a
7748   2051 3C                  inc     a
7749   2052 32 40 63            ld      (POINT_AWARD_STATE),a
7750   2055 21 2C 6A            ld      hl,SMASH_SPRITE
7751   2058 22 43 63            ld      (SMASHED_SPRITE_POINTER),hl
7752   205B C9                  ret     
7753   205C             ;------------------------------------------------------------------------------
7754   205C             
7755   205C             
7756   205C             ;------------------------------------------------------------------------------
7757   205C             l1f46:  
7758   205C             		; If Mario is not falling,
7759   205C             		; return
7760   205C 3A 21 62    		ld      a,(MARIO_IS_FALLING)
7761   205F A7                  and     a
7762   2060 C8                  ret     z
7763   2061             		
7764   2061             		; 
7765   2061 AF                  xor     a
7766   2062 32 04 62            ld      ($6204),a
7767   2065 32 06 62            ld      ($6206),a
7768   2068 32 21 62            ld      (MARIO_IS_FALLING),a
7769   206B 32 10 62            ld      (MARIO_JUMPING_LEFT),a
7770   206E 32 11 62            ld      (MARIO_JUMPING_RIGHT),a
7771   2071 32 12 62            ld      ($6212),a
7772   2074 32 13 62            ld      ($6213),a
7773   2077 32 14 62            ld      ($6214),a
7774   207A             		
7775   207A 3C                  inc     a
7776   207B 32 16 62            ld      (MARIO_IS_JUMPING),a
7777   207E 32 1F 62            ld      ($621f),a
7778   2081 3A 05 62            ld      a,(MARIO_Y)
7779   2084 32 0E 62            ld      (MARIO_JUMP_Y_COORD),a
7780   2087 C9                  ret     
7781   2088             ;------------------------------------------------------------------------------
7782   2088             
7783   2088             
7784   2088             
7785   2088             ;------------------------------------------------------------------------------
7786   2088             l1f72:  
7787   2088             		; Return unless this is the barrels stage
7788   2088             		; Note: I can save 2 bytes by using rst $30
7789   2088 3E 01       		ld		a,%00000001
7790   208A F7          		rst		$30
7791   208B             ;		ld      a,(CURRENT_STAGE)
7792   208B             ;        dec     a
7793   208B             ;        ret     nz
7794   208B             		
7795   208B DD 21 00 67         ld      ix,BARREL_STRUCTS
7796   208F 21 80 69            ld      hl,SPRING_SPRITES
7797   2092 11 20 00            ld      de,32					; 32 byte data structure
7798   2095 06 0A               ld      b,10					; For b = 10 to 1 (10 barrels)
7799   2097             
7800   2097             		; If the barrel is active, jump ahead
7801   2097 DD 7E 00    l1f83:  ld      a,(ix+0)
7802   209A 3D                  dec     a
7803   209B 28 09               jr      z,l1f93
7804   209D                     
7805   209D                     ; Advance to the next barrel
7806   209D 2C                  inc     l
7807   209E 2C                  inc     l
7808   209F 2C                  inc     l
7809   20A0             
7810   20A0             		; Process the next barrel
7811   20A0 2C          l1f8d:  inc     l
7812   20A1 DD 19               add     ix,de
7813   20A3 10 F2               djnz    l1f83					; Next b
7814   20A5 C9                  ret     
7815   20A6             
7816   20A6             		; If ??? has reached 0, jump ahead
7817   20A6 DD 7E 01    l1f93:  ld      a,(ix+1)
7818   20A9 3D                  dec     a
7819   20AA CA EE 21            jp      z,l20ec						; Exceeds relative branch
7820   20AD                     
7821   20AD                     ; If bit 0 of ??? is 1, jump ahead
7822   20AD DD 7E 02            ld      a,(ix+2)
7823   20B0 1F                  rra     
7824   20B1 38 09               jr      c,l1fac
7825   20B3                     
7826   20B3                     ; If bit 1 of ??? is 1, jump ahead
7827   20B3 1F                  rra     
7828   20B4 38 3D               jr      c,l1fe5
7829   20B6                     
7830   20B6                     ; If bit 2 of ??? is 1, jump ahead
7831   20B6 1F                  rra     
7832   20B7 38 43               jr      c,l1fef
7833   20B9                     
7834   20B9                     ; Jump ahead
7835   20B9 C3 5E 21            jp      l2053						; Exceeds relative branch
7836   20BC                     
7837   20BC                     ; Move the barrel down 1 pixel
7838   20BC D9          l1fac:  exx     
7839   20BD DD 34 05            inc     (ix+5)						; Y coordinate entry
7840   20C0                     
7841   20C0                     ; If the barrel y coordinate has not reached ???, jump ahead
7842   20C0 DD 7E 17            ld      a,(ix+23)
7843   20C3 DD BE 05            cp      (ix+5)						; Y coordinate
7844   20C6 20 15               jr      nz,l1fce
7845   20C8                     
7846   20C8                     ; Advance the barrel rolling animation
7847   20C8                     ; Select either the normal barrel graphics (barrel type == 0)
7848   20C8             		; or the oil barrel graphics (barrel type == 1)
7849   20C8 DD 7E 15    		ld      a,(ix+21)					; Barrel type
7850   20CB 07                  rlca    							
7851   20CC 07                  rlca    
7852   20CD C6 15               add     a,$15						; The first normal barrel sprite image
7853   20CF DD 77 07            ld      (ix+7),a					; Sprite number entry
7854   20D2                     
7855   20D2 DD 7E 02            ld      a,(ix+2)
7856   20D5 EE 07               xor     %00000111
7857   20D7 DD 77 02            ld      (ix+2),a
7858   20DA C3 AD 22            jp      L_LD_SPRITE_DATA_TO_STRUCT_2	; Exceeds relative branch
7859   20DD                     
7860   20DD                     
7861   20DD                     ; If ??? has not reached 0, jump ahead
7862   20DD DD 7E 0F    l1fce:  ld      a,(ix+15)
7863   20E0 3D                  dec     a
7864   20E1 20 0A               jr      nz,l1fdf
7865   20E3                     
7866   20E3                     ; Toggle the barrel falling sprite
7867   20E3                     ; (Between $16 and $17 or $1a and $1b)
7868   20E3 DD 7E 07            ld      a,(ix+7)					; Sprite number
7869   20E6 EE 01               xor     %00000001
7870   20E8 DD 77 07            ld      (ix+7),a
7871   20EB                     
7872   20EB                     ; Reset the ??? counter to 4
7873   20EB 3E 04               ld      a,4
7874   20ED                     
7875   20ED                     ; Update the ??? counter
7876   20ED DD 77 0F    l1fdf:  ld      (ix+15),a
7877   20F0 C3 AD 22            jp      L_LD_SPRITE_DATA_TO_STRUCT_2	; Exceeds relative branch
7878   20F3                     
7879   20F3                     
7880   20F3                     
7881   20F3 D9          l1fe5:  exx     
7882   20F4 01 00 01            ld      bc,$0100
7883   20F7                     
7884   20F7                     ; Move the barrel right 1 pixel
7885   20F7 DD 34 03            inc     (ix+3)						; X coordinate entry
7886   20FA 18 07               jr      l1ff6
7887   20FC                     
7888   20FC                     
7889   20FC D9          l1fef:  exx     
7890   20FD 01 04 FF            ld      bc,$ff04
7891   2100                     
7892   2100                     ; Move the barrel left 1 pixel
7893   2100 DD 35 03            dec     (ix+3)						; X coordinate entry
7894   2103                     
7895   2103 DD 66 03    l1ff6:  ld      h,(ix+3)					; X coordinate entry
7896   2106 DD 6E 05            ld      l,(ix+5)					; Y coordinate entry
7897   2109 7C                  ld      a,h
7898   210A E6 07               and     %00000111
7899   210C FE 03               cp      3
7900   210E CA 5C 22            jp      z,l215f						; Exceeds relative branch
7901   2111                     
7902   2111                     ; Make the barrel follow the countours of the platforms
7903   2111 2D                  dec     l
7904   2112 2D                  dec     l
7905   2113 2D                  dec     l
7906   2114 CD 13 24            call    L_MOVE_SPRITE_ALONG_PLAT
7907   2117 2C                  inc     l
7908   2118 2C                  inc     l
7909   2119 2C                  inc     l
7910   211A                     
7911   211A 7D                  ld      a,l
7912   211B DD 77 05            ld      (ix+5),a
7913   211E                     
7914   211E CD B3 24            call    l23de
7915   2121                     
7916   2121 CD 7B 25            call    l24b4
7917   2124                     
7918   2124 DD 7E 03            ld      a,(ix+3)
7919   2127 FE 1C               cp      %00011100
7920   2129 38 0F               jr      c,l202f
7921   212B FE E4               cp      $e4
7922   212D DA AD 22            jp      c,L_LD_SPRITE_DATA_TO_STRUCT_2	; Exceeds relative branch
7923   2130 AF                  xor     a
7924   2131 DD 77 10            ld      (ix+16),a
7925   2134 DD 36 11 60         ld      (ix+17),$60
7926   2138 18 09               jr      l2038
7927   213A                     
7928   213A AF          l202f:  xor     a
7929   213B DD 36 10 FF         ld      (ix+16),$ff
7930   213F DD 36 11 A0         ld      (ix+17),$a0
7931   2143 DD 36 12 FF l2038:  ld      (ix+18),$ff
7932   2147 DD 36 13 F0         ld      (ix+19),$f0
7933   214B DD 77 14            ld      (ix+20),a
7934   214E DD 77 0E            ld      (ix+14),a
7935   2151 DD 77 04            ld      (ix+4),a
7936   2154 DD 77 06            ld      (ix+6),a
7937   2157 DD 36 02 08         ld      (ix+2),8
7938   215B C3 AD 22            jp      L_LD_SPRITE_DATA_TO_STRUCT_2	; Exceeds relative branch
7939   215E                     
7940   215E D9          l2053:  exx     
7941   215F CD 71 24            call    l239c
7942   2162 CD 15 2B            call    l2a2f
7943   2165 A7                  and     a
7944   2166 20 24               jr      nz,l2083
7945   2168 DD 7E 03            ld      a,(ix+3)
7946   216B C6 08               add     a,8
7947   216D FE 10               cp      $10
7948   216F 38 11               jr      c,l2079
7949   2171 CD 7B 25            call    l24b4
7950   2174 DD 7E 10            ld      a,(ix+16)
7951   2177 E6 01               and     1
7952   2179 07                  rlca    
7953   217A 07                  rlca    
7954   217B 4F                  ld      c,a
7955   217C CD B3 24            call    l23de
7956   217F C3 AD 22            jp      L_LD_SPRITE_DATA_TO_STRUCT_2	; Exceeds relative branch
7957   2182 AF          l2079:  xor     a
7958   2183 DD 77 00            ld      (ix+0),a
7959   2186 DD 77 03            ld      (ix+3),a
7960   2189 C3 AD 22            jp      L_LD_SPRITE_DATA_TO_STRUCT_2	; Exceeds relative branch
7961   218C DD 34 0E    l2083:  inc     (ix+14)
7962   218F DD 7E 0E            ld      a,(ix+14)
7963   2192 3D                  dec     a
7964   2193 28 13               jr      z,l20a2
7965   2195 3D                  dec     a
7966   2196 28 2E               jr      z,l20c3
7967   2198 DD 7E 10            ld      a,(ix+16)
7968   219B 3D                  dec     a
7969   219C 3E 04               ld      a,4
7970   219E 20 02               jr      nz,l209c
7971   21A0 3E 02               ld      a,2
7972   21A2 DD 77 02    l209c:  ld      (ix+2),a
7973   21A5 C3 AD 22            jp      L_LD_SPRITE_DATA_TO_STRUCT_2	; Exceeds relative branch
7974   21A8 DD 7E 15    l20a2:  ld      a,(ix+21)
7975   21AB A7                  and     a
7976   21AC 20 0B               jr      nz,l20b5
7977   21AE 21 05 62            ld      hl,MARIO_Y
7978   21B1 DD 7E 05            ld      a,(ix+5)
7979   21B4 D6 16               sub     $16
7980   21B6 BE                  cp      (hl)
7981   21B7 30 0D               jr      nc,l20c3
7982   21B9 DD 7E 10    l20b5:  ld      a,(ix+16)
7983   21BC A7                  and     a
7984   21BD 20 25               jr      nz,l20e1
7985   21BF DD 77 11            ld      (ix+17),a
7986   21C2 DD 36 10 FF         ld      (ix+16),$ff
7987   21C6 CD DB 24    l20c3:  call    l2407
7988   21C9 CB 3C               srl     h
7989   21CB CB 1D               rr      l
7990   21CD CB 3C               srl     h
7991   21CF CB 1D               rr      l
7992   21D1 DD 74 12            ld      (ix+18),h
7993   21D4 DD 75 13            ld      (ix+19),l
7994   21D7 AF                  xor     a
7995   21D8 DD 77 14            ld      (ix+20),a
7996   21DB DD 77 04            ld      (ix+4),a
7997   21DE DD 77 06            ld      (ix+6),a
7998   21E1 C3 AD 22            jp      L_LD_SPRITE_DATA_TO_STRUCT_2	; Exceeds relative branch
7999   21E4 DD 36 10 01 l20e1:  ld      (ix+16),1
8000   21E8 DD 36 11 00         ld      (ix+17),0
8001   21EC 18 D8               jr      l20c3
8002   21EE                     
8003   21EE D9          l20ec:  exx     
8004   21EF CD 71 24            call    l239c
8005   21F2 7C                  ld      a,h
8006   21F3 D6 1A               sub     $1a
8007   21F5 DD 46 19            ld      b,(ix+25)
8008   21F8 B8                  cp      b
8009   21F9 38 09               jr      c,l2104
8010   21FB CD 15 2B            call    l2a2f
8011   21FE A7                  and     a
8012   21FF 20 17               jr      nz,l2118
8013   2201 CD 7B 25            call    l24b4
8014   2204                     
8015   2204                     ; If the x coordinate (+8) is > 16
8016   2204                     ; jump back to animate the sprite
8017   2204 DD 7E 03    l2104:  ld      a,(ix+3)
8018   2207 C6 08               add     a,8
8019   2209 FE 10               cp      16
8020   220B D2 DD 20            jp      nc,l1fce					; Exceeds relative branch
8021   220E                     
8022   220E                     ; The x coordinate is <= 16
8023   220E                     ; Deactivate the sprite
8024   220E AF                  xor     a
8025   220F DD 77 00            ld      (ix+0),a
8026   2212 DD 77 03            ld      (ix+3),a
8027   2215                     
8028   2215                     ; Update the sprite and process the next object
8029   2215 C3 AD 22            jp      L_LD_SPRITE_DATA_TO_STRUCT_2	; Exceeds relative branch
8030   2218                     
8031   2218 DD 7E 05    l2118:  ld      a,(ix+5)
8032   221B FE E0               cp      $e0
8033   221D 38 25               jr      c,l2146
8034   221F DD 7E 07            ld      a,(ix+7)
8035   2222 E6 FC               and     $fc
8036   2224 F6 01               or      1
8037   2226 DD 77 07            ld      (ix+7),a
8038   2229 AF                  xor     a
8039   222A DD 77 01            ld      (ix+1),a
8040   222D DD 77 02            ld      (ix+2),a
8041   2230 DD 36 10 FF         ld      (ix+16),$ff
8042   2234 DD 77 11            ld      (ix+17),a
8043   2237 DD 77 12            ld      (ix+18),a
8044   223A DD 36 13 B0         ld      (ix+19),$b0
8045   223E DD 36 0E 01         ld      (ix+14),1
8046   2242 18 0D               jr      l2153
8047   2244 CD DB 24    l2146:  call    l2407
8048   2247 CD B1 23            call    l22cb
8049   224A DD 7E 05            ld      a,(ix+5)
8050   224D DD 77 19            ld      (ix+25),a
8051   2250 AF                  xor     a
8052   2251 DD 77 14    l2153:  ld      (ix+20),a
8053   2254 DD 77 04            ld      (ix+4),a
8054   2257 DD 77 06            ld      (ix+6),a
8055   225A 18 51       l215c:  jr      L_LD_SPRITE_DATA_TO_STRUCT_2
8056   225C 7D          l215f:  ld      a,l
8057   225D C6 05       l2160:  add     a,5
8058   225F 57                  ld      d,a
8059   2260 7C                  ld      a,h
8060   2261 CD 66 22            call    l216d
8061   2264 18 47               jr      L_LD_SPRITE_DATA_TO_STRUCT_2
8062   2266             
8063   2266 CD 46 24    l216d:  call    L_CHECK_IF_ON_LADDER
8064   2269 3D                  dec     a
8065   226A C0                  ret     nz
8066   226B 78                  ld      a,b
8067   226C D6 05               sub     5
8068   226E DD 77 17            ld      (ix+23),a
8069   2271             		
8070   2271             		; If the barrel fire is not lit, then jump ahead
8071   2271             		; (barrel will always take ladders before the barrel is lit)
8072   2271 3A 48 63            ld      a,(BARREL_FIRE_STATUS)
8073   2274 A7                  and     a
8074   2275 28 2E               jr      z,l21b2
8075   2277             		
8076   2277             		; Return if the barrel is below or on the same level as Mario
8077   2277             		; (barrel will never take the ladder)
8078   2277 3A 05 62            ld      a,(MARIO_Y)
8079   227A D6 04               sub     4
8080   227C BA                  cp      d
8081   227D D8                  ret     c
8082   227E             		
8083   227E             		; Convert the difficulty (1 to 5) to a modified difficulty number between 1 and 3
8084   227E 3A 80 63            ld      a,(CP_DIFFICULTY)
8085   2281 1F                  rra     
8086   2282 3C                  inc     a
8087   2283 47                  ld      b,a
8088   2284             		
8089   2284             		; Get a random number between 0 and 3
8090   2284 3A 18 60            ld      a,(RANDOM_NUMBER)
8091   2287 4F                  ld      c,a
8092   2288 E6 03               and     %00000011
8093   228A             		
8094   228A             		; If random number is greater than the modified difficulty number, then return
8095   228A             		; (barrel will not take the ladder)
8096   228A B8                  cp      b
8097   228B D0                  ret     nc
8098   228C             		
8099   228C             		; If Mario is directly below the barrel, then go down the ladder
8100   228C 21 10 60            ld      hl,PLAYER_INPUT
8101   228F 3A 03 62            ld      a,(MARIO_X)
8102   2292 BB                  cp      e
8103   2293 28 10               jr      z,l21b2
8104   2295             	
8105   2295             		; If the barrel is to the right of Mario, check if Mario is moving left
8106   2295 30 06               jr      nc,l21a9
8107   2297             		
8108   2297             		; If Mario is not moving right, then skip ahead
8109   2297 CB 46               bit     0,(hl)
8110   2299 28 06               jr      z,l21ae
8111   229B             		
8112   229B             		; If the barrel is to the left of Mario and Mario is moving right, 
8113   229B             		; then the barrel will go down the ladder
8114   229B 18 08               jr      l21b2
8115   229D             		
8116   229D             		; If the barrel is to the right of Mario and Mario is moving left, 
8117   229D             		; then the barrel will go down the ladder
8118   229D CB 4E       l21a9:  bit     1,(hl)
8119   229F 20 04               jr      nz,l21b2
8120   22A1             		
8121   22A1             		; 25% chance of the barrel going down the ladder on its own
8122   22A1 79          l21ae:  ld      a,c
8123   22A2 E6 18               and     $18
8124   22A4 C0                  ret     nz
8125   22A5             		
8126   22A5             		; Advance the barrel animation
8127   22A5 DD 34 07    l21b2:  inc     (ix+7)
8128   22A8             
8129   22A8             		; Set the barrel to take the ladder
8130   22A8 DD CB 02 C6         set     0,(ix+2)
8131   22AC C9                  ret     
8132   22AD             ;------------------------------------------------------------------------------
8133   22AD             
8134   22AD             
8135   22AD             		
8136   22AD             ;------------------------------------------------------------------------------
8137   22AD             ; Copy data from an object data structure to a sprite structure
8138   22AD             L_LD_SPRITE_DATA_TO_STRUCT_2:  
8139   22AD D9          		exx     
8140   22AE DD 7E 03            ld      a,(ix+3)					; X coordinate
8141   22B1 77                  ld      (hl),a
8142   22B2 2C                  inc     l
8143   22B3 DD 7E 07            ld      a,(ix+7)					; Sprite number
8144   22B6 77                  ld      (hl),a
8145   22B7 2C                  inc     l
8146   22B8 DD 7E 08            ld      a,(ix+8)					; Palette
8147   22BB 77                  ld      (hl),a
8148   22BC 2C                  inc     l
8149   22BD DD 7E 05            ld      a,(ix+5)					; Y coordinate
8150   22C0 77                  ld      (hl),a
8151   22C1             
8152   22C1                     ; Jump back to process the next object
8153   22C1 C3 A0 20            jp      l1f8d						; Exceeds relative branch
8154   22C4             ;------------------------------------------------------------------------------
8155   22C4             
8156   22C4             
8157   22C4             
8158   22C4             ;------------------------------------------------------------------------------
8159   22C4             ; Input data for the attract mode game play demonstration
8160   22C4             ;
8161   22C4             ; The first byte of data is the first demo input value, which is repeated ???
8162   22C4             ; times.
8163   22C4             ;
8164   22C4             ; The two byte pairs that follow are:
8165   22C4             ;	byte 0 = the input data
8166   22C4             ;	byte 1 = repeat count for the following input
8167   22C4             ;		bit 0 = right
8168   22C4             ;		bit 1 = left
8169   22C4             ;		bit 2 = up
8170   22C4             ;		bit 3 = down
8171   22C4             ;		bit 7 = jump
8172   22C4             ;
8173   22C4             ; The expectation seems to be that Mario will be dead before the input runs out.
8174   22C4             ; Interesting things heppen, however, if he doesn't and the rest of the code that
8175   22C4             ; follows is treated as input data...
8176   22C4             L_DEMO_INPUT_DATA:	
8177   22C4 80          		.byte	$80	         	; jump
8178   22C5 FE 01       		.word	TWO_BYTES($01, 254) ; right
8179   22C7 C0 04       		.word	TWO_BYTES($04, 192) ; up
8180   22C9 50 02       		.word	TWO_BYTES($02, 80)  ; left
8181   22CB 10 82       		.word	TWO_BYTES($82, 16)  ; jump left 
8182   22CD 60 02       		.word	TWO_BYTES($02, 96)  ; left
8183   22CF 10 82       		.word	TWO_BYTES($82, 16)  ; jump left
8184   22D1 CA 01       		.word	TWO_BYTES($01, 202) ; right
8185   22D3 10 81       		.word	TWO_BYTES($81, 16)  ; jump right
8186   22D5 FF 02       		.word	TWO_BYTES($02, 255) ; left
8187   22D7 38 01       		.word	TWO_BYTES($01, 56)  ; right 
8188   22D9 80 02       		.word	TWO_BYTES($02, 128) ; left
8189   22DB FF 04       		.word	TWO_BYTES($04, 255) ; up
8190   22DD 80 04       		.word	TWO_BYTES($04, 128) ; up
8191   22DF 60 80       		.word	TWO_BYTES($80, 96)  ; jump
8192   22E1             ;------------------------------------------------------------------------------
8193   22E1             
8194   22E1             
8195   22E1             ;------------------------------------------------------------------------------
8196   22E1             ; Simulate player input for the demo mode
8197   22E1             L_SIMULATE_DEMO_INPUT:  
8198   22E1             		; Convert the input index number to a memory offset in de
8199   22E1 11 C4 22    		ld      de,L_DEMO_INPUT_DATA
8200   22E4 21 CC 63            ld      hl,DEMO_INPUT_INDEX
8201   22E7 7E                  ld      a,(hl)
8202   22E8 07                  rlca    
8203   22E9 83                  add     a,e
8204   22EA 5F                  ld      e,a
8205   22EB                     
8206   22EB                     ; Get the byte of simulated input
8207   22EB 1A                  ld      a,(de)
8208   22EC 32 10 60            ld      (PLAYER_INPUT),a
8209   22EF                     
8210   22EF                     ; Decrement the input repeat, and return if it has not reached zero
8211   22EF 2C                  inc     l
8212   22F0 7E                  ld      a,(hl)
8213   22F1 35                  dec     (hl)
8214   22F2 A7                  and     a
8215   22F3 C0                  ret     nz
8216   22F4             		
8217   22F4             		; Read the next input repeat
8218   22F4 1C                  inc     e
8219   22F5 1A                  ld      a,(de)
8220   22F6 77                  ld      (hl),a
8221   22F7                     
8222   22F7                     ; Increment the input index
8223   22F7 2D                  dec     l
8224   22F8 34                  inc     (hl)
8225   22F9 C9                  ret     
8226   22FA             ;------------------------------------------------------------------------------
8227   22FA             
8228   22FA             
8229   22FA             
8230   22FA             ;------------------------------------------------------------------------------
8231   22FA             ; Implement the logic for the retracting ladders on the mixer stage
8232   22FA             L_IMPLEMENT_RET_LADDERS:  
8233   22FA             		; Return unless this is the mixer stage
8234   22FA 3E 02       		ld      a,%00000010
8235   22FC F7                  rst     $30							
8236   22FD                     
8237   22FD                     ; If counter 2 is odd, process the left ladder
8238   22FD 3A 1A 60            ld      a,(COUNTER_2)
8239   2300 1F                  rra
8240   2301 21 80 62            ld      hl,L_RETRACT_LADDER_DATA
8241   2304 7E                  ld      a,(hl)
8242   2305 38 04               jr      c,l2219
8243   2307                     
8244   2307                     ; Counter 2 is even; process the right ladder
8245   2307 21 88 62            ld      hl,R_RETRACT_LADDER_STATE
8246   230A 7E                  ld      a,(hl)
8247   230B                     
8248   230B E5          l2219:  push    hl
8249   230C EF                  rst     $28							; Jump to local table address
8250   230D             		; Jump table
8251   230D 15 23       		.word	L_LADDER_STATE_0	; 0 = ladder in up position
8252   230F 44 23       		.word	L_LADDER_STATE_1	; 1 = ladder moving down
8253   2311 80 23       		.word	L_LADDER_STATE_2	; 2 = ladder in down position
8254   2313 89 23       		.word	L_LADDER_STATE_3	; 3 = ladder moving up
8255   2315             ;------------------------------------------------------------------------------
8256   2315             
8257   2315             
8258   2315             
8259   2315             ;------------------------------------------------------------------------------
8260   2315             ; This function controls the retractable ladders on the mixer level
8261   2315             ; when they are in the up position, waiting to descend
8262   2315             ;
8263   2315             ; passed:	hl (on the stack) - the address of the ladder data
8264   2315             L_LADDER_STATE_0:  
8265   2315             		; Decrement the ladder delay and jump ahead if it has reached
8266   2315             		; 0, to skip moving on to the next ladder state
8267   2315 E1          		pop     hl
8268   2316 2C                  inc     l							; RETRACT_LADDER_DELAY	
8269   2317 35                  dec     (hl)
8270   2318 20 0D               jr      nz,l223a
8271   231A             
8272   231A             		; Advance to the next ladder state
8273   231A 2D                  dec     l							; RETRACT_LADDER_STATE
8274   231B 34                  inc     (hl)				
8275   231C             		
8276   231C             		; If Mario is on this ladder, set $621a to 1 and return
8277   231C 2C                  inc     l
8278   231D 2C                  inc     l							; RETRACT_LADDER_X
8279   231E CD 30 23            call    L_CHECK_IF_MARIO_ON_LADDER
8280   2321 3E 01               ld      a,1
8281   2323 32 1A 62            ld      ($621a),a
8282   2326 C9                  ret   
8283   2327             		
8284   2327             		; The ladder is still waiting to descend
8285   2327             		; If Mario is on the ladder, set $621a to 0 and return
8286   2327 2C          l223a:  inc     l
8287   2328 CD 30 23            call    L_CHECK_IF_MARIO_ON_LADDER
8288   232B AF                  xor     a
8289   232C 32 1A 62            ld      ($621a),a
8290   232F C9                  ret     
8291   2330             ;------------------------------------------------------------------------------
8292   2330             
8293   2330             
8294   2330             
8295   2330             ;------------------------------------------------------------------------------
8296   2330             ; This function checks if Mario is on the current retractable 
8297   2330             ; ladder.
8298   2330             ; Abort the calling function if:
8299   2330             ; 	Mario's y coordinate is > 122 or
8300   2330             ;	MARIO_IS_JUMPING is not 0 or
8301   2330             ;	Mario's x coordinate does not match the ladder's x coordinate
8302   2330             ;
8303   2330             ; passed:	hl - the address of the current retractable ladder's
8304   2330             ;				x coordinate
8305   2330             L_CHECK_IF_MARIO_ON_LADDER:  
8306   2330             		; If Mario's y coordinate is 122 or more,
8307   2330             		; jump ahead to abort the calling function
8308   2330 3A 05 62    		ld      a,(MARIO_Y)
8309   2333 FE 7A               cp      122
8310   2335 30 0B               jr      nc,l2257
8311   2337                     
8312   2337                     ; If Mario is jumping, 
8313   2337                     ; jump ahead to abort the calling function
8314   2337 3A 16 62    		ld      a,(MARIO_IS_JUMPING)
8315   233A A7                  and     a
8316   233B 20 05               jr      nz,l2257
8317   233D                     
8318   233D                     ; If Mari 's x coordinate is equal to (hl),
8319   233D                     ; return
8320   233D 3A 03 62            ld      a,(MARIO_X)
8321   2340 BE                  cp      (hl)
8322   2341 C8                  ret     z
8323   2342                     
8324   2342                     ; Return from the calling function
8325   2342 E1          l2257:  pop     hl
8326   2343 C9                  ret     
8327   2344             ;------------------------------------------------------------------------------
8328   2344             
8329   2344             
8330   2344             ;------------------------------------------------------------------------------
8331   2344             ; This function moves the ladder down one pixel every 4th call.
8332   2344             ; It also forces Mario down with it, if Mario is on the ladder
8333   2344             ;
8334   2344             ; If Mario is above the stationary part of the ladder, he is moved
8335   2344             ; down at the same speed as the retractable ladder; otherwise, he
8336   2344             ; is moved down at half speed.
8337   2344             ;
8338   2344             ; passed:	hl (on the stack) - the address of the ladder's state
8339   2344             L_LADDER_STATE_1:  
8340   2344             		; Decrement the ladder movement delay
8341   2344             		; Return if it has not reached 0
8342   2344 E1          		pop     hl
8343   2345 2C                  inc     l
8344   2346 2C                  inc     l
8345   2347 2C                  inc     l
8346   2348 2C                  inc     l							; RETRACT_LADDER_MOVE_DELAY
8347   2349 35                  dec     (hl)
8348   234A C0                  ret     nz
8349   234B             		
8350   234B             		; Reset the movement delay to 4
8351   234B 3E 04               ld      a,4
8352   234D 77                  ld      (hl),a
8353   234E             		
8354   234E             		; Lower the ladder 1 pixel
8355   234E 2D                  dec     l							; RETRACT_LADDER_Y
8356   234F 34                  inc     (hl)
8357   2350             		
8358   2350             		; Update the y coordinate of the sprite for the current ladder
8359   2350 CD A4 23            call    L_UPDATE_LADDER_SPRITE_COORD
8360   2353             		
8361   2353             		; If the ladder has not reached its lowest point, jump ahead
8362   2353 3E 78               ld      a,120
8363   2355 BE                  cp      (hl)
8364   2356 20 07               jr      nz,l2275
8365   2358             		
8366   2358             		; Advance to the next ladder state
8367   2358 2D                  dec     l
8368   2359 2D                  dec     l
8369   235A 2D                  dec     l
8370   235B 34                  inc     (hl)
8371   235C             		
8372   235C 2C                  inc     l
8373   235D 2C                  inc     l
8374   235E 2C                  inc     l
8375   235F             
8376   235F             		; Return if Mario is not on this ladder
8377   235F 2D          l2275:  dec     l							; RETRACT_LADDER_X
8378   2360 CD 30 23    l2276:  call    L_CHECK_IF_MARIO_ON_LADDER
8379   2363             
8380   2363             		; If Mario is above the stationary part of the ladder, jump ahead
8381   2363 3A 05 62            ld      a,(MARIO_Y)
8382   2366 FE 68               cp      104
8383   2368 30 09               jr      nc,l228a
8384   236A             		
8385   236A             		; Mario is below the stationary part of the ladder;
8386   236A             		; Move Mario down 1 pixel
8387   236A 21 05 62    l2281:  ld      hl,MARIO_Y
8388   236D 34                  inc     (hl)
8389   236E             		
8390   236E             		; Display Mario's sprite as climbing
8391   236E CD D4 3F            call    L_SET_MARIO_SPRITE_TO_CLIMBING
8392   2371             		
8393   2371             		; Move Mario down 1 pixel
8394   2371 34                  inc     (hl)						; MARIO_SPRITE_Y
8395   2372 C9                  ret     
8396   2373             
8397   2373             		; If bit 0 Mario's y coordinate is a 1, jump back up to move him
8398   2373             		; down 1 pizel
8399   2373 1F          l228a:  rra     
8400   2374 38 F4               jr      c,l2281
8401   2376             		
8402   2376             		; If bit 1 of Mario's y coordinate is a 1, set $6222 to 1
8403   2376 1F                  rra     
8404   2377 3E 01               ld      a,1
8405   2379 38 01               jr      c,l2295
8406   237B             		
8407   237B             		; Bit 1 of Mario's y coordinate is a 0, set $6222 to 0
8408   237B AF                  xor     a
8409   237C 32 22 62    l2295:  ld      ($6222),a
8410   237F C9                  ret     
8411   2380             ;------------------------------------------------------------------------------
8412   2380             
8413   2380             
8414   2380             
8415   2380             ;------------------------------------------------------------------------------
8416   2380             ; This function leaves the ladder in the down position for a random time
8417   2380             ; before advancing to the next state
8418   2380             L_LADDER_STATE_2:  
8419   2380 E1          		pop     hl
8420   2381 3A 18 60            ld      a,(RANDOM_NUMBER)
8421   2384 E6 3C               and     %00111100
8422   2386 C0                  ret     nz
8423   2387 34                  inc     (hl)
8424   2388 C9                  ret     
8425   2389             ;------------------------------------------------------------------------------
8426   2389             
8427   2389             
8428   2389             
8429   2389             ;------------------------------------------------------------------------------
8430   2389             ; This function moves the ladder back into the up position 1 pixel at a time
8431   2389             L_LADDER_STATE_3:  
8432   2389             		; Decrement the movement delay
8433   2389             		; Return if it has not reached 0
8434   2389 E1          		pop     hl
8435   238A 2C                  inc     l
8436   238B 2C                  inc     l
8437   238C 2C                  inc     l
8438   238D 2C                  inc     l						; RETRACT_LADDER_MOVE_DELAY
8439   238E 35                  dec     (hl)
8440   238F C0                  ret     nz
8441   2390             		
8442   2390             		; Reset the movement delay to 2
8443   2390 36 02               ld      (hl),2
8444   2392                     
8445   2392                     ; Move the ladder up 1 pixel
8446   2392 2D                  dec     l						; RETRACT_LADDER_Y
8447   2393 35                  dec     (hl)
8448   2394                     
8449   2394                     ; Update the sprite
8450   2394 CD A4 23            call    L_UPDATE_LADDER_SPRITE_COORD
8451   2397                     
8452   2397                     ; Return if the ladder is not completely up
8453   2397 3E 68               ld      a,104
8454   2399 BE                  cp      (hl)
8455   239A C0                  ret     nz
8456   239B             		
8457   239B             		; Reset the ladder delay (time before retracting again)
8458   239B AF                  xor     a
8459   239C 06 80               ld      b,128
8460   239E 2D                  dec     l
8461   239F 2D                  dec     l						; RETRACT_LADDER_DELAY
8462   23A0 70                  ld      (hl),b
8463   23A1                     
8464   23A1                     ; Reset the ladder state to 0
8465   23A1 2D                  dec     l						; RETRACT_LADDER_STATE
8466   23A2 77                  ld      (hl),a
8467   23A3 C9                  ret     
8468   23A4             ;------------------------------------------------------------------------------
8469   23A4             
8470   23A4             
8471   23A4             ;------------------------------------------------------------------------------
8472   23A4             ; Update the address of the y coordinate of the ladder sprite corresponding to 
8473   23A4             ; the currently processed ladder
8474   23A4             ;
8475   23A4             ; passed:	hl - address of the retractable ladder's y coordinate
8476   23A4             L_UPDATE_LADDER_SPRITE_COORD:  
8477   23A4             		; If this is the right ladder, set the y coordinate of the right ladder
8478   23A4             		; sprite
8479   23A4 7E          		ld      a,(hl)
8480   23A5 CB 5D               bit     3,l
8481   23A7 11 4B 69            ld      de,R_RETRACT_LADDER_SPRITE_Y
8482   23AA 20 03               jr      nz,l22c9
8483   23AC             		
8484   23AC             		; Update the coordinate of the left ladder sprite
8485   23AC 11 47 69            ld      de,L_RETRACT_LADDER_SPRITE_Y
8486   23AF             		
8487   23AF 12          l22c9:  ld      (de),a
8488   23B0 C9                  ret     
8489   23B1             ;------------------------------------------------------------------------------
8490   23B1             
8491   23B1             
8492   23B1             
8493   23B1             ;------------------------------------------------------------------------------
8494   23B1 3A 48 63    l22cb:  ld      a,(BARREL_FIRE_STATUS)
8495   23B4 A7                  and     a
8496   23B5 28 0F               jr      z,l22e1
8497   23B7 3A 80 63            ld      a,(CP_DIFFICULTY)
8498   23BA 3D                  dec     a
8499   23BB EF                  rst     $28							; Jump to local table address
8500   23BC             		; Jump table
8501   23BC D8 23       		.word	l22f6	; 0 = 
8502   23BE D8 23       		.word	l22f6	; 1 = 
8503   23C0 E5 23       		.word	l2303	; 2 = 
8504   23C2 E5 23       		.word	l2303	; 3 = 
8505   23C4 FB 23       		.word	l231a	; 4 = 
8506   23C6             ;------------------------------------------------------------------------------
8507   23C6             
8508   23C6             
8509   23C6             
8510   23C6             ;------------------------------------------------------------------------------
8511   23C6 3A 29 62    l22e1:  ld      a,(CP_LEVEL_NUMBER)
8512   23C9 47                  ld      b,a
8513   23CA 05                  dec     b
8514   23CB 3E 01               ld      a,1
8515   23CD 28 0C               jr      z,l22f9
8516   23CF 05                  dec     b
8517   23D0 3E B1               ld      a,$b1
8518   23D2 28 07               jr      z,l22f9
8519   23D4             		
8520   23D4 3E E9               ld      a,$e9
8521   23D6 18 03               jr      l22f9
8522   23D8 3A 18 60    l22f6:  ld      a,(RANDOM_NUMBER)
8523   23DB DD 77 11    l22f9:  ld      (ix+17),a
8524   23DE E6 01               and     1
8525   23E0 3D                  dec     a
8526   23E1 DD 77 10            ld      (ix+16),a
8527   23E4 C9                  ret     
8528   23E5             ;------------------------------------------------------------------------------
8529   23E5             
8530   23E5             
8531   23E5             
8532   23E5             ;------------------------------------------------------------------------------
8533   23E5 3A 18 60    l2303:  ld      a,(RANDOM_NUMBER)
8534   23E8 DD 77 11            ld      (ix+17),a
8535   23EB 3A 03 62            ld      a,(MARIO_X)
8536   23EE DD BE 03            cp      (ix+3)
8537   23F1 3E 01               ld      a,1
8538   23F3 30 02               jr      nc,l2316
8539   23F5 3D                  dec     a
8540   23F6 3D                  dec     a
8541   23F7 DD 77 10    l2316:  ld      (ix+16),a
8542   23FA C9                  ret     
8543   23FB             ;------------------------------------------------------------------------------
8544   23FB             
8545   23FB             
8546   23FB             
8547   23FB             ;------------------------------------------------------------------------------
8548   23FB 3A 03 62    l231a:  ld      a,(MARIO_X)
8549   23FE DD 96 03            sub     (ix+3)
8550   2401 0E FF               ld      c,$ff
8551   2403 38 01               jr      c,l2326
8552   2405 0C                  inc     c
8553   2406 07          l2326:  rlca    
8554   2407 CB 11               rl      c
8555   2409 07                  rlca    
8556   240A CB 11               rl      c
8557   240C DD 71 10            ld      (ix+16),c
8558   240F DD 77 11            ld      (ix+17),a
8559   2412 C9                  ret     
8560   2413             ;------------------------------------------------------------------------------
8561   2413             
8562   2413             
8563   2413             
8564   2413             ;------------------------------------------------------------------------------
8565   2413             ; This function contains the logic the rolls the barrels along the girder
8566   2413             ; platforms and makes the barrels follow the slope of the platforms.
8567   2413             ; passed:	h - sprite x coordinate
8568   2413             ;			l - sprite y coordinate
8569   2413             ;			b - 1 if the barrel is rolling right,
8570   2413             ;			  - -1 if the barrel is rolling left
8571   2413             ; return:	l - the sprite's new y coordinate
8572   2413             L_MOVE_SPRITE_ALONG_PLAT:  
8573   2413 3E 0F       		ld      a,%00001111
8574   2415 A4                  and     h
8575   2416                     
8576   2416                     ; If the barrel is rolling right, jump ahead
8577   2416 05                  dec     b
8578   2417 28 07               jr      z,l2342
8579   2419             
8580   2419             		; If the barrel is rolling left
8581   2419             		; and is not at the edge of a tile grid space, return
8582   2419 FE 0F               cp      %00001111
8583   241B D8                  ret     c
8584   241C                     
8585   241C                     ; Mark the barrel as rolling left, and jump ahead
8586   241C 06 FF               ld      b,-1
8587   241E 18 05               jr      l2347
8588   2420             
8589   2420                     ; Return unless the barrel is at the edge of a tile grid space    
8590   2420 FE 01       l2342:  cp      1
8591   2422 D0                  ret     nc
8592   2423             		
8593   2423             		; Mark the barrel as rolling right
8594   2423 06 01               ld      b,1
8595   2425                     
8596   2425                     ; Jump ahead if the barrel has reached the straight part of the bottom platform
8597   2425 3E F0       l2347:  ld      a,240
8598   2427 BD                  cp      l
8599   2428 28 10               jr      z,l2360
8600   242A                     
8601   242A                     ; Jump ahead if the barrel is on the straight part of the top platform
8602   242A 3E 4C               ld      a,76
8603   242C BD                  cp      l
8604   242D 28 10               jr      z,l2366
8605   242F                     
8606   242F                     ; Jump ahead if the barrel has ???
8607   242F 7D                  ld      a,l
8608   2430 CB 6F               bit     5,a
8609   2432 28 03               jr      z,l235c
8610   2434                     
8611   2434 90          l2359:  sub     b
8612   2435             
8613   2435             		; Update the barrel's y coordinate and return
8614   2435 6F          l235a:  ld      l,a
8615   2436 C9                  ret     
8616   2437             		
8617   2437             		; Move the barrel down 1 pixel
8618   2437 80          l235c:  add     a,b
8619   2438 18 FB               jr      l235a
8620   243A             
8621   243A CB 7C       l2360:  bit     7,h
8622   243C 20 F6               jr      nz,l2359
8623   243E C9                  ret     
8624   243F             		
8625   243F             		; Return if the barrel has not reached the sloped portion
8626   243F             		; of the top platform
8627   243F 7C          l2366:  ld      a,h
8628   2440 FE 98               cp      152
8629   2442 D8                  ret     c
8630   2443             		
8631   2443             		; Jump back up to move the barrel down 1 pixel
8632   2443 7D                  ld      a,l
8633   2444 18 F1               jr      l235c		
8634   2446             ;------------------------------------------------------------------------------
8635   2446             
8636   2446                      
8637   2446             		
8638   2446             ;------------------------------------------------------------------------------
8639   2446             ; This function checks if Mario is at the top or bottom of a ladder.
8640   2446             ; If Mario is not at the top or bottom of a ladder, the calling function is 
8641   2446             ; aborted
8642   2446             ;
8643   2446             ; passed:	a - Mario's x coordinate
8644   2446             ;			d - Mario's y coordinate (+8)
8645   2446             ; return:	a - 0 if Mario is at the bottom of a ladder,
8646   2446             ;				1 if Mario is at the top of a ladder
8647   2446             ;			b - the y coordinate of the other end of the ladder
8648   2446             ;				(bottom if Mario is at the top of the ladder,
8649   2446             ;				top if Mario is at the bottom of the ladder)
8650   2446             L_CHECK_IF_ON_LADDER:
8651   2446             		; Load bc with the number of normal ladders + 1
8652   2446 01 15 00    		ld		bc,21
8653   2449             		; If there is not a normal ladder under Mario,
8654   2449             		; jump ahead to return from the calling function
8655   2449 21 00 63    		ld      hl,NORMAL_LADDER_X_COORD_DATA
8656   244C ED B1       l2371:  cpir    
8657   244E 20 1F               jr      nz,l239a
8658   2450                     
8659   2450                     ; Save hl and bc
8660   2450 E5                  push    hl
8661   2451 C5                  push    bc
8662   2452                     
8663   2452                     ; Advance hl to this ladder's y1 coordinate
8664   2452 01 14 00            ld      bc,20
8665   2455 09                  add     hl,bc
8666   2456                     
8667   2456 0C                  inc     c
8668   2457                     
8669   2457                     ; If Mario is at the bottom of this ladder,
8670   2457                     ; jump ahead
8671   2457 5F                  ld      e,a						; Save Mario x in e
8672   2458 7A                  ld      a,d						; Load Mario y from d
8673   2459 BE                  cp      (hl)
8674   245A 28 09               jr      z,l238f
8675   245C                     
8676   245C                     ; Advance hl to this ladder's y2 coordinate
8677   245C 09                  add     hl,bc
8678   245D                     
8679   245D                     ; If Mario is at the top of this ladder, jump ahead
8680   245D BE                  cp      (hl)
8681   245E 28 0A               jr      z,l2395
8682   2460                     
8683   2460                     ; Search again for another ladder
8684   2460             ;        ld      d,a						; Save Mario y in d Note: this may not be neccessary - d already contains the y coordinate
8685   2460 7B                  ld      a,e						; Load Mario x from e
8686   2461 C1                  pop     bc
8687   2462 E1                  pop     hl
8688   2463 18 E7               jr      l2371
8689   2465             
8690   2465             		; Advance hl to the ladder's y2 coordinate
8691   2465 09          l238f:  add     hl,bc
8692   2466             
8693   2466             		; Jump ahead to return a as 1
8694   2466 3E 01               ld      a,1
8695   2468 18 03               jr      l2398
8696   246A                     
8697   246A                     ; Return a as 0
8698   246A AF          l2395:  xor     a						; a = 0
8699   246B                     
8700   246B                     ; Backup hl to the ladder's y1 coordinate
8701   246B ED 42               sbc     hl,bc
8702   246D                     
8703   246D                     ; Store the ladder's other y coordinate in b
8704   246D C1          l2398:  pop     bc
8705   246E 46                  ld      b,(hl)
8706   246F                     
8707   246F E1          l239a:  pop     hl
8708   2470 C9                  ret     
8709   2471             ;------------------------------------------------------------------------------
8710   2471             		
8711   2471             
8712   2471             		
8713   2471             ;------------------------------------------------------------------------------
8714   2471             l239c:  
8715   2471 DD 7E 04    		ld      a,(ix+4)
8716   2474 DD 86 11            add     a,(ix+17)
8717   2477 DD 77 04            ld      (ix+4),a
8718   247A DD 7E 03            ld      a,(ix+3)					; X coordinate
8719   247D DD 8E 10            adc     a,(ix+16)
8720   2480 DD 77 03            ld      (ix+3),a
8721   2483                     
8722   2483 DD 7E 06            ld      a,(ix+6)
8723   2486 DD 96 13            sub     (ix+19)
8724   2489 6F                  ld      l,a
8725   248A DD 7E 05            ld      a,(ix+5)					; Y coordinate
8726   248D DD 9E 12            sbc     a,(ix+18)
8727   2490 67                  ld      h,a
8728   2491 DD 7E 14            ld      a,(ix+20)
8729   2494 A7                  and     a						; Clear the carry bit
8730   2495 17                  rla     						; Bit 7 to carry flag
8731   2496 3C                  inc     a
8732   2497 06 00               ld      b,0
8733   2499 CB 10               rl      b
8734   249B CB 27               sla     a
8735   249D CB 10               rl      b
8736   249F CB 27               sla     a
8737   24A1 CB 10               rl      b
8738   24A3 CB 27               sla     a
8739   24A5 CB 10               rl      b
8740   24A7 4F                  ld      c,a
8741   24A8 09                  add     hl,bc
8742   24A9 DD 74 05            ld      (ix+5),h				; Y coordinate
8743   24AC DD 75 06            ld      (ix+6),l				
8744   24AF DD 34 14            inc     (ix+20)
8745   24B2 C9                  ret     
8746   24B3             ;------------------------------------------------------------------------------
8747   24B3             
8748   24B3             
8749   24B3             
8750   24B3             ;------------------------------------------------------------------------------
8751   24B3             ; passed;	c - 
8752   24B3             l23de:  
8753   24B3             		; Decrement the ??? counter
8754   24B3             		; If it has not reached 0, jump ahead to skip this function
8755   24B3 DD 7E 0F    		ld      a,(ix+15)
8756   24B6 3D                  dec     a
8757   24B7 20 1E               jr      nz,l2403
8758   24B9                     
8759   24B9 AF                  xor     a						; a = 0
8760   24BA DD CB 07 26         sla     (ix+7)
8761   24BE 17                  rla     
8762   24BF DD CB 08 26         sla     (ix+8)
8763   24C3 17                  rla     
8764   24C4 47                  ld      b,a
8765   24C5 3E 03               ld      a,3
8766   24C7 B1                  or      c
8767   24C8 CD A7 30            call    l3009
8768   24CB                     
8769   24CB 1F                  rra     
8770   24CC DD CB 08 1E         rr      (ix+8)
8771   24D0 1F                  rra     
8772   24D1 DD CB 07 1E         rr      (ix+7)
8773   24D5                     
8774   24D5                     ; Reset the ??? to 4
8775   24D5 3E 04               ld      a,4
8776   24D7 DD 77 0F    l2403:  ld      (ix+15),a
8777   24DA C9                  ret     
8778   24DB             ;------------------------------------------------------------------------------
8779   24DB             
8780   24DB             
8781   24DB             
8782   24DB             ;------------------------------------------------------------------------------
8783   24DB DD 7E 14    l2407:  ld      a,(ix+20)
8784   24DE 07                  rlca    
8785   24DF 07                  rlca    
8786   24E0 07                  rlca    
8787   24E1 07                  rlca    
8788   24E2 4F                  ld      c,a
8789   24E3 E6 0F               and     %00001111
8790   24E5 67                  ld      h,a
8791   24E6 79                  ld      a,c
8792   24E7 E6 F0               and     %11110000
8793   24E9 6F                  ld      l,a
8794   24EA DD 4E 13            ld      c,(ix+19)
8795   24ED DD 46 12            ld      b,(ix+18)
8796   24F0 ED 42               sbc     hl,bc
8797   24F2 C9                  ret     
8798   24F3             ;------------------------------------------------------------------------------
8799   24F3             
8800   24F3             
8801   24F3             
8802   24F3             ;------------------------------------------------------------------------------
8803   24F3             ; Implement the barriers that stop Mario from moving past the edges of the screen
8804   24F3             ; or past the invisible barriers surrounding Donkey Kong on the barrels and 
8805   24F3             ; elevators stages.
8806   24F3             ;
8807   24F3             ; passed:	none
8808   24F3             ; return:	d = 1 if Mario can't move left
8809   24F3             ;			e = 1 if Mario can't move right
8810   24F3             L_IMPLEMENT_BARRIERS:  
8811   24F3             		; Check if Mario is at the left edge of the stage
8812   24F3 11 00 01    		ld      de,$0100					
8813   24F6 3A 03 62            ld      a,(MARIO_X)
8814   24F9 FE 16       		cp		22
8815   24FB D8                  ret     c							; Return if Mario X < 22
8816   24FC             		
8817   24FC             		; Check if Mario is at the right edge of the stage
8818   24FC 15                  dec     d
8819   24FD 1C                  inc     e
8820   24FE FE EA               cp      234
8821   2500 D0                  ret     nc							; Return if Mario X > 234
8822   2501             
8823   2501 1D          		dec		e
8824   2502             
8825   2502             		; If this is the secret stage,
8826   2502             		; jump ahead to implement its barriers
8827   2502 3A 27 62            ld      a,(CURRENT_STAGE)
8828   2505 FE 05       		cp		5
8829   2507 C0                  ret     nz
8830   2508             		
8831   2508             		; Implement the cage bar barrier on the secret stage
8832   2508             		; Mario can't move past the bars unless they are all down
8833   2508             lcagebarrier:
8834   2508 3A 03 62    		ld		a,(MARIO_X)
8835   250B FE AA       		cp		170
8836   250D D8          		ret		c
8837   250E 3A 05 62    		ld		a,(MARIO_Y)
8838   2511 FE D8       		cp		216
8839   2513 D8          		ret		c
8840   2514 3A B8 62    		ld		a,(CAGE_BARS_REMAINING)
8841   2517 B7          		or		a
8842   2518 C8          		ret		z
8843   2519             
8844   2519 1C          		inc		e
8845   251A C9          		ret
8846   251B             ;------------------------------------------------------------------------------
8847   251B             
8848   251B             
8849   251B             
8850   251B             ;------------------------------------------------------------------------------
8851   251B             ; Parse the stage data for the current stage and use it to fill in the ladder
8852   251B             ; data structures (type, x coordinate, and y1 - y2 coordinates)
8853   251B             L_PARSE_STAGE_LADDER_DATA:  
8854   251B FD 21 10 63         ld      iy,BROKEN_LADDER_X_COORD_DATA
8855   251F                     
8856   251F                     ; If the current stage is barrels,
8857   251F                     ; point to the barrels stage data
8858   251F 3A 27 62    		ld      a,(CURRENT_STAGE)
8859   2522 3D                  dec     a
8860   2523 21 F5 3A            ld      hl,L_BARRELS_STAGE_DATA
8861   2526 28 15               jr      z,l2471
8862   2528                     
8863   2528                     ; If the current stage is the mixer,
8864   2528                     ; point to the mixer stage data
8865   2528 3D                  dec     a
8866   2529 21 6E 3B            ld      hl,L_MIXER_STAGE_DATA
8867   252C 28 0F               jr      z,l2471
8868   252E                     
8869   252E                     ; If the current stage is the elevators,
8870   252E                     ; point to the elevators stage data
8871   252E 3D                  dec     a
8872   252F 21 F6 3B            ld      hl,L_ELEVATORS_STAGE_DATA
8873   2532 28 09               jr      z,l2471
8874   2534             		
8875   2534             		; If the current stage is the rivets,
8876   2534             		; point to the rivets stage data
8877   2534 3D          		dec		a
8878   2535 21 9C 3C    		ld		hl,L_RIVETS_STAGE_DATA
8879   2538 28 03       		jr		z,l2471
8880   253A                     
8881   253A                     ; Point to the secret stage data
8882   253A 21 01 3D            ld      hl,L_SECRET_STAGE_DATA
8883   253D                     
8884   253D DD 21 00 63 l2471:  ld      ix,NORMAL_LADDER_X_COORD_DATA
8885   2541 11 05 00            ld      de,5
8886   2544                     
8887   2544                     ; If the first tile type of stage data is $00,
8888   2544                     ; (normal ladder),
8889   2544                     ; then jump ahead
8890   2544 7E          l2478:  ld      a,(hl)
8891   2545 A7                  and     a
8892   2546 28 09               jr      z,l2488
8893   2548                     
8894   2548                     ; If the first tile type of stage data is $01,
8895   2548                     ; (broken ladder),
8896   2548                     ; then jump ahead
8897   2548 3D                  dec     a
8898   2549 28 1B               jr      z,l249e
8899   254B                     
8900   254B                     ; If the end of the data has been reached, return
8901   254B FE A9               cp      $a9
8902   254D C8                  ret     z
8903   254E             		
8904   254E             		; Check out the next tile type
8905   254E 19                  add     hl,de
8906   254F 18 F3               jr      l2478
8907   2551                     
8908   2551             		; Record the coordinates of the normal ladder
8909   2551 23          l2488:  inc     hl						; X1 coordinate
8910   2552 7E                  ld      a,(hl)
8911   2553 DD 77 00            ld      (ix+0),a
8912   2556 23                  inc     hl						; Y1 coordinate
8913   2557 7E                  ld      a,(hl)
8914   2558 DD 77 15            ld      (ix+21),a
8915   255B 23                  inc     hl
8916   255C 23                  inc     hl						; Y2 coordinate
8917   255D 7E                  ld      a,(hl)
8918   255E DD 77 2A            ld      (ix+42),a
8919   2561                     
8920   2561             		; Advance to the next ladder data structure 
8921   2561             		; and the next block of tile data
8922   2561 DD 23               inc     ix
8923   2563 23                  inc     hl
8924   2564                     
8925   2564             		; Process the next block of tile data
8926   2564 18 DE               jr      l2478
8927   2566                     
8928   2566             		; Record the coordinates of the broken ladder
8929   2566 23          l249e:  inc     hl						; X1 coordinate
8930   2567 7E                  ld      a,(hl)
8931   2568 FD 77 00            ld      (iy+0),a
8932   256B 23                  inc     hl						; Y1 coordinate
8933   256C 7E                  ld      a,(hl)
8934   256D FD 77 15            ld      (iy+21),a
8935   2570 23                  inc     hl
8936   2571 23                  inc     hl						; Y2 coordinate
8937   2572 7E                  ld      a,(hl)
8938   2573 FD 77 2A            ld      (iy+42),a
8939   2576                     
8940   2576             		; Advance to the next ladder data structure 
8941   2576             		; and the next block of tile data
8942   2576 FD 23               inc     iy
8943   2578 23                  inc     hl
8944   2579                     
8945   2579             		; Process the next block of tile data
8946   2579 18 C9               jr      l2478
8947   257B             ;------------------------------------------------------------------------------
8948   257B             
8949   257B             
8950   257B             ;------------------------------------------------------------------------------
8951   257B             l24b4:  
8952   257B             		; Return if ??? is above 232
8953   257B DD 7E 05    		ld      a,(ix+5)					; Y coordinate
8954   257E FE E8               cp      232
8955   2580 D8                  ret     c
8956   2581             		
8957   2581                     ; Returm if ??? is right of 42 or left of 32
8958   2581 DD 7E 03            ld      a,(ix+3)					; X coordinate
8959   2584 FE 2A               cp      42
8960   2586 D0                  ret     nc
8961   2587 FE 20               cp      32
8962   2589 D8                  ret     c
8963   258A             		
8964   258A             		; If this is not an oil barrel, jump ahead
8965   258A             		; to skip the fire flare up
8966   258A DD 7E 15            ld      a,(ix+21)				; Barrel type
8967   258D A7                  and     a
8968   258E 28 06               jr      z,l24d0
8969   2590                     
8970   2590                     ; Flare up the oil fire
8971   2590 3E 03               ld      a,3
8972   2592 32 B9 62            ld      (BARREL_FIRE_STATE),a
8973   2595                     
8974   2595                     ; Mark the barrel as inactive
8975   2595 AF                  xor     a
8976   2596 DD 77 00    l24d0:  ld      (ix+0),a					; Active
8977   2599 DD 77 03            ld      (ix+3),a					; X coordinate
8978   259C                     
8979   259C                     ; Trigger Donkey Kong's stomp sound
8980   259C 21 82 60            ld      hl,STOMP_SOUND_TRIGGER
8981   259F 36 03               ld      (hl),3
8982   25A1                     
8983   25A1 E1                  pop     hl
8984   25A2                     
8985   25A2                     ; If the barrel fire is marked as burning, jump ahead
8986   25A2 3A 48 63            ld      a,(BARREL_FIRE_STATUS)
8987   25A5 A7                  and     a
8988   25A6 C2 AD 22            jp      nz,L_LD_SPRITE_DATA_TO_STRUCT_2	; Exceeds relative branch
8989   25A9                     
8990   25A9                     ; Mark the fire as burning
8991   25A9 3C                  inc     a
8992   25AA 32 48 63            ld      (BARREL_FIRE_STATUS),a
8993   25AD                     
8994   25AD C3 AD 22            jp      L_LD_SPRITE_DATA_TO_STRUCT_2	; Exceeds relative branch
8995   25B0             
8996   25B0             		
8997   25B0             		; Return unless this is the mixer stage
8998   25B0 3E 02       l24ea:  ld      a,%00000010
8999   25B2 F7                  rst     $30							
9000   25B3             		
9001   25B3 CD E7 25            call    l2523
9002   25B6 CD 4E 26            call    L_MOVE_PIES_ON_CONVEYERS
9003   25B9 DD 21 A0 65         ld      ix,PIE_STRUCTS
9004   25BD 06 06               ld      b,6
9005   25BF 21 B8 69            ld      hl,PIE_SPRITES
9006   25C2 DD 7E 00    l24fc:  ld      a,(ix+0)
9007   25C5 A7                  and     a
9008   25C6 28 19               jr      z,l251c
9009   25C8 DD 7E 03            ld      a,(ix+3)
9010   25CB 77                  ld      (hl),a
9011   25CC 2C                  inc     l
9012   25CD DD 7E 07            ld      a,(ix+7)
9013   25D0 77                  ld      (hl),a
9014   25D1 2C                  inc     l
9015   25D2 DD 7E 08            ld      a,(ix+8)
9016   25D5 77                  ld      (hl),a
9017   25D6 2C                  inc     l
9018   25D7 DD 7E 05            ld      a,(ix+5)
9019   25DA 77                  ld      (hl),a
9020   25DB 2C                  inc     l
9021   25DC DD 19       l2517:  add     ix,de
9022   25DE 10 E2               djnz    l24fc
9023   25E0 C9                  ret     
9024   25E1             		
9025   25E1 7D          l251c:  ld      a,l
9026   25E2 C6 04               add     a,$04
9027   25E4 6F                  ld      l,a
9028   25E5 18 F5               jr      l2517
9029   25E7 21 9B 63    l2523:  ld      hl,$639b
9030   25EA 7E                  ld      a,(hl)
9031   25EB A7                  and     a
9032   25EC 20 5E               jr      nz,l258f
9033   25EE 3A 9A 63            ld      a,($639a)
9034   25F1 A7                  and     a
9035   25F2 C8                  ret     z
9036   25F3             		
9037   25F3 06 06               ld      b,$06
9038   25F5 11 10 00            ld      de,$0010
9039   25F8 DD 21 A0 65         ld      ix,PIE_STRUCTS
9040   25FC DD CB 00 46 l2539:  bit     0,(ix+0)
9041   2600 28 05               jr      z,l2545
9042   2602 DD 19               add     ix,de
9043   2604 10 F6               djnz    l2539
9044   2606 C9                  ret     
9045   2607             		
9046   2607 CD 57 00    l2545:  call    L_UPDATE_RAND_NUM
9047   260A FE 60               cp      $60
9048   260C DD 36 05 7C         ld      (ix+5),$7c
9049   2610 38 06               jr      c,l2558
9050   2612 3A A3 62            ld      a,(RIGHT_MASTER_CONVEYER_DIR)
9051   2615 3D                  dec     a
9052   2616 20 14               jr      nz,l256e
9053   2618 DD 36 05 CC l2558:  ld      (ix+5),$cc
9054   261C 3A A6 62            ld      a,(BOT_MASTER_CONVEYER_DIR)
9055   261F 07                  rlca    
9056   2620 DD 36 03 07 l2560:  ld      (ix+3),$07
9057   2624 30 0D               jr      nc,l2576
9058   2626 DD 36 03 F8         ld      (ix+3),$f8
9059   262A 18 07               jr      l2576
9060   262C CD 57 00    l256e:  call    L_UPDATE_RAND_NUM
9061   262F FE 68               cp      $68
9062   2631 18 ED               jr      l2560
9063   2633 DD 36 00 01 l2576:  ld      (ix+0),$01
9064   2637 DD 36 07 4B         ld      (ix+7),$4b
9065   263B DD 36 09 08         ld      (ix+9),$08
9066   263F DD 36 0A 03         ld      (ix+10),$03
9067   2643 3E 7C               ld      a,$7c
9068   2645 32 9B 63            ld      ($639b),a
9069   2648 AF                  xor     a
9070   2649 32 9A 63            ld      ($639a),a
9071   264C 35          l258f:  dec     (hl)
9072   264D C9                  ret     
9073   264E             ;------------------------------------------------------------------------------
9074   264E             
9075   264E             
9076   264E             
9077   264E             ;------------------------------------------------------------------------------
9078   264E             ; This function moves the pies along the conveyers on the mixer stage
9079   264E             ; Note: It should be possible to optomize this function to gain a few bytes
9080   264E             L_MOVE_PIES_ON_CONVEYERS:  
9081   264E DD 21 A0 65 		ld      ix,PIE_STRUCTS
9082   2652 21 B8 69    		ld		hl,PIE_SPRITES
9083   2655 11 10 00            ld      de,16					; 16 byte data structures
9084   2658 06 06               ld      b,6						; For b = 6 to 1 (6 pies)
9085   265A                     
9086   265A                     ; If this pie is not active, jump ahead to process the next one
9087   265A DD CB 00 46 l259a:  bit     0,(ix+0)
9088   265E 28 18               jr      z,l25bb
9089   2660                     
9090   2660                     ; If the pie is off the left edge of the screen, 
9091   2660             		; jump ahead
9092   2660 DD 7E 03            ld      a,(ix+3)					; x coordinate
9093   2663 4F                  ld      c,a
9094   2664 C6 07               add     a,7
9095   2666 FE 0E               cp      14
9096   2668 38 2A               jr      c,l25d6
9097   266A                     
9098   266A                     ; If the pie is on the left or right conveyers
9099   266A DD 7E 05            ld      a,(ix+5)					; y coordinate
9100   266D FE 7C               cp      124
9101   266F 28 10               jr      z,l25c0
9102   2671                     
9103   2671                     ; The pie is on the bottom conveyer
9104   2671                     ; Move the pie along the bottom conveyer
9105   2671 3A A6 63            ld      a,(BOT_CONVEYER_DIR)
9106   2674 81                  add     a,c
9107   2675 DD 77 03            ld      (ix+3),a					; x coordinate
9108   2678                     
9109   2678                     ; Move on to the next pie and sprite
9110   2678 DD 19       l25bb:  add     ix,de
9111   267A 2C          		inc		l
9112   267B 2C          		inc		l
9113   267C 2C          		inc		l
9114   267D 2C          		inc		l
9115   267E 10 DA               djnz    l259a
9116   2680 C9                  ret     
9117   2681             		
9118   2681             		; The pie is on the left or right conveyer
9119   2681             		; If the pie has reached the oil barrel, jump ahead
9120   2681 79          l25c0:  ld      a,c
9121   2682 FE 80               cp      128
9122   2684 28 0E               jr      z,l25d6
9123   2686                     
9124   2686                     ; If the pie is on the right conveyer belt,
9125   2686                     ; use the right conveyer belt direction
9126   2686 3A A5 63            ld      a,(RIGHT_CONVEYER_DIR)
9127   2689 30 03               jr      nc,l25cf
9128   268B                     
9129   268B                     ; If the pie is on the left conveyer belt,
9130   268B                     ; use the left conveyer belt direction
9131   268B 3A A4 63            ld      a,(LEFT_CONVEYER_DIR)
9132   268E                     
9133   268E                     ; Move the pie along this conveyer belt
9134   268E 81          l25cf:  add     a,c
9135   268F DD 77 03            ld      (ix+3),a
9136   2692                     
9137   2692                     ; Jump back to process the next pie
9138   2692 18 E4               jr      l25bb
9139   2694                     
9140   2694                     ; Deactivate the sprite structure
9141   2694 AF          l25d6:  xor     a
9142   2695 DD 77 00            ld      (ix+0),a					; Sprite active
9143   2698 DD 77 03            ld      (ix+3),a					; X coordinate
9144   269B                     
9145   269B                     ; Hide the sprite
9146   269B 77                  ld      (hl),a
9147   269C                     
9148   269C                     ; Jump back up to process the next pie
9149   269C 18 DA               jr      l25bb
9150   269E             ;------------------------------------------------------------------------------
9151   269E             
9152   269E             
9153   269E             
9154   269E             ;------------------------------------------------------------------------------
9155   269E             ; This function performs conveyer handling for the mixer stage
9156   269E             L_IMPLEMENT_CONVEYERS:  
9157   269E 3E 02       		ld      a,%00000010
9158   26A0 F7                  rst     $30							; Return unless this is the mixer stage
9159   26A1 CD AE 26            call    L_IMPLEMENT_TOP_CONVEYER
9160   26A4 CD D9 26            call    L_IMPLEMENT_MID_CONVEYERS
9161   26A7 CD F6 26            call    L_IMPLEMENT_BOT_CONVEYERS
9162   26AA CD AA 2B            call    L_MOVE_MARIO_ON_CONVEYERS
9163   26AD C9                  ret     
9164   26AE             ;------------------------------------------------------------------------------
9165   26AE             
9166   26AE             
9167   26AE             
9168   26AE             ;------------------------------------------------------------------------------
9169   26AE             ; This function controls the top conveyer belt and causes it to change directions
9170   26AE             ; periodically.
9171   26AE             ;
9172   26AE             ; It also calls the animate motor function to animate the top two conveyer belt
9173   26AE             ; motor sprite to simulate them rotating.
9174   26AE             L_IMPLEMENT_TOP_CONVEYER:  
9175   26AE             		; If counter 2 is odd, jump ahead to skip the conveyer reverse logic
9176   26AE 3A 1A 60    		ld      a,(COUNTER_2)
9177   26B1 0F                  rrca    
9178   26B2 38 0C               jr      c,l2616
9179   26B4             		
9180   26B4             		; If the conveyer reverse timer has not reached zero, jump ahead to
9181   26B4             		; skip the conveyer reverse logic
9182   26B4 21 A0 62            ld      hl,TOP_MASTER_REVERSE_TIMER
9183   26B7 35                  dec     (hl)
9184   26B8 20 06               jr      nz,l2616
9185   26BA             		
9186   26BA             		; Reset the conveyer reverse timer to 128
9187   26BA 36 80               ld      (hl),128
9188   26BC             		
9189   26BC             		; Reverse the conveyer belt
9190   26BC 2C                  inc     l							; TOP_MASTER_CONVEYER_DIR
9191   26BD CD 54 27            call    L_REVERSE_CONVEYER_DIR
9192   26C0             		
9193   26C0             		; Set the conveyer belt speed to 1 in the current direction
9194   26C0 21 A1 62    l2616:  ld      hl,TOP_MASTER_CONVEYER_DIR
9195   26C3 CD 5E 27            call    L_SET_CONVEYER_SPEED_TO_1
9196   26C6             		
9197   26C6             		; Set the top conveyer belt direction and speed to match the master
9198   26C6             		; animation conveyer belt direction
9199   26C6 32 A3 63            ld      (TOP_CONVEYER_DIR),a
9200   26C9             		
9201   26C9             		; If it is not time to update the motor animation, then return
9202   26C9 3A 1A 60            ld      a,(COUNTER_2)
9203   26CC E6 1F               and     %00011111
9204   26CE FE 01               cp      1
9205   26D0 C0                  ret     nz
9206   26D1             		
9207   26D1             		; Animate the two conveyer belt motors
9208   26D1 11 E4 69            ld      de,CONV_MOTOR_SPRITE_TL
9209   26D4 EB                  ex      de,hl
9210   26D5 CD 21 27            call    L_ANIMATE_MOTOR_SPRITES
9211   26D8 C9                  ret     
9212   26D9             ;------------------------------------------------------------------------------
9213   26D9             
9214   26D9             
9215   26D9             
9216   26D9             ;------------------------------------------------------------------------------
9217   26D9             ; This function controls the left and right conveyer belts on the mixer stage
9218   26D9             ; These two conveyer belts always move inwards.  
9219   26D9             ;
9220   26D9             ; It also calls the animate motor function to animate the top two conveyer belt
9221   26D9             ; motor sprite to simulate them rotating.
9222   26D9             L_IMPLEMENT_MID_CONVEYERS:  
9223   26D9 21 A3 62    l264c:  ld      hl,RIGHT_MASTER_CONVEYER_DIR
9224   26DC CD 5E 27            call    L_SET_CONVEYER_SPEED_TO_1	; a = RIGHT_MASTER_CONVEYER_DIR speed and dir
9225   26DF             
9226   26DF                     ; Set the right and left conveyer belt directions
9227   26DF                     ; (opposite of each other)
9228   26DF 32 A5 63            ld      (RIGHT_CONVEYER_DIR),a
9229   26E2 ED 44               neg     
9230   26E4 32 A4 63            ld      (LEFT_CONVEYER_DIR),a
9231   26E7                     
9232   26E7                     ; If it is not time to update the motor animation, then return
9233   26E7 3A 1A 60            ld      a,(COUNTER_2)
9234   26EA E6 1F               and     %00011111
9235   26EC C0                  ret     nz
9236   26ED             		
9237   26ED             		; Update the animation of the left and right conveyer motors
9238   26ED 2D                  dec     l							; MID_MASTER_REVERSE_TIMER
9239   26EE 11 EC 69            ld      de,CONV_MOTOR_SPRITE_MR
9240   26F1 EB                  ex      de,hl
9241   26F2 CD 21 27            call    L_ANIMATE_MOTOR_SPRITES
9242   26F5             
9243   26F5 C9                  ret    
9244   26F6             ;------------------------------------------------------------------------------
9245   26F6             
9246   26F6             
9247   26F6             		
9248   26F6             ;------------------------------------------------------------------------------
9249   26F6             ; This function controls the bottom conveyer belt and causes it to change directions
9250   26F6             ; periodically.
9251   26F6             ;
9252   26F6             ; It also calls the animate motor function to animate the bottom two conveyer belt
9253   26F6             ; motor sprite to simulate them rotating.
9254   26F6             L_IMPLEMENT_BOT_CONVEYERS:  
9255   26F6             		; If counter 2 is odd, jump ahead
9256   26F6 3A 1A 60    		ld      a,(COUNTER_2)
9257   26F9 0F                  rrca    
9258   26FA 38 0C               jr      c,l268d
9259   26FC                     
9260   26FC                     ; Decrement the conveyer reverse countdown timer
9261   26FC                     ; If it has not reached 0, jump ahead to skip reinitializing it
9262   26FC                     ; and reversing the conveyer
9263   26FC 21 A5 62            ld      hl,BOT_MASTER_REVERSE_TIMER
9264   26FF 35                  dec     (hl)
9265   2700 20 06               jr      nz,l268d
9266   2702                     
9267   2702                     ; Reinitialize the timer
9268   2702 36 FF               ld      (hl),255
9269   2704                     
9270   2704                     ; Reverse the conveyer belt
9271   2704 2C                  inc     l
9272   2705 CD 54 27            call    L_REVERSE_CONVEYER_DIR
9273   2708                     
9274   2708                     
9275   2708 21 A6 62    l268d:  ld      hl,BOT_MASTER_CONVEYER_DIR
9276   270B CD 5E 27            call    L_SET_CONVEYER_SPEED_TO_1
9277   270E                     
9278   270E                     ; Set the direction and speed of the bottom conveyer
9279   270E 32 A6 63            ld      (BOT_CONVEYER_DIR),a
9280   2711                     
9281   2711                     ; If it is not time to update the conveyer motor animation
9282   2711                     ; return
9283   2711 3A 1A 60            ld      a,(COUNTER_2)
9284   2714 E6 1F               and     %00011111
9285   2716 FE 02               cp      2
9286   2718 C0                  ret     nz
9287   2719             		
9288   2719             		; Animate the two bottom conveyer motors
9289   2719 11 F4 69            ld      de,CONV_MOTOR_SPRITE_BL
9290   271C EB                  ex      de,hl
9291   271D CD 21 27            call    L_ANIMATE_MOTOR_SPRITES
9292   2720 C9                  ret     
9293   2721             ;------------------------------------------------------------------------------
9294   2721             
9295   2721             
9296   2721             ;------------------------------------------------------------------------------
9297   2721             ; Animate a pair of conveyer belt motor sprites by advancing them in the 
9298   2721             ; direction matching the conveyer belt's direction.
9299   2721             ;
9300   2721             ; passed:	hl - the address of the first of the two conveyer belt motor 
9301   2721             ;				sprites
9302   2721             ;			de - the address of the conveyer belt direction variable
9303   2721             ; Return:	a - the new motor sprite number
9304   2721             L_ANIMATE_MOTOR_SPRITES:  
9305   2721             		; If the conveyer belt is moving left, jump ahead
9306   2721 2C          		inc     l							; Sprite number
9307   2722 1A                  ld      a,(de)
9308   2723 17                  rla     
9309   2724 38 17               jr      c,l26c5
9310   2726             		
9311   2726             		; Handle the motor sprites when the conveyer belt it moving right
9312   2726             		
9313   2726             		; Advance to the next motor sprite to give the illusion that it is 
9314   2726             		; rotating
9315   2726 7E                  ld      a,(hl)
9316   2727 3C                  inc     a
9317   2728             		
9318   2728             		; If the motor sprite number does not need to be wrapped, jump ahead
9319   2728             		; to skip it
9320   2728 FE 53               cp      $53
9321   272A 20 02               jr      nz,l26b5
9322   272C             		
9323   272C             		; Wrap the motor sprite number to the first motor sprite
9324   272C 3E 50               ld      a,$50
9325   272E             		
9326   272E             		; Save the new motor sprite number
9327   272E 77          l26b5:  ld      (hl),a
9328   272F             
9329   272F             		; Advance to the opposite motor sprite sprite (it is flipped horizontally)
9330   272F 7D                  ld      a,l
9331   2730 C6 04               add     a,4
9332   2732             		
9333   2732             		; Reverse to the previous motor sprite to give the illusion that it is
9334   2732             		; rotating
9335   2732 6F                  ld      l,a
9336   2733 7E                  ld      a,(hl)
9337   2734 3D                  dec     a
9338   2735             		
9339   2735             		; If the motor sprite number does not need to be wrapped, jump ahead
9340   2735             		; to skip it
9341   2735 FE CF               cp      $cf							; $4f flipped horizontally
9342   2737 20 02               jr      nz,l26c3
9343   2739             		
9344   2739             		; Wrap the motor sprite number
9345   2739 3E D2               ld      a,$d2						; $52 flipped horizontally
9346   273B             		
9347   273B             				
9348   273B             								
9349   273B             		; Handle the motor sprites when the conveyer belt is moving left
9350   273B             		
9351   273B             		; Save the new motor sprite
9352   273B 77          l26c3:  ld      (hl),a
9353   273C C9                  ret     
9354   273D             		
9355   273D             		; Reverse to the previous motor sprite to give the illusion that it is
9356   273D             		; rotating
9357   273D 7E          l26c5:  ld      a,(hl)
9358   273E 3D                  dec     a
9359   273F             		
9360   273F             		; If the motor sprite number does not need to be wrapped, jump ahead
9361   273F             		; to skip it
9362   273F FE 4F               cp      $4f
9363   2741 20 02               jr      nz,l26ce
9364   2743             		
9365   2743             		; Wrap the motor sprite
9366   2743 3E 52               ld      a,$52
9367   2745             		
9368   2745             		; Save the new motor sprite
9369   2745 77          l26ce:  ld      (hl),a
9370   2746             
9371   2746             		; Advance to the opposite motor sprite (it is flipped horizontally)
9372   2746 7D                  ld      a,l
9373   2747 C6 04               add     a,4
9374   2749             		
9375   2749             		; Advance to the next motor sprite to give the illusion that it is
9376   2749             		; rotating
9377   2749 6F                  ld      l,a
9378   274A 7E                  ld      a,(hl)
9379   274B 3C                  inc     a
9380   274C             		
9381   274C             		; If the motor sprite number does not need to be wrapped, jump ahead
9382   274C             		; to skip it
9383   274C FE D3               cp      $d3							; $53 flipped horizontally
9384   274E 20 02               jr      nz,l26dc
9385   2750             		
9386   2750             		; Wrap the motor sprite number
9387   2750 3E D0               ld      a,$d0						; $50 flipped horizontally
9388   2752             		
9389   2752             		; Save the new motor sprite
9390   2752 77          l26dc:  ld      (hl),a
9391   2753 C9                  ret     
9392   2754             ;------------------------------------------------------------------------------
9393   2754             
9394   2754             
9395   2754             
9396   2754             ;------------------------------------------------------------------------------
9397   2754             ; Reverse the direction of a conveyer belt
9398   2754             ; passed:	hl - the address of the conveyer belt direction variable
9399   2754             L_REVERSE_CONVEYER_DIR:  
9400   2754             		; If the conveyer belt is moving right, jump ahead
9401   2754 CB 7E       		bit     7,(hl)
9402   2756 28 03               jr      z,l26e6
9403   2758             		
9404   2758             		; The conveyer belt is moving left, so reverse it to move right
9405   2758 36 02               ld      (hl),2
9406   275A C9                  ret  
9407   275B             		
9408   275B             		; The conveyer belt is moving right, so reverse it to move left
9409   275B 36 FE       l26e6:  ld      (hl),-2
9410   275D C9                  ret     
9411   275E             ;------------------------------------------------------------------------------
9412   275E             
9413   275E             
9414   275E             
9415   275E             ;------------------------------------------------------------------------------
9416   275E             ; Slow a conveyer belt speed to 1 pixel in the current direction
9417   275E             ;
9418   275E             ; passed:	hl - the address of the conveyer belt direction variable
9419   275E             ; return:	a - the conveyer belt speed and direction
9420   275E             L_SET_CONVEYER_SPEED_TO_1:  
9421   275E             		; Return if counter 2 is even
9422   275E 3A 1A 60    		ld      a,(COUNTER_2)
9423   2761 E6 01               and     %00000001
9424   2763 C8                  ret     z
9425   2764             		
9426   2764             		; If the conveyer belt is moving left, set the direction to -1
9427   2764 CB 7E               bit     7,(hl)
9428   2766 3E FF               ld      a,-1
9429   2768 20 02               jr      nz,l26f8
9430   276A             		
9431   276A             		; The conveyer belt is moving right, so set the direction to 1
9432   276A 3E 01               ld      a,1
9433   276C 77          l26f8:  ld      (hl),a
9434   276D C9                  ret     
9435   276E             ;------------------------------------------------------------------------------
9436   276E             
9437   276E             
9438   276E             
9439   276E             ;------------------------------------------------------------------------------
9440   276E             ; Handle the elevators
9441   276E             ; Move the elevators
9442   276E             ; Detect when Mario is on an elevator
9443   276E             ; Move Mario with the elevator
9444   276E             ; Kill Mario if he reaches the bottom of the screen or is crushed at the top 
9445   276E             ;	of the elevator
9446   276E             ; Make Mario fall if he steps of the elevator
9447   276E             L_IMPLEMENT_ELEVATORS:  
9448   276E             		; Return unless this is the elevators stage
9449   276E 3E 04       		ld      a,%00000100
9450   2770 F7                  rst     $30		
9451   2771                     
9452   2771                     ; If Mario has reached the bottom of the screen,
9453   2771                     ; jump ahead to kill him				
9454   2771 3A 05 62            ld      a,(MARIO_Y)
9455   2774 FE F0               cp      240
9456   2776 30 62               jr      nc,l277f
9457   2778                     
9458   2778             		; On odd cycles, 
9459   2778             		; jump ahead to move the elevators
9460   2778 3A 1A 60            ld      a,(COUNTER_2)
9461   277B 0F          l271a:  rrca    
9462   277C 38 04               jr      c,l2722
9463   277E                     
9464   277E                     ; On even cycles,
9465   277E                     ; jump ahead to move Mario on the elevators
9466   277E CD A5 27    l271e:  call    L_MOVE_MARIO_ON_ELEVATORS
9467   2781 C9                  ret    
9468   2782             		
9469   2782             		; Move the elevators
9470   2782 CD F1 27    l2722:  call    L_MOVE_ELEVATORS
9471   2785             		; Spawn a new elevator if it is time
9472   2785 CD 2F 28            call    L_SPAWN_NEW_ELEVATOR
9473   2788                     
9474   2788                     ; Update the elevator sprite coordinates to match the data structures
9475   2788 06 06               ld      b,6							; 6 elevator platforms
9476   278A 11 10 00            ld      de,16						; 16 byte data structures 
9477   278D 21 58 69            ld      hl,ELEVATOR_PLATFORM_SPRITES
9478   2790 DD 21 00 66         ld      ix,ELEVATOR_STRUCTS
9479   2794 DD 7E 03    l2734:  ld      a,(ix+3)					; X coordinate
9480   2797 77                  ld      (hl),a						; Sprite x coordinate
9481   2798 2C                  inc     l
9482   2799 2C                  inc     l
9483   279A 2C                  inc     l							; Sprite y coordinate
9484   279B DD 7E 05            ld      a,(ix+5)					; Y coordinate
9485   279E 77                  ld      (hl),a
9486   279F 2C                  inc     l
9487   27A0                     
9488   27A0                     ; Advance to the next sprite
9489   27A0 DD 19               add     ix,de
9490   27A2 10 F0               djnz    l2734
9491   27A4 C9                  ret     
9492   27A5             ;------------------------------------------------------------------------------
9493   27A5             
9494   27A5             
9495   27A5             
9496   27A5             ;------------------------------------------------------------------------------
9497   27A5             ; Move Mario up or down with the elevators
9498   27A5             ; Checks if Mario has reached the very top or bottom of the elevator shaft
9499   27A5             ;	and kills him
9500   27A5             ; Make Mario fall if he steps off the platform
9501   27A5             L_MOVE_MARIO_ON_ELEVATORS:  
9502   27A5             		; Return if Mario is not riding an elevator
9503   27A5 3A 98 63    		ld      a,(MARIO_ON_ELEVATOR)
9504   27A8 A7                  and     a
9505   27A9 C8                  ret     z
9506   27AA             		
9507   27AA             		; Return if Mario is jumping
9508   27AA 3A 16 62            ld      a,(MARIO_IS_JUMPING)
9509   27AD A7                  and     a
9510   27AE C0                  ret     nz
9511   27AF             		
9512   27AF             		; If Mario has stepped off the left edge of the left elevator column,
9513   27AF             		; jump ahead to make him fall
9514   27AF 3A 03 62            ld      a,(MARIO_X)
9515   27B2 FE 2C               cp      44
9516   27B4 38 0C               jr      c,l2766
9517   27B6                     
9518   27B6                     ; If Mario is still on the left elevator column,
9519   27B6                     ; jump ahead to move him up with the elevators
9520   27B6 FE 43               cp      67
9521   27B8 38 11               jr      c,l276f
9522   27BA                     
9523   27BA                     ; If Mario has stepped off the right edge of the left elevator column,
9524   27BA                     ; or the left edge of the right elevator column,
9525   27BA                     ; jump ahead to make him fall
9526   27BA FE 6C               cp      108
9527   27BC 38 04               jr      c,l2766
9528   27BE                     
9529   27BE                     ; If Mario is still on the right elevator column,
9530   27BE                     ; jump ahead to move him down with the elevators
9531   27BE FE 83               cp      131
9532   27C0 38 20               jr      c,l2787
9533   27C2                     
9534   27C2                     ; Mario has stepped off the right edge of the right elevator column
9535   27C2             		; Mark Mario as no longer riding the elevators
9536   27C2 AF          l2766:  xor     a
9537   27C3 32 98 63            ld      (MARIO_ON_ELEVATOR),a
9538   27C6                     
9539   27C6                     ; Mark Mario as falling
9540   27C6 3C                  inc     a
9541   27C7 32 21 62            ld      (MARIO_IS_FALLING),a
9542   27CA C9                  ret     
9543   27CB             		
9544   27CB             		; Mario is riding the left elevator column
9545   27CB             		
9546   27CB             		; If Mario has been smashed at the top of the elevator,
9547   27CB             		; jump ahead to kill him
9548   27CB 3A 05 62    l276f:  ld      a,(MARIO_Y)
9549   27CE FE 71               cp      113
9550   27D0 38 08               jr      c,l277f
9551   27D2 3D                  dec     a
9552   27D3             		
9553   27D3             		; Move Mario up with the elevator
9554   27D3 32 05 62            ld      (MARIO_Y),a
9555   27D6 32 4F 69            ld      (MARIO_SPRITE_Y),a
9556   27D9 C9                  ret   
9557   27DA             		
9558   27DA             		; Mark Mario as dead
9559   27DA AF          l277f:  xor     a
9560   27DB 32 00 62            ld      (MARIO_ALIVE),a
9561   27DE             		
9562   27DE             		; Mark Mario as no longer on the elevator
9563   27DE 32 98 63            ld      (MARIO_ON_ELEVATOR),a
9564   27E1 C9                  ret     
9565   27E2             		
9566   27E2             		; Mario is riding the right elevator column
9567   27E2             		
9568   27E2             		; If Mario has reached the bottom of the the elevator column,
9569   27E2             		; jump back up to kill him
9570   27E2 3A 05 62    l2787:  ld      a,(MARIO_Y)
9571   27E5 FE E8               cp      232
9572   27E7 30 F1               jr      nc,l277f
9573   27E9             		
9574   27E9             		; Move Mario down with the elevator
9575   27E9 3C                  inc     a
9576   27EA 32 05 62            ld      (MARIO_Y),a
9577   27ED 32 4F 69            ld      (MARIO_SPRITE_Y),a
9578   27F0 C9                  ret     
9579   27F1             ;------------------------------------------------------------------------------
9580   27F1             
9581   27F1             
9582   27F1             
9583   27F1             ;------------------------------------------------------------------------------
9584   27F1             ; Move the elevators
9585   27F1             ; When an elevator reaches the top of the left column it is sent to the top of
9586   27F1             ; the right column
9587   27F1             ; When an elevator reaches the bottom of the right column, it is deactivated
9588   27F1             L_MOVE_ELEVATORS:  
9589   27F1             		; Iterate over each elevator platform
9590   27F1 06 06       		ld      b,6							; 6 elevator sprites
9591   27F3 11 10 00            ld      de,16						; 16 byte data structures
9592   27F6 DD 21 00 66         ld      ix,ELEVATOR_STRUCTS
9593   27FA             		
9594   27FA             		; If this elevator is inactive,
9595   27FA             		; jump ahead to process the next one
9596   27FA DD CB 00 46 l27a0:  bit     0,(ix+0)					
9597   27FE 28 19               jr      z,l27c2
9598   2800             		
9599   2800             		; If the elevator is moving down,
9600   2800             		; jump ahead to skip the moving up logic
9601   2800 DD CB 0D 5E         bit     3,(ix+13)					; Direction
9602   2804 28 18               jr      z,l27c7
9603   2806             
9604   2806             		; The elevator is moving up
9605   2806             		
9606   2806             		; Move the elevator one pixel up
9607   2806 DD 7E 05            ld      a,(ix+5)					; Y coordinate
9608   2809 3D                  dec     a
9609   280A DD 77 05    		ld      (ix+5),a
9610   280D             		
9611   280D             		; If the elevator has not reached the top, 
9612   280D             		; jump ahead
9613   280D FE 60               cp      96
9614   280F 20 08               jr      nz,l27c2
9615   2811             		
9616   2811             		; Move the elevator to the top of the right column
9617   2811 DD 36 03 77         ld      (ix+3),119					; X coordinate
9618   2815 DD 36 0D 04         ld      (ix+13),4					; Direction
9619   2819             		
9620   2819             		; Process the next elevator platform
9621   2819 DD 19       l27c2:  add     ix,de
9622   281B 10 DD               djnz    l27a0
9623   281D C9                  ret  
9624   281E             		
9625   281E             		; The elevator is moving down
9626   281E             		
9627   281E             		; Move the elevator one pixel down
9628   281E DD 7E 05    l27c7:  ld      a,(ix+5)
9629   2821 3C                  inc     a
9630   2822 DD 77 05            ld      (ix+5),a
9631   2825             		
9632   2825             		; If the elevator has not reached the bottom,
9633   2825             		; jump back up to process the next elevator
9634   2825 FE F8               cp      248
9635   2827 20 F0               jr      nz,l27c2
9636   2829             		
9637   2829             		; Deactivate this elevator and process the next one
9638   2829 DD 36 00 00         ld      (ix+0),0					; Inactive
9639   282D 18 EA               jr      l27c2
9640   282F             ;------------------------------------------------------------------------------
9641   282F             
9642   282F             
9643   282F             		
9644   282F             ;------------------------------------------------------------------------------
9645   282F             ; Spawns a new elevator when the elevator spawn timer reaches 0
9646   282F             L_SPAWN_NEW_ELEVATOR:  
9647   282F             		; If it is not time to spawn an elevator, 
9648   282F             		; jump ahead to decrement the spawn timer
9649   282F 21 A7 62    		ld      hl,ELEVATOR_SPAWN_TIMER
9650   2832 7E                  ld      a,(hl)
9651   2833 A7                  and     a
9652   2834 20 23               jr      nz,l2806
9653   2836             		
9654   2836             		; Search for the first available elevator data structure
9655   2836 06 06               ld      b,6							; 6 elevator platforms
9656   2838 DD 21 00 66         ld      ix,ELEVATOR_STRUCTS
9657   283C             
9658   283C             		; If this elevator is inactive, 
9659   283C             		; jump ahead to use it
9660   283C DD CB 00 46 l27e8:  bit     0,(ix+0)
9661   2840 28 05               jr      z,l27f4
9662   2842             		
9663   2842             		; Check the next elevator
9664   2842 DD 19               add     ix,de
9665   2844 10 F6               djnz    l27e8
9666   2846 C9                  ret   
9667   2847             		
9668   2847             		; Spawn the elevator at the bottom of the left column
9669   2847 DD 36 00 01 l27f4:  ld      (ix+0),1					; Active
9670   284B DD 36 03 37         ld      (ix+3),55					; X coordinate
9671   284F DD 36 05 F8         ld      (ix+5),248					; Y coordinate
9672   2853 DD 36 0D 08         ld      (ix+13),8					; Moving up
9673   2857 36 34               ld      (hl),52						; ELEVATOR_SPAWN_TIMER
9674   2859             		
9675   2859             		; Decrement the elevator spawn timer
9676   2859 35          l2806:  dec     (hl)						; ELEVATOR_SPAWN_TIMER
9677   285A C9                  ret     
9678   285B             ;------------------------------------------------------------------------------
9679   285B             
9680   285B             
9681   285B             
9682   285B             ;------------------------------------------------------------------------------
9683   285B             ; The directions to move the elevators in each quadrant
9684   285B             L_QUADRANT_DIRECTIONS:
9685   285B 01 01       		.byte	 1,  1	; Quadrant 0
9686   285D FF 01       		.byte	-1,  1	; Quadrant 1
9687   285F FF FF       		.byte	-1, -1	; Quadrant 2
9688   2861 01 FF       		.byte	 1, -1	; Quadrant 3
9689   2863             ;------------------------------------------------------------------------------
9690   2863             
9691   2863             
9692   2863             
9693   2863             ;------------------------------------------------------------------------------
9694   2863             ; Handle the elevators on the secret stage
9695   2863             ; Move the elevators
9696   2863             ; Detect when Mario is on an elevator
9697   2863             ; Move Mario with the elevator
9698   2863             ; Kill Mario if he reaches the bottom of the screen or is crushed at the top 
9699   2863             ;	of the elevator
9700   2863             ; Make Mario fall if he steps off the elevator
9701   2863             ;
9702   2863             ; NOTE: Look at streamlining this function
9703   2863             L_IMPLEMENT_SECRET_ELEVATORS:  
9704   2863             		; Return unless this is the secret stage
9705   2863 3E 10       		ld      a,%00010000
9706   2865 F7                  rst     $30	
9707   2866             		
9708   2866             		; Return if Mario is dead
9709   2866 D7          		rst		$10
9710   2867             		
9711   2867                     ; If Mario has reached the bottom of the screen,
9712   2867                     ; jump back up to code that will mark him as dead
9713   2867 3A 05 62            ld      a,(MARIO_Y)
9714   286A FE F8               cp      248
9715   286C D2 DA 27            jp      nc,l277f					; Exceeds relative branch
9716   286F             
9717   286F             		; Only move the elevators every other counter cycle
9718   286F 3A 1A 60            ld      a,(COUNTER_2)
9719   2872 0F          		rrca	
9720   2873 D0          		ret		nc
9721   2874             		
9722   2874             		; Only move the elevators when they are not paused
9723   2874 3A BA 62    		ld		a,(SECRET_ELEVATOR_PAUSE_COUNT)
9724   2877 A7          		and		a
9725   2878 28 05       		jr		z,l_implement_secret_elevators_1
9726   287A             		
9727   287A             		; Decrement the pause counter and return
9728   287A 21 BA 62    		ld		hl,SECRET_ELEVATOR_PAUSE_COUNT
9729   287D 35          		dec		(hl)
9730   287E C9          		ret
9731   287F             
9732   287F             l_implement_secret_elevators_1:		
9733   287F             		; Get the vectors for the current quadrant
9734   287F 21 B7 62    		ld		hl,SECRET_ELEVATOR_QUAD
9735   2882 7E          		ld		a,(hl)
9736   2883 21 5B 28    		ld		hl,L_QUADRANT_DIRECTIONS
9737   2886 87          		add		a,a
9738   2887 85          		add		a,l
9739   2888 6F          		ld		l,a
9740   2889 46          		ld		b,(hl)
9741   288A 23          		inc		hl
9742   288B 4E          		ld		c,(hl)
9743   288C             		
9744   288C             		; Advance the move counter
9745   288C 21 B6 62    		ld		hl,SECRET_ELEVATOR_MOVE_COUNT
9746   288F 34          		inc		(hl)
9747   2890 7E          		ld		a,(hl)
9748   2891             		
9749   2891             		; If the elevator has not reached the end of the quadrant,
9750   2891             		; jump ahead to finish
9751   2891 FE 18       		cp		24
9752   2893 38 26       		jr		c,l_implement_secret_elevators_3
9753   2895             		
9754   2895             		; If the elevators don't need to reverse direction
9755   2895 21 BB 62    		ld		hl,SECRET_ELEVATOR_REVERSE
9756   2898 7E          		ld		a,(hl)
9757   2899 A7          		and		a
9758   289A 36 00       		ld		(hl),0
9759   289C             
9760   289C 3A A4 62    		ld		a,(SECRET_ELEVATOR_DIR)
9761   289F CA AB 28    		jp		z,l_implement_secret_elevators_2
9762   28A2             
9763   28A2             		; Reverse the elevator direction
9764   28A2 ED 44       		neg		
9765   28A4             
9766   28A4             		; Change to the opposite quadrant
9767   28A4 F5          		push	af
9768   28A5 21 B7 62    		ld		hl,SECRET_ELEVATOR_QUAD
9769   28A8 86          		add		a,(hl)
9770   28A9 77          		ld		(hl),a
9771   28AA F1          		pop		af
9772   28AB             		
9773   28AB             l_implement_secret_elevators_2:
9774   28AB             		; Advance the quadrant in the correct direction
9775   28AB 32 A4 62    		ld		(SECRET_ELEVATOR_DIR),a
9776   28AE 21 B7 62    		ld		hl,SECRET_ELEVATOR_QUAD
9777   28B1 86          		add		a,(hl)
9778   28B2 E6 03       		and		%00000011					; Force quadrant to 0-3
9779   28B4 77          		ld		(hl),a						; Elevator quadrant
9780   28B5             
9781   28B5             		; Pause for a few cycles at the end of the quadrant
9782   28B5 3E 10       		ld		a,16
9783   28B7 32 BA 62    		ld		(SECRET_ELEVATOR_PAUSE_COUNT),a
9784   28BA             		
9785   28BA             		; Reset the move counter
9786   28BA AF          		xor		a
9787   28BB             		
9788   28BB             l_implement_secret_elevators_3:
9789   28BB 32 B6 62    		ld		(SECRET_ELEVATOR_MOVE_COUNT),a	; Move counter
9790   28BE             		
9791   28BE             		; Move the elevators
9792   28BE DD 21 00 66 		ld		ix,ELEVATOR_STRUCT_1
9793   28C2 11 58 69    		ld		de,ELEVATOR_PLATFORM_SPRITE_1
9794   28C5 CD CF 28    		call	l_implement_secret_elevators_5
9795   28C8 DD 21 10 66 		ld		ix,ELEVATOR_STRUCT_2
9796   28CC 11 5C 69    		ld		de,ELEVATOR_PLATFORM_SPRITE_2
9797   28CF             		
9798   28CF             l_implement_secret_elevators_5:		
9799   28CF             		; If Mario is jumping,
9800   28CF             		; skip the code that moves him with the elevator
9801   28CF 3A 16 62    		ld		a,(MARIO_IS_JUMPING)
9802   28D2 B7          		or		a
9803   28D3 20 34       		jr		nz,lelevatormove
9804   28D5             		
9805   28D5             		; If Mario is riding an elevator
9806   28D5 3A 98 63    		ld		a,(MARIO_ON_ELEVATOR)
9807   28D8 B7          		or		a
9808   28D9 28 2E       		jr		z,lelevatormove
9809   28DB             		
9810   28DB             		; If Mario is on this elevator
9811   28DB 3A 05 62    		ld		a,(MARIO_Y)
9812   28DE C6 0C       		add		a,12
9813   28E0 DD 96 05    		sub		(ix+5)
9814   28E3 20 24       		jr		nz,lelevatormove
9815   28E5             		
9816   28E5             		; If Mario has walked off the left edge of the elevator,
9817   28E5             		; jump to code that will mark him as falling
9818   28E5 3A 03 62    		ld		a,(MARIO_X)
9819   28E8 DD 96 03    		sub		(ix+3)
9820   28EB FE F4       		cp		-12
9821   28ED FA C2 27    		jp		m,l2766
9822   28F0             	
9823   28F0             		; If Mario has walked off the right edge of the elevator,
9824   28F0             		; jump to code that will mark him as falling
9825   28F0 FE 0C       		cp		12
9826   28F2 F2 C2 27    		jp		p,l2766		
9827   28F5             		
9828   28F5             		; Move Mario with the elevator
9829   28F5 3A 05 62    		ld		a,(MARIO_Y)
9830   28F8 81          		add		a,c
9831   28F9 32 05 62    		ld		(MARIO_Y),a
9832   28FC 32 4F 69    		ld		(MARIO_SPRITE_Y),a
9833   28FF 3A 03 62    		ld		a,(MARIO_X)
9834   2902 80          		add		a,b
9835   2903 32 03 62    		ld		(MARIO_X),a
9836   2906 32 4C 69    		ld		(MARIO_SPRITE_X),a
9837   2909             
9838   2909             lelevatormove:
9839   2909             		; Move the elevator vertically
9840   2909 DD 7E 05    		ld		a,(ix+5)
9841   290C 81          		add		a,c
9842   290D DD 77 05    		ld		(ix+5),a
9843   2910             		
9844   2910             		; Move the elevator horizontally
9845   2910 DD 7E 03    		ld		a,(ix+3)
9846   2913 80          		add		a,b
9847   2914 DD 77 03    		ld		(ix+3),a
9848   2917                     
9849   2917             lsecret2734:  
9850   2917             		; Update the elevator sprites
9851   2917 DD 7E 03    		ld      a,(ix+3)					; X coordinate
9852   291A 12                  ld      (de),a						; Sprite x coordinate
9853   291B 1C                  inc     e
9854   291C 1C                  inc     e
9855   291D 1C                  inc     e							; Sprite y coordinate
9856   291E DD 7E 05            ld      a,(ix+5)					; Y coordinate
9857   2921 12                  ld      (de),a
9858   2922 C9                  ret     
9859   2923             ;------------------------------------------------------------------------------
9860   2923             
9861   2923             
9862   2923             
9863   2923             ;------------------------------------------------------------------------------
9864   2923             ; Check if Mario has come in contact with an enemy and kill him
9865   2923             L_CHECK_FOR_ENEMY_COLLISION:  
9866   2923             		; If Mario has not contacted any enemy,
9867   2923             		; return
9868   2923 FD 21 00 62 		ld      iy,MARIO_DATA_STRUCT
9869   2927 3A 05 62            ld      a,(MARIO_Y)
9870   292A 4F                  ld      c,a
9871   292B 21 07 04            ld      hl,$0407					; 8x14 collision boundary
9872   292E CD 88 29            call    L_IMPL_ENEMY_COLL_FOR_STAGE
9873   2931 A7                  and     a
9874   2932 C8                  ret     z
9875   2933             		
9876   2933             		; Mario has contacted an enemy
9877   2933             		
9878   2933             		; Mark Mario as dead
9879   2933 3D                  dec     a
9880   2934 32 00 62            ld      (MARIO_ALIVE),a
9881   2937 C9                  ret     
9882   2938             ;------------------------------------------------------------------------------
9883   2938             
9884   2938             
9885   2938             ;------------------------------------------------------------------------------
9886   2938             ; Check if Mario has struck an enemy with the hammer
9887   2938             L_CHECK_FOR_HAMMER_KILL:  
9888   2938             		; Examine each hammer
9889   2938 06 02       		ld      b,2							; 2 hammers
9890   293A 11 10 00            ld      de,16						; 16 byte data structures
9891   293D FD 21 80 66         ld      iy,HAMMER_STRUCTS
9892   2941             
9893   2941             		; If Mario has this hammer, jump ahead to handle it
9894   2941 FD CB 01 46 l2826:  bit     0,(iy+1)
9895   2945 20 05               jr      nz,l2832
9896   2947             		
9897   2947             		; Check the next hammer
9898   2947 FD 19               add     iy,de
9899   2949 10 F6               djnz    l2826						; Next b
9900   294B C9                  ret     
9901   294C             
9902   294C             		; If the hammer has not hit an enemy, 
9903   294C             		; return
9904   294C FD 4E 05    l2832:  ld      c,(iy+5)					; Hammer y coordinate
9905   294F FD 66 09            ld      h,(iy+9)					; Collision boundary x radius
9906   2952 FD 6E 0A            ld      l,(iy+10)					; Collision boundary y radius
9907   2955 CD 88 29            call    L_IMPL_ENEMY_COLL_FOR_STAGE
9908   2958 A7                  and     a
9909   2959 C8                  ret     z
9910   295A             		
9911   295A             		; The hammer has struck an enemy
9912   295A             		
9913   295A             		; Activate the smash animation sequence
9914   295A 32 50 63            ld      (SMASH_ANIMATION_ACTIVE),a
9915   295D             		
9916   295D             		; Calculate the index of the enemy that was struck
9917   295D 3A B9 63            ld      a,(NUM_ENEMIES_OF_CURRENT_CLASS)
9918   2960 90                  sub     b
9919   2961 32 54 63            ld      (SMASH_ANIMATION_ENEMY_INDEX),a
9920   2964             		
9921   2964             		; Save the structure size
9922   2964 7B                  ld      a,e							; Data structure size in bytes
9923   2965 32 53 63            ld      (SMASH_ENEMY_DATA_SIZE),a
9924   2968             		
9925   2968             		; Save a pointer to the first entry in the enemy's class data structures
9926   2968 DD 22 51 63         ld      (SMASH_ENEMY_CLASS_POINTER),ix
9927   296C C9                  ret     
9928   296D             ;------------------------------------------------------------------------------
9929   296D             
9930   296D             
9931   296D             
9932   296D             ;------------------------------------------------------------------------------
9933   296D             ; Check if Mario has jumped over an enemy
9934   296D             L_CHECK_FOR_ENEMY_JUMP:  
9935   296D             		; Setup the collision check
9936   296D FD 21 00 62 		ld      iy,MARIO_DATA_STRUCT
9937   2971 3A 05 62            ld      a,(MARIO_Y)
9938   2974             		
9939   2974             		; Setup the boundary 12 pixels below Mario
9940   2974 C6 0C               add     a,12
9941   2976 4F                  ld      c,a
9942   2977             		
9943   2977             		; If the player is not pressing left or right, 
9944   2977             		; jump ahead to use a normal sized boundary
9945   2977 3A 10 60            ld      a,(PLAYER_INPUT)
9946   297A E6 03               and     %00000011
9947   297C 21 08 05            ld      hl,TWO_BYTES(5, 8)			; 10x16 boundary
9948   297F 28 03               jr      z,l286b
9949   2981             		
9950   2981             		; If the player is pressing left or right,
9951   2981             		; use a wider boundary
9952   2981 21 08 13            ld      hl,TWO_BYTES(19,8)			; 28x16 boundary
9953   2984             
9954   2984             		; Check if Mario has jumped over an enemy
9955   2984 CD 19 3F    l286b:  call    l3e88
9956   2987 C9                  ret     
9957   2988             ;------------------------------------------------------------------------------
9958   2988             
9959   2988             
9960   2988             
9961   2988             ;------------------------------------------------------------------------------
9962   2988             ; Check for collisions with enemies specific to the current stage
9963   2988             L_IMPL_ENEMY_COLL_FOR_STAGE:  
9964   2988 3A 27 62    		ld      a,(CURRENT_STAGE)
9965   298B 3D          		dec		a
9966   298C E5                  push    hl
9967   298D EF                  rst     $28							; Jump to local table address
9968   298E                     ; Jump table
9969   298E 98 29       		.word	L_BARREL_ENEMY_COLLISION	; 1 = barrels stage
9970   2990 B8 29       		.word	L_MIXER_ENEMY_COLLISION		; 2 = mixer stage
9971   2992 D7 29       		.word	L_ELEVATOR_ENEMY_COLLISION	; 3 = elevators stage
9972   2994 F8 29       		.word	L_RIVETS_ENEMY_COLLISION	; 4 = rivets stage
9973   2996 F8 29       		.word	L_RIVETS_ENEMY_COLLISION	; 5 = secret stage (same as rivets)
9974   2998             ;------------------------------------------------------------------------------
9975   2998             
9976   2998             
9977   2998             
9978   2998             ;------------------------------------------------------------------------------
9979   2998             ; Check for collisions with enemies on the barrels stage
9980   2998             L_BARREL_ENEMY_COLLISION:  
9981   2998 E1          		pop     hl							; Collision boundary size
9982   2999             		
9983   2999             		; Return if there has been a collision with a barrel
9984   2999 06 0A               ld      b,10						; 10 barrels
9985   299B 78                  ld      a,b
9986   299C 32 B9 63            ld      (NUM_ENEMIES_OF_CURRENT_CLASS),a
9987   299F 11 20 00            ld      de,32						; 32 byte data size
9988   29A2 DD 21 00 67         ld      ix,BARREL_STRUCTS
9989   29A6 CD 0A 2A            call    L_CHECK_FOR_COLLISION
9990   29A9             		
9991   29A9             		; ; Return if there has been a collision with a fire ball
9992   29A9                     ; ld      b,5							; 5 fire balls
9993   29A9                     ; ld      a,b
9994   29A9                     ; ld      (NUM_ENEMIES_OF_CURRENT_CLASS),a
9995   29A9                     ; ld      e,32						; 32 byte data size
9996   29A9                     ; ld      ix,FIREBALL_STRUCTS
9997   29A9                     ; call    L_CHECK_FOR_COLLISION
9998   29A9             		
9999   29A9             		; Return if there has been a collision with the barrel fire
10000  29A9 06 01               ld      b,1							; 1 barrel fire
10001  29AB 78                  ld      a,b
10002  29AC 32 B9 63            ld      (NUM_ENEMIES_OF_CURRENT_CLASS),a
10003  29AF DD 21 A0 66         ld      ix,BARREL_FIRE_STRUCT
10004  29B3 CD 0A 2A            call    L_CHECK_FOR_COLLISION
10005  29B6             
10006  29B6             		; ; Return with no collision detected
10007  29B6                     ; ret     
10008  29B6             		
10009  29B6             		; Jump to the rivets collision detection code to check for
10010  29B6             		; fireballs and collision areas
10011  29B6 18 41       		jr		l_rivets_enemy_collision_1
10012  29B8             ;------------------------------------------------------------------------------
10013  29B8             
10014  29B8             
10015  29B8             
10016  29B8             ;------------------------------------------------------------------------------
10017  29B8             ; Check for collisions on the mixer stage
10018  29B8             L_MIXER_ENEMY_COLLISION:  
10019  29B8 E1          		pop     hl							; Collision boundary size
10020  29B9             		
10021  29B9             		; ; Return if there has been a collision with a fire ball
10022  29B9                     ; ld      b,5							; 5 fire balls	
10023  29B9                     ; ld      a,b
10024  29B9                     ; ld      (NUM_ENEMIES_OF_CURRENT_CLASS),a
10025  29B9                     ; ld      de,32						; 32 byte data size
10026  29B9                     ; ld      ix,FIREBALL_STRUCTS
10027  29B9                     ; call    L_CHECK_FOR_COLLISION
10028  29B9             		
10029  29B9             		; Return if there has been a collision with a "pie"
10030  29B9 06 06               ld      b,6							; 6 pies
10031  29BB 78                  ld      a,b
10032  29BC 32 B9 63            ld      (NUM_ENEMIES_OF_CURRENT_CLASS),a
10033  29BF 1E 10               ld      e,16						; 16 byte data structure
10034  29C1 DD 21 A0 65         ld      ix,PIE_STRUCTS
10035  29C5 CD 0A 2A            call    L_CHECK_FOR_COLLISION
10036  29C8             		
10037  29C8             		; Return if there has been a collision with the barrel fire
10038  29C8 06 01               ld      b,1							; 1 barrel fire
10039  29CA 78                  ld      a,b
10040  29CB 32 B9 63            ld      (NUM_ENEMIES_OF_CURRENT_CLASS),a
10041  29CE DD 21 A0 66         ld      ix,BARREL_FIRE_STRUCT
10042  29D2 CD 0A 2A            call    L_CHECK_FOR_COLLISION
10043  29D5             		
10044  29D5             		; ; Return with no collision detected
10045  29D5                     ; ret     
10046  29D5             
10047  29D5             		; Jump to the rivets collision detection code to check for
10048  29D5             		; fireballs and collision areas
10049  29D5 18 22       		jr		l_rivets_enemy_collision_1
10050  29D7             ;------------------------------------------------------------------------------
10051  29D7             
10052  29D7             
10053  29D7             
10054  29D7             ;------------------------------------------------------------------------------
10055  29D7             ; Check for collisions on the elevators stage
10056  29D7             L_ELEVATOR_ENEMY_COLLISION:  
10057  29D7 E1          		pop     hl							; Collision boundary size
10058  29D8             		
10059  29D8             		; Return if there has been a collision with a fire ball
10060  29D8 06 07               ld      b,7							; 5 fire balls
10061  29DA 78                  ld      a,b
10062  29DB 32 B9 63            ld      (NUM_ENEMIES_OF_CURRENT_CLASS),a
10063  29DE 11 20 00            ld      de,32						; 32 byte data size
10064  29E1 DD 21 00 64         ld      ix,FIREBALL_STRUCTS
10065  29E5 CD 0A 2A            call    L_CHECK_FOR_COLLISION
10066  29E8             		
10067  29E8             		; Return if there has been a collision with a spring
10068  29E8 06 0A               ld      b,10						; 10 springs
10069  29EA 78                  ld      a,b
10070  29EB 32 B9 63            ld      (NUM_ENEMIES_OF_CURRENT_CLASS),a
10071  29EE 1E 10               ld      e,16						; 16 byte data size
10072  29F0 DD 21 00 65         ld      ix,SPRING_STRUCTS
10073  29F4 CD 0A 2A            call    L_CHECK_FOR_COLLISION
10074  29F7             		
10075  29F7             		; Return with no collision detected
10076  29F7 C9                  ret     
10077  29F8             		
10078  29F8             		; Jump to the rivets collision detection code to check for
10079  29F8             		; fireballs and collision areas
10080  29F8             		; jr		l_rivets_enemy_collision_1
10081  29F8             ;------------------------------------------------------------------------------
10082  29F8             
10083  29F8             		
10084  29F8             		
10085  29F8             ;------------------------------------------------------------------------------
10086  29F8             ; Check for collisions on the rivets stage
10087  29F8             L_RIVETS_ENEMY_COLLISION:  
10088  29F8 E1          		pop     hl							; Collision boundary size
10089  29F9             		
10090  29F9             		; Return if there has been a collision with a fire ball or
10091  29F9             		; the collision areas around Donkey Kong
10092  29F9             l_rivets_enemy_collision_1:
10093  29F9 06 07               ld      b,7							; 5 fire balls + 2 collision areas
10094  29FB 78                  ld      a,b
10095  29FC 32 B9 63            ld      (NUM_ENEMIES_OF_CURRENT_CLASS),a
10096  29FF 11 20 00            ld      de,32						; 32 byte data size
10097  2A02 DD 21 00 64         ld      ix,FIREBALL_STRUCTS
10098  2A06 CD 0A 2A            call    L_CHECK_FOR_COLLISION
10099  2A09             		
10100  2A09             		; Return with no collision detected
10101  2A09 C9                  ret     
10102  2A0A             ;------------------------------------------------------------------------------
10103  2A0A             
10104  2A0A             
10105  2A0A             
10106  2A0A             ;------------------------------------------------------------------------------
10107  2A0A             ; Check for collision between 1 sprite (Mario/Hammer) and a group of sprites
10108  2A0A             ; (enemies)
10109  2A0A             ; passed:	b - the number of enemies to process
10110  2A0A             ;			c - y coordinate
10111  2A0A             ;			de - the size of the structure
10112  2A0A             ;			h - the collision boundary width (radius)
10113  2A0A             ;			l - the collision boundary height (radius)
10114  2A0A             ;			ix - pointer to the first enemy sprite
10115  2A0A             ;			iy - pointer to the start of the prime sprite data structure
10116  2A0A             ; return:	a - 1 if a collision occurred,
10117  2A0A             ;				0 otherwise
10118  2A0A             L_CHECK_FOR_COLLISION:  
10119  2A0A DD E5       		push    ix
10120  2A0C             
10121  2A0C             		; If the current enemy sprite is inactive, jump ahead to check the next one
10122  2A0C DD CB 00 46 l2915:  bit     0,(ix+0)					; Active flag
10123  2A10 28 29               jr      z,l294c
10124  2A12             		
10125  2A12             		; Calculate the absolute difference between 
10126  2A12             		; the primary sprite's y coordinate and
10127  2A12             		; the enemy sprite's y coordinate
10128  2A12 79                  ld      a,c
10129  2A13 DD 96 05            sub     (ix+5)						; Y coordinate
10130  2A16 30 02               jr      nc,l2925
10131  2A18 ED 44               neg     
10132  2A1A             
10133  2A1A             		; If the primary sprite's vertical collision boundary 
10134  2A1A             		; encompasses the center of the enemy sprite,
10135  2A1A             		; jump ahead
10136  2A1A 3C          l2925:  inc     a
10137  2A1B 95                  sub     l							; Boundary height
10138  2A1C 38 05               jr      c,l2930
10139  2A1E             		
10140  2A1E             		; If the boundaries don't overlap vertically, 
10141  2A1E             		; jump ahead to process the next enemy
10142  2A1E DD 96 0A            sub     (ix+10)						; Enemy boundary height
10143  2A21 30 18               jr      nc,l294c
10144  2A23             		
10145  2A23             		; Calculate the absolute difference between 
10146  2A23             		; the primary sprite's x coordinate and
10147  2A23             		; the enemy sprite's x coordinate
10148  2A23 FD 7E 03    l2930:  ld      a,(iy+3)					; X coordinate
10149  2A26 DD 96 03            sub     (ix+3)						; X coordinate
10150  2A29 30 02       		jr      nc,l293b
10151  2A2B ED 44       		neg     
10152  2A2D             		
10153  2A2D             		; If the primary sprite's horizontal collision boundary
10154  2A2D             		; encompasses the center of the enemy sprite
10155  2A2D             		; jump ahead
10156  2A2D 94          l293b:  sub     h							; Boundary width
10157  2A2E 38 05               jr      c,l2945
10158  2A30             		
10159  2A30             		; If the boundaries don't ovelap horizontally,
10160  2A30             		; jump ahead to process the next enemy
10161  2A30 DD 96 09            sub     (ix+9)						; Enemy boundary width
10162  2A33 30 06               jr      nc,l294c
10163  2A35             		
10164  2A35             		; Indicate that a collision has ocurred
10165  2A35 3E 01       l2945:  ld      a,1
10166  2A37 DD E1               pop     ix
10167  2A39             		
10168  2A39             		; Return from the calling function
10169  2A39 E1                  pop		hl
10170  2A3A C9                  ret  
10171  2A3B             		
10172  2A3B             		; Process the next enemy sprite
10173  2A3B DD 19       l294c:  add     ix,de
10174  2A3D 10 CD               djnz    l2915
10175  2A3F                     
10176  2A3F                     ; Indicate that a collision did not occur
10177  2A3F AF                  xor     a
10178  2A40 DD E1               pop     ix
10179  2A42 C9                  ret     
10180  2A43             ;------------------------------------------------------------------------------
10181  2A43             
10182  2A43             
10183  2A43             
10184  2A43             ;------------------------------------------------------------------------------
10185  2A43             ; Implements the logic that checks for Mario grabbing a hammer and then 
10186  2A43             ; triggers the hammer cycle to start
10187  2A43             L_IMPLEMENT_HAMMER_GRAB:  
10188  2A43             		; Return unless this is the barrels stage, mixer stage, or rivets stage
10189  2A43 3E 0B       		ld      a,%00001011
10190  2A45 F7                  rst     $30							
10191  2A46                     
10192  2A46             		; Check if a hammer has been grabbed
10193  2A46             		; Return if no hammer has been grabbed
10194  2A46 CD 62 2A    		call    L_CHECK_FOR_HAMMER_GRAB
10195  2A49             
10196  2A49             		; Set the hammer grabbed flag to true
10197  2A49 32 18 62            ld      (HAMMER_GRABBED),a
10198  2A4C             		
10199  2A4C             		; Trigger the award sound to play
10200  2A4C 0F                  rrca    
10201  2A4D 0F                  rrca    							; $04
10202  2A4E 32 85 60            ld      (AWARD_SOUND_TRIGGER),a
10203  2A51             		
10204  2A51             		; If no hammer was grabbed, return?
10205  2A51 78                  ld      a,b
10206  2A52 A7                  and     a
10207  2A53 C8                  ret     z
10208  2A54             		
10209  2A54             		; If the second hammer was grabbed, jump ahead to mark it as taken
10210  2A54 FE 01               cp      1
10211  2A56 28 05               jr      z,l296f
10212  2A58             		
10213  2A58             		; Mark the first hammer as grabbed
10214  2A58 DD 36 01 01         ld      (ix+1),1					; Hammer grabbed
10215  2A5C C9                  ret     
10216  2A5D             		
10217  2A5D             		; Mark the second hammer as grabbed
10218  2A5D DD 36 11 01 l296f:  ld      (ix+17),1					; Hammer grabbed
10219  2A61 C9                  ret     
10220  2A62             ;------------------------------------------------------------------------------
10221  2A62             
10222  2A62             
10223  2A62             
10224  2A62             ;------------------------------------------------------------------------------
10225  2A62             ; Detect when a hammer has been grabbed by checking if Mario has "collided" 
10226  2A62             ; with a hammer.
10227  2A62             ; 
10228  2A62             ; return:	a - 1 if a hammer has been grabbed
10229  2A62             ;			b - 0 if no hammer was grabbed
10230  2A62             ;				1 if the second hammer was grabbed
10231  2A62             ;				2 if the first hammer was grabbed
10232  2A62             ;			ix - pointing to the first hammer data structure
10233  2A62             L_CHECK_FOR_HAMMER_GRAB:  
10234  2A62 FD 21 00 62 		ld      iy,MARIO_DATA_STRUCT
10235  2A66 3A 05 62            ld      a,(MARIO_Y)
10236  2A69 4F                  ld      c,a
10237  2A6A 21 08 04            ld      hl,TWO_BYTES(4,8)			; 8x16 collision area
10238  2A6D 06 02               ld      b,2							; 2 hammers
10239  2A6F 11 10 00            ld      de,16						; 16 byte data structures
10240  2A72 DD 21 80 66         ld      ix,HAMMER_STRUCTS
10241  2A76 CD 0A 2A            call    L_CHECK_FOR_COLLISION
10242  2A79 C9                  ret     
10243  2A7A             ;------------------------------------------------------------------------------
10244  2A7A             
10245  2A7A             
10246  2A7A             
10247  2A7A             ;------------------------------------------------------------------------------
10248  2A7A             ; Checks if the current fireball is attempting to move off a girder into
10249  2A7A             ; empty air.  
10250  2A7A             ; return:	a - 0 if the tile the fireball is moving onto is a girder
10251  2A7A             ;				1 if it is not
10252  2A7A             L_CHECK_IF_NOT_SUPPORTED:  
10253  2A7A             		; Get the fireball's next intended x coordinate
10254  2A7A 2A C8 63    		ld      hl,(CURRENT_FIREBALL)
10255  2A7D 7D                  ld      a,l
10256  2A7E C6 0E               add     a,14						; Next intended x coordinate
10257  2A80 6F                  ld      l,a
10258  2A81 56                  ld      d,(hl)
10259  2A82             		
10260  2A82             		; Get the fireball's y coordinate + 12
10261  2A82 2C                  inc     l							; Next intended y coordinate
10262  2A83 7E                  ld      a,(hl)
10263  2A84 C6 0C               add     a,12
10264  2A86 5F                  ld      e,a
10265  2A87             		
10266  2A87             		; Convert the fireball coordinate to a screen memory address
10267  2A87 EB                  ex      de,hl
10268  2A88 CD 8E 30            call    L_STAGE_LOC_TO_ADDRESS
10269  2A8B 7E                  ld      a,(hl)
10270  2A8C             		
10271  2A8C             		; If the tile is less than the girder tiles,
10272  2A8C             		; jump ahead to return a as 1
10273  2A8C FE B0               cp      $b0
10274  2A8E 38 08               jr      c,l29ac
10275  2A90             		
10276  2A90             		; If the tile is outside the block of girder tiles,
10277  2A90             		; jump ahead to return a as 1
10278  2A90 E6 0F               and     %00001111
10279  2A92 FE 08               cp      $08
10280  2A94 30 02               jr      nc,l29ac
10281  2A96             		
10282  2A96             		; The tile is a girder tile
10283  2A96             		; Return a as 0
10284  2A96 AF                  xor     a
10285  2A97 C9                  ret     
10286  2A98             
10287  2A98             		; The tile is not a girder
10288  2A98             		; Return a as 1
10289  2A98 3E 01       l29ac:  ld      a,1
10290  2A9A C9                  ret     
10291  2A9B             ;------------------------------------------------------------------------------
10292  2A9B             
10293  2A9B             
10294  2A9B             
10295  2A9B             ;------------------------------------------------------------------------------
10296  2A9B             ; Handle Mario's interaction with the elevators.
10297  2A9B             ; Detect when Mario has landed on an elevator platform and flag him as riding it
10298  2A9B             ; Detect when Mario has struck the bottom of an elevator platform with his head
10299  2A9B             ;	and kill him
10300  2A9B             ; Detect when Mario has hit the side of an elevator? and stop him?
10301  2A9B             ; return:	a - 1 if Mario has interacted with an elevator
10302  2A9B             ;			b - 1 if Mario is riding an elevator?
10303  2A9B             L_INTERACT_WITH_ELEVATORS:  
10304  2A9B             		; Return unless this is the elevators or secret stage
10305  2A9B 3E 14       		ld      a,%00010100
10306  2A9D F7                  rst     $30		
10307  2A9E                     
10308  2A9E             		; If Mario has not collided with an elevator platform,
10309  2A9E             		; jump ahead to return a and b as 0
10310  2A9E FD 21 00 62         ld      iy,MARIO_DATA_STRUCT
10311  2AA2 3A 05 62            ld      a,(MARIO_Y)
10312  2AA5 4F                  ld      c,a
10313  2AA6 21 08 04            ld      hl,TWO_BYTES(4,8)			; 8x16 collision area
10314  2AA9 CD 08 2B            call    L_CHECK_FOR_ELEVATOR_COLLISION
10315  2AAC A7                  and     a
10316  2AAD 28 57               jr      z,l2a20
10317  2AAF             		
10318  2AAF             		; Calculate the index of the elevator Mario has collided with
10319  2AAF 3E 06               ld      a,6
10320  2AB1             		
10321  2AB1             		; If the correct index has been found, jump ahead
10322  2AB1 90                  sub     b
10323  2AB2 28 05       l29c7:  jr      z,l29d0
10324  2AB4             
10325  2AB4             		; Advance to the next elevator index
10326  2AB4 DD 19               add     ix,de
10327  2AB6 3D                  dec     a
10328  2AB7 18 F9               jr      l29c7
10329  2AB9             
10330  2AB9             		; If Mario is not above the top of the elevator platform,
10331  2AB9             		; jump ahead
10332  2AB9             		; (This is a rough and generous collision detection, as the boundaries
10333  2AB9             		; are shifted to make it easier for Mario to get onto the platform)
10334  2AB9 DD 7E 05    l29d0:  ld      a,(ix+5)					; Y coordinate of elevator
10335  2ABC D6 04               sub     4							; Shift the boundary up 4 pixels
10336  2ABE 57                  ld      d,a
10337  2ABF 3A 0C 62            ld      a,($620c)
10338  2AC2 C6 05               add     a,5							; Allow Mario to overlap the elevator by 3 pixels
10339  2AC4 BA                  cp      d
10340  2AC5 30 0E               jr      nc,l29ee
10341  2AC7             		
10342  2AC7             		; Move Mario to stand directly on the platform
10343  2AC7 7A                  ld      a,d
10344  2AC8 D6 08               sub     8
10345  2ACA 32 05 62            ld      (MARIO_Y),a
10346  2ACD             		
10347  2ACD             		; Indicate that Mario is now riding an elevator platform
10348  2ACD 3E 01               ld      a,1
10349  2ACF 47                  ld      b,a
10350  2AD0 32 98 63            ld      (MARIO_ON_ELEVATOR),a
10351  2AD3             		
10352  2AD3             		; Return from the calling function
10353  2AD3 E1                  pop		hl
10354  2AD4 C9                  ret     
10355  2AD5             
10356  2AD5             		; If Mario has struck the bottom of a platform with his head,
10357  2AD5             		; jump ahead to kill him
10358  2AD5 3A 0C 62    l29ee:  ld      a,($620c)
10359  2AD8 D6 0E               sub     14							; Allow some overlap
10360  2ADA BA                  cp      d
10361  2ADB 30 24               jr      nc,l2a1b
10362  2ADD             		
10363  2ADD             		; Detect if Mario has struck the side of an elevator platform
10364  2ADD             		
10365  2ADD             		; If Mario is jumping to the right, jump ahead to handle it
10366  2ADD 3A 10 62            ld      a,(MARIO_JUMPING_LEFT)
10367  2AE0 A7                  and     a
10368  2AE1 3A 03 62            ld      a,(MARIO_X)
10369  2AE4 28 06               jr      z,l2a08
10370  2AE6             		
10371  2AE6             		; Mario is jumping left
10372  2AE6             		; Adjust his x coordinate to stop at the right edge of the platform
10373  2AE6 F6 07               or      %00000111
10374  2AE8 D6 04               sub     4
10375  2AEA             		
10376  2AEA             		; Jump ahead to update Mario's x coordinate
10377  2AEA 18 06               jr      l2a0e
10378  2AEC             		
10379  2AEC             		; Mario is jumping right
10380  2AEC             		; Adjust his x coordinate to stop at the left edge of the platform
10381  2AEC D6 08       l2a08:  sub     8
10382  2AEE F6 07               or      %00000111
10383  2AF0 C6 04               add     a,4
10384  2AF2             		
10385  2AF2             		; Update Mario's x coordinate
10386  2AF2 32 03 62    l2a0e:  ld      (MARIO_X),a
10387  2AF5 32 4C 69            ld      (MARIO_SPRITE_X),a
10388  2AF8                     
10389  2AF8             		; Return a = 1 and b = 0
10390  2AF8 3E 01       		ld      a,1
10391  2AFA 06 00               ld      b,0
10392  2AFC             		
10393  2AFC 32 16 62    		ld		(MARIO_IS_JUMPING),a
10394  2AFF             		
10395  2AFF             		; Return from the calling function
10396  2AFF E1                  pop		hl
10397  2B00 C9                  ret     
10398  2B01             		
10399  2B01             		; Mark Mario as dead and return a and b = 0
10400  2B01 AF          l2a1b:  xor     a
10401  2B02 32 00 62            ld      (MARIO_ALIVE),a
10402  2B05 C9                  ret     
10403  2B06             
10404  2B06             		; Return a and b = 0
10405  2B06 47          l2a20:  ld      b,a
10406  2B07 C9                  ret     
10407  2B08             ;------------------------------------------------------------------------------
10408  2B08             
10409  2B08             
10410  2B08             
10411  2B08             ;------------------------------------------------------------------------------
10412  2B08             ; Check for a collision between Mario and an elevator platform
10413  2B08             ; return: 	a - 1 if a collision has occurred
10414  2B08             L_CHECK_FOR_ELEVATOR_COLLISION:  
10415  2B08 06 06       		ld      b,6								; 6 elevator platforms
10416  2B0A 11 10 00            ld      de,16							; 16 byte data structures
10417  2B0D DD 21 00 66         ld      ix,ELEVATOR_STRUCTS
10418  2B11 CD 0A 2A            call    L_CHECK_FOR_COLLISION
10419  2B14 C9                  ret     
10420  2B15             ;------------------------------------------------------------------------------
10421  2B15             
10422  2B15             
10423  2B15             
10424  2B15             ;------------------------------------------------------------------------------
10425  2B15 DD 7E 03    l2a2f:  ld      a,(ix+3)
10426  2B18 67                  ld      h,a
10427  2B19 DD 7E 05            ld      a,(ix+5)
10428  2B1C C6 04               add     a,$04
10429  2B1E 6F                  ld      l,a
10430  2B1F E5                  push    hl
10431  2B20 CD 8E 30            call    L_STAGE_LOC_TO_ADDRESS
10432  2B23 D1                  pop     de
10433  2B24 7E                  ld      a,(hl)
10434  2B25 FE B0               cp      $b0
10435  2B27 38 2E               jr      c,l2a7b
10436  2B29 E6 0F               and     $0f
10437  2B2B FE 08               cp      $08
10438  2B2D 30 28               jr      nc,l2a7b
10439  2B2F 7E                  ld      a,(hl)
10440  2B30 FE C0               cp      $c0
10441  2B32 28 23               jr      z,l2a7b
10442  2B34 38 11               jr      c,l2a69
10443  2B36 FE D0               cp      $d0
10444  2B38 38 11               jr      c,l2a6e
10445  2B3A FE E0               cp      $e0
10446  2B3C 38 04               jr      c,l2a63
10447  2B3E FE F0               cp      $f0
10448  2B40 38 09               jr      c,l2a6e
10449  2B42 E6 0F       l2a63:  and     $0f
10450  2B44 3D                  dec     a
10451  2B45 18 08               jr      l2a72
10452  2B47 3E FF       l2a69:  ld      a,$ff
10453  2B49 18 04               jr      l2a72
10454  2B4B E6 0F       l2a6e:  and     $0f
10455  2B4D D6 09               sub     $09
10456  2B4F 4F          l2a72:  ld      c,a
10457  2B50 7B                  ld      a,e
10458  2B51 E6 F8               and     $f8
10459  2B53 81                  add     a,c
10460  2B54 BB                  cp      e
10461  2B55 38 02               jr      c,l2a7d
10462  2B57 AF          l2a7b:  xor     a
10463  2B58 C9                  ret     
10464  2B59             
10465  2B59 D6 04       l2a7d:  sub     $04
10466  2B5B DD 77 05            ld      (ix+5),a
10467  2B5E 3E 01               ld      a,$01
10468  2B60 C9                  ret     
10469  2B61             ;------------------------------------------------------------------------------
10470  2B61             
10471  2B61             
10472  2B61             
10473  2B61             ;------------------------------------------------------------------------------
10474  2B61             l2a85:  
10475  2B61 3A 15 62    		ld      a,(MARIO_IS_CLIMBING)
10476  2B64 A7                  and     a
10477  2B65 C0                  ret     nz
10478  2B66             		
10479  2B66 3A 16 62            ld      a,(MARIO_IS_JUMPING)
10480  2B69 A7                  and     a
10481  2B6A C0                  ret     nz
10482  2B6B             		
10483  2B6B 3A 98 63            ld      a,(MARIO_ON_ELEVATOR)
10484  2B6E FE 01               cp      1
10485  2B70 C8                  ret     z
10486  2B71             		
10487  2B71 3A 03 62            ld      a,(MARIO_X)
10488  2B74 D6 03               sub     $03
10489  2B76 67                  ld      h,a
10490  2B77 3A 05 62            ld      a,(MARIO_Y)
10491  2B7A C6 0C               add     a,$0c
10492  2B7C 6F                  ld      l,a
10493  2B7D E5                  push    hl
10494  2B7E CD 8E 30            call    L_STAGE_LOC_TO_ADDRESS
10495  2B81 D1                  pop     de
10496  2B82 7E                  ld      a,(hl)
10497  2B83 FE B0               cp      $b0
10498  2B85 38 07               jr      c,l2ab4
10499  2B87 E6 0F               and     $0f
10500  2B89 FE 08               cp      $08
10501  2B8B 30 01               jr      nc,l2ab4
10502  2B8D C9                  ret    
10503  2B8E             		
10504  2B8E 7A          l2ab4:  ld      a,d
10505  2B8F E6 07               and     $07
10506  2B91 28 11               jr      z,l2acd
10507  2B93 01 20 00            ld      bc,$0020
10508  2B96 ED 42               sbc     hl,bc
10509  2B98 7E                  ld      a,(hl)
10510  2B99 FE B0               cp      $b0
10511  2B9B 38 07               jr      c,l2acd
10512  2B9D E6 0F               and     $0f
10513  2B9F FE 08               cp      $08
10514  2BA1 30 01               jr      nc,l2acd
10515  2BA3 C9                  ret     
10516  2BA4             		
10517  2BA4 3E 01       l2acd:  ld      a,1
10518  2BA6 32 21 62            ld      (MARIO_IS_FALLING),a
10519  2BA9 C9                  ret     
10520  2BAA             ;------------------------------------------------------------------------------
10521  2BAA             
10522  2BAA             
10523  2BAA             ;------------------------------------------------------------------------------
10524  2BAA             ; This function moves Mario along the conveyer belts on the mixer stage
10525  2BAA             L_MOVE_MARIO_ON_CONVEYERS:  
10526  2BAA                     ; If Mario is standing on the left or right conveyer, jump ahead
10527  2BAA 3A 03 62    		ld      a,(MARIO_X)
10528  2BAD 47                  ld      b,a
10529  2BAE 3A 05 62            ld      a,(MARIO_Y)
10530  2BB1 FE 78       		cp      120
10531  2BB3 28 0A               jr      z,l2af6
10532  2BB5                     
10533  2BB5                     ; If Mario is standing on the bottom conveyer, jump ahead
10534  2BB5 FE C8       		cp      $c8
10535  2BB7 28 01               jr      z,l2af0
10536  2BB9 C9                  ret     
10537  2BBA             
10538  2BBA             		; Move Mario along the bottom conveyer
10539  2BBA 3A A6 63    l2af0:  ld      a,(BOT_CONVEYER_DIR)
10540  2BBD 18 0B               jr      l2b02
10541  2BBF                     
10542  2BBF                     ; If Mario is on the right conveyer, move him along it
10543  2BBF 78          l2af6:  ld      a,b
10544  2BC0 FE 80               cp      128
10545  2BC2 3A A5 63            ld      a,(RIGHT_CONVEYER_DIR)
10546  2BC5 30 03               jr      nc,l2b02
10547  2BC7                     
10548  2BC7                     ; If Mario is on the left conveyer, move him along it
10549  2BC7 3A A4 63            ld      a,(LEFT_CONVEYER_DIR)
10550  2BCA                     
10551  2BCA                     ; Move Mario
10552  2BCA 80          l2b02:  add     a,b
10553  2BCB 32 03 62            ld      (MARIO_X),a
10554  2BCE 32 4C 69            ld      (MARIO_SPRITE_X),a
10555  2BD1                     
10556  2BD1                     ; Check if Mario has hit the edge of the screen
10557  2BD1 CD F3 24            call    L_IMPLEMENT_BARRIERS
10558  2BD4                     
10559  2BD4                     ; If Mario has hit the right edge, jump ahead to correct his position
10560  2BD4 21 03 62            ld      hl,MARIO_X
10561  2BD7 1D                  dec     e
10562  2BD8 28 04               jr      z,l2b18
10563  2BDA                     
10564  2BDA                     ; If Mario has hit the left edge, jump ahead to correct his position
10565  2BDA 15                  dec     d
10566  2BDB 28 03               jr      z,l2b1a
10567  2BDD                     
10568  2BDD C9                  ret     
10569  2BDE             		
10570  2BDE             		; Stop Mario from moving into the right edge of the screen
10571  2BDE 35          l2b18:  dec     (hl)
10572  2BDF C9                  ret     
10573  2BE0             
10574  2BE0             		
10575  2BE0             		; Stop Mario from moving into the left edge of the screen
10576  2BE0 34          l2b1a:  inc     (hl)
10577  2BE1 C9                  ret     
10578  2BE2             ;------------------------------------------------------------------------------
10579  2BE2             
10580  2BE2             
10581  2BE2             
10582  2BE2             ;------------------------------------------------------------------------------
10583  2BE2             l2b1c:  
10584  2BE2 DD 21 00 62 		ld      ix,MARIO_DATA_STRUCT
10585  2BE6 CD EF 2B            call    l2b29
10586  2BE9 CD 9B 2A            call    L_INTERACT_WITH_ELEVATORS
10587  2BEC AF                  xor     a
10588  2BED 47                  ld      b,a
10589  2BEE C9                  ret     
10590  2BEF             ;------------------------------------------------------------------------------
10591  2BEF             
10592  2BEF             
10593  2BEF             
10594  2BEF             ;------------------------------------------------------------------------------
10595  2BEF             ; passed:	ix - MARIO_DATA_STRUCT
10596  2BEF             l2b29:  
10597  2BEF             		; If the current stage is not barrels, 
10598  2BEF             		; jump ahead
10599  2BEF 3A 27 62    		ld      a,(CURRENT_STAGE)
10600  2BF2 3D                  dec     a
10601  2BF3 20 21               jr      nz,l2b53
10602  2BF5                     
10603  2BF5                     ; Save Mario's coordinate to hl
10604  2BF5                     ; (Y coordinate + 7)
10605  2BF5 3A 03 62            ld      a,(MARIO_X)
10606  2BF8 67                  ld      h,a
10607  2BF9 3A 05 62            ld      a,(MARIO_Y)
10608  2BFC C6 07               add     a,7
10609  2BFE 6F                  ld      l,a
10610  2BFF                     
10611  2BFF CD 5A 2C            call    l2b9b
10612  2C02                     
10613  2C02                     ; If a is 0, jump ahead
10614  2C02 A7                  and     a
10615  2C03 28 0F               jr      z,l2b51
10616  2C05                     
10617  2C05                     
10618  2C05 7B                  ld      a,e
10619  2C06 91                  sub     c
10620  2C07 FE 04               cp      4
10621  2C09 30 2A               jr      nc,l2b74
10622  2C0B                     
10623  2C0B 79                  ld      a,c
10624  2C0C D6 07               sub     $07
10625  2C0E 32 05 62            ld      (MARIO_Y),a
10626  2C11 3E 01               ld      a,$01
10627  2C13 47                  ld      b,a
10628  2C14 E1          l2b51:  pop     hl
10629  2C15 C9                  ret     
10630  2C16             		
10631  2C16 3A 03 62    l2b53:  ld      a,(MARIO_X)
10632  2C19 D6 03               sub     $03
10633  2C1B 67                  ld      h,a
10634  2C1C 3A 05 62            ld      a,(MARIO_Y)
10635  2C1F C6 07               add     a,$07
10636  2C21 6F                  ld      l,a
10637  2C22 CD 5A 2C            call    l2b9b
10638  2C25 FE 02               cp      2
10639  2C27 28 12               jr      z,l2b7a
10640  2C29 7A                  ld      a,d
10641  2C2A C6 07               add     a,%00000111
10642  2C2C 67                  ld      h,a
10643  2C2D 6B                  ld      l,e
10644  2C2E CD 5A 2C            call    l2b9b
10645  2C31 A7                  and     a
10646  2C32 C8                  ret     z
10647  2C33             		
10648  2C33 18 06               jr      l2b7a
10649  2C35 3E 00       l2b74:  ld      a,$00
10650  2C37 06 00               ld      b,$00
10651  2C39 E1                  pop     hl
10652  2C3A C9                  ret     
10653  2C3B             		
10654  2C3B 3A 10 62    l2b7a:  ld      a,(MARIO_JUMPING_LEFT)
10655  2C3E A7                  and     a
10656  2C3F 3A 03 62            ld      a,(MARIO_X)
10657  2C42 28 06               jr      z,l2b8b
10658  2C44 F6 07               or      $07
10659  2C46 D6 04               sub     $04
10660  2C48 18 06               jr      l2b91
10661  2C4A D6 08       l2b8b:  sub     $08
10662  2C4C F6 07               or      $07
10663  2C4E C6 04               add     a,$04
10664  2C50 32 03 62    l2b91:  ld      (MARIO_X),a
10665  2C53 32 4C 69            ld      (MARIO_SPRITE_X),a
10666  2C56 3E 01               ld      a,$01
10667  2C58 E1                  pop     hl
10668  2C59 C9                  ret     
10669  2C5A             ;------------------------------------------------------------------------------
10670  2C5A             
10671  2C5A             
10672  2C5A             
10673  2C5A             ;------------------------------------------------------------------------------
10674  2C5A             ; passed:	hl - x,y coordinate
10675  2C5A             ;			ix - 
10676  2C5A             ; return:	a - 
10677  2C5A             ;			b -
10678  2C5A             ;			c - The y coordinate of the top of the supporting tile surface
10679  2C5A             ;			de - the original x,y coordinate
10680  2C5A             l2b9b:  
10681  2C5A E5          		push    hl
10682  2C5B             		
10683  2C5B             		; Convert the x,y coordinate to a screen tile memory address
10684  2C5B CD 8E 30            call    L_STAGE_LOC_TO_ADDRESS
10685  2C5E                     
10686  2C5E D1                  pop     de
10687  2C5F                     
10688  2C5F                     ; Get the tile at the coordinate passed in
10689  2C5F 7E                  ld      a,(hl)
10690  2C60                     
10691  2C60                     ; If the tile cannot support weight,
10692  2C60                     ; jump ahead
10693  2C60 FE B0               cp      $b0
10694  2C62 38 2B               jr      c,l2bd9
10695  2C64 E6 0F               and     %00001111
10696  2C66 FE 08               cp      8
10697  2C68 30 25               jr      nc,l2bd9
10698  2C6A                 
10699  2C6A                         
10700  2C6A                     ; If the tile is the ladder tile,
10701  2C6A                     ; jump ahead
10702  2C6A 7E                  ld      a,(hl)
10703  2C6B FE C0               cp      $c0
10704  2C6D 28 20               jr      z,l2bd9
10705  2C6F                     
10706  2C6F                     ; If the tile is less than the ladder tile, 
10707  2C6F                     ; jump ahead
10708  2C6F 38 21               jr      c,l2bdc
10709  2C71                     
10710  2C71                     ; If the tile is one of the upper porion barrel girders with ladders, 
10711  2C71                     ; jump ahead
10712  2C71 FE D0               cp      $d0
10713  2C73 38 0D               jr      c,l2bcb
10714  2C75                     
10715  2C75                     ; If the tile is one of the barrel girders with a ladder,
10716  2C75                     ; jump ahead
10717  2C75 FE E0               cp      $e0
10718  2C77 38 04               jr      c,l2bc5
10719  2C79                     
10720  2C79                     ; If the tile is one of the upper porion barrel girders, 
10721  2C79                     ; jump ahead
10722  2C79 FE F0               cp      $f0
10723  2C7B 38 05               jr      c,l2bcb
10724  2C7D                     
10725  2C7D                     ; The tile is one of the lower barrel girders
10726  2C7D                     
10727  2C7D                     ; Isolate the offset of the girder
10728  2C7D E6 0F       l2bc5:  and     %00001111
10729  2C7F 3D                  dec     a
10730  2C80 18 04               jr      l2bcf
10731  2C82                     
10732  2C82                     ; Isolate the offset of the girder - 9
10733  2C82 E6 0F       l2bcb:  and     %00001111
10734  2C84 D6 09               sub     9
10735  2C86             
10736  2C86 4F          l2bcf:  ld      c,a
10737  2C87                     
10738  2C87                     ; Round the y coordinate to the nearest tile boundary
10739  2C87 7B                  ld      a,e
10740  2C88 E6 F8               and     %11111000
10741  2C8A                     
10742  2C8A                     ; Add the tile offset
10743  2C8A 81                  add     a,c
10744  2C8B 4F                  ld      c,a
10745  2C8C                     
10746  2C8C                     ; If the original y coordinate is below the top of the girder,
10747  2C8C                     ; jump ahead
10748  2C8C BB                  cp      e
10749  2C8D 38 08               jr      c,l2be1
10750  2C8F                     
10751  2C8F                     ; Report that there is no supporting surface?
10752  2C8F AF          l2bd9:  xor     a
10753  2C90 47                  ld      b,a
10754  2C91 C9                  ret     
10755  2C92             		
10756  2C92             		; Round the y coordinate to the nearest tile boundary - 1
10757  2C92 7B          l2bdc:  ld      a,e
10758  2C93 E6 F8               and     %11111000
10759  2C95 3D                  dec     a
10760  2C96 4F                  ld      c,a
10761  2C97                     
10762  2C97 3A 0C 62    l2be1:  ld      a,($620c)
10763  2C9A DD 96 05            sub     (ix+5)							; Y coordinate
10764  2C9D 83                  add     a,e
10765  2C9E B9                  cp      c
10766  2C9F 28 02               jr      z,l2bef
10767  2CA1 30 08               jr      nc,l2bf8
10768  2CA3 79          l2bef:  ld      a,c
10769  2CA4 D6 07               sub     7
10770  2CA6 32 05 62            ld      (MARIO_Y),a
10771  2CA9 18 05               jr      l2bfd
10772  2CAB                     
10773  2CAB 3E 02       l2bf8:  ld      a,2
10774  2CAD 06 00               ld      b,0
10775  2CAF C9                  ret     
10776  2CB0             		
10777  2CB0 3E 01       l2bfd:  ld      a,$01
10778  2CB2 47                  ld      b,a
10779  2CB3 E1                  pop     hl
10780  2CB4 E1                  pop     hl
10781  2CB5 C9                  ret     
10782  2CB6             ;------------------------------------------------------------------------------
10783  2CB6             
10784  2CB6             
10785  2CB6             
10786  2CB6             ;------------------------------------------------------------------------------
10787  2CB6             l2c03:  
10788  2CB6             		; Return unless this is the barrels stage
10789  2CB6 3E 01       		ld      a,%00000001
10790  2CB8 F7                  rst     $30							
10791  2CB9                     
10792  2CB9             		; Return if Mario is dead
10793  2CB9 D7                  rst     $10
10794  2CBA             		
10795  2CBA             		; If Donkey Kong is stomping,
10796  2CBA             		; return
10797  2CBA 3A 93 63            ld      a,(DK_STOMPING)
10798  2CBD 0F                  rrca    
10799  2CBE D8                  ret     c
10800  2CBF             		
10801  2CBF 3A B1 62            ld      a,($62b1)
10802  2CC2 A7                  and     a
10803  2CC3 C8                  ret     z
10804  2CC4             		
10805  2CC4 4F                  ld      c,a
10806  2CC5 3A B0 62            ld      a,(INTERNAL_TIMER)
10807  2CC8 D6 02               sub     2
10808  2CCA B9                  cp      c
10809  2CCB 38 5B               jr      c,l2c7b
10810  2CCD 3A 82 63            ld      a,($6382)
10811  2CD0 CB 4F               bit     1,a
10812  2CD2 20 5D               jr      nz,l2c86
10813  2CD4 3A 80 63            ld      a,(CP_DIFFICULTY)
10814  2CD7 47                  ld      b,a
10815  2CD8 3A 1A 60            ld      a,(COUNTER_2)
10816  2CDB E6 1F               and     %00011111
10817  2CDD B8          l2c2c:  cp      b
10818  2CDE 28 03               jr      z,l2c33
10819  2CE0 10 FB               djnz    l2c2c
10820  2CE2 C9                  ret     
10821  2CE3             		
10822  2CE3 3A B0 62    l2c33:  ld      a,(INTERNAL_TIMER)
10823  2CE6 CB 3F               srl     a
10824  2CE8 B9                  cp      c
10825  2CE9 38 05               jr      c,l2c41
10826  2CEB 3A 19 60            ld      a,(COUNTER_1)
10827  2CEE 0F                  rrca    
10828  2CEF D0                  ret     nc
10829  2CF0             		
10830  2CF0 CD 57 00    l2c41:  call    L_UPDATE_RAND_NUM
10831  2CF3 E6 0F               and     %00001111
10832  2CF5 20 3A               jr      nz,l2c86
10833  2CF7 3E 01       l2c49:  ld      a,1
10834  2CF9 32 82 63    l2c4b:  ld      ($6382),a
10835  2CFC 3C                  inc     a
10836  2CFD 32 8F 63    l2c4f:  ld      ($638f),a
10837  2D00 3E 01               ld      a,1
10838  2D02 32 92 63            ld      ($6392),a
10839  2D05 3A B2 62            ld      a,($62b2)
10840  2D08 B9                  cp      c
10841  2D09 C0                  ret     nz
10842  2D0A             		
10843  2D0A D6 08               sub     8
10844  2D0C 32 B2 62            ld      ($62b2),a
10845  2D0F 11 20 00            ld      de,32
10846  2D12 21 00 64            ld      hl,FIREBALL_STRUCTS
10847  2D15 06 05               ld      b,5
10848  2D17 7E          l2c69:  ld      a,(hl)
10849  2D18 A7                  and     a
10850  2D19 28 04               jr      z,l2c72
10851  2D1B 19                  add     hl,de
10852  2D1C 10 F9               djnz    l2c69
10853  2D1E C9                  ret    
10854  2D1F             		
10855  2D1F 3A 82 63    l2c72:  ld      a,($6382)
10856  2D22 F6 80               or      %10000000
10857  2D24 32 82 63            ld      ($6382),a
10858  2D27 C9                  ret     
10859  2D28             ;------------------------------------------------------------------------------
10860  2D28             
10861  2D28             
10862  2D28             
10863  2D28             ;------------------------------------------------------------------------------
10864  2D28             ; passed:	a - 
10865  2D28             ;			c - 
10866  2D28 C6 02       l2c7b:  add     a,2
10867  2D2A B9                  cp      c
10868  2D2B 28 CA               jr      z,l2c49
10869  2D2D                     
10870  2D2D 3E 02               ld      a,$02
10871  2D2F 18 C8               jr      l2c4b
10872  2D31 AF          l2c86:  xor     a
10873  2D32 32 82 63            ld      ($6382),a
10874  2D35 3E 03               ld      a,$03
10875  2D37 18 C4               jr      l2c4f
10876  2D39             		
10877  2D39             		; Return unless this is the barrels stage
10878  2D39 3E 01       l2c8f:  ld      a,%00000001
10879  2D3B F7                  rst     $30							
10880  2D3C                     ; Return if Mario is dead
10881  2D3C D7                  rst     $10
10882  2D3D 3A 93 63            ld      a,(DK_STOMPING)
10883  2D40 0F                  rrca    
10884  2D41 38 76               jr      c,l2d15
10885  2D43 3A 92 63            ld      a,($6392)
10886  2D46 0F                  rrca    
10887  2D47 D0                  ret     nc
10888  2D48             		
10889  2D48 DD 21 00 67         ld      ix,BARREL_STRUCTS
10890  2D4C 11 20 00            ld      de,32
10891  2D4F 06 0A               ld      b,10
10892  2D51 DD 7E 00    l2ca8:  ld      a,(ix+0)
10893  2D54 0F                  rrca    
10894  2D55 38 03               jr      c,l2cb3
10895  2D57 0F                  rrca    
10896  2D58 30 05               jr      nc,l2cb8
10897  2D5A DD 19       l2cb3:  add     ix,de
10898  2D5C 10 F3               djnz    l2ca8
10899  2D5E C9                  ret     
10900  2D5F             		
10901  2D5F DD 22 AA 62 l2cb8:  ld      ($62aa),ix
10902  2D63 DD 36 00 02         ld      (ix+0),$02
10903  2D67 16 00               ld      d,$00
10904  2D69 3E 0A               ld      a,$0a
10905  2D6B 90                  sub     b
10906  2D6C 87                  add     a,a
10907  2D6D 87                  add     a,a
10908  2D6E 5F                  ld      e,a
10909  2D6F 21 80 69            ld      hl,SPRING_SPRITES
10910  2D72 19                  add     hl,de
10911  2D73 22 AC 62            ld      ($62ac),hl
10912  2D76 3E 01               ld      a,1
10913  2D78 32 93 63            ld      (DK_STOMPING),a
10914  2D7B 11 01 05            ld      de,$0501
10915  2D7E CD 36 31            call    L_ADD_EVENT
10916  2D81 21 B1 62            ld      hl,$62b1
10917  2D84 35                  dec     (hl)
10918  2D85 20 05               jr      nz,l2ce6
10919  2D87 3E 01               ld      a,$01
10920  2D89 32 86 63            ld      ($6386),a
10921  2D8C 7E          l2ce6:  ld      a,(hl)
10922  2D8D FE 04               cp      $04
10923  2D8F 30 0A               jr      nc,l2cf6
10924  2D91 21 A8 69            ld      hl,STANDING_BARREL_SPRITE_DATA
10925  2D94 87                  add     a,a
10926  2D95 87                  add     a,a
10927  2D96 5F                  ld      e,a
10928  2D97 16 00               ld      d,$00
10929  2D99 19                  add     hl,de
10930  2D9A 72                  ld      (hl),d
10931  2D9B DD 36 07 15 l2cf6:  ld      (ix+7),$15
10932  2D9F DD 36 08 0B         ld      (ix+8),$0b
10933  2DA3 DD 36 15 00         ld      (ix+21),$00
10934  2DA7 3A 82 63            ld      a,($6382)
10935  2DAA 07                  rlca    
10936  2DAB 30 0C               jr      nc,l2d15
10937  2DAD DD 36 07 19         ld      (ix+7),$19
10938  2DB1 DD 36 08 0C         ld      (ix+8),$0c
10939  2DB5 DD 36 15 01         ld      (ix+21),$01
10940  2DB9 21 AF 62    l2d15:  ld      hl,DK_CLIMBING_COUNTER
10941  2DBC 35                  dec     (hl)
10942  2DBD C0                  ret     nz
10943  2DBE             		
10944  2DBE 36 18               ld      (hl),$18
10945  2DC0 3A 8F 63            ld      a,($638f)
10946  2DC3 A7                  and     a
10947  2DC4 28 3C               jr      z,l2d51
10948  2DC6 4F                  ld      c,a
10949  2DC7 21 43 39            ld      hl,L_DK_SPRITES_THROW_BARREL
10950  2DCA 3A 82 63            ld      a,($6382)
10951  2DCD 0F                  rrca    
10952  2DCE 38 01               jr      c,l2d2f
10953  2DD0 0D                  dec     c
10954  2DD1 79          l2d2f:  ld      a,c
10955  2DD2 87                  add     a,a
10956  2DD3 87                  add     a,a
10957  2DD4 87                  add     a,a
10958  2DD5 4F                  ld      c,a
10959  2DD6 87                  add     a,a
10960  2DD7 87                  add     a,a
10961  2DD8 81                  add     a,c
10962  2DD9 5F                  ld      e,a
10963  2DDA 16 00               ld      d,$00
10964  2DDC 19                  add     hl,de
10965  2DDD D5          		push	de
10966  2DDE CD 4E 00            call    L_LOAD_DK_SPRITES
10967  2DE1             
10968  2DE1             		; Move the collision area to match Donkey Kong's position
10969  2DE1 D1          		pop	de
10970  2DE2 7B          		ld	a,e
10971  2DE3 FE 00       		cp	0
10972  2DE5 3E 56       		ld	a,K_COLLISION_X_BARRELS+16
10973  2DE7 28 02       		jr	z,l2d2f_1
10974  2DE9 3E 46       		ld	a,K_COLLISION_X_BARRELS
10975  2DEB             
10976  2DEB             l2d2f_1:
10977  2DEB 32 A3 64    		ld	(COLLISION_AREA_STRUCT_1+3),a
10978  2DEE 32 50 69    		ld	(COLLISION_AREA_SPRITE_1),a
10979  2DF1 21 8F 63            ld      hl,$638f
10980  2DF4 35                  dec     (hl)
10981  2DF5 20 0B               jr      nz,l2d51
10982  2DF7 3E 01               ld      a,1
10983  2DF9 32 AF 62            ld      (DK_CLIMBING_COUNTER),a
10984  2DFC 3A 82 63            ld      a,($6382)
10985  2DFF 0F                  rrca    
10986  2E00 38 30               jr      c,l2d83
10987  2E02 2A A8 62    l2d51:  ld      hl,($62a8)
10988  2E05 7E          l2d54:  ld      a,(hl)
10989  2E06 DD 2A AA 62         ld      ix,($62aa)
10990  2E0A ED 5B AC 62         ld      de,($62ac)
10991  2E0E FE 7F               cp      $7f
10992  2E10 28 28               jr      z,l2d8c
10993  2E12 4F                  ld      c,a
10994  2E13 E6 7F               and     $7f
10995  2E15 12                  ld      (de),a
10996  2E16 DD 7E 07            ld      a,(ix+7)
10997  2E19 CB 79               bit     7,c
10998  2E1B 28 02               jr      z,l2d70
10999  2E1D EE 03               xor     $03
11000  2E1F 13          l2d70:  inc     de
11001  2E20 12                  ld      (de),a
11002  2E21 DD 77 07            ld      (ix+7),a
11003  2E24 DD 7E 08            ld      a,(ix+8)
11004  2E27 13                  inc     de
11005  2E28 12                  ld      (de),a
11006  2E29 23                  inc     hl
11007  2E2A 7E                  ld      a,(hl)
11008  2E2B 13                  inc     de
11009  2E2C 12                  ld      (de),a
11010  2E2D 23                  inc     hl
11011  2E2E 22 A8 62            ld      ($62a8),hl
11012  2E31 C9                  ret     
11013  2E32             		
11014  2E32 21 DD 39    l2d83:  ld      hl,l39cc
11015  2E35 22 A8 62            ld      ($62a8),hl
11016  2E38 18 CB               jr      l2d54
11017  2E3A 21 D4 39    l2d8c:  ld      hl,l39c3
11018  2E3D 22 A8 62            ld      ($62a8),hl
11019  2E40 DD 36 01 01         ld      (ix+1),$01
11020  2E44 3A 82 63            ld      a,($6382)
11021  2E47 0F                  rrca    
11022  2E48 38 08               jr      c,l2da5
11023  2E4A DD 36 01 00         ld      (ix+1),$00
11024  2E4E DD 36 02 02         ld      (ix+2),$02
11025  2E52 DD 36 00 01 l2da5:  ld      (ix+0),$01
11026  2E56 DD 36 0F 01         ld      (ix+15),$01
11027  2E5A AF                  xor     a
11028  2E5B DD 77 10            ld      (ix+16),a
11029  2E5E DD 77 11            ld      (ix+17),a
11030  2E61 DD 77 12            ld      (ix+18),a
11031  2E64 DD 77 13            ld      (ix+19),a
11032  2E67 DD 77 14            ld      (ix+20),a
11033  2E6A 32 93 63            ld      (DK_STOMPING),a
11034  2E6D 32 92 63            ld      ($6392),a
11035  2E70 1A                  ld      a,(de)
11036  2E71 DD 77 03            ld      (ix+3),a
11037  2E74 13                  inc     de
11038  2E75 13                  inc     de
11039  2E76 13                  inc     de
11040  2E77 1A                  ld      a,(de)
11041  2E78 DD 77 05            ld      (ix+5),a
11042  2E7B 21 6D 38            ld      hl,L_DK_SPRITES_L_ARM_RAISED
11043  2E7E CD 4E 00            call    L_LOAD_DK_SPRITES
11044  2E81             		
11045  2E81 21 0B 69            ld      hl,DK_SPRITE_1_Y
11046  2E84 0E FC               ld      c,$fc
11047  2E86 FF                  rst     $38
11048  2E87             		
11049  2E87             		; Move the collision area to match Donkey Kong's new
11050  2E87             		; position
11051  2E87 3E 46       		ld		a,K_COLLISION_X_BARRELS
11052  2E89 32 A3 64    		ld		(COLLISION_AREA_STRUCT_1+3),a
11053  2E8C 32 50 69    		ld		(COLLISION_AREA_SPRITE_1),a
11054  2E8F             
11055  2E8F C9                  ret     
11056  2E90             ;------------------------------------------------------------------------------
11057  2E90             
11058  2E90             
11059  2E90             
11060  2E90             ;------------------------------------------------------------------------------
11061  2E90             ; This function causes a fireball or firefox to randomly be released 
11062  2E90             ; on the mixer or rivets stage
11063  2E90             L_RANDOMLY_RELEASE_FIREBALL:  
11064  2E90             		; Return unless this is the mixer stage or rivets stage
11065  2E90 3E 0A       		ld      a,%00001010
11066  2E92 F7                  rst     $30		
11067  2E93             
11068  2E93             		; Return if Mario is dead
11069  2E93 D7                  rst     $10
11070  2E94             		
11071  2E94             		; Calculate the modified difficulty 
11072  2E94             		; by incrementing the current difficulty and multiplying by 2
11073  2E94 3A 80 63            ld      a,(CP_DIFFICULTY)
11074  2E97 3C                  inc     a
11075  2E98 A7                  and     a
11076  2E99 1F                  rra     
11077  2E9A 47                  ld      b,a
11078  2E9B             		
11079  2E9B             		; Increment the modified difficulty by one 
11080  2E9B             		; if this is the mixer stage
11081  2E9B 3A 27 62            ld      a,(CURRENT_STAGE)
11082  2E9E FE 02               cp      2
11083  2EA0 20 01               jr      nz,l2dee		
11084  2EA2 04                  inc     b  							; ++b if this is the mixer stage
11085  2EA3             
11086  2EA3             		; For b = modified difficulty to 1
11087  2EA3             		; Convert the modified difficulty into a random bit mask
11088  2EA3             		; The bit mask makes it more likely that a fireball is released
11089  2EA3             		; on higher difficulty settings
11090  2EA3 3E FE       l2dee:  ld      a,254
11091  2EA5 37                  scf        							; Set the carry flag
11092  2EA6             		
11093  2EA6 1F          l2df1:  rra     
11094  2EA7 A7                  and     a							; Clear the carry flag
11095  2EA8 10 FC               djnz    l2df1						; Next b
11096  2EAA             
11097  2EAA             		; Use the random bit mask to randomly release a fireball
11098  2EAA             		; Return if a fireball should not be released
11099  2EAA 47                  ld      b,a
11100  2EAB 3A 1A 60            ld      a,(COUNTER_2)
11101  2EAE A0                  and     b
11102  2EAF C0                  ret     nz
11103  2EB0             		
11104  2EB0             		; Trigger a fireball to be released
11105  2EB0 3E 01               ld      a,1
11106  2EB2 32 A0 63            ld      (RELEASE_A_FIREBALL),a
11107  2EB5 32 9A 63            ld      ($639a),a
11108  2EB8 C9                  ret     
11109  2EB9             ;------------------------------------------------------------------------------
11110  2EB9             
11111  2EB9             
11112  2EB9             
11113  2EB9             ;------------------------------------------------------------------------------
11114  2EB9             ; Process the springs on the elevators level
11115  2EB9             ; This function spawns new springs, makes them bounce, and then causes them to 
11116  2EB9             ; fall when they reach the gap in the top platform
11117  2EB9             L_IMPLEMENT_SPRINGS:  
11118  2EB9             		; Return unless this is the elevators stage
11119  2EB9 3E 04       		ld      a,%00000100
11120  2EBB F7                  rst     $30	
11121  2EBC                     						
11122  2EBC                     ; Return if Mario is dead
11123  2EBC D7                  rst     $10
11124  2EBD                     
11125  2EBD DD 21 00 65         ld      ix,SPRING_STRUCTS			; ix points to the first spring data structure
11126  2EC1 FD 21 80 69         ld      iy,SPRING_SPRITES			; iy points to the first spring sprite?
11127  2EC5 06 0A               ld      b,10						; For b = 10 to 1 (10 springs)
11128  2EC7             
11129  2EC7             		; If this spring is not active, jump ahead to process the next spring
11130  2EC7 DD 7E 00    l2e12:  ld      a,(ix+0)					
11131  2ECA 0F                  rrca    
11132  2ECB D2 54 2F            jp      nc,l2ea7					; If the spring is inactive, don't process it
11133  2ECE             
11134  2ECE 3A 1A 60            ld      a,(COUNTER_2)
11135  2ED1 E6 0F               and     %00001111
11136  2ED3 20 08               jr      nz,l2e29
11137  2ED5             
11138  2ED5 FD 7E 01            ld      a,(iy+1)					; Swap between extended and compressed sprites every 16 counter cycles
11139  2ED8 EE 07               xor     %00000111
11140  2EDA FD 77 01            ld      (iy+1),a
11141  2EDD             
11142  2EDD             		; If the spring is falling, jump ahead to skip the bounce logic
11143  2EDD DD 7E 0D    l2e29:  ld      a,(ix+13)					; Spring state
11144  2EE0 FE 04               cp      4
11145  2EE2 28 50               jr      z,l2e84						; If the spring is falling, skip bounce processing
11146  2EE4             
11147  2EE4             		; Move the spring two pixels right
11148  2EE4 DD 34 03            inc     (ix+3)						; X coordinate
11149  2EE7 DD 34 03            inc     (ix+3)							
11150  2EEA             
11151  2EEA             		; Get the next bounce vector
11152  2EEA DD 6E 0E            ld      l,(ix+14)					; hl = address of next bounce vector
11153  2EED DD 66 0F            ld      h,(ix+15)
11154  2EF0 7E                  ld      a,(hl)						; a = next bounce vector
11155  2EF1 4F                  ld      c,a							; c = next bounce vector as well
11156  2EF2                     
11157  2EF2                     ; If this is the end of the vecor data, jump ahead
11158  2EF2                     ; to process the end of the bounce
11159  2EF2 FE 7F               cp      $7f
11160  2EF4 28 54               jr      z,l2e9c						; If the end of the bounce sequence has been reached, restart the sequence
11161  2EF6             		
11162  2EF6             		; Advance to next bounce vector
11163  2EF6 23                  inc     hl				
11164  2EF7                     					
11165  2EF7             		; Move the spring up or down by the vector
11166  2EF7 DD 86 05            add     a,(ix+5)
11167  2EFA DD 77 05            ld      (ix+5),a
11168  2EFD             
11169  2EFD             		; Resave the address of the next bounce vector
11170  2EFD DD 75 0E    l2e4b:  ld      (ix+14),l
11171  2F00 DD 74 0F            ld      (ix+15),h
11172  2F03             		
11173  2F03             		; If the spring has not reached the gap in the platform,
11174  2F03             		; jump ahead to skip the falling logic
11175  2F03 DD 7E 03            ld      a,(ix+3)					; X coordinate
11176  2F06 FE B7               cp      183
11177  2F08 38 12               jr      c,l2e6c						; If the spring has not reached the gap, simply update the sprite position
11178  2F0A             
11179  2F0A                     ; If the end of the bounce has not been reached,
11180  2F0A                     ; jump ahead to skip the falling logic
11181  2F0A 79                  ld      a,c
11182  2F0B FE 7F               cp      $7f
11183  2F0D 20 0D               jr      nz,l2e6c	
11184  2F0F                     
11185  2F0F                     ; Trigger the spring's falling state
11186  2F0F DD 36 0D 04         ld      (ix+13),4					; Enter the falling state
11187  2F13             		
11188  2F13             		; Turn off spring bounce sound
11189  2F13 AF                  xor     a
11190  2F14 32 83 60            ld      (SPRING_SOUND_TRIGGER),a
11191  2F17             		
11192  2F17             		; Trigger the falling sound
11193  2F17 3E 03               ld      a,3
11194  2F19 32 84 60            ld      (FALL_SOUND_TRIGGER),a
11195  2F1C             		
11196  2F1C             		; Move the sprite to the new coordinate
11197  2F1C DD 7E 03    l2e6c:  ld      a,(ix+3)					; Data structure x coordinate				
11198  2F1F FD 77 00            ld      (iy+0),a					; Sprite x coordinate
11199  2F22 DD 7E 05            ld      a,(ix+5)					; Data structure y coordinate
11200  2F25 FD 77 03            ld      (iy+3),a					; Sprite y coordinate
11201  2F28             
11202  2F28             		; Advance to the next spring structure
11203  2F28 11 10 00    l2e78:  ld      de,16
11204  2F2B DD 19               add     ix,de	
11205  2F2D                     
11206  2F2D             		; Advance to the next spring sprite							
11207  2F2D 1E 04               ld      e,4
11208  2F2F FD 19               add     iy,de	
11209  2F31                     
11210  2F31                     ; Process the next spring
11211  2F31 10 94               djnz    l2e12						; Next b
11212  2F33 C9                  ret     
11213  2F34             		
11214  2F34             		; Move the spring 3 pixels down
11215  2F34 3E 03       l2e84:  ld      a,3
11216  2F36 DD 86 05            add     a,(ix+5)					; y coordinate
11217  2F39 DD 77 05            ld      (ix+5),a
11218  2F3C             
11219  2F3C             		; If the spring has not reached the bottom of the screen, jump back up
11220  2F3C             		; to update the sprite position
11221  2F3C FE F8               cp      248
11222  2F3E 38 DC               jr      c,l2e6c
11223  2F40             
11224  2F40             		; Inactivate the spring
11225  2F40 DD 36 03 00         ld      (ix+3),0					; x coordinate
11226  2F44 DD 36 00 00         ld      (ix+0),0					; Sprite inactive
11227  2F48                     
11228  2F48                     ; Jump back up to update the sprite posituon
11229  2F48 18 D2               jr      l2e6c
11230  2F4A             		
11231  2F4A             		; Restart the bounce sequence
11232  2F4A 21 BB 39    l2e9c:  ld      hl,L_SPRING_VECTOR_DATA	
11233  2F4D             
11234  2F4D             		; Play the spring bounce sound					
11235  2F4D 3E 03               ld      a,3
11236  2F4F 32 83 60            ld      (SPRING_SOUND_TRIGGER),a
11237  2F52                     
11238  2F52                     ; Jump back up to continue processing the bounce logic
11239  2F52 18 A9               jr      l2e4b						; Continue the bounce sequence processing
11240  2F54             		
11241  2F54             		; If it is not time to release a spring, 
11242  2F54             		; jump back up to process the next spring
11243  2F54 3A 96 63    l2ea7:  ld      a,(RELEASE_SPRING)
11244  2F57 0F                  rrca    
11245  2F58 30 CE               jr      nc,l2e78								
11246  2F5A             
11247  2F5A             		; Release a new spring
11248  2F5A AF                  xor     a
11249  2F5B 32 96 63            ld      (RELEASE_SPRING),a			; Reset the release spring flag
11250  2F5E DD 36 05 50         ld      (ix+5),80					; Y coordinate
11251  2F62 DD 36 0D 01         ld      (ix+13),1					; Spring state = bouncing
11252  2F66             
11253  2F66             		; Get a random number between -8 and 7
11254  2F66 CD 57 00            call    L_UPDATE_RAND_NUM
11255  2F69 E6 0F               and     %00001111
11256  2F6B C6 F8               add     a,-8
11257  2F6D             
11258  2F6D             		; Initialize spring
11259  2F6D DD 77 03            ld      (ix+3),a					; Spring x coord = -8 to 7
11260  2F70 DD 36 00 01         ld      (ix+0),1					; Activate spring
11261  2F74 21 BB 39            ld      hl,L_SPRING_VECTOR_DATA		; Point to start of bounce vector data
11262  2F77 DD 75 0E            ld      (ix+14),l
11263  2F7A DD 74 0F            ld      (ix+15),h
11264  2F7D                     
11265  2F7D                     ; Jump back up to process the next spring
11266  2F7D 18 A9               jr      l2e78						; Process next spring
11267  2F7F             ;------------------------------------------------------------------------------
11268  2F7F             		
11269  2F7F             
11270  2F7F             
11271  2F7F             ;------------------------------------------------------------------------------
11272  2F7F             ; This function animates the hammer cycle if it is active.
11273  2F7F             ; This involves:
11274  2F7F             ;	Displaying the hammer in Mario's hands when he first grabs it
11275  2F7F             ; 	Animating the up/down pounding of the hammer when Mario reaches the ground
11276  2F7F             ;	Playing the hammer time song
11277  2F7F             ;	Alternating the hammer color when time is running out
11278  2F7F             ;	Deactivating the hammer when the cycle is over
11279  2F7F             L_ANIMATE_HAMMER_CYCLE:  
11280  2F7F                     ; Return if Mario is dead
11281  2F7F D7                  rst     $10
11282  2F80             
11283  2F80                     ; Determine which hammer is being held
11284  2F80 11 18 6A            ld      de,HAMMER_SPRITE_1			
11285  2F83 DD 21 80 66         ld      ix,HAMMER_STRUCT_1
11286  2F87 DD 7E 01            ld      a,(ix+1)					; Mario has hammer
11287  2F8A 0F                  rrca    
11288  2F8B 38 07               jr      c,l2eed
11289  2F8D 11 1C 6A            ld      de,HAMMER_SPRITE_2
11290  2F90 DD 21 90 66         ld      ix,HAMMER_STRUCT_2
11291  2F94             
11292  2F94             		; Indicate that the hammer is above Mario
11293  2F94 DD 36 0E 00 l2eed:  ld      (ix+14),0					; X offset
11294  2F98 DD 36 0F F0         ld      (ix+15),-16					; Y offset
11295  2F9C             
11296  2F9C             		; If the hammer cycle is not active, jump ahead to skip 
11297  2F9C             		; running the cycle (raising and lowering the hammer)
11298  2F9C 3A 17 62            ld      a,(HAMMER_CYCLE_ACTIVE)
11299  2F9F 0F                  rrca    
11300  2FA0 D2 39 30            jp      nc,l2f97					; Exceeds relative branch
11301  2FA3             
11302  2FA3             		; The hammer cycle is active
11303  2FA3             		; Clear the hammer grabbed flag as it is no longer needed
11304  2FA3 AF                  xor     a
11305  2FA4 32 18 62            ld      (HAMMER_GRABBED),a
11306  2FA7                     
11307  2FA7             		; Trigger the hammer time tune
11308  2FA7 21 89 60            ld      hl,SONG_TRIGGER
11309  2FAA 36 04               ld      (hl),SONG_TRIGGER_HAMMER
11310  2FAC                     
11311  2FAC DD 36 09 06         ld      (ix+9),6
11312  2FB0 DD 36 0A 03         ld      (ix+10),3
11313  2FB4                     
11314  2FB4                     ; Convert Mario's sprite to a version holding the hammer in the air
11315  2FB4                     ; (Current sprite * 2 with bit 3 set, properly flipped)
11316  2FB4 06 1E               ld      b,$1e						; Hammer up sprite number
11317  2FB6 3A 07 62            ld      a,(MARIO_DATA_SPRITE_NUM)
11318  2FB9 CB 27               sla     a
11319  2FBB 30 04               jr      nc,l2f1b
11320  2FBD F6 80               or      %10000000					; Flip horizontally
11321  2FBF CB F8               set     7,b
11322  2FC1 F6 08       l2f1b:  or      %00001000					; Set the sprite to one of the hammer-carrying sprites
11323  2FC3 4F                  ld      c,a
11324  2FC4                     
11325  2FC4                     ; If it is not time to lower the hammer, jump ahead
11326  2FC4 3A 94 63            ld      a,(HAMMER_CYCLE_COUNTER)
11327  2FC7 CB 5F               bit     3,a
11328  2FC9 28 1C               jr      z,l2f43
11329  2FCB                     
11330  2FCB                     ; Set the Mario and hammer sprites to their lowered positions
11331  2FCB CB C0               set     0,b
11332  2FCD CB C1               set     0,c
11333  2FCF             
11334  2FCF DD 36 09 05         ld      (ix+9),5
11335  2FD3 DD 36 0A 06         ld      (ix+10),6
11336  2FD7                     
11337  2FD7                     ; Indicate the hammer is lowered to Mario's left
11338  2FD7 DD 36 0F 00         ld      (ix+15),0					; Y offset
11339  2FDB DD 36 0E F0         ld      (ix+14),-16					; X offset
11340  2FDF                     
11341  2FDF                     ; If Mario is facing left, jump ahead to skip flipping the hammer 
11342  2FDF CB 79               bit     7,c
11343  2FE1 28 04               jr      z,l2f43
11344  2FE3             
11345  2FE3             		; Indicatd the hammer is lowered to Mario's right
11346  2FE3 DD 36 0E 10         ld      (ix+14),16					; X offset
11347  2FE7                     
11348  2FE7                     ; Save the sprite number
11349  2FE7 79          l2f43:  ld      a,c
11350  2FE8 32 4D 69            ld      (MARIO_SPRITE_NUM),a
11351  2FEB                     
11352  2FEB                     ; Use palette 7
11353  2FEB 0E 07               ld      c,7
11354  2FED                     
11355  2FED                     ; Advance the hammer cycle
11356  2FED 21 94 63            ld      hl,HAMMER_CYCLE_COUNTER
11357  2FF0 34                  inc     (hl)
11358  2FF1                     
11359  2FF1                     ; If the cycle has not wrapped around back to 0, jump ahead
11360  2FF1 20 65               jr      nz,l2fb7
11361  2FF3                     
11362  2FF3                     ; Increment the hammer cycle wrap counter
11363  2FF3 21 95 63            ld      hl,HAMMER_CYCLE_WRAP_COUNTER
11364  2FF6 34                  inc     (hl)
11365  2FF7 7E                  ld      a,(hl)
11366  2FF8                     
11367  2FF8                     ; If the hammer cycle has not wrapped twice, jump ahead
11368  2FF8 FE 02               cp      2
11369  2FFA 20 62               jr      nz,l2fbe
11370  2FFC                     
11371  2FFC                     ; Reset hammer cycle data
11372  2FFC AF                  xor     a
11373  2FFD 32 95 63            ld      (HAMMER_CYCLE_WRAP_COUNTER),a
11374  3000 32 17 62            ld      (HAMMER_CYCLE_ACTIVE),a
11375  3003 DD 77 01            ld      (ix+1),a					; Mario no longer has the hammer
11376  3006 3A 03 62            ld      a,(MARIO_X)
11377  3009 ED 44               neg     
11378  300B DD 77 0E            ld      (ix+14),a					; X offset = -MARIO_X (this is used lower down to set the hammer's x coordinate to 0)
11379  300E                     
11380  300E                     ; Update Mario's sprite 
11381  300E 3A 07 62            ld      a,(MARIO_DATA_SPRITE_NUM)
11382  3011 32 4D 69            ld      (MARIO_SPRITE_NUM),a
11383  3014                     
11384  3014                     ; Mark the hammer as inactive
11385  3014 DD 36 00 00         ld      (ix+0),0					; Sprite inactive
11386  3018             
11387  3018             		; Play the previously active tune
11388  3018 3A 89 63            ld      a,(PRE_HAMMER_TUNE)
11389  301B 32 89 60            ld      (SONG_TRIGGER),a
11390  301E                     
11391  301E                     ; Set the hammer's x coordinate based on
11392  301E                     ; the hammer's offset from Mario
11393  301E EB          l2f7c:  ex      de,hl
11394  301F 3A 03 62            ld      a,(MARIO_X)
11395  3022 DD 86 0E            add     a,(ix+14)					; X offset					; X offset
11396  3025 77                  ld      (hl),a						; Hammer sprite x coordinate
11397  3026 DD 77 03            ld      (ix+3),a					; X coordinate
11398  3029                     
11399  3029                     ; Update the hammer sprite number and palette
11400  3029 23                  inc     hl							; Sprite number
11401  302A 70                  ld      (hl),b					
11402  302B 23                  inc     hl							; Sprite palette
11403  302C 71                  ld      (hl),c
11404  302D                     
11405  302D                     ; Set the hammer y coordinate based on the offset from Mario
11406  302D 23                  inc     hl							; Y coordinate
11407  302E 3A 05 62            ld      a,(MARIO_Y)
11408  3031 DD 86 0F            add     a,(ix+15)					; Y offset
11409  3034 77                  ld      (hl),a
11410  3035 DD 77 05            ld      (ix+5),a					; Y coordinate
11411  3038 C9                  ret     
11412  3039                     
11413  3039             		; If the hammer has not been grabbed, return
11414  3039 3A 18 62    l2f97:  ld      a,(HAMMER_GRABBED)
11415  303C 0F                  rrca    
11416  303D D0                  ret     nc
11417  303E             		
11418  303E DD 36 09 06         ld      (ix+9),6
11419  3042 DD 36 0A 03         ld      (ix+10),3
11420  3046                     
11421  3046                     ; Set b to the upright hammer sprite horizontally flipped to match Mario
11422  3046 3A 07 62            ld      a,(MARIO_DATA_SPRITE_NUM)
11423  3049 07                  rlca    
11424  304A 3E 3C               ld      a,$3c						; $1e shifted left 1 bit
11425  304C 1F                  rra     
11426  304D 47                  ld      b,a
11427  304E                     
11428  304E                     ; Use palette 7
11429  304E 0E 07               ld      c,7							; Palette 7
11430  3050                     
11431  3050             		; Save the current tune so that it can be restored after the hammer cycle is over
11432  3050 3A 89 60            ld      a,(SONG_TRIGGER)
11433  3053 32 89 63            ld      (PRE_HAMMER_TUNE),a
11434  3056                     
11435  3056                     ; Jump back up to update the hammer sprite
11436  3056 18 C6               jr      l2f7c
11437  3058                     
11438  3058             		; If the hammer cycle counter has not yet wrapped once,
11439  3058             		; jump back up to update the hammer sprite
11440  3058 3A 95 63    l2fb7:  ld      a,(HAMMER_CYCLE_WRAP_COUNTER)
11441  305B A7                  and     a
11442  305C 28 C0               jr      z,l2f7c
11443  305E             		
11444  305E             		; Cycle the hammer palette to provide a visual indication that
11445  305E             		; the hammer will disappear soon
11446  305E             		
11447  305E             		; If it is not time to change the hammer color,
11448  305E             		; Jump back up to update the hammer sprite
11449  305E 3A 1A 60    l2fbe:  ld      a,(COUNTER_2)
11450  3061 CB 5F               bit     3,a
11451  3063 28 B9               jr      z,l2f7c
11452  3065             		
11453  3065             		; Set the palette to 1 and jump back up to update the hammer sprite
11454  3065 0E 01               ld      c,1
11455  3067 18 B5               jr      l2f7c
11456  3069             ;------------------------------------------------------------------------------
11457  3069             		
11458  3069             
11459  3069             		
11460  3069             ;------------------------------------------------------------------------------
11461  3069             l2fcb:  
11462  3069             		; Return unless this is the mixer stage, elevators stage, rivets stage,
11463  3069             		; or secret stage
11464  3069 3E 1E       		ld      a,%00011110
11465  306B F7                  rst     $30			
11466  306C             		
11467  306C 21 B4 62            ld      hl,$62b4
11468  306F 35                  dec     (hl)
11469  3070 C0                  ret     nz
11470  3071             		
11471  3071             		; Make the barrel fire flare up 
11472  3071 3E 03               ld      a,3
11473  3073 32 B9 62            ld      (BARREL_FIRE_STATE),a
11474  3076             		
11475  3076 32 96 63            ld      (RELEASE_SPRING),a
11476  3079             		
11477  3079             		; Redisplay the timer
11478  3079 11 01 05            ld      de,$0501
11479  307C CD 36 31            call    L_ADD_EVENT
11480  307F             
11481  307F             		
11482  307F 3A B3 62            ld      a,($62b3)
11483  3082 77                  ld      (hl),a
11484  3083             		
11485  3083 21 B1 62            ld      hl,$62b1
11486  3086 35                  dec     (hl)
11487  3087                     
11488  3087 C0          		ret     nz
11489  3088             
11490  3088 3E 01               ld      a,1
11491  308A 32 86 63            ld      ($6386),a
11492  308D C9                  ret     
11493  308E             ;------------------------------------------------------------------------------
11494  308E             
11495  308E             
11496  308E             
11497  308E             ;------------------------------------------------------------------------------
11498  308E             ; Convert a two byte tile location into a tile memory address
11499  308E             ; passed:  hl - the stage location data
11500  308E             ; return:  hl - the tile memory address
11501  308E             L_STAGE_LOC_TO_ADDRESS:  
11502  308E             		; Isolate the x coord (5 MSBs in l)
11503  308E 7D          		ld      a,l
11504  308F 0F                  rrca    
11505  3090 0F                  rrca    
11506  3091 0F                  rrca    
11507  3092 E6 1F               and     %00011111
11508  3094 6F                  ld      l,a
11509  3095             
11510  3095             		; Isolate the y coord (5 MSBs in h)
11511  3095 7C                  ld      a,h
11512  3096 2F                  cpl     							; Invert a
11513  3097 E6 F8               and     %11111000
11514  3099 5F                  ld      e,a
11515  309A             
11516  309A             		; Convert the x and y to a tile memory address
11517  309A AF                  xor     a
11518  309B 67                  ld      h,a
11519  309C CB 13               rl      e						
11520  309E 17                  rla     
11521  309F CB 13               rl      e
11522  30A1 17                  rla     							; a = 2 MSBs in e
11523  30A2 C6 74               add     a,$74
11524  30A4 57                  ld      d,a
11525  30A5 19                  add     hl,de
11526  30A6 C9                  ret     
11527  30A7             ;------------------------------------------------------------------------------
11528  30A7             
11529  30A7             
11530  30A7             
11531  30A7             ;------------------------------------------------------------------------------
11532  30A7             ; I have absolutely no idea what this function does...
11533  30A7             ; passed:	a - 
11534  30A7             ;			b - 
11535  30A7             ; return:	a
11536  30A7             l3009:  
11537  30A7             		; Copy a to d
11538  30A7 57          		ld      d,a
11539  30A8             		
11540  30A8             		; If a is 1, 3, or 5, jump ahead
11541  30A8 0F                  rrca    
11542  30A9 38 11               jr      c,l3022
11543  30AB             
11544  30AB             		; If a is 0 or 2, set c to $93
11545  30AB 0E 93               ld      c,$93
11546  30AD 0F                  rrca    
11547  30AE 0F                  rrca    
11548  30AF 30 02               jr      nc,l3017
11549  30B1             		
11550  30B1             		; If a is 4, set c to $6c
11551  30B1 0E 6C               ld      c,$6c
11552  30B3             		
11553  30B3             		; If a is 2, jump ahead
11554  30B3 07          l3017:  rlca    
11555  30B4 38 13               jr      c,l3031
11556  30B6             		
11557  30B6             		; Isolate the 4 MSBs of c
11558  30B6 79                  ld      a,c
11559  30B7 E6 F0               and     %11110000
11560  30B9 4F                  ld      c,a
11561  30BA             		
11562  30BA 18 0D               jr      l3031
11563  30BC             		
11564  30BC             		; If a is 1 or 3, set c to $b4
11565  30BC 0E B4       l3022:  ld      c,$b4
11566  30BE 0F                  rrca    
11567  30BF 0F                  rrca    
11568  30C0 30 02               jr      nc,l302b
11569  30C2             		
11570  30C2             		; If a is 5, set c to $1e
11571  30C2 0E 1E               ld      c,$1e
11572  30C4             		
11573  30C4             		; If b is >= 4, jump ahead to skip decrementing b
11574  30C4 CB 50       l302b:  bit     2,b
11575  30C6 28 01               jr      z,l3031
11576  30C8             		
11577  30C8 05                  dec     b
11578  30C9             		
11579  30C9             		; Rotate c two bits right
11580  30C9 79          l3031:  ld      a,c
11581  30CA 0F                  rrca    
11582  30CB 0F                  rrca    
11583  30CC 4F                  ld      c,a
11584  30CD             		
11585  30CD             		; If the 2 LSBs of c are not equal to b, 
11586  30CD             		; jump back up to rotate it again
11587  30CD E6 03               and     %00000011
11588  30CF B8                  cp      b		
11589  30D0 20 F7               jr      nz,l3031
11590  30D2             		
11591  30D2             		; Rotate c two bits right
11592  30D2 79                  ld      a,c
11593  30D3 0F                  rrca    
11594  30D4 0F                  rrca    
11595  30D5             		
11596  30D5             		; If the 2 LSBs of c are not both 1's, retrun
11597  30D5 E6 03               and     %00000011
11598  30D7 FE 03               cp      3
11599  30D9 C0                  ret     nz		
11600  30DA             		
11601  30DA CB 92               res     2,d
11602  30DC 15                  dec     d
11603  30DD C0                  ret     nz
11604  30DE                     
11605  30DE 3E 04       		ld      a,4
11606  30E0 C9                  ret     
11607  30E1             ;------------------------------------------------------------------------------
11608  30E1             
11609  30E1             
11610  30E1             
11611  30E1             ;------------------------------------------------------------------------------
11612  30E1             ; Animate the ladder being pulled up on the introduction stage by erasing each 
11613  30E1             ; row of the ladder one by one
11614  30E1             L_ANIMATE_LADDER_PULL_UP:  
11615  30E1 11 E0 FF    		ld      de,-32
11616  30E4             		
11617  30E4             		; Get the current ladder row to erase
11618  30E4 3A 8E 63            ld      a,(LADDER_ROW_TO_ERASE)
11619  30E7 4F                  ld      c,a
11620  30E8 06 00               ld      b,0						; bc = row
11621  30EA                     
11622  30EA                     ; Erase each ladder tile at the current row
11623  30EA 21 00 76            ld      hl,TILE_COORD(16,0)
11624  30ED CD FB 30            call    L_ERASE_INTRO_LADDER_TILE
11625  30F0 21 C0 75            ld      hl,TILE_COORD(14,0)
11626  30F3 CD FB 30            call    L_ERASE_INTRO_LADDER_TILE
11627  30F6                     
11628  30F6                     ; Advance to the next row
11629  30F6 21 8E 63            ld      hl,LADDER_ROW_TO_ERASE
11630  30F9 35                  dec     (hl)
11631  30FA C9                  ret     
11632  30FB             ;------------------------------------------------------------------------------
11633  30FB             
11634  30FB             
11635  30FB             
11636  30FB             ;------------------------------------------------------------------------------
11637  30FB             ; Animate the ladders on the introduction stage being pulled up by overwriting 
11638  30FB             ; a ladder tile with the tile to the left of it
11639  30FB             ; passed:  hl - screen memory address of the tile just to the left of the one to
11640  30FB             ;				overwrite
11641  30FB             ;			bc - the row to act on
11642  30FB             ;			de - -32
11643  30FB             L_ERASE_INTRO_LADDER_TILE:  
11644  30FB             		; Overwrite the ladder tile with the tile to the left
11645  30FB 09          		add     hl,bc
11646  30FC 7E                  ld      a,(hl)
11647  30FD 19                  add     hl,de
11648  30FE 77                  ld      (hl),a
11649  30FF C9                  ret     
11650  3100             ;------------------------------------------------------------------------------
11651  3100             
11652  3100             
11653  3100             
11654  3100             ;------------------------------------------------------------------------------
11655  3100             ; Advances the current game state variable once the minor timer runs down
11656  3100             L_PAUSE_CURRENT_STATE:  
11657  3100 DF          		rst     $18						; Return until the minor timer has run down
11658  3101             		
11659  3101             		; Advance the current state variable
11660  3101 2A C0 63            ld      hl,(CURRENT_STATE_VAR_POINTER)
11661  3104 34                  inc     (hl)
11662  3105 C9                  ret     
11663  3106             ;------------------------------------------------------------------------------
11664  3106             
11665  3106             
11666  3106             
11667  3106             ;------------------------------------------------------------------------------
11668  3106             ; Animate Donkey Kong carrying Pauline up the ladders on the introduction stage
11669  3106             L_ANIMATE_CLIMBING_LADDERS:  
11670  3106             		; Return until 8 increments of counter have occured
11671  3106 21 AF 62    		ld      hl,DK_CLIMBING_COUNTER
11672  3109 34                  inc     (hl)
11673  310A 7E                  ld      a,(hl)
11674  310B E6 07               and     %0111
11675  310D C0                  ret     nz
11676  310E                     
11677  310E                     ; Move Donkey Kong up 4 pixels
11678  310E 21 0B 69            ld      hl,DK_SPRITE_1_Y
11679  3111 0E FC               ld      c,-4
11680  3113 FF                  rst     $38
11681  3114                     
11682  3114                     ; Alternate between Donkey Kong's climbing arm sprites
11683  3114 0E 81               ld      c,%10000001
11684  3116 21 09 69            ld      hl,DK_SPRITE_1_NUM
11685  3119 CD 2D 31            call    L_ALT_DK_ARMS_AND_LEGS
11686  311C              
11687  311C                     ; Alternate between Donkey Kong's climbing leg sprites
11688  311C 21 1D 69            ld      hl,DK_SPRITE_6_NUM
11689  311F CD 2D 31            call    L_ALT_DK_ARMS_AND_LEGS
11690  3122                     
11691  3122                     ; Randomly flip Pauline's struggling legs
11692  3122 CD 57 00            call    L_UPDATE_RAND_NUM
11693  3125 E6 80               and     %10000000
11694  3127 21 2D 69            ld      hl,DK_SPRITE_10_NUM
11695  312A AE                  xor     (hl)
11696  312B 77                  ld      (hl),a
11697  312C                     
11698  312C C9                  ret     
11699  312D             ;------------------------------------------------------------------------------
11700  312D             
11701  312D             
11702  312D             
11703  312D             ;------------------------------------------------------------------------------
11704  312D             ; Alternate Donkey Kong's arm or leg sprites to animate Donkey Kong's climb up
11705  312D             ; the ladders 
11706  312D             ; passed:  a - $81
11707  312D             ;			hl - address of a Donkey Kong sprite y coord
11708  312D             ;			de - 4
11709  312D             L_ALT_DK_ARMS_AND_LEGS:  
11710  312D             		; Alternate Donkey Kong's arms between sprites $34 and $35
11711  312D             		; to animate Donkey Kong climbing the ladders
11712  312D 06 02       		ld      b,2						; For b = 2 to 1
11713  312F 79          l3098:  ld      a,c						; %1001
11714  3130 AE                  xor     (hl)
11715  3131 77                  ld      (hl),a
11716  3132 19                  add     hl,de					; Next arm sprite y coord
11717  3133 10 FA               djnz    l3098					; Next b
11718  3135 C9                  ret     
11719  3136             ;------------------------------------------------------------------------------
11720  3136             
11721  3136             
11722  3136             
11723  3136             ;------------------------------------------------------------------------------
11724  3136             ; Add function to circular event buffer to be processed and called during the
11725  3136             ; next interrupt
11726  3136             ; Event numbers:
11727  3136             ;	0 = Award points
11728  3136             ;		0 = 0 points
11729  3136             ;		1 = 100 points
11730  3136             ;		2 = 200 points
11731  3136             ;		...
11732  3136             ;		9 = 900 points
11733  3136             ;		10 = 0 points
11734  3136             ;		11 = 1000 points
11735  3136             ;		12 = 2000 points
11736  3136             ;		...
11737  3136             ;		19 = 9000 points
11738  3136             ;
11739  3136             ;	1 = Clear scores
11740  3136             ;
11741  3136             ;	2 = Display scores
11742  3136             ;		0 = Display player 1 score
11743  3136             ;		1 = Display player 2 score
11744  3136             ;		2 = Display high score
11745  3136             ;		3 = Display all scored
11746  3136             ;
11747  3136             ;	3 = Display a string from the string table
11748  3136             ;		
11749  3136             ;	4 = Display the number of plays earned
11750  3136             ;
11751  3136             ;	5 = Display the timer
11752  3136             ;		0 = Add the timer to the player's score
11753  3136             ;		1 = Don't add the timer to the player's score
11754  3136             ;
11755  3136             ;	6 = Display current lives and level number
11756  3136             ;		0 = Don't subtract a life first
11757  3136             ;		1 = Do subtract a life first
11758  3136             ;
11759  3136             ; passed:	d - the event number
11760  3136             ;			e - the argument to pass to the function
11761  3136             L_ADD_EVENT:  
11762  3136 E5          		push    hl
11763  3137 21 C0 60            ld      hl,$60c0
11764  313A 3A B0 60            ld      a,(ACTION_BUFFER_WRITE_POS)
11765  313D 6F                  ld      l,a
11766  313E CB 7E               bit     7,(hl)
11767  3140 28 0E               jr      z,l30bb
11768  3142 72                  ld      (hl),d
11769  3143 2C                  inc     l
11770  3144 73                  ld      (hl),e
11771  3145 2C                  inc     l
11772  3146 7D                  ld      a,l
11773  3147 FE C0               cp      $c0
11774  3149 30 02               jr      nc,l30b8
11775  314B 3E C0               ld      a,$c0
11776  314D 32 B0 60    l30b8:  ld      (ACTION_BUFFER_WRITE_POS),a
11777  3150 E1          l30bb:  pop     hl
11778  3151 C9                  ret     
11779  3152             ;------------------------------------------------------------------------------
11780  3152             
11781  3152             
11782  3152             
11783  3152             ;------------------------------------------------------------------------------
11784  3152             ; Clear sprites before running the death animation
11785  3152             L_CLEAR_SPRITES_WHEN_DEAD:  
11786  3152             		; Clear the collision detection sprites
11787  3152 21 50 69    		ld      hl,COLLISION_AREA_SPRITES
11788  3155 06 02               ld      b,2						; For b = 2 to 1
11789  3157 CD 78 31            call    l30e4
11790  315A                     
11791  315A                     ; Clear $6980 through $69a4
11792  315A 2E 80               ld      l,$80					; hl = $6980
11793  315C 06 0A               ld      b,10						; For b = 10 to 1
11794  315E CD 78 31            call    l30e4
11795  3161                     
11796  3161                     ; Clear the pie and conveyer motor sprites
11797  3161 2E B8               ld      l,$b8					; hl = PIE_SPRITES
11798  3163 06 0B               ld      b,11						; For b = 11 to 1
11799  3165 CD 78 31            call    l30e4
11800  3168                     
11801  3168                     ; Clear the prize and hammer sprites
11802  3168 21 0C 6A            ld      hl,PRIZE_SPRITES
11803  316B 06 05               ld      b,5						; For b = 5 to 1
11804  316D 18 09               jr      l30e4
11805  316F                     
11806  316F                     
11807  316F             L_CLEAR_MARIO_SPRITE:  
11808  316F             		; Clear the Mario sprite
11809  316F 21 4C 69    		ld      hl,MARIO_SPRITE_X
11810  3172 36 00               ld      (hl),0
11811  3174                     
11812  3174                     ; Clear the elevator platform sprites
11813  3174 2E 58               ld      l,$58					; hl = ELEVATOR_PLATFORM_SPRITES
11814  3176 06 06               ld      b,6
11815  3178                     
11816  3178 7D          l30e4:  ld      a,l
11817  3179             
11818  3179             		; Set the current sprite's x coordinate to 0
11819  3179 36 00       l30e5:  ld      (hl),0
11820  317B             
11821  317B             		; Advance to the next sprite
11822  317B C6 04               add     a,4
11823  317D 6F                  ld      l,a
11824  317E 10 F9               djnz    l30e5					; Next b
11825  3180                     
11826  3180 C9                  ret     
11827  3181             ;------------------------------------------------------------------------------
11828  3181             
11829  3181             
11830  3181             ;------------------------------------------------------------------------------
11831  3181             L_IMPLEMENT_FIREBALLS:  
11832  3181             		; Return if it is not time to update the fireballs
11833  3181             		; (Fireballs are updated faster on higher difficulty levels)
11834  3181 CD 8E 31    		call    L_CONTROL_FIREBALL_SPEED
11835  3184             
11836  3184             		; Spawn new fireballs if it is time
11837  3184             		; Return from this function if there are no active fireballs
11838  3184 CD CC 31            call    L_SPAWN_FIREBALLS
11839  3187             		
11840  3187             		; Make the fireballs move
11841  3187 CD 32 32            call    L_PROCESS_EACH_FIREBALL
11842  318A             		
11843  318A             		; Update the fireball sprites to match the fireball data structures
11844  318A CD 2E 35            call    L_UPDATE_FIREBALL_SPRITES
11845  318D C9                  ret     
11846  318E             ;------------------------------------------------------------------------------
11847  318E             
11848  318E             
11849  318E             
11850  318E             ;------------------------------------------------------------------------------
11851  318E             ; This function controls how often the fireballs are updated
11852  318E             ; based on the current difficulty level (up to a maximum of 5).
11853  318E             ; The fireballs are updated slower (and, thus, move slower) on
11854  318E             ; slower difficulty levels.  As the difficulty level increases,
11855  318E             ; so does the fireball speed.
11856  318E             L_CONTROL_FIREBALL_SPEED:  
11857  318E             		; Jump to one of the following functions based on the
11858  318E             		; difficulty level (up to a maximum of 5)
11859  318E 3A 80 63    		ld      a,(CP_DIFFICULTY)
11860  3191 FE 06               cp      6
11861  3193 38 02               jr      c,l3103
11862  3195 3E 05               ld      a,5
11863  3197 EF          l3103:  rst     $28							; Jump to local table address
11864  3198             		; Jump table
11865  3198 A4 31       		.word	L_CONTROL_FIREBALL_SPEED_0_1	; 0 = 
11866  319A A4 31       		.word	L_CONTROL_FIREBALL_SPEED_0_1	; 1 = 
11867  319C AE 31       		.word	L_CONTROL_FIREBALL_SPEED_2	; 2 = 
11868  319E B8 31       		.word	L_CONTROL_FIREBALL_SPEED_3_4	; 3 = 
11869  31A0 B8 31       		.word	L_CONTROL_FIREBALL_SPEED_3_4	; 4 = 
11870  31A2 C2 31       		.word	L_CONTROL_FIREBALL_SPEED_5 	; 5 = 
11871  31A4             ;------------------------------------------------------------------------------
11872  31A4             
11873  31A4             
11874  31A4             ;------------------------------------------------------------------------------
11875  31A4             ; Difficulty levels 0 and 1
11876  31A4             ; Fireballs are processed one out of two calls
11877  31A4             L_CONTROL_FIREBALL_SPEED_0_1:  
11878  31A4             		; Return if counter 2 is odd
11879  31A4 3A 1A 60    		ld      a,(COUNTER_2)
11880  31A7 E6 01               and     %00000001
11881  31A9 FE 01               cp      1
11882  31AB C8                  ret     z
11883  31AC             		
11884  31AC             		; Return from the calling function if counter 2 is even
11885  31AC E1                  pop		hl
11886  31AD C9                  ret     
11887  31AE             ;------------------------------------------------------------------------------
11888  31AE             
11889  31AE             
11890  31AE             
11891  31AE             ;------------------------------------------------------------------------------
11892  31AE             ; Difficulty level 2
11893  31AE             ; Fireballs are processed 5 out of 8 times
11894  31AE             L_CONTROL_FIREBALL_SPEED_2: 	
11895  31AE             		; Return if the 3 LSBs of counter 2 are less than 5
11896  31AE 3A 1A 60    		ld      a,(COUNTER_2)
11897  31B1 E6 07               and     %00000111
11898  31B3 FE 05               cp      5
11899  31B5 F8                  ret     m
11900  31B6             		
11901  31B6             		; Return from the calling function 
11902  31B6             		; if the 3 LSBs of counter 2 are greater than or equal to 5
11903  31B6 E1                  pop		hl
11904  31B7 C9                  ret     
11905  31B8             ;------------------------------------------------------------------------------
11906  31B8             
11907  31B8             
11908  31B8             
11909  31B8             ;------------------------------------------------------------------------------
11910  31B8             ; Difficulty levels 3 and 4
11911  31B8             ; Fireballs are processed 3 out of 4 times?
11912  31B8             L_CONTROL_FIREBALL_SPEED_3_4:  
11913  31B8             		; Return if the 2 LSBs of counter 2 are not equal to 3
11914  31B8 3A 1A 60    		ld      a,(COUNTER_2)
11915  31BB E6 03               and     %00000011
11916  31BD FE 03               cp      3
11917  31BF F8                  ret     m
11918  31C0             		
11919  31C0             		; Return from the calling function 
11920  31C0             		; if the 2 LSBs of counter 2 are 3
11921  31C0 E1                  pop		hl
11922  31C1 C9                  ret     
11923  31C2             ;------------------------------------------------------------------------------
11924  31C2             
11925  31C2             
11926  31C2             
11927  31C2             ;------------------------------------------------------------------------------
11928  31C2             ; Difficulty level 5
11929  31C2             ; Fireballs are processed 7 out of 8 times
11930  31C2             L_CONTROL_FIREBALL_SPEED_5:	
11931  31C2             		; Return if the 3 LSBs of counter 2 are not equal to 7
11932  31C2 3A 1A 60    		ld      a,(COUNTER_2)
11933  31C5 E6 07               and     %00000111
11934  31C7 FE 07               cp      7
11935  31C9 F8                  ret     m
11936  31CA             
11937  31CA             		; Return from the calling function
11938  31CA             		; if the 3 LSBs of counter 2 are 7
11939  31CA E1          		pop		hl
11940  31CB C9                  ret     
11941  31CC             ;------------------------------------------------------------------------------
11942  31CC             
11943  31CC             
11944  31CC             
11945  31CC             ;------------------------------------------------------------------------------
11946  31CC             ; This function counts the number of active fireballs,
11947  31CC             ; Spawns new ones when it is time to and there are open fireball
11948  31CC             ; data structures,
11949  31CC             ; Returns from the calling function if there are no active 
11950  31CC             ; fireballs
11951  31CC             ;
11952  31CC             ; NOTE: Apparently, the number of active fireballs on the mixer
11953  31CC             ;		stage is limited by the current difficulty level.  
11954  31CC             ;		I did not know that...
11955  31CC             L_SPAWN_FIREBALLS:  
11956  31CC DD 21 00 64 		ld      ix,FIREBALL_STRUCTS
11957  31D0             		
11958  31D0             		; Set the active fireball count to 0
11959  31D0 AF                  xor     a
11960  31D1 32 A1 63            ld      (ACTIVE_FIREBALL_COUNT),a
11961  31D4             		
11962  31D4             		; Examine each fireball data structure
11963  31D4 06 05               ld      b,5							; 5 fireballs
11964  31D6 11 20 00            ld      de,32						; 32 byte data structures
11965  31D9             
11966  31D9             		; If this fireball is not active, jump ahead
11967  31D9 DD 7E 00    l3149:  ld      a,(ix+0)
11968  31DC FE 00               cp      0
11969  31DE 28 28               jr      z,l317c
11970  31E0             		
11971  31E0             		; Increment the fireball index
11972  31E0 3A A1 63            ld      a,(ACTIVE_FIREBALL_COUNT)
11973  31E3 3C                  inc     a
11974  31E4 32 A1 63            ld      (ACTIVE_FIREBALL_COUNT),a
11975  31E7             		
11976  31E7             		; If the hammer cycle is not active,
11977  31E7             		; set the fireball sprite palette to 1
11978  31E7             		; (normal fireball colors)
11979  31E7 3E 01               ld      a,1
11980  31E9 DD 77 08            ld      (ix+8),a
11981  31EC 3A 17 62            ld      a,(HAMMER_CYCLE_ACTIVE)
11982  31EF FE 01               cp      1
11983  31F1 20 04               jr      nz,l316a
11984  31F3             		
11985  31F3             		; If the hammer cycle is active,
11986  31F3             		; set the fireball sprite palette to 0
11987  31F3             		; (inverted fireball colors)
11988  31F3 AF                  xor     a
11989  31F4 DD 77 08            ld      (ix+8),a
11990  31F7             		
11991  31F7             		; Process the next fireball
11992  31F7 DD 19       l316a:  add     ix,de
11993  31F9 10 DE               djnz    l3149						; Next b
11994  31FB             
11995  31FB             		; Set the fireball release trigger to 0
11996  31FB 21 A0 63            ld      hl,RELEASE_A_FIREBALL
11997  31FE 36 00               ld      (hl),0
11998  3200             		
11999  3200             		; If there are active fireballs, return
12000  3200 3A A1 63            ld      a,(ACTIVE_FIREBALL_COUNT)
12001  3203 FE 00               cp      0
12002  3205 C0                  ret     nz
12003  3206             		
12004  3206             		; If there are no active fireballs, 
12005  3206             		; return from the calling function
12006  3206 E1                  pop		hl
12007  3207 C9                  ret     
12008  3208             		
12009  3208             		
12010  3208             		; The current fireball data structure (in ix)
12011  3208             		; is not being used
12012  3208             l317c:  ; If this is not the mixer stage, jump ahead
12013  3208 3A 27 62            ld      a,(CURRENT_STAGE)
12014  320B FE 02               cp      2
12015  320D 20 09               jr      nz,l3195
12016  320F             		
12017  320F             		; If the number of active fireballs 
12018  320F             		; already matches the difficulty level, return
12019  320F 3A A1 63            ld      a,(ACTIVE_FIREBALL_COUNT)
12020  3212 4F                  ld      c,a
12021  3213 3A 80 63            ld      a,(CP_DIFFICULTY)
12022  3216 B9                  cp      c
12023  3217 C8                  ret     z
12024  3218             		
12025  3218             		; If it is not time to release a fireball,
12026  3218             		; jump back up to process the next fireball
12027  3218             		; data structure
12028  3218 3A A0 63    l3195:  ld      a,(RELEASE_A_FIREBALL)
12029  321B FE 01               cp      1
12030  321D 20 D8               jr      nz,l316a
12031  321F             		
12032  321F             		; Set this fireball active
12033  321F DD 77 00            ld      (ix+0),a					; Active
12034  3222             		
12035  3222             		; Mark that this fireball needs to be initialized
12036  3222 DD 77 18            ld      (ix+24),a					; Not initialized
12037  3225             		
12038  3225             		; Turn off the fireball release flag
12039  3225 AF                  xor     a
12040  3226 32 A0 63            ld      (RELEASE_A_FIREBALL),a
12041  3229             		
12042  3229             		; Increment the number of active fireballs
12043  3229 3A A1 63            ld      a,(ACTIVE_FIREBALL_COUNT)
12044  322C 3C                  inc     a
12045  322D 32 A1 63            ld      (ACTIVE_FIREBALL_COUNT),a
12046  3230             		
12047  3230             		; Jump back up to process the next fireball
12048  3230 18 C5               jr      l316a
12049  3232             ;------------------------------------------------------------------------------
12050  3232             
12051  3232             
12052  3232             
12053  3232             ;------------------------------------------------------------------------------
12054  3232             ; Update each fireball in turn
12055  3232             L_PROCESS_EACH_FIREBALL:  
12056  3232             		; Make fireballs 2 and 4 move left roughly 25% of the time
12057  3232 CD 5C 32    		call    L_FIREBALLS_ABRUPT_LEFT
12058  3235             		
12059  3235             		; Initialize the count of updated fireballs
12060  3235 AF                  xor     a
12061  3236 32 A2 63            ld      (UPDATED_FIREBALL_COUNT),a
12062  3239             		
12063  3239             		; Process each fireball
12064  3239 21 E0 63            ld      hl,FIREBALL_STRUCTS - 32	; 32 bytes before the first fireball data structure
12065  323C 22 C8 63            ld      (CURRENT_FIREBALL),hl
12066  323F 2A C8 63    l31be:  ld      hl,(CURRENT_FIREBALL)
12067  3242 01 20 00            ld      bc,32
12068  3245 09                  add     hl,bc
12069  3246 22 C8 63            ld      (CURRENT_FIREBALL),hl
12070  3249             		
12071  3249             		; If this fireball is not active, 
12072  3249             		; jump ahead to skip processing it
12073  3249 7E                  ld      a,(hl)
12074  324A A7                  and     a
12075  324B 28 03               jr      z,l31d0
12076  324D             		
12077  324D             		; Update this fireball
12078  324D             		; Make it move, climb ladders, etc
12079  324D CD 81 32            call    L_UPDATE_CURRENT_FIREBALL
12080  3250             
12081  3250             		; Increment the number of fireballs that have been processed
12082  3250 3A A2 63    l31d0:  ld      a,(UPDATED_FIREBALL_COUNT)
12083  3253 3C                  inc     a
12084  3254 32 A2 63            ld      (UPDATED_FIREBALL_COUNT),a
12085  3257             		
12086  3257             		; If there are still more fireballs to process,
12087  3257             		; jump back up to process the next one
12088  3257 FE 05               cp      5
12089  3259 20 E4               jr      nz,l31be
12090  325B             		
12091  325B C9                  ret     
12092  325C             ;------------------------------------------------------------------------------
12093  325C             
12094  325C             
12095  325C             
12096  325C             ;------------------------------------------------------------------------------
12097  325C             ; This function makes the 2nd and 4th fireballs turn left roughly 25% of the 
12098  325C             ; time on difficulty level 3 or higher
12099  325C             ; I have no idea why
12100  325C             L_FIREBALLS_ABRUPT_LEFT:  
12101  325C             		; Return if the difficulty level is less than 3
12102  325C 3A 80 63    		ld      a,(CP_DIFFICULTY)
12103  325F FE 03               cp      3
12104  3261 F8                  ret     m
12105  3262             		
12106  3262             		; Roughly a 25% chance of continuing 
12107  3262 CD 75 32            call    L_ROUGH_25_P_CHANCE
12108  3265 FE 01               cp      1
12109  3267 C0                  ret     nz
12110  3268             		
12111  3268             		; Make fireballs 2 and 4 move left
12112  3268 21 39 64            ld      hl,FIREBALL_STRUCT_2+25		; Direction
12113  326B 3E 02               ld      a,2
12114  326D 77                  ld      (hl),a
12115  326E 21 79 64            ld      hl,FIREBALL_STRUCT_4+25		; Direction
12116  3271 3E 02               ld      a,2
12117  3273 77                  ld      (hl),a
12118  3274 C9                  ret     
12119  3275             ;------------------------------------------------------------------------------
12120  3275             
12121  3275             
12122  3275             
12123  3275             ;------------------------------------------------------------------------------
12124  3275             ; This function returns a 1 roughly 25% of the time
12125  3275             L_ROUGH_25_P_CHANCE:  
12126  3275             		; 25% chance of returning a 1
12127  3275 3A 18 60    		ld      a,(RANDOM_NUMBER)
12128  3278 E6 03               and     %00000011
12129  327A FE 01               cp      1
12130  327C C0                  ret     nz
12131  327D             		
12132  327D             		; Return the value of counter 2
12133  327D 3A 1A 60            ld      a,(COUNTER_2)
12134  3280 C9                  ret     
12135  3281             ;------------------------------------------------------------------------------
12136  3281             
12137  3281             
12138  3281             
12139  3281             ;------------------------------------------------------------------------------
12140  3281             ; This function updates the current fireball's state and position
12141  3281             L_UPDATE_CURRENT_FIREBALL:  
12142  3281             		; Work with the currently active fireball
12143  3281 DD 2A C8 63 		ld      ix,(CURRENT_FIREBALL)
12144  3285             
12145  3285             		; If the fireball has not been initialized yet
12146  3285 DD 7E 18            ld      a,(ix+24)					; Not initialized
12147  3288 FE 01               cp      1
12148  328A 28 65               jr      z,l327a
12149  328C             		
12150  328C             		; If the fireball is moving up or down,
12151  328C             		; jump ahead to skip handling horizontal movement
12152  328C DD 7E 0D            ld      a,(ix+13)					; Fireball direction
12153  328F FE 04               cp      4
12154  3291 F2 AB 32            jp      p,l3230
12155  3294             		
12156  3294             		; If the fireball needs to pause, 
12157  3294             		; jump ahead to handle it
12158  3294 DD 7E 19            ld      a,(ix+25)
12159  3297 FE 02               cp      2
12160  3299 28 5A               jr      z,l327e
12161  329B                     
12162  329B             		; Make the fireball change direction periodically
12163  329B CD 74 33    		call    L_CHANGE_FIREBALL_DIR
12164  329E                     
12165  329E 3A 18 60    		ld      a,(RANDOM_NUMBER)
12166  32A1 E6 03               and     %00000011
12167  32A3 20 09               jr      nz,l3233
12168  32A5             		
12169  32A5             		; If the fireball is standing still, 
12170  32A5             		; jump ahead to make the fireball bob without moving
12171  32A5 DD 7E 0D    l3229:  ld      a,(ix+13)					; Fireball direction
12172  32A8 A7                  and     a
12173  32A9 28 24               jr      z,l3257
12174  32AB             		
12175  32AB             		; Handle the fireball climbing up and down ladders
12176  32AB             		; If the fireball can climb a ladder, this function decides
12177  32AB             		; if it should
12178  32AB CD 91 33    l3230:  call    L_HANDLE_FIREBALLS_AND_LADDERS
12179  32AE             
12180  32AE             		; If the fireball is moving up or down,
12181  32AE             		; jump (way) ahead 
12182  32AE DD 7E 0D    l3233:  ld      a,(ix+13)					; Fireball direction
12183  32B1 FE 04               cp      4
12184  32B3 F2 05 33            jp      p,l3291
12185  32B6             		
12186  32B6             		; Update the fireball's position while its walking
12187  32B6 CD FA 33            call    L_UPDATE_FIREBALL_WALK
12188  32B9             		
12189  32B9             		; If the fireball is attempting to move off a girder,
12190  32B9             		; jump ahead to reverse its direction
12191  32B9 CD 7A 2A            call    L_CHECK_IF_NOT_SUPPORTED
12192  32BC FE 01               cp      1
12193  32BE 28 4A               jr      z,l3297
12194  32C0             		
12195  32C0             		; Work with the current fireball
12196  32C0 DD 2A C8 63         ld      ix,(CURRENT_FIREBALL)
12197  32C4             		
12198  32C4             		; If the fireball is attempting to move off the left side
12199  32C4             		; of the screen, 
12200  32C4             		; jump ahead to make it reverse its direction
12201  32C4             		; NOTE: Some code could be saved by jumping to the same
12202  32C4             		;		address used when the fireball attempts to move
12203  32C4             		;		off the girder (just above here)
12204  32C4             		;		It would slightly change the game mechanics, 
12205  32C4             		;		but shouldn't be noticeable
12206  32C4 DD 7E 0E            ld      a,(ix+14)					; Next intended x coordinate
12207  32C7 FE 10               cp      16
12208  32C9 38 36               jr      c,l328c
12209  32CB             		
12210  32CB             		; If the fireball is attempting to move off the right side
12211  32CB             		; of the screen,
12212  32CB             		; jump ahead to reverse its direction
12213  32CB             		; NOTE: Some code could be saved the same as above
12214  32CB FE F0               cp		240
12215  32CD 30 2B               jr      nc,l3284
12216  32CF             		
12217  32CF             		; If the bob table index has not reached the start of the table,
12218  32CF             		; jump ahead to decrement the index
12219  32CF DD 7E 13    l3257:  ld      a,(ix+19)					; Bob table index
12220  32D2 FE 00               cp      0
12221  32D4 20 53               jr      nz,l32b9
12222  32D6             		
12223  32D6             		; Reset the fireball bob table index to the end of the table
12224  32D6 3E 11               ld      a,FIREBALL_BOB_TABLE_LENGTH-1
12225  32D8             		
12226  32D8             		; Save the new fireball bob table index
12227  32D8 DD 77 13    l3261:  ld      (ix+19),a					; Bob table index
12228  32DB             
12229  32DB             		; Load the fireball bob y offset
12230  32DB 16 00               ld      d,0
12231  32DD 5F                  ld      e,a
12232  32DE 21 8B 3A            ld      hl,L_FIREBALL_BOB_TABLE
12233  32E1 19                  add     hl,de
12234  32E2 7E                  ld      a,(hl)
12235  32E3             		
12236  32E3             		; Move the fireball to its next intended x coordinate
12237  32E3 DD 46 0E            ld      b,(ix+14)					; Next intended x coordinate
12238  32E6 DD 70 03            ld      (ix+3),b					; X coordinate
12239  32E9             		
12240  32E9             		; Move the fireball to its next y coordinate plus the
12241  32E9             		; bob offset
12242  32E9 DD 4E 0F            ld      c,(ix+15)					; Next intended y coordinate
12243  32EC 81                  add     a,c
12244  32ED DD 77 05            ld      (ix+5),a					; Y coordinate
12245  32F0 C9                  ret     
12246  32F1             		
12247  32F1             		
12248  32F1             		; The current fireball has not been initialized yet
12249  32F1 CD 2C 33    l327a:  call    L_INIT_FIREBALL_FOR_STAGE
12250  32F4 C9                  ret     
12251  32F5             		
12252  32F5             		
12253  32F5             		; Handle the fireball while it is paused
12254  32F5 CD 43 33    l327e:  call    L_HANDLE_FIREBALL_PAUSED
12255  32F8             
12256  32F8             		; Jump back up to continue processing the fireball movement
12257  32F8 18 AB               jr      l3229
12258  32FA             		
12259  32FA             		; Make the fireball move left next
12260  32FA 3E 02       l3284:  ld      a,2
12261  32FC             
12262  32FC             		; Update the fireball direction
12263  32FC DD 77 0D    l3286:  ld      (ix+13),a					; Fireball direction
12264  32FF             
12265  32FF             		; Jump up to move the fireball to its next intended coordinate
12266  32FF 18 CE               jr      l3257
12267  3301             		
12268  3301             		; Make the fireball move right next
12269  3301 3E 01       l328c:  ld      a,1
12270  3303             
12271  3303             		; Jump up to update the fireball direction and
12272  3303             		; move the fireball
12273  3303 18 F7               jr      l3286
12274  3305             		
12275  3305             		; Update the fireball climbing up or down the current ladder
12276  3305 CD 32 34    l3291:  call    L_UPDATE_FIREBALL_CLIMB
12277  3308             
12278  3308             		; Jump up to move the fireball to its next intended coordinate
12279  3308 18 C5               jr      l3257
12280  330A             		
12281  330A             		; Work with the currently active fireball
12282  330A DD 2A C8 63 l3297:  ld      ix,(CURRENT_FIREBALL)
12283  330E             
12284  330E             		; If the fireball is moving left, 
12285  330E             		; jump ahead to reverse its direction
12286  330E DD 7E 0D            ld      a,(ix+13)					; Fireball direction
12287  3311 FE 01               cp      1
12288  3313 20 0D               jr      nz,l32b1
12289  3315             		
12290  3315             		; The fireball is moving right
12291  3315             		; Make the fireball move left immediately
12292  3315 3E 02               ld      a,2
12293  3317 DD 35 0E            dec     (ix+14)						; Next intended x coordinate
12294  331A             
12295  331A             		; Update the fireball direction
12296  331A DD 77 0D    l32a8:  ld      (ix+13),a					; Fireball direction
12297  331D             
12298  331D             		; If the current stage is barrels, 
12299  331D             		; make the fireball follow the contours of the platforms
12300  331D CD 0F 34            call    L_HANDLE_BARREL_PLATS
12301  3320             
12302  3320             		; Jump up to move the fireball to its next intended coordinate
12303  3320 18 AD               jr      l3257
12304  3322             		
12305  3322             		; Make the fireball move right immediately
12306  3322 3E 01       l32b1:  ld      a,1
12307  3324 DD 34 0E            inc     (ix+14)						; Next intended x coordinate
12308  3327             		
12309  3327             		; Jump back up to update the fireball direction
12310  3327             		; and to move the fireball
12311  3327 18 F1               jr      l32a8
12312  3329             		
12313  3329             		; Decrement the bob table index and jump back up
12314  3329             		; to make the fireball bob as it moves
12315  3329 3D          l32b9:  dec     a
12316  332A 18 AC               jr      l3261
12317  332C             ;------------------------------------------------------------------------------
12318  332C             
12319  332C             
12320  332C                     
12321  332C             ;------------------------------------------------------------------------------
12322  332C             ; This function calls the correct function to initialize the fireball depending
12323  332C             ; on the current stage
12324  332C             ; passed:	ix - the address of the current fireball
12325  332C             L_INIT_FIREBALL_FOR_STAGE:  
12326  332C                     ; If the current stage is the barrels stage, 
12327  332C             		; jump ahead
12328  332C 3A 27 62    		ld      a,(CURRENT_STAGE)
12329  332F FE 01               cp      1
12330  3331 28 08               jr      z,l32ce
12331  3333             		
12332  3333             		; If the current stage is the mixer stage
12333  3333             		; jump ahead
12334  3333 FE 02               cp      2
12335  3335 28 08               jr      z,l32d2
12336  3337             		
12337  3337             		; If the current stage is the elevators or rivets stage,
12338  3337             		; initialize the fireball for the rivets stage
12339  3337             		; NOTE: If the current stage is elevators, this function
12340  3337             		;		returns immediately
12341  3337 CD F9 34            call    L_INIT_FIREBALL_RIVETS
12342  333A C9                  ret     
12343  333B             		
12344  333B             		; The current stage is barrels
12345  333B             		; Initialize the fireball for the barrels stage
12346  333B CD 74 34    l32ce:  call    L_INIT_FIREBALL_BARRELS
12347  333E C9                  ret   
12348  333F             		
12349  333F             		; The current stage is the mixer
12350  333F             		; Initialize the fireball for the mixer stage
12351  333F CD BE 34    l32d2:  call    L_INIT_FIREBALL_MIXER
12352  3342 C9                  ret     
12353  3343             ;------------------------------------------------------------------------------
12354  3343             
12355  3343             
12356  3343             
12357  3343             ;------------------------------------------------------------------------------
12358  3343             ; This function controls fireballs while they are paused.
12359  3343             L_HANDLE_FIREBALL_PAUSED:  
12360  3343             		; If the pause timer is not 0, jump ahead to decrement it
12361  3343 DD 7E 1C    		ld      a,(ix+28)					; Pause timer
12362  3346 FE 00               cp      0
12363  3348 20 19               jr      nz,l32fd
12364  334A             
12365  334A             		; If the fireball is not paused,
12366  334A             		; jump ahead to change direction
12367  334A DD 7E 1D            ld      a,(ix+29)
12368  334D FE 01               cp      1
12369  334F 20 1F               jr      nz,l330b
12370  3351             		
12371  3351             		; If the fireball is lower than Mario,
12372  3351             		; jump ahead to unpause it
12373  3351 3A 05 62    		ld      a,(MARIO_Y)
12374  3354 DD 46 0F            ld      b,(ix+15)
12375  3357 90                  sub     b
12376  3358 38 0E               jr      c,l3303
12377  335A             		
12378  335A             		; Reset the pause timer
12379  335A DD 36 1C FF         ld      (ix+28),255					; Pause timer
12380  335E             		
12381  335E             		; Make the fireball stand still
12382  335E DD 36 0D 00 l32f8:  ld      (ix+13),0
12383  3362 C9                  ret     
12384  3363             
12385  3363             		; Decrement the timer
12386  3363 DD 35 1C    l32fd:  dec     (ix+28)						; Pause timer
12387  3366             
12388  3366             		; If the timer has not reached 0, 
12389  3366             		; jump up to keep the fireball standing still
12390  3366 20 F6               jr      nz,l32f8
12391  3368             		
12392  3368             		; Mark the fireball as no longer paused
12393  3368 DD 36 19 00 l3303:  ld      (ix+25),0
12394  336C             
12395  336C             		; Reset the pause timer to 0
12396  336C DD 36 1C 00         ld      (ix+28),0					; Pause timer
12397  3370             		
12398  3370             		; Periodically change the fireball's direction
12399  3370 CD 74 33    l330b:  call    L_CHANGE_FIREBALL_DIR
12400  3373 C9                  ret     
12401  3374             ;------------------------------------------------------------------------------
12402  3374             
12403  3374             
12404  3374             
12405  3374             ;------------------------------------------------------------------------------
12406  3374             ; This function makes the fireball change direction periodically.
12407  3374             ; The fireball continues moving in the current direction (left or right) for a 
12408  3374             ; set period of time and then has a chance of changing direction.
12409  3374             L_CHANGE_FIREBALL_DIR:  
12410  3374             		; If the direction counter has not reached 0, 
12411  3374             		; jump ahead to decrement it and return
12412  3374 DD 7E 16    		ld      a,(ix+22)
12413  3377 FE 00               cp      0
12414  3379 20 12               jr      nz,l3332
12415  337B                     
12416  337B             		; Reset the direction counter to 43
12417  337B DD 36 16 2B         ld      (ix+22),43
12418  337F                     
12419  337F                     ; Make the fireball stand still
12420  337F DD 36 0D 00         ld      (ix+13),0
12421  3383                     
12422  3383                     ; 50% chance of jumping ahead and keep moving in the
12423  3383             		; same direction until the direction counter reaches
12424  3383             		; 0 again
12425  3383 3A 18 60            ld      a,(RANDOM_NUMBER)
12426  3386 0F                  rrca    
12427  3387 30 04               jr      nc,l3332
12428  3389                     
12429  3389             ;        ; If the fireball is moving right,
12430  3389             ;        ; jump ahead
12431  3389             ;		; NOTE: Because the fireball was made to stand still up
12432  3389             ;		; above, this compare will always be non-zero, so the 
12433  3389             ;		; fireball will always end up moving right at this point.
12434  3389             ;		; This appears to be a bug, but some code could be shaved 
12435  3389             ;		; off here by just making the fireball move right without
12436  3389             ;		; affecting the game play
12437  3389             ;       ld      a,(ix+13)
12438  3389             ;        cp      1
12439  3389             ;        jp      z,l3336
12440  3389             ;        
12441  3389             		; Make the fireball move right
12442  3389 DD 36 0D 01         ld      (ix+13),1
12443  338D             		
12444  338D             		; Decrement the direction counter
12445  338D DD 35 16    l3332:  dec     (ix+22)
12446  3390 C9                  ret     
12447  3391             		
12448  3391             ;		; Make the fireball move left
12449  3391             ;		; NOTE: Execution will never reach here
12450  3391             ;l3336:  ld      (ix+13),2
12451  3391             ;
12452  3391             ;		; Jump back up to decrement the direction counter and return
12453  3391             ;        jp      l3332
12454  3391             ;------------------------------------------------------------------------------
12455  3391             
12456  3391             
12457  3391             
12458  3391             ;------------------------------------------------------------------------------
12459  3391             ; This functions checks if the fireball is standing on the top or bottom of a
12460  3391             ; ladder.  If so and the fireball can get closer to Mario by climbing the
12461  3391             ; ladder, then it will take it; otherwise, the ladder will be ignored.
12462  3391             ;
12463  3391             ; This function also makes the fireball continue climbing a ladder if one is 
12464  3391             ; currently being climbed.
12465  3391             L_HANDLE_FIREBALLS_AND_LADDERS:  
12466  3391             		; If the fireball is moving up, jump ahead
12467  3391 DD 7E 0D    		ld      a,(ix+13)					; Fireball direction
12468  3394 FE 08               cp      8
12469  3396 28 27               jr      z,l3371
12470  3398             		
12471  3398             		; If the fireball is moving down, jump ahead
12472  3398 FE 04               cp      4
12473  339A 28 3C               jr      z,l338a
12474  339C             		
12475  339C             		; Return if the fireball is attempting to move above
12476  339C             		; the top platform
12477  339C             		; This prevents the fireball from 
12478  339C             		; climbing the escape ladders, I believe
12479  339C CD EF 33            call    L_ABORT_IF_FIREBALL_TOO_HIGH
12480  339F             		
12481  339F                     ; Check if the fireball is on a ladder
12482  339F                     ; a will be 0 if at the bottom, 1 if at the top
12483  339F                     ; This function will be aborted if no ladder
12484  339F DD 7E 0F            ld      a,(ix+15)					; Next intended y coordinate
12485  33A2 C6 08               add     a,8
12486  33A4 57                  ld      d,a
12487  33A5 DD 7E 0E            ld      a,(ix+14)					; Next intended x coordinate
12488  33A8 CD 46 24            call    L_CHECK_IF_ON_LADDER
12489  33AB             		
12490  33AB             		; If the fireball is at the bottom of a ladder,
12491  33AB             		; jump ahead
12492  33AB A7                  and     a
12493  33AC 28 39               jr      z,l3399
12494  33AE             		
12495  33AE             		; The fireball is at the top of a ladder
12496  33AE             		; Save the coordinate of the bottom of the ladder
12497  33AE DD 70 1F            ld      (ix+31),b
12498  33B1             		
12499  33B1             		; Return (don't climb down) if the fireball is below Mario
12500  33B1 3A 05 62            ld      a,(MARIO_Y)
12501  33B4 47                  ld      b,a
12502  33B5 DD 7E 0F            ld      a,(ix+15)					; The next intended y coordinate
12503  33B8 90                  sub     b
12504  33B9 D0                  ret     nc
12505  33BA             		
12506  33BA             		; Mark the fireball as moving down
12507  33BA DD 36 0D 04         ld      (ix+13),4					; Direction
12508  33BE C9                  ret     
12509  33BF             
12510  33BF             		
12511  33BF             		
12512  33BF             		; The fireball is moving up
12513  33BF             		; If the fireball has not reached the top of the ladder 
12514  33BF             		; being climbed, return
12515  33BF DD 7E 0F    l3371:  ld      a,(ix+15)					; Next intended y coordinate
12516  33C2 C6 08               add     a,8
12517  33C4 DD 46 1F            ld      b,(ix+31)
12518  33C7 B8                  cp      b
12519  33C8 C0                  ret     nz
12520  33C9             		
12521  33C9             		; Mark the fireball as standing still
12522  33C9 DD 36 0D 00         ld      (ix+13),0					; Direction
12523  33CD             		
12524  33CD             		; Return if the fireball is not paused (standing without moving)
12525  33CD DD 7E 19            ld      a,(ix+25)
12526  33D0 FE 02               cp      2
12527  33D2 C0                  ret     nz
12528  33D3             		
12529  33D3             		; Mark the fireball as paused
12530  33D3 DD 36 1D 01         ld      (ix+29),1
12531  33D7 C9                  ret     
12532  33D8             		
12533  33D8             		
12534  33D8             		
12535  33D8             		; The fireball is moving down
12536  33D8             		; If the fireball has not reached the bottom of the ladder
12537  33D8             		; being climbed, return
12538  33D8 DD 7E 0F    l338a:  ld      a,(ix+15)
12539  33DB C6 08               add     a,8
12540  33DD DD 46 1F            ld      b,(ix+31)
12541  33E0 B8                  cp      b
12542  33E1 C0                  ret     nz
12543  33E2             		
12544  33E2             		; Mark the fireball as standing still
12545  33E2 DD 36 0D 00         ld      (ix+13),0
12546  33E6 C9                  ret     
12547  33E7             		
12548  33E7             		
12549  33E7             		
12550  33E7             		; The fireball is at the bottom of a ladder
12551  33E7             		; Record the y coordinate of the top of the ladder
12552  33E7 DD 70 1F    l3399:  ld      (ix+31),b
12553  33EA             
12554  33EA             		; Mark the fireball as moving up
12555  33EA DD 36 0D 08         ld      (ix+13),8
12556  33EE C9                  ret     
12557  33EF             ;------------------------------------------------------------------------------
12558  33EF             
12559  33EF             
12560  33EF             
12561  33EF             ;------------------------------------------------------------------------------
12562  33EF             ; This function checks if the current fireball is attempting to move too high
12563  33EF             ; on the barrels, mixer, or elevators stages.  If the fireball attempts to move
12564  33EF             ; onto the top platform, 
12565  33EF             ; passed:	ix - pointer to the fireball structure to process
12566  33EF             ; return:	none
12567  33EF             L_ABORT_IF_FIREBALL_TOO_HIGH:  
12568  33EF             		; Return unless this is the barrels stage, mixer stage, or elevators stage
12569  33EF 3E 07       		ld      a,%00000111
12570  33F1 F7                  rst     $30			
12571  33F2             		
12572  33F2             		; Return if the fireball is not trying to move onto the top
12573  33F2             		; platform on the stage
12574  33F2 DD 7E 0F            ld      a,(ix+15)
12575  33F5 FE 59               cp      89
12576  33F7 D0                  ret     nc
12577  33F8             		
12578  33F8             		; If the fireball is trying to move onto the top platform on the stage,
12579  33F8             		; return from the calling function
12580  33F8 E1                  pop		hl
12581  33F9 C9                  ret     
12582  33FA             ;------------------------------------------------------------------------------
12583  33FA             
12584  33FA             
12585  33FA             
12586  33FA             ;------------------------------------------------------------------------------
12587  33FA             ; This function updates the fireball's position while it is walking
12588  33FA             ; The fireball is forced to follow the contours of the platforms on the barrels
12589  33FA             ; stage
12590  33FA             L_UPDATE_FIREBALL_WALK:  
12591  33FA             		; If the fireball is moving right, jump ahead
12592  33FA DD 7E 0D    		ld      a,(ix+13)					; Direction
12593  33FD FE 01               cp      1
12594  33FF 28 24               jr      z,l33d9
12595  3401             		
12596  3401             		; The fireball is moving left
12597  3401             		; Face the fireball to the left
12598  3401 DD 7E 07            ld      a,(ix+7)					; Sprite image
12599  3404 E6 7F               and     %01111111					; Clear the flipped bit
12600  3406 DD 77 07            ld      (ix+7),a					; Sprite image
12601  3409             		
12602  3409             		; Move the fireball 1 pixel to the left
12603  3409 DD 35 0E            dec     (ix+14)						; Next intended x coordinate
12604  340C             		
12605  340C             		; Update the sprite image
12606  340C CD 52 34    l33c0:  call    L_UPDATE_FIREBALL_SPRITE
12607  340F             
12608  340F             		; If the current stage is not the barrels,
12609  340F             		; return
12610  340F             L_HANDLE_BARREL_PLATS:  
12611  340F 3A 27 62    		ld      a,(CURRENT_STAGE)
12612  3412 FE 01               cp      STAGE_BARRELS
12613  3414 C0                  ret     nz
12614  3415             		
12615  3415             		; Make the fireball move along the platforms
12616  3415 DD 66 0E            ld      h,(ix+14)					; Next intended x coordinate
12617  3418 DD 6E 0F            ld      l,(ix+15)					; Next intended y coordinate
12618  341B DD 46 0D            ld      b,(ix+13)					; Direction
12619  341E CD 13 24            call    L_MOVE_SPRITE_ALONG_PLAT
12620  3421 DD 75 0F            ld      (ix+15),l					; Next intended y corodinate
12621  3424 C9                  ret     
12622  3425             		
12623  3425             		; The fireball is moving right
12624  3425             		; Face the fireball to the right
12625  3425 DD 7E 07    l33d9:  ld      a,(ix+7)					; Sprite image
12626  3428 F6 80               or      %10000000					; Set the flipped bit
12627  342A DD 77 07            ld      (ix+7),a					; Sprite image
12628  342D             		
12629  342D             		; Move the fireball 1 pixel to the right
12630  342D DD 34 0E            inc     (ix+14)						; Next intended x coordinate
12631  3430             		
12632  3430             		; Jump back up to continue updating the fireball's position
12633  3430 18 DA               jr      l33c0
12634  3432             ;------------------------------------------------------------------------------
12635  3432             
12636  3432             
12637  3432             
12638  3432             ;------------------------------------------------------------------------------
12639  3432             ; This function moves the fireball up or down the current ladder
12640  3432             ; (depending, of course, on which direction the fireball is climbing)
12641  3432             ; It does not check if the fireball has reached the top or bottom of the
12642  3432             ; ladder - this is handled elsewhere
12643  3432             ; passed:	ix - pointer to the current fireball
12644  3432             L_UPDATE_FIREBALL_CLIMB:  
12645  3432             		; Update the fireball's sprite image
12646  3432 CD 52 34    		call    L_UPDATE_FIREBALL_SPRITE
12647  3435             		
12648  3435             		; If the fireball is moving down
12649  3435 DD 7E 0D            ld      a,(ix+13)					; Direction
12650  3438 FE 08               cp      8
12651  343A 20 12               jr      nz,l3405
12652  343C             		
12653  343C             		; If the ladder climb counter has not reached 0,
12654  343C             		; jump ahead to decrement it and return
12655  343C DD 7E 14            ld      a,(ix+20)					; Climb update counter
12656  343F A7                  and     a
12657  3440 20 08               jr      nz,l3401
12658  3442             		
12659  3442             		; Reset the sprite update counter to 2
12660  3442 DD 36 14 02         ld      (ix+20),2					; Climb update counter
12661  3446             		
12662  3446             		; Move the fireball up 1 pixel
12663  3446 DD 35 0F            dec     (ix+15)						; Y coordinate
12664  3449 C9                  ret     
12665  344A             		
12666  344A             		; Decrement the ladder climb counter
12667  344A DD 35 14    l3401:  dec     (ix+20)						; Climb update counter
12668  344D C9                  ret    
12669  344E             		
12670  344E             		; Move the fireball down 1 pixel
12671  344E DD 34 0F    l3405:  inc     (ix+15)						; Y coordinate
12672  3451 C9                  ret     
12673  3452             ;------------------------------------------------------------------------------
12674  3452             
12675  3452             
12676  3452             
12677  3452             ;------------------------------------------------------------------------------
12678  3452             ; This function updates the fireball sprite image, cycling it periodically 
12679  3452             ; between the two sprite images for the fireball (either $3d and $3e, or $4d 
12680  3452             ; and $4e)
12681  3452             ; passed:	ix - pointer to the fireball to process
12682  3452             L_UPDATE_FIREBALL_SPRITE:  
12683  3452             		; If the sprite update counter has not reached 0,
12684  3452             		; jump ahead to decrement it and return
12685  3452 DD 7E 15    		ld      a,(ix+21)					; The sprite update counter
12686  3455 A7                  and     a
12687  3456 20 18               jr      nz,l3428
12688  3458                     
12689  3458             		; Reset the sprite update counter to 2
12690  3458 DD 36 15 02 		ld      (ix+21),2					; The sprite update counter
12691  345C                     
12692  345C             		; Advance the sprite number
12693  345C DD 34 07    		inc     (ix+7)						; The sprite number
12694  345F             		
12695  345F             		; If the sprite does not need to be wrapped,
12696  345F             		; return
12697  345F DD 7E 07            ld      a,(ix+7)					; The sprite number
12698  3462 E6 0F               and     %00001111
12699  3464 FE 0F               cp      $0f
12700  3466 C0                  ret     nz
12701  3467             		
12702  3467             		; Wrap the fireball sprite to the first of the two sprite
12703  3467             		; images (either $3d or $4d)
12704  3467 DD 7E 07            ld      a,(ix+7)					; The sprite number
12705  346A EE 02               xor     %00000010
12706  346C DD 77 07            ld      (ix+7),a					; The sprite number
12707  346F C9                  ret     
12708  3470             
12709  3470             		; Decrement the sprite update counter
12710  3470 DD 35 15    l3428:  dec     (ix+21)						; The sprite update counter
12711  3473 C9                  ret     
12712  3474             ;------------------------------------------------------------------------------
12713  3474             
12714  3474             
12715  3474             
12716  3474             ;------------------------------------------------------------------------------
12717  3474             ; This function initializes the current fireball for the barrels stage
12718  3474             ; passed:	ix - pointer to the fireball structure to process
12719  3474             L_INIT_FIREBALL_BARRELS:  
12720  3474             		; If the oil barrel jump pointer has not been set,
12721  3474             		; jump ahead to initialize it
12722  3474 DD 6E 1A    		ld      l,(ix+26)					; Oil barrel jump pointer
12723  3477 DD 66 1B            ld      h,(ix+27)					; Oil barrel jump pointer
12724  347A AF                  xor     a							; Clear the carry flag
12725  347B 01 00 00            ld      bc,0
12726  347E ED 4A               adc     hl,bc
12727  3480 20 07               jr      nz,l3442
12728  3482             		
12729  3482             		; Set the oil barrel jump pointer to the beginning of the table
12730  3482 21 9D 3A            ld      hl,L_OIL_BARREL_JUMP_TABLE_BARRELS
12731  3485             		
12732  3485             		; Initialize the fireball's x coordinate to 38
12733  3485 DD 36 03 26         ld      (ix+3),38
12734  3489             
12735  3489             		; Move the fireball right 1 pixel
12736  3489 DD 34 03    l3442:  inc     (ix+3)
12737  348C             		
12738  348C             		; If the end of the oil barrel jump table has been reached,
12739  348C             		; jump ahead to finish initializing the fireball
12740  348C 7E          l3445:  ld      a,(hl)
12741  348D FE AA               cp      $aa							; End of data
12742  348F 28 0B               jr      z,l3456
12743  3491             		
12744  3491             		; Update the fireball's y coordinate
12745  3491 DD 77 05            ld      (ix+5),a
12746  3494             		
12747  3494             		; Advance to the next entry in the oil barrel jump table
12748  3494 23                  inc     hl
12749  3495 DD 75 1A            ld      (ix+26),l
12750  3498 DD 74 1B            ld      (ix+27),h
12751  349B C9                  ret     
12752  349C             		
12753  349C             		; The end of the oil barrel jump table has been reached
12754  349C             		; Initialize the fireball's data
12755  349C AF          l3456:  xor     a
12756  349D DD 77 13            ld      (ix+19),a					; Bob table index
12757  34A0 DD 77 18            ld      (ix+24),a					; The fireball has now been initialized
12758  34A3 DD 77 0D            ld      (ix+13),a					; The fireball is standing still
12759  34A6 DD 77 1C            ld      (ix+28),a					; The fireball is not paused
12760  34A9             
12761  34A9             		; Next intended x and y coordinates equal the current 
12762  34A9             		; x and y coordinates
12763  34A9 DD 7E 03            ld      a,(ix+3)					
12764  34AC DD 77 0E            ld      (ix+14),a
12765  34AF DD 7E 05            ld      a,(ix+5)
12766  34B2 DD 77 0F            ld      (ix+15),a
12767  34B5             		
12768  34B5             		; Clear the oil barrel jump table pointer
12769  34B5 DD 36 1A 00         ld      (ix+26),0
12770  34B9 DD 36 1B 00         ld      (ix+27),0
12771  34BD C9                  ret     
12772  34BE             ;------------------------------------------------------------------------------
12773  34BE             
12774  34BE             
12775  34BE             
12776  34BE             ;------------------------------------------------------------------------------
12777  34BE             ; This function initializes the current fireball for the mixer stage
12778  34BE             ; passed:	ix - pointer to the fireball structure to process
12779  34BE             L_INIT_FIREBALL_MIXER:  
12780  34BE             		; If the oil barrel jump pointer has already been initialized,
12781  34BE             		; jump ahead to skip initializing it
12782  34BE DD 6E 1A    		ld      l,(ix+26)					; Oil barrel jump index
12783  34C1 DD 66 1B            ld      h,(ix+27)					; Oil barrel jump index
12784  34C4 AF                  xor     a
12785  34C5 01 00 00            ld      bc,0
12786  34C8 ED 4A               adc     hl,bc
12787  34CA 20 12               jr      nz,l349a
12788  34CC             		
12789  34CC             		; Initialize the oil barrel jump pointer to the start of the table
12790  34CC 21 BD 3A            ld      hl,L_OIL_BARREL_JUMP_TABLE_MIXER
12791  34CF             		
12792  34CF             		; If Mario is on the left side of the screen, 
12793  34CF             		; jump ahead
12794  34CF 3A 03 62            ld      a,(MARIO_X)
12795  34D2 CB 7F               bit     7,a
12796  34D4 28 14               jr      z,l34a8
12797  34D6             		
12798  34D6             		; Mario is on the right side of the screen
12799  34D6             		; Mark the fireball as moving right
12800  34D6 DD 36 0D 01         ld      (ix+13),1
12801  34DA             		
12802  34DA             		; Fireball x coordinate starts at 126
12803  34DA DD 36 03 7E         ld      (ix+3),126
12804  34DE             		
12805  34DE             		; If the fireball is moving left,
12806  34DE             		; jump ahead
12807  34DE DD 7E 0D    l349a:  ld      a,(ix+13)
12808  34E1 FE 01               cp      1
12809  34E3 20 0F               jr      nz,l34b3
12810  34E5             		
12811  34E5             		; Move the fireball 1 pixel right
12812  34E5 DD 34 03            inc     (ix+3)
12813  34E8             		
12814  34E8             		; Jump up to the barrels stage initialization function
12815  34E8             		; to continue the oil barrel jump processing
12816  34E8 18 A2               jr      l3445
12817  34EA             		
12818  34EA             		; Mark the fireball as moving left
12819  34EA DD 36 0D 02 l34a8:  ld      (ix+13),2
12820  34EE             
12821  34EE             		; Fireball x coordinate starts at 128
12822  34EE DD 36 03 80         ld      (ix+3),128
12823  34F2             		
12824  34F2             		; Jump back up to continue the oil barrel jump processing
12825  34F2 18 EA               jr      l349a
12826  34F4             		
12827  34F4             		; Move the fireball 1 pixel left
12828  34F4 DD 35 03    l34b3:  dec     (ix+3)
12829  34F7             
12830  34F7             		; Jump up to the barrels stage initialization function
12831  34F7             		; to continue the oil barrel jump processing
12832  34F7 18 93               jr      l3445
12833  34F9             ;------------------------------------------------------------------------------
12834  34F9             
12835  34F9             
12836  34F9             
12837  34F9             ;------------------------------------------------------------------------------
12838  34F9             ; Initialize the fireball on the rivets stage
12839  34F9             ; Place it in its initial position
12840  34F9             ; passed:	ix - the address of the current fireball
12841  34F9             L_INIT_FIREBALL_RIVETS:  
12842  34F9             		; If the current stage is the elevators stage,
12843  34F9             		; return
12844  34F9             ;		; NOTE: This function is only called when the current stage
12845  34F9             ;		;		is elevators or rivets, so the rest of this function
12846  34F9             ;		;		is only run when on the rivets stage
12847  34F9 3E 0B       		ld		a,%00001011
12848  34FB F7          		rst		$30
12849  34FC             		
12850  34FC             		; If Mario is on the right side of the screen,
12851  34FC             		; jump ahead
12852  34FC 3A 03 62            ld      a,(MARIO_X)
12853  34FF CB 7F               bit     7,a
12854  3501 20 26               jr      nz,l34ed
12855  3503             		
12856  3503             		; Mario is on the left side of the screen
12857  3503             		; Pick a random starting location on the right side of
12858  3503             		; the screen
12859  3503 21 D5 3A            ld      hl,L_L_RIVET_SPAWN_COORDS
12860  3506 06 00       l34ca:  ld      b,0
12861  3508 3A 19 60            ld      a,(COUNTER_1)
12862  350B E6 06               and     %00000110
12863  350D 4F                  ld      c,a							; bc = random offset (multiple of 2)
12864  350E 09                  add     hl,bc						; hl = random coordinate
12865  350F             
12866  350F             		; Set the fireball's coordinate
12867  350F 7E                  ld      a,(hl)
12868  3510 DD 77 03            ld      (ix+3),a					; X coordinate
12869  3513 DD 77 0E            ld      (ix+14),a					; Next intended x coordinate
12870  3516 23                  inc     hl
12871  3517 7E                  ld      a,(hl)
12872  3518 DD 77 05            ld      (ix+5),a					; Y coordinate
12873  351B DD 77 0F            ld      (ix+15),a					; Next intended y coordinate
12874  351E             
12875  351E             		; Mark the fireball as standing still
12876  351E AF                  xor     a							; a = 0
12877  351F DD 77 0D            ld      (ix+13),a					; Fireball direction
12878  3522             		
12879  3522             		; Mark that the fireball has been initialized
12880  3522 DD 77 18            ld      (ix+24),a					; Not initialized
12881  3525                     
12882  3525             		; Clear the pause timer
12883  3525 DD 77 1C    		ld      (ix+28),a					; Pause timer
12884  3528 C9                  ret     
12885  3529             		
12886  3529             		; Mario is on the right side of the screen
12887  3529             		; Pick a random starting location on the left side of
12888  3529             		; the screen
12889  3529 21 E5 3A    l34ed:  ld      hl,L_R_RIVET_SPAWN_COORDS
12890  352C 18 D8               jr      l34ca
12891  352E             ;------------------------------------------------------------------------------
12892  352E             
12893  352E             
12894  352E             
12895  352E             ;------------------------------------------------------------------------------
12896  352E             ; Copy the data from the fireball data structures to the fireball sprites
12897  352E             L_UPDATE_FIREBALL_SPRITES:  
12898  352E 21 00 64    		ld      hl,FIREBALL_STRUCTS
12899  3531 11 D0 69            ld      de,FIREBALL_SPRITES
12900  3534 06 05               ld      b,5							; 5 fireballs
12901  3536             
12902  3536             		; If this fireball is not active,
12903  3536             		; jump ahead to skip
12904  3536 7E          l34fb:  ld      a,(hl)
12905  3537 A7                  and     a
12906  3538 28 1E               jr      z,l351e
12907  353A             		
12908  353A             		; Copy the x coordinate to the spirte
12909  353A 2C                  inc     l
12910  353B 2C                  inc     l
12911  353C 2C                  inc     l							; X coordinate
12912  353D 7E                  ld      a,(hl)
12913  353E 12                  ld      (de),a						; X coordinate
12914  353F             
12915  353F             		; Copy the sprite image number to the sprite
12916  353F 3E 04               ld      a,4
12917  3541 85                  add     a,l
12918  3542 6F                  ld      l,a							; Sprite image number
12919  3543 1C                  inc     e							; Sprite image number
12920  3544 7E                  ld      a,(hl)
12921  3545 12                  ld      (de),a
12922  3546             		
12923  3546             		; Copy the sprite palette to the sprite
12924  3546 2C                  inc     l							; Sprite palette number
12925  3547 1C                  inc     e							; Sprite palette number
12926  3548 7E                  ld      a,(hl)
12927  3549 12                  ld      (de),a
12928  354A             		
12929  354A             		; Copy the y coordinate to the sprite
12930  354A 2D                  dec     l
12931  354B 2D                  dec     l
12932  354C 2D                  dec     l							; Y coordinate
12933  354D 1C                  inc     e							; Y coordinate
12934  354E 7E                  ld      a,(hl)
12935  354F 12                  ld      (de),a
12936  3550             
12937  3550             		; Advance to the next fireball sprite 
12938  3550 13                  inc     de
12939  3551             		
12940  3551             		; Advance to the next fireball data structure
12941  3551 3E 1B       l3517:  ld      a,27
12942  3553 85                  add     a,l
12943  3554 6F                  ld      l,a
12944  3555             		
12945  3555             		; Process the next fireball data structure
12946  3555 10 DF               djnz    l34fb						; Next b
12947  3557 C9                  ret     
12948  3558             		
12949  3558             		; Advance to the next fireball data structure and sprite
12950  3558 3E 05       l351e:  ld      a,5
12951  355A 85                  add     a,l
12952  355B 6F                  ld      l,a
12953  355C 3E 04               ld      a,4
12954  355E 83                  add     a,e
12955  355F 5F                  ld      e,a
12956  3560             		
12957  3560             		; Jump back to process the next fireball
12958  3560 18 EF               jr      l3517
12959  3562             ;------------------------------------------------------------------------------
12960  3562             
12961  3562             
12962  3562             
12963  3562             ;------------------------------------------------------------------------------
12964  3562             ; Points table
12965  3562             ; Lists possible points values to award the player
12966  3562             L_POINT_AWARD_TABLE:  
12967  3562             		; .byte	$00, $00, $00	; Entry 0 (000000)
12968  3562             		
12969  3562                     ; .byte	$00, $01, $00	; Entry 1 (000100)
12970  3562             		
12971  3562             		; .byte	$00, $02, $00	; Entry 2 (000200)
12972  3562             		
12973  3562             		; .byte	$00, $03, $00	; Entry 3 (000300)
12974  3562             		
12975  3562             		; .byte	$00, $04, $00	; Entry 4 (000400)
12976  3562             		
12977  3562             		; .byte	$00, $05, $00	; Entry 5 (000500)
12978  3562             		
12979  3562             		; .byte	$00, $06, $00	; Entry 6 (000600)
12980  3562             		
12981  3562             		; .byte	$00, $07, $00	; Entry 7 (000700)
12982  3562             		
12983  3562             		; .byte	$00, $08, $00	; Entry 8 (000800)
12984  3562             		
12985  3562             		; .byte	$00, $09, $00	; Entry 9 (000900)
12986  3562             		
12987  3562             		; .byte	$00, $00, $00	; Entry 10 (001000)
12988  3562             		
12989  3562             		; .byte	$00, $10, $00	; Entry 11 (001100)
12990  3562             		
12991  3562             		; .byte	$00, $20, $00	; Entry 12 (001200)
12992  3562             		
12993  3562             		; .byte	$00, $30, $00	; Entry 13 (001300)
12994  3562             		
12995  3562             		; .byte	$00, $40, $00	; Entry 14 (001400)
12996  3562             		
12997  3562             		; .byte	$00, $50, $00	; Entry 15 (001500)
12998  3562             		
12999  3562             		; .byte	$00, $60, $00	; Entry 16 (001500)
13000  3562             		
13001  3562             		; .byte	$00, $70, $00	; Entry 17 (001700)
13002  3562             		
13003  3562             		; .byte	$00, $80, $00	; Entry 18 (001800)
13004  3562             		
13005  3562             		; .byte	$00, $90, $00	; Entry 19 (001900)
13006  3562 00          		.byte	$00	; Entry 0 (000000)
13007  3563             		
13008  3563 01                  .byte	$01	; Entry 1 (000100)
13009  3564             		
13010  3564 02          		.byte	$02	; Entry 2 (000200)
13011  3565             		
13012  3565 03          		.byte	$03	; Entry 3 (000300)
13013  3566             		
13014  3566 04          		.byte	$04	; Entry 4 (000400)
13015  3567             		
13016  3567 05          		.byte	$05	; Entry 5 (000500)
13017  3568             		
13018  3568 06          		.byte	$06	; Entry 6 (000600)
13019  3569             		
13020  3569 07          		.byte	$07	; Entry 7 (000700)
13021  356A             		
13022  356A 08          		.byte	$08	; Entry 8 (000800)
13023  356B             		
13024  356B 09          		.byte	$09	; Entry 9 (000900)
13025  356C             		
13026  356C 00          		.byte	$00	; Entry 10 (001000)
13027  356D             		
13028  356D 10          		.byte	$10	; Entry 11 (001100)
13029  356E             		
13030  356E 20          		.byte	$20	; Entry 12 (001200)
13031  356F             		
13032  356F 30          		.byte	$30	; Entry 13 (001300)
13033  3570             		
13034  3570 40          		.byte	$40	; Entry 14 (001400)
13035  3571             		
13036  3571 50          		.byte	$50	; Entry 15 (001500)
13037  3572             		
13038  3572 60          		.byte	$60	; Entry 16 (001500)
13039  3573             		
13040  3573 70          		.byte	$70	; Entry 17 (001700)
13041  3574             		
13042  3574 80          		.byte	$80	; Entry 18 (001800)
13043  3575             		
13044  3575 90          		.byte	$90	; Entry 19 (001900)
13045  3576             ;------------------------------------------------------------------------------
13046  3576             
13047  3576             
13048  3576             
13049  3576             ;------------------------------------------------------------------------------
13050  3576             ; Default high score data
13051  3576             ; "1ST  007650              "
13052  3576             L_DEFAULT_HIGH_SCORE_DATA:	
13053  3576             L_DEFAULT_HIGH_SCORE_DATA_1:
13054  3576 94 77       		.word	TILE_COORD(28,20)	; High score string coordinate
13055  3578             
13056  3578 01 23 24 10 		.byte 	$01, $23, $24, $10, $10, $00, $00, $07, $06, $05, $00, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10
13056  357C 10 00 00 07 
13056  3580 06 05 00 10 
13056  3584 10 10 10 10 
13056  3588 10 10 10 10 
13056  358C 10 10 10 10 
13056  3590 10 
13057  3591 3F          		.byte 	$3f		; End string
13058  3592             		
13059  3592 00          		.byte	$00		; High score player ID ($00 = not earned by any current player)
13060  3593             		
13061  3593 50          		.byte	$50		; High score (007650)
13062  3594 76          		.byte	$76
13063  3595 00          		.byte	$00
13064  3596             		
13065  3596 F4 76       		.word	TILE_COORD(23,20)	; High score coordinate (23, 20)
13066  3598             
13067  3598             ; 2ND  006100              "
13068  3598 96 77       		.word	TILE_COORD(28,22)	; High score string coordinate (28,22)
13069  359A             
13070  359A 02 1E 14 10 		.byte	$02, $1E, $14, $10, $10, $00, $00, $06, $01, $00, $00, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10
13070  359E 10 00 00 06 
13070  35A2 01 00 00 10 
13070  35A6 10 10 10 10 
13070  35AA 10 10 10 10 
13070  35AE 10 10 10 10 
13070  35B2 10 
13071  35B3 3F          		.byte	$3f		; End string
13072  35B4             		
13073  35B4 00          		.byte	$00		; High score player ID ($00 = not earned by any current player)
13074  35B5             		
13075  35B5 00          		.byte	$00		; High score (006100)
13076  35B6 61          		.byte	$61
13077  35B7 00          		.byte	$00
13078  35B8             		
13079  35B8 F6 76       		.word	TILE_COORD(23,22)	; High score coordinate (23,22)
13080  35BA             
13081  35BA             ; "3RD  005950              "
13082  35BA 98 77       		.word	TILE_COORD(28,24)	; High score string coordinate (28,24)
13083  35BC             
13084  35BC 03 22 14 10 		.byte	$03, $22, $14, $10, $10, $00, $00, $05, $09, $05, $00, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10
13084  35C0 10 00 00 05 
13084  35C4 09 05 00 10 
13084  35C8 10 10 10 10 
13084  35CC 10 10 10 10 
13084  35D0 10 10 10 10 
13084  35D4 10 
13085  35D5 3F          		.byte	$3f		; End string
13086  35D6             		
13087  35D6 00          		.byte	$00		; High score player ID ($00 = not earned by any current player)
13088  35D7             		
13089  35D7 50          		.byte	$50		; High score (005950)
13090  35D8 59          		.byte	$59
13091  35D9 00          		.byte	$00
13092  35DA             		
13093  35DA F8 76       		.word	TILE_COORD(23,24)	; High score coordinate (23, 24)
13094  35DC             		
13095  35DC             ; "4TH  005050              "
13096  35DC 9A 77       		.word	TILE_COORD(28,26) 	; High score string coordinate (28,26)
13097  35DE             		
13098  35DE 04 24 18 10 		.byte	$04, $24, $18, $10, $10, $00, $00, $05, $00, $05, $00, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10
13098  35E2 10 00 00 05 
13098  35E6 00 05 00 10 
13098  35EA 10 10 10 10 
13098  35EE 10 10 10 10 
13098  35F2 10 10 10 10 
13098  35F6 10 
13099  35F7 3F          		.byte	$3f		; End string
13100  35F8             		
13101  35F8 00          		.byte	$00		; High score player ID ($00 = not earned by any current player)
13102  35F9             		
13103  35F9 50          		.byte	$50		; High score (005050)
13104  35FA 50          		.byte	$50
13105  35FB 00          		.byte	$00
13106  35FC             
13107  35FC FA 76       		.word 	TILE_COORD(23,26) 	; High score coordinate (23,26)		
13108  35FE             
13109  35FE             ; "5TH  004300              "
13110  35FE 9C 77       		.word	TILE_COORD(28,28) 	; High score string coordinate (28, 28)
13111  3600             		
13112  3600 05 24 18 10 		.byte	$05, $24, $18, $10, $10, $00, $00, $04, $03, $00, $00, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10
13112  3604 10 00 00 04 
13112  3608 03 00 00 10 
13112  360C 10 10 10 10 
13112  3610 10 10 10 10 
13112  3614 10 10 10 10 
13112  3618 10 
13113  3619 3F          		.byte	$3f		; End string
13114  361A             		
13115  361A             		
13116  361A 00          		.byte	$00		; High score player ID ($00 = not earned by any current player)
13117  361B             				
13118  361B 00          		.byte	$00		; High score (004300)
13119  361C 43          		.byte	$43
13120  361D 00          		.byte	$00
13121  361E             		
13122  361E FC 76       		.word 	TILE_COORD(23,28) 	; High score coordinate (23, 28)		
13123  3620             ;------------------------------------------------------------------------------
13124  3620             
13125  3620             
13126  3620             
13127  3620             ;------------------------------------------------------------------------------
13128  3620             ; The following data is used on the high score initial entry screen to display
13129  3620             ; the letter selection box around $eac letter.  Each two byte pair is an x,y
13130  3620             ; coordinate.  
13131  3620             ; The MSB is the x coordinate and the LSB is the y coordinate.
13132  3620             ; Row 1
13133  3620 3B 5C       L_HS_LETTER_COORD_TABLE:	.word	$5c3b	; 'A' = (59,92)
13134  3622 4B 5C       		.word	$5c4b	; 'B' = (75,92)
13135  3624 5B 5C       		.word	$5c5b	; 'C' =
13136  3626 6B 5C       		.word	$5c6b	; 'D' =
13137  3628 7B 5C       		.word	$5c7b	; 'E' =
13138  362A 8B 5C       		.word	$5c8b	; 'F' =
13139  362C 9B 5C       		.word	$5c9b	; 'G' =
13140  362E AB 5C       		.word	$5cAb	; 'H' =
13141  3630 BB 5C       		.word	$5cBb	; 'I' =
13142  3632 CB 5C       		.word	$5cCb	; 'J' =
13143  3634             
13144  3634             ; Row 2
13145  3634 3B 6C       		.word	$6c3b	; 'K' =
13146  3636 4B 6C       		.word	$6c4b	; 'L' =
13147  3638 5B 6C       		.word	$6c5b	; 'M' =
13148  363A 6B 6C       		.word	$6c6b	; 'N' =
13149  363C 7B 6C       		.word	$6c7b	; 'O' =
13150  363E 8B 6C       		.word	$6c8b	; 'P' =
13151  3640 9B 6C       		.word	$6c9b	; 'Q' =
13152  3642 AB 6C       		.word	$6cAb	; 'R' =
13153  3644 BB 6C       		.word	$6cBb	; 'S' =
13154  3646 CB 6C       		.word	$6cCb	; 'T' =
13155  3648             
13156  3648             ; Row 3
13157  3648 3B 7C       		.word	$7c3b	; 'U' =
13158  364A 4B 7C       		.word	$7c4b	; 'V' =
13159  364C 5B 7C       		.word	$7c5b	; 'W' =
13160  364E 6B 7C       		.word	$7c6b	; 'X' =
13161  3650 7B 7C       		.word	$7c7b	; 'Y' =
13162  3652 8B 7C       		.word	$7c8b	; 'Z' =
13163  3654 9B 7C       		.word	$7c9b	; '.' =
13164  3656 AB 7C       		.word	$7cAb	; '-' =
13165  3658 BB 7C       		.word	$7cBb	; 'RUB' =
13166  365A CB 7C       		.word	$7cCb	; 'END' =
13167  365C             ;------------------------------------------------------------------------------
13168  365C             
13169  365C             		
13170  365C             ;------------------------------------------------------------------------------
13171  365C             ; String table
13172  365C             ; Strings are looked up by index number and a memory location is returned 
13173  365C             L_STRING_TABLE:	
13174  365C 9C 36       		.word	L_GAME_OVER_STRING_DATA 	; 0 = "GAME OVER"
13175  365E 01 00       		.word	1 		; unused
13176  3660 A9 36       		.word	L_PLAYER_1_STRING_DATA 	; 2 = "PLAYER (I)"
13177  3662 B6 36       		.word	L_PLAYER_2_STRING_DATA 	; 3 = "PLAYER (II)"
13178  3664 C3 36       		.word	L_HIGH_SCORE_STRING_DATA 	; 4 = "HIGH SCORE"
13179  3666 D0 36       		.word	L_CREDIT_STRING_DATA 	; 5 = "CREDIT    "
13180  3668 06 00       		.word	6 		; unused
13181  366A DD 36       		.word	L_HOW_HIGH_STRING_DATA 	; 7 = "HOW HIGH CAN YOU GET ? "
13182  366C 08 00       		.word	8 		; unused
13183  366E F7 36       		.word	L_ONLY_1_STRING_DATA 	; 9 = "ONLY 1 PlAYER BUTTON"
13184  3670 0E 37       		.word	L_1_OR_2_STRING_DATA 	; 10 = "1 OR 2 PLAYERS BUTTON"
13185  3672 0B 00       		.word	11		; unused
13186  3674 26 37       		.word	L_PUSH_STRING_DATA 	; 12 = "PUSH"
13187  3676 2D 37       		.word	L_REGIS_STRING_DATA 	; 13 = "NAME REGISTRATION"
13188  3678 41 37       		.word	L_NAME_STRING_DATA 	; 14 = "NAME:"
13189  367A 49 37       		.word	L_UNDERLINE_STRING_DATA 	; 15 = "---         "
13190  367C 58 37       		.word	L_A_TO_J_STRING_DATA 	; 16 = "A B C D E F G H I J"
13191  367E 6E 37       		.word	L_K_TO_T_STRING_DATA 	; 17 = "K L M N O P Q R S T"
13192  3680 84 37       		.word	L_U_TO_END_STRING_DATA 	; 18 = "U V W X Y Z . -RUBEND "
13193  3682 9C 37       		.word	L_REGI_TIME_STRING_DATA 	; 19 = "REGI TIME  (30) "
13194  3684 00 61       		.word	HIGH_SCORE_TABLE_ENTRY_1 ; 20 = HIGH_SCORE_TABLE_ENTRY_1
13195  3686 22 61       		.word	HIGH_SCORE_TABLE_ENTRY_2 ; 21 = HIGH_SCORE_TABLE_ENTRY_2
13196  3688 44 61       		.word	HIGH_SCORE_TABLE_ENTRY_3 ; 22 = HIGH_SCORE_TABLE_ENTRY_3
13197  368A 66 61       		.word	HIGH_SCORE_TABLE_ENTRY_4 ; 23 = HIGH_SCORE_TABLE_ENTRY_4
13198  368C 88 61       		.word	HIGH_SCORE_TABLE_ENTRY_5 ; 24 = HIGH_SCORE_TABLE_ENTRY_5
13199  368E AF 37       		.word	l379e 	; 25 = "RANK  SCORE  NAME    "
13200  3690 C7 37       		.word	l37b6 	; 26 = "YOUR NAME WAS REGISTERED."
13201  3692 E3 37       		.word	l37d2 	; 27 = "INSERT COIN "
13202  3694 F2 37       		.word	l37e1 	; 28 = "  PLAYER    COIN"
13203  3696 88 3F       		.word	L_PLUS_STRING_DATA	; 29 = "PLUS!"
13204  3698 90 3F       		.word	L_1981_STRING_DATA 	; 30 = "1981"
13205  369A 99 3F       		.word	L_NINTENDO_STRING_DATA 	; 31 = "NINTENDO OF AMERICA"
13206  369C             ;------------------------------------------------------------------------------
13207  369C             
13208  369C             
13209  369C             
13210  369C             ;------------------------------------------------------------------------------
13211  369C             ; Static strings
13212  369C             ; "GAME  OVER" 
13213  369C             L_GAME_OVER_STRING_DATA: 	
13214  369C 96 76       		.word	TILE_COORD(20,22) 	; (20, 22) 
13215  369E 17 11 1D 15 		.byte	$17, $11, $1d, $15, $10, $10, $1f, $26, $15, $22
13215  36A2 10 10 1F 26 
13215  36A6 15 22 
13216  36A8 3F          		.byte	$3f		; End string
13217  36A9             		
13218  36A9             ; "PLAYER (I)" 
13219  36A9             L_PLAYER_1_STRING_DATA: 	
13220  36A9 94 76       		.word	TILE_COORD(20,20) 	; (20, 20)
13221  36AB 20 1C 11 29 		.byte	$20, $1C, $11, $29, $15, $22, $10, $30, $32, $31
13221  36AF 15 22 10 30 
13221  36B3 32 31 
13222  36B5 3F          		.byte	$3F
13223  36B6             				
13224  36B6             ; "PLAYER (II)"
13225  36B6             L_PLAYER_2_STRING_DATA: 	
13226  36B6 94 76       		.word   TILE_COORD(20,20)	; (20, 20)
13227  36B8 20 1C 11 29 		.byte	$20, $1C, $11, $29, $15, $22, $10, $30, $33, $31
13227  36BC 15 22 10 30 
13227  36C0 33 31 
13228  36C2 3F          		.byte	$3F
13229  36C3             				
13230  36C3             ; "HIGH SCORE" 
13231  36C3             L_HIGH_SCORE_STRING_DATA: 	
13232  36C3 80 76       		.word   TILE_COORD(20,0)	; (20, 0)  
13233  36C5 18 19 17 18 		.byte	$18, $19, $17, $18, $10, $23, $13, $1F, $22, $15
13233  36C9 10 23 13 1F 
13233  36CD 22 15 
13234  36CF 3F          		.byte	$3F
13235  36D0             				
13236  36D0             ; "CREDIT    "
13237  36D0             L_CREDIT_STRING_DATA: 	
13238  36D0 9F 75       		.word   TILE_COORD(12,31) 	; (12, 31)
13239  36D2 13 22 15 14 		.byte	$13, $22, $15, $14, $19, $24, $10, $10, $10, $10
13239  36D6 19 24 10 10 
13239  36DA 10 10 
13240  36DC 3F          		.byte	$3F
13241  36DD             				
13242  36DD             ; "HOW HIGH CAN YOU GET ? "
13243  36DD             L_HOW_HIGH_STRING_DATA: 	
13244  36DD 5E 77       		.word   TILE_COORD(26,30)	; (25, 31)
13245  36DF 18 1F 27 10 		.byte	$18, $1F, $27, $10, $18, $19, $17, $18, $10, $13, $11, $1E, $10, $29, $1F, $25, $10, $17, $15, $24, $10, $FB, $10
13245  36E3 18 19 17 18 
13245  36E7 10 13 11 1E 
13245  36EB 10 29 1F 25 
13245  36EF 10 17 15 24 
13245  36F3 10 FB 10 
13246  36F6 3F          		.byte	$3F
13247  36F7             				
13248  36F7             ; "ONLY 1 PlAYER BUTTON"
13249  36F7             L_ONLY_1_STRING_DATA: 	
13250  36F7 29 77       		.word   TILE_COORD(25,9)	; (25, 9)
13251  36F9 1F 1E 1C 29 		.byte	$1F, $1E, $1C, $29, $10, $01, $10, $20, $1C, $11, $29, $15, $22, $10, $12, $25, $24, $24, $1F, $1E
13251  36FD 10 01 10 20 
13251  3701 1C 11 29 15 
13251  3705 22 10 12 25 
13251  3709 24 24 1F 1E 
13252  370D 3F          		.byte	$3F
13253  370E             				
13254  370E             ; "1 OR 2 PLAYERS BUTTON"
13255  370E             L_1_OR_2_STRING_DATA: 	
13256  370E 29 77       		.word   TILE_COORD(25,9)	; (25, 9)
13257  3710 01 10 1F 22 		.byte	$01, $10, $1F, $22, $10, $02, $10, $20, $1C, $11, $29, $15, $22, $23, $10, $12, $25, $24, $24, $1F, $1E
13257  3714 10 02 10 20 
13257  3718 1C 11 29 15 
13257  371C 22 23 10 12 
13257  3720 25 24 24 1F 
13257  3724 1E 
13258  3725 3F          		.byte	$3F
13259  3726             				
13260  3726             ; "PUSH"
13261  3726             L_PUSH_STRING_DATA: 	
13262  3726 27 76       		.word   TILE_COORD(17,7)	; (17, 7)
13263  3728 20 25 23 18 		.byte	$20, $25, $23, $18
13264  372C 3F          		.byte	$3F
13265  372D             		
13266  372D             ; "NAME REGISTRATION"
13267  372D             L_REGIS_STRING_DATA: 	
13268  372D 06 77       		.word   TILE_COORD(24,6)	; (24, 6)
13269  372F 1E 11 1D 15 		.byte	$1E, $11, $1D, $15, $10, $22, $15, $17, $19, $23, $24, $22, $11, $24, $19, $1F, $1E
13269  3733 10 22 15 17 
13269  3737 19 23 24 22 
13269  373B 11 24 19 1F 
13269  373F 1E 
13270  3740 3F          		.byte	$3F
13271  3741             		
13272  3741             ; "NAME:"
13273  3741             L_NAME_STRING_DATA: 	
13274  3741 88 76       		.word   TILE_COORD(20,8)	; (20, 8)
13275  3743 1E 11 1D 15 		.byte	$1E, $11, $1D, $15, $2E
13275  3747 2E 
13276  3748 3F          		.byte	$3F
13277  3749             				
13278  3749             ; "---         " ('-''s are underlines)
13279  3749             L_UNDERLINE_STRING_DATA: 	
13280  3749 E9 75       		.word   TILE_COORD(15,9)	; (15, 9)
13281  374B 2D 2D 2D 10 		.byte	$2D, $2D, $2D, $10, $10, $10, $10, $10, $10, $10, $10, $10
13281  374F 10 10 10 10 
13281  3753 10 10 10 10 
13282  3757 3F          		.byte	$3F
13283  3758             				
13284  3758             ; "A B C D E F G H I J"
13285  3758             L_A_TO_J_STRING_DATA: 	
13286  3758 0B 77       		.word   TILE_COORD(24,11)	; (24, 11)
13287  375A 11 10 12 10 		.byte	$11, $10, $12, $10, $13, $10, $14, $10, $15, $10, $16, $10, $17, $10, $18, $10, $19, $10, $1A
13287  375E 13 10 14 10 
13287  3762 15 10 16 10 
13287  3766 17 10 18 10 
13287  376A 19 10 1A 
13288  376D 3F          		.byte	$3F
13289  376E             		
13290  376E             ; "K L M N O P Q R S T"
13291  376E             L_K_TO_T_STRING_DATA: 	
13292  376E 0D 77       		.word   TILE_COORD(24,13)	; (24, 13)
13293  3770 1B 10 1C 10 		.byte	$1B, $10, $1C, $10, $1D, $10, $1E, $10, $1F, $10, $20, $10, $21, $10, $22, $10, $23, $10, $24
13293  3774 1D 10 1E 10 
13293  3778 1F 10 20 10 
13293  377C 21 10 22 10 
13293  3780 23 10 24 
13294  3783 3F          		.byte	$3F
13295  3784             				
13296  3784             ; "U V W X Y Z . -RUBEND "
13297  3784             L_U_TO_END_STRING_DATA: 	
13298  3784 0F 77       		.word   TILE_COORD(24,15)	; (24, 15)
13299  3786 25 10 26 10 		.byte	$25, $10, $26, $10, $27, $10, $28, $10, $29, $10, $2A, $10, $2B, $10, $2C, $44, $45, $46, $47, $48, $10
13299  378A 27 10 28 10 
13299  378E 29 10 2A 10 
13299  3792 2B 10 2C 44 
13299  3796 45 46 47 48 
13299  379A 10 
13300  379B 3F          		.byte	$3F
13301  379C             				
13302  379C             ; "REGI TIME  (30) "
13303  379C             L_REGI_TIME_STRING_DATA: 	
13304  379C F2 76       		.word   TILE_COORD(23,18)	; (23, 18)
13305  379E 22 15 17 19 		.byte	$22, $15, $17, $19, $10, $24, $19, $1D, $15, $10, $10, $30, $03, $00, $31, $10
13305  37A2 10 24 19 1D 
13305  37A6 15 10 10 30 
13305  37AA 03 00 31 10 
13306  37AE 3F          		.byte	$3F
13307  37AF             				
13308  37AF             ; "RANK  SCORE  NAME    "
13309  37AF             l379e: 	
13310  37AF 92 77       		.word   TILE_COORD(28,18)	; (28, 18)
13311  37B1 22 11 1E 1B 		.byte	$22, $11, $1E, $1B, $10, $10, $23, $13, $1F, $22, $15, $10, $10, $1E, $11, $1D, $15, $10, $10, $10, $10
13311  37B5 10 10 23 13 
13311  37B9 1F 22 15 10 
13311  37BD 10 1E 11 1D 
13311  37C1 15 10 10 10 
13311  37C5 10 
13312  37C6 3F          		.byte	$3F
13313  37C7             		
13314  37C7             ; "YOUR NAME WAS REGISTERED."
13315  37C7             l37b6: 	
13316  37C7 72 77       		.word   TILE_COORD(27,18)	; (27, 18)
13317  37C9 29 1F 25 22 		.byte	$29, $1F, $25, $22, $10, $1E, $11, $1D, $15, $10, $27, $11, $23, $10, $22, $15, $17, $19, $23, $24, $15, $22, $15, $14, $42
13317  37CD 10 1E 11 1D 
13317  37D1 15 10 27 11 
13317  37D5 23 10 22 15 
13317  37D9 17 19 23 24 
13317  37DD 15 22 15 14 
13317  37E1 42 
13318  37E2 3F          		.byte	$3F
13319  37E3             		
13320  37E3             ; "INSERT COIN "
13321  37E3             l37d2: 	
13322  37E3 A7 76       		.word   TILE_COORD(21,7)	; (21, 7)
13323  37E5 19 1E 23 15 		.byte	$19, $1E, $23, $15, $22, $24, $10, $13, $1F, $19, $1E, $10
13323  37E9 22 24 10 13 
13323  37ED 1F 19 1E 10 
13324  37F1 3F          		.byte	$3F
13325  37F2             				
13326  37F2             ; "  PLAYER    COIN"
13327  37F2             l37e1: 	
13328  37F2 0A 77       		.word   TILE_COORD(24,10)	; (24, 10)
13329  37F4 10 10 20 1C 		.byte	$10, $10, $20, $1C, $11, $29, $15, $22, $10, $10, $10, $10, $13, $1F, $19, $1E
13329  37F8 11 29 15 22 
13329  37FC 10 10 10 10 
13329  3800 13 1F 19 1E 
13330  3804 3F          		.byte	$3F
13331  3805             				
13332  3805             ; " NINTENDO    "
13333  3805             l37f4: 	
13334  3805 FC 76       		.word   TILE_COORD(23,28)	; (23, 28)
13335  3807 49 4A 10 1E 		.byte	$49, $4A, $10, $1E, $19, $1E, $24, $15, $1E, $14, $1F, $10, $10, $10, $10
13335  380B 19 1E 24 15 
13335  380F 1E 14 1F 10 
13335  3813 10 10 10 
13336  3816 3F          		.byte	$3F
13337  3817             				
13338  3817             ; "1981"
13339  3817             l3806: 	
13340  3817 7C 75       		.word   TILE_COORD(11,28)	; (11, 28)
13341  3819 01 09 08 01 		.byte	$01, $09, $08, $01
13342  381D 3F          		.byte	$3F
13343  381E             ;------------------------------------------------------------------------------
13344  381E             
13345  381E             
13346  381E             ;------------------------------------------------------------------------------
13347  381E             ; Introduction stage data
13348  381E             ; (This is essentially the barrels level before Donkey Kong stomps and warps
13349  381E             ; it)
13350  381E             L_INTRO_STAGE_DATA: 	
13351  381E             		; Pauline's platform
13352  381E 02          		.byte	$02		; Barrels girders
13353  381F 97 38       		.word	$3897	; (18,7) offset 0
13354  3821 68 38       		.word	$3868	; (13,7) offset 0
13355  3823             
13356  3823             		; 5th platform		
13357  3823 02          		.byte	$02		; Barrels girders
13358  3824 DF 54       		.word	$54DF	; (27,10) offset 4
13359  3826 10 54       		.word	$5410	; (2,10) offset 4
13360  3828             		
13361  3828             		; 4th platform
13362  3828 02          		.byte	$02		; Barrels girders
13363  3829 EF 6D       		.word	$6DEF	; (29,13) offset 5
13364  382B 20 6D       		.word	$6D20	; (4,13) offset 5
13365  382D             		
13366  382D             		; 3rd platform
13367  382D 02          		.byte	$02		; Barrels girders
13368  382E DF 8E       		.word	$8EDF	; (27,17) offset 6
13369  3830 10 8E       		.word	$8E10	; (2,17) offset 6
13370  3832             		
13371  3832             		; 2nd platform
13372  3832 02          		.byte	$02		; Barrels girders
13373  3833 EF AF       		.word	$AFEF	; (29,21) offset 7
13374  3835 20 AF       		.word	$AF20	; (4,21) offset 7
13375  3837             		
13376  3837             		; 1st platform
13377  3837 02          		.byte	$02		; Barrels girders
13378  3838 DF D0       		.word	$D0DF	; (27,26) offset 0
13379  383A 10 D0       		.word	$D010	; (2,26) offset 0
13380  383C             
13381  383C             		; Floor		
13382  383C 02          		.byte	$02		; Barrels girders
13383  383D EF F1       		.word	$F1EF	; (29,30) offset 1
13384  383F 10 F1       		.word	$F110	; (4,30) offset 1
13385  3841             		
13386  3841 00          		.byte	$00		; Ladder
13387  3842 53 18       		.word	$1853	; (10,3) offset 0
13388  3844 53 54       		.word	$5453	; (10,10) offset 4
13389  3846             		
13390  3846 00          		.byte	$00		; Ladder
13391  3847 63 18       		.word	$1863	; (12,3) offset 0
13392  3849 63 54       		.word	$5463	; (12,10) offset 4
13393  384B             		
13394  384B 00          		.byte	$00		; Ladder
13395  384C 93 38       		.word	$3893	; (18,7) offset 0
13396  384E 93 54       		.word	$5493	; (18,10) offset 4
13397  3850             		
13398  3850 00          		.byte	$00		; Ladder
13399  3851 83 54       		.word	$5483	; (16,10) offset 4
13400  3853 83 F1       		.word	$F183	; (16,30) offset 1
13401  3855             		
13402  3855 00          		.byte	$00		; Ladder
13403  3856 93 54       		.word	$5493	; (18,10) offset 4
13404  3858 93 F1       		.word	$F193	; (18,30) offset 1
13405  385A             		
13406  385A AA          		.byte   $aa		; End of data
13407  385B             ;------------------------------------------------------------------------------
13408  385B             
13409  385B             
13410  385B             
13411  385B             ;------------------------------------------------------------------------------
13412  385B             ; The characters that make up the timer display
13413  385B             ;					|BONUS|
13414  385B             ;					|0000 |
13415  385B             ;					 -----
13416  385B             L_TIMER_BOX_TILE_DATA: 	
13417  385B 8D          		.byte   $8D     ; upper-right corner
13418  385C 7D          		.byte   $7D 	; right edge
13419  385D 8C          		.byte   $8C 	; lower-right corner
13420  385E 6F          		.byte   $6F 	; top edge
13421  385F 00          		.byte   $00 	; '0'
13422  3860 7C          		.byte   $7C 	; bottom edge
13423  3861 6E          		.byte   $6E 	; top edge
13424  3862 00          		.byte   $00 	; '0'
13425  3863 7C          		.byte   $7C 	; bottom edge
13426  3864 6D          		.byte   $6D 	; top edge
13427  3865 00          		.byte   $00 	; '0'
13428  3866 7C          		.byte   $7C 	; bottom edge
13429  3867 6C          		.byte   $6C 	; top edge
13430  3868 00          		.byte   $00 	; '0'
13431  3869 7C          		.byte   $7C 	; bottom edge
13432  386A 8F          		.byte   $8F 	; upper-left corner
13433  386B 7F          		.byte   $7F 	; left edge
13434  386C 8E          		.byte   $8E 	; lower-left corner
13435  386D             ;------------------------------------------------------------------------------
13436  386D             
13437  386D             
13438  386D             
13439  386D             ;------------------------------------------------------------------------------
13440  386D             ; Sprite data for Donkey Kong standing with his left arm raised
13441  386D             L_DK_SPRITES_L_ARM_RAISED:	
13442  386D 47          		.byte	$47		; DK front right leg 
13443  386E 27          		.byte	$27
13444  386F 08          		.byte	$08
13445  3870 50          		.byte	$50
13446  3871             		
13447  3871 2F          		.byte	$2F		; DK front left leg (flipped h.)
13448  3872 A7          		.byte	$A7 
13449  3873 08          		.byte	$08 
13450  3874 50          		.byte	$50 
13451  3875             		
13452  3875 3B          		.byte	$3B		; DK front chest
13453  3876 25          		.byte	$25 
13454  3877 08          		.byte	$08 
13455  3878 50          		.byte	$50 
13456  3879             		
13457  3879 00          		.byte	$00		; unused
13458  387A 70          		.byte	$70 
13459  387B 08          		.byte	$08 
13460  387C 48          		.byte	$48 
13461  387D             		
13462  387D 3B          		.byte	$3B		; DK front head
13463  387E 23          		.byte	$23		; Mouth closed 
13464  387F 07          		.byte	$07 
13465  3880 40          		.byte	$40 
13466  3881             		
13467  3881 46          		.byte	$46		; DK front left arm (flipped h.)
13468  3882 A9          		.byte	$A9		; ($29 - right arm lowered and curled)
13469  3883 08          		.byte	$08 
13470  3884 44          		.byte	$44 
13471  3885             		
13472  3885 00          		.byte	$00		; unused
13473  3886 70          		.byte	$70 
13474  3887 08          		.byte	$08 
13475  3888 48          		.byte	$48 
13476  3889             		
13477  3889 30          		.byte	$30		; DK front right arm
13478  388A 29          		.byte	$29 
13479  388B 08          		.byte	$08 
13480  388C 44          		.byte	$44 
13481  388D             		
13482  388D 00          		.byte	$00		; unused
13483  388E 70          		.byte	$70 
13484  388F 08          		.byte	$08 
13485  3890 48          		.byte	$48 
13486  3891             		
13487  3891 00          		.byte	$00		; unused
13488  3892 70          		.byte	$70 
13489  3893 0A          		.byte	$0A 
13490  3894 48          		.byte	$48 
13491  3895             ;------------------------------------------------------------------------------
13492  3895             
13493  3895             
13494  3895             
13495  3895             ;------------------------------------------------------------------------------
13496  3895             ; Sprite data for Pauline standing, facing right
13497  3895             L_PAULINE_SPRITES_FACE_RIGHT:	
13498  3895 6F          		.byte	111
13499  3896 10          		.byte	$10		; $10 (Pauline's head facing right) 
13500  3897 09          		.byte	$09 
13501  3898 23          		.byte	35 
13502  3899             		
13503  3899 6F          		.byte	111
13504  389A 11          		.byte	$11		; $11 (Pauline's body facing right) 
13505  389B 0A          		.byte	$0A 
13506  389C 33          		.byte	51 
13507  389D             ;------------------------------------------------------------------------------
13508  389D             
13509  389D             
13510  389D             
13511  389D             ;------------------------------------------------------------------------------
13512  389D             ; Sprite data for Donkey Kong climbing
13513  389D             L_DK_SPRITES_CLIMBING:	
13514  389D 50          		.byte	$50		; DK Left Arm
13515  389E 34          		.byte	$34 
13516  389F 08          		.byte	$08 
13517  38A0 3C          		.byte	$3C 
13518  38A1             		
13519  38A1 00          		.byte	$00		; DK Right Arm (hidden initially)
13520  38A2 35          		.byte	$35 
13521  38A3 08          		.byte	$08 
13522  38A4 3C          		.byte	$3C 
13523  38A5             		
13524  38A5 53          		.byte	$53		; DK Left Head
13525  38A6 32          		.byte	$32 
13526  38A7 08          		.byte	$08 
13527  38A8 40          		.byte	$40 
13528  38A9             		
13529  38A9 63          		.byte	$63		; DK Right Head
13530  38AA 33          		.byte	$33 
13531  38AB 08          		.byte	$08 
13532  38AC 40          		.byte	$40 
13533  38AD             		
13534  38AD 00          		.byte	$00		; 
13535  38AE 70          		.byte	$70 
13536  38AF 08          		.byte	$08 
13537  38B0 48          		.byte	$48 
13538  38B1             		
13539  38B1 53          		.byte	$53		; DK Left Leg
13540  38B2 36          		.byte	$36 
13541  38B3 08          		.byte	$08 
13542  38B4 50          		.byte	$50 
13543  38B5             		
13544  38B5 63          		.byte	$63		; DK Right Leg
13545  38B6 37          		.byte	$37 
13546  38B7 08          		.byte	$08 
13547  38B8 50          		.byte	$50 
13548  38B9             		
13549  38B9 6B          		.byte	$6B		; DK Right Arm carrying Pauline
13550  38BA 31          		.byte	$31 
13551  38BB 08          		.byte	$08 
13552  38BC 41          		.byte	$41 
13553  38BD             		
13554  38BD 00          		.byte	$00		; 
13555  38BE 70          		.byte	$70 
13556  38BF 08          		.byte	$08 
13557  38C0 48          		.byte	$48 
13558  38C1             		
13559  38C1 6A          		.byte	$6A		; Pauline being carried
13560  38C2 14          		.byte	$14 
13561  38C3 0A          		.byte	$0A 
13562  38C4 48          		.byte	$48 
13563  38C5             ;------------------------------------------------------------------------------
13564  38C5             
13565  38C5             
13566  38C5             
13567  38C5             ;------------------------------------------------------------------------------
13568  38C5             ; Data describing Donkey Kong's jump from the top of the ladders onto the top
13569  38C5             ; platform on the intro screen
13570  38C5             L_DK_JUMP_FROM_LADDER_DATA:	
13571  38C5 FD FD FD FD 		.byte	-3, -3, -3, -3, -3, -3, -3
13571  38C9 FD FD FD 
13572  38CC FE FE FE FE 		.byte	-2, -2, -2, -2, -2, -2
13572  38D0 FE FE 
13573  38D2 FF FF FF FF 		.byte	-1, -1, -1, -1
13574  38D6 00 00       		.byte	 0,  0
13575  38D8 01 01 01    		.byte	 1,  1,  1
13576  38DB 7F          		.byte	$7F 	; End of data
13577  38DC             ;------------------------------------------------------------------------------
13578  38DC             
13579  38DC             
13580  38DC             
13581  38DC             ;------------------------------------------------------------------------------
13582  38DC             ; Data describing Donkey Kong's jumps across the top platform in the intro
13583  38DC             ; screen
13584  38DC             L_DK_JUMP_ACROSS_PLAT_DATA:	
13585  38DC FF FF FF FF 		.byte	-1, -1, -1, -1, -1,  0, -1,  0
13585  38E0 FF 00 FF 00 
13586  38E4 00 01 00 01 		.byte	 0,  1,  0,  1,  1,  1,  1,  1
13586  38E8 01 01 01 01 
13587  38EC 7F          		.byte	$7f		; End of data
13588  38ED             
13589  38ED             ;------------------------------------------------------------------------------
13590  38ED             		
13591  38ED             		
13592  38ED             		
13593  38ED             ;------------------------------------------------------------------------------
13594  38ED             l38dc:	
13595  38ED             		; First set of deformation data
13596  38ED 04          		.byte	$04		; Blank tiles
13597  38EE 7F F0       		.word	$F07F	; (15,30)
13598  38F0 10 F0       		.word	$F010	; (2,30)
13599  38F2             		     
13600  38F2 02          		.byte	$02		; Barrel girders
13601  38F3 DF F2       		.word	$F2DF	; (27,30) offset 2
13602  38F5 70 F8       		.word	$F870	; (14,31) offset 0
13603  38F7             		
13604  38F7 02          		.byte	$02		; Barrel girders
13605  38F8 6F F8       		.word	$F86F	; (13,14) offset 0
13606  38FA 10 F8       		.word	$F810	; (2,14) offset 0
13607  38FC             		
13608  38FC AA          		.byte	$AA		; End of data
13609  38FD             		
13610  38FD             		
13611  38FD             		; Second set of deformation data
13612  38FD 04          		.byte	$04		; Blank tiles
13613  38FE DF D0       		.word	$D0DF	; (27,26)
13614  3900 90 D0       		.word	$D090	; 18,26)
13615  3902             		
13616  3902 02          		.byte	$02		; Barrel girders
13617  3903 DF DC       		.word	$DCDF	; (27,27) offset 4
13618  3905 20 D1       		.word	$D120	; (4,26) offset 1
13619  3907             		
13620  3907 AA          		.byte	$AA		; End of data
13621  3908             		
13622  3908 FF FF FF FF 		.byte	$FF, $FF, $FF, $FF, $FF	; Filler
13622  390C FF 
13623  390D             		
13624  390D             		
13625  390D             		; Third set of deformation data
13626  390D 04          		.byte	$04		; Blank tiles
13627  390E DF A8       		.word	$A8DF	; (27,21)
13628  3910 20 A8       		.word	$A820	; (4,21)
13629  3912             		
13630  3912 04          		.byte	$04		; Blank tiles
13631  3913 5F B0       		.word	$B05F	; (11,22)
13632  3915 20 B0       		.word	$B020	; (21,22)
13633  3917             		
13634  3917 02          		.byte	$02		; Barrel girders
13635  3918 DF B0       		.word	$B0DF	; (27,22) offset 0
13636  391A 20 BB       		.word	$BB20	; (21,23) offset 3
13637  391C             		
13638  391C AA          		.byte	$AA		; End of data
13639  391D             		
13640  391D             		
13641  391D             		; Fourth set of deformation data
13642  391D 04          		.byte	$04		; Blank tiles
13643  391E DF 88       		.word	$88DF	; (27,17)
13644  3920 30 88       		.word	$8830	; (6,17)
13645  3922             		
13646  3922 04          		.byte	$04		; Blank tiles
13647  3923 DF 90       		.word	$90DF	; (27,18)
13648  3925 B0 90       		.word	$90B0	; (27,18)
13649  3927             		
13650  3927 02          		.byte	$02		; Barrel girders
13651  3928 DF 9A       		.word	$9ADF	; (27,19) offset 2
13652  392A 20 8F       		.word	$8F20	; (21,17) offset 7
13653  392C             		
13654  392C AA          		.byte	$AA		; End of data
13655  392D             		
13656  392D             		
13657  392D             		; Fifth set of deformation data
13658  392D 04          		.byte	$04		; Blank tiles
13659  392E BF 68       		.word	$68BF	; (23,13)
13660  3930 20 68       		.word	$6820	; (21,13)
13661  3932             		
13662  3932 04          		.byte	$04		; Blank tiles
13663  3933 3F 70       		.word	$703F	; (7,14)
13664  3935 20 70       		.word	$7020	; (21,14)
13665  3937             		
13666  3937 02          		.byte	$02		; Barrel girders
13667  3938 DF 6E       		.word	$6EDF	; (27,13) offset 6
13668  393A 20 79       		.word	$7920	; (21,15) offset 1
13669  393C             		
13670  393C AA          		.byte	$AA		; End of data
13671  393D             ;------------------------------------------------------------------------------
13672  393D             
13673  393D             
13674  393D             
13675  393D             ;------------------------------------------------------------------------------
13676  393D             ; Data defining the sloped portion of the 6th platform on the intro and barrels
13677  393D             ; stage
13678  393D             L_INTRO_DATA_SLOPE6: 	
13679  393D 02          		.byte	$02	; Barrels girder
13680  393E DF 58       		.word	$58DF	; (27,11) offset 0
13681  3940 A0 55       		.word	$55A0	; (20,10) offset 5
13682  3942 AA          		.byte	$AA	; End of data
13683  3943             ;------------------------------------------------------------------------------
13684  3943             
13685  3943             
13686  3943             
13687  3943             ;------------------------------------------------------------------------------
13688  3943             ; Sprite data for Donkey Kong facing right, left arm reaching out
13689  3943             L_DK_SPRITES_THROW_BARREL: 	
13690  3943 00          		.byte	$00		; x coord 
13691  3944 70          		.byte	$70		; sprite number
13692  3945 08          		.byte	$08		; palette
13693  3946 44          		.byte	$44		; y coord
13694  3947             		
13695  3947 2B          		.byte	$2B		; x coord 
13696  3948 AC          		.byte	$AC		; sprite number ($2c - left leg back)
13697  3949 08          		.byte	$08		; palette 
13698  394A 4C          		.byte	$4C		; y coord
13699  394B             		
13700  394B 3B          		.byte	$3B		; x coord 
13701  394C AE          		.byte	$AE		; sprite number ($2e - body sideways)
13702  394D 08          		.byte	$08		; palette 
13703  394E 4C          		.byte	$4C		; y coord 
13704  394F             		
13705  394F 3B          		.byte	$3B		; x coord 
13706  3950 AF          		.byte	$AF		; sprite number ($2f - back sideways)
13707  3951 08          		.byte	$08		; palette 
13708  3952 3C          		.byte	$3C		; y coord
13709  3953             		
13710  3953 4B          		.byte	$4B		; x coord 
13711  3954 B0          		.byte	$B0		; sprite number ($30 - head sideways)
13712  3955 07          		.byte	$07		; palette 
13713  3956 3C          		.byte	$3C		; y coord
13714  3957             		
13715  3957 4B          		.byte	$4B		; x coord 
13716  3958 AD          		.byte	$AD		; sprite number ($2d - head sideways)
13717  3959 08          		.byte	$08		; palette 
13718  395A 4C          		.byte	$4C		; y coord
13719  395B             		
13720  395B 00          		.byte	$00		; x coord 
13721  395C 70          		.byte	$70		; sprite number 
13722  395D 08          		.byte	$08		; palette 
13723  395E 44          		.byte	$44		; y coord 
13724  395F             		
13725  395F 00          		.byte	$00		; x coord 
13726  3960 70          		.byte	$70		; sprite number 
13727  3961 08          		.byte	$08		; palette 
13728  3962 44          		.byte	$44		; y coord 
13729  3963             		
13730  3963 00          		.byte	$00		; x coord 
13731  3964 70          		.byte	$70		; sprite number 
13732  3965 08          		.byte	$08		; palette 
13733  3966 44          		.byte	$44		; y coord 
13734  3967             		
13735  3967 00          		.byte	$00		; x coord 
13736  3968 70          		.byte	$70		; sprite number 
13737  3969 0A          		.byte	$0A		; palette 
13738  396A 44          		.byte	$44		; y coord 
13739  396B             ;------------------------------------------------------------------------------
13740  396B             
13741  396B             
13742  396B             
13743  396B             ;------------------------------------------------------------------------------
13744  396B             ; Sprite data for Donkey Kong standing with arms down
13745  396B             L_DK_SPRITES_ARMS_DOWN:	
13746  396B 47          		.byte	$47		; x coord 
13747  396C 27          		.byte	$27		; sprite number ($27 - left leg)
13748  396D 08          		.byte	$08		; palette 
13749  396E 4C          		.byte	$4C		; y coord
13750  396F             		
13751  396F 2F          		.byte	$2F		; x coord 
13752  3970 A7          		.byte	$A7		; sprite number ($27 - right leg)
13753  3971 08          		.byte	$08		; palette 
13754  3972 4C          		.byte	$4C		; y coord
13755  3973             		
13756  3973 3B          		.byte	$3B		; x coord
13757  3974 25          		.byte	$25		; sprite number ($25 - torso)
13758  3975 08          		.byte	$08		; palette
13759  3976 4C          		.byte	$4C		; y coord
13760  3977             		
13761  3977 00          		.byte	$00		; x coord
13762  3978 70          		.byte	$70		; sprite number
13763  3979 08          		.byte	$08		; palette
13764  397A 44          		.byte	$44		; y coord
13765  397B             		
13766  397B 3B          		.byte	$3B		; x coord
13767  397C 23          		.byte	$23		; sprite number ($23 - face frowning)
13768  397D 07          		.byte	$07		; palette
13769  397E 3C          		.byte	$3C		; y coord
13770  397F             		
13771  397F 4B          		.byte	$4B		; x coord
13772  3980 2A          		.byte	$2A		; sprite number ($2a - right shoulder)
13773  3981 08          		.byte	$08		; palette
13774  3982 3C          		.byte	$3C		; y coord
13775  3983             		
13776  3983 4B          		.byte	$4B		; x coord
13777  3984 2B          		.byte	$2B		; sprite number ($2b - right arm)
13778  3985 08          		.byte	$08		; palette
13779  3986 4C          		.byte	$4C		; y coord
13780  3987             		
13781  3987 2B          		.byte	$2B		; x coord
13782  3988 AA          		.byte	$AA		; sprite number ($2a - left shoulder)
13783  3989 08          		.byte	$08		; palette
13784  398A 3C          		.byte	$3C		; y coord
13785  398B             		
13786  398B 2B          		.byte	$2B		; x coord
13787  398C AB          		.byte	$AB		; sprite number ($2b - left arm)
13788  398D 08          		.byte	$08		; palette
13789  398E 4C          		.byte	$4C		; y coord
13790  398F             		
13791  398F 00          		.byte	$00		; x coord
13792  3990 70          		.byte	$70		; sprite number
13793  3991 0A          		.byte	$0A		; palette
13794  3992 44          		.byte	$44		; y coord
13795  3993             ;------------------------------------------------------------------------------
13796  3993             
13797  3993             
13798  3993             ;------------------------------------------------------------------------------
13799  3993             ; Sprite data for Donkey Kong
13800  3993             L_DK_SPRITES_GRAB_BARREL:	
13801  3993 00          		.byte	$00		; x coord
13802  3994 70          		.byte	$70		; sprite number
13803  3995 08          		.byte	$08		; palette
13804  3996 44          		.byte	$44		; y coord
13805  3997             		
13806  3997 4B          		.byte	$4B		; x coord
13807  3998 2C          		.byte	$2C		; sprite number ($2c - left leg back)
13808  3999 08          		.byte	$08		; palette
13809  399A 4C          		.byte	$4C		; y coord
13810  399B             		
13811  399B 3B          		.byte	$3B		; x coord
13812  399C 2E          		.byte	$2E		; sprite number  ($2e - torso)
13813  399D 08          		.byte	$08		; palette
13814  399E 4C          		.byte	$4C		; y coord
13815  399F             		
13816  399F 3B          		.byte	$3B		; x coord
13817  39A0 2F          		.byte	$2F		; sprite number ($2f - back)
13818  39A1 08          		.byte	$08		; palette
13819  39A2 3C          		.byte	$3C		; y coord
13820  39A3             		
13821  39A3 2B          		.byte	$2B		; x coord
13822  39A4 30          		.byte	$30		; sprite number ($30 - head facing left)
13823  39A5 07          		.byte	$07		; palette
13824  39A6 3C          		.byte	$3C		; y coord
13825  39A7             		
13826  39A7 2B          		.byte	$2B		; x coord
13827  39A8 2D          		.byte	$2D		; sprite number ($2d - right leg, left arm forward, reaching)
13828  39A9 08          		.byte	$08		; palette
13829  39AA 4C          		.byte	$4C		; y coord
13830  39AB             		
13831  39AB 00          		.byte	$00		; x coord
13832  39AC 70          		.byte	$70		; sprite number
13833  39AD 08          		.byte	$08		; palette
13834  39AE 44          		.byte	$44		; y coord
13835  39AF             		
13836  39AF 00          		.byte	$00		; x coord
13837  39B0 70          		.byte	$70		; sprite number
13838  39B1 08          		.byte	$08		; palette
13839  39B2 44          		.byte	$44		; y coord
13840  39B3             		
13841  39B3 00          		.byte	$00		; x coord
13842  39B4 70          		.byte	$70		; sprite number
13843  39B5 08          		.byte	$08		; palette
13844  39B6 44          		.byte	$44		; y coord
13845  39B7             		
13846  39B7 00          		.byte	$00		; x coord
13847  39B8 70          		.byte	$70		; sprite number
13848  39B9 0A          		.byte	$0A		; palette
13849  39BA 44          		.byte	$44		; y coord
13850  39BB             ;------------------------------------------------------------------------------
13851  39BB             
13852  39BB             
13853  39BB             
13854  39BB             ;------------------------------------------------------------------------------
13855  39BB             ; Vector data describing the bounce of the springs on the elevators stage
13856  39BB             L_SPRING_VECTOR_DATA:	
13857  39BB FD FD FD FE 		.byte	-3, -3, -3, -2, -2, -2, -2, -1, -1,  0, -1,  0 ; Rising
13857  39BF FE FE FE FF 
13857  39C3 FF 00 FF 00 
13858  39C7 00 01 00 01 		.byte	 0,  1,  0,  1,  1,  2,  2,  2,  2,  3,  3,  3 ; Falling
13858  39CB 01 02 02 02 
13858  39CF 02 03 03 03 
13859  39D3 7F          		.byte	127 ; End of data
13860  39D4             ;------------------------------------------------------------------------------
13861  39D4             
13862  39D4             
13863  39D4             
13864  39D4             ;------------------------------------------------------------------------------
13865  39D4             l39c3:	
13866  39D4 1E          		.byte	$1E
13867  39D5 4E          		.byte	$4E
13868  39D6 BB          		.byte	$BB
13869  39D7 4C          		.byte	$4C
13870  39D8 D8          		.byte	$D8
13871  39D9 4E          		.byte	$4e
13872  39DA 59                  .byte	$59
13873  39DB 4E                  .byte	$4e
13874  39DC 7F                  .byte	127 ; End of data
13875  39DD             ;------------------------------------------------------------------------------
13876  39DD             
13877  39DD             
13878  39DD             ;------------------------------------------------------------------------------
13879  39DD BB          l39cc:  .byte   $bb
13880  39DE 4D                  .byte   $4d
13881  39DF 7F                  .byte   $7f
13882  39E0             ;------------------------------------------------------------------------------
13883  39E0             
13884  39E0             
13885  39E0             
13886  39E0             ;------------------------------------------------------------------------------
13887  39E0             ; Sprite data for Donkey Kong standing grinning with his right leg and left
13888  39E0             ; arm raised.
13889  39E0             L_DK_SPRITES_GRIN_L_STOMP: 	
13890  39E0 47          		.byte	$47		; x coord
13891  39E1 27          		.byte	$27		; sprite number ($27 - left leg)
13892  39E2 08          		.byte	$08		; palette 
13893  39E3 50          		.byte	$50		; y coord 
13894  39E4             		
13895  39E4 2D          		.byte	$2D		; x coord 
13896  39E5 26          		.byte	$26		; sprite number ($26 - right leg raised)
13897  39E6 08          		.byte	$08		; palette
13898  39E7 50          		.byte	$50		; y coord
13899  39E8             		
13900  39E8 3B          		.byte	$3B		; x coord
13901  39E9 25          		.byte	$25		; sprite number ($25 - torso)
13902  39EA 08          		.byte	$08		; palette
13903  39EB 50          		.byte	$50		; y coord
13904  39EC             		
13905  39EC 00          		.byte	$00 	; x coord
13906  39ED 70          		.byte	$70 	; sprite number
13907  39EE 08          		.byte	$08 	; palette
13908  39EF 48          		.byte	$48		; y coord
13909  39F0             		
13910  39F0 3B          		.byte	$3B 	; x coord
13911  39F1 24          		.byte	$24 	; sprite number ($24 - head - grinning)
13912  39F2 07          		.byte	$07 	; palette
13913  39F3 40          		.byte	$40 	; y coord
13914  39F4             		
13915  39F4 4B          		.byte	$4B 	; x coord
13916  39F5 28          		.byte	$28 	; sprite number ($28 - left arm raised)
13917  39F6 08          		.byte	$08 	; palette
13918  39F7 40          		.byte	$40 	; y coord
13919  39F8             		
13920  39F8 00          		.byte	$00 	; x coord
13921  39F9 70          		.byte	$70 	; sprite number
13922  39FA 08          		.byte	$08 	; palette
13923  39FB 48          		.byte	$48		; y coord
13924  39FC             		
13925  39FC 30          		.byte	$30 	; x coord
13926  39FD 29          		.byte	$29 	; sprite number ($29 - right arm curled)
13927  39FE 08          		.byte	$08 	; palette
13928  39FF 44          		.byte	$44		; y coord
13929  3A00             		
13930  3A00 00          		.byte	$00 	; x coord
13931  3A01 70          		.byte	$70 	; sprite number
13932  3A02 08          		.byte	$08 	; palette
13933  3A03 48          		.byte	$48		; y coord
13934  3A04             		
13935  3A04 00          		.byte	$00 	; x coord
13936  3A05 70          		.byte	$70 	; sprite number
13937  3A06 0A          		.byte	$0A 	; palette
13938  3A07 48          		.byte	$48		; y coord
13939  3A08             ;------------------------------------------------------------------------------
13940  3A08             
13941  3A08             
13942  3A08             ;------------------------------------------------------------------------------
13943  3A08             ; Sprite data for Donkey Kong standing grinning with his left leg and right
13944  3A08             ; arm raised.
13945  3A08             L_DK_SPRITES_GRIN_R_STOMP:	
13946  3A08 49          		.byte	$49 	; x coord
13947  3A09 A6          		.byte	$A6 	; sprite number ($26 - left leg)
13948  3A0A 08          		.byte	$08 	; palette
13949  3A0B 50          		.byte	$50		; y coord
13950  3A0C             		
13951  3A0C 2F          		.byte	$2F 	; x coord
13952  3A0D A7          		.byte	$A7 	; sprite number	($27 - right leg raised)
13953  3A0E 08          		.byte	$08 	; palette
13954  3A0F 50          		.byte	$50		; y coord
13955  3A10             		
13956  3A10 3B          		.byte	$3B 	; x coord
13957  3A11 25          		.byte	$25 	; sprite number ($25 - torso)
13958  3A12 08          		.byte	$08 	; palette
13959  3A13 50          		.byte	$50		; y coord
13960  3A14             		
13961  3A14 00          		.byte	$00 	; x coord
13962  3A15 70          		.byte	$70 	; sprite number
13963  3A16 08          		.byte	$08 	; palette
13964  3A17 48          		.byte	$48		; y coord
13965  3A18             		
13966  3A18 3B          		.byte	$3B 	; x coord
13967  3A19 24          		.byte	$24 	; sprite number ($24 - head grinning)
13968  3A1A 07          		.byte	$07 	; palette
13969  3A1B 40          		.byte	$40		; y coord
13970  3A1C             		
13971  3A1C 46          		.byte	$46 	; x coord
13972  3A1D A9          		.byte	$A9 	; sprite number ($29 - left arm curled)
13973  3A1E 08          		.byte	$08 	; palette
13974  3A1F 44          		.byte	$44		; y coord
13975  3A20             		
13976  3A20 00          		.byte	$00 	; x coord
13977  3A21 70          		.byte	$70 	; sprite number
13978  3A22 08          		.byte	$08 	; palette
13979  3A23 48          		.byte	$48		; y coord
13980  3A24             		
13981  3A24 2B          		.byte	$2B 	; x coord
13982  3A25 A8          		.byte	$A8 	; sprite number ($28 - right arm raised)
13983  3A26 08          		.byte	$08 	; palette
13984  3A27 40          		.byte	$40		; y coord
13985  3A28             		
13986  3A28 00          		.byte	$00 	; x coord
13987  3A29 70          		.byte	$70 	; sprite number
13988  3A2A 08          		.byte	$08 	; palette
13989  3A2B 48          		.byte	$48		; y coord
13990  3A2C             		
13991  3A2C 00          		.byte	$00 	; x coord
13992  3A2D 70          		.byte	$70 	; sprite number
13993  3A2E 0A          		.byte	$0A 	; palette
13994  3A2F 48          		.byte	$48		; y coord
13995  3A30             ;------------------------------------------------------------------------------
13996  3A30             
13997  3A30             
13998  3A30             
13999  3A30             ;------------------------------------------------------------------------------
14000  3A30             ; Sprite data for Donkey Kong grinning and falling upside-down
14001  3A30             L_DK_SPRITES_GRIN_UD:	
14002  3A30 73          		.byte	$73 	; x coord
14003  3A31 A7          		.byte	$A7 	; sprite number ($27 - leg)
14004  3A32 88          		.byte	$88 	; palette
14005  3A33 60          		.byte	$60		; y coord
14006  3A34             		
14007  3A34 8B          		.byte	$8B 	; x coord
14008  3A35 27          		.byte	$27 	; sprite number ($27 - leg)
14009  3A36 88          		.byte	$88 	; palette
14010  3A37 60          		.byte	$60		; y coord
14011  3A38             		
14012  3A38 7F          		.byte	$7F 	; x coord
14013  3A39 25          		.byte	$25 	; sprite number ($25 - torso)
14014  3A3A 88          		.byte	$88 	; palette
14015  3A3B 60          		.byte	$60		; y coord
14016  3A3C             		
14017  3A3C 00          		.byte	$00 	; x coord
14018  3A3D 70          		.byte	$70 	; sprite number
14019  3A3E 88          		.byte	$88 	; palette
14020  3A3F 68          		.byte	$68		; y coord
14021  3A40             		
14022  3A40 7F          		.byte	$7F 	; x coord
14023  3A41 24          		.byte	$24 	; sprite number ($24 - head grinning)
14024  3A42 87          		.byte	$87 	; palette
14025  3A43 70          		.byte	$70		; y coord
14026  3A44             		
14027  3A44 74          		.byte	$74 	; x coord
14028  3A45 29          		.byte	$29 	; sprite number ($29 - arm curled)
14029  3A46 88          		.byte	$88 	; palette
14030  3A47 6C          		.byte	$6C		; y coord
14031  3A48             		
14032  3A48 00          		.byte	$00 	; x coord
14033  3A49 70          		.byte	$70 	; sprite number
14034  3A4A 88          		.byte	$88 	; palette
14035  3A4B 68          		.byte	$68		; y coord
14036  3A4C             		
14037  3A4C 8A          		.byte	$8A 	; x coord
14038  3A4D A9          		.byte	$A9 	; sprite number ($29 - arm curled)
14039  3A4E 88          		.byte	$88 	; palette
14040  3A4F 6C          		.byte	$6C		; y coord
14041  3A50             		
14042  3A50 00          		.byte	$00 	; x coord
14043  3A51 70          		.byte	$70 	; sprite number
14044  3A52 88          		.byte	$88 	; palette
14045  3A53 68          		.byte	$68		; y coord
14046  3A54             		
14047  3A54 00          		.byte	$00 	; x coord
14048  3A55 70          		.byte	$70 	; sprite number
14049  3A56 8A          		.byte	$8A 	; palette
14050  3A57 68          		.byte	$68		; y coord
14051  3A58             ;------------------------------------------------------------------------------
14052  3A58             
14053  3A58             
14054  3A58             
14055  3A58             ;------------------------------------------------------------------------------
14056  3A58             ; Data describing how to draw the first fallen platform on the pies level when
14057  3A58             ; the stage has has been completed
14058  3A58             L_RIVETS_DATA_FALL1: 	
14059  3A58 05          		.byte	$05 	; Girders with circular holes
14060  3A59 AF F0       		.word	$F0AF	; (21,30)
14061  3A5B 50 F0       		.word	$F050	; (10,30)
14062  3A5D AA          		.byte	$AA	; End of data
14063  3A5E             ;------------------------------------------------------------------------------
14064  3A5E             
14065  3A5E             
14066  3A5E             
14067  3A5E             ;------------------------------------------------------------------------------
14068  3A5E             ; Data describing how to draw the second fallen platform on the pies level when
14069  3A5E             ; the stage has has been completed
14070  3A5E             L_RIVETS_DATA_FALL2:	
14071  3A5E 05          		.byte	$05 	; Girders with circular holes
14072  3A5F AF E8       		.word	$E8AF	; (21,29)
14073  3A61 50 E8       		.word	$E850	; (10,29)
14074  3A63 AA          		.byte	$AA	; End of data
14075  3A64             ;------------------------------------------------------------------------------
14076  3A64             
14077  3A64             
14078  3A64             
14079  3A64             ;------------------------------------------------------------------------------
14080  3A64             ; Data describing how to draw the third fallen platform on the pies level when
14081  3A64             ; the stage has has been completed
14082  3A64             L_RIVETS_DATA_FALL3:	
14083  3A64 05          		.byte	$05 	; Girders with circular holes
14084  3A65 AF E0       		.word	$E0AF	; (21,28)
14085  3A67 50 E0       		.word	$E050	; (10,28)
14086  3A69 AA          		.byte	$AA	; End of data
14087  3A6A             ;------------------------------------------------------------------------------
14088  3A6A             
14089  3A6A             				
14090  3A6A             
14091  3A6A             ;------------------------------------------------------------------------------
14092  3A6A             ; Data describing how to draw the fourth fallen platform on the pies level when
14093  3A6A             ; the stage has has been completed
14094  3A6A             L_RIVETS_DATA_FALL4:	
14095  3A6A 05          		.byte	$05 	; Girders with circular holes
14096  3A6B AF D8       		.word	$D8AF	; (21,27)
14097  3A6D 50 D8       		.word	$D850	; (10,27)
14098  3A6F AA          		.byte	$AA	; End of data
14099  3A70             ;------------------------------------------------------------------------------
14100  3A70             
14101  3A70             
14102  3A70             
14103  3A70             ;------------------------------------------------------------------------------
14104  3A70             ; Data describing how to draw the top fallen platform on the pies level when
14105  3A70             ; the stage has has been completed		
14106  3A70             L_RIVETS_DATA_FALL_TOP:	
14107  3A70 05          		.byte	$05 	; Girders with circular holes
14108  3A71 B7 58       		.word	$58B7	; (22,11)
14109  3A73 48 58       		.word	$5848	; (9,11)
14110  3A75 AA          		.byte	$AA	; End of data
14111  3A76             ;------------------------------------------------------------------------------
14112  3A76             
14113  3A76             
14114  3A76             ;------------------------------------------------------------------------------
14115  3A76             ; Stage order table defining the stages and the order they will appear in each 
14116  3A76             ; level
14117  3A76             ; Level 1
14118  3A76             L_STAGE_ORDER_TABLE: 	
14119  3A76 01 04       		.byte	1, 4				; Barrels, Rivets
14120  3A78             ; Level 2	
14121  3A78 01 03 04    		.byte	1, 3, 4				; Barrels, Elevators, Rivets
14122  3A7B             
14123  3A7B             ; Level 3
14124  3A7B 01 02 03 04 		.byte	1, 2, 3, 4			; Barrels, Mixer, Elevators, Rivets
14125  3A7F             		
14126  3A7F             ; Level 4
14127  3A7F 01 02 01 03 		.byte	1, 2, 1, 3, 4		; Barrels, Mixer, Barrels, Elevators, Rivets
14127  3A83 04 
14128  3A84             
14129  3A84             ; Level 5+		
14130  3A84             L_STAGE_ORDER_TABLE_LAST: 	
14131  3A84 01 02 01 03 		.byte	1, 2, 1, 3, 1, 4	; Barrels, Mixer, Barrels, Elevators, Barrels, Rivets
14131  3A88 01 04 
14132  3A8A             
14133  3A8A 7F          		.byte	$7F		; End of data marker
14134  3A8B             ;------------------------------------------------------------------------------
14135  3A8B             
14136  3A8B             
14137  3A8B             
14138  3A8B             ;------------------------------------------------------------------------------
14139  3A8B             ; The fireballs in the game don't just move left and right, they
14140  3A8B             ; bob up and down as they do it, so they look more like real fire
14141  3A8B             ; as they travel.  The following table controls this behavior.
14142  3A8B             L_FIREBALL_BOB_TABLE:	
14143  3A8B FF          		.byte	-1        
14144  3A8C 00          		.byte	 0        
14145  3A8D FF          		.byte	-1        
14146  3A8E FF          		.byte	-1        
14147  3A8F FE          		.byte	-2
14148  3A90 FE          		.byte	-2      
14149  3A91 FE          		.byte	-2
14150  3A92 FE          		.byte	-2
14151  3A93 FE          		.byte	-2
14152  3A94 FE          		.byte	-2
14153  3A95 FE          		.byte	-2
14154  3A96 FE          		.byte	-2      
14155  3A97 FE          		.byte	-2
14156  3A98 FE          		.byte	-2      
14157  3A99 FE          		.byte	-2
14158  3A9A FF          		.byte	-1      
14159  3A9B FF          		.byte	-1        
14160  3A9C 00          		.byte	 0   
14161  3A9D             FIREBALL_BOB_TABLE_LENGTH = $ - L_FIREBALL_BOB_TABLE
14162  3A9D             ;------------------------------------------------------------------------------
14163  3A9D             
14164  3A9D             
14165  3A9D             ;------------------------------------------------------------------------------
14166  3A9D             ; The following data contains the y coordinates for the fireballs as they first 
14167  3A9D             ; jump out of the oil barrel on the barrels stage
14168  3A9D             L_OIL_BARREL_JUMP_TABLE_BARRELS:	
14169  3A9D E8          		.byte	232        
14170  3A9E E5          		.byte	229        
14171  3A9F E3          		.byte	227        
14172  3AA0 E2          		.byte	226
14173  3AA1 E1          		.byte	225
14174  3AA2 E0          		.byte	224    
14175  3AA3 DF          		.byte	223        
14176  3AA4 DE          		.byte	222
14177  3AA5 DD          		.byte	221      
14178  3AA6 DD          		.byte	221
14179  3AA7 DC          		.byte	220
14180  3AA8 DC          		.byte	220
14181  3AA9 DC          		.byte	220  
14182  3AAA DC          		.byte	220
14183  3AAB DC          		.byte	220
14184  3AAC DC          		.byte	220    
14185  3AAD DD          		.byte	221
14186  3AAE DD          		.byte	221
14187  3AAF DE          		.byte	222
14188  3AB0 DF          		.byte	223  
14189  3AB1 E0          		.byte	224        
14190  3AB2 E1          		.byte	225        
14191  3AB3 E2          		.byte	226
14192  3AB4 E3          		.byte	227
14193  3AB5 E4          		.byte	228    
14194  3AB6 E5          		.byte	229        
14195  3AB7 E7          		.byte	231        
14196  3AB8 E9          		.byte	233        
14197  3AB9 EB          		.byte	235        
14198  3ABA ED          		.byte	237
14199  3ABB F0          		.byte	240     
14200  3ABC AA          		.byte	$aa							; End of data        
14201  3ABD             ;------------------------------------------------------------------------------
14202  3ABD             
14203  3ABD             
14204  3ABD             
14205  3ABD             ;------------------------------------------------------------------------------
14206  3ABD             ; The following data contains the y coordinates for the fireballs as they first 
14207  3ABD             ; jump out of the oil barrel on the barrels stage
14208  3ABD             L_OIL_BARREL_JUMP_TABLE_MIXER:	
14209  3ABD 80          		.byte	128        
14210  3ABE 7B          		.byte	123        
14211  3ABF 78          		.byte	120        
14212  3AC0 76          		.byte	118        
14213  3AC1 74          		.byte	116        
14214  3AC2 73          		.byte	115        
14215  3AC3 72          		.byte	114       
14216  3AC4 71          		.byte	113        
14217  3AC5 70          		.byte	112        
14218  3AC6 70          		.byte	112        
14219  3AC7 6F          		.byte	111        
14220  3AC8 6F          		.byte	111        
14221  3AC9 6F          		.byte	111        
14222  3ACA 70          		.byte	112        
14223  3ACB 70          		.byte	112        
14224  3ACC 71          		.byte	113        
14225  3ACD 72          		.byte	114        
14226  3ACE 73          		.byte	115        
14227  3ACF 74          		.byte	116        
14228  3AD0 75          		.byte	117        
14229  3AD1 76          		.byte	118        
14230  3AD2 77          		.byte	119        
14231  3AD3 78          		.byte	120        
14232  3AD4 AA          		.byte	$aa							; End of data        
14233  3AD5             ;------------------------------------------------------------------------------
14234  3AD5             
14235  3AD5             
14236  3AD5             
14237  3AD5             ;------------------------------------------------------------------------------
14238  3AD5             ; The spawning coordinates for fireballs appearing on the right side of the 
14239  3AD5             ; screen on the rivets stage
14240  3AD5             ; NOTE: x,y are reversed?
14241  3AD5             L_L_RIVET_SPAWN_COORDS:	
14242  3AD5 EE F0       		.word	TWO_BYTES(240,238)
14243  3AD7 DB A0       		.word	TWO_BYTES(160,219) 
14244  3AD9 E6 C8       		.word	TWO_BYTES(200,230)
14245  3ADB D6 78       		.word	TWO_BYTES(120,214)    
14246  3ADD EB F0       		.word	TWO_BYTES(240,235)      
14247  3ADF DB A0       		.word	TWO_BYTES(160,219)  
14248  3AE1 E6 C8       		.word	TWO_BYTES(200,230)
14249  3AE3 E6 C8       		.word	TWO_BYTES(200,230)  
14250  3AE5             ;------------------------------------------------------------------------------
14251  3AE5             
14252  3AE5             
14253  3AE5             
14254  3AE5             ;------------------------------------------------------------------------------
14255  3AE5             ; The spawning coordinates for fireballs appearing on the left side of the 
14256  3AE5             ; screen on the rivets stage
14257  3AE5             ; NOTE: x,y are reversed?
14258  3AE5             L_R_RIVET_SPAWN_COORDS:	
14259  3AE5 1B C8       		.word	TWO_BYTES(200,27)    
14260  3AE7 23 A0       		.word	TWO_BYTES(160,35)     
14261  3AE9 2B 78       		.word	TWO_BYTES(120,43)      
14262  3AEB 12 F0       		.word	TWO_BYTES(240,18)      
14263  3AED 1B C8       		.word	TWO_BYTES(200,27)     
14264  3AEF 23 A0       		.word	TWO_BYTES(160,35)     
14265  3AF1 12 F0       		.word	TWO_BYTES(240,18)    
14266  3AF3 1B C8       		.word	TWO_BYTES(200,27)
14267  3AF5             ;------------------------------------------------------------------------------
14268  3AF5             
14269  3AF5             
14270  3AF5             ;------------------------------------------------------------------------------
14271  3AF5             ; Stage data for the barrels stage
14272  3AF5             L_BARRELS_STAGE_DATA:	
14273  3AF5 02          		.byte	$02 	; tile type
14274  3AF6 97 38       		.word	$3897 	; coord 1 (13,7)
14275  3AF8 68 38       		.word	$3868 	; coord 2 (18,7)
14276  3AFA             		
14277  3AFA 02          		.byte	$02 	; tile type
14278  3AFB 9F 54       		.word	$549F 	; coord 1 (12,10)
14279  3AFD 10 54       		.word	$5410 	; coord 2 (29,10)
14280  3AFF             		
14281  3AFF 02          		.byte	$02 	; tile type
14282  3B00 DF 58       		.word	$58DF 	; coord 1 (4,11)
14283  3B02 A0 55       		.word	$55A0 	; coord 2 (11,10)
14284  3B04             		
14285  3B04 02          		.byte	$02 	; tile type
14286  3B05 EF 6D       		.word	$6DEF 	; coord 1 (2,13)
14287  3B07 20 79       		.word	$7920 	; coord 2 (27,15)
14288  3B09             		
14289  3B09 02          		.byte	$02 	; tile type
14290  3B0A DF 9A       		.word	$9ADF 	; coord 1 (4, 19)
14291  3B0C 10 8E       		.word	$8E10 	; coord 2 (29,17)
14292  3B0E             		
14293  3B0E 02          		.byte	$02 	; tile type
14294  3B0F EF AF       		.word	$AFEF 	; coord 1 (2,21)
14295  3B11 20 BB       		.word	$BB20 	; coord 2 (27,23)
14296  3B13             		
14297  3B13 02          		.byte	$02 	; tile type
14298  3B14 DF DC       		.word	$DCDF 	; coord 1 (4,27)
14299  3B16 10 D0       		.word	$D010 	; coord 2 (29,26)
14300  3B18             		
14301  3B18 02          		.byte	$02 	; tile type
14302  3B19 FF F0       		.word	$F0FF 	; coord 1 (0,30)
14303  3B1B 80 F7       		.word	$F780 	; coord 2 (15,30)
14304  3B1D             		
14305  3B1D 02          		.byte	$02 	; tile type
14306  3B1E 7F F8       		.word	$F87F 	; coord 1 (16,31)
14307  3B20 00 F8       		.word	$F800 	; coord 2 (31,31)
14308  3B22             		
14309  3B22 00          		.byte	$00 
14310  3B23 CB 57       		.word	$57CB 
14311  3B25 CB 6F       		.word	$6FCB 
14312  3B27             		
14313  3B27 00          		.byte	$00 
14314  3B28 CB 99       		.word	$99CB 
14315  3B2A CB B1       		.word	$B1CB 
14316  3B2C             		
14317  3B2C 00          		.byte	$00 
14318  3B2D CB DB       		.word	$DBCB 
14319  3B2F CB F3       		.word	$F3CB 
14320  3B31             		
14321  3B31 00          		.byte	$00 
14322  3B32 63 18       		.word	$1863 
14323  3B34 63 54       		.word	$5463 
14324  3B36             		
14325  3B36 01          		.byte	$01 
14326  3B37 63 D5       		.word	$D563 
14327  3B39 63 F8       		.word	$F863 
14328  3B3B             		
14329  3B3B 00          		.byte	$00 
14330  3B3C 33 78       		.word	$7833 
14331  3B3E 33 90       		.word	$9033 
14332  3B40             		
14333  3B40 00          		.byte	$00 
14334  3B41 33 BA       		.word	$BA33 
14335  3B43 33 D2       		.word	$D233 
14336  3B45             		
14337  3B45 00          		.byte	$00 
14338  3B46 53 18       		.word	$1853 
14339  3B48 53 54       		.word	$5453 
14340  3B4A             		
14341  3B4A 01          		.byte	$01 
14342  3B4B 53 92       		.word	$9253 
14343  3B4D 53 B8       		.word	$B853 
14344  3B4F             		
14345  3B4F 00          		.byte	$00 
14346  3B50 5B 76       		.word	$765B 
14347  3B52 5B 92       		.word	$925B 
14348  3B54             		
14349  3B54 00          		.byte	$00 
14350  3B55 73 B6       		.word	$B673 
14351  3B57 73 D6       		.word	$D673 
14352  3B59             		
14353  3B59 00          		.byte	$00 
14354  3B5A 83 95       		.word	$9583 
14355  3B5C 83 B5       		.word	$B583 
14356  3B5E             		
14357  3B5E 00          		.byte	$00 
14358  3B5F 93 38       		.word	$3893 
14359  3B61 93 54       		.word	$5493 
14360  3B63             		
14361  3B63 01          		.byte	$01 
14362  3B64 BB 70       		.word	$70BB 
14363  3B66 BB 98       		.word	$98BB 
14364  3B68             		
14365  3B68 01          		.byte	$01 
14366  3B69 6B 54       		.word	$546B 
14367  3B6B 6B 75       		.word	$756B 
14368  3B6D             		
14369  3B6D AA          		.byte	$AA		; End of data
14370  3B6E             ;------------------------------------------------------------------------------
14371  3B6E             
14372  3B6E             
14373  3B6E             
14374  3B6E             ;------------------------------------------------------------------------------
14375  3B6E             ; Stage data for the mixer stage
14376  3B6E             L_MIXER_STAGE_DATA: 	
14377  3B6E 06          		.byte	$06 
14378  3B6F 8F 90       		.word	$908F 
14379  3B71 70 90       		.word	$9070
14380  3B73             		
14381  3B73 06          		.byte	$06 
14382  3B74 8F 98       		.word	$988F 
14383  3B76 70 98       		.word	$9870
14384  3B78             		
14385  3B78 06          		.byte	$06 
14386  3B79 8F A0       		.word	$A08F 
14387  3B7B 70 A0       		.word	$A070
14388  3B7D             		
14389  3B7D 00          		.byte	$00 
14390  3B7E 63 18       		.word	$1863 
14391  3B80 63 58       		.word	$5863
14392  3B82             		
14393  3B82 00          		.byte	$00 
14394  3B83 63 80       		.word	$8063 
14395  3B85 63 A8       		.word	$A863
14396  3B87             		
14397  3B87 00          		.byte	$00 
14398  3B88 63 D0       		.word	$D063 
14399  3B8A 63 F8       		.word	$F863
14400  3B8C             		
14401  3B8C 00          		.byte	$00 
14402  3B8D 53 18       		.word	$1853 
14403  3B8F 53 58       		.word	$5853
14404  3B91             		
14405  3B91 00          		.byte	$00 
14406  3B92 53 A8       		.word	$A853 
14407  3B94 53 D0       		.word	$D053
14408  3B96             		
14409  3B96 00          		.byte	$00 
14410  3B97 9B 80       		.word	$809B 
14411  3B99 9B A8       		.word	$A89B
14412  3B9B             		
14413  3B9B 00          		.byte	$00 
14414  3B9C 9B D0       		.word	$D09B 
14415  3B9E 9B F8       		.word	$F89B
14416  3BA0             		
14417  3BA0 01          		.byte	$01 
14418  3BA1 23 58       		.word	$5823 
14419  3BA3 23 80       		.word	$8023
14420  3BA5             		
14421  3BA5 01          		.byte	$01 
14422  3BA6 DB 58       		.word	$58DB 
14423  3BA8 DB 80       		.word	$80DB
14424  3BAA             		
14425  3BAA 00          		.byte	$00 
14426  3BAB 2B 80       		.word	$802B 
14427  3BAD 2B A8       		.word	$A82B
14428  3BAF             		
14429  3BAF 00          		.byte	$00 
14430  3BB0 D3 80       		.word	$80D3 
14431  3BB2 D3 A8       		.word	$A8D3
14432  3BB4             		
14433  3BB4 00          		.byte	$00 
14434  3BB5 A3 A8       		.word	$A8A3 
14435  3BB7 A3 D0       		.word	$D0A3
14436  3BB9             		
14437  3BB9 00          		.byte	$00 
14438  3BBA 2B D0       		.word	$D02B 
14439  3BBC 2B F8       		.word	$F82B
14440  3BBE             		
14441  3BBE 00          		.byte	$00 
14442  3BBF D3 D0       		.word	$D0D3 
14443  3BC1 D3 F8       		.word	$F8D3
14444  3BC3             		
14445  3BC3 00          		.byte	$00 
14446  3BC4 93 38       		.word	$3893 
14447  3BC6 93 58       		.word	$5893
14448  3BC8             		
14449  3BC8 02          		.byte	$02 
14450  3BC9 97 38       		.word	$3897 
14451  3BCB 68 38       		.word	$3868
14452  3BCD             		
14453  3BCD 03          		.byte	$03 
14454  3BCE EF 58       		.word	$58EF 
14455  3BD0 10 58       		.word	$5810
14456  3BD2             		
14457  3BD2 03          		.byte	$03 
14458  3BD3 F7 80       		.word	$80F7 
14459  3BD5 88 80       		.word	$8088
14460  3BD7             		
14461  3BD7 03          		.byte	$03 
14462  3BD8 77 80       		.word	$8077 
14463  3BDA 08 80       		.word	$8008
14464  3BDC             		
14465  3BDC 02          		.byte	$02 
14466  3BDD A7 A8       		.word	$A8A7 
14467  3BDF 50 A8       		.word	$A850
14468  3BE1             		
14469  3BE1 02          		.byte	$02 
14470  3BE2 E7 A8       		.word	$A8E7 
14471  3BE4 B8 A8       		.word	$A8B8
14472  3BE6             		
14473  3BE6 02          		.byte	$02 
14474  3BE7 3F A8       		.word	$A83F 
14475  3BE9 18 A8       		.word	$A818
14476  3BEB             		
14477  3BEB 03          		.byte	$03 
14478  3BEC EF D0       		.word	$D0EF 
14479  3BEE 10 D0       		.word	$D010
14480  3BF0             		
14481  3BF0 02          		.byte	$02 
14482  3BF1 EF F8       		.word	$F8EF 
14483  3BF3 10 F8       		.word	$F810
14484  3BF5             		
14485  3BF5 AA          		.byte	$aa		; End of data
14486  3BF6             ;------------------------------------------------------------------------------
14487  3BF6             
14488  3BF6             
14489  3BF6             
14490  3BF6             ;------------------------------------------------------------------------------
14491  3BF6             ; Stage data for the elevators stage
14492  3BF6             L_ELEVATORS_STAGE_DATA:
14493  3BF6 00          		.byte	$00 
14494  3BF7 63 18       		.word	$1863 
14495  3BF9 63 58       		.word	$5863
14496  3BFB             		
14497  3BFB 00          		.byte	$00 
14498  3BFC 63 88       		.word	$8863 
14499  3BFE 63 D0       		.word	$D063
14500  3C00             		
14501  3C00 00          		.byte	$00 
14502  3C01 53 18       		.word	$1853 
14503  3C03 53 58       		.word	$5853
14504  3C05             		
14505  3C05 00          		.byte	$00 
14506  3C06 53 88       		.word	$8853 
14507  3C08 53 D0       		.word	$D053
14508  3C0A             		
14509  3C0A 00          		.byte	$00 
14510  3C0B E3 68       		.word	$68E3 
14511  3C0D E3 90       		.word	$90E3
14512  3C0F             		
14513  3C0F 00          		.byte	$00 
14514  3C10 E3 B8       		.word	$B8E3 
14515  3C12 E3 D0       		.word	$D0E3
14516  3C14             		
14517  3C14 00          		.byte	$00 
14518  3C15 CB 90       		.word	$90CB 
14519  3C17 CB B0       		.word	$B0CB
14520  3C19             		
14521  3C19 00          		.byte	$00 
14522  3C1A B3 58       		.word	$58B3 
14523  3C1C B3 78       		.word	$78B3
14524  3C1E             		
14525  3C1E 00          		.byte	$00 
14526  3C1F 9B 80       		.word	$809B 
14527  3C21 9B A0       		.word	$A09B
14528  3C23             		
14529  3C23 00          		.byte	$00 
14530  3C24 93 38       		.word	$3893 
14531  3C26 93 58       		.word	$5893
14532  3C28             		
14533  3C28 00          		.byte	$00 
14534  3C29 23 88       		.word	$8823 
14535  3C2B 23 C0       		.word	$C023
14536  3C2D             		
14537  3C2D 00          		.byte	$00 
14538  3C2E 1B C0       		.word	$C01B 
14539  3C30 1B E8       		.word	$E81B
14540  3C32             		
14541  3C32 02          		.byte	$02 
14542  3C33 97 38       		.word	$3897 
14543  3C35 68 38       		.word	$3868
14544  3C37             		
14545  3C37 02          		.byte	$02 
14546  3C38 B7 58       		.word	$58B7 
14547  3C3A 10 58       		.word	$5810
14548  3C3C             		
14549  3C3C 02          		.byte	$02 
14550  3C3D EF 68       		.word	$68EF 
14551  3C3F E0 68       		.word	$68E0
14552  3C41             		
14553  3C41 02          		.byte	$02 
14554  3C42 D7 70       		.word	$70D7 
14555  3C44 C8 70       		.word	$70C8
14556  3C46             		
14557  3C46 02          		.byte	$02 
14558  3C47 BF 78       		.word	$78BF 
14559  3C49 B0 78       		.word	$78B0
14560  3C4B             		
14561  3C4B 02          		.byte	$02 
14562  3C4C A7 80       		.word	$80A7 
14563  3C4E 90 80       		.word	$8090
14564  3C50             		
14565  3C50 02          		.byte	$02 
14566  3C51 67 88       		.word	$8867 
14567  3C53 48 88       		.word	$8848
14568  3C55             		
14569  3C55 02          		.byte	$02 
14570  3C56 27 88       		.word	$8827 
14571  3C58 10 88       		.word	$8810
14572  3C5A             		
14573  3C5A 02          		.byte	$02 
14574  3C5B EF 90       		.word	$90EF 
14575  3C5D C8 90       		.word	$90C8
14576  3C5F             		
14577  3C5F 02          		.byte	$02 
14578  3C60 A7 A0       		.word	$A0A7 
14579  3C62 98 A0       		.word	$A098
14580  3C64             		
14581  3C64 02          		.byte	$02 
14582  3C65 BF A8       		.word	$A8BF 
14583  3C67 B0 A8       		.word	$A8B0
14584  3C69             		
14585  3C69 02          		.byte	$02 
14586  3C6A D7 B0       		.word	$B0D7 
14587  3C6C C8 B0       		.word	$B0C8
14588  3C6E             		
14589  3C6E 02          		.byte	$02 
14590  3C6F EF B8       		.word	$B8EF 
14591  3C71 E0 B8       		.word	$B8E0
14592  3C73             		
14593  3C73 02          		.byte	$02 
14594  3C74 27 C0       		.word	$C027 
14595  3C76 10 C0       		.word	$C010
14596  3C78             		
14597  3C78 02          		.byte	$02 
14598  3C79 EF D0       		.word	$D0EF 
14599  3C7B D8 D0       		.word	$D0D8
14600  3C7D             		
14601  3C7D 02          		.byte	$02 
14602  3C7E 67 D0       		.word	$D067 
14603  3C80 50 D0       		.word	$D050
14604  3C82             		
14605  3C82 02          		.byte	$02 
14606  3C83 CF D8       		.word	$D8CF 
14607  3C85 C0 D8       		.word	$D8C0
14608  3C87             		
14609  3C87 02          		.byte	$02 
14610  3C88 B7 E0       		.word	$E0B7 
14611  3C8A A8 E0       		.word	$E0A8
14612  3C8C             		
14613  3C8C 02          		.byte	$02 
14614  3C8D 9F E8       		.word	$E89F 
14615  3C8F 88 E8       		.word	$E888
14616  3C91             		
14617  3C91 02          		.byte	$02 
14618  3C92 27 E8       		.word	$E827 
14619  3C94 10 E8       		.word	$E810
14620  3C96             		
14621  3C96 02          		.byte	$02 
14622  3C97 EF F8       		.word	$F8EF 
14623  3C99 10 F8       		.word	$F810
14624  3C9B             		
14625  3C9B AA          		.byte	$AA		; End of stage data
14626  3C9C             ;------------------------------------------------------------------------------
14627  3C9C             
14628  3C9C             
14629  3C9C             
14630  3C9C             ;------------------------------------------------------------------------------
14631  3C9C             ; Stage data for the rivets stage
14632  3C9C             L_RIVETS_STAGE_DATA:
14633  3C9C 00          		.byte	$00 
14634  3C9D 7B 80       		.word	$807B 
14635  3C9F 7B A8       		.word	$A87B
14636  3CA1             		
14637  3CA1 00          		.byte	$00 
14638  3CA2 7B D0       		.word	$D07B 
14639  3CA4 7B F8       		.word	$F87B
14640  3CA6             		
14641  3CA6 00          		.byte	$00 
14642  3CA7 33 58       		.word	$5833 
14643  3CA9 33 80       		.word	$8033
14644  3CAB             		
14645  3CAB 00          		.byte	$00 
14646  3CAC 53 58       		.word	$5853 
14647  3CAE 53 80       		.word	$8053
14648  3CB0             		
14649  3CB0 00          		.byte	$00 
14650  3CB1 AB 58       		.word	$58AB 
14651  3CB3 AB 80       		.word	$80AB
14652  3CB5             		
14653  3CB5 00          		.byte	$00 
14654  3CB6 CB 58       		.word	$58CB 
14655  3CB8 CB 80       		.word	$80CB
14656  3CBA             		
14657  3CBA 00          		.byte	$00 
14658  3CBB 2B 80       		.word	$802B 
14659  3CBD 2B A8       		.word	$A82B
14660  3CBF             		
14661  3CBF 00          		.byte	$00 
14662  3CC0 D3 80       		.word	$80D3 
14663  3CC2 D3 A8       		.word	$A8D3
14664  3CC4             		
14665  3CC4 00          		.byte	$00 
14666  3CC5 23 A8       		.word	$A823 
14667  3CC7 23 D0       		.word	$D023
14668  3CC9             		
14669  3CC9 00          		.byte	$00 
14670  3CCA 5B A8       		.word	$A85B 
14671  3CCC 5B D0       		.word	$D05B
14672  3CCE             		
14673  3CCE 00          		.byte	$00 
14674  3CCF A3 A8       		.word	$A8A3 
14675  3CD1 A3 D0       		.word	$D0A3
14676  3CD3             		
14677  3CD3 00          		.byte	$00 
14678  3CD4 DB A8       		.word	$A8DB 
14679  3CD6 DB D0       		.word	$D0DB
14680  3CD8             		
14681  3CD8 00          		.byte	$00 
14682  3CD9 1B D0       		.word	$D01B 
14683  3CDB 1B F8       		.word	$F81B
14684  3CDD             		
14685  3CDD 00          		.byte	$00 
14686  3CDE E3 D0       		.word	$D0E3 
14687  3CE0 E3 F8       		.word	$F8E3
14688  3CE2             		
14689  3CE2 05          		.byte	$05 
14690  3CE3 B7 30       		.word	$30B7 
14691  3CE5 48 30       		.word	$3048
14692  3CE7             		
14693  3CE7 05          		.byte	$05 
14694  3CE8 CF 58       		.word	$58CF 
14695  3CEA 30 58       		.word	$5830
14696  3CEC             		
14697  3CEC 05          		.byte	$05 
14698  3CED D7 80       		.word	$80D7 
14699  3CEF 28 80       		.word	$8028
14700  3CF1             		
14701  3CF1 05          		.byte	$05 
14702  3CF2 DF A8       		.word	$A8DF 
14703  3CF4 20 A8       		.word	$A820
14704  3CF6             		
14705  3CF6 05          		.byte	$05 
14706  3CF7 E7 D0       		.word	$D0E7 
14707  3CF9 18 D0       		.word	$D018
14708  3CFB             		
14709  3CFB 05          		.byte	$05 
14710  3CFC EF F8       		.word	$F8EF 
14711  3CFE 10 F8       		.word	$F810
14712  3D00             		
14713  3D00 AA          		.byte	$AA		; End of stage data
14714  3D01             ;------------------------------------------------------------------------------
14715  3D01             
14716  3D01             
14717  3D01             
14718  3D01             ;------------------------------------------------------------------------------
14719  3D01             ; Stage data for the secret stage
14720  3D01             L_SECRET_STAGE_DATA:
14721  3D01             		; Ladders
14722  3D01 00          		NRM_LAD_STAGE_DATA(3,25,3,31)	; Bottom left
14722  3D02 1B C8       
14722  3D04 1B F8       
14723  3D06 01          		BRK_LAD_STAGE_DATA(28,25,28,31)	; Bottom right
14723  3D07 EB C8       
14723  3D09 EB F8       
14724  3D0B 01          		BRK_LAD_STAGE_DATA(9,19,9,25)	; Lower mid left
14724  3D0C 4B 98       
14724  3D0E 4B C8       
14725  3D10 00          		NRM_LAD_STAGE_DATA(21,19,21,25)	; Lower mid right
14725  3D11 AB 98       
14725  3D13 AB C8       
14726  3D15 01          		BRK_LAD_STAGE_DATA(3,13,3,19)	; Upper mid left
14726  3D16 1B 68       
14726  3D18 1B 98       
14727  3D1A 00          		NRM_LAD_STAGE_DATA(28,13,28,19)	; Upper mid right
14727  3D1B EB 68       
14727  3D1D EB 98       
14728  3D1F 00          		NRM_LAD_STAGE_DATA(9,7,9,13)	; Top left
14728  3D20 4B 38       
14728  3D22 4B 68       
14729  3D24 01          		BRK_LAD_STAGE_DATA(21,7,21,13)	; Top right
14729  3D25 AB 38       
14729  3D27 AB 68       
14730  3D29             
14731  3D29             		; Top platform
14732  3D29 02          		STAGE_DATA(SLP_GIRDER_TILE,20,7,10,7)
14732  3D2A A0 38       
14732  3D2C 50 38       
14733  3D2E             		
14734  3D2E             		; Upper middle platforms
14735  3D2E 02          		STAGE_DATA(SLP_GIRDER_TILE,11,13,2,13)
14735  3D2F 58 68       
14735  3D31 10 68       
14736  3D33 02          		STAGE_DATA(SLP_GIRDER_TILE,30,13,20,13)
14736  3D34 F0 68       
14736  3D36 A0 68       
14737  3D38             
14738  3D38             		; Mid middle platforms
14739  3D38 02          		STAGE_DATA(SLP_GIRDER_TILE,11,19,2,19)
14739  3D39 58 98       
14739  3D3B 10 98       
14740  3D3D 02          		STAGE_DATA(SLP_GIRDER_TILE,30,19,20,19)
14740  3D3E F0 98       
14740  3D40 A0 98       
14741  3D42             
14742  3D42             		; Lower middle platforms
14743  3D42 02          		STAGE_DATA(SLP_GIRDER_TILE,11,25,2,25)
14743  3D43 58 C8       
14743  3D45 10 C8       
14744  3D47 02          		STAGE_DATA(SLP_GIRDER_TILE,28,25,20,25)
14744  3D48 E0 C8       
14744  3D4A A0 C8       
14745  3D4C             
14746  3D4C             		; Bottom platforms
14747  3D4C 02          		STAGE_DATA(SLP_GIRDER_TILE,11,31,2,31)
14747  3D4D 58 F8       
14747  3D4F 10 F8       
14748  3D51 02          		STAGE_DATA(SLP_GIRDER_TILE,30,31,20,31)
14748  3D52 F0 F8       
14748  3D54 A0 F8       
14749  3D56             		
14750  3D56 AA          		.byte	$AA		; End of stage data
14751  3D57             ;------------------------------------------------------------------------------
14752  3D57             
14753  3D57             
14754  3D57             
14755  3D57             ;------------------------------------------------------------------------------
14756  3D57             ; The following strings are used to display the height of the next stage on
14757  3D57             ; the intermission screen
14758  3D57             ; " 25m"
14759  3D57             L_HEIGHT_STRING_TABLE:  
14760  3D57 10 82 85 8B 		.byte	$10, $82, $85, $8B
14761  3D5B             
14762  3D5B              ; " 50m"
14763  3D5B 10 85 80 8B l3cf4:  .byte	$10, $85, $80, $8B
14764  3D5F             
14765  3D5F              ; " 75m"
14766  3D5F 10 87 85 8B l3cf8:  .byte	$10, $87, $85, $8B
14767  3D63             
14768  3D63              ; "100m"
14769  3D63 81 80 80 8B l3cfc:  .byte	$81, $80, $80, $8B
14770  3D67             		
14771  3D67              ; "125m"
14772  3D67 81 82 85 8B l3d00:  .byte	$81, $82, $85, $8B
14773  3D6B             		
14774  3D6B              ; "150m"
14775  3D6B 81 85 80 8B l3d04:  .byte	$81, $85, $80, $8B
14776  3D6F             ;------------------------------------------------------------------------------
14777  3D6F             
14778  3D6F             
14779  3D6F             
14780  3D6F             ;------------------------------------------------------------------------------
14781  3D6F             ; The following data describes how to draw the "DONKEY KONG" title in large
14782  3D6F             ; letters on the title screen.
14783  3D6F             ;
14784  3D6F             ; Each entry consists of a one-byte number of tiles to draw and a two-byte
14785  3D6F             ; screen coordinate.  The tiles are drawn starting at the coordinate and 
14786  3D6F             ; moving down for the indicated number of tiles.
14787  3D6F             ; 
14788  3D6F             L_LARGE_DK_LETTER_DATA:	
14789  3D6F             		; 'D'
14790  3D6F 05          		.byte	5
14791  3D70 87 77       		.word	TILE_COORD(28,7)
14792  3D72 01          		.byte	1
14793  3D73 67 77       		.word	TILE_COORD(27,7)
14794  3D75 01          		.byte	1
14795  3D76 6B 77       		.word	TILE_COORD(27,11)
14796  3D78 03          		.byte	3
14797  3D79 48 77       		.word	TILE_COORD(26,8)
14798  3D7B             		
14799  3D7B             		; 'O'
14800  3D7B 05          		.byte	5 
14801  3D7C 07 77       		.word	TILE_COORD(24,7) 
14802  3D7E 01          		.byte	1 
14803  3D7F E7 76       		.word	TILE_COORD(23,7) 
14804  3D81 01          		.byte	1 
14805  3D82 EB 76       		.word	TILE_COORD(23,11) 
14806  3D84 05          		.byte	5 
14807  3D85 C7 76       		.word	TILE_COORD(22,7) 
14808  3D87             
14809  3D87             		; 'N'
14810  3D87 05          		.byte	5 
14811  3D88 87 76       		.word	TILE_COORD(20,7) 
14812  3D8A 02          		.byte	2 
14813  3D8B 68 76       		.word	TILE_COORD(19,8) 
14814  3D8D 02          		.byte	2 
14815  3D8E 49 76       		.word	TILE_COORD(18,9) 
14816  3D90 05          		.byte	5 
14817  3D91 27 76       		.word	TILE_COORD(17,7) 
14818  3D93             
14819  3D93             		; 'K'
14820  3D93 05          		.byte	5 
14821  3D94 E7 75       		.word	TILE_COORD(15,7) 
14822  3D96 01          		.byte	1 
14823  3D97 C9 75       		.word	TILE_COORD(14,9) 
14824  3D99 03          		.byte	3 
14825  3D9A A9 75       		.word	TILE_COORD(13,9) 
14826  3D9C 01          		.byte	1 
14827  3D9D 87 75       		.word	TILE_COORD(12,7) 
14828  3D9F 01          		.byte	1 
14829  3DA0 8B 75       		.word	TILE_COORD(12,11) 
14830  3DA2             
14831  3DA2             		; 'E'
14832  3DA2 05          		.byte	5 
14833  3DA3 47 75       		.word	TILE_COORD(10,7) 
14834  3DA5 01          		.byte	1 
14835  3DA6 27 75       		.word	TILE_COORD(9,7)
14836  3DA8 01          		.byte	1 
14837  3DA9 29 75       		.word	TILE_COORD(9,9)
14838  3DAB 01          		.byte	1 
14839  3DAC 2B 75       		.word	TILE_COORD(9,11)
14840  3DAE 01          		.byte	1 
14841  3DAF 07 75       		.word	TILE_COORD(8,7)
14842  3DB1 01          		.byte	1 
14843  3DB2 09 75       		.word	TILE_COORD(8,9)
14844  3DB4 01          		.byte	1 
14845  3DB5 0B 75       		.word	TILE_COORD(8,11)
14846  3DB7             
14847  3DB7             		; 'Y'
14848  3DB7 03          		.byte	3 
14849  3DB8 C7 74       		.word	TILE_COORD(6,7)
14850  3DBA 03          		.byte	3 
14851  3DBB A9 74       		.word	TILE_COORD(5,9)
14852  3DBD 03          		.byte	3 
14853  3DBE 87 74       		.word	TILE_COORD(4,7)
14854  3DC0             
14855  3DC0             		; 'K'
14856  3DC0 05          		.byte	5 
14857  3DC1 2E 77       		.word	TILE_COORD(25,14)
14858  3DC3 05          		.byte	5 
14859  3DC4 0E 77       		.word	TILE_COORD(24,14)
14860  3DC6 02          		.byte	2 
14861  3DC7 EF 76       		.word	TILE_COORD(23,15)
14862  3DC9 02          		.byte	2 
14863  3DCA CE 76       		.word	TILE_COORD(22,14)
14864  3DCC 02          		.byte	2 
14865  3DCD D1 76       		.word	TILE_COORD(22,17)
14866  3DCF             
14867  3DCF             		; 'O'
14868  3DCF 05          		.byte	5 
14869  3DD0 8E 76       		.word	TILE_COORD(20,14)
14870  3DD2 05          		.byte	5 
14871  3DD3 6E 76       		.word	TILE_COORD(19,14)
14872  3DD5 01          		.byte	1 
14873  3DD6 4E 76       		.word	TILE_COORD(18,14)
14874  3DD8 01          		.byte	1 
14875  3DD9 52 76       		.word	TILE_COORD(18,18)
14876  3DDB 05          		.byte	5 
14877  3DDC 2E 76       		.word	TILE_COORD(17,14)
14878  3DDE             
14879  3DDE             		; 'N'  
14880  3DDE 05          		.byte	5 
14881  3DDF EE 75       		.word	TILE_COORD(15,14)
14882  3DE1 02          		.byte	2 
14883  3DE2 CF 75       		.word	TILE_COORD(14,15)
14884  3DE4 02          		.byte	2 
14885  3DE5 B0 75       		.word	TILE_COORD(13,16)
14886  3DE7 05          		.byte	5 
14887  3DE8 8E 75       		.word	TILE_COORD(12,14)
14888  3DEA             
14889  3DEA             		; 'G'
14890  3DEA 03          		.byte	3 
14891  3DEB 4F 75       		.word	TILE_COORD(10,15)
14892  3DED 05          		.byte	5 
14893  3DEE 2E 75       		.word	TILE_COORD(9,14)
14894  3DF0 01          		.byte	1 
14895  3DF1 0E 75       		.word	TILE_COORD(8,14)
14896  3DF3 01          		.byte	1 
14897  3DF4 12 75       		.word	TILE_COORD(8,18)
14898  3DF6 01          		.byte	1 
14899  3DF7 EE 74       		.word	TILE_COORD(7,14)
14900  3DF9 01          		.byte	1 
14901  3DFA F0 74       		.word	TILE_COORD(7,16)
14902  3DFC 01          		.byte	1 
14903  3DFD F2 74       		.word	TILE_COORD(7,18)
14904  3DFF 02          		.byte	2 
14905  3E00 D0 74       		.word	TILE_COORD(6,16)
14906  3E02             
14907  3E02 00          		.byte	$00		; End of data
14908  3E03             ;------------------------------------------------------------------------------
14909  3E03              
14910  3E03             
14911  3E03             
14912  3E03             ;------------------------------------------------------------------------------
14913  3E03             ; The following data is used to initialize the value of game variables ($6280 -
14914  3E03             ; $62bf) before every stage
14915  3E03             L_INITIAL_STAGE_DATA_TABLE:	
14916  3E03 00          		.byte	0	; L_RETRACT_LADDER_STATE = up
14917  3E04 00          		.byte	0	; L_RETRACT_LADDER_DELAY (minimum)
14918  3E05 23          		.byte	35	; L_RETRACT_LADDER_X
14919  3E06 68          		.byte	104	; L_RETRACT_LADDER_Y (all the way up)
14920  3E07 01          		.byte	1	; L_RETRACT_LADDER_MOVE_DELAY
14921  3E08 11          		.byte	17	; $6285
14922  3E09 00          		.byte	0	; $6286
14923  3E0A 00          		.byte	0	; $6287
14924  3E0B 00          		.byte	0	; R_RETRACT_LADDER_STATE = up
14925  3E0C 10          		.byte	16	; R_RETRACT_LADDER_DELAY
14926  3E0D DB          		.byte	219	; R_RETRACT_LADDER_X
14927  3E0E 68          		.byte	104	; R_RETRACT_LADDER_Y (all the way up)
14928  3E0F 01          		.byte	1	; R_RETRACT_LADDER_MOVE_DELAY
14929  3E10 40          		.byte	64	; $628D
14930  3E11 00          		.byte	0	; $628E
14931  3E12 00          		.byte	0	; $628F
14932  3E13 08          		.byte	8	; REMAINING_RIVETS
14933  3E14 01          		.byte	1	; $6291
14934  3E15 01          		.byte	1	; $6292
14935  3E16 01          		.byte	1	; $6293
14936  3E17 01          		.byte	1	; $6294
14937  3E18 01          		.byte	1	; $6295
14938  3E19 01          		.byte	1	; $6296
14939  3E1A 01          		.byte	1	; $6297
14940  3E1B 01          		.byte	1	; $6298
14941  3E1C 01          		.byte	1	; $6299
14942  3E1D 00          		.byte	0	; $629A
14943  3E1E 00          		.byte	0	; $629B
14944  3E1F 00          		.byte	0	; $629C
14945  3E20 00          		.byte	0	; $629D
14946  3E21 00          		.byte	0	; $629E
14947  3E22 00          		.byte	0	; $629F
14948  3E23 80          		.byte	128	; TOP_MASTER_REVERSE_TIMER
14949  3E24 01          		.byte	1	; TOP_MASTER_CONVEYER_DIR (moving right)
14950  3E25 C0          		.byte	192	; MID_MASTER_REVERSE_TIMER
14951  3E26 FF          		.byte	-1	; RIGHT_MASTER_CONVEYER_DIR (moving left)
14952  3E27 01          		.byte	1	; LEFT_MASTER_CONVEYER_DIR, SECRET_ELEVATOR_DIR
14953  3E28 FF          		.byte	255	; BOT_MASTER_REVERSE_TIMER
14954  3E29 FF          		.byte	-1	; BOT_MASTER_CONVEYER_DIR (moving left)
14955  3E2A 34          		.byte	52	; ELEVATOR_SPAWN_TIMER
14956  3E2B D4 39       		.word	l39c3	; $62A8
14957  3E2D 00 67       		.word	BARREL_STRUCTS	; $62AA
14958  3E2F 80 69       		.word	SPRING_SPRITES	; $62AC
14959  3E31 1A          		.byte	26	; $62AE
14960  3E32 01          		.byte	1 	; DK_CLIMBING_COUNTER
14961  3E33 00          		.byte	0 	; INTERNAL_TIMER
14962  3E34 00          		.byte	0 	; $62B1
14963  3E35 00          		.byte	0 	; $62B2
14964  3E36 00          		.byte	0 	; $62B3
14965  3E37 00          		.byte	0	; $62B4
14966  3E38 00          		.byte	0	; $62B5, 
14967  3E39 00          		.byte	0	; $62B6, SECRET_ELEVATOR_MOVE_COUNT
14968  3E3A 00          		.byte	0 	; $62B7, SECRET_ELEVATOR_QUAD
14969  3E3B 04          		.byte	4 	; BARREL_FIRE_FREEZE, CAGE_BARS_REMAINING
14970  3E3C 00          		.byte	0 	; BARREL_FIRE_STATE, SECRET_ELEVATOR_PAUSE_COUNT
14971  3E3D 10          		.byte	16 	; BARREL_FIRE_FLARE_UP_TIME
14972  3E3E 00          		.byte	0 	; $62BB, SECRET_ELEVATOR_REVERSE
14973  3E3F 00          		.byte	0 	; $62BC
14974  3E40 00          		.byte	0 	; $62BD
14975  3E41 00          		.byte	0 	; $62BE
14976  3E42 00          		.byte	0 	; $62BF
14977  3E43             ;------------------------------------------------------------------------------
14978  3E43              
14979  3E43             
14980  3E43             
14981  3E43             ;------------------------------------------------------------------------------
14982  3E43             ; Sprite data for the four upright barrels standing to Donkey Kong's left on the
14983  3E43             ; barrels stage.
14984  3E43             L_STANDING_BARRELS_SPRITE_DATA:	
14985  3E43 1E          		.byte	30 		; x coord
14986  3E44 18          		.byte	$18		; sprite number ($18 - upright barrel)
14987  3E45 0B          		.byte	$0B 	; palette
14988  3E46 4B          		.byte	75 		; y coord
14989  3E47             
14990  3E47 14          		.byte	20 		; x coord
14991  3E48 18          		.byte	$18		; sprite number ($18 - upright barrel)
14992  3E49 0B          		.byte	$0B 	; palette
14993  3E4A 4B          		.byte	75 		; y coord
14994  3E4B             
14995  3E4B 1E          		.byte	30 		; x coord
14996  3E4C 18          		.byte	$18		; sprite number ($18 - upright barrel)
14997  3E4D 0B          		.byte	$0B 	; palette
14998  3E4E 3B          		.byte	59 		; y coord
14999  3E4F             
15000  3E4F 14          		.byte	20 		; x coord
15001  3E50 18          		.byte	$18		; sprite number ($18 - upright barrel)
15002  3E51 0B          		.byte	$0B 	; palette
15003  3E52 3B          		.byte	59 		; y coord
15004  3E53             ;------------------------------------------------------------------------------
15005  3E53             
15006  3E53             
15007  3E53             
15008  3E53             ;------------------------------------------------------------------------------
15009  3E53             ; Initial sprite data for fire balls
15010  3E53             L_FIREBALL_SPRITE_DATA:	
15011  3E53 3D          		.byte	$3D	; Fire ball sprite
15012  3E54 01          		.byte	$01	; Palette
15013  3E55 03          		.byte	3
15014  3E56 02          		.byte	2
15015  3E57             ;------------------------------------------------------------------------------
15016  3E57             
15017  3E57             
15018  3E57             
15019  3E57             ;------------------------------------------------------------------------------
15020  3E57             ; Initial sprite data for firefoxes
15021  3E57             L_FIREFOX_SPRITE_DATA:	
15022  3E57 4D          		.byte	$4D	; Firefox sprite
15023  3E58 01          		.byte	$01	; Palette
15024  3E59 04          		.byte	4
15025  3E5A 01          		.byte	1
15026  3E5B             ;------------------------------------------------------------------------------
15027  3E5B             
15028  3E5B             
15029  3E5B             
15030  3E5B             ;------------------------------------------------------------------------------
15031  3E5B             ; Initial coordinates for the fireballs on the secret stage
15032  3E5B             L_SECRET_FIREBALL_COORDS:
15033  3E5B D8          		.byte	216	; X coordinate
15034  3E5C 90          		.byte	144	; Y coordinate
15035  3E5D             
15036  3E5D 30          		.byte	48	; X coordinate
15037  3E5E C0          		.byte	192	; Y coordinate
15038  3E5F             		
15039  3E5F 96          		.byte	150	; X coordinate
15040  3E60 30          		.byte	48	; Y coordinate
15041  3E61             		
15042  3E61 50          		.byte	80	; X coordinate
15043  3E62 90          		.byte	144	; Y coordinate
15044  3E63             		
15045  3E63 58          		.byte	88	; X coordinate
15046  3E64 30          		.byte	48	; Y coordinate
15047  3E65             ;------------------------------------------------------------------------------
15048  3E65             
15049  3E65             
15050  3E65             
15051  3E65             ;------------------------------------------------------------------------------
15052  3E65             ; Initial sprite data for the oil barrel fire on the barrels stage
15053  3E65             ; This is before the fire is lit
15054  3E65             L_BARRELS_FIRE_SPRITE_DATA:	
15055  3E65 27          		.byte	39	; X coordinate
15056  3E66 70          		.byte	$70	; Blank sprite
15057  3E67 01          		.byte	$01	; Palette
15058  3E68 E0          		.byte	224	; Y coordinate
15059  3E69 00          		.byte	0
15060  3E6A 00          		.byte	0
15061  3E6B             ;------------------------------------------------------------------------------
15062  3E6B             
15063  3E6B             
15064  3E6B             
15065  3E6B             ;------------------------------------------------------------------------------
15066  3E6B             ; Initial sprite data for the oil barrel fire on the mixer stage
15067  3E6B             ; The fire is initially burning
15068  3E6B             L_MIXER_FIRE_SPRITE_DATA:	
15069  3E6B 7F          		.byte	127	; X coordinate
15070  3E6C 40          		.byte	$40	; Burning fire sprite
15071  3E6D 01          		.byte	$01	; Palette
15072  3E6E 78          		.byte	120	; Y coordinate
15073  3E6F 02          		.byte	2
15074  3E70 00          		.byte	0
15075  3E71             ;------------------------------------------------------------------------------
15076  3E71             
15077  3E71             
15078  3E71             
15079  3E71             ;------------------------------------------------------------------------------
15080  3E71             ; Sprite data for the oil barrel on the barrels stage
15081  3E71             L_OIL_BARREL_SPRITE_DATA_1: 
15082  3E71 27          		.byte	39		; x coord 
15083  3E72 49          		.byte	$49		; sprite number 
15084  3E73 0C          		.byte	$0C		; palette
15085  3E74 F0          		.byte	240		; y coord
15086  3E75             ;------------------------------------------------------------------------------
15087  3E75             
15088  3E75             
15089  3E75             
15090  3E75             ;------------------------------------------------------------------------------
15091  3E75             ; Sprite data for the oil can on the mixer stage
15092  3E75             L_OIL_BARREL_SPRITE_DATA_2: 	
15093  3E75 7F          		.byte	127		; x coord 
15094  3E76 49          		.byte	$49		; sprite number 
15095  3E77 0C          		.byte	$0C		; palette
15096  3E78 88          		.byte	136		; y coord
15097  3E79             ;------------------------------------------------------------------------------
15098  3E79             
15099  3E79             
15100  3E79             ;------------------------------------------------------------------------------
15101  3E79             ; Sprite data for the hammers that Mario can grab
15102  3E79             L_HAMMER_SPRITE_DATA:	
15103  3E79 1E          		.byte	$1E	; Upright Hammer
15104  3E7A 07          		.byte	$07	; Palette
15105  3E7B 03          		.byte	3
15106  3E7C 09          		.byte	9
15107  3E7D             ;------------------------------------------------------------------------------
15108  3E7D             
15109  3E7D             
15110  3E7D             
15111  3E7D             ;------------------------------------------------------------------------------
15112  3E7D             ; Initial coordinates for the hammers on the barrels stage
15113  3E7D             L_BARRELS_HAMMER_COORDS:	
15114  3E7D 24          		.byte	36	; X coordinate
15115  3E7E 64          		.byte	100	; Y coordinate
15116  3E7F             		
15117  3E7F BB          		.byte	187	; X coordinate
15118  3E80 C0          		.byte	192	; Y coordinate
15119  3E81             ;------------------------------------------------------------------------------
15120  3E81             
15121  3E81             
15122  3E81             
15123  3E81             ;------------------------------------------------------------------------------
15124  3E81             ; Initial coordinates for the hammers on the mixer stage
15125  3E81             L_MIXER_HAMMER_COORDS:	
15126  3E81 23          		.byte	35	; X coordinate
15127  3E82 8D          		.byte	141	; Y coordinate
15128  3E83             		
15129  3E83 7B          		.byte	123	; X coordinate
15130  3E84 B4          		.byte	180	; Y coordinate
15131  3E85             ;------------------------------------------------------------------------------
15132  3E85             
15133  3E85             
15134  3E85             
15135  3E85             ;------------------------------------------------------------------------------
15136  3E85             ; Initial coordinates for the hammers on the rivets stage
15137  3E85             L_RIVETS_HAMMER_COORDS:	
15138  3E85 1B          		.byte	27	; X coordinate
15139  3E86 8C          		.byte	140	; Y coordinate
15140  3E87             		
15141  3E87 7C          		.byte	124	; X coordinate
15142  3E88 64          		.byte	100	; Y coordinate
15143  3E89             ;------------------------------------------------------------------------------
15144  3E89             
15145  3E89             
15146  3E89             
15147  3E89             ;------------------------------------------------------------------------------
15148  3E89             ; Sprite data for pies on the mixer stage
15149  3E89             L_PIE_SPRITE_DATA:	
15150  3E89 4B          		.byte	$4B	; Pie sprite
15151  3E8A 0E          		.byte	$0E	; Palette
15152  3E8B 04          		.byte	4
15153  3E8C 02          		.byte	2
15154  3E8D             ;------------------------------------------------------------------------------
15155  3E8D             
15156  3E8D             
15157  3E8D             
15158  3E8D             ;------------------------------------------------------------------------------
15159  3E8D             ; Sprite data for the retractable ladders on the mixer level
15160  3E8D             L_RETRACT_LADDER_SPRITE_DATA:	
15161  3E8D 23          		.byte	35		; x coord 
15162  3E8E 46          		.byte	$46 	; sprite number
15163  3E8F 03          		.byte	$03 	; palette
15164  3E90 68          		.byte	104		; y coord
15165  3E91             		
15166  3E91 DB          		.byte	219		; x coord 
15167  3E92 46          		.byte	$46 	; sprite number
15168  3E93 03          		.byte	$03 	; palette
15169  3E94 68          		.byte	104		; y coord
15170  3E95             ;------------------------------------------------------------------------------
15171  3E95             
15172  3E95             
15173  3E95             
15174  3E95             ;------------------------------------------------------------------------------
15175  3E95             ; Sprite data for the conveyer motors on the mixer level
15176  3E95             L_MIXER_MOTOR_SPRITE_DATA:	
15177  3E95             		; CONV_MOTOR_SPRITE_TL (Top left)
15178  3E95 17          		.byte	23		; x coord 
15179  3E96 50          		.byte	$50 	; sprite number
15180  3E97 00          		.byte	$00 	; palette
15181  3E98 5C          		.byte	92		; y coord
15182  3E99             		
15183  3E99             		; CONV_MOTOR_SPRITE_TR (Top right)
15184  3E99 E7          		.byte	231		; x coord 
15185  3E9A D0          		.byte	$D0 	; sprite number ($50 - horizontally reversed)
15186  3E9B 00          		.byte	$00 	; palette
15187  3E9C 5C          		.byte	92		; y coord
15188  3E9D             		
15189  3E9D             		; CONV_MOTOR_SPRITE_MR (Middle right)
15190  3E9D 8C          		.byte	140		; x coord 
15191  3E9E 50          		.byte	$50 	; sprite number
15192  3E9F 00          		.byte	$00 	; palette
15193  3EA0 84          		.byte	132		; y coord
15194  3EA1             		
15195  3EA1             		; CONV_MOTOR_SPRITE_ML (Middle left)
15196  3EA1 73          		.byte	115		; x coord 
15197  3EA2 D0          		.byte	$D0 	; sprite number ($50 - horizontally reversed)
15198  3EA3 00          		.byte	$00 	; palette
15199  3EA4 84          		.byte	132		; y coord
15200  3EA5             		
15201  3EA5             		; CONV_MOTOR_SPRITE_BL (Bottom left)
15202  3EA5 17          		.byte	23		; x coord 
15203  3EA6 50          		.byte	$50 	; sprite number
15204  3EA7 00          		.byte	$00 	; palette
15205  3EA8 D4          		.byte	212		; y coord
15206  3EA9             		
15207  3EA9             		; CONV_MOTOR_SPRITE_BR (Bottom right)
15208  3EA9 E7          		.byte	231		; x coord 
15209  3EAA D0          		.byte	$D0 	; sprite number ($50 - horizontally reversed)
15210  3EAB 00          		.byte	$00 	; palette
15211  3EAC D4          		.byte	212		; y coord
15212  3EAD             ;------------------------------------------------------------------------------
15213  3EAD             
15214  3EAD             
15215  3EAD             
15216  3EAD             ;------------------------------------------------------------------------------
15217  3EAD             ; Sprite data for bonus prizes on the mixer stage
15218  3EAD             L_MIXER_PRIZE_SPRITE_DATA:	
15219  3EAD 53          		.byte	83		; x coord 
15220  3EAE 73          		.byte	$73 	; sprite number (Pauline's hat)
15221  3EAF 0A          		.byte	$0A 	; palette
15222  3EB0             
15223  3EB0 A0          		.byte	160		; y coord
15224  3EB1             		
15225  3EB1 8B          		.byte	139		; x coord 
15226  3EB2 74          		.byte	$74 	; sprite number	(Pauline's purse)
15227  3EB3 0A          		.byte	$0A 	; palette
15228  3EB4 F0          		.byte	240		; y coord
15229  3EB5             		
15230  3EB5 DB          		.byte	219		; x coord 
15231  3EB6 75          		.byte	$75 	; sprite number (Pauline's umbrella)
15232  3EB7 0A          		.byte	$0A 	; palette
15233  3EB8 A0          		.byte	160		; y coord
15234  3EB9             ;------------------------------------------------------------------------------
15235  3EB9             
15236  3EB9             
15237  3EB9             
15238  3EB9             ;------------------------------------------------------------------------------
15239  3EB9             ; Sprite data for bonus prizes on the elevators stage
15240  3EB9             L_ELEV_PRIZE_SPRITE_DATA:	
15241  3EB9 5B          		.byte	91		; x coord 
15242  3EBA 73          		.byte	$73 	; sprite number (Pauline's hat)
15243  3EBB 0A          		.byte	$0A 	; palette
15244  3EBC C8          		.byte	200		; y coord
15245  3EBD             		
15246  3EBD E3          		.byte	227		; x coord 
15247  3EBE 74          		.byte	$74 	; sprite number	(Pauline's purse)
15248  3EBF 0A          		.byte	$0A 	; palette
15249  3EC0 60          		.byte	96		; y coord
15250  3EC1             		
15251  3EC1 1B          		.byte	27		; x coord 
15252  3EC2 75          		.byte	$75 	; sprite number (Pauline's umbrella)
15253  3EC3 0A          		.byte	$0A 	; palette
15254  3EC4 80          		.byte	128		; y coord
15255  3EC5             ;------------------------------------------------------------------------------
15256  3EC5             
15257  3EC5             
15258  3EC5             
15259  3EC5             ;------------------------------------------------------------------------------
15260  3EC5             ; Sprite data for bonus prizes on the rivets stage
15261  3EC5             L_RIVETS_PRIZE_SPRITE_DATA:	
15262  3EC5 DB          		.byte	219		; x coord 
15263  3EC6 73          		.byte	$73 	; sprite number (Pauline's hat)
15264  3EC7 0A          		.byte	$0A 	; palette
15265  3EC8 C8          		.byte	200		; y coord
15266  3EC9             		
15267  3EC9 93          		.byte	147		; x coord 
15268  3ECA 74          		.byte	$74 	; sprite number	(Pauline's purse)
15269  3ECB 0A          		.byte	$0A 	; palette
15270  3ECC F0          		.byte	240		; y coord
15271  3ECD             		
15272  3ECD 33          		.byte	51		; x coord 
15273  3ECE 75          		.byte	$75 	; sprite number (Pauline's umbrella)
15274  3ECF 0A          		.byte	$0A 	; palette
15275  3ED0 50          		.byte	80		; y coord
15276  3ED1             ;------------------------------------------------------------------------------
15277  3ED1             
15278  3ED1             
15279  3ED1             
15280  3ED1             ;------------------------------------------------------------------------------
15281  3ED1             ; Sprite data for bonus prizes on the rivets stage
15282  3ED1             L_SECRET_PRIZE_SPRITE_DATA:	
15283  3ED1 20          		.byte	32		; x coord 
15284  3ED2 73          		.byte	$73 	; sprite number (Pauline's hat)
15285  3ED3 0A          		.byte	$0A 	; palette
15286  3ED4 C0          		.byte	192		; y coord
15287  3ED5             		
15288  3ED5 30          		.byte	48		; x coord 
15289  3ED6 74          		.byte	$74 	; sprite number	(Pauline's purse)
15290  3ED7 0A          		.byte	$0A 	; palette
15291  3ED8 60          		.byte	96		; y coord
15292  3ED9             		
15293  3ED9 D8          		.byte	216		; x coord 
15294  3EDA 75          		.byte	$75 	; sprite number (Pauline's umbrella)
15295  3EDB 0A          		.byte	$0A 	; palette
15296  3EDC 90          		.byte	144		; y coord
15297  3EDD             ;------------------------------------------------------------------------------
15298  3EDD             
15299  3EDD             
15300  3EDD             
15301  3EDD             ;------------------------------------------------------------------------------
15302  3EDD             ; Sprite data for the cage triggers on the secret stage
15303  3EDD             L_SECRET_TRIGGER_DATA:
15304  3EDD D4          		.byte	212		; x coord
15305  3EDE 62          		.byte	$62		; sprite number ("Button")
15306  3EDF 0F          		.byte	$0F		; palette
15307  3EE0 C0          		.byte	192		; y coord
15308  3EE1             
15309  3EE1 40          		.byte	64		; x coord
15310  3EE2 62          		.byte	$62		; sprite number ("Button")
15311  3EE3 0F          		.byte	$0F		; palette
15312  3EE4 90          		.byte	144		; y coord
15313  3EE5             
15314  3EE5 DC          		.byte	220		; x coord
15315  3EE6 62          		.byte	$62		; sprite number ("Button")
15316  3EE7 0F          		.byte	$0F		; palette
15317  3EE8 60          		.byte	96		; y coord
15318  3EE9             
15319  3EE9 74          		.byte	116		; x coord
15320  3EEA 62          		.byte	$62		; sprite number ("Button")
15321  3EEB 0F          		.byte	$0F		; palette
15322  3EEC 30          		.byte	48		; y coord
15323  3EED             		
15324  3EED             ;------------------------------------------------------------------------------
15325  3EED             
15326  3EED             
15327  3EED             
15328  3EED             ;------------------------------------------------------------------------------
15329  3EED             ; Sprite data for the elevator platforms on the elevators stage
15330  3EED             L_ELEVATOR_SPRITE_DATA:	
15331  3EED 44          		.byte	$44		; Elevator platform sprite
15332  3EEE 03          		.byte	$03		; Palette
15333  3EEF 08          		.byte	8
15334  3EF0 04          		.byte	4
15335  3EF1             ;------------------------------------------------------------------------------
15336  3EF1             
15337  3EF1             
15338  3EF1             
15339  3EF1             ;------------------------------------------------------------------------------
15340  3EF1             ; The initial coordinates for the elevators on the elevators stage
15341  3EF1             L_ELEVATOR_COORDS:	
15342  3EF1 37          		.byte	55	; X coordinate
15343  3EF2 F4          		.byte	244	; Y coordinate
15344  3EF3             		
15345  3EF3 37          		.byte	55	; X coordinate
15346  3EF4 C0          		.byte	192	; Y coordinate
15347  3EF5             		
15348  3EF5 37          		.byte	55	; X coordinate
15349  3EF6 8C          		.byte	140	; Y coordinate
15350  3EF7             		
15351  3EF7 77          		.byte	119	; X coordinate
15352  3EF8 70          		.byte	112	; Y coordinate
15353  3EF9             		
15354  3EF9 77          		.byte	119	; X coordinate
15355  3EFA A4          		.byte	164	; Y coordinate
15356  3EFB             		
15357  3EFB 77          		.byte	119	; X coordinate
15358  3EFC D8          		.byte	216	; Y coordinate
15359  3EFD             ;------------------------------------------------------------------------------
15360  3EFD             
15361  3EFD             
15362  3EFD             
15363  3EFD             ;------------------------------------------------------------------------------
15364  3EFD             ; The initial coordinates for the elevators on the secret stage
15365  3EFD             L_SECRET_ELEVATOR_COORDS:
15366  3EFD 7F          		.byte	127	; X coordinate
15367  3EFE CC          		.byte	204	; Y coordinate
15368  3EFF             
15369  3EFF 7F          		.byte	127	; X coordinate
15370  3F00 6C          		.byte	108	; Y coordinate
15371  3F01             ;------------------------------------------------------------------------------
15372  3F01             
15373  3F01             
15374  3F01             
15375  3F01             ;------------------------------------------------------------------------------
15376  3F01             ; Determine the amount of points to award the player
15377  3F01             ; passed: 	a - (pointAwardType) rotated right 1 bit
15378  3F01             ; return: 	de - function call to pass to the AddFunctionToUpdateList function
15379  3F01             ;             	 ($0001 = award 100 points
15380  3F01             ;             	  $0003 = award 300 points
15381  3F01             ;             	  $0005 = award 500 points)
15382  3F01             ;         	b - the point sprite to display
15383  3F01             DETERMINE_POINT_AWARD_AMT: 	
15384  3F01 11 01 00    		ld		de,1		
15385  3F04 06 7B       		ld		b,$7b						; 200 point award sprite
15386  3F06 1F          		rra
15387  3F07 D2 20 1F    		jp		nc,l1e28					; Exceeds relative branch
15388  3F0A             		
15389  3F0A 1E 03       		ld		e,3
15390  3F0C 06 7D       		ld		b,$7d						; 300 point award sprite
15391  3F0E 1F          		rra
15392  3F0F D2 20 1F    		jp		nc,l1e28					; Exceeds relative branch
15393  3F12             		
15394  3F12             		; NOTE: There appears to be a bug here
15395  3F12             		;       500 points are awarded, but the
15396  3F12             		;       800 point sprite is displayed
15397  3F12             		;       (de is set to 5 = 500 points,
15398  3F12             		;        but b is set to $7f = 800 point sprite)
15399  3F12 1E 05       		ld		e,5
15400  3F14             ;		ld		b,$7f						; 800 point award sprite
15401  3F14 06 7E       		ld		b,$7e
15402  3F16 C3 20 1F    		jp		l1e28						; Exceeds relative branch
15403  3F19             ;------------------------------------------------------------------------------
15404  3F19             
15405  3F19             
15406  3F19             
15407  3F19             ;------------------------------------------------------------------------------
15408  3F19             ; Detect collisions with enemies on the current stage
15409  3F19 3A 27 62    l3e88: 	ld		a,(CURRENT_STAGE)
15410  3F1C 3D          		dec		a
15411  3F1D E5          		push	hl
15412  3F1E EF          		rst		$28
15413  3F1F             		; Jump table
15414  3F1F             ;		.word	L_ORG	; 0 = reset game
15415  3F1F 29 3F       		.word	l3e99	; 1 = 
15416  3F21 B8 29       		.word	L_MIXER_ENEMY_COLLISION	; 2 = 
15417  3F23 D7 29       		.word	L_ELEVATOR_ENEMY_COLLISION	; 3 =
15418  3F25 F8 29       		.word	L_RIVETS_ENEMY_COLLISION	; 4 = 
15419  3F27 F8 29       		.word	L_RIVETS_ENEMY_COLLISION	; 5 = Secret stage (same as rivets)
15420  3F29             ;------------------------------------------------------------------------------
15421  3F29             
15422  3F29             
15423  3F29             ;------------------------------------------------------------------------------
15424  3F29             l3e99:	
15425  3F29 E1          		pop		hl
15426  3F2A AF          		xor		a
15427  3F2B 32 60 60    		ld 		($6060),a
15428  3F2E 06 0A       		ld 		b,10
15429  3F30 11 20 00    		ld 		de,32
15430  3F33 DD 21 00 67 		ld 		ix,BARREL_STRUCTS
15431  3F37 CD 53 3F    		call	l3ec3
15432  3F3A 06 05       		ld		b,5
15433  3F3C DD 21 00 64 		ld		ix,FIREBALL_STRUCTS
15434  3F40 CD 53 3F    		call	l3ec3
15435  3F43 3A 60 60    		ld		a,($6060)
15436  3F46 A7          		and		a
15437  3F47 C8          		ret		z
15438  3F48             
15439  3F48 FE 01       		cp		$01
15440  3F4A C8          		ret		z
15441  3F4B             
15442  3F4B FE 03       		cp		$03
15443  3F4D 3E 03       		ld		a,$03
15444  3F4F D8          		ret		c
15445  3F50             
15446  3F50 3E 07       		ld 		a,$07
15447  3F52 C9          		ret
15448  3F53             ;------------------------------------------------------------------------------
15449  3F53             
15450  3F53             
15451  3F53             
15452  3F53             ;------------------------------------------------------------------------------
15453  3F53 DD CB 00 46 l3ec3:	bit		0,(ix+0)
15454  3F57 28 2A       		jr		z,l3efa
15455  3F59 79          		ld		a,c
15456  3F5A DD 96 05    		sub		(ix+5)
15457  3F5D 30 02       		jr		nc,l3ed3
15458  3F5F ED 44       		neg
15459  3F61 3C          l3ed3:	inc		a
15460  3F62 95          		sub		l
15461  3F63 38 05       		jr		c,l3ede
15462  3F65 DD 96 0A    		sub		(ix+10)
15463  3F68 30 19       		jr		nc,l3efa
15464  3F6A FD 7E 03    l3ede:	ld		a,(iy+3)
15465  3F6D DD 96 03    		sub		(ix+3)
15466  3F70 30 02       		jr		nc,l3ee9
15467  3F72 ED 44       		neg
15468  3F74 94          l3ee9:	sub		h
15469  3F75 38 05       		jr		c,l3ef3
15470  3F77 DD 96 09    		sub		(ix+9)
15471  3F7A 30 07       		jr		nc,l3efa
15472  3F7C 3A 60 60    l3ef3:	ld		a,($6060)
15473  3F7F 3C          		inc		a
15474  3F80 32 60 60    		ld		($6060),a
15475  3F83 DD 19       l3efa:	add		ix,de
15476  3F85 10 CC       		djnz	l3ec3
15477  3F87 C9                  ret
15478  3F88             ;------------------------------------------------------------------------------
15479  3F88             
15480  3F88             
15481  3F88             
15482  3F88             ;------------------------------------------------------------------------------
15483  3F88             ; "PLUS!"
15484  3F88             L_PLUS_STRING_DATA:
15485  3F88 54 76       		.word	TILE_COORD(18,20)
15486  3F8A 20 1C 25 23 		.byte	$20, $1C, $25, $23, $38
15486  3F8E 38 
15487  3F8F 3F          		.byte	$3F
15488  3F90             		
15489  3F90             ; "1981"
15490  3F90             L_1981_STRING_DATA: 	
15491  3F90 5C 76       		.word	TILE_COORD(18, 28)
15492  3F92 49 4A 01 09 		.byte	$49, $4A, $01, $09, $08, $01
15492  3F96 08 01 
15493  3F98 3F          		.byte	$3F		; End of string
15494  3F99             		
15495  3F99             
15496  3F99             ; "NINTENDO OF AMERICA INC."
15497  3F99             L_NINTENDO_STRING_DATA: 	
15498  3F99 7D 77       		.word	$TILE_COORD(27, 29)
15499  3F9B 1E          		.byte	$1E
15500  3F9C             L_NINTENDO_STRING_DATA_1:	
15501  3F9C 19 1E 24 15 		.byte	$19, $1E, $24, $15, $1E, $14, $1F, $10, $1F, $16, $10, $11, $1d, $15, $22, $19, $13, $11, $10, $19, $1E, $13, $2B
15501  3FA0 1E 14 1F 10 
15501  3FA4 1F 16 10 11 
15501  3FA8 1D 15 22 19 
15501  3FAC 13 11 10 19 
15501  3FB0 1E 13 2B 
15502  3FB3 3F          		.byte	$3F		; End of string		
15503  3FB4             ;------------------------------------------------------------------------------
15504  3FB4             
15505  3FB4             
15506  3FB4             
15507  3FB4             ;------------------------------------------------------------------------------
15508  3FB4             ; Display (TM)
15509  3FB4             L_DISPLAY_TM:	
15510  3FB4 21 AF 74    		ld      hl,TILE_COORD(5,15)
15511  3FB7 11 E0 FF    		ld      de,-32
15512  3FBA 36 9F       		ld      (hl),$9f    ; Display '(T'
15513  3FBC 19          		add     hl,de       ; hl=(4, 15)
15514  3FBD 36 9E       		ld      (hl),$9e    ; Display 'M)'
15515  3FBF C9          		ret     
15516  3FC0             ;------------------------------------------------------------------------------
15517  3FC0             
15518  3FC0             
15519  3FC0             
15520  3FC0             ;------------------------------------------------------------------------------
15521  3FC0             ; I don't quite understand why this function is needed
15522  3FC0             ; It just displays the retractable ladders in the mixers level and jumps 
15523  3FC0             ; to the routine that completes the stage initialization
15524  3FC0             ;L_WEIRD_DISPLAY_STAGE_FN:	
15525  3FC0             ;		call	L_DISPLAY_MIXER_LADDERS
15526  3FC0             ;		jp		L_COMPLETE_STAGE_INIT		; Exceeds relative branch
15527  3FC0             ;------------------------------------------------------------------------------
15528  3FC0             		
15529  3FC0             
15530  3FC0             
15531  3FC0             ;------------------------------------------------------------------------------
15532  3FC0             ; If the current stage is the mixer stage (2), draw the ladders for that level
15533  3FC0             ; otherwise return immediately.
15534  3FC0             L_DISPLAY_MIXER_LADDERS:  
15535  3FC0             		; Return unless this is the rivets stage
15536  3FC0 3E 02       		ld      a,%00000010		
15537  3FC2 F7                  rst     $30							
15538  3FC3             		
15539  3FC3 06 02               ld      b,2							; For b = 2 to 1
15540  3FC5 21 6C 77            ld      hl,TILE_COORD(27,12)
15541  3FC8 36 10       l3fae:  ld      (hl),$10					; Display ' ' at hl
15542  3FCA 23                  inc     hl			
15543  3FCB 23          l3fb1:  inc     hl							; hl += 2 rows
15544  3FCC 36 C0               ld      (hl),$c0					; Display ladder at hl
15545  3FCE 21 8C 74            ld      hl,TILE_COORD(4,12)
15546  3FD1 10 F5               djnz    l3fae						; next b
15547  3FD3 C9                  ret     
15548  3FD4             ;------------------------------------------------------------------------------
15549  3FD4             
15550  3FD4             
15551  3FD4             
15552  3FD4             ;------------------------------------------------------------------------------
15553  3FD4             ; Called when Mario starts climbing a ladder.
15554  3FD4             ; Set Mario's sprite to the climbing sprite and returns the address of
15555  3FD4             ; marioSpriteY
15556  3FD4             ;
15557  3FD4             ; passed:	none
15558  3FD4             ; return:	hl - address of Mario's sprite y coordinate
15559  3FD4             L_SET_MARIO_SPRITE_TO_CLIMBING:  
15560  3FD4             		; Set Mario's sprite to 3
15561  3FD4 21 4D 69    		ld      hl,MARIO_SPRITE_NUM
15562  3FD7 36 03               ld      (hl),3
15563  3FD9 2C                  inc     l
15564  3FDA 2C                  inc     l							; MARIO_SPRITE_Y
15565  3FDB C9                  ret     
15566  3FDC             ;------------------------------------------------------------------------------
15567  3FDC             
15568  3FDC             
15569  3FDC             
15570  3FDC             ;------------------------------------------------------------------------------
15571  3FDC             ; Generate an error if the program goes over the 16K limit
15572  3FDC             	.echo "NOTE: ROM size is "
15573  3FDC             	.echo $
15574  3FDC             	.echo " bytes"
15575  3FDC~            #if ($ > $4000)
15576  3FDC~            	.echo "\nERROR: 16K limit exceeded by "
15577  3FDC~            	.echo $ - $4000
15578  3FDC~            	.echo " bytes\n"
15579  3FDC~            	!!!ERROR:_16K_LIMIT_EXCEEDED!!!
15580  3FDC             #else
15581  3FDC             	.echo ", leaving "
15582  3FDC             	.echo $4000 - $
15583  3FDC             	.echo " bytes free\n"
15584  3FDC             #endif
15585  3FDC             ;------------------------------------------------------------------------------
15586  3FDC             
15587  3FDC             
15588  3FDC             
15589  3FDC             ;------------------------------------------------------------------------------
15590  3FDC             ; Many routines jump here to abort the game
15591  4000             		.org $4000
15592  4000             l4000:
15593  4000                     .end
15594  4000             ;------------------------------------------------------------------------------
15595  4000             



Label        Value      Label        Value      Label        Value
------------------      ------------------      ------------------
AWARD_SOUND_TRIGGER 6085      ACTION_BUFFER_WRITE_POS 60B0      ACTION_BUFFER_READ_POS 60B1      
ACTIVATE_SECRET_STAGE 6290      ANIMATION_TIMER 6390      ACTIVE_FIREBALL_COUNT 63A1      
AWARD_SPRITE  6A30      AWARD_SPRITE_X 6A30      AWARD_SPRITE_NUM 6A31      
AWARD_SPRITE_PAL 6A32      AWARD_SPRITE_Y 6A33      BRK_LADDER_TILE 0001      
BLANK_TILE    0004      BLANK_CP_HIGH_SCORE 6031      BLINK_SCORE_TIMER 6032      
BOT_OF_CURRENT_LADDER 621C      BOT_MASTER_REVERSE_TIMER 62A5      BOT_MASTER_CONVEYER_DIR 62A6      
BARREL_FIRE_FREEZE 62B8      BARREL_FIRE_STATE 62B9      BARREL_FIRE_FLARE_UP_TIME 62BA      
BROKEN_LADDER_X_COORD_DATA 6310      BROKEN_LADDER_Y1_COORD_DATA 6325      BROKEN_LADDER_Y2_COORD_DATA 633A      
BARREL_FIRE_STATUS 6348      BOT_CONVEYER_DIR 63A6      BARREL_FIRE_STRUCT 66A0      
BARREL_STRUCTS 6700      BARREL_FIRE_SPRITE 6A28      BARREL_FIRE_SPRITE_X 6A28      
BARREL_FIRE_SPRITE_NUM 6A29      BARREL_FIRE_SPRITE_PAL 6A2A      BARREL_FIRE_SPRITE_Y 6A2B      
CIR_GIRDER_TILE 0005      COIN_VALID    6003      CURRENT_PLAYER 600D      
COUNTER_1     6019      COUNTER_2     601A      CABINET_TYPE  6026      
CABINET_TYPE_COCKTAIL 0000      CABINET_TYPE_UPRIGHT 0001      CURRENT_SCORE_STRING 61B1      
CURRENT_STAGE 6227      CP_DATA       6228      CP_NUMBER_LIVES 6228      
CP_LEVEL_NUMBER 6229      CP_STAGE_ORDER_POINTER 622A      CP_INTRO_NOT_DISPLAYED 622C      
CP_BONUS_LIFE_AWARDED 622D      CP_HEIGHT_INDEX 622E      CP_STAGE_ORDER_POINTER_LAG 622F      
CAGE_BARS_REMAINING 62B8      CP_DIFFICULTY 6380      CURRENT_STATE_VAR_POINTER 63C0      
CURRENT_FIREBALL 63C8      COLLISION_AREA_STRUCTS 64A0      COLLISION_AREA_STRUCT_1 64A0      
COLLISION_AREA_STRUCT_2 64C0      CAGE_TRIGGER_STRUCT 64A0      COLLISION_AREA_SPRITES 6950      
COLLISION_AREA_SPRITE_1 6950      COLLISION_AREA_SPRITE_2 6954      CONVEYER_MOTOR_SPRITES 69E4      
CONV_MOTOR_SPRITE_TL 69E4      CONV_MOTOR_SPRITE_TL_X 69E4      CONV_MOTOR_SPRITE_TL_NUM 69E5      
CONV_MOTOR_SPRITE_TL_PAL 69E6      CONV_MOTOR_SPRITE_TL_Y 69E7      CONV_MOTOR_SPRITE_TR 69E8      
CONV_MOTOR_SPRITE_TR_X 69E8      CONV_MOTOR_SPRITE_TR_NUM 69E9      CONV_MOTOR_SPRITE_TR_PAL 69EA      
CONV_MOTOR_SPRITE_TR_Y 69EB      CONV_MOTOR_SPRITE_MR 69EC      CONV_MOTOR_SPRITE_MR_X 69EC      
CONV_MOTOR_SPRITE_MR_NUM 69ED      CONV_MOTOR_SPRITE_MR_PAL 69EE      CONV_MOTOR_SPRITE_MR_Y 69EF      
CONV_MOTOR_SPRITE_ML 69F0      CONV_MOTOR_SPRITE_ML_X 69F0      CONV_MOTOR_SPRITE_ML_NUM 69F1      
CONV_MOTOR_SPRITE_ML_PAL 69F2      CONV_MOTOR_SPRITE_ML_Y 69F3      CONV_MOTOR_SPRITE_BL 69F4      
CONV_MOTOR_SPRITE_BL_X 69F4      CONV_MOTOR_SPRITE_BL_NUM 69F5      CONV_MOTOR_SPRITE_BL_PAL 69F6      
CONV_MOTOR_SPRITE_BL_Y 69F7      CONV_MOTOR_SPRITE_BR 69F8      CONV_MOTOR_SPRITE_BR_X 69F8      
CONV_MOTOR_SPRITE_BR_NUM 69F9      CONV_MOTOR_SPRITE_BR_PAL 69FA      CONV_MOTOR_SPRITE_BR_Y 69FB      
DIP_NUM_LIVES 6020      DIP_BONUS_LIFE 6021      DIP_COINS_PER_CREDIT 6024      
DIP_PLAYS_PER_CREDIT 6025      DEATH_SOUND_TRIGGER 6088      DK_CLIMBING_COUNTER 62AF      
DK_REACHING_COUNTER 62AF      DK_STOMPING   6393      DEATH_ANIMATION_STATE 639D      
DEATH_ANIMATION_COUNTER 639E      DK_DISTANCE_TO_LADDER 63B7      DEMO_INPUT_INDEX 63CC      
DEMO_INPUT_REPEAT 63CD      DK_SPRITES    6908      DK_SPRITE_1_X 6908      
DK_SPRITE_1_NUM 6909      DK_SPRITE_1_PAL 690A      DK_SPRITE_1_Y 690B      
DK_SPRITE_2_X 690C      DK_SPRITE_2_NUM 690D      DK_SPRITE_2_PAL 690E      
DK_SPRITE_2_Y 690F      DK_SPRITE_3_X 6910      DK_SPRITE_3_NUM 6911      
DK_SPRITE_3_PAL 6912      DK_SPRITE_3_Y 6913      DK_SPRITE_4_X 6914      
DK_SPRITE_4_NUM 6915      DK_SPRITE_4_PAL 6916      DK_SPRITE_4_Y 6917      
DK_SPRITE_5_X 6918      DK_SPRITE_5_NUM 6919      DK_SPRITE_5_PAL 691A      
DK_SPRITE_5_Y 691B      DK_SPRITE_6_X 691C      DK_SPRITE_6_NUM 691D      
DK_SPRITE_6_PAL 691E      DK_SPRITE_6_Y 691F      DK_SPRITE_7_X 6920      
DK_SPRITE_7_NUM 6921      DK_SPRITE_7_PAL 6922      DK_SPRITE_7_Y 6923      
DK_SPRITE_8_X 6924      DK_SPRITE_8_NUM 6925      DK_SPRITE_8_PAL 6926      
DK_SPRITE_8_Y 6927      DK_SPRITE_9_X 6928      DK_SPRITE_9_NUM 6929      
DK_SPRITE_9_PAL 692A      DK_SPRITE_9_Y 692B      DK_SPRITE_10_X 692C      
DK_SPRITE_10_NUM 692D      DK_SPRITE_10_PAL 692E      DK_SPRITE_10_Y 692F      
DK_STARS_SPRITE 6A24      DK_STARS_SPRITE_X 6A24      DK_STARS_SPRITE_NUM 6A25      
DK_STARS_SPRITE_PAL 6A26      DK_STARS_SPRITE_Y 6A27      DIP_INPUT     7D80      
DEATH_SOUND_OUTPUT 7D80      DETERMINE_POINT_AWARD_AMT 3F01      ELEVATOR_SPAWN_TIMER 62A7      
ELEVATOR_STRUCTS 6600      ELEVATOR_STRUCT_1 6600      ELEVATOR_STRUCT_2 6610      
ELEVATOR_STRUCT_3 6620      ELEVATOR_STRUCT_4 6630      ELEVATOR_STRUCT_5 6640      
ELEVATOR_STRUCT_6 6650      ELEVATOR_PLATFORM_SPRITES 6958      ELEVATOR_PLATFORM_SPRITE_1 6958      
ELEVATOR_PLATFORM_SPRITE_2 695C      ELEVATOR_PLATFORM_SPRITE_3 6960      ELEVATOR_PLATFORM_SPRITE_4 6964      
ELEVATOR_PLATFORM_SPRITE_5 6968      ELEVATOR_PLATFORM_SPRITE_6 696C      ELEVATOR_MOTOR_SPRITE_DATA 6970      
ELEVATOR_MOTOR_SPRITE_1 6970      ELEVATOR_MOTOR_SPRITE_1_X 6970      ELEVATOR_MOTOR_SPRITE_1_NUM 6971      
ELEVATOR_MOTOR_SPRITE_1_PAL 6972      ELEVATOR_MOTOR_SPRITE_1_Y 6973      ELEVATOR_MOTOR_SPRITE_2 6974      
ELEVATOR_MOTOR_SPRITE_2_X 6974      ELEVATOR_MOTOR_SPRITE_2_NUM 6975      ELEVATOR_MOTOR_SPRITE_2_PAL 6976      
ELEVATOR_MOTOR_SPRITE_2_Y 6977      ELEVATOR_MOTOR_SPRITE_3 6978      ELEVATOR_MOTOR_SPRITE_3_X 6978      
ELEVATOR_MOTOR_SPRITE_3_NUM 6979      ELEVATOR_MOTOR_SPRITE_3_PAL 697A      ELEVATOR_MOTOR_SPRITE_3_Y 697B      
ELEVATOR_MOTOR_SPRITE_4 697C      ELEVATOR_MOTOR_SPRITE_4_X 697C      ELEVATOR_MOTOR_SPRITE_4_NUM 697D      
ELEVATOR_MOTOR_SPRITE_4_PAL 697E      ELEVATOR_MOTOR_SPRITE_4_Y 697F      FALL_SOUND_TRIGGER 6084      
FIREBALL_STRUCTS 6400      FIREBALL_STRUCT_1 6400      FIREBALL_STRUCT_2 6420      
FIREBALL_STRUCT_3 6440      FIREBALL_STRUCT_4 6460      FIREBALL_STRUCT_5 6480      
FIREBALL_SPRITES 69D0      FIREBALL_SPRITE_1 69D0      FIREBALL_SPRITE_2 69D4      
FIREBALL_SPRITE_3 69D8      FIREBALL_SPRITE_4 69DC      FIREBALL_SPRITE_5 69E0      
FALL_SOUND_OUTPUT 7D04      FIREBALL_BOB_TABLE_LENGTH 0012      GAME_STATE    6005      
GAME_STATE_INIT 0000      GAME_STATE_ATTRACT 0001      GAME_STATE_COIN 0002      
GAME_STATE_PLAY 0003      GAME_SUBSTATE 600A      GAME_SUBSTATE_ATTRACT_COIN 0000      
GAME_SUBSTATE_ATTRACT_INIT 0001      GAME_SUBSTATE_ATTRACT_MARIO 0002      GAME_SUBSTATE_ATTRACT_RUN 0003      
GAME_SUBSTATE_PLAY_ORIENT 0000      GAME_SUBSTATE_PLAY_INIT_P1 0001      GAME_SUBSTATE_PLAY_START_P1 0002      
GAME_SUBSTATE_PLAY_INIT_P2 0003      GAME_SUBSTATE_PLAY_START_P2 0004      GAME_SUBSTATE_PLAY_PLAYER_INFO 0005      
GAME_SUBSTATE_PLAY_PREPARE 0006      GAME_SUBSTATE_PLAY_INTRO 0007      GAME_SUBSTATE_PLAY_INTERMISSION 0008      
GAME_SUBSTATE_PLAY_STAGE 000A      GAME_SUBSTATE_PLAY_MARIO 000B      HIGH_SCORE_TABLE 6100      
HIGH_SCORE_TABLE_ENTRY_1 6100      HIGH_SCORE_TABLE_ENTRY_2 6122      HIGH_SCORE_TABLE_ENTRY_3 6144      
HIGH_SCORE_TABLE_ENTRY_4 6166      HIGH_SCORE_TABLE_ENTRY_5 6188      HAMMER_CYCLE_ACTIVE 6217      
HAMMER_GRABBED 6218      HEIGHT_25M    0000      HEIGHT_50M    0001      
HEIGHT_75M    0002      HEIGHT_100M   0003      HEIGHT_125M   0004      
HEIGHT_150M   0005      HAMMER_CYCLE_COUNTER 6394      HAMMER_CYCLE_WRAP_COUNTER 6395      
HAMMER_STRUCTS 6680      HAMMER_STRUCT_1 6680      HAMMER_STRUCT_2 6690      
HAMMER_SPRITES 6A18      HAMMER_SPRITE_1 6A18      HAMMER_SPRITE_2 6A1C      
HEART_SPRITE  6A20      HEART_SPRITE_X 6A20      HEART_SPRITE_NUM 6A21      
HEART_SPRITE_PAL 6A22      HEART_SPRITE_Y 6A23      INITIALS_TIMER_VALUE 6033      
INITIALS_TIMER_DELAY 6034      INITIALS_COORD 6036      INITIALS_ADDRESS 603A      
INTERNAL_TIMER 62B0      INTRODUCTION_STATE 6385      INTERM_HEIGHT_STRING_INDEX 63A7      
INTERM_HEIGHT_STRING_COORD 63A8      INTERRUPT_ENABLE 7D84      JOYSTICK_INPUT_DELAY 6030      
JUMP_SOUND_TRIGGER 6081      JUMP_SOUND_OUTPUT 7D01      K_COLLISION_SPRITE_NUM 003F      
K_COLLISION_SPRITE_PAL 000C      K_COLLISION_SPRITE_WIDTH 0008      K_COLLISION_SPRITE_HEIGHT 0008      
K_COLLISION_1_X_RIVETS 0073      K_COLLISION_1_Y_RIVETS 0050      K_COLLISION_2_X_RIVETS 008D      
K_COLLISION_2_Y_RIVETS 0050      K_COLLISION_X_BARRELS 0046      K_COLLISION_Y_BARRELS 004C      
K_COLLISION_X_ELEVATORS 0046      K_COLLISION_Y_ELEVATORS 0050      LADDER_TILE   0000      
L_RETRACT_LADDER_DATA 6280      L_RETRACT_LADDER_STATE 6280      L_RETRACT_LADDER_DELAY 6281      
L_RETRACT_LADDER_X 6282      L_RETRACT_LADDER_Y 6283      L_RETRACT_LADDER_MOVE_DELAY 6284      
LEFT_MASTER_CONVEYER_DIR 62A4      LADDER_ROW_TO_ERASE 638E      LEFT_CONVEYER_DIR 63A4      
LADDER_JUMP_VECTOR_POINTER 63C2      L_RETRACT_LADDER_SPRITE 6944      L_RETRACT_LADDER_SPRITE_X 6944      
L_RETRACT_LADDER_SPRITE_NUM 6945      L_RETRACT_LADDER_SPRITE_PAL 6946      L_RETRACT_LADDER_SPRITE_Y 6947      
L_ORG         0000      L_MOVE_N_SPRITES 003A      L_LOAD_DK_SPRITES 004E      
L_UPDATE_RAND_NUM 0057      L_INTERRUPT_HANDLER 0066      L_POP_REGISTERS_FROM_STACK 00C9      
L_PLAY_SOUNDS 00D7      L_SOUNDS_OFF  010F      L_P8257_REGISTER_DATA 012B      
L_CONFIG_P8257 0134      L_CHECK_FOR_COIN 016E      L_INITIAL_SCORE_DATA 01AB      
L_BLANK_SCORE_DATA 01B0      L_INIT_ATTRACT_MODE 01B4      L_LOAD_DIP_SETTINGS 01F8      
L_INIT_GAME   0252      L_MAIN_LOOP   02A9      L_PROCESS_ACTION_BUFFER 02CF      
L_DISPLAY_NUP 0301      L_RETURN_NUP_COORD 0333      L_AWARD_BONUS_LIFE 033C      
L_INCREASE_DIFFICULTY 036B      L_IMPLEMENT_BARREL_FIRE 038E      L_TOGGLE_FIRE_SPRITES 03DC      
L_ANIMATE_DK_AND_PAULINE 03E5      L_DISPLAY_OR_CLEAR_HELP 04FE      L_AWARD_POINTS 0506      
L_GET_PLAYER_SCORE 054B      L_DISPLAY_PLAYER_SCORE 0557      L_DISPLAY_HIGH_SCORE 0564      
L_DISPLAY_HIGH_SCORE_2 0568      L_DISPLAY_SCORE_DIGIT 057F      L_ZERO_SCORES 0587      
L_DISPLAY_SCORES 05AE      L_DISPLAY_STRING 05CD      L_DISPLAY_CREDITS 05F5      
L_DISPLAY_CREDITS_2 05FA      L_PROCESS_TIMER 060E      L_DISPLAY_LIVES_AND_LEVEL 0696      
L_IMPLEMENT_GAME_PLAY 06DA      L_IMPLEMENT_ATTRACT_MODE 070E      L_PROMPT_FOR_START 0729      
L_PREPARE_DEMO_MODE 0730      L_INSERT_COINS_SCREEN 0746      L_CLEAN_UP_DEMO_MODE 078F      
L_FLASH_DK_TITLE_SCREEN 0797      L_FREEZE_DK_TITLE_SCREEN 0816      L_CLEAR_SCREEN_AND_SPRITES 081D      
L_CLEAR_STAGE_SCREEN 083D      L_WAITING_FOR_START_MODE 0877      L_DISPLAY_PUSH_START_SCREEN 087F      
L_HANDLE_START_BUTTONS 08BB      L_INITIAL_PLAYER_DATA_TABLE 091E      L_DISPLAY_HIGH_SCORES 0925      
L_SUBTRACT_ONE_PLAY 0937      L_ORIENT_SCREEN 0946      L_INIT_P1     0969      
L_P1_PROMPT_SCREEN 0993      L_DISPLAY_2UP 09AB      L_INIT_P2     09BB      
L_P2_PROMPT_SCREEN 09D8      L_DISPLAY_TURN_DATA 09F4      L_DISPLAY_1UP 0A10      
L_PREPARE_SCREEN_FOR_TURN 0A20      L_IMPLEMENT_INTRO_STAGE 0A33      L_DISPLAY_INTRODUCTION_STAGE 0A47      
L_DISPLAY_DK_CLIMBING 0A7C      L_IMPLEMENT_DK_CLIMB_ANIM 0AA5      L_ANIMATE_DK_JUMP_FROM_LAD 0AC3      
L_ANIMATE_DK_PLAT_JUMPS 0B23      L_ANIMATE_DK_GRIN_TAUNT 0B6D      L_DISPLAY_INTERMISSION 0B93      
L_DISPLAY_CURRENT_STAGE 0C46      L_DISPLAY_CURRENT_STAGE_2 0C47      L_DISPLAY_RIVETS 0CC2      
L_RIVET_COORD_DATA 0CD8      L_DRAW_ELEVATOR_SUPPORTS 0CE8      L_DRAW_PAULINE_PLAT_POSTS 0D04      
L_DRAW_SECRET_CAGE 0D20      L_COMPLETE_STAGE_INIT 0D38      L_DISPLAY_STAGE 0DAD      
L_INIT_CURRENT_STAGE 0F44      L_INIT_BARRELS_STAGE_SPRITES 0FC7      L_INITIAL_BARREL_DATA 1007      
L_INIT_MIXER_STAGE_SPRITES 100B      L_INIT_ELEVATOR_STAGE_SPRITES 105E      L_ELEV_MOTOR_SPRITE_DATA 10F5      
L_INIT_RIVETS_STAGE_SPRITES 1105      L_COL_SPRITE_DATA 1152      L_RIVETS_COL_SPRITE_COORD_DATA 1156      
L_BARREL_COL_SPRITE_COORD_DATA 115A      L_ELEV_COL_SPRITE_COORD_DATA 115E      L_INIT_SPRING_DATA 1162      
L_INITIAL_SPRING_DATA 117E      L_INIT_HAMMER_SPRITES 1182      L_INIT_SECRET_STAGE_SPRITES 11AF      
L_COPY_STRUCT_TO_SPRITE 123A      L_COPY_COORDS_TO_STRUCTS 1253      L_LOAD_BARREL_FIRE_DATA 1261      
L_LD_SPRITE_DATA_TO_STRUCT 1291      L_INIT_MARIO  12A3      L_IMPLEMENT_DEATH_ANIM 12E2      
L_PREPARE_DEATH_ANIMATION 12EF      L_ROTATE_MARIO_DEAD_SPRITE 1310      L_CLEAN_UP_DEATH_ANIMATION 1341      
L_POST_DEATH_PROCESSING_P1 1354      L_POST_DEATH_PROCESSING_P2 13A4      L_ADV_FROM_P1_GAME_OVER 13ED      
L_ADV_FROM_P2_GAME_OVER 13FE      L_PREPARE_FOR_P2_TURN 1406      L_PREPARE_FOR_P1_TURN 1417      
L_ADD_SCORE_TO_HS_TABLE 1426      L_CHECK_FOR_HS_INITIALS 147A      L_RESTART_GAME 14CC      
L_IMPLEMENT_HS_INITIAL_ENTRY 14DB      L_UPDATE_LETTER_SEL_BOX 1636      L_IMPLEMENT_STAGE_WIN_ANIM 1651      
L_IMPLEMENT_MIXER_WIN_ANIM 166E      L_IMPLEMENT_RIVETS_WIN_ANIM 167F      L_IMPLEMENT_SECRET_WIN_ANIM 1692      
L_WIN_STAGE_ANIM_0 16A6      L_WIN_STAGE_ANIM_1 16C2      L_WIN_STAGE_ANIM_2 16DC      
L_MIXER_WIN_STAGE_ANIM_0 16F4      L_WAIT_FOR_DK_TO_REACH_LADDERS 170C      L_WIN_ANIM_DISPLAY_PAULINE 1754      
L_WIN_STAGE_ANIM_3 178B      L_WIN_STAGE_ANIM_4 17BC      L_HIDE_OFFSCREEN_DK_SPRITES 17D1      
L_CHECK_IF_DK_SPRITES_HIDDEN 17E7      L_ADVANCE_TO_NEXT_STAGE 17F2      L_RIVETS_WIN_STAGE_ANIM_0 1832      
L_CLEAR_AROUND_GAME_OVER 18A1      L_RIVETS_WIN_STAGE_ANIM_1 18B3      L_RIVETS_WIN_STAGE_ANIM_2 18E8      
L_RIVETS_WIN_STAGE_ANIM_3 18F9      L_RIVETS_WIN_STAGE_ANIM_4 193B      L_SECRET_WIN_ANIM_0 19DB      
L_SECRET_WIN_ANIM_1 1A05      L_SECRET_WIN_ANIM_2 1A29      L_SECRET_WIN_ANIM_3 1A52      
L_PREP_FOR_NEXT_PLAYER 1A79      L_RUN_GAME_DEMO 1A85      L_RUN_GAME    1A88      
L_CHECK_IF_PRIZE_REACHED 1AEB      L_CHECK_IF_TRIGGER_REACHED 1B18      L_IMPLEMENT_POINT_AWARD 1EC4      
L_GIVE_POINT_AWARD 1ECE      L_NO_POINTS_TO_DISPLAY 1F3F      L_DISPLAY_POINT_AWARD_SPRITE 1F40      
L_CHECK_FOR_WIN_CONDITIONS 1F4D      L_CHECK_FOR_SMASH_ANIM 1FA9      L_IMPLEMENT_SMASH_ANIM 1FB3      
L_INIT_SMASH_ANIM 1FBD      L_SMASH_ANIM_PHASE_1 2021      L_COMPLETE_SMASH_ANIM 203A      
L_LD_SPRITE_DATA_TO_STRUCT_2 22AD      L_DEMO_INPUT_DATA 22C4      L_SIMULATE_DEMO_INPUT 22E1      
L_IMPLEMENT_RET_LADDERS 22FA      L_LADDER_STATE_0 2315      L_CHECK_IF_MARIO_ON_LADDER 2330      
L_LADDER_STATE_1 2344      L_LADDER_STATE_2 2380      L_LADDER_STATE_3 2389      
L_UPDATE_LADDER_SPRITE_COORD 23A4      L_MOVE_SPRITE_ALONG_PLAT 2413      L_CHECK_IF_ON_LADDER 2446      
L_IMPLEMENT_BARRIERS 24F3      L_PARSE_STAGE_LADDER_DATA 251B      L_MOVE_PIES_ON_CONVEYERS 264E      
L_IMPLEMENT_CONVEYERS 269E      L_IMPLEMENT_TOP_CONVEYER 26AE      L_IMPLEMENT_MID_CONVEYERS 26D9      
L_IMPLEMENT_BOT_CONVEYERS 26F6      L_ANIMATE_MOTOR_SPRITES 2721      L_REVERSE_CONVEYER_DIR 2754      
L_SET_CONVEYER_SPEED_TO_1 275E      L_IMPLEMENT_ELEVATORS 276E      L_MOVE_MARIO_ON_ELEVATORS 27A5      
L_MOVE_ELEVATORS 27F1      L_SPAWN_NEW_ELEVATOR 282F      L_QUADRANT_DIRECTIONS 285B      
L_IMPLEMENT_SECRET_ELEVATORS 2863      L_CHECK_FOR_ENEMY_COLLISION 2923      L_CHECK_FOR_HAMMER_KILL 2938      
L_CHECK_FOR_ENEMY_JUMP 296D      L_IMPL_ENEMY_COLL_FOR_STAGE 2988      L_BARREL_ENEMY_COLLISION 2998      
L_MIXER_ENEMY_COLLISION 29B8      L_ELEVATOR_ENEMY_COLLISION 29D7      L_RIVETS_ENEMY_COLLISION 29F8      
L_CHECK_FOR_COLLISION 2A0A      L_IMPLEMENT_HAMMER_GRAB 2A43      L_CHECK_FOR_HAMMER_GRAB 2A62      
L_CHECK_IF_NOT_SUPPORTED 2A7A      L_INTERACT_WITH_ELEVATORS 2A9B      L_CHECK_FOR_ELEVATOR_COLLISION 2B08      
L_MOVE_MARIO_ON_CONVEYERS 2BAA      L_RANDOMLY_RELEASE_FIREBALL 2E90      L_IMPLEMENT_SPRINGS 2EB9      
L_ANIMATE_HAMMER_CYCLE 2F7F      L_STAGE_LOC_TO_ADDRESS 308E      L_ANIMATE_LADDER_PULL_UP 30E1      
L_ERASE_INTRO_LADDER_TILE 30FB      L_PAUSE_CURRENT_STATE 3100      L_ANIMATE_CLIMBING_LADDERS 3106      
L_ALT_DK_ARMS_AND_LEGS 312D      L_ADD_EVENT   3136      L_CLEAR_SPRITES_WHEN_DEAD 3152      
L_CLEAR_MARIO_SPRITE 316F      L_IMPLEMENT_FIREBALLS 3181      L_CONTROL_FIREBALL_SPEED 318E      
L_CONTROL_FIREBALL_SPEED_0_1 31A4      L_CONTROL_FIREBALL_SPEED_2 31AE      L_CONTROL_FIREBALL_SPEED_3_4 31B8      
L_CONTROL_FIREBALL_SPEED_5 31C2      L_SPAWN_FIREBALLS 31CC      L_PROCESS_EACH_FIREBALL 3232      
L_FIREBALLS_ABRUPT_LEFT 325C      L_ROUGH_25_P_CHANCE 3275      L_UPDATE_CURRENT_FIREBALL 3281      
L_INIT_FIREBALL_FOR_STAGE 332C      L_HANDLE_FIREBALL_PAUSED 3343      L_CHANGE_FIREBALL_DIR 3374      
L_HANDLE_FIREBALLS_AND_LADDERS 3391      L_ABORT_IF_FIREBALL_TOO_HIGH 33EF      L_UPDATE_FIREBALL_WALK 33FA      
L_HANDLE_BARREL_PLATS 340F      L_UPDATE_FIREBALL_CLIMB 3432      L_UPDATE_FIREBALL_SPRITE 3452      
L_INIT_FIREBALL_BARRELS 3474      L_INIT_FIREBALL_MIXER 34BE      L_INIT_FIREBALL_RIVETS 34F9      
L_UPDATE_FIREBALL_SPRITES 352E      L_POINT_AWARD_TABLE 3562      L_DEFAULT_HIGH_SCORE_DATA 3576      
L_DEFAULT_HIGH_SCORE_DATA_1 3576      L_HS_LETTER_COORD_TABLE 3620      L_STRING_TABLE 365C      
L_GAME_OVER_STRING_DATA 369C      L_PLAYER_1_STRING_DATA 36A9      L_PLAYER_2_STRING_DATA 36B6      
L_HIGH_SCORE_STRING_DATA 36C3      L_CREDIT_STRING_DATA 36D0      L_HOW_HIGH_STRING_DATA 36DD      
L_ONLY_1_STRING_DATA 36F7      L_1_OR_2_STRING_DATA 370E      L_PUSH_STRING_DATA 3726      
L_REGIS_STRING_DATA 372D      L_NAME_STRING_DATA 3741      L_UNDERLINE_STRING_DATA 3749      
L_A_TO_J_STRING_DATA 3758      L_K_TO_T_STRING_DATA 376E      L_U_TO_END_STRING_DATA 3784      
L_REGI_TIME_STRING_DATA 379C      L_INTRO_STAGE_DATA 381E      L_TIMER_BOX_TILE_DATA 385B      
L_DK_SPRITES_L_ARM_RAISED 386D      L_PAULINE_SPRITES_FACE_RIGHT 3895      L_DK_SPRITES_CLIMBING 389D      
L_DK_JUMP_FROM_LADDER_DATA 38C5      L_DK_JUMP_ACROSS_PLAT_DATA 38DC      L_INTRO_DATA_SLOPE6 393D      
L_DK_SPRITES_THROW_BARREL 3943      L_DK_SPRITES_ARMS_DOWN 396B      L_DK_SPRITES_GRAB_BARREL 3993      
L_SPRING_VECTOR_DATA 39BB      L_DK_SPRITES_GRIN_L_STOMP 39E0      L_DK_SPRITES_GRIN_R_STOMP 3A08      
L_DK_SPRITES_GRIN_UD 3A30      L_RIVETS_DATA_FALL1 3A58      L_RIVETS_DATA_FALL2 3A5E      
L_RIVETS_DATA_FALL3 3A64      L_RIVETS_DATA_FALL4 3A6A      L_RIVETS_DATA_FALL_TOP 3A70      
L_STAGE_ORDER_TABLE 3A76      L_STAGE_ORDER_TABLE_LAST 3A84      L_FIREBALL_BOB_TABLE 3A8B      
L_OIL_BARREL_JUMP_TABLE_BARRELS 3A9D      L_OIL_BARREL_JUMP_TABLE_MIXER 3ABD      L_L_RIVET_SPAWN_COORDS 3AD5      
L_R_RIVET_SPAWN_COORDS 3AE5      L_BARRELS_STAGE_DATA 3AF5      L_MIXER_STAGE_DATA 3B6E      
L_ELEVATORS_STAGE_DATA 3BF6      L_RIVETS_STAGE_DATA 3C9C      L_SECRET_STAGE_DATA 3D01      
L_HEIGHT_STRING_TABLE 3D57      L_LARGE_DK_LETTER_DATA 3D6F      L_INITIAL_STAGE_DATA_TABLE 3E03      
L_STANDING_BARRELS_SPRITE_DATA 3E43      L_FIREBALL_SPRITE_DATA 3E53      L_FIREFOX_SPRITE_DATA 3E57      
L_SECRET_FIREBALL_COORDS 3E5B      L_BARRELS_FIRE_SPRITE_DATA 3E65      L_MIXER_FIRE_SPRITE_DATA 3E6B      
L_OIL_BARREL_SPRITE_DATA_1 3E71      L_OIL_BARREL_SPRITE_DATA_2 3E75      L_HAMMER_SPRITE_DATA 3E79      
L_BARRELS_HAMMER_COORDS 3E7D      L_MIXER_HAMMER_COORDS 3E81      L_RIVETS_HAMMER_COORDS 3E85      
L_PIE_SPRITE_DATA 3E89      L_RETRACT_LADDER_SPRITE_DATA 3E8D      L_MIXER_MOTOR_SPRITE_DATA 3E95      
L_MIXER_PRIZE_SPRITE_DATA 3EAD      L_ELEV_PRIZE_SPRITE_DATA 3EB9      L_RIVETS_PRIZE_SPRITE_DATA 3EC5      
L_SECRET_PRIZE_SPRITE_DATA 3ED1      L_SECRET_TRIGGER_DATA 3EDD      L_ELEVATOR_SPRITE_DATA 3EED      
L_ELEVATOR_COORDS 3EF1      L_SECRET_ELEVATOR_COORDS 3EFD      L_PLUS_STRING_DATA 3F88      
L_1981_STRING_DATA 3F90      L_NINTENDO_STRING_DATA 3F99      L_NINTENDO_STRING_DATA_1 3F9C      
L_DISPLAY_TM  3FB4      L_DISPLAY_MIXER_LADDERS 3FC0      L_SET_MARIO_SPRITE_TO_CLIMBING 3FD4      
MAJOR_TIMER   6008      MINOR_TIMER   6009      MARIO_DATA_STRUCT 6200      
MARIO_ALIVE   6200      MARIO_X       6203      MARIO_Y       6205      
MARIO_DATA_SPRITE_NUM 6207      MARIO_DATA_PALETTE 6208      MARIO_JUMP_Y_COORD 620E      
MARIO_JUMPING_LEFT 6210      MARIO_JUMPING_RIGHT 6211      MARIO_IS_CLIMBING 6215      
MARIO_IS_JUMPING 6216      MARIO_HAMMER_CYCLE_DELAY 621E      MARIO_IS_FALLING 6221      
MID_MASTER_REVERSE_TIMER 62A2      MAJOR_COUNTER 6381      MINOR_COUNTER 6384      
MARIO_ON_ELEVATOR 6398      MARIO_SPRITE  694C      MARIO_SPRITE_X 694C      
MARIO_SPRITE_NUM 694D      MARIO_SPRITE_PAL 694E      MARIO_SPRITE_Y 694F      
MISC_INPUT    7D00      MISC_INPUT_COIN_BIT 0007      MISC_INPUT_START_2P_BIT 0003      
MISC_INPUT_START_1P_BIT 0002      MISC_INPUT_TAMPER_BIT 0000      MARIO_START_COORD F03F      
MARIO_START_COORD_ELEVATORS E016      NUM_PLAYS     6001      NUM_COINS_PENDING 6002      
NO_COINS_INSERTED 6007      NUM_COINS_FOR_1P 6022      NUM_COINS_FOR_2P 6023      
NORMAL_LADDER_X_COORD_DATA 6300      NORMAL_LADDER_Y1_COORD_DATA 6315      NORMAL_LADDER_Y2_COORD_DATA 632A      
NUM_ENEMIES_OF_CURRENT_CLASS 63B9      ONSCREEN_TIMER 638C      OIL_BARREL_SPRITE 69FC      
OIL_BARREL_SPRITE_X 69FC      OIL_BARREL_SPRITE_NUM 69FD      OIL_BARREL_SPRITE_PAL 69FE      
OIL_BARREL_SPRITE_Y 69FF      PLAYER_1      0000      PLAYER_2      0001      
PLAYER_INPUT  6010      PLAYER_INPUT_JUMP_BIT 0007      PLAYER_INPUT_DOWN_BIT 0003      
PLAYER_INPUT_UP_BIT 0002      PLAYER_INPUT_LEFT_BIT 0001      PLAYER_INPUT_RIGHT_BIT 0000      
PLAYER_INPUT_LAG 6011      PLAYER_ID_ADDRESS 6038      P1_DATA       6040      
P1_NUMBER_LIVES 6040      P1_LEVEL_NUMBER 6041      P1_STAGE_ORDER_POINTER 6042      
P1_INTRO_NOT_DISPLAYED 6044      P1_BONUS_AWARDED 6045      P1_HEIGHT_INDEX 6046      
P1_STAGE_ORDER_POINTER_LAG 6047      P2_DATA       6048      P2_NUMBER_LIVES 6048      
P2_LEVEL_NUMBER 6049      P2_STAGE_ORDER_POINTER 604A      P2_INTRO_NOT_DISPLAYED 604C      
P2_BONUS_AWARDED 604D      P2_HEIGHT_INDEX 604E      P2_STAGE_ORDER_POINTER_LAG 604F      
PENDING_SONG_TRIGGER 608A      PENDING_SONG_TRIGGER_REPEAT 608B      PREV_P1_SCORE 60B2      
PREV_P2_SCORE 60B5      PREV_HIGH_SCORE 60B8      POINT_AWARD_STATE 6340      
POINT_AWARD_DISPLAY_TIMER 6341      POINT_AWARD_TYPE 6342      PRE_HAMMER_TUNE 6389      
PLATFORM_JUMP_VECTOR_POINTER 63C4      PIE_STRUCTS   65A0      PAULINE_SPRITES 6900      
PAULINE_UPPER_SPRITE_X 6900      PAULINE_UPPER_SPRITE_NUM 6901      PAULINE_UPPER_SPRITE_PAL 6902      
PAULINE_UPPER_SPRITE_Y 6903      PAULINE_LOWER_SPRITE_X 6904      PAULINE_LOWER_SPRITE_NUM 6905      
PAULINE_LOWER_SPRITE_PAL 6906      PAULINE_LOWER_SPRITE_Y 6907      PIE_SPRITES   69B8      
PIE_SPRITE_1  69B8      PIE_SPRITE_2  69BC      PIE_SPRITE_3  69C0      
PIE_SPRITE_4  69C4      PIE_SPRITE_5  69C8      PIE_SPRITE_6  69CC      
PRIZE_SPRITES 6A0C      PRIZE_SPRITE_1 6A0C      PRIZE_SPRITE_2 6A10      
PRIZE_SPRITE_3 6A14      P1_INPUT      7C00      P1_INPUT_RESET_BIT 0006      
P1_INPUT_JUMP_BIT 0005      P1_INPUT_DOWN_BIT 0003      P1_INPUT_UP_BIT 0002      
P1_INPUT_LEFT_BIT 0001      P1_INPUT_RIGHT_BIT 0000      P2_INPUT      7C80      
P2_INPUT_RESET_BIT 0006      P2_INPUT_JUMP_BIT 0005      P2_INPUT_DOWN_BIT 0003      
P2_INPUT_UP_BIT 0002      P2_INPUT_LEFT_BIT 0001      P2_INPUT_RIGHT_BIT 0000      
PALETTE_1_OUTPUT 7D86      PALETTE_2_OUTPUT 7D87      RANDOM_NUMBER 6018      
RETRACTABLE_LADDER_DATA 6280      R_RETRACT_LADDER_STATE 6288      R_RETRACT_LADDER_DELAY 6289      
R_RETRACT_LADDER_X 628A      R_RETRACT_LADDER_Y 628B      R_RETRACT_LADDER_MOVE_DELAY 628C      
REMAINING_RIVETS 6290      RIGHT_MASTER_CONVEYER_DIR 62A3      RELEASE_SPRING 6396      
RELEASE_A_FIREBALL 63A0      RIGHT_CONVEYER_DIR 63A5      RETRACTABLE_LADDER_SPRITES 6944      
R_RETRACT_LADDER_SPRITE 6948      R_RETRACT_LADDER_SPRITE_X 6948      R_RETRACT_LADDER_SPRITE_NUM 6949      
R_RETRACT_LADDER_SPRITE_PAL 694A      R_RETRACT_LADDER_SPRITE_Y 694B      SLP_GIRDER_TILE 0002      
SQR_GIRDER_TILE 0003      SECOND_PLAYER 600E      SELECTED_LETTER 6035      
STOMP_SOUND_TRIGGER 6082      SPRING_SOUND_TRIGGER 6083      SONG_TRIGGER  6089      
SONG_TRIGGER_NONE 0000      SONG_TRIGGER_INTRODUCTION 0001      SONG_TRIGGER_INTERMISSION 0002      
SONG_TRIGGER_OUT_OF_TIME 0003      SONG_TRIGGER_HAMMER 0004      SONG_TRIGGER_LEVEL_END_2 0005      
SONG_TRIGGER_HAMMER_HIT 0006      SONG_TRIGGER_STAGE_END 0007      SONG_TRIGGER_BG_BARRELS 0008      
SONG_TRIGGER_BG_MIXER 0009      SONG_TRIGGER_BG_ELEVATORS 000A      SONG_TRIGGER_BG_RIVETS 000B      
SONG_TRIGGER_LEVEL_END_1 000C      SONG_TRIGGER_RIVET_REMOVED 000D      SONG_TRIGGER_RIVET_END 000E      
SONG_TRIGGER_ROAR 000F      STAGE_BARRELS 0001      STAGE_MIXER   0002      
STAGE_ELEVATORS 0003      STAGE_RIVETS  0004      STAGE_DATA_BLOCK 6280      
SECRET_ELEVATOR_DIR 62A4      SECRET_ELEVATOR_MOVE_COUNT 62B6      SECRET_ELEVATOR_QUAD 62B7      
SECRET_ELEVATOR_PAUSE_COUNT 62BA      SECRET_ELEVATOR_REVERSE 62BB      SMASHED_SPRITE_POINTER 6343      
SMASH_ANIMATION_STATE 6345      SMASH_ANIMATION_FRAME_DELAY 6346      SMASH_ANIMATION_CYCLE_COUNTER 6347      
SMASH_ANIMATION_ACTIVE 6350      SMASH_ENEMY_CLASS_POINTER 6351      SMASH_ENEMY_DATA_SIZE 6353      
SMASH_ANIMATION_ENEMY_INDEX 6354      STAGE_DEFORM_INDEX 638D      STAGE_DATA_START_ADDRESS 63AB      
STAGE_DATA_END_ADDRESS 63AD      STAGE_DATA_FIRST_Y_OFFSET 63AF      STAGE_DATA_LAST_Y_OFFSET 63B0      
STAGE_DATA_X_DIFF 63B1      STAGE_DATA_Y_DIFF 63B2      STAGE_DATA_TILE_ID 63B3      
STAGE_DATA_UNKNOWN 63B4      STAGE_DATA_CURRENT_TILE 63B5      SPRING_STRUCTS 6500      
SPRITE_STRUCTS 6900      SPRING_SPRITES 6980      SPRING_SPRITE_1 6980      
SPRING_SPRITE_2 6984      SPRING_SPRITE_3 6988      SPRING_SPRITE_4 698C      
SPRING_SPRITE_5 6990      SPRING_SPRITE_6 6994      SPRING_SPRITE_7 6998      
SPRING_SPRITE_8 699C      SPRING_SPRITE_9 69A0      SPRING_SPRITE_10 69A4      
STANDING_BARREL_SPRITE_DATA 69A8      STANDING_BARREL_SPRITE_1 69A8      STANDING_BARREL_SPRITE_1_X 69A8      
STANDING_BARREL_SPRITE_1_NUM 69A9      STANDING_BARREL_SPRITE_1_PAL 69AA      STANDING_BARREL_SPRITE_1_Y 69AB      
STANDING_BARREL_SPRITE_2 69AC      STANDING_BARREL_SPRITE_2_X 69AC      STANDING_BARREL_SPRITE_2_NUM 69AD      
STANDING_BARREL_SPRITE_2_PAL 69AE      STANDING_BARREL_SPRITE_2_Y 69AF      STANDING_BARREL_SPRITE_3 69B0      
STANDING_BARREL_SPRITE_3_X 69B0      STANDING_BARREL_SPRITE_3_NUM 69B1      STANDING_BARREL_SPRITE_3_PAL 69B2      
STANDING_BARREL_SPRITE_3_Y 69B3      STANDING_BARREL_SPRITE_4 69B4      STANDING_BARREL_SPRITE_4_X 69B4      
STANDING_BARREL_SPRITE_4_NUM 69B5      STANDING_BARREL_SPRITE_4_PAL 69B6      STANDING_BARREL_SPRITE_4_Y 69B7      
SMASH_SPRITE  6A2C      SMASH_SPRITE_X 6A2C      SMASH_SPRITE_NUM 6A2D      
SMASH_SPRITE_PAL 6A2E      SMASH_SPRITE_Y 6A2F      SONG_OUTPUT   7C00      
STOMP_SOUND_OUTPUT 7D02      SPRING_SOUND_OUTPUT 7D03      SCREEN_ORIENTATION 7D82      
TWO_PLAYERS   600F      TOP_OF_CURRENT_LADDER 621B      TOP_MASTER_REVERSE_TIMER 62A0      
TOP_MASTER_CONVEYER_DIR 62A1      TITLE_PALETTE_CYCLE_COUNTER 638A      TITLE_PALETTE_PATTERN 638B      
TIME_FOR_DK_ACTION 6391      TOP_CONVEYER_DIR 63A3      TIMER_HAS_RUN_DOWN 63B8      
TRIGGER_SPRITES 6970      TRIGGER_SPRITE_1 6970      TRIGGER_SPRITE_2 6974      
TRIGGER_SPRITE_3 6978      TRIGGER_SPRITE_4 697C      TIME_RUNNING_OUT_SOUND_OUTPUT 7D09      
UPDATED_FIREBALL_COUNT 63A2      WALK_SOUND_TRIGGER 6080      WIN_ANIMATION_STATE 6388      
WALK_SOUND_OUTPUT 7D00      X_TILE        0006      l0008         0008      
l0010         0010      l0018         0018      l0026         0026      
l0032         0032      l0038         0038      l_move_n_sprites_1 003D      
l0044         0044      l0048         0048      l0098         0095      
l009b         0098      l00b5         00AC      l00ed         00E4      
l00f5         00EB      l0108         00FC      l010b         00FF      
l0118         010B      l0125         0118      l012d         0120      
l0189         017B      l019d         018E      l0221         0211      
l0226         0216      l0241         022E      l0247         0234      
l0259         0245      l026c         0258      l026d         0259      
l0279         0265      l027a         0266      l0288         0274      
l028a         0276      l0298         0284      l02f6         02E2      
l0307         02F3      l033e         032A      l0361         034D      
l039e         038A      l03de         03C9      l03e4         03CF      
l0413         03FC      l0426         0412      l0448         0431      
l0450         0439      l0464         044A      l0478         045C      
l0485         0468      l0486         0469      l0493         046E      
l0496         0479      l04a1         0482      l04a3         0484      
l04ac         048D      l04be         049F      l04e1         04C3      
l04f1         04D2      l04f9         04DA      l0509         04E9      
l_animate_dk_and_pauline_1 04F2      l0516         0500      l052e         0514      
l0545         0533      l0550         053D      l0556         0543      
l0583         056F      l05ab         0595      l05b3         059C      
l05bd         05A5      l05cb         05B2      l05d5         05BB      
l05da         05BF      l05e0         05C4      l0600         05E4      
l060c         05F0      l0640         0622      l0655         0636      
l066a         064A      l0689         0668      l0691         0670      
l06a8         0687      l06b1         0690      l06c2         06A0      
l06d2         06AF      l06d7         06B4      l06ed         06CA      
l06f0         06CD      l07ad         077A      l07bc         0788      
l07da         07A5      l07eb         07B5      l07f4         07BE      
l07fa         07C4      l0801         07CB      l082d         07F9      
l083b         0806      l0857         0822      l085b         0826      
l0868         0832      l086b         0835      l0879         0842      
l0880         0849      l0893         085B      l0895         085D      
l08a7         086C      l08ad         0872      l08d5         089A      
l08e4         08A8      l08f3         08B6      l0906         08C7      
l090f         08D0      l0919         08D9      l0938         08F8      
l0970         0930      l099f         095E      l09a8         0966      
l09d0         098D      l0b1e         0ADA      l0b38         0AF4      
l0b86         0B40      l0bc8         0B82      l0bd1         0B8A      
l0c11         0BCA      l0c1f         0BD8      l0c29         0BE2      
l0c29a        0BE4      l0c2b         0BE6      l0c43         0BF9      
l0cc6         0C76      l0cd4         0C87      l0cdf         0C91      
l0cf2         0CA3      ldisplaycurrentstage1 0CB0      l0d05         0CC7      
l0d0d         0CCF      l0d30         0CF1      l0d32         0CF3      
l0d3d         0CFE      l0d4c         0D0D      l0d4e         0D0F      
l0d59         0D1A      lsecret0d4b   0D2A      lsecret0d4c   0D31      
lsecret0d4e   0D33      l0d8b         0D6D      lpaulinesecret 0D86      
l0dd3         0DD8      l0e19         0E1D      l0e2a         0E2C      
l0e3f         0E40      l0e4b         0E4B      l0e4f         0E4F      
l0e62         0E62      l0e78         0E76      l0ea0         0E9B      
l0ec9         0EC1      l0ecf         0EC6      l0ed3         0ECA      
l0ee5         0EDC      l0ee8         0EDE      l0eff         0EF4      
l0f14         0F07      l0f1b         0F0E      l0f2f         0F20      
l0f35         0F26      l0f4c         0F3C      l0f51         0F40      
l0f5b         0F49      l0f5c         0F4A      l0f67         0F55      
l0f68         0F56      l0f8e         0F7C      l0f93         0F81      
l0fa2         0F90      l0fbc         0FAA      l0fcb         0FB9      
l_init_barrels_stage_sprites_1 0FED      l10a0         1077      l10a8         107D      
l10ad         1082      l10c3         1092      l_init_rivets_stage_sprites_1 1125      
l_init_secret_stage_sprites_0 11BC      l_init_secret_stage_sprites_1 11D4      lsecret10c3   120A      
l122e         1295      l124b         12B1      l12cb         132E      
l12ed         134F      l1322         1383      l1334         1395      
l133f         139F      l137f         13DE      l138a         13E8      
l1395         13F3      l139c         13F9      l13da         1436      
l13ed         1449      l13fc         1458      l140a         1466      
l1437         1492      l1445         149F      l144f         14A8      
l1459         14B1      l146e         14C5      l14c1         1515      
l14c9         151C      l14dc         152F      l14ed         153F      
l14fc         154D      l1514         1562      l151d         1569      
l152d         1576      l1539         1581      l1546         158D      
l1567         15AB      l156d         15B0      l1580         15C2      
l1586         15C7      l158a         15CA      l15a0         15DE      
l15b8         15F5      l15c6         1602      l15d1         160D      
l15df         161B      l15ed         1629      l15f9         1635      
l1622         1661      l1662         16B4      l1686         16D8      
l16d0         171F      l16d5         1724      l16e1         1730      
l16ee         173A      l_win_anim_display_pauline_1 176F      l_win_anim_display_pauline_2 177D      
l_win_stage_anim_3_1 17B7      l1774         17D9      l177f         17E3      
l1785         17E9      l_advance_to_next_stage_1 1801      l_advance_to_next_stage_2 180E      
l179d         1819      l17a0         181C      l182d         18A8      
l182f         18AA      l184e         18C7      l1859         18D2      
l190f         1980      l1910         1981      l1920         1991      
l193d         19AE      l194b         19BB      l_secret_win_anim_3_1 1A6A      
l19d2         1AE3      lcheckifreached 1AF0      l19e2         1AF3      
l19ed         1AFE      l_check_if_trigger_reached_1 1B34      l1a07         1B3C      
l1a15         1B48      l1a1e         1B51      l1a1f         1B52      
l1a2a         1B5D      l1a33         1B66      l1a4b         1B7B      
l1a51         1B81      l1a62         1B91      l1a69         1B97      
l1a72         1B9F      l1a7b         1BA7      l1a95         1BC0      
l1a99         1BC3      l1a9e         1BC7      l1abd         1BE6      
l1ac3         1BEB      l1ae6         1C0B      l1af5         1C19      
l1afe         1C21      l1b2c         1C4B      l1b38         1C56      
l1b45         1C63      l1b4e         1C6C      l1b55         1C72      
l1b6e         1C8B      l1b8a         1CAA      l1bb2         1CD2      
l1bd8         1CF7      l1bec         1D0A      l1bf2         1D0F      
l1c05         1D20      l1c33         1D4A      l1c3a         1D51      
l1c48         1D5E      l1c4f         1D65      l1c76         1D8C      
l1c8f         1DA5      l1cab         1DBF      l1cc2         1DD5      
l1cd2         1DE5      l1ceb         1DFD      l1cf2         1E04      
l1d03         1E14      l1d11         1E21      l1d3f         1E4A      
l1d49         1E54      l1d51         1E5B      l1d67         1E70      
l1d76         1E7E      l1d8a         1E91      l1d8f         1E96      
l1d95         1E9C      l1da6         1EAD      l1df5         1EF5      
l1e00         1EFE      l1e08         1F05      l1e10         1F0C      
l1e15         1F11      l1e28         1F20      l1e36         1F2C      
l1e6d         1F61      l1e74         1F69      l1e7a         1F6E      
l1e7b         1F7D      l1e80         1F8B      l1e85         1F94      
l1e86         1F9B      l1eb4         1FCF      l1ec8         1FE2      
l1ecf         1FE8      l1ede         1FF6      l1f1d         2034      
l1f34         204A      l1f46         205C      l1f72         2088      
l1f83         2097      l1f8d         20A0      l1f93         20A6      
l1fac         20BC      l1fce         20DD      l1fdf         20ED      
l1fe5         20F3      l1fef         20FC      l1ff6         2103      
l202f         213A      l2038         2143      l2053         215E      
l2079         2182      l2083         218C      l209c         21A2      
l20a2         21A8      l20b5         21B9      l20c3         21C6      
l20e1         21E4      l20ec         21EE      l2104         2204      
l2118         2218      l2146         2244      l2153         2251      
l215c         225A      l215f         225C      l2160         225D      
l216d         2266      l21a9         229D      l21ae         22A1      
l21b2         22A5      l2219         230B      l223a         2327      
l2257         2342      l2275         235F      l2276         2360      
l2281         236A      l228a         2373      l2295         237C      
l22c9         23AF      l22cb         23B1      l22e1         23C6      
l22f6         23D8      l22f9         23DB      l2303         23E5      
l2316         23F7      l231a         23FB      l2326         2406      
l2342         2420      l2347         2425      l2359         2434      
l235a         2435      l235c         2437      l2360         243A      
l2366         243F      l2371         244C      l238f         2465      
l2395         246A      l2398         246D      l239a         246F      
l239c         2471      l23de         24B3      l2403         24D7      
l2407         24DB      lcagebarrier  2508      l2471         253D      
l2478         2544      l2488         2551      l249e         2566      
l24b4         257B      l24d0         2596      l24ea         25B0      
l24fc         25C2      l2517         25DC      l251c         25E1      
l2523         25E7      l2539         25FC      l2545         2607      
l2558         2618      l2560         2620      l256e         262C      
l2576         2633      l258f         264C      l259a         265A      
l25bb         2678      l25c0         2681      l25cf         268E      
l25d6         2694      l2616         26C0      l264c         26D9      
l268d         2708      l26b5         272E      l26c3         273B      
l26c5         273D      l26ce         2745      l26dc         2752      
l26e6         275B      l26f8         276C      l271a         277B      
l271e         277E      l2722         2782      l2734         2794      
l2766         27C2      l276f         27CB      l277f         27DA      
l2787         27E2      l27a0         27FA      l27c2         2819      
l27c7         281E      l27e8         283C      l27f4         2847      
l2806         2859      l_implement_secret_elevators_1 287F      l_implement_secret_elevators_2 28AB      
l_implement_secret_elevators_3 28BB      l_implement_secret_elevators_5 28CF      lelevatormove 2909      
lsecret2734   2917      l2826         2941      l2832         294C      
l286b         2984      l_rivets_enemy_collision_1 29F9      l2915         2A0C      
l2925         2A1A      l2930         2A23      l293b         2A2D      
l2945         2A35      l294c         2A3B      l296f         2A5D      
l29ac         2A98      l29c7         2AB2      l29d0         2AB9      
l29ee         2AD5      l2a08         2AEC      l2a0e         2AF2      
l2a1b         2B01      l2a20         2B06      l2a2f         2B15      
l2a63         2B42      l2a69         2B47      l2a6e         2B4B      
l2a72         2B4F      l2a7b         2B57      l2a7d         2B59      
l2a85         2B61      l2ab4         2B8E      l2acd         2BA4      
l2af0         2BBA      l2af6         2BBF      l2b02         2BCA      
l2b18         2BDE      l2b1a         2BE0      l2b1c         2BE2      
l2b29         2BEF      l2b51         2C14      l2b53         2C16      
l2b74         2C35      l2b7a         2C3B      l2b8b         2C4A      
l2b91         2C50      l2b9b         2C5A      l2bc5         2C7D      
l2bcb         2C82      l2bcf         2C86      l2bd9         2C8F      
l2bdc         2C92      l2be1         2C97      l2bef         2CA3      
l2bf8         2CAB      l2bfd         2CB0      l2c03         2CB6      
l2c2c         2CDD      l2c33         2CE3      l2c41         2CF0      
l2c49         2CF7      l2c4b         2CF9      l2c4f         2CFD      
l2c69         2D17      l2c72         2D1F      l2c7b         2D28      
l2c86         2D31      l2c8f         2D39      l2ca8         2D51      
l2cb3         2D5A      l2cb8         2D5F      l2ce6         2D8C      
l2cf6         2D9B      l2d15         2DB9      l2d2f         2DD1      
l2d2f_1       2DEB      l2d51         2E02      l2d54         2E05      
l2d70         2E1F      l2d83         2E32      l2d8c         2E3A      
l2da5         2E52      l2dee         2EA3      l2df1         2EA6      
l2e12         2EC7      l2e29         2EDD      l2e4b         2EFD      
l2e6c         2F1C      l2e78         2F28      l2e84         2F34      
l2e9c         2F4A      l2ea7         2F54      l2eed         2F94      
l2f1b         2FC1      l2f43         2FE7      l2f7c         301E      
l2f97         3039      l2fb7         3058      l2fbe         305E      
l2fcb         3069      l3009         30A7      l3017         30B3      
l3022         30BC      l302b         30C4      l3031         30C9      
l3098         312F      l30b8         314D      l30bb         3150      
l30e4         3178      l30e5         3179      l3103         3197      
l3149         31D9      l316a         31F7      l317c         3208      
l3195         3218      l31be         323F      l31d0         3250      
l3229         32A5      l3230         32AB      l3233         32AE      
l3257         32CF      l3261         32D8      l327a         32F1      
l327e         32F5      l3284         32FA      l3286         32FC      
l328c         3301      l3291         3305      l3297         330A      
l32a8         331A      l32b1         3322      l32b9         3329      
l32ce         333B      l32d2         333F      l32f8         335E      
l32fd         3363      l3303         3368      l330b         3370      
l3332         338D      l3371         33BF      l338a         33D8      
l3399         33E7      l33c0         340C      l33d9         3425      
l3401         344A      l3405         344E      l3428         3470      
l3442         3489      l3445         348C      l3456         349C      
l349a         34DE      l34a8         34EA      l34b3         34F4      
l34ca         3506      l34ed         3529      l34fb         3536      
l3517         3551      l351e         3558      l379e         37AF      
l37b6         37C7      l37d2         37E3      l37e1         37F2      
l37f4         3805      l3806         3817      l38dc         38ED      
l39c3         39D4      l39cc         39DD      l3cf4         3D5B      
l3cf8         3D5F      l3cfc         3D63      l3d00         3D67      
l3d04         3D6B      l3e88         3F19      l3e99         3F29      
l3ec3         3F53      l3ed3         3F61      l3ede         3F6A      
l3ee9         3F74      l3ef3         3F7C      l3efa         3F83      
l3fae         3FC8      l3fb1         3FCB      l4000         4000      

tasm: Number of errors = 0
