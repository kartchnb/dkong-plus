0001   0000             ; An attempt to produce code of the original Donkey Kong game
0002   0000             ; as small as possible without (noticeably) affecting the game
0003   0000             
0004   0000             #include "vars.h"
0001+  0000             ; The following macro allows tile coordinates to be entered as x,y coordinates rather
0002+  0000             ; than bare memory addresses
0003+  0000             #define		TILE_COORD(x,y)			$7400 + (x * 32) + y
0004+  0000             
0005+  0000             ; The following macro combines two bytes into a single word
0006+  0000             #define		TWO_BYTES(a,b)			(b & $ff) | ((a & $ff) << 8) & $ffff
0007+  0000             
0008+  0000             ; The following macro assembles a block of stage data given:
0009+  0000             ;	t - the tile type
0010+  0000             ;	x1, y1 - the starting coordinate of the line of tiles
0011+  0000             ;	x2, y2 - the ending coordinate of the line of tiles
0012+  0000             #define		STAGE_DATA(t,x1,y1,x2,y2) .byte (t)\ .word ((y1<<11) | (x1<<3) & $ffff) \ .word ((y2<<11) + (x2<<3) & $ffff)
0013+  0000             #define		NRM_LAD_STAGE_DATA(x1,y1,x2,y2) .byte 0\ .word ((y1<<11) | (x1<<3 | 0011) & $ffff) \ .word ((y2<<11) | (x2<<3 | 0011) & $ffff)
0014+  0000             #define		BRK_LAD_STAGE_DATA(x1,y1,x2,y2) .byte 1\ .word ((y1<<11) | (x1<<3 | 0011) & $ffff) \ .word ((y2<<11) | (x2<<3 | 0011) & $ffff)
0015+  0000             ; The following macro converts an x,y coordinate into a stage data location
0016+  0000             #define		STAGE_COORD(x,y)		((y<<11) | (x<<3)) & $ffff
0017+  0000             #define		STAGE_DATA_END 			.byte 	$AA
0018+  0000             
0019+  0000             LADDER_TILE							= 0
0020+  0000             BRK_LADDER_TILE						= 1
0021+  0000             SLP_GIRDER_TILE						= 2
0022+  0000             SQR_GIRDER_TILE						= 3
0023+  0000             BLANK_TILE							= 4
0024+  0000             CIR_GIRDER_TILE						= 5
0025+  0000             X_TILE								= 6
0026+  0000             
0027+  0000             NUM_PLAYS	                 		= $6001		; The number of game plays that have been paid for
0028+  0000             NUM_COINS_PENDING           		= $6002  	; Keeps track of the number of coins entered until there are enough for a credit
0029+  0000             COIN_VALID                    		= $6003  	; Prevents 1 coin entry from being processed more than once
0030+  0000             
0031+  0000             GAME_STATE             				= $6005  
0032+  0000             GAME_STATE_INIT							= 0		; Preparing the game
0033+  0000             GAME_STATE_ATTRACT						= 1		; Running attract mode
0034+  0000             GAME_STATE_COIN							= 2		; Coin(s) inserted, waiting for player to push start
0035+  0000             GAME_STATE_PLAY							= 3		; The game is being played
0036+  0000                 
0037+  0000             NO_COINS_INSERTED           		= $6007  	; becomes 0 when a coin is inserted
0038+  0000             MAJOR_TIMER                 		= $6008
0039+  0000             MINOR_TIMER                 		= $6009
0040+  0000             
0041+  0000             GAME_SUBSTATE						= $600a
0042+  0000             ; If GAME_STATE == GAME_STATE_ATTRACT
0043+  0000             GAME_SUBSTATE_ATTRACT_COIN				= 0		; Display insert coin screen
0044+  0000             GAME_SUBSTATE_ATTRACT_INIT				= 1		; Initialize the attract mode
0045+  0000             GAME_SUBSTATE_ATTRACT_MARIO		 		= 2 	; Initialize the Mario sprite 
0046+  0000             GAME_SUBSTATE_ATTRACT_RUN				= 3		; Run the attract mode
0047+  0000             	
0048+  0000             ; If GAME_STATE == GAME_STATE_COIN_INSERTED
0049+  0000             
0050+  0000             ; If GAME_STATE == GAME_STATE_PLAYING
0051+  0000             GAME_SUBSTATE_PLAY_ORIENT				= 0		; Orienting the screen
0052+  0000             GAME_SUBSTATE_PLAY_INIT_P1				= 1		; Initialize player 1
0053+  0000             GAME_SUBSTATE_PLAY_START_P1				= 2		; Display player 1 start prompt
0054+  0000             GAME_SUBSTATE_PLAY_INIT_P2				= 3 	; Initialize player 2
0055+  0000             GAME_SUBSTATE_PLAY_START_P2				= 4		; Display player 2 start prompt
0056+  0000             GAME_SUBSTATE_PLAY_PLAYER_INFO			= 5		; Display information for the player
0057+  0000             GAME_SUBSTATE_PLAY_PREPARE				= 6		; Prepare to display either intro or intermission
0058+  0000             GAME_SUBSTATE_PLAY_INTRO				= 7		; Run the introduction screen
0059+  0000             GAME_SUBSTATE_PLAY_INTERMISSION			= 8		; Run the intermission screen
0060+  0000             GAME_SUBSTATE_PLAY_STAGE				= 10	; Display the current stage
0061+  0000             GAME_SUBSTATE_PLAY_MARIO				= 11	; Initialize the Mario sprite
0062+  0000             	
0063+  0000             CURRENT_PLAYER						= $600d
0064+  0000             PLAYER_1								= 0		; Player 1's turn
0065+  0000             PLAYER_2								= 1		; Player 2's turn
0066+  0000             
0067+  0000             SECOND_PLAYER						= $600e		; 1 if the second player is the current player
0068+  0000             TWO_PLAYERS							= $600f		; = 1 if two players are playing
0069+  0000             PLAYER_INPUT						= $6010
0070+  0000             PLAYER_INPUT_JUMP_BIT					= 7
0071+  0000             PLAYER_INPUT_DOWN_BIT					= 3
0072+  0000             PLAYER_INPUT_UP_BIT						= 2
0073+  0000             PLAYER_INPUT_LEFT_BIT					= 1
0074+  0000             PLAYER_INPUT_RIGHT_BIT					= 0
0075+  0000             PLAYER_INPUT_LAG					= $6011		; Prevents input (specifically the jump button) from being processed twice
0076+  0000             
0077+  0000             RANDOM_NUMBER						= $6018		
0078+  0000             COUNTER_1							= $6019
0079+  0000             COUNTER_2							= $601a		; Decremented on every interrupt
0080+  0000             
0081+  0000             DIP_NUM_LIVES						= $6020		; The number of lives setting from the DIP switches
0082+  0000             DIP_BONUS_LIFE						= $6021		; The number of points for the life bonus from the DIP switches
0083+  0000             NUM_COINS_FOR_1P					= $6022		; The number of coins required for 1 player to play
0084+  0000             NUM_COINS_FOR_2P					= $6023		; The number of coins required for 2 players to play
0085+  0000             DIP_COINS_PER_CREDIT				= $6024		; The number of coins required for 1 credit
0086+  0000             DIP_PLAYS_PER_CREDIT				= $6025		; The number of plays given for each credit earned
0087+  0000             CABINET_TYPE						= $6026
0088+  0000             CABINET_TYPE_COCKTAIL					= 0
0089+  0000             CABINET_TYPE_UPRIGHT					= 1
0090+  0000             
0091+  0000             JOYSTICK_INPUT_DELAY				= $6030	; Prevents the joystick from scrolling through the letters too quickly on the high score initials entry screen
0092+  0000             BLANK_CP_HIGH_SCORE					= $6031	; Makes the score display blink (0 = display score, 1 = blank it)
0093+  0000             BLINK_SCORE_TIMER					= $6032	; The score starts to blink when this reaches 0
0094+  0000             INITIALS_TIMER_VALUE				= $6033	; The time remaining to enter initials
0095+  0000             INITIALS_TIMER_DELAY				= $6034	; The delay between ticks of the initials timer
0096+  0000             SELECTED_LETTER						= $6035	; The letter currently selected for high score entry
0097+  0000             INITIALS_COORD						= $6036	; 2 byte screen coordinate the next initial letter will be displayed at for high score entry
0098+  0000             PLAYER_ID_ADDRESS					= $6038	; 2 byte address of the player's high score entry - determined when it's time for the player to enter initials
0099+  0000             INITIALS_ADDRESS					= $603a	; The memory address to write the player's initials to for the high score
0100+  0000             
0101+  0000             P1_DATA								= $6040
0102+  0000             	; This is an 8 byte block of data for player 1
0103+  0000             	; The individual data items are listed below
0104+  0000             P1_NUMBER_LIVES						= $6040	; The number of lives for player 1
0105+  0000             P1_LEVEL_NUMBER						= $6041	; Player 1's level number
0106+  0000             P1_STAGE_ORDER_POINTER				= $6042	; The address of the stage data for player 1's current stage
0107+  0000             P1_INTRO_NOT_DISPLAYED				= $6044	; 1 if the intro has not been displayed for player 1
0108+  0000             P1_BONUS_AWARDED					= $6045	; 1 if player 1 has been awarded a bonus life
0109+  0000             P1_HEIGHT_INDEX						= $6046	; The index to the current height that player 1 has achieved
0110+  0000             P1_STAGE_ORDER_POINTER_LAG			= $6047
0111+  0000             P2_DATA								= $6048
0112+  0000             	; This is an 8 byte block of data for player 2
0113+  0000             	; The individual data items are listed below
0114+  0000             P2_NUMBER_LIVES						= $6048	; The number of lives for player 2
0115+  0000             P2_LEVEL_NUMBER						= $6049	; Player 2's level number
0116+  0000             P2_STAGE_ORDER_POINTER				= $604a	; The address of the stage data for player 2's current stage
0117+  0000             P2_INTRO_NOT_DISPLAYED				= $604c	; 1 if the intro has not been displayed
0118+  0000             P2_BONUS_AWARDED					= $604d	; 1 if player 2 has been awarded a bonus life
0119+  0000             P2_HEIGHT_INDEX						= $604e	; The index to the current height that player 2 has achieved
0120+  0000             P2_STAGE_ORDER_POINTER_LAG			= $604f
0121+  0000             
0122+  0000             WALK_SOUND_TRIGGER					= $6080	; Triggers the Mario walking sound
0123+  0000             JUMP_SOUND_TRIGGER					= $6081	; Triggers the Mario jumping sound
0124+  0000             STOMP_SOUND_TRIGGER					= $6082	; Triggers the Donkey Kong stomping sound
0125+  0000             SPRING_SOUND_TRIGGER				= $6083	; Triggers the spring bounce sound
0126+  0000             FALL_SOUND_TRIGGER					= $6084	; Triggers the falling spring sound
0127+  0000             AWARD_SOUND_TRIGGER					= $6085	; Triggers the point award sound (Mario jumps a barrel, smashes a barrel/fire, grabs the hammer)
0128+  0000             
0129+  0000             DEATH_SOUND_TRIGGER					= $6088
0130+  0000             SONG_TRIGGER						= $6089	; Songs are played whenever this is set to non-zero
0131+  0000             SONG_TRIGGER_NONE						= 0
0132+  0000             SONG_TRIGGER_INTRODUCTION				= 1
0133+  0000             SONG_TRIGGER_INTERMISSION				= 2
0134+  0000             SONG_TRIGGER_OUT_OF_TIME				= 3
0135+  0000             SONG_TRIGGER_HAMMER						= 4
0136+  0000             SONG_TRIGGER_LEVEL_END_2				= 5
0137+  0000             SONG_TRIGGER_HAMMER_HIT					= 6
0138+  0000             SONG_TRIGGER_STAGE_END					= 7
0139+  0000             SONG_TRIGGER_BG_BARRELS					= 8	
0140+  0000             SONG_TRIGGER_BG_MIXER					= 9
0141+  0000             SONG_TRIGGER_BG_ELEVATORS				= 10
0142+  0000             SONG_TRIGGER_BG_RIVETS					= 11
0143+  0000             SONG_TRIGGER_LEVEL_END_1				= 12
0144+  0000             SONG_TRIGGER_RIVET_REMOVED				= 13
0145+  0000             SONG_TRIGGER_RIVET_END					= 14
0146+  0000             SONG_TRIGGER_ROAR						= 15
0147+  0000             PENDING_SONG_TRIGGER				= $608a	; The current song being played
0148+  0000             PENDING_SONG_TRIGGER_REPEAT			= $608b		; The number of times to repeat the pending song trigger
0149+  0000             
0150+  0000             ACTION_BUFFER_WRITE_POS				= $60b0
0151+  0000             ACTION_BUFFER_READ_POS				= $60b1
0152+  0000             PREV_P1_SCORE						= $60b2		; The remembered player 1 score displayed during attract mode
0153+  0000             PREV_P2_SCORE						= $60b5		; The remembered player 2 score
0154+  0000             PREV_HIGH_SCORE						= $60b8		; The remembered high score
0155+  0000             
0156+  0000             HIGH_SCORE_TABLE					= $6100
0157+  0000             	; Each entry in the table has the following format
0158+  0000             	; Bytes 0-1 = Coord of the high score string representation
0159+  0000             	; Bytes 2-27 = High score string representation
0160+  0000             	; Byte 28 = Player ID
0161+  0000             	;	0 = No current player
0162+  0000             	;	1 = Player 1
0163+  0000             	;	2 = Player 2
0164+  0000             	; Bytes 29-31 = High score entry (BCD)
0165+  0000             	; Bytes 32-33 = High score coord
0166+  0000             HIGH_SCORE_TABLE_ENTRY_1			= $6100
0167+  0000             HIGH_SCORE_TABLE_ENTRY_2			= $6122
0168+  0000             HIGH_SCORE_TABLE_ENTRY_3			= $6144
0169+  0000             HIGH_SCORE_TABLE_ENTRY_4			= $6166
0170+  0000             HIGH_SCORE_TABLE_ENTRY_5			= $6188
0171+  0000             
0172+  0000             CURRENT_SCORE_STRING				= $61b1	; The string representation of the current player's score including room for initials (18 bytes long) (ends at $61c3)
0173+  0000             
0174+  0000             MARIO_DATA_STRUCT					= $6200
0175+  0000             	; This is the start of Mario's 39 byte data structure
0176+  0000             	; The structure consists of the following data items
0177+  0000             	; (Each item also has a separate variable defined below):
0178+  0000             	;  0 - Mario is alive (1 or 0)
0179+  0000             	; 
0180+  0000             	;  3 - Mario's x coordinate
0181+  0000             	; 
0182+  0000             	;  5 - Mario's y coordinate
0183+  0000             	;
0184+  0000             	;  7 - Mario's sprite number
0185+  0000             	;  8 - Mario's palette
0186+  0000             	;
0187+  0000             	; 14 - The y coordinate that Mario started jumping from
0188+  0000             	;
0189+  0000             	; 16 - Mario is jumping left if this equals $FF
0190+  0000             	; 17 - Mario is jumping right if this equals $80
0191+  0000             	;
0192+  0000             	; 21 - Mario is climbing a ladder (1 or 0)
0193+  0000             	; 22 - Mario is jumping (1 or 0)
0194+  0000             	; 23 - The hammer cycle is active (1 or 0)
0195+  0000             	; 24 - The hammer has been grabbed (1 or 0)
0196+  0000             	; 
0197+  0000             	; 27 - The y coordinate of the top of the ladder being currently climbed
0198+  0000             	; 28 - The y coordinate of the bottom of the ladder being currently climbed
0199+  0000             	;
0200+  0000             	; 33 - Mario is falling (1 or 0)
0201+  0000             MARIO_ALIVE							= $6200
0202+  0000             
0203+  0000             MARIO_X								= $6203
0204+  0000             
0205+  0000             MARIO_Y								= $6205			
0206+  0000             
0207+  0000             MARIO_DATA_SPRITE_NUM				= $6207
0208+  0000             MARIO_DATA_PALETTE					= $6208
0209+  0000             
0210+  0000             MARIO_JUMP_Y_COORD					= $620e	; The y coordinate of the start of Mario's current jump
0211+  0000             
0212+  0000             MARIO_JUMPING_LEFT					= $6210	; $FF if Mario is jumping left
0213+  0000             MARIO_JUMPING_RIGHT				 	= $6211	; $80 if Mario is jumping right
0214+  0000             
0215+  0000             MARIO_IS_CLIMBING					= $6215 ; 1 if Mario is climbing a ladder
0216+  0000             MARIO_IS_JUMPING					= $6216	; 1 if Mario is jumping
0217+  0000             HAMMER_CYCLE_ACTIVE					= $6217	; This is set to 1 if Mario has the hammer and the up/down cycle is active
0218+  0000             HAMMER_GRABBED						= $6218 ; This is set to 1 when Mario initially jumps up and grabs the hammer, and is set to 0 when Mario comes back down and the hammer cycle starts
0219+  0000             
0220+  0000             TOP_OF_CURRENT_LADDER				= $621b	; The y coordinate of the top of the current ladder being climbed
0221+  0000             BOT_OF_CURRENT_LADDER				= $621c	; The y coordinate of the bottom of the current ladder being climbed
0222+  0000             
0223+  0000             MARIO_HAMMER_CYCLE_DELAY			= $621e	; Small delay between when the hammer is grabbed and the hammer cycle begins (countdown from 4 to 0)
0224+  0000             
0225+  0000             MARIO_IS_FALLING					= $6221	; 1 when Mario is in free fall
0226+  0000             
0227+  0000             CURRENT_STAGE						= $6227	; The stage that the current player is at
0228+  0000             STAGE_BARRELS							= 1		
0229+  0000             STAGE_MIXER								= 2
0230+  0000             STAGE_ELEVATORS							= 3
0231+  0000             STAGE_RIVETS							= 4
0232+  0000             
0233+  0000             CP_DATA								= $6228
0234+  0000             	; This is an 8 byte block of data for the current player
0235+  0000             	; The individual data items are listed below
0236+  0000             CP_NUMBER_LIVES						= $6228	; The number of lives for the current player
0237+  0000             CP_LEVEL_NUMBER						= $6229	; The level number for the current player
0238+  0000             CP_STAGE_ORDER_POINTER				= $622a
0239+  0000             CP_INTRO_NOT_DISPLAYED				= $622c ; 1 if the current player has seen the intro screen
0240+  0000             CP_BONUS_LIFE_AWARDED				= $622d	; 1 if the current player has earned the bonus life
0241+  0000             CP_HEIGHT_INDEX						= $622e
0242+  0000             HEIGHT_25M								= 0
0243+  0000             HEIGHT_50M								= 1
0244+  0000             HEIGHT_75M								= 2
0245+  0000             HEIGHT_100M								= 3
0246+  0000             HEIGHT_125M								= 4
0247+  0000             HEIGHT_150M								= 5
0248+  0000             CP_STAGE_ORDER_POINTER_LAG			= $622f
0249+  0000             
0250+  0000             ; This is the start of 64 bytes of data used in the stage game play
0251+  0000             STAGE_DATA_BLOCK					= $6280
0252+  0000             
0253+  0000             RETRACTABLE_LADDER_DATA				= $6280		
0254+  0000             ; The start of the 8 byte data for the two retractable ladders on the mixer stage
0255+  0000             ; The data structure is as follows:
0256+  0000             ;
0257+  0000             ;  0 - The ladder state
0258+  0000             ;		0 = ladder in up position
0259+  0000             ;		1 = ladder moving down
0260+  0000             ;		2 = ladder in down position
0261+  0000             ;		3 = ladder moving up
0262+  0000             ;  1 - The ladder up delay - the time before the ladder starts to descend
0263+  0000             ;  2 - The ladder x coordinate
0264+  0000             ;  3 - 
0265+  0000             ;  4 - The ladder move delay - the ladder is moved down one pixel when
0266+  0000             ;		this reaches 0
0267+  0000             L_RETRACT_LADDER_DATA				= $6280
0268+  0000             L_RETRACT_LADDER_STATE				= $6280
0269+  0000             L_RETRACT_LADDER_DELAY				= $6281
0270+  0000             L_RETRACT_LADDER_X					= $6282
0271+  0000             L_RETRACT_LADDER_Y					= $6283
0272+  0000             L_RETRACT_LADDER_MOVE_DELAY			= $6284
0273+  0000             
0274+  0000             R_RETRACT_LADDER_STATE				= $6288
0275+  0000             R_RETRACT_LADDER_DELAY				= $6289
0276+  0000             R_RETRACT_LADDER_X					= $628a
0277+  0000             R_RETRACT_LADDER_Y					= $628b
0278+  0000             R_RETRACT_LADDER_MOVE_DELAY			= $628c
0279+  0000             
0280+  0000             REMAINING_RIVETS					= $6290	; The number of rivets that have not been removed
0281+  0000             
0282+  0000             TOP_MASTER_REVERSE_TIMER			= $62a0	; When this reaches 0, the mixer stage conveyer directions are reversed
0283+  0000             TOP_MASTER_CONVEYER_DIR				= $62a1	; The direction of the top conveyer belt in the mixer stage
0284+  0000             MID_MASTER_REVERSE_TIMER			= $62a2	; When this reaches 0, the middle conveyers (left and right) change direction
0285+  0000             RIGHT_MASTER_CONVEYER_DIR			= $62a3	; The direction of the right conveyer belt
0286+  0000             LEFT_MASTER_CONVEYER_DIR			= $62a4	; The direction of the left conveyer belt
0287+  0000             BOT_MASTER_REVERSE_TIMER			= $62a5	; When this reaches 0, the bottom conveyer change direction
0288+  0000             BOT_MASTER_CONVEYER_DIR				= $62a6	; The direction of the bottom conveyer belt in the mixer stage
0289+  0000             ELEVATOR_SPAWN_TIMER				= $62a7	; Counts down from 52 to 0 and then a new elevator is spawned in the left column on the elevators stage
0290+  0000             
0291+  0000             DK_CLIMBING_COUNTER					= $62af	; Used to delay between advancing Donkey Kong's climbing animation
0292+  0000             
0293+  0000             INTERNAL_TIMER						= $62b0	; The internal stage timer (in hex)
0294+  0000             
0295+  0000             BARREL_FIRE_FREEZE					= $62b8	; Counts down from 4 to 0 between updates of the barrel fire
0296+  0000             BARREL_FIRE_STATE					= $62b9		
0297+  0000             	; 3 = Initial flare up
0298+  0000             	; 1 = Normal burning
0299+  0000             	; 0 = Not burning
0300+  0000             BARREL_FIRE_FLARE_UP_TIME			= $62ba	; The time remaining until the initial flare up subsides
0301+  0000             
0302+  0000             NORMAL_LADDER_X_COORD_DATA			= $6300	; The start of x coordinate data for the normal ladders in the current stage
0303+  0000             	; 15 bytes total (max of 15 normal ladders)
0304+  0000             BROKEN_LADDER_X_COORD_DATA			= $6310	; The start of x coordinate data for the broken ladders in the current stage
0305+  0000             	; 5 bytes total (max of 5 broken ladders)
0306+  0000             NORMAL_LADDER_Y1_COORD_DATA			= $6315	; The start of y1 coordinate data for the normal ladders in the current stage
0307+  0000             	; 15 bytes total (max of 15 broken ladders)
0308+  0000             BROKEN_LADDER_Y1_COORD_DATA			= $6325	; The start of y1 coordinate data for broken ladders in the current stage
0309+  0000             	; 5 bytes total (max of 5 broken ladders)
0310+  0000             NORMAL_LADDER_Y2_COORD_DATA			= $632A	; The start of y2 coordinate data for the normal ladders in the current stage
0311+  0000             	; 15 bytes total (max of 15 normal ladders)
0312+  0000             BROKEN_LADDER_Y2_COORD_DATA			= $633A	; The start of y2 coordinate data for the broken ladders in the current stage
0313+  0000             	; 5 bytes total (max of 5 broken ladders)
0314+  0000             POINT_AWARD_STATE					= $6340		
0315+  0000             	; 0 = No points have been awarded
0316+  0000             	; 1 = Award points to the player
0317+  0000             	; 2 = Display the point award
0318+  0000             POINT_AWARD_DISPLAY_TIMER			= $6341	; The current point award sprite is displayed until this timer reaches 0	
0319+  0000             POINT_AWARD_TYPE					= $6342 ; The type of point award that Mario has earned
0320+  0000             	; 0 = award points based on the level number
0321+  0000             	;	level 1 = 300 points
0322+  0000             	;	level 2 = 500 points
0323+  0000             	;	level 3+ = 800 points
0324+  0000             	; 1 = 200 points
0325+  0000             	; 2 = 300 points
0326+  0000             	; 3 = 300 points
0327+  0000             	; 4 = random 300, 500, or 800
0328+  0000             	; 5 = 500 points (800 point sprite is displayed)
0329+  0000             SMASHED_SPRITE_POINTER				= $6343	; The address of the sprite that was smashed by the hammer(2 bytes)
0330+  0000             SMASH_ANIMATION_STATE				= $6345	; The state of the smash animation
0331+  0000             	; 0 = 
0332+  0000             	; 1 = 
0333+  0000             	; 2 = 
0334+  0000             SMASH_ANIMATION_FRAME_DELAY			= $6346	; The current animation frame is displayed until this counts down to 0
0335+  0000             SMASH_ANIMATION_CYCLE_COUNTER		= $6347	; The smash animation cycles between the first two sprite images in the smash animation until this counts down to 0
0336+  0000             BARREL_FIRE_STATUS					= $6348	; 1 if the barrel fire has been lit
0337+  0000             
0338+  0000             SMASH_ANIMATION_ACTIVE				= $6350	; 1 when an object has been smashed and the animation is in effect (everything else pauses)
0339+  0000             SMASH_ENEMY_CLASS_POINTER			= $6351 ; (2 bytes) pointer to the start of the data structures for the enemy's class (used to find the correct enemy data structure)
0340+  0000             SMASH_ENEMY_DATA_SIZE				= $6353	; The size of the data structure of the enemy that was struck by the hammer (used to find the correct enemy data structure)
0341+  0000             SMASH_ANIMATION_ENEMY_INDEX			= $6354	; The index number (within the enemy's class) of the enemy that was struck by the hammer
0342+  0000             
0343+  0000             CP_DIFFICULTY						= $6380
0344+  0000             MAJOR_COUNTER						= $6381
0345+  0000             
0346+  0000             MINOR_COUNTER						= $6384
0347+  0000             INTRODUCTION_STATE					= $6385
0348+  0000             	; 0 = display introduction screen
0349+  0000             	; 1 = prepare sprites
0350+  0000             	; 2 = animate the climbing sequence
0351+  0000             	; 3 = pause
0352+  0000             	; 4 = animate intro screen
0353+  0000             	; 5 = pause
0354+  0000             	; 6 = animate Donkey Kong jumping
0355+  0000             	; 7 = Donkey Kong grins and laughs
0356+  0000             	
0357+  0000             WIN_ANIMATION_STATE					= $6388	; State of the win stage animation
0358+  0000             PRE_HAMMER_TUNE						= $6389 ; Saves the tune that was playing before the hammer was grabbed
0359+  0000             TITLE_PALETTE_CYCLE_COUNTER			= $638a	; Used to cycle the palette colors on the "DONKEY KONG" title screen
0360+  0000             TITLE_PALETTE_PATTERN				= $638b	; The currently used palette on the "DONKEY KONG" title screen
0361+  0000             ONSCREEN_TIMER						= $638c	; The internal timer converted to BCD for display
0362+  0000             STAGE_DEFORM_INDEX					= $638d	; Keeps track of the next stage data to display when Donkey Kong completes a jump in the introduction stage and causes the platforms to deform
0363+  0000             LADDER_ROW_TO_ERASE					= $638e	; The ladder row to erase as the ladder is being pulled up on the introduction stage
0364+  0000             ANIMATION_TIMER						= $6390	; Manages the animation state for Donkey Kong and Pauline
0365+  0000             TIME_FOR_DK_ACTION					= $6391	; Indicates that a Donkey Kong action is being animated
0366+  0000             
0367+  0000             DK_STOMPING							= $6393	; Donkey Kong starts stomping when this is 1
0368+  0000             HAMMER_CYCLE_COUNTER				= $6394	; Counter that controls the cycle of raising and lowering the hammer cycle when Mario has the hammer
0369+  0000             HAMMER_CYCLE_WRAP_COUNTER			= $6395	; Keeps track of the number of times the hammer cycle counter wraps back around to 0 - the hammer is released after 2 wraps
0370+  0000             RELEASE_SPRING						= $6396
0371+  0000             
0372+  0000             MARIO_ON_ELEVATOR					= $6398	; 1 if Mario is riding up or down an elevator platform
0373+  0000             
0374+  0000             DEATH_ANIMATION_STATE				= $639d
0375+  0000             DEATH_ANIMATION_COUNTER				= $639e
0376+  0000             
0377+  0000             RELEASE_A_FIREBALL					= $63a0	; A fireball is released when this equals 1
0378+  0000             ACTIVE_FIREBALL_COUNT				= $63a1 ; The number of fireballs active on the current level
0379+  0000             UPDATED_FIREBALL_COUNT				= $63a2	; The number of fireballs that have been updated (counts up to 5)
0380+  0000             TOP_CONVEYER_DIR					= $63a3	; The direction that the top conveyer belt on the mixer level is moving
0381+  0000             LEFT_CONVEYER_DIR					= $63a4
0382+  0000             RIGHT_CONVEYER_DIR					= $63a5
0383+  0000             BOT_CONVEYER_DIR					= $63a6
0384+  0000             
0385+  0000             INTERM_HEIGHT_STRING_INDEX			= $63a7	; Index to the string representing the current height in the height string table for the intermission screen
0386+  0000             INTERM_HEIGHT_STRING_COORD			= $63a8	; (2 bytes) The coordinate that the current height string should be displayed at on the intermission screen
0387+  0000             
0388+  0000             STAGE_DATA_START_ADDRESS			= $63ab	; The tile memory address where the first tile in a tile line is to be drawn
0389+  0000             STAGE_DATA_END_ADDRESS				= $63ad	; The tile memory address where the last tile in a tile line is to be drawn
0390+  0000             STAGE_DATA_FIRST_Y_OFFSET			= $63af
0391+  0000             STAGE_DATA_LAST_Y_OFFSET			= $63b0
0392+  0000             STAGE_DATA_X_DIFF					= $63b1
0393+  0000             STAGE_DATA_Y_DIFF					= $63b2
0394+  0000             STAGE_DATA_TILE_ID					= $63b3
0395+  0000             STAGE_DATA_UNKNOWN					= $63b4
0396+  0000             STAGE_DATA_CURRENT_TILE				= $63b5
0397+  0000             
0398+  0000             DK_DISTANCE_TO_LADDER				= $63b7 ; The distance between Donkey Kongs head? and the ladder on the mixer level
0399+  0000             TIMER_HAS_RUN_DOWN					= $63b8	; Set to 1 to distinguish between the onscreen timer being zero because it needs to be initialized and being zero because it has legitimately run down
0400+  0000             NUM_ENEMIES_OF_CURRENT_CLASS		= $63b9	; The number of enemies in the enemy class that was struck by the hammer (used to identify which enemy data structure was struck)
0401+  0000             
0402+  0000             CURRENT_STATE_VAR_POINTER			= $63c0	; Points to the variable that controls the current game state
0403+  0000             
0404+  0000             LADDER_JUMP_VECTOR_POINTER			= $63c2	; Points to the current vector data for Donkey Kong's jump from the ladder to the platform on the introduction stage
0405+  0000             PLATFORM_JUMP_VECTOR_POINTER		= $63c4	; Points to the current vector data for Donkey Kong's jumps across the platform on the introduction stage
0406+  0000             
0407+  0000             CURRENT_FIREBALL					= $63c8	; Points to the fireball currently being processed (2 bytes)
0408+  0000             
0409+  0000             DEMO_INPUT_INDEX					= $63cc
0410+  0000             DEMO_INPUT_REPEAT					= $63cd
0411+  0000             
0412+  0000             FIREBALL_STRUCTS					= $6400
0413+  0000             	; This is the start of a series of 5 32-byte data structures representing 
0414+  0000             	; the state of the active fire balls on a stage
0415+  0000             	; The structure layout is as follows:
0416+  0000             	;
0417+  0000             	;  0 - Fire ball active (0 or 1)?
0418+  0000             	;
0419+  0000             	;  3 - x coordinate of the fire ball
0420+  0000             	;  
0421+  0000             	;  5 - y coordinate of the fire ball
0422+  0000             	;
0423+  0000             	;  7 - The sprite number of the fire ball sprite
0424+  0000             	;  8 - The sprite palette 
0425+  0000             	;
0426+  0000             	; 13 - The fireball direction
0427+  0000             	;		0 - standing still
0428+  0000             	;		1 - moving right
0429+  0000             	;		2 - moving left
0430+  0000             	;		4 - moving down
0431+  0000             	;		8 - moving up
0432+  0000             	; 14 - The next intended x coordinate
0433+  0000             	; 15 - The next intended y coordinate
0434+  0000             	;
0435+  0000             	; 19 - The bob table index - controls how the fireball seems to bob as it moves
0436+  0000             	; 20 - The climb update counter - the fireball is moved up or down the current ladder when this reaches 0
0437+  0000             	; 21 - The sprite update counter - the sprite image is updated when this reaches 0
0438+  0000             	; 22 - The direction counter - the fireball continues in the current diection (left or right) until this reaches 0 - it may still go up and down ladders, however
0439+  0000             	;
0440+  0000             	; 24 - Not initialized - the fireball has not been initialized yet if this is 1
0441+  0000             	; 25 - Pause mode - the fireball pauses for a while when this equals 2
0442+  0000             	; 26,27 - The oil barrel jump pointer - pointer to the entry in a table of y coodinates for the fireball as it initially jumps out of the oil barrel on the barrels stage
0443+  0000             	; 28 - Pause timer - the fireball stops being paused when this reaches 0
0444+  0000             	; 29 - Pause mode (2) - the fireball is paused when this equals 1
0445+  0000             	;
0446+  0000             	; 31 - The y coordinate of the other end of the ladder currently being climbed
0447+  0000             FIREBALL_STRUCT_1					= $6400
0448+  0000             FIREBALL_STRUCT_2					= $6420
0449+  0000             FIREBALL_STRUCT_3					= $6440
0450+  0000             FIREBALL_STRUCT_4					= $6460
0451+  0000             FIREBALL_STRUCT_5					= $6480
0452+  0000             
0453+  0000             COLLISION_AREA_STRUCT				= $64a0
0454+  0000             	; This is the start of 2 32-byte data structures representing 
0455+  0000             	; invisible collision detection sprites
0456+  0000             	;
0457+  0000             	;  0 - Sprite active (0 or 1)?
0458+  0000             	;
0459+  0000             	;  3 - x coordinate of the sprite
0460+  0000             	;  
0461+  0000             	;  5 - y coordinate of the sprite
0462+  0000             	;
0463+  0000             	;  7 - The sprite number of the sprite
0464+  0000             	;  8 - The sprite palette 
0465+  0000             	
0466+  0000             SPRING_STRUCTS						= $6500
0467+  0000             	; This is the start of a series of 10 16-byte data structures representing 
0468+  0000             	; the state of the active springs on the elevators stage
0469+  0000             	; The structure layout is as follows:
0470+  0000             	;
0471+  0000             	;  0 - Spring active (0 or 1)?
0472+  0000             	;
0473+  0000             	;  3 - x coordinate of the spring?
0474+  0000             	;  
0475+  0000             	;  5 - y coordinate of the spring
0476+  0000             	;
0477+  0000             	;  7 - The sprite number of the spring sprite
0478+  0000             	;  8 - The sprite palette 
0479+  0000             	; 
0480+  0000             	; 13 - The spring state
0481+  0000             	;	1 = bouncing
0482+  0000             	;	4 = falling
0483+  0000             	; 14 - The most significant byte of the address of the next bounce vector
0484+  0000             	; 15 - The least significant byte of the address of the next bounce vector
0485+  0000             
0486+  0000             PIE_STRUCTS							= $65A0
0487+  0000             	; This is the start of a series of 6 16-byte data structures representing 
0488+  0000             	; the state of the pies on the mixer stage
0489+  0000             	; The structure layout is as follows:
0490+  0000             	;
0491+  0000             	;  0 - pie active (0 or 1)
0492+  0000             	; 
0493+  0000             	;  3 - x coordinate of the pie
0494+  0000             	;  
0495+  0000             	;  5 - y coordinate of the pie
0496+  0000             	;
0497+  0000             	;  7 - The sprite number of the pie sprite
0498+  0000             	;  8 - The sprite palette 
0499+  0000             	;
0500+  0000             	
0501+  0000             ELEVATOR_STRUCTS					= $6600
0502+  0000             	; This is the start of a series of 6 16-byte data structures representing 
0503+  0000             	; the state of the elevator platforms on a stage
0504+  0000             	; The structure layout is as follows:
0505+  0000             	;
0506+  0000             	;  0 - elevator active (0 or 1)
0507+  0000             	; 
0508+  0000             	;  3 - x coordinate of the elevator
0509+  0000             	;  
0510+  0000             	;  5 - y coordinate of the elevator
0511+  0000             	;
0512+  0000             	;  7 - The sprite number of the elevator sprite
0513+  0000             	;  8 - The sprite palette 
0514+  0000             	;  9 - The radial width of the elevator's collision boundary
0515+  0000             	; 10 - The radial height of the elevator's collision boundary
0516+  0000             	;
0517+  0000             	; 12 - The move counter of the elevators on the secret stage
0518+  0000             	; 13 - The direction (8 if the elevator is moving up, 4 if it is moving down)
0519+  0000             	;      The direction of rotation on the secret stage
0520+  0000             	;	      (0 = clockwise, 1 = counter-clockwise)
0521+  0000             	; 14 - The current quadrant of movement for the secret stage
0522+  0000             	;         1 | 2
0523+  0000             	;	      --+--
0524+  0000             	;	      0 | 3
0525+  0000             ELEVATOR_STRUCT_1					= $6600
0526+  0000             ELEVATOR_STRUCT_2					= $6610
0527+  0000             ELEVATOR_STRUCT_3					= $6620
0528+  0000             ELEVATOR_STRUCT_4					= $6630
0529+  0000             ELEVATOR_STRUCT_5					= $6640
0530+  0000             ELEVATOR_STRUCT_6					= $6650
0531+  0000             
0532+  0000             HAMMER_STRUCTS						= $6680
0533+  0000             	; This is the start of a series of 2 16-byte data structures representing 
0534+  0000             	; the state of the hammers on a stage
0535+  0000             	; The structure layout is as follows:
0536+  0000             	;
0537+  0000             	;  0 - hammer active (0 or 1)
0538+  0000             	;  1 - Mario has hammer (0 or 1) 
0539+  0000             	; 
0540+  0000             	;  3 - x coordinate of the hammer
0541+  0000             	;  
0542+  0000             	;  5 - y coordinate of the hammer
0543+  0000             	;
0544+  0000             	;  7 - The sprite number of the hammer sprite
0545+  0000             	;  8 - The sprite palette 
0546+  0000             	;  9 - Collision boundary x radius (distance from the center of the sprite)
0547+  0000             	; 10 - Collision boundary y radius (distance from the center of the sprite)
0548+  0000             	;
0549+  0000             	; 14 - X coordinate offset from Mario (-16 = to Mario's left, 16 = to Mario's right, 0 = above Mario)
0550+  0000             	; 15 - Y coordinate offset from Mario (-16 = above Mario, 0 = to Mario's left or right)
0551+  0000             	; 
0552+  0000             HAMMER_STRUCT_1						= $6680	
0553+  0000             HAMMER_STRUCT_2						= $6690
0554+  0000             BARREL_FIRE_STRUCT					= $66a0
0555+  0000             	; This is a 32-byte data structure representing the state of the barrel fire
0556+  0000             	; on the barrels and mixer stages
0557+  0000             	; The structure layout is as follows:
0558+  0000             	;
0559+  0000             	;  0 - Barrel fire active (0 or 1)?
0560+  0000             	;
0561+  0000             	;  3 - Barrel fire sprite x coordinate
0562+  0000             	;
0563+  0000             	;  5 - Barrel fire sprite y coordinate
0564+  0000             	;
0565+  0000             	;  7 - Barrel fire sprite number
0566+  0000             	;  8 - Barrel fire sprite palette
0567+  0000             
0568+  0000             BARREL_STRUCTS						= $6700
0569+  0000             	; This is the start of 10 32-byte data structures 
0570+  0000             	; representing the state of the barrels on the barrels stage
0571+  0000             	; The structure layout is as follows:
0572+  0000             	;
0573+  0000             	;  0 - Barrel active (0 or 1)?
0574+  0000             	;
0575+  0000             	;  3 - Barrel sprite x coordinate
0576+  0000             	;
0577+  0000             	;  5 - Barrel sprite y coordinate
0578+  0000             	;
0579+  0000             	;  7 - Barrel sprite number
0580+  0000             	;  8 - Barrel sprite palette
0581+  0000             	;
0582+  0000             	; 21 - Barrel type (0 = normal barrel, 1 = oil barrel)
0583+  0000             
0584+  0000             SPRITE_STRUCTS						= $6900
0585+  0000             	; This is the start of a series of ??? 4-byte data structures for the 
0586+  0000             	; active sprites in the game.
0587+  0000             	; The Sprite data structures continue to $6a7f
0588+  0000             	; The structure layout is as follows:
0589+  0000             	;
0590+  0000             	;  0 - The x coordinate of the sprite
0591+  0000             	;  1 - The sprite graphic number
0592+  0000             	;      If bit 1 of this byte is 1 then the graphic is flipped horizontally
0593+  0000             	;  2 - The palette to use for the sprite
0594+  0000             	;      If bit 1 of this byte is 1 then the graphic is flipped vertically
0595+  0000             	;  3 - The y coordinate of the sprite
0596+  0000             
0597+  0000             PAULINE_SPRITES						= $6900
0598+  0000             	; The 2 sprites that make up PAULINE
0599+  0000             PAULINE_UPPER_SPRITE_X				= $6900
0600+  0000             PAULINE_UPPER_SPRITE_NUM			= $6901
0601+  0000             PAULINE_UPPER_SPRITE_PAL			= $6902
0602+  0000             PAULINE_UPPER_SPRITE_Y				= $6903
0603+  0000             PAULINE_LOWER_SPRITE_X				= $6904
0604+  0000             PAULINE_LOWER_SPRITE_NUM			= $6905
0605+  0000             PAULINE_LOWER_SPRITE_PAL			= $6906
0606+  0000             PAULINE_LOWER_SPRITE_Y				= $6907
0607+  0000             
0608+  0000             DK_SPRITES							= $6908
0609+  0000             	; This marks the start of the 10 sprites that 
0610+  0000             	; make up Donkey Kong.  The last sprite ends at
0611+  0000             	; $6929.
0612+  0000             DK_SPRITE_1_X						= $6908
0613+  0000             DK_SPRITE_1_NUM						= $6909
0614+  0000             DK_SPRITE_1_PAL						= $690a
0615+  0000             DK_SPRITE_1_Y						= $690b
0616+  0000             DK_SPRITE_2_X						= $690c
0617+  0000             DK_SPRITE_2_NUM						= $690d
0618+  0000             DK_SPRITE_2_PAL						= $690e
0619+  0000             DK_SPRITE_2_Y						= $690f
0620+  0000             DK_SPRITE_3_X						= $6910
0621+  0000             DK_SPRITE_3_NUM						= $6911
0622+  0000             DK_SPRITE_3_PAL						= $6912
0623+  0000             DK_SPRITE_3_Y						= $6913
0624+  0000             DK_SPRITE_4_X						= $6914
0625+  0000             DK_SPRITE_4_NUM						= $6915
0626+  0000             DK_SPRITE_4_PAL						= $6916
0627+  0000             DK_SPRITE_4_Y						= $6917
0628+  0000             DK_SPRITE_5_X						= $6918
0629+  0000             DK_SPRITE_5_NUM						= $6919
0630+  0000             DK_SPRITE_5_PAL						= $691a
0631+  0000             DK_SPRITE_5_Y						= $691b
0632+  0000             DK_SPRITE_6_X						= $691c
0633+  0000             DK_SPRITE_6_NUM						= $691d
0634+  0000             DK_SPRITE_6_PAL						= $691e
0635+  0000             DK_SPRITE_6_Y						= $691f
0636+  0000             DK_SPRITE_7_X						= $6920
0637+  0000             DK_SPRITE_7_NUM						= $6921
0638+  0000             DK_SPRITE_7_PAL						= $6922
0639+  0000             DK_SPRITE_7_Y						= $6923
0640+  0000             DK_SPRITE_8_X						= $6924
0641+  0000             DK_SPRITE_8_NUM						= $6925
0642+  0000             DK_SPRITE_8_PAL						= $6926
0643+  0000             DK_SPRITE_8_Y						= $6927
0644+  0000             DK_SPRITE_9_X						= $6928
0645+  0000             DK_SPRITE_9_NUM						= $6929
0646+  0000             DK_SPRITE_9_PAL						= $692a
0647+  0000             DK_SPRITE_9_Y						= $692b
0648+  0000             DK_SPRITE_10_X						= $692c
0649+  0000             DK_SPRITE_10_NUM					= $692d
0650+  0000             DK_SPRITE_10_PAL					= $692e
0651+  0000             DK_SPRITE_10_Y						= $692f
0652+  0000             ; Start of the two retractable ladder sprites on the mixer level
0653+  0000             RETRACTABLE_LADDER_SPRITES			= $6944
0654+  0000             L_RETRACT_LADDER_SPRITE				= $6944
0655+  0000             L_RETRACT_LADDER_SPRITE_X			= $6944
0656+  0000             L_RETRACT_LADDER_SPRITE_NUM			= $6945
0657+  0000             L_RETRACT_LADDER_SPRITE_PAL			= $6946
0658+  0000             L_RETRACT_LADDER_SPRITE_Y			= $6947
0659+  0000             R_RETRACT_LADDER_SPRITE				= $6948
0660+  0000             R_RETRACT_LADDER_SPRITE_X			= $6948
0661+  0000             R_RETRACT_LADDER_SPRITE_NUM			= $6949
0662+  0000             R_RETRACT_LADDER_SPRITE_PAL			= $694a
0663+  0000             R_RETRACT_LADDER_SPRITE_Y			= $694b
0664+  0000             ; Start of Mario's sprite
0665+  0000             MARIO_SPRITE						= $694c
0666+  0000             MARIO_SPRITE_X						= $694c
0667+  0000             MARIO_SPRITE_NUM					= $694d
0668+  0000             MARIO_SPRITE_PAL					= $694e
0669+  0000             MARIO_SPRITE_Y						= $694f
0670+  0000             ; Sprite data for two invisible collision detection sprites
0671+  0000             COLLISION_AREA_SPRITES				= $6950
0672+  0000             COLLISION_AREA_SPRITE_1				= $6950
0673+  0000             COLLISION_AREA_SPRITE_2				= $6954
0674+  0000             ; Sprite data for the elevator platforms on the elevators stage
0675+  0000             ; 6 sprites
0676+  0000             ELEVATOR_PLATFORM_SPRITES			= $6958
0677+  0000             ELEVATOR_PLATFORM_SPRITE_1			= $6958
0678+  0000             ELEVATOR_PLATFORM_SPRITE_2			= $695c
0679+  0000             ELEVATOR_PLATFORM_SPRITE_3			= $6960
0680+  0000             ELEVATOR_PLATFORM_SPRITE_4			= $6964
0681+  0000             ELEVATOR_PLATFORM_SPRITE_5			= $6968
0682+  0000             ELEVATOR_PLATFORM_SPRITE_6			= $696c
0683+  0000             ; Sprite data for the 4 evelator motors on the elevators stage
0684+  0000             ; 16 bytes
0685+  0000             ELEVATOR_MOTOR_SPRITE_DATA			= $6970
0686+  0000             ELEVATOR_MOTOR_SPRITE_1				= $6970
0687+  0000             ELEVATOR_MOTOR_SPRITE_1_X			= $6970
0688+  0000             ELEVATOR_MOTOR_SPRITE_1_NUM			= $6971
0689+  0000             ELEVATOR_MOTOR_SPRITE_1_PAL			= $6972
0690+  0000             ELEVATOR_MOTOR_SPRITE_1_Y			= $6973
0691+  0000             ELEVATOR_MOTOR_SPRITE_2				= $6974
0692+  0000             ELEVATOR_MOTOR_SPRITE_2_X			= $6974
0693+  0000             ELEVATOR_MOTOR_SPRITE_2_NUM			= $6975
0694+  0000             ELEVATOR_MOTOR_SPRITE_2_PAL			= $6976
0695+  0000             ELEVATOR_MOTOR_SPRITE_2_Y			= $6977
0696+  0000             ELEVATOR_MOTOR_SPRITE_3				= $6978
0697+  0000             ELEVATOR_MOTOR_SPRITE_3_X			= $6978
0698+  0000             ELEVATOR_MOTOR_SPRITE_3_NUM			= $6979
0699+  0000             ELEVATOR_MOTOR_SPRITE_3_PAL			= $697a
0700+  0000             ELEVATOR_MOTOR_SPRITE_3_Y			= $697b
0701+  0000             ELEVATOR_MOTOR_SPRITE_4				= $697c
0702+  0000             ELEVATOR_MOTOR_SPRITE_4_X			= $697c
0703+  0000             ELEVATOR_MOTOR_SPRITE_4_NUM			= $697d
0704+  0000             ELEVATOR_MOTOR_SPRITE_4_PAL			= $697e
0705+  0000             ELEVATOR_MOTOR_SPRITE_4_Y			= $697f
0706+  0000             ; Start of the 10 spring sprites
0707+  0000             SPRING_SPRITES						= $6980		; This is the start of the spring sprite data
0708+  0000             SPRING_SPRITE_1						= $6980		
0709+  0000             SPRING_SPRITE_2						= $6984		
0710+  0000             SPRING_SPRITE_3						= $6988		
0711+  0000             SPRING_SPRITE_4						= $698c		
0712+  0000             SPRING_SPRITE_5						= $6990		
0713+  0000             SPRING_SPRITE_6						= $6994		
0714+  0000             SPRING_SPRITE_7						= $6998		
0715+  0000             SPRING_SPRITE_8						= $699c		
0716+  0000             SPRING_SPRITE_9						= $69a0		
0717+  0000             SPRING_SPRITE_10					= $69a4
0718+  0000             ; Sprite data for the four standing barrels on the barrels stage
0719+  0000             STANDING_BARREL_SPRITE_DATA			= $69a8
0720+  0000             STANDING_BARREL_SPRITE_1			= $69a8
0721+  0000             STANDING_BARREL_SPRITE_1_X			= $69a8
0722+  0000             STANDING_BARREL_SPRITE_1_NUM		= $69a9
0723+  0000             STANDING_BARREL_SPRITE_1_PAL		= $69aa
0724+  0000             STANDING_BARREL_SPRITE_1_Y			= $69ab
0725+  0000             STANDING_BARREL_SPRITE_2			= $69ac
0726+  0000             STANDING_BARREL_SPRITE_2_X			= $69ac
0727+  0000             STANDING_BARREL_SPRITE_2_NUM		= $69ad
0728+  0000             STANDING_BARREL_SPRITE_2_PAL		= $69ae
0729+  0000             STANDING_BARREL_SPRITE_2_Y			= $69af
0730+  0000             STANDING_BARREL_SPRITE_3			= $69b0
0731+  0000             STANDING_BARREL_SPRITE_3_X			= $69b0
0732+  0000             STANDING_BARREL_SPRITE_3_NUM		= $69b1
0733+  0000             STANDING_BARREL_SPRITE_3_PAL		= $69b2
0734+  0000             STANDING_BARREL_SPRITE_3_Y			= $69b3
0735+  0000             STANDING_BARREL_SPRITE_4			= $69b4
0736+  0000             STANDING_BARREL_SPRITE_4_X			= $69b4
0737+  0000             STANDING_BARREL_SPRITE_4_NUM		= $69b5
0738+  0000             STANDING_BARREL_SPRITE_4_PAL		= $69b6
0739+  0000             STANDING_BARREL_SPRITE_4_Y			= $69b7
0740+  0000             ; Pie sprites (6 sprites in all)
0741+  0000             PIE_SPRITES							= $69b8
0742+  0000             PIE_SPRITE_1						= $69b8
0743+  0000             PIE_SPRITE_2						= $69bc
0744+  0000             PIE_SPRITE_3						= $69c0
0745+  0000             PIE_SPRITE_4						= $69c4
0746+  0000             PIE_SPRITE_5						= $69c8
0747+  0000             PIE_SPRITE_6						= $69cc
0748+  0000             ; Fireball sprites (5 sprites in all)
0749+  0000             FIREBALL_SPRITES					= $69d0
0750+  0000             FIREBALL_SPRITE_1					= $69d0
0751+  0000             FIREBALL_SPRITE_2					= $69d4
0752+  0000             FIREBALL_SPRITE_3					= $69d8
0753+  0000             FIREBALL_SPRITE_4					= $69dc
0754+  0000             FIREBALL_SPRITE_5					= $69e0
0755+  0000             ; Conveyer belt motor sprites (6 sprites)
0756+  0000             CONVEYER_MOTOR_SPRITES				= $69e4
0757+  0000             ; Top left conveyer motor
0758+  0000             CONV_MOTOR_SPRITE_TL				= $69e4
0759+  0000             CONV_MOTOR_SPRITE_TL_X				= $69e4
0760+  0000             CONV_MOTOR_SPRITE_TL_NUM			= $69e5
0761+  0000             CONV_MOTOR_SPRITE_TL_PAL			= $69e6
0762+  0000             CONV_MOTOR_SPRITE_TL_Y				= $69e7
0763+  0000             ; Top right conveyer motor
0764+  0000             CONV_MOTOR_SPRITE_TR				= $69e8
0765+  0000             CONV_MOTOR_SPRITE_TR_X				= $69e8
0766+  0000             CONV_MOTOR_SPRITE_TR_NUM			= $69e9
0767+  0000             CONV_MOTOR_SPRITE_TR_PAL			= $69ea
0768+  0000             CONV_MOTOR_SPRITE_TR_Y				= $69eb
0769+  0000             ; Middle right conveyer motor
0770+  0000             CONV_MOTOR_SPRITE_MR				= $69ec
0771+  0000             CONV_MOTOR_SPRITE_MR_X				= $69ec
0772+  0000             CONV_MOTOR_SPRITE_MR_NUM			= $69ed
0773+  0000             CONV_MOTOR_SPRITE_MR_PAL			= $69ee
0774+  0000             CONV_MOTOR_SPRITE_MR_Y				= $69ef
0775+  0000             ; Middle left conveyer motor
0776+  0000             CONV_MOTOR_SPRITE_ML				= $69f0
0777+  0000             CONV_MOTOR_SPRITE_ML_X				= $69f0
0778+  0000             CONV_MOTOR_SPRITE_ML_NUM			= $69f1
0779+  0000             CONV_MOTOR_SPRITE_ML_PAL			= $69f2
0780+  0000             CONV_MOTOR_SPRITE_ML_Y				= $69f3
0781+  0000             ; Bottom left conveyer motor
0782+  0000             CONV_MOTOR_SPRITE_BL				= $69f4
0783+  0000             CONV_MOTOR_SPRITE_BL_X				= $69f4
0784+  0000             CONV_MOTOR_SPRITE_BL_NUM			= $69f5
0785+  0000             CONV_MOTOR_SPRITE_BL_PAL			= $69f6
0786+  0000             CONV_MOTOR_SPRITE_BL_Y				= $69f7
0787+  0000             ; Bottom right conveyer motor
0788+  0000             CONV_MOTOR_SPRITE_BR				= $69f8
0789+  0000             CONV_MOTOR_SPRITE_BR_X				= $69f8
0790+  0000             CONV_MOTOR_SPRITE_BR_NUM			= $69f9
0791+  0000             CONV_MOTOR_SPRITE_BR_PAL			= $69fa
0792+  0000             CONV_MOTOR_SPRITE_BR_Y				= $69fb
0793+  0000             ; The oil barrel sprite
0794+  0000             OIL_BARREL_SPRITE					= $69fc
0795+  0000             OIL_BARREL_SPRITE_X					= $69fc
0796+  0000             OIL_BARREL_SPRITE_NUM				= $69fd
0797+  0000             OIL_BARREL_SPRITE_PAL				= $69fe
0798+  0000             OIL_BARREL_SPRITE_Y					= $69ff
0799+  0000             
0800+  0000             ; Prize sprites (3 sprites)
0801+  0000             PRIZE_SPRITES						= $6a0c
0802+  0000             PRIZE_SPRITE_1						= $6a0c
0803+  0000             PRIZE_SPRITE_2						= $6a10
0804+  0000             PRIZE_SPRITE_3						= $6a14
0805+  0000             ; The start of the two hammer sprites on a level
0806+  0000             HAMMER_SPRITES						= $6a18
0807+  0000             HAMMER_SPRITE_1						= $6a18
0808+  0000             HAMMER_SPRITE_2						= $6a1c
0809+  0000             
0810+  0000             HEART_SPRITE						= $6a20
0811+  0000             HEART_SPRITE_X						= $6a20
0812+  0000             HEART_SPRITE_NUM					= $6a21
0813+  0000             HEART_SPRITE_PAL					= $6a22
0814+  0000             HEART_SPRITE_Y						= $6a23
0815+  0000             DK_STARS_SPRITE						= $6a24
0816+  0000             DK_STARS_SPRITE_X					= $6a24
0817+  0000             DK_STARS_SPRITE_NUM					= $6a25
0818+  0000             DK_STARS_SPRITE_PAL					= $6a26
0819+  0000             DK_STARS_SPRITE_Y					= $6a27
0820+  0000             BARREL_FIRE_SPRITE					= $6a28	; The oil barrel fire sprite
0821+  0000             BARREL_FIRE_SPRITE_X				= $6a28			
0822+  0000             BARREL_FIRE_SPRITE_NUM				= $6a29
0823+  0000             BARREL_FIRE_SPRITE_PAL				= $6a2a
0824+  0000             BARREL_FIRE_SPRITE_Y				= $6a2b
0825+  0000             SMASH_SPRITE						= $6a2c	; The smash animation sprite (displayed when Mario hits an enemy with the hammer)
0826+  0000             SMASH_SPRITE_X						= $6a2c
0827+  0000             SMASH_SPRITE_NUM					= $6a2d
0828+  0000             SMASH_SPRITE_PAL					= $6a2e
0829+  0000             SMASH_SPRITE_Y						= $6a2f
0830+  0000             AWARD_SPRITE						= $6a30
0831+  0000             AWARD_SPRITE_X						= $6a30
0832+  0000             AWARD_SPRITE_NUM					= $6a31
0833+  0000             AWARD_SPRITE_PAL					= $6a32
0834+  0000             AWARD_SPRITE_Y						= $6a33
0835+  0000             	
0836+  0000             P1_INPUT							= $7c00
0837+  0000             P1_INPUT_RESET_BIT						= 6		; Reset game?
0838+  0000             P1_INPUT_JUMP_BIT						= 5		; Jump button
0839+  0000             P1_INPUT_DOWN_BIT						= 3
0840+  0000             P1_INPUT_UP_BIT							= 2
0841+  0000             P1_INPUT_LEFT_BIT						= 1
0842+  0000             P1_INPUT_RIGHT_BIT						= 0
0843+  0000             
0844+  0000             SONG_OUTPUT							= $7c00
0845+  0000             
0846+  0000             P2_INPUT							= $7c80
0847+  0000             P2_INPUT_RESET_BIT						= 6		; Reset game?
0848+  0000             P2_INPUT_JUMP_BIT						= 5		; Jump button
0849+  0000             P2_INPUT_DOWN_BIT						= 3
0850+  0000             P2_INPUT_UP_BIT							= 2
0851+  0000             P2_INPUT_LEFT_BIT						= 1
0852+  0000             P2_INPUT_RIGHT_BIT						= 0
0853+  0000             
0854+  0000             MISC_INPUT							= $7d00
0855+  0000             MISC_INPUT_COIN_BIT						= 7		; Coin entered
0856+  0000             MISC_INPUT_START_2P_BIT					= 3		; 2 player start
0857+  0000             MISC_INPUT_START_1P_BIT					= 2		; 1 player start
0858+  0000             MISC_INPUT_TAMPER_BIT					= 0		; If this is 1, the code jumps to l4000
0859+  0000             
0860+  0000             WALK_SOUND_OUTPUT					= $7d00		; Causes the walking sound to play
0861+  0000             JUMP_SOUND_OUTPUT					= $7d01		; Causes the jumping sound to play
0862+  0000             STOMP_SOUND_OUTPUT					= $7d02		; Causes the Donkey Kong stomping sound to play
0863+  0000             SPRING_SOUND_OUTPUT					= $7d03		; Causes the spring bounce sound to play
0864+  0000             FALL_SOUND_OUTPUT					= $7d04		; Causes the falling spring sound to play
0865+  0000             
0866+  0000             TIME_RUNNING_OUT_SOUND_OUTPUT		= $7d09		; Causes the time running out sound to play
0867+  0000             
0868+  0000             DIP_INPUT							= $7d80
0869+  0000             	; Bit 7 Cocktail (0) or Upright (1)
0870+  0000             	; Bit 6 \ 000 = 1 coin/1 play  001 = 1 coin/2 play  010 = 1 coin/3 play
0871+  0000             	; Bit 5 | 011 = 1 coin/4 play  100 = 2 coin/1 play  101 = 3 coin/1 play
0872+  0000             	; Bit 4 / 110 = 4 coin/1 play  111 = 5 coin/1 play
0873+  0000             	; Bit 3 \ Bonus at
0874+  0000             	; Bit 2 / 00 = 7000  01 = 10000  10 = 15000  11 = 20000
0875+  0000             	; Bit 1 \ 00 = 3 lives  01 = 4 lives
0876+  0000             	; Bit 0 / 10 = 5 lives  11 = 6 lives
0877+  0000             
0878+  0000             DEATH_SOUND_OUTPUT					= $7d80
0879+  0000             
0880+  0000             SCREEN_ORIENTATION					= $7d82
0881+  0000             	; 0 = flipped
0882+  0000             	; 1 = standard
0883+  0000             
0884+  0000             INTERRUPT_ENABLE            		= $7d84
0885+  0000             
0886+  0000             PALETTE_1_OUTPUT					= $7d86
0887+  0000             PALETTE_2_OUTPUT					= $7d87
0888+  0000             
0005   0000             
0006   0000             		.org	$00
0007   0000             		
0008   0000             ;------------------------------------------------------------------------------
0009   0000             ; Program entry point
0010   0000 3E 00       L_ORG:  ld      a,0                       ; Disable interrupts
0011   0002 32 84 7D            ld      (INTERRUPT_ENABLE),a        ; ''
0012   0005 C3 66 02            jp      L_INIT_GAME                       ; Initialize the game
0013   0008             ;------------------------------------------------------------------------------
0014   0008             
0015   0008             
0016   0008             
0017   0008             ;------------------------------------------------------------------------------
0018   0008             ; Check if demo mode is active (no coins have been inserted).  
0019   0008             ; If it is, abort the calling function        
0020   0008             ; Note: This code MUST start at address 0008h.
0021   0008             		.org	$08
0022   0008 3A 07 60    l0008:  ld      a,(NO_COINS_INSERTED)
0023   000B 0F                  rrca    
0024   000C D0                  ret     nc							; Return if NO_COINS_INSERTED == 0
0025   000D 33                  inc     sp		
0026   000E 33                  inc     sp							; Return from calling function otherwise
0027   000F C9                  ret     						
0028   0010             ;------------------------------------------------------------------------------
0029   0010             
0030   0010             
0031   0010             		
0032   0010             ;------------------------------------------------------------------------------
0033   0010             ; Check if Mario is dead.  If he is, abort the calling function
0034   0010             ; NOTE: This code MUST start at address 0010h.
0035   0010             		.org	$10
0036   0010 3A 00 62    l0010:  ld      a,(MARIO_ALIVE)
0037   0013 0F                  rrca    							; Return if MARIO_ALIVE == 1
0038   0014 D8                  ret     c
0039   0015 E1                  pop		hl							; Return from calling function otherwise
0040   0016 C9                  ret     
0041   0017             ;------------------------------------------------------------------------------
0042   0017             
0043   0017             
0044   0017             
0045   0017             ;------------------------------------------------------------------------------
0046   0017             ; Decrement the minor timer.  If it has not reached 0, abort the calling function
0047   0018             		.org $18
0048   0018 21 09 60    l0018:  ld      hl,MINOR_TIMER				; -- MINOR_TIMER
0049   001B 35                  dec     (hl)
0050   001C C8                  ret     z							; Return if MINOR_TIMER has reached 0
0051   001D E1                  pop		hl							; Return from the calling function otherwise
0052   001E C9                  ret     
0053   001F             ;------------------------------------------------------------------------------
0054   001F             
0055   001F             
0056   001F             
0057   001F             ;------------------------------------------------------------------------------
0058   001F             ; Decrement the major timer.  If it has not reached 0, abort the calling function
0059   001F             ; If it has reached 0, decrement MINOR_TIMER and return from the calling function 
0060   001F             ; if it has not reached 0.
0061   001F             ; NOTE: This function MUST start at address $0020
0062   0020             		.org	$20
0063   0020 21 08 60            ld      hl,MAJOR_TIMER
0064   0023 35                  dec     (hl)						; --MAJOR_TIMER
0065   0024 28 F2               jr      z,l0018
0066   0026 E1          l0026:  pop     hl
0067   0027 C9                  ret     
0068   0028             ;------------------------------------------------------------------------------
0069   0028             
0070   0028             
0071   0028             
0072   0028             ;------------------------------------------------------------------------------
0073   0028             ; Retrieve an address in a jump table immediately following the instruction
0074   0028             ; that called this function and jump to the address.
0075   0028             ; NOTE: This function MUST start at address 0028h.
0076   0028             ;
0077   0028             ; passed: a - the table index to jump to 
0078   0028                     .org    $28
0079   0028 87                  add     a,a							; A *= 2
0080   0029 E1                  pop     hl							; HL = the address of the instruction that called this function
0081   002A 5F                  ld      e,a							
0082   002B 16 00               ld      d,$00						; DE = table index offset
0083   002D C3 32 00            jp      l0032						; Skip the next instruction
0084   0030             		
0085   0030             ; The following instruction is not part of the previous function
0086   0030             ; NOTE: This instruction MUST be at address $0030		
0087   0030             		.org	$30
0088   0030 18 12               jr      l0044
0089   0032             		
0090   0032 19          l0032:  add     hl,de						; HL = address of table entry
0091   0033 5E                  ld      e,(hl)						
0092   0034 23                  inc     hl
0093   0035 56                  ld      d,(hl)
0094   0036 EB                  ex      de,hl						; HL = entry in table
0095   0037 E9                  jp      (hl)						; Jump to the address
0096   0038             ;------------------------------------------------------------------------------
0097   0038             
0098   0038             
0099   0038             
0100   0038             ;------------------------------------------------------------------------------
0101   0038             ; Move the 10 sprites that make up Donkey Kong either horizontally or
0102   0038             ; vertically by adding the amount in c to every 4th byte starting at the
0103   0038             ; address in hl.
0104   0038             ;
0105   0038             ; NOTE: This function MUST start at address 0038h.
0106   0038             ;
0107   0038             ; passed: 	hl - the address of the first sprites x or y coord
0108   0038             ;			c - the amount to move the sprite 
0109   0038             		.org $38
0110   0038 11 04 00    l0038:  ld      de,4
0111   003B 06 0A               ld      b,10
0112   003D             L_MOVE_N_SPRITES:  
0113   003D 79          		ld      a,c
0114   003E 86                  add     a,(hl)
0115   003F 77                  ld      (hl),a
0116   0040 19                  add     hl,de
0117   0041 10 FA               djnz    L_MOVE_N_SPRITES
0118   0043 C9                  ret     
0119   0044             ;------------------------------------------------------------------------------
0120   0044             
0121   0044             
0122   0044             
0123   0044             ;------------------------------------------------------------------------------
0124   0044             ; Return from the calling function unless the stage is one of the stages of 
0125   0044             ; interest.
0126   0044             ; Checks if the bit in a corresponding to the current stage is set.  This
0127   0044             ; allows multiple stages to be checked for.
0128   0044             ; passed:	a - the stage bit mask
0129   0044 21 27 62    l0044:  ld      hl,CURRENT_STAGE
0130   0047 46                  ld      b,(hl)
0131   0048 0F          l0048:  rrca    
0132   0049 10 FD               djnz    l0048
0133   004B D8                  ret     c
0134   004C E1                  pop     hl
0135   004D C9                  ret     
0136   004E             ;------------------------------------------------------------------------------
0137   004E             
0138   004E             
0139   004E             
0140   004E             ;------------------------------------------------------------------------------
0141   004E             ; Copy Donkey Kong sprites from a ROM address into the Donkey Kong sprite 
0142   004E             ; memory
0143   004E             ; passed:  hl - source address
0144   004E             L_LOAD_DK_SPRITES:  
0145   004E 11 08 69    		ld      de,DK_SPRITE_1_X
0146   0051 01 28 00            ld      bc,40   
0147   0054 ED B0               ldir    
0148   0056 C9                  ret     
0149   0057             ;------------------------------------------------------------------------------
0150   0057             
0151   0057             
0152   0057             
0153   0057             ;------------------------------------------------------------------------------
0154   0057             ; Update the random number by adding the values of the two counters to the 
0155   0057             ; current random number
0156   0057             ; 
0157   0057             ; passed:	none
0158   0057             ; return:	a - random number
0159   0057             ;			hl - COUNTER_1 
0160   0057 3A 18 60    L_UPDATE_RAND_NUM:  ld      a,(RANDOM_NUMBER)
0161   005A 21 1A 60            ld      hl,COUNTER_2
0162   005D 86                  add     a,(hl)
0163   005E 21 19 60            ld      hl,COUNTER_1
0164   0061 86                  add     a,(hl)
0165   0062 32 18 60            ld      (RANDOM_NUMBER),a
0166   0065 C9                  ret 
0167   0066             ;------------------------------------------------------------------------------
0168   0066                 
0169   0066             		
0170   0066             
0171   0066             ;------------------------------------------------------------------------------
0172   0066             ; Interrupt handler
0173   0066             ; Called periodically to update the game state		
0174   0066             		.org	$66
0175   0066             L_INTERRUPT_HANDLER:  
0176   0066             		; Push the registers onto the stack
0177   0066 F5          		push    af
0178   0067 C5                  push    bc
0179   0068 D5                  push    de
0180   0069 E5                  push    hl
0181   006A DD E5               push    ix
0182   006C FD E5               push    iy
0183   006E             		
0184   006E AF                  xor     a
0185   006F 32 84 7D            ld      (INTERRUPT_ENABLE),a		; Disable interrupts
0186   0072             		
0187   0072 3A 00 7D            ld      a,(MISC_INPUT)					; If bit 0 of INPUT2 is 0, abort the game 
0188   0075 E6 01               and     1
0189   0077 C2 00 40            jp      nz,l4000
0190   007A             		
0191   007A             ; Configure the P8257		
0192   007A 21 38 01            ld      hl,L_P8257_REGISTER_DATA
0193   007D CD 41 01            call    L_CONFIG_P8257
0194   0080             		
0195   0080             		; Skip player handling if no coin has been inserted (attract mode is active)
0196   0080 3A 07 60            ld      a,(NO_COINS_INSERTED)
0197   0083 A7                  and     a
0198   0084 C2 B5 00            jp      nz,l00b5
0199   0087             		
0200   0087             		; Ignore player 2 input if this is an upright cabinet
0201   0087 3A 26 60            ld      a,(CABINET_TYPE)
0202   008A A7                  and     a
0203   008B C2 98 00            jp      nz,l0098
0204   008E             		
0205   008E             		; If player 2 is active, get player 2 input
0206   008E 3A 0E 60            ld      a,(SECOND_PLAYER)
0207   0091 A7                  and     a
0208   0092 3A 80 7C            ld      a,(P2_INPUT)
0209   0095 C2 9B 00            jp      nz,l009b
0210   0098             		
0211   0098             		; Get player 1 input
0212   0098 3A 00 7C    l0098:  ld      a,(P1_INPUT)
0213   009B             
0214   009B             		; Read the input and save the old input in PLAYER_INPUT_LAG
0215   009B 47          l009b:  ld      b,a
0216   009C E6 0F               and     $0f
0217   009E 4F                  ld      c,a
0218   009F 3A 11 60            ld      a,(PLAYER_INPUT_LAG)
0219   00A2 2F                  cpl     
0220   00A3 A0                  and     b
0221   00A4 E6 10               and     $10
0222   00A6 17                  rla     
0223   00A7 17                  rla     
0224   00A8 17                  rla     
0225   00A9 B1                  or      c
0226   00AA 60                  ld      h,b
0227   00AB 6F                  ld      l,a
0228   00AC 22 10 60            ld      (PLAYER_INPUT),hl		; Save player input and player input lag
0229   00AF             		
0230   00AF             		; Reset the game if the reset input bit is set
0231   00AF 78                  ld      a,b
0232   00B0 CB 77               bit     6,a
0233   00B2 C2 00 00            jp      nz,L_ORG
0234   00B5             		
0235   00B5             		; Decrement COUNTER_2 on every interrupt
0236   00B5 21 1A 60    l00b5:  ld      hl,COUNTER_2
0237   00B8 35                  dec     (hl)
0238   00B9             		
0239   00B9 CD 57 00            call    L_UPDATE_RAND_NUM		; Update the random number
0240   00BC CD 7B 01            call    L_CHECK_FOR_COIN		; Check for coins
0241   00BF CD E0 00            call    L_PLAY_SOUNDS			; Play sounds
0242   00C2                     
0243   00C2             		; Make sure registers are popped from the stack after the next function
0244   00C2 21 D2 00    		ld      hl,L_POP_REGISTERS_FROM_STACK				
0245   00C5 E5                  push    hl
0246   00C6             		
0247   00C6             		; Jump to a function based on the current game state
0248   00C6 3A 05 60            ld      a,(GAME_STATE)
0249   00C9 EF                  rst     $28							; Jump to local table address
0250   00CA             		; Jump table
0251   00CA C3 01       		.word	L_INIT_ATTRACT_MODE ; 0 = Prepare attract mode
0252   00CC 3C 07       		.word	L_IMPLEMENT_ATTRACT_MODE ; 1 = Implement attract mode
0253   00CE B1 08       		.word	L_WAITING_FOR_START_MODE	; 2 = Start game
0254   00D0 FE 06       		.word	L_IMPLEMENT_GAME_PLAY	; 3 = Display current game screen
0255   00D2             ;------------------------------------------------------------------------------
0256   00D2             
0257   00D2             
0258   00D2                     
0259   00D2             ;------------------------------------------------------------------------------
0260   00D2             ; Pop the registers from the stack
0261   00D2             L_POP_REGISTERS_FROM_STACK:  
0262   00D2 FD E1       		pop     iy
0263   00D4 DD E1               pop     ix
0264   00D6 E1                  pop     hl
0265   00D7 D1                  pop     de
0266   00D8 C1                  pop     bc
0267   00D9 3E 01               ld      a,$01
0268   00DB 32 84 7D            ld      (INTERRUPT_ENABLE),a
0269   00DE F1                  pop     af
0270   00DF C9                  ret 
0271   00E0             ;------------------------------------------------------------------------------
0272   00E0             
0273   00E0             
0274   00E0             ;------------------------------------------------------------------------------
0275   00E0             ; Play sounds if not in attract mode
0276   00E0             L_PLAY_SOUNDS:  
0277   00E0 21 80 60    		ld      hl,WALK_SOUND_TRIGGER
0278   00E3 11 00 7D            ld      de,WALK_SOUND_OUTPUT
0279   00E6             		
0280   00E6             		; Don't play sounds if attract mode is active
0281   00E6 3A 07 60            ld      a,(NO_COINS_INSERTED)
0282   00E9 A7                  and     a
0283   00EA C0                  ret     nz
0284   00EB             
0285   00EB             		; Pass each sound trigger to the sound chip
0286   00EB 06 08               ld      b,8				; For b = 8 to 1
0287   00ED 7E          l00ed:  ld      a,(hl)			; a > 0 if the current sound should be played
0288   00EE A7                  and     a
0289   00EF             		
0290   00EF             		; If this sound has not been triggered, jump ahead
0291   00EF CA F5 00            jp      z,l00f5		
0292   00F2             		
0293   00F2 35                  dec     (hl)			; Decrement the sound trigger value
0294   00F3 3E 01               ld      a,1
0295   00F5 12          l00f5:  ld      (de),a			; Turn the sound on or off
0296   00F6 1C                  inc     e				; Advance to the next sound and trigger
0297   00F7 2C                  inc     l
0298   00F8 10 F3               djnz    l00ed			; Next b
0299   00FA             		
0300   00FA             		; If the current song needs to be triggered, jump ahead
0301   00FA 21 8B 60            ld      hl,PENDING_SONG_TRIGGER_REPEAT
0302   00FD 7E                  ld      a,(hl)
0303   00FE A7                  and     a
0304   00FF C2 08 01            jp      nz,l0108
0305   0102             		
0306   0102             		; Set or clear the SONG_TRIGGER
0307   0102 2D                  dec     l
0308   0103 2D                  dec     l
0309   0104 7E                  ld      a,(hl)
0310   0105 C3 0B 01            jp      l010b
0311   0108             		
0312   0108             		; Turn on the song trigger
0313   0108 35          l0108:  dec     (hl)
0314   0109 2D                  dec     l
0315   010A 7E                  ld      a,(hl)
0316   010B             		
0317   010B             		; Turn on or off the song
0318   010B 32 00 7C    l010b:  ld      (SONG_OUTPUT),a
0319   010E                     
0320   010E             		; If the death sound is not playing, jump ahead
0321   010E 21 88 60    		ld      hl,DEATH_SOUND_TRIGGER
0322   0111 AF                  xor     a				; a = 0
0323   0112 BE                  cp      (hl)
0324   0113 CA 18 01            jp      z,l0118
0325   0116             		
0326   0116             		; Decrement the death sound counter to not trigger the sound
0327   0116 35                  dec     (hl)
0328   0117 3C                  inc     a				; a = 1
0329   0118             		
0330   0118             		; Trigger or turn off the death sound
0331   0118 32 80 7D    l0118:  ld      (DEATH_SOUND_OUTPUT),a
0332   011B C9                  ret   
0333   011C             ;------------------------------------------------------------------------------
0334   011C               
0335   011C             
0336   011C             
0337   011C             ;------------------------------------------------------------------------------
0338   011C             ; Turn off all sounds 
0339   011C             L_SOUNDS_OFF:  
0340   011C             		; All sound triggers and sound outputs
0341   011C 06 08       		ld      b,8		; For b = 8 to 1
0342   011E AF                  xor     a			; a = 0
0343   011F 21 00 7D            ld      hl,WALK_SOUND_OUTPUT
0344   0122 11 80 60            ld      de,WALK_SOUND_TRIGGER
0345   0125 77          l0125:  ld      (hl),a
0346   0126 12                  ld      (de),a
0347   0127 2C                  inc     l
0348   0128 1C                  inc     e
0349   0129 10 FA               djnz    l0125		; Next b
0350   012B             
0351   012B             		; Clear ($7d08-$7d0c)
0352   012B 06 04               ld      b,4		; For b = 4 to 1
0353   012D 12          l012d:  ld      (de),a
0354   012E 1C                  inc     e
0355   012F 10 FC               djnz    l012d		; Next b
0356   0131             
0357   0131             		; Clear song outputs
0358   0131 32 80 7D            ld      (DEATH_SOUND_OUTPUT),a
0359   0134 32 00 7C            ld      (SONG_OUTPUT),a
0360   0137 C9                  ret     
0361   0138             ;------------------------------------------------------------------------------
0362   0138             
0363   0138             
0364   0138             		
0365   0138             ;------------------------------------------------------------------------------
0366   0138             ; P8257 control register settings
0367   0138             L_P8257_REGISTER_DATA:
0368   0138 53          		.byte	$53		; Sent to $7808
0369   0139 00          		.byte	$00		; Sent to $7800
0370   013A 69          		.byte	$69		; Sent to $7800
0371   013B 80          		.byte	$80		; Sent to $7801
0372   013C 41          		.byte	$41		; Sent to $7801
0373   013D 00          		.byte	$00		; Sent to $7802
0374   013E 70          		.byte	$70		; Sent to $7802
0375   013F 80          		.byte	$80		; Sent to $7803
0376   0140 81          		.byte	$81		; Send to $7803
0377   0141             ;------------------------------------------------------------------------------
0378   0141             
0379   0141             		
0380   0141             
0381   0141             ;------------------------------------------------------------------------------
0382   0141             ; Set P8257 control registers
0383   0141             ; passed:	hl - set to point to L_P8257_REGISTER_DATA
0384   0141 AF          L_CONFIG_P8257:  xor     a
0385   0142 32 85 7D            ld      ($7d85),a
0386   0145 7E                  ld      a,(hl)
0387   0146 32 08 78            ld      ($7808),a
0388   0149 23                  inc     hl
0389   014A 7E                  ld      a,(hl)
0390   014B 32 00 78            ld      ($7800),a
0391   014E 23                  inc     hl
0392   014F 7E                  ld      a,(hl)
0393   0150 32 00 78            ld      ($7800),a
0394   0153 23                  inc     hl
0395   0154 7E                  ld      a,(hl)
0396   0155 32 01 78            ld      ($7801),a
0397   0158 23                  inc     hl
0398   0159 7E                  ld      a,(hl)
0399   015A 32 01 78            ld      ($7801),a
0400   015D 23                  inc     hl
0401   015E 7E                  ld      a,(hl)
0402   015F 32 02 78            ld      ($7802),a
0403   0162 23                  inc     hl
0404   0163 7E                  ld      a,(hl)
0405   0164 32 02 78            ld      ($7802),a
0406   0167 23                  inc     hl
0407   0168 7E                  ld      a,(hl)
0408   0169 32 03 78            ld      ($7803),a
0409   016C 23                  inc     hl
0410   016D 7E                  ld      a,(hl)
0411   016E 32 03 78            ld      ($7803),a
0412   0171 3E 01               ld      a,$01
0413   0173 32 85 7D            ld      ($7d85),a
0414   0176 AF                  xor     a
0415   0177 32 85 7D            ld      ($7d85),a
0416   017A C9                  ret     
0417   017B             ;------------------------------------------------------------------------------
0418   017B             
0419   017B             
0420   017B             
0421   017B             ;------------------------------------------------------------------------------
0422   017B             ; Check for and handle coin insertion
0423   017B             L_CHECK_FOR_COIN:  
0424   017B 3A 00 7D    		ld      a,(MISC_INPUT)
0425   017E CB 7F               bit     MISC_INPUT_COIN_BIT,a
0426   0180 21 03 60            ld      hl,COIN_VALID
0427   0183             		; Jump ahead if a coin is being insered
0428   0183 C2 89 01            jp      nz,l0189
0429   0186             		
0430   0186             		; Mark the next coin insertion as valid
0431   0186 36 01               ld      (hl),1
0432   0188 C9                  ret     
0433   0189             
0434   0189             		; Return if this coin has already been registered
0435   0189 7E          l0189:  ld      a,(hl)
0436   018A A7                  and     a
0437   018B C8                  ret     z
0438   018C             		
0439   018C E5                  push    hl					; Save COIN_VALID address to the stack
0440   018D             		
0441   018D             		; If the player is playing skip sound stuff
0442   018D 3A 05 60            ld      a,(GAME_STATE)
0443   0190 FE 03               cp      GAME_STATE_PLAY
0444   0192 CA 9D 01            jp      z,l019d
0445   0195             		
0446   0195 CD 1C 01            call    L_SOUNDS_OFF		; Turn off all sounds
0447   0198             		
0448   0198             		; Trigger coin insertion sound
0449   0198 3E 03               ld      a,3
0450   019A 32 83 60            ld      (SPRING_SOUND_TRIGGER),a
0451   019D             		
0452   019D             		; Mark this coin insertion as invalid so that it is not reprocessed
0453   019D E1          l019d:  pop     hl					; Restore COIN_VALID address from the stack
0454   019E 36 00               ld      (hl),$00
0455   01A0             
0456   01A0             		; Add this coin to the coins waiting to be processed
0457   01A0 2B          		dec     hl					; hl = NUM_COINS_PENDING
0458   01A1 34                  inc     (hl)
0459   01A2             		
0460   01A2             		; Return if there are not enough coins for one credit
0461   01A2 11 24 60            ld      de,DIP_COINS_PER_CREDIT
0462   01A5 1A                  ld      a,(de)
0463   01A6 96                  sub     (hl)
0464   01A7 C0                  ret     nz
0465   01A8             		
0466   01A8             		; Convert coins to credits
0467   01A8 77                  ld      (hl),a				; Spend all the pending coins
0468   01A9 13                  inc     de					; de = DIP_PLAYS_PER_CREDIT
0469   01AA 2B                  dec     hl					; hl = NUM_PLAYS
0470   01AB EB                  ex      de,hl				
0471   01AC 1A                  ld      a,(de)
0472   01AD             		
0473   01AD             		; Return if 90 credits have been paid for (the max that can be handled)
0474   01AD FE 90               cp      $90
0475   01AF D0                  ret     nc
0476   01B0             		
0477   01B0             		; Add the number of plays that have been earned for the credits that have been paid for
0478   01B0 86                  add     a,(hl)
0479   01B1 27                  daa     					; Adjust a to BCD digits
0480   01B2 12                  ld      (de),a				; Save the number of plays
0481   01B3             		
0482   01B3             		; Update the number of plays that are displayed
0483   01B3 11 00 04            ld      de,$0400
0484   01B6 CD 22 30            call    L_ADD_EVENT
0485   01B9 C9                  ret     
0486   01BA             ;------------------------------------------------------------------------------
0487   01BA             
0488   01BA             
0489   01BA             
0490   01BA             ;------------------------------------------------------------------------------
0491   01BA             ; The default initial score values
0492   01BA             L_INITIAL_SCORE_DATA:
0493   01BA 00 37 00    		.byte	$00, $37, $00	; Player 1 score = 003700
0494   01BD AA AA       		.byte	$aa, $aa, 		; Player 2 score = blank
0495   01BF             L_BLANK_SCORE_DATA:	; The $aa bytes display a blank score
0496   01BF AA          			.byte $aa
0497   01C0 50 76 00    		.byte	$50, $76, $00	; High score = 007650
0498   01C3             ;------------------------------------------------------------------------------
0499   01C3             		
0500   01C3             
0501   01C3             
0502   01C3             ;------------------------------------------------------------------------------
0503   01C3             ; Initialize the attract mode
0504   01C3             L_INIT_ATTRACT_MODE:  
0505   01C3 CD 73 08    		call    L_CLEAR_STAGE_SCREEN
0506   01C6             
0507   01C6             		; Load the initially displayed scores from ROM
0508   01C6 21 BA 01            ld      hl,L_INITIAL_SCORE_DATA
0509   01C9 11 B2 60            ld      de,PREV_P1_SCORE
0510   01CC 01 09 00            ld      bc,9
0511   01CF ED B0               ldir    
0512   01D1             		
0513   01D1             		; Initialize the attract mode
0514   01D1 3E 01               ld      a,1
0515   01D3 32 07 60            ld      (NO_COINS_INSERTED),a					; In attract mode, waiting for coins
0516   01D6 32 29 62            ld      (CP_LEVEL_NUMBER),a						; Level 1
0517   01D9 32 28 62            ld      (CP_NUMBER_LIVES),a						; 1 life
0518   01DC             		
0519   01DC CD B8 06            call    L_DISPLAY_LIVES_AND_LEVEL									; Display lives and level
0520   01DF CD 07 02            call    L_LOAD_DIP_SETTINGS
0521   01E2             
0522   01E2 3E 01               ld      a,1
0523   01E4 32 82 7D            ld      (SCREEN_ORIENTATION),a					; Orient the screen normally
0524   01E7 32 05 60            ld      (GAME_STATE),a							; In attract mode
0525   01EA 32 27 62            ld      (CURRENT_STAGE),a								; Starting on the barrels stage
0526   01ED             
0527   01ED AF                  xor     a
0528   01EE 32 0A 60            ld      (GAME_SUBSTATE),a						; Displaying the coin entry screen
0529   01F1 CD 52 0A            call    L_DISPLAY_1UP
0530   01F4 11 04 03            ld      de,$0304
0531   01F7 CD 22 30            call    L_ADD_EVENT							; Display "HIGH SCORE"
0532   01FA 11 02 02            ld      de,$0202
0533   01FD CD 22 30            call    L_ADD_EVENT							; Display the high score
0534   0200 11 00 02            ld      de,$0200
0535   0203 CD 22 30            call    L_ADD_EVENT							; Display player 1's score
0536   0206 C9                  ret     
0537   0207             ;------------------------------------------------------------------------------
0538   0207             
0539   0207             
0540   0207             
0541   0207             ;------------------------------------------------------------------------------
0542   0207             ; Load DIP settings and default high score table
0543   0207             L_LOAD_DIP_SETTINGS:  
0544   0207             		; Read the number of lives setting
0545   0207 3A 80 7D    		ld      a,(DIP_INPUT)
0546   020A 4F                  ld      c,a
0547   020B 21 20 60            ld      hl,DIP_NUM_LIVES
0548   020E E6 03               and     %00000011
0549   0210 C6 03               add     a,3
0550   0212 77                  ld      (hl),a
0551   0213             
0552   0213             		; Read the bonus life setting
0553   0213 23                  inc     hl
0554   0214 79                  ld      a,c
0555   0215 0F                  rrca    
0556   0216 0F                  rrca    
0557   0217 E6 03               and     %00000011
0558   0219 47                  ld      b,a
0559   021A 3E 07               ld      a,7
0560   021C CA 26 02            jp      z,l0226
0561   021F 3E 05               ld      a,5
0562   0221 C6 05       l0221:  add     a,5
0563   0223 27                  daa     
0564   0224 10 FB               djnz    l0221
0565   0226 77          l0226:  ld      (hl),a
0566   0227             
0567   0227             		; 
0568   0227 23                  inc     hl
0569   0228 79                  ld      a,c
0570   0229 01 01 01            ld      bc,$0101
0571   022C 11 02 01            ld      de,$0102
0572   022F E6 70               and     %01110000
0573   0231 17                  rla     
0574   0232 17                  rla     
0575   0233 17                  rla     
0576   0234 17                  rla     
0577   0235 CA 47 02            jp      z,l0247
0578   0238 DA 41 02            jp      c,l0241
0579   023B 3C                  inc     a
0580   023C 4F                  ld      c,a
0581   023D 5A                  ld      e,d
0582   023E C3 47 02            jp      l0247
0583   0241 C6 02       l0241:  add     a,2
0584   0243 47                  ld      b,a
0585   0244 57                  ld      d,a
0586   0245 87                  add     a,a
0587   0246 5F                  ld      e,a
0588   0247 72          l0247:  ld      (hl),d
0589   0248             
0590   0248 23                  inc     hl
0591   0249 73                  ld      (hl),e
0592   024A 23                  inc     hl
0593   024B 70                  ld      (hl),b
0594   024C 23                  inc     hl
0595   024D 71                  ld      (hl),c
0596   024E 23                  inc     hl
0597   024F             
0598   024F             		; Read the cabinet type
0599   024F 3A 80 7D            ld      a,(DIP_INPUT)
0600   0252 07                  rlca    
0601   0253 3E 01               ld      a,1
0602   0255 DA 59 02            jp      c,l0259
0603   0258 3D                  dec     a
0604   0259 77          l0259:  ld      (hl),a
0605   025A             
0606   025A             		; Load the default high score table
0607   025A 21 D7 34            ld      hl,L_DEFAULT_HIGH_SCORE_DATA
0608   025D 11 00 61            ld      de,HIGH_SCORE_TABLE
0609   0260 01 AA 00            ld      bc,170
0610   0263 ED B0               ldir    
0611   0265 C9                  ret     
0612   0266             ;------------------------------------------------------------------------------
0613   0266             
0614   0266             
0615   0266             
0616   0266             ;------------------------------------------------------------------------------
0617   0266             ; Initialization code
0618   0266             L_INIT_GAME:  
0619   0266             		; Clear 4096 bytes of RAM ($6000 to $6FFF) to $00        
0620   0266 06 10       		ld      b,16			
0621   0268 21 00 60            ld      hl,$6000
0622   026B AF                  xor     a
0623   026C 4F          l026c:  ld      c,a
0624   026D 77          l026d:  ld      (hl),a
0625   026E 23                  inc     hl
0626   026F 0D                  dec     c
0627   0270 20 FB               jr      nz,l026d
0628   0272 10 F8               djnz    l026c
0629   0274                     
0630   0274             		; Clear 1024 bytes of RAM ($7000 to $73ff) to $00        
0631   0274 06 04               ld      b,4
0632   0276 21 00 70            ld      hl,$7000
0633   0279 4F          l0279:  ld      c,a
0634   027A 77          l027a:  ld      (hl),a
0635   027B 23                  inc     hl
0636   027C 0D                  dec     c
0637   027D 20 FB               jr      nz,l027a
0638   027F 10 F8               djnz    l0279
0639   0281                     
0640   0281             		; Clear 1024 bytes of tile RAM ($7400 to $77ff) to $10 (blank space character)
0641   0281 06 04               ld      b,4
0642   0283 3E 10               ld      a,$10
0643   0285 21 00 74            ld      hl,TILE_COORD(0,0)
0644   0288 0E 00       l0288:  ld      c,0
0645   028A 77          l028a:  ld      (hl),a
0646   028B 23                  inc     hl
0647   028C 0D                  dec     c
0648   028D 20 FB               jr      nz,l028a
0649   028F 10 F7               djnz    l0288
0650   0291                     
0651   0291             		; Clear 64 byte circular event buffer ($60c0 to $60ff) to $ff (invalid value)    
0652   0291             		; Can hold 32 events with their parameters
0653   0291 21 C0 60            ld      hl,$60c0
0654   0294 06 40               ld      b,64
0655   0296 3E FF               ld      a,$ff
0656   0298 77          l0298:  ld      (hl),a
0657   0299 23                  inc     hl
0658   029A 10 FC               djnz    l0298
0659   029C                     
0660   029C             		; Initialize the circular event buffer write pointer to $c0 ($60c0)
0661   029C 3E C0               ld      a,$c0
0662   029E 32 B0 60            ld      (ACTION_BUFFER_WRITE_POS),a
0663   02A1 32 B1 60            ld      (ACTION_BUFFER_READ_POS),a
0664   02A4                     
0665   02A4             		; Initialize the display palette to 00
0666   02A4 AF                  xor     a
0667   02A5 32 83 7D            ld      ($7d83),a   ; ($7d83) = 0
0668   02A8 32 86 7D            ld      (PALETTE_1_OUTPUT),a 
0669   02AB 32 87 7D            ld      (PALETTE_2_OUTPUT),a
0670   02AE             
0671   02AE             		; Initialize the screen orientation
0672   02AE 3C                  inc     a
0673   02AF 32 82 7D            ld      (SCREEN_ORIENTATION),a   ; (SCREEN_ORIENTATION) = 1
0674   02B2             
0675   02B2             		; Initialize the stack
0676   02B2 31 00 6C            ld      sp,$6c00    ; Stack starts at $6c00
0677   02B5             
0678   02B5             		; Turn off sounds
0679   02B5 CD 1C 01            call    L_SOUNDS_OFF       ; Turn off sounds and music
0680   02B8             
0681   02B8             		; Reenable interrupts
0682   02B8 3E 01               ld      a,1       
0683   02BA 32 84 7D            ld      (INTERRUPT_ENABLE),a    ; Reenable interrupts
0684   02BD             ; End of initialization
0685   02BD             ;------------------------------------------------------------------------------
0686   02BD                     
0687   02BD             
0688   02BD             
0689   02BD             ;------------------------------------------------------------------------------
0690   02BD             ; Main program loop
0691   02BD             ; Checks if there are events waiting in the event buffer and processes them
0692   02BD             ; until the buffer is empty.
0693   02BD             L_MAIN_LOOP:  
0694   02BD             		; Check for actions in the action buffer
0695   02BD 26 60       		ld      h,$60
0696   02BF 3A B1 60            ld      a,(ACTION_BUFFER_READ_POS)   ; A = (readPtr)
0697   02C2 6F                  ld      l,a
0698   02C3 7E                  ld      a,(hl)
0699   02C4             		
0700   02C4             		; Double a to turn it into a 2-byte offset
0701   02C4 87                  add     a,a
0702   02C5 30 1C               jr      nc,L_PROCESS_ACTION_BUFFER    ; If A is a valid buffer byte, jump ahead (skipping 'nUp' display and timer incrementing)
0703   02C7                     
0704   02C7 CD 15 03    		call    L_DISPLAY_NUP ; Flash the current player's 'nUp' line
0705   02CA CD 50 03            call    L_AWARD_BONUS_LIFE ; Pre-turn stuff: Award bonus life, display lives and level number
0706   02CD 21 19 60            ld      hl,COUNTER_1
0707   02D0 34                  inc     (hl)        ; ++counter2
0708   02D1 21 83 63            ld      hl,$6383
0709   02D4 3A 1A 60            ld      a,(COUNTER_2)
0710   02D7 BE                  cp      (hl)
0711   02D8 28 E3               jr      z,L_MAIN_LOOP
0712   02DA 77                  ld      (hl),a
0713   02DB CD 7F 03            call    L_INCREASE_DIFFICULTY
0714   02DE CD A2 03            call    L_IMPLEMENT_BARREL_FIRE
0715   02E1 18 DA               jr      L_MAIN_LOOP
0716   02E3             ;------------------------------------------------------------------------------
0717   02E3             
0718   02E3             
0719   02E3             
0720   02E3             ;------------------------------------------------------------------------------
0721   02E3             ; Process actions from the action buffer
0722   02E3             ;
0723   02E3             ; passed:	a - the offset of the action function to jump to in 
0724   02E3             ;				the table below
0725   02E3             ;			hl - pointer to the location of the action buffer read
0726   02E3             ;				position
0727   02E3             L_PROCESS_ACTION_BUFFER:  
0728   02E3             		; Parse the action jump table index
0729   02E3 E6 1F       		and     %00011111
0730   02E5 5F                  ld      e,a
0731   02E6 16 00               ld      d,$00
0732   02E8 36 FF               ld      (hl),$ff					; Clear this action
0733   02EA             
0734   02EA             		; Read the action parameter
0735   02EA 2C                  inc     l
0736   02EB 4E                  ld      c,(hl)
0737   02EC 36 FF               ld      (hl),$ff					; Clear this parameter
0738   02EE             
0739   02EE             		; Advance the action buffer read pointer (wrapping around if needed)
0740   02EE 2C                  inc     l
0741   02EF 7D                  ld      a,l
0742   02F0 FE C0               cp      $c0
0743   02F2 30 02               jr      nc,l02f6
0744   02F4 3E C0               ld      a,$c0
0745   02F6 32 B1 60    l02f6:  ld      (ACTION_BUFFER_READ_POS),a
0746   02F9             
0747   02F9 79                  ld      a,c							; a = action parameter
0748   02FA             
0749   02FA             		; Make sure execution returns to the main loop after the action is processed
0750   02FA 21 BD 02            ld      hl,L_MAIN_LOOP
0751   02FD E5                  push    hl
0752   02FE             
0753   02FE             		; Jump to the correct offset in the jump table below
0754   02FE 21 07 03            ld      hl,l0307
0755   0301 19                  add     hl,de
0756   0302 5E                  ld      e,(hl)
0757   0303 23                  inc     hl
0758   0304 56                  ld      d,(hl)
0759   0305 EB                  ex      de,hl
0760   0306 E9                  jp      (hl)
0761   0307             
0762   0307                     ; Jump table
0763   0307 1C 05       l0307   .word   L_AWARD_POINTS ; 0 = Award points
0764   0309 9B 05               .word   L_ZERO_SCORES ; 1 = Clear scores
0765   030B C6 05               .word   L_DISPLAY_SCORES ; 2 = Display all scores
0766   030D E9 05               .word   L_DISPLAY_STRING ; 3 = Display string
0767   030F 11 06               .word   L_DISPLAY_CREDITS ; 4 = Display the number of credits
0768   0311 2A 06               .word   L_PROCESS_TIMER ; 5 = Display timer
0769   0313 B8 06               .word   L_DISPLAY_LIVES_AND_LEVEL ; 6 = Display lives and level
0770   0315             ;------------------------------------------------------------------------------
0771   0315             
0772   0315             
0773   0315             
0774   0315             ;------------------------------------------------------------------------------
0775   0315             ; Display "1UP" and "2UP" (if two players are playing)
0776   0315             ; The string for the current player is flashed
0777   0315             L_DISPLAY_NUP:  
0778   0315             		; Only proceed once every 16 counter cycles
0779   0315 3A 1A 60    		ld      a,(COUNTER_2)
0780   0318 47                  ld      b,a
0781   0319 E6 0F               and     $0f
0782   031B C0                  ret     nz
0783   031C             
0784   031C             		; Abort if in attract mode
0785   031C CF                  rst     $08
0786   031D             
0787   031D             		; Get the coordinate for this player's "nUP" string
0788   031D 3A 0D 60            ld      a,(CURRENT_PLAYER)
0789   0320 CD 47 03            call    L_RETURN_NUP_COORD
0790   0323             
0791   0323             		; Display the "nUP" line every other time
0792   0323             		; (on for 16 cycles, off for 16 cycles)
0793   0323 11 E0 FF            ld      de,-32
0794   0326 CB 60               bit     4,b
0795   0328 28 14               jr      z,l033e					; Display "1UP" or "2UP"
0796   032A             
0797   032A             		; Clear the "nUP" string
0798   032A 3E 10               ld      a,$10
0799   032C 77                  ld      (hl),a
0800   032D 19                  add     hl,de
0801   032E 77                  ld      (hl),a
0802   032F 19                  add     hl,de
0803   0330 77                  ld      (hl),a
0804   0331             
0805   0331             		; If two players, display the other "nUP" line without blinking
0806   0331 3A 0F 60            ld      a,(TWO_PLAYERS)
0807   0334 A7                  and     a
0808   0335 C8                  ret     z
0809   0336 3A 0D 60            ld      a,(CURRENT_PLAYER)
0810   0339 EE 01               xor     $01							; a = inactive player
0811   033B CD 47 03            call    L_RETURN_NUP_COORD			; Get coordinate of inactive player's "nUP" line
0812   033E             
0813   033E             		; Display "1UP" or "2UP'
0814   033E 3C          l033e:  inc     a							; Convert player ID (0 or 1) to player number (1 or 2)
0815   033F 77                  ld      (hl),a
0816   0340 19                  add     hl,de						; Move 1 column right
0817   0341 36 25               ld      (hl),$25					; 'U'
0818   0343 19                  add     hl,de						; Move 1 column right
0819   0344 36 20               ld      (hl),$20					;'P'
0820   0346 C9                  ret     
0821   0347             ;------------------------------------------------------------------------------
0822   0347             
0823   0347             
0824   0347             
0825   0347             ;------------------------------------------------------------------------------
0826   0347             ; Return the coordinate of either "1UP" (a = 0) or "2UP" (a = 1)
0827   0347             ;
0828   0347             ; passed:	a - 0 (player 1) or 1 (player 2)
0829   0347             L_RETURN_NUP_COORD:  
0830   0347 21 40 77    		ld      hl,TILE_COORD(26,0)
0831   034A A7                  and     a
0832   034B C8                  ret     z
0833   034C 21 E0 74            ld      hl,TILE_COORD(7,0)
0834   034F C9                  ret     
0835   0350             ;------------------------------------------------------------------------------
0836   0350             
0837   0350             
0838   0350             
0839   0350             ;------------------------------------------------------------------------------
0840   0350             ; Handle awarding bonus life
0841   0350             L_AWARD_BONUS_LIFE:  
0842   0350             		; Return if the player has already received a bonus life
0843   0350 3A 2D 62    		ld      a,(CP_BONUS_LIFE_AWARDED)
0844   0353 A7                  and     a
0845   0354 C0                  ret     nz
0846   0355             
0847   0355             		; Get the 2nd and 3rd digits of the player's score
0848   0355 21 B3 60            ld      hl,PREV_P1_SCORE+1
0849   0358 3A 0D 60            ld      a,(CURRENT_PLAYER)
0850   035B A7                  and     a
0851   035C 28 03               jr      z,l0361
0852   035E 21 B6 60            ld      hl,PREV_P2_SCORE+1
0853   0361 7E          l0361:  ld      a,(hl)
0854   0362 E6 F0               and     $f0
0855   0364 47                  ld      b,a							; b = 3rd digit of current player's score
0856   0365 23                  inc     hl
0857   0366 7E                  ld      a,(hl)
0858   0367 E6 0F               and     $0f							; a = 2nd digit of current player's score
0859   0369 B0                  or      b
0860   036A 0F                  rrca    
0861   036B 0F                  rrca    
0862   036C 0F                  rrca    
0863   036D 0F                  rrca    							; a = 2nd and 3rd digits of current player's score
0864   036E             
0865   036E             		; Return if the player has not earned an extra life
0866   036E 21 21 60            ld      hl,DIP_BONUS_LIFE
0867   0371 BE                  cp      (hl)
0868   0372 D8                  ret     c
0869   0373             
0870   0373             		; Award a bonus life
0871   0373 3E 01               ld      a,$01
0872   0375 32 2D 62            ld      (CP_BONUS_LIFE_AWARDED),a
0873   0378 21 28 62            ld      hl,CP_NUMBER_LIVES
0874   037B 34                  inc     (hl)
0875   037C C3 B8 06            jp      L_DISPLAY_LIVES_AND_LEVEL
0876   037F             ;------------------------------------------------------------------------------
0877   037F             
0878   037F             
0879   037F             
0880   037F             ;------------------------------------------------------------------------------
0881   037F             ; Increment the minor and major counters
0882   037F             ; The difficulty starts out equal to the level number and increases by 1 every 2048 
0883   037F             ; counter cycles to a maximum of 5.
0884   037F             L_INCREASE_DIFFICULTY:  
0885   037F             		; Increment the minor counter
0886   037F 21 84 63    		ld      hl,MINOR_COUNTER
0887   0382 7E                  ld      a,(hl)
0888   0383 34                  inc     (hl)
0889   0384             
0890   0384             		; Return if the minor counter has not rolled over
0891   0384 A7                  and     a
0892   0385 C0                  ret     nz
0893   0386             
0894   0386             		; Increment the major counter
0895   0386 21 81 63            ld      hl,MAJOR_COUNTER
0896   0389 7E                  ld      a,(hl)
0897   038A 47                  ld      b,a
0898   038B 34                  inc     (hl)
0899   038C             
0900   038C             		; Return if the 3 LSBs have not rolled over
0901   038C E6 07               and     %00000111
0902   038E C0                  ret     nz
0903   038F             
0904   038F             		; Isolate the 5 MSBs
0905   038F 78                  ld      a,b
0906   0390 0F                  rrca    
0907   0391 0F                  rrca    
0908   0392 0F                  rrca    
0909   0393 47                  ld      b,a
0910   0394             
0911   0394             		; Increase the difficulty level to a maximum or 5
0912   0394 3A 29 62            ld      a,(CP_LEVEL_NUMBER)
0913   0397 80                  add     a,b
0914   0398 FE 05               cp      5
0915   039A 38 02               jr      c,l039e
0916   039C 3E 05               ld      a,5
0917   039E 32 80 63    l039e:  ld      (CP_DIFFICULTY),a
0918   03A1 C9                  ret     
0919   03A2             ;------------------------------------------------------------------------------
0920   03A2             
0921   03A2             
0922   03A2             
0923   03A2             ;------------------------------------------------------------------------------
0924   03A2             ; Handle the barrel fire animation on the barrels and mixer levels.  This 
0925   03A2             ; includes displaying the initial flare up when an oil barrel is thrown and
0926   03A2             ; the normal burning afterwards.
0927   03A2             L_IMPLEMENT_BARREL_FIRE:  
0928   03A2 3E 03       		ld      a,%0011
0929   03A4 F7                  rst     $30							; Return unless this is the barrels stage or mixer stage
0930   03A5                     ; Return if Mario is dead
0931   03A5 D7                  rst     $10
0932   03A6             
0933   03A6             		; Return if the smash animation is playing
0934   03A6 3A 50 63            ld      a,(SMASH_ANIMATION_ACTIVE)
0935   03A9 0F                  rrca    
0936   03AA D8                  ret     c
0937   03AB             
0938   03AB             		; Return if it is not time to update the barrel fire
0939   03AB 21 B8 62            ld      hl,BARREL_FIRE_FREEZE
0940   03AE 35                  dec     (hl)
0941   03AF C0                  ret     nz
0942   03B0             
0943   03B0             		; Reset the barrel fire delay to 4
0944   03B0 36 04               ld      (hl),4
0945   03B2             
0946   03B2             		; Return if the oil barrel is not burning
0947   03B2 3A B9 62            ld      a,(BARREL_FIRE_STATE)
0948   03B5 0F                  rrca    
0949   03B6 D0                  ret     nc
0950   03B7             
0951   03B7             		; Prepare the sprite
0952   03B7 21 29 6A            ld      hl,BARREL_FIRE_SPRITE_NUM
0953   03BA 06 40               ld      b,$40						; Basic fire sprite
0954   03BC DD 21 A0 66         ld      ix,BARREL_FIRE_STRUCT
0955   03C0             		
0956   03C0             		; If the barrel fire is not in its initial flare up, jump ahead
0957   03C0 0F                  rrca    
0958   03C1 D2 E4 03            jp      nc,l03e4
0959   03C4             		
0960   03C4             		; Display the flared up barrel fire sprite
0961   03C4 DD 36 09 02         ld      (ix+9),2
0962   03C8 DD 36 0A 02         ld      (ix+10),2
0963   03CC 04                  inc     b
0964   03CD 04                  inc     b							; b = $42, the first flared up sprite
0965   03CE CD F2 03            call    L_TOGGLE_FIRE_SPRITES
0966   03D1             		
0967   03D1             		; Return if the flare up time has not run out
0968   03D1 21 BA 62            ld      hl,BARREL_FIRE_FLARE_UP_TIME
0969   03D4 35                  dec     (hl)
0970   03D5 C0                  ret     nz
0971   03D6             
0972   03D6             		; The barrel fire is now burning normally
0973   03D6 3E 01               ld      a,1
0974   03D8 32 B9 62            ld      (BARREL_FIRE_STATE),a
0975   03DB 32 A0 63            ld      (RELEASE_A_FIREBALL),a
0976   03DE 3E 10       l03de:  ld      a,16
0977   03E0 32 BA 62            ld      (BARREL_FIRE_FLARE_UP_TIME),a
0978   03E3 C9                  ret     
0979   03E4             
0980   03E4             		; Display the normal barrel fire sprite
0981   03E4 DD 36 09 02 l03e4:  ld      (ix+9),2
0982   03E8 DD 36 0A 00         ld      (ix+10),0
0983   03EC CD F2 03            call    L_TOGGLE_FIRE_SPRITES
0984   03EF C3 DE 03            jp      l03de
0985   03F2             ;------------------------------------------------------------------------------
0986   03F2             		
0987   03F2             
0988   03F2             		
0989   03F2             ;------------------------------------------------------------------------------
0990   03F2             ; Alternate between the sprite number in b and the next sprite up
0991   03F2             ; passed:	b - the first sprite number 
0992   03F2             ;			hl - the sprite number memory address
0993   03F2             ; return:	(hl) - the resulting sprite number
0994   03F2             L_TOGGLE_FIRE_SPRITES:  
0995   03F2 70          		ld      (hl),b
0996   03F3 3A 19 60            ld      a,(COUNTER_1)
0997   03F6 0F                  rrca    
0998   03F7 D8                  ret     c
0999   03F8 04                  inc     b
1000   03F9 70                  ld      (hl),b
1001   03FA C9                  ret     
1002   03FB             ;------------------------------------------------------------------------------
1003   03FB             
1004   03FB             
1005   03FB             
1006   03FB             ;------------------------------------------------------------------------------
1007   03FB             ; Animate Donkey Kong (stomping, grabbing barrels, etc) and Pauline (yelling 
1008   03FB             ; HELP! and being frantic)
1009   03FB             L_ANIMATE_DK_AND_PAULINE:  
1010   03FB             		; If this is not the mixer stage, skip ahead
1011   03FB 3A 27 62    		ld      a,(CURRENT_STAGE)
1012   03FE FE 02               cp      2
1013   0400 C2 13 04            jp      nz,l0413
1014   0403             
1015   0403             		; Move Donkey Kong along the top conveyer
1016   0403 21 08 69            ld      hl,DK_SPRITE_1_X
1017   0406 3A A3 63            ld      a,(TOP_CONVEYER_DIR)
1018   0409 4F                  ld      c,a
1019   040A FF                  rst     $38						; Move Donkey Kong horizontally
1020   040B             
1021   040B             		; Calculate and save Donkey Kong's distance from the ladder
1022   040B 3A 10 69            ld      a,(DK_SPRITE_3_X)
1023   040E D6 3B               sub     59
1024   0410 32 B7 63            ld      (DK_DISTANCE_TO_LADDER),a
1025   0413             
1026   0413             		; If Donkey Kong is in an action, jump ahead to perform it
1027   0413 3A 91 63    l0413:  ld      a,(TIME_FOR_DK_ACTION)
1028   0416 A7                  and     a
1029   0417 C2 26 04            jp      nz,l0426
1030   041A             
1031   041A             		; If counter 2 has not yet run down, then jump ahead to skip Donkey Kong
1032   041A             		; animation and animate Pauline
1033   041A 3A 1A 60            ld      a,(COUNTER_2)
1034   041D A7                  and     a
1035   041E C2 86 04            jp      nz,l0486
1036   0421             
1037   0421             		; If counter 2 has run down, it is time for Donkey Kong to act 
1038   0421 3E 01               ld      a,1
1039   0423 32 91 63            ld      (TIME_FOR_DK_ACTION),a
1040   0426             
1041   0426             		; If ++ANIMATION_TIMER == 128, jump ahead
1042   0426 21 90 63    l0426:  ld      hl,ANIMATION_TIMER
1043   0429 34                  inc     (hl)
1044   042A 7E                  ld      a,(hl)
1045   042B FE 80               cp      128
1046   042D CA 64 04            jp      z,l0464
1047   0430             
1048   0430             		; If Donkey Kong is not stomping, then jump ahead to animate Pauline
1049   0430 3A 93 63            ld      a,(DK_STOMPING)
1050   0433 A7                  and     a
1051   0434 C2 86 04            jp      nz,l0486
1052   0437             
1053   0437             		; If it is not time to update Donkey Kong's stomp animation,
1054   0437             		; skip ahead to animate Pauline
1055   0437 7E                  ld      a,(hl)
1056   0438 47                  ld      b,a
1057   0439 E6 1F               and     %00011111
1058   043B C2 86 04            jp      nz,l0486
1059   043E             
1060   043E             		; Toggle between Donkey Kong stomping sprites
1061   043E 21 41 39            ld      hl,L_DK_SPRITES_GRIN_L_STOMP
1062   0441 CB 68               bit     5,b
1063   0443 20 03               jr      nz,l0448
1064   0445 21 69 39            ld      hl,L_DK_SPRITES_GRIN_R_STOMP
1065   0448 CD 4E 00    l0448:  call    L_LOAD_DK_SPRITES
1066   044B             
1067   044B             		; Trigger stomp sound
1068   044B 3E 03               ld      a,3
1069   044D 32 82 60            ld      (STOMP_SOUND_TRIGGER),a
1070   0450             
1071   0450             		; Jump ahead if the current stage is mixer or rivets
1072   0450 3A 27 62    l0450:  ld      a,(CURRENT_STAGE)
1073   0453 0F                  rrca    
1074   0454 D2 78 04            jp      nc,l0478
1075   0457             
1076   0457             		; Jump ahead if this is the elevators stage
1077   0457 0F                  rrca    
1078   0458 DA 86 04            jp      c,l0486
1079   045B             
1080   045B             		; If this is the barrels stage, move Donkey Kong 4 pixels left
1081   045B 21 0B 69            ld      hl,DK_SPRITE_1_Y
1082   045E 0E FC               ld      c,-4
1083   0460 FF                  rst     $38
1084   0461 C3 86 04            jp      l0486
1085   0464             
1086   0464             		; Set ANIMATION_TIMER and TIME_FOR_DK_ACTION to 0
1087   0464 AF          l0464:  xor     a
1088   0465 77                  ld      (hl),a
1089   0466 23                  inc     hl
1090   0467 77                  ld      (hl),a
1091   0468             
1092   0468             		; If Donkey Kong is not stomping, then skip ahead to animate Pauline
1093   0468 3A 93 63            ld      a,(DK_STOMPING)
1094   046B A7                  and     a
1095   046C C2 86 04            jp      nz,l0486
1096   046F             
1097   046F 21 CE 37            ld      hl,L_DK_SPRITES_L_ARM_RAISED
1098   0472 CD 4E 00            call    L_LOAD_DK_SPRITES
1099   0475 C3 50 04            jp      l0450
1100   0478             
1101   0478             		; Move Donkey Kong to the ladder?
1102   0478 21 08 69    l0478:  ld      hl,DK_SPRITE_1_X
1103   047B 0E 44               ld      c,68
1104   047D             
1105   047D             		; If the current stage is mixer, jump ahead
1106   047D 0F                  rrca    
1107   047E D2 85 04            jp      nc,l0485
1108   0481             
1109   0481 3A B7 63            ld      a,(DK_DISTANCE_TO_LADDER)
1110   0484 4F                  ld      c,a
1111   0485 FF          l0485:  rst     $38
1112   0486             
1113   0486             ; Animate Pauline on the barrels, mixer, and elevators level
1114   0486             ; The HELP! tiles are periodically displayed and erased
1115   0486             ; and Pauline is animated as frantic
1116   0486 3A 90 63    l0486:  ld      a,(ANIMATION_TIMER)
1117   0489 4F                  ld      c,a
1118   048A 11 20 00            ld      de,32						; Used to move tile address one column left
1119   048D             
1120   048D             		; If the current stage is rivets
1121   048D 3A 27 62            ld      a,(CURRENT_STAGE)
1122   0490 FE 04               cp      4
1123   0492 CA BE 04            jp      z,l04be
1124   0495             
1125   0495             		; If ANIMATION_TIMER is zero, then clear the HElP! tiles next to Pauline
1126   0495 79                  ld      a,c
1127   0496 A7                  and     a
1128   0497 CA A1 04            jp      z,l04a1
1129   049A             
1130   049A             		; If bit 6 of ANIMATION_TIMER is set, display the HELP! tiles
1131   049A 3E EF               ld      a,$ef
1132   049C CB 71               bit     6,c
1133   049E C2 A3 04            jp      nz,l04a3
1134   04A1             
1135   04A1 3E 10       l04a1:  ld      a,$10						; Blank tile
1136   04A3             		; Display or clear the HElP! tiles next to Pauline
1137   04A3 21 C4 75    l04a3:  ld      hl,TILE_COORD(14,4)
1138   04A6 CD 14 05            call    L_DISPLAY_OR_CLEAR_HELP						; Display or clear HELP!
1139   04A9             
1140   04A9 3A 05 69            ld      a,(PAULINE_LOWER_SPRITE_NUM)
1141   04AC             		; Record Paulines lower sprite number
1142   04AC 32 05 69    l04ac:  ld      (PAULINE_LOWER_SPRITE_NUM),a
1143   04AF             		; All done if bit 6 of ANIMATION_TIMER is not set
1144   04AF CB 71               bit     6,c
1145   04B1 C8                  ret     z
1146   04B2             
1147   04B2             		; Return if lower three bits of ANIMATION_TIMER are not 0
1148   04B2 47                  ld      b,a						; b = pauline lower sprite number
1149   04B3 79                  ld      a,c						; a = ANIMATION_TIMER
1150   04B4 E6 07               and     %00000111
1151   04B6 C0                  ret     nz
1152   04B7             
1153   04B7             		; Animate Pauline frantic by swapping her lower sprite number 
1154   04B7             		; between $11 and $12
1155   04B7 78                  ld      a,b
1156   04B8 EE 03               xor     %00000011
1157   04BA 32 05 69            ld      (PAULINE_LOWER_SPRITE_NUM),a
1158   04BD C9                  ret     
1159   04BE             
1160   04BE             ; Animate Pauline on the rivets stage
1161   04BE             		; Clear the HELP! tiles from both sides of Pauline
1162   04BE 3E 10       l04be:  ld      a,$10
1163   04C0 21 23 76            ld      hl,TILE_COORD(17,3)
1164   04C3 CD 14 05            call    L_DISPLAY_OR_CLEAR_HELP						; Display or clear HELP!
1165   04C6 21 83 75            ld      hl,TILE_COORD(12,3)
1166   04C9 CD 14 05            call    L_DISPLAY_OR_CLEAR_HELP						; Display or clear HELP!
1167   04CC             
1168   04CC             		; If bit 6 of ANIMATION_TIMER is 0, jump ahead
1169   04CC CB 71               bit     6,c
1170   04CE CA 09 05            jp      z,l0509
1171   04D1             
1172   04D1             		; If Mario is right of center, jump ahead
1173   04D1 3A 03 62            ld      a,(MARIO_X)
1174   04D4 FE 80               cp      128
1175   04D6 D2 F1 04            jp      nc,l04f1
1176   04D9             
1177   04D9             		; Mario is left of center, so face Pauline left and display the HELP! tiles to Pauline's left
1178   04D9 3E DF               ld      a,$df						; Last of the three HELP! tiles
1179   04DB 21 23 76            ld      hl,TILE_COORD(17,3)
1180   04DE CD 14 05            call    L_DISPLAY_OR_CLEAR_HELP						; Display HELP!
1181   04E1 3A 01 69    l04e1:  ld      a,(PAULINE_UPPER_SPRITE_NUM)	; Face pauline left
1182   04E4 F6 80               or      %10000000
1183   04E6 32 01 69            ld      (PAULINE_UPPER_SPRITE_NUM),a
1184   04E9 3A 05 69            ld      a,(PAULINE_LOWER_SPRITE_NUM)
1185   04EC F6 80               or      %10000000
1186   04EE C3 AC 04            jp      l04ac						; Animate Pauline
1187   04F1             
1188   04F1             		; Mario is right of center, so face Pauline right and display the HELP! tiles to Pauline's right
1189   04F1 3E EF       l04f1:  ld      a,$ef						; Last of the three HELP! tiles
1190   04F3 21 83 75            ld      hl,TILE_COORD(12,3)
1191   04F6 CD 14 05            call    L_DISPLAY_OR_CLEAR_HELP						; Display HELP!
1192   04F9 3A 01 69    l04f9:  ld      a,(PAULINE_UPPER_SPRITE_NUM)
1193   04FC E6 7F               and     %01111111
1194   04FE 32 01 69            ld      (PAULINE_UPPER_SPRITE_NUM),a
1195   0501 3A 05 69            ld      a,(PAULINE_LOWER_SPRITE_NUM)
1196   0504 E6 7F               and     %01111111
1197   0506 C3 AC 04            jp      l04ac						; Animate Pauline
1198   0509             
1199   0509             		; If Mario is right of center, face Pauline right
1200   0509 3A 03 62    l0509:  ld      a,(MARIO_X)
1201   050C FE 80               cp      128
1202   050E D2 F9 04            jp      nc,l04f9
1203   0511             
1204   0511             		; If Mario is left of center, face Pauline left
1205   0511 C3 E1 04            jp      l04e1
1206   0514             ;------------------------------------------------------------------------------
1207   0514             
1208   0514             
1209   0514             
1210   0514             ;------------------------------------------------------------------------------
1211   0514             ; Display or clear the HELP! tiles to Pauline's left or right
1212   0514             ; passed:	a - the last tile of a 3 tile set 
1213   0514             ;				($10 to clear the tiles, or $df or $ef to display HELP!)
1214   0514             ;			hl - the right-most screen coordinate for the set of 3 tiles
1215   0514             ;			de - 32 to move left 1 column before displaying the next tile
1216   0514             L_DISPLAY_OR_CLEAR_HELP:  
1217   0514 06 03       		ld      b,3							; b = 3 to 1
1218   0516 77          l0516:  ld      (hl),a						; Display the current tile
1219   0517 19                  add     hl,de						; Move left one column
1220   0518 3D                  dec     a							; Decrement the tile
1221   0519 10 FB               djnz    l0516						; Next b
1222   051B C9                  ret     
1223   051C             ;------------------------------------------------------------------------------
1224   051C             
1225   051C             
1226   051C             
1227   051C             ;------------------------------------------------------------------------------
1228   051C             ; Award points to the player
1229   051C             ; passed:  a - the points award table entry number of the points to award
1230   051C             L_AWARD_POINTS:  
1231   051C 4F          		ld      c,a
1232   051D CF                  rst     $08							; Return if in attract mode
1233   051E             
1234   051E             		; Get pointer to the current playe's score in de
1235   051E CD 5F 05            call    L_GET_PLAYER_SCORE
1236   0521             
1237   0521             		; Convert the point table entry number to a table offset
1238   0521 79                  ld      a,c
1239   0522 81                  add     a,c
1240   0523 81                  add     a,c
1241   0524 4F                  ld      c,a
1242   0525             
1243   0525             		; Get pointer to the table entry
1244   0525 21 9B 34            ld      hl,L_POINT_AWARD_TABLE
1245   0528 06 00               ld      b,$00
1246   052A 09                  add     hl,bc
1247   052B             
1248   052B             		; Add the points to the player's score
1249   052B A7                  and     a
1250   052C 06 03               ld      b,3							; For b = 3 to 1
1251   052E 1A          l052e:  ld      a,(de)
1252   052F 8E                  adc     a,(hl)
1253   0530 27                  daa     
1254   0531 12                  ld      (de),a
1255   0532 13                  inc     de
1256   0533 23                  inc     hl
1257   0534 10 F8               djnz    l052e						; Next b
1258   0536             
1259   0536             		; Display the current player's score
1260   0536 D5                  push    de
1261   0537 1B                  dec     de
1262   0538 3A 0D 60            ld      a,(CURRENT_PLAYER)
1263   053B CD 6B 05            call    L_DISPLAY_PLAYER_SCORE
1264   053E             
1265   053E             		; Check if the player's score is higher than the high score
1266   053E D1                  pop     de
1267   053F 1B                  dec     de
1268   0540 21 BA 60            ld      hl,PREV_HIGH_SCORE+2
1269   0543 06 03               ld      b,3							; For b = 3 to 1
1270   0545 1A          l0545:  ld      a,(de)
1271   0546 BE                  cp      (hl)
1272   0547 D8                  ret     c
1273   0548             		; If the score is higher, jump ahead
1274   0548 C2 50 05            jp      nz,l0550
1275   054B 1B                  dec     de
1276   054C 2B                  dec     hl
1277   054D 10 F6               djnz    l0545						; Next b
1278   054F C9                  ret
1279   0550             
1280   0550             		; Replace the high score with player's score
1281   0550 CD 5F 05    l0550:  call    L_GET_PLAYER_SCORE
1282   0553 21 B8 60            ld      hl,PREV_HIGH_SCORE
1283   0556 1A          l0556:  ld      a,(de)
1284   0557 77                  ld      (hl),a
1285   0558 13                  inc     de
1286   0559 23                  inc     hl
1287   055A 10 FA               djnz    l0556						; Next b
1288   055C C3 DA 05            jp      l05da						; Display the high score
1289   055F             ;------------------------------------------------------------------------------
1290   055F             
1291   055F             
1292   055F             
1293   055F             ;------------------------------------------------------------------------------
1294   055F             ; Return the current player's stored score
1295   055F             ; Return:  de - PREV_P1_SCORE or PREV_P2_SCORE
1296   055F             ;          a - CURRENT_PLAYER
1297   055F             L_GET_PLAYER_SCORE:  
1298   055F 11 B2 60    		ld      de,PREV_P1_SCORE
1299   0562 3A 0D 60            ld      a,(CURRENT_PLAYER)
1300   0565 A7                  and     a
1301   0566 C8                  ret     z
1302   0567 11 B5 60            ld      de,PREV_P2_SCORE
1303   056A C9                  ret     
1304   056B             ;------------------------------------------------------------------------------
1305   056B             
1306   056B             
1307   056B             
1308   056B             ;------------------------------------------------------------------------------
1309   056B             ; Display the player's score (0 for player 1, or 1 for player 2)
1310   056B             ; pssed:  a - the player number (0 = player 1, 1 = player 2)
1311   056B             ;         de - pointer to player's score:  
1312   056B             L_DISPLAY_PLAYER_SCORE:
1313   056B             		; Determine the screen coordinate to display the score at
1314   056B DD 21 81 77 		ld      ix,TILE_COORD(28,1)
1315   056F A7                  and     a
1316   0570 28 0A               jr      z,L_DISPLAY_HIGH_SCORE_2
1317   0572 DD 21 21 75         ld      ix,TILE_COORD(9,1)
1318   0576 18 04               jr      L_DISPLAY_HIGH_SCORE_2
1319   0578             
1320   0578             		; Get the screen coordinate to display the high score at
1321   0578             L_DISPLAY_HIGH_SCORE:  
1322   0578 DD 21 41 76 		ld      ix,TILE_COORD(18,1)
1323   057C             
1324   057C EB          L_DISPLAY_HIGH_SCORE_2:  ex      de,hl
1325   057D 11 E0 FF            ld      de,-32
1326   0580 01 04 03            ld      bc,$0304					; For b = 3 to 1
1327   0583             
1328   0583             		; Display each digit of the score
1329   0583 7E          l0583:  ld      a,(hl)
1330   0584 0F                  rrca    
1331   0585 0F                  rrca    
1332   0586 0F                  rrca    
1333   0587 0F                  rrca    
1334   0588 CD 93 05            call    L_DISPLAY_SCORE_DIGIT
1335   058B 7E                  ld      a,(hl)
1336   058C CD 93 05            call    L_DISPLAY_SCORE_DIGIT
1337   058F 2B                  dec     hl
1338   0590 10 F1               djnz    l0583					; Next b
1339   0592 C9                  ret     
1340   0593             ;------------------------------------------------------------------------------
1341   0593             
1342   0593             
1343   0593             
1344   0593             ;------------------------------------------------------------------------------
1345   0593             ; Display one digit of the score and move 1 column to the right
1346   0593             ; passed:  a - digit to display in BCD.  Only the least-significant nibble is looked at.
1347   0593             ;          de - -32
1348   0593             ;          ix - the screen coordinate to display at
1349   0593             L_DISPLAY_SCORE_DIGIT:  
1350   0593 E6 0F       		and     %00001111
1351   0595 DD 77 00            ld      (ix+0),a
1352   0598 DD 19               add     ix,de
1353   059A C9                  ret     
1354   059B             ;------------------------------------------------------------------------------
1355   059B             
1356   059B             
1357   059B             
1358   059B             ;------------------------------------------------------------------------------
1359   059B             ; Zero-out scores
1360   059B             ; passed: A - score ID
1361   059B             ;             (0 = player 1, 
1362   059B             ;              1 = player 2,
1363   059B             ;              2 = high score,
1364   059B             ;              3 = all scores)
1365   059B             L_ZERO_SCORES:
1366   059B             		; If a is 3, jump ahead to zero all scores
1367   059B FE 03       		cp      3
1368   059D D2 BD 05    		jp      nc,l05bd
1369   05A0             
1370   05A0             		; Get the address of the requested score
1371   05A0 F5          		push    af
1372   05A1 21 B2 60    		ld      hl,PREV_P1_SCORE
1373   05A4 A7          		and     a
1374   05A5 CA AB 05    		jp      z,l05ab
1375   05A8 21 B5 60    		ld      hl,PREV_P2_SCORE
1376   05AB FE 02       l05ab:  cp      2
1377   05AD C2 B3 05    		jp      nz,l05b3
1378   05B0 21 B8 60    		ld      hl,PREV_HIGH_SCORE
1379   05B3             
1380   05B3             		; Zero the selected score
1381   05B3 AF          l05b3:  xor     a
1382   05B4 77          		ld      (hl),a
1383   05B5 23          		inc     hl
1384   05B6 77          		ld      (hl),a
1385   05B7 23          		inc     hl
1386   05B8 77          		ld      (hl),a
1387   05B9 F1          		pop     af
1388   05BA C3 C6 05    		jp      L_DISPLAY_SCORES
1389   05BD             
1390   05BD             		; Zero each score in turn
1391   05BD             		; (High score, player 2, player 1)
1392   05BD 3D          l05bd:  dec	 a
1393   05BE F5          		push    af
1394   05BF CD 9B 05    		call    L_ZERO_SCORES
1395   05C2 F1          		pop     af
1396   05C3 C8          		ret     z
1397   05C4 18 F7       		jr      l05bd
1398   05C6             ;------------------------------------------------------------------------------
1399   05C6             
1400   05C6             
1401   05C6             
1402   05C6             ;------------------------------------------------------------------------------
1403   05C6             ; Display scores
1404   05C6             ; passed: A - score ID
1405   05C6             ;             (0 = player 1, 
1406   05C6             ;              1 = player 2,
1407   05C6             ;              2 = high score,
1408   05C6             ;              3 = all scores)
1409   05C6             L_DISPLAY_SCORES:  		
1410   05C6             		; If a is 3, jump ahead to display all scores
1411   05C6 FE 03       		cp	  3
1412   05C8 CA E0 05    		jp      z,l05e0
1413   05CB 11 B4 60    l05cb:  ld      de,PREV_P1_SCORE+2
1414   05CE A7                  and     a
1415   05CF CA D5 05            jp      z,l05d5
1416   05D2 11 B7 60            ld      de,PREV_P2_SCORE+2
1417   05D5 FE 02       l05d5:  cp      2
1418   05D7 C2 6B 05            jp      nz,L_DISPLAY_PLAYER_SCORE
1419   05DA 11 BA 60    l05da:  ld      de,PREV_HIGH_SCORE+2
1420   05DD             
1421   05DD             		; Display the score
1422   05DD C3 78 05            jp      L_DISPLAY_HIGH_SCORE
1423   05E0             
1424   05E0             		; Display each score in turn
1425   05E0             		; (High score, player 2, player 1)
1426   05E0 3D          l05e0:  dec     a
1427   05E1 F5                  push    af
1428   05E2 CD C6 05            call    L_DISPLAY_SCORES
1429   05E5 F1                  pop     af
1430   05E6 C8                  ret     z
1431   05E7 18 F7               jr      l05e0
1432   05E9             ;------------------------------------------------------------------------------
1433   05E9             
1434   05E9             
1435   05E9             
1436   05E9             ;------------------------------------------------------------------------------
1437   05E9             ; Display a string from the string table
1438   05E9             ; passed: a - string table entry number
1439   05E9             ;			if the entry number is negative, the string is erased
1440   05E9             L_DISPLAY_STRING:  
1441   05E9             		; Look up the string address in the string table
1442   05E9 21 BD 35    		ld      hl,L_STRING_TABLE
1443   05EC 87                  add     a,a
1444   05ED F5                  push    af
1445   05EE E6 7F               and     %01111111
1446   05F0 5F                  ld      e,a
1447   05F1 16 00               ld      d,$00
1448   05F3 19                  add     hl,de
1449   05F4 5E                  ld      e,(hl)
1450   05F5 23                  inc     hl
1451   05F6 56                  ld      d,(hl)
1452   05F7 EB                  ex      de,hl
1453   05F8             
1454   05F8             		; Get the screen coordinate of the string
1455   05F8 5E                  ld      e,(hl)
1456   05F9 23                  inc     hl
1457   05FA 56                  ld      d,(hl)
1458   05FB 23                  inc     hl
1459   05FC             
1460   05FC             		; Display each character in the string 
1461   05FC             		; (string ends when $3f is found)
1462   05FC 01 E0 FF            ld      bc,-32
1463   05FF EB                  ex      de,hl
1464   0600 1A          l0600:  ld      a,(de)
1465   0601 FE 3F               cp      $3f
1466   0603 CA 26 00            jp      z,l0026
1467   0606 77                  ld      (hl),a
1468   0607 F1                  pop     af
1469   0608             		
1470   0608             		; If the string is to be erased, display a space instead
1471   0608 30 02               jr      nc,l060c
1472   060A 36 10               ld      (hl),$10
1473   060C             
1474   060C             		; Move to the next character
1475   060C F5          l060c:  push    af
1476   060D 13                  inc     de
1477   060E 09                  add     hl,bc
1478   060F 18 EF               jr      l0600
1479   0611             ;------------------------------------------------------------------------------
1480   0611             
1481   0611             
1482   0611             
1483   0611             ;------------------------------------------------------------------------------
1484   0611             ; Display the number of plays that have been paid for
1485   0611             L_DISPLAY_CREDITS:  
1486   0611             		; Return if no coins have been inserted
1487   0611 3A 07 60    		ld      a,(NO_COINS_INSERTED)
1488   0614 0F                  rrca    
1489   0615 D0                  ret     nc
1490   0616             		
1491   0616             		; Display the number of credits paid for
1492   0616             L_DISPLAY_CREDITS_2:  
1493   0616 3E 05       		ld      a,5
1494   0618 CD E9 05            call    L_DISPLAY_STRING
1495   061B 21 01 60            ld      hl,NUM_PLAYS
1496   061E 11 E0 FF            ld      de,-32
1497   0621 DD 21 BF 74         ld      ix,TILE_COORD(5, 31)
1498   0625 06 01               ld      b,1
1499   0627             		; Use the score display code to display the number of credits
1500   0627 C3 83 05            jp      l0583
1501   062A             ;------------------------------------------------------------------------------
1502   062A             
1503   062A             
1504   062A             
1505   062A             ;------------------------------------------------------------------------------
1506   062A             ; Process the timer either initializing it, displaying it, or adding it to
1507   062A             ; the player's score.
1508   062A             ; passed:	a - 0: Add the timer to the player's score without displaying it
1509   062A             ;				1: Simply display the timer
1510   062A             L_PROCESS_TIMER:  
1511   062A             		; If a = 0, jump ahead to add the timer to the player's score
1512   062A A7          		and     a
1513   062B CA 91 06            jp      z,l0691
1514   062E             		
1515   062E             		; If ONSCREEN_TIMER is not reached 0, jump ahead
1516   062E 3A 8C 63            ld      a,(ONSCREEN_TIMER)
1517   0631 A7                  and     a
1518   0632 C2 A8 06            jp      nz,l06a8
1519   0635             		
1520   0635             		; Return unless the timer is 0 because it hasn't been initialized yet
1521   0635 3A B8 63            ld      a,(TIMER_HAS_RUN_DOWN)
1522   0638 A7                  and     a
1523   0639 C0                  ret     nz
1524   063A             		
1525   063A             		; Convert the hex timer number to hex BCD for display
1526   063A 3A B0 62            ld      a,(INTERNAL_TIMER)
1527   063D 01 0A 00            ld      bc,$000a
1528   0640             		
1529   0640             		; Determine the number of 10's in the timer
1530   0640             		; (Because the displayed timer counts down by 100's, this will be
1531   0640             		; displayed as the 1,000's digit)
1532   0640 04          l0640:  inc     b
1533   0641 91                  sub     c
1534   0642 C2 40 06            jp      nz,l0640
1535   0645 78                  ld      a,b
1536   0646             		
1537   0646             		; Shift the digit to the most-significant nibble in store in the onscreen timer
1538   0646 07                  rlca    
1539   0647 07                  rlca    
1540   0648 07                  rlca    
1541   0649 07                  rlca    
1542   064A 32 8C 63            ld      (ONSCREEN_TIMER),a
1543   064D             		
1544   064D             		; Display the timer box
1545   064D 21 BC 37            ld      hl,L_TIMER_BOX_TILE_DATA
1546   0650 11 65 74            ld      de,TILE_COORD(3, 5)
1547   0653 3E 06               ld      a,6							; For a = 6 to 1
1548   0655 DD 21 1D 00 l0655:  ld      ix,29
1549   0659 01 03 00            ld      bc,3						; 3 bytes of data to display
1550   065C ED B0               ldir    
1551   065E DD 19               add     ix,de						; Advance to the next column
1552   0660 DD E5               push    ix
1553   0662 D1                  pop     de							; Load ix into de
1554   0663 3D                  dec     a							
1555   0664 C2 55 06            jp      nz,l0655					; Next a
1556   0667             		
1557   0667             		; Determine the number of 1's in the timer
1558   0667             		; (Because the displayed timer counts down by 100's, this will be
1559   0667             		; displayed as the 100's digit)
1560   0667 3A 8C 63            ld      a,(ONSCREEN_TIMER)
1561   066A 4F          l066a:  ld      c,a
1562   066B E6 0F               and     %00001111
1563   066D 47                  ld      b,a
1564   066E             		
1565   066E             		; If the timer is greater than or equal to 1,000, then jump ahead to
1566   066E             		; skip the time running out warning
1567   066E 79                  ld      a,c
1568   066F 0F                  rrca    
1569   0670 0F                  rrca    
1570   0671 0F                  rrca    
1571   0672 0F                  rrca    
1572   0673 E6 0F               and     %00001111
1573   0675 C2 89 06            jp      nz,l0689
1574   0678             		
1575   0678             		; Trigger the time running out warning sound
1576   0678 3E 03               ld      a,SONG_TRIGGER_OUT_OF_TIME
1577   067A 32 89 60            ld      (SONG_TRIGGER),a
1578   067D             		
1579   067D             		; Display the last two '0's of the timer in red
1580   067D 3E 70               ld      a,$70						; Red '0'
1581   067F 32 86 74            ld      (TILE_COORD(4,6)),a			; 1's digit of displayed score
1582   0682 32 A6 74            ld      (TILE_COORD(5,6)),a			; 10's digit of displayed score
1583   0685             
1584   0685             		; Clear the 1,000's digit and display the 100's digit in red
1585   0685 80                  add     a,b
1586   0686 47                  ld      b,a
1587   0687 3E 10               ld      a,$10						; ' '
1588   0689             		
1589   0689             		; Display the 1,000's digit			
1590   0689 32 E6 74    l0689:  ld      (TILE_COORD(7,6)),a			; 1,000's digit of displayed score
1591   068C             
1592   068C             		; Display the 100's digit
1593   068C 78                  ld      a,b
1594   068D 32 C6 74            ld      (TILE_COORD(6,6)),a			; 100's digit of displayed score
1595   0690 C9                  ret     
1596   0691             
1597   0691             		; Award the 100's points to the player
1598   0691 3A 8C 63    l0691:  ld      a,(ONSCREEN_TIMER)
1599   0694 47                  ld      b,a
1600   0695 E6 0F               and     %00001111
1601   0697 C5                  push    bc
1602   0698 CD 1C 05            call    L_AWARD_POINTS
1603   069B C1                  pop     bc
1604   069C             		
1605   069C             		; Award the 1000's points to the player
1606   069C 78                  ld      a,b
1607   069D 0F                  rrca    
1608   069E 0F                  rrca    
1609   069F 0F                  rrca    
1610   06A0 0F                  rrca    
1611   06A1 E6 0F               and     %00001111
1612   06A3 C6 0A               add     a,10
1613   06A5 C3 1C 05            jp      L_AWARD_POINTS
1614   06A8             		
1615   06A8             		; Decrement the timer
1616   06A8 D6 01       l06a8:  sub     1
1617   06AA             
1618   06AA             		; If the timer has not reached 0, then skip ahead
1619   06AA 20 05               jr      nz,l06b1
1620   06AC             		
1621   06AC             		; Indicate that the timer is 0 because it has run down, not that it
1622   06AC             		; needs to be initialized
1623   06AC 21 B8 63            ld      hl,TIMER_HAS_RUN_DOWN
1624   06AF 36 01               ld      (hl),1
1625   06B1             		
1626   06B1             		; Resave the onscreen timer and jump back up to display it
1627   06B1 27          l06b1:  daa     
1628   06B2 32 8C 63            ld      (ONSCREEN_TIMER),a
1629   06B5 C3 6A 06            jp      l066a
1630   06B8             ;------------------------------------------------------------------------------
1631   06B8             
1632   06B8             
1633   06B8             
1634   06B8             ;------------------------------------------------------------------------------
1635   06B8             ; Display the number of lives and the current level number
1636   06B8             ; passed:	a - The number of lives to subtract before the lives are displayed
1637   06B8             L_DISPLAY_LIVES_AND_LEVEL:  
1638   06B8 4F          		ld      c,a
1639   06B9 CF                  rst     $08							; Return if attract mode is not active
1640   06BA             
1641   06BA             		; Blank (28,3)-(22,3)
1642   06BA 06 06               ld      b,6							; For b = 6 to 1
1643   06BC 11 E0 FF            ld      de,-32						
1644   06BF 21 83 77            ld      hl,TILE_COORD(28,3)
1645   06C2 36 10       l06c2:  ld      (hl),$10					; Display ' '
1646   06C4 19                  add     hl,de						; Move 1 column right
1647   06C5 10 FB               djnz    l06c2						; Next b
1648   06C7             
1649   06C7             		; Subtract a life if a = 1
1650   06C7 3A 28 62            ld      a,(CP_NUMBER_LIVES)
1651   06CA 91                  sub     c
1652   06CB             
1653   06CB CA D7 06            jp      z,l06d7						; If there are no lives left, jump ahead
1654   06CE             
1655   06CE             		; Display the number of lives
1656   06CE 47                  ld      b,a							; For b = number of lives to 1
1657   06CF 21 83 77            ld      hl,TILE_COORD(28,3)
1658   06D2 36 FF       l06d2:  ld      (hl),$ff					; Display the life icon
1659   06D4 19                  add     hl,de						; Move 1 column right
1660   06D5 10 FB               djnz    l06d2						; Next b
1661   06D7             
1662   06D7             		; Display "L="
1663   06D7 21 03 75    l06d7:  ld      hl,TILE_COORD(8,3)
1664   06DA 36 1C               ld      (hl),$1c					; Display 'L'
1665   06DC 21 E3 74            ld      hl,TILE_COORD(7,3)
1666   06DF 36 34               ld      (hl),$34					; Display '='
1667   06E1 3A 29 62            ld      a,(CP_LEVEL_NUMBER)
1668   06E4                     
1669   06E4             		; Limit level number to 99
1670   06E4 FE 64       		cp      100
1671   06E6 38 05               jr      c,l06ed
1672   06E8 3E 63               ld      a,99
1673   06EA 32 29 62            ld      (CP_LEVEL_NUMBER),a
1674   06ED             
1675   06ED             		; Convert the level number to 10's digit (in b) and 1's digit (in a)
1676   06ED 01 0A FF    l06ed:  ld      bc,$ff0a
1677   06F0 04          l06f0:  inc     b
1678   06F1 91                  sub     c
1679   06F2 D2 F0 06            jp      nc,l06f0
1680   06F5 81                  add     a,c
1681   06F6 32 A3 74            ld      (TILE_COORD(5,3)),a			; Display 1's digit
1682   06F9 78                  ld      a,b
1683   06FA 32 C3 74            ld      (TILE_COORD(6,3)),a			; Display 10's digit
1684   06FD C9                  ret     
1685   06FE             ;------------------------------------------------------------------------------
1686   06FE             
1687   06FE             
1688   06FE             
1689   06FE             ;------------------------------------------------------------------------------
1690   06FE             ; Called when the GAME_STATE == 3 (player is playing)
1691   06FE             ; Jump to one of the following table entries based on the current game screen
1692   06FE             L_IMPLEMENT_GAME_PLAY:  
1693   06FE 3A 0A 60    		ld      a,(GAME_SUBSTATE)
1694   0701 EF                  rst     $28							; Jump to local table address
1695   0702             		; Jump table
1696   0702 85 09       		.word	L_ORIENT_SCREEN	; 0 = orient the screen
1697   0704 AA 09       		.word	L_INIT_P1	; 1 = initialize player 1
1698   0706 D5 09       		.word	L_P1_PROMPT_SCREEN	; 2 = display player 1 prompt
1699   0708 FD 09       		.word	L_INIT_P2	; 3 = intialize player 2
1700   070A 1A 0A       		.word	L_P2_PROMPT_SCREEN	; 4 = display player 2 prompt
1701   070C 36 0A       		.word	L_DISPLAY_TURN_DATA	; 5 = display data for this turn
1702   070E 62 0A       		.word	L_PREPARE_SCREEN_FOR_TURN	; 6 = trigger introduction or intermission
1703   0710 75 0A       		.word	L_IMPLEMENT_INTRO_STAGE	; 7 = show introduction stage
1704   0712 D8 0B       		.word	L_DISPLAY_INTERMISSION	; 8 = show intermission
1705   0714 00 00       		.word	L_ORG	; 9 = reset game
1706   0716 8E 0C       		.word	L_DISPLAY_CURRENT_STAGE	; 10 = display current stage
1707   0718 2E 12       		.word	L_INIT_MARIO	; 11 = initialize Mario sprite
1708   071A 6B 19       		.word	L_RUN_GAME	; 12 = run game
1709   071C 6E 12       		.word	L_IMPLEMENT_DEATH_ANIM	; 13 = display Mario death animation
1710   071E E4 12       		.word	L_POST_DEATH_PROCESSING_P1	; 14 = end turn player 1
1711   0720 36 13       		.word	L_POST_DEATH_PROCESSING_P2	; 15 = end turn player 2
1712   0722 81 13       		.word	L_ADV_FROM_P1_GAME_OVER	; 16 = start player 2 or end the game
1713   0724 93 13       		.word	L_ADV_FROM_P2_GAME_OVER	; 17 = start player 1 or end the game
1714   0726 9C 13       		.word	L_PREPARE_FOR_P2_TURN	; 18 = activate player 2
1715   0728 AD 13       		.word	L_PREPARE_FOR_P1_TURN	; 19 = activate player 1
1716   072A 10 14       		.word	L_CHECK_FOR_HS_INITIALS	; 20 = check for high scores
1717   072C 78 14       		.word	L_IMPLEMENT_HS_INITIAL_ENTRY	; 21 = get initials for high scores
1718   072E 07 16       		.word	L_IMPLEMENT_STAGE_WIN_ANIM	; 22 = show win animation for barrels, mixer, and elevator stages
1719   0730 5C 19       		.word	L_PREP_FOR_NEXT_PLAYER	; 23 = activate next player
1720   0732 00 00       		.word	L_ORG	; 24 = reset game
1721   0734 00 00       		.word	L_ORG	; 25 = reset game
1722   0736 00 00       		.word	L_ORG	; 26 = reset game
1723   0738 00 00       		.word	L_ORG	; 27 = reset game
1724   073A 00 00       		.word	L_ORG	; 28 = reset game
1725   073C             ;------------------------------------------------------------------------------
1726   073C             
1727   073C             
1728   073C             
1729   073C             ;------------------------------------------------------------------------------
1730   073C             ; Called when GAME_STATE == 1 (attract mode)
1731   073C             ; If credits have been paid for, just wait for the player to push start, otherwise
1732   073C             ; run through the attract sequence.
1733   073C             L_IMPLEMENT_ATTRACT_MODE: 	
1734   073C 21 0A 60    		ld      hl,GAME_SUBSTATE
1735   073F 3A 01 60    		ld      a,(NUM_PLAYS)
1736   0742 A7                  and     a
1737   0743 C2 5C 07    		jp		nz,L_PROMPT_FOR_START					; If coins have been entered, just show the start prompt
1738   0746 7E          		ld		a,(hl)
1739   0747 EF          		rst		$28
1740   0748             		; Jump table
1741   0748 79 07       		.word	L_INSERT_COINS_SCREEN ; 0 = display insert coin screen
1742   074A 63 07       		.word	L_PREPARE_DEMO_MODE ; 1 = prepare for attract mode
1743   074C 2E 12       		.word	L_INIT_MARIO ; 2 = initialize Mario sprite
1744   074E 68 19       		.word	L_RUN_GAME_DEMO ; 3 = run demo
1745   0750 6E 12       		.word	L_IMPLEMENT_DEATH_ANIM ; 4 = display Mario death animation
1746   0752 C3 07       		.word	L_CLEAN_UP_DEMO_MODE ; 5 = clear the screen
1747   0754 CB 07       		.word	L_FLASH_DK_TITLE_SCREEN ; 6 = display the title screen with "DONKEY KONG" letters and cycle the palette
1748   0756 4A 08       		.word	L_FREEZE_DK_TITLE_SCREEN ; 7 = display the title screen until it times out
1749   0758 00 00       		.word	L_ORG ; 8 = reset game
1750   075A 00 00       		.word	L_ORG ; 9 = reset game
1751   075C             ;------------------------------------------------------------------------------
1752   075C             
1753   075C             		
1754   075C             		
1755   075C             ;------------------------------------------------------------------------------
1756   075C             ; Prompt the player to push start
1757   075C             ; passed - hl - GAME_SUBSTATE
1758   075C             L_PROMPT_FOR_START:  
1759   075C 36 00       		ld      (hl),$00					; Set GAME_SUBSTATE to 0
1760   075E 21 05 60            ld      hl,GAME_STATE
1761   0761 34                  inc     (hl)						; GAME_STATE = 2 (waiting for player to push start)
1762   0762 C9                  ret     
1763   0763             ;------------------------------------------------------------------------------
1764   0763             
1765   0763             
1766   0763             
1767   0763             ;------------------------------------------------------------------------------
1768   0763             ; Prepare for the demonstration mode by setting the stage, level and number of
1769   0763             ; lives, and displaying the stage.
1770   0763             L_PREPARE_DEMO_MODE:  
1771   0763             		; Return until the timers decrement to 0
1772   0763 E7          		rst     $20						
1773   0764                     
1774   0764             		; Clear $6392 and the fireball release trigger
1775   0764 AF          		xor     a
1776   0765 32 92 63            ld      ($6392),a
1777   0768 32 A0 63            ld      (RELEASE_A_FIREBALL),a
1778   076B             
1779   076B             		; Demo occurs on barrels stage, level 1 with 1 life
1780   076B 3E 01               ld      a,1
1781   076D 32 27 62            ld      (CURRENT_STAGE),a
1782   0770 32 29 62            ld      (CP_LEVEL_NUMBER),a
1783   0773 32 28 62            ld      (CP_NUMBER_LIVES),a
1784   0776             
1785   0776             		; Display and initialize the current stage
1786   0776 C3 8F 0C            jp      L_DISPLAY_CURRENT_STAGE_2
1787   0779             ;------------------------------------------------------------------------------
1788   0779             
1789   0779             
1790   0779             
1791   0779             ;------------------------------------------------------------------------------
1792   0779             ; Display the initial screen in attract mode.  The string "INSERT COIN" is shown
1793   0779             ; and the number of coins required for 1 and 2 players is also displayed.  The
1794   0779             ; previous game's score(s) is shown as well.
1795   0779             L_INSERT_COINS_SCREEN:  
1796   0779             		; Initialize pallette to 00
1797   0779 21 86 7D    		ld      hl,PALETTE_1_OUTPUT						
1798   077C 36 00               ld      (hl),$00
1799   077E 23                  inc     hl
1800   077F 36 00               ld      (hl),$00
1801   0781             		
1802   0781 11 1B 03    		ld      de,$031b
1803   0784 CD 22 30            call    L_ADD_EVENT				; Display "INSERT COIN"
1804   0787 1C                  inc     e
1805   0788 CD 22 30            call    L_ADD_EVENT				; Display "  PLAYER    COIN"
1806   078B CD 64 09            call    L_DISPLAY_HIGH_SCORES
1807   078E             
1808   078E             		; Set MINOR_TIMER to 2
1809   078E 21 09 60            ld      hl,MINOR_TIMER
1810   0791 36 02               ld      (hl),2
1811   0793             		
1812   0793             		; Set GAME_SUBSTATE to 1 (initializing the attract mode)
1813   0793 23                  inc     hl
1814   0794 34                  inc     (hl)
1815   0795             		
1816   0795             		; Clear the game section of the screen and display "1UP"
1817   0795 CD 73 08            call    L_CLEAR_STAGE_SCREEN
1818   0798 CD 52 0A            call    L_DISPLAY_1UP
1819   079B             		
1820   079B             		; If the last game had two players, then display "2UP" as well
1821   079B 3A 0F 60            ld      a,(TWO_PLAYERS)
1822   079E FE 01               cp      1
1823   07A0 CC ED 09            call    z,L_DISPLAY_2UP		
1824   07A3             		
1825   07A3             		; Display the number of coins required for 1 player to play
1826   07A3 ED 5B 22 60         ld      de,(NUM_COINS_FOR_1P)
1827   07A7 21 6C 75            ld      hl,TILE_COORD(11,12)
1828   07AA CD AD 07            call    l07ad
1829   07AD             		
1830   07AD             		; Display e at the tile address in hl and d in the next row down
1831   07AD 73          l07ad:  ld      (hl),e
1832   07AE 23                  inc     hl
1833   07AF 23                  inc     hl
1834   07B0 72                  ld      (hl),d
1835   07B1 7A                  ld      a,d
1836   07B2             		; If the coins required for two players >= 10, then display both digits
1837   07B2 D6 0A               sub     10
1838   07B4 C2 BC 07            jp      nz,l07bc
1839   07B7 77                  ld      (hl),a
1840   07B8 3C                  inc     a
1841   07B9 32 8E 75            ld      (TILE_COORD(12,14)),a
1842   07BC             		
1843   07BC             		; Display '1' and '2' for 1 and 2 players
1844   07BC 11 01 02    l07bc:  ld      de,$0201
1845   07BF 21 8C 76            ld      hl,TILE_COORD(20,12)
1846   07C2 C9                  ret     
1847   07C3             ;------------------------------------------------------------------------------
1848   07C3             
1849   07C3             
1850   07C3             
1851   07C3             ;------------------------------------------------------------------------------
1852   07C3             ; Clean up the demonstration mode by clearing the stage tiles and advancing to 
1853   07C3             ; the next substate
1854   07C3             L_CLEAN_UP_DEMO_MODE:  
1855   07C3 CD 73 08    		call    L_CLEAR_STAGE_SCREEN
1856   07C6             		
1857   07C6             		; Attract mode substate = 6
1858   07C6 21 0A 60            ld      hl,GAME_SUBSTATE
1859   07C9 34                  inc     (hl)
1860   07CA C9                  ret     
1861   07CB             ;------------------------------------------------------------------------------
1862   07CB             
1863   07CB             
1864   07CB             
1865   07CB             ;------------------------------------------------------------------------------
1866   07CB             ; Display the DONKEY KONG title screen
1867   07CB             ; The palette is cycled to make the screen flash excitingly
1868   07CB             L_FLASH_DK_TITLE_SCREEN:  
1869   07CB             		; If the palette cycle counter has already been initialized, jump ahead
1870   07CB 3A 8A 63    		ld      a,(TITLE_PALETTE_CYCLE_COUNTER)
1871   07CE FE 00               cp      0
1872   07D0 C2 2C 08            jp      nz,l082d
1873   07D3             		
1874   07D3             		; Initialize the palette cycle counter to 96 
1875   07D3 3E 60               ld      a,96
1876   07D5 32 8A 63            ld      (TITLE_PALETTE_CYCLE_COUNTER),a
1877   07D8             
1878   07D8             		; Set the palette cycle pattern
1879   07D8 0E 5F               ld      c,%01011111
1880   07DA             
1881   07DA             		; If the palette cycle counter has reached zero, then advance to the next
1882   07DA             		; submode
1883   07DA FE 00       l07da:  cp      0
1884   07DC CA 3A 08            jp      z,l083b
1885   07DF             		
1886   07DF             		; Rotate the palette and set PALETTE_1_OUTPUT to the previous value of bit 7
1887   07DF 21 86 7D            ld      hl,PALETTE_1_OUTPUT
1888   07E2 36 00               ld      (hl),0
1889   07E4 79          		ld      a,c
1890   07E5 CB 07               rlc     a
1891   07E7 30 02               jr      nc,l07eb
1892   07E9 36 01               ld      (hl),1
1893   07EB             		
1894   07EB             		; Rotate the palette and set PALETTE_2_OUTPUT to the previous value of bit 7
1895   07EB 23          l07eb:  inc     hl
1896   07EC 36 00               ld      (hl),0
1897   07EE CB 07               rlc     a
1898   07F0 30 02               jr      nc,l07f4
1899   07F2 36 01               ld      (hl),1
1900   07F4             		
1901   07F4             		; Draw the large "DONKEY KONG" letters
1902   07F4 32 8B 63    l07f4:  ld      (TITLE_PALETTE_PATTERN),a
1903   07F7 21 7A 3C            ld      hl,L_LARGE_DK_LETTER_DATA
1904   07FA             		
1905   07FA             		; Draw one line of tiles
1906   07FA 3E B0       l07fa:  ld      a,$b0						; Girder tile with large round hole
1907   07FC 46          		ld      b,(hl)						; for b = the number of tiles to draw to 1
1908   07FD 23                  inc     hl
1909   07FE 5E                  ld      e,(hl)						; de = the first tile screen coordinate
1910   07FF 23                  inc     hl
1911   0800 56                  ld      d,(hl)
1912   0801 12          l0801:  ld      (de),a						; Display the rivet tile at the current coordinate
1913   0802 13                  inc     de							; Move down one row
1914   0803 10 FC               djnz    l0801						; Next b
1915   0805             		
1916   0805             		; If this is not the end of the letter data, then repeat
1917   0805 23                  inc     hl
1918   0806 7E                  ld      a,(hl)
1919   0807 FE 00               cp      $00
1920   0809 C2 FA 07            jp      nz,l07fa
1921   080C             		
1922   080C             		; Display "1981" and "NINTENDO OF AMERICA"
1923   080C 11 1E 03            ld      de,$031e
1924   080F CD 22 30            call    L_ADD_EVENT
1925   0812 13                  inc     de
1926   0813 CD 22 30            call    L_ADD_EVENT
1927   0816             		
1928   0816             		; Load Donkey Kong sprites
1929   0816 21 41 39            ld      hl,L_DK_SPRITES_GRIN_L_STOMP
1930   0819 CD 4E 00            call    L_LOAD_DK_SPRITES
1931   081C             		
1932   081C             		; Display "(TM)"
1933   081C CD 95 3E            call    L_DISPLAY_TM
1934   081F             		
1935   081F             		; Position and display Donkey Kong 
1936   081F 21 08 69            ld      hl,DK_SPRITE_1_X
1937   0822 0E 44               ld      c,68
1938   0824 FF                  rst     $38
1939   0825 21 0B 69            ld      hl,DK_SPRITE_1_Y
1940   0828 0E 78               ld      c,120
1941   082A FF                  rst     $38
1942   082B C9                  ret     
1943   082C             
1944   082C             		; Load the previous palette pattern
1945   082C 3A 8B 63    l082d:  ld      a,(TITLE_PALETTE_PATTERN)
1946   082F 4F                  ld      c,a
1947   0830             		
1948   0830             		; Decrement the cycle counter
1949   0830 3A 8A 63            ld      a,(TITLE_PALETTE_CYCLE_COUNTER)
1950   0833 3D                  dec     a
1951   0834 32 8A 63            ld      (TITLE_PALETTE_CYCLE_COUNTER),a
1952   0837             
1953   0837             		; Implement the palette cycling
1954   0837 C3 DA 07            jp      l07da
1955   083A             		
1956   083A             		; Clean up and move to the next substate
1957   083A 21 09 60    l083b:  ld      hl,MINOR_TIMER
1958   083D 36 02               ld      (hl),2					; Set MINOR_TIMER to 2
1959   083F 23                  inc     hl
1960   0840 34                  inc     (hl)						; Advance the substate
1961   0841 21 8A 63            ld      hl,TITLE_PALETTE_CYCLE_COUNTER
1962   0844 36 00               ld      (hl),0						; Set TITLE_PALETTE_CYCLE_COUNTER to 0
1963   0846 23                  inc     hl
1964   0847 36 00               ld      (hl),0						; Set TITLE_PALETTE_PATTERN to 0
1965   0849 C9                  ret     
1966   084A             ;------------------------------------------------------------------------------
1967   084A             
1968   084A             
1969   084A             
1970   084A             ;------------------------------------------------------------------------------
1971   084A             ; Pause on the DONKEY KONG title screen and then restart the attract mode
1972   084A             L_FREEZE_DK_TITLE_SCREEN:  
1973   084A             		; Return until the timers run down
1974   084A E7          		rst     $20
1975   084B             
1976   084B             		; Reset the attract mode substate to 0
1977   084B 21 0A 60            ld      hl,GAME_SUBSTATE
1978   084E 36 00               ld      (hl),0
1979   0850 C9                  ret     
1980   0851             ;------------------------------------------------------------------------------
1981   0851             
1982   0851             
1983   0851             
1984   0851             ;------------------------------------------------------------------------------
1985   0851             ; Clear the entire screen and all the sprite
1986   0851             L_CLEAR_SCREEN_AND_SPRITES:  
1987   0851             		; Clear the entire screen
1988   0851 21 00 74    		ld      hl,TILE_COORD(0,0)
1989   0854 0E 04               ld      c,4						; For c = 4 to 1
1990   0856 06 00       l0857:  ld      b,0						; For b = 256 to 1
1991   0858 3E 10               ld      a,$10					; ' '
1992   085A 77          l085b:  ld      (hl),a
1993   085B 23                  inc     hl
1994   085C 10 FC               djnz    l085b					; Next b
1995   085E 0D                  dec     c		
1996   085F C2 56 08            jp      nz,l0857				; Next c
1997   0862                     
1998   0862                     ; Clear all 96 sprites
1999   0862 21 00 69            ld      hl,SPRITE_STRUCTS
2000   0865 0E 02               ld      c,2						; For c = 2 to 1
2001   0867 06 C0       l0868:  ld      b,192					; For b = 192 to 1
2002   0869 AF                  xor     a
2003   086A 77          l086b:  ld      (hl),a					; 0 this sprite byte
2004   086B 23                  inc     hl
2005   086C 10 FC               djnz    l086b					; Next b
2006   086E 0D                  dec     c
2007   086F C2 67 08            jp      nz,l0868				; Next c
2008   0872 C9                  ret     
2009   0873             ;------------------------------------------------------------------------------
2010   0873             
2011   0873             
2012   0873             
2013   0873             ;------------------------------------------------------------------------------
2014   0873             ; Clear the screen tiles (all but the top 4 rows)
2015   0873             L_CLEAR_STAGE_SCREEN:  
2016   0873 21 04 74    		ld      hl,TILE_COORD(0,4)
2017   0876 0E 20               ld      c,32					; For c = 32 to 1 (32 columns)
2018   0878 06 1C       l0879:  ld      b,28					; For b = 28 to 1 (the lower 28 rows)
2019   087A 3E 10               ld      a,$10					; ' '
2020   087C 11 04 00            ld      de,4
2021   087F 77          l0880:  ld      (hl),a					; Clear this screen coord
2022   0880 23                  inc     hl						; Advance 1 row down
2023   0881 10 FC               djnz    l0880					; Next b
2024   0883 19                  add     hl,de					; Skip the top 4 rows
2025   0884 0D                  dec     c						
2026   0885 C2 78 08            jp      nz,l0879				; Next c
2027   0888             		
2028   0888             		; Clear (9,2) to (22,3)
2029   0888 21 22 75            ld      hl,TILE_COORD(9,2)
2030   088B 11 20 00            ld      de,32			
2031   088E 0E 02               ld      c,2						; For c = 2 to 1 (2 rows)
2032   0890 3E 10               ld      a,$10				
2033   0892 06 0E       l0893:  ld      b,14					; For b = 14 to 1
2034   0894 77          l0895:  ld      (hl),a					; Clear this screen coord
2035   0895 19                  add     hl,de					; Advance 1 column left
2036   0896 10 FC               djnz    l0895					; Next b
2037   0898 21 23 75            ld      hl,TILE_COORD(9,3)
2038   089B 0D                  dec     c						
2039   089C C2 92 08            jp      nz,l0893				; Next c
2040   089F             		
2041   089F             		; Clear sprites
2042   089F 21 00 69            ld      hl,SPRITE_STRUCTS
2043   08A2 06 00               ld      b,0
2044   08A4 3E 00               ld      a,0
2045   08A6 77          l08a7:  ld      (hl),a
2046   08A7 23                  inc     hl
2047   08A8 10 FC               djnz    l08a7
2048   08AA 06 80               ld      b,128
2049   08AC 77          l08ad:  ld      (hl),a
2050   08AD 23                  inc     hl
2051   08AE 10 FC               djnz    l08ad
2052   08B0             		
2053   08B0 C9                  ret     
2054   08B1             ;------------------------------------------------------------------------------
2055   08B1             
2056   08B1             
2057   08B1             
2058   08B1             ;------------------------------------------------------------------------------
2059   08B1             ; Game processing once a coin has been entered.  The attract mode no longer runs, 
2060   08B1             ; and the screen prompts the player to just push start already...
2061   08B1 3A 0A 60    L_WAITING_FOR_START_MODE:  ld      a,(GAME_SUBSTATE)
2062   08B4 EF                  rst     $28							; Jump to local table address
2063   08B5 B9 08               .word	L_DISPLAY_PUSH_START_SCREEN	; 0 = display start prompt
2064   08B7 F7 08       		.word	L_HANDLE_START_BUTTONS	; 1 = start 1 or 2 players
2065   08B9             ;------------------------------------------------------------------------------
2066   08B9             
2067   08B9             
2068   08B9             		
2069   08B9             ;------------------------------------------------------------------------------
2070   08B9             ; Display the "push 1 player" or "push 1 or 2 player" screen
2071   08B9             ; 
2072   08B9             ; passed:	none
2073   08B9             ; return:	the state of misc input in a
2074   08B9             L_DISPLAY_PUSH_START_SCREEN:  
2075   08B9 CD 73 08    		call    L_CLEAR_STAGE_SCREEN
2076   08BC             		
2077   08BC             		; Coins have been inserted
2078   08BC AF                  xor     a
2079   08BD 32 07 60            ld      (NO_COINS_INSERTED),a
2080   08C0                     
2081   08C0                     ; Display "PUSH"
2082   08C0 11 0C 03            ld      de,$030c
2083   08C3 CD 22 30            call    L_ADD_EVENT
2084   08C6                     
2085   08C6                     ; Advance to the next substate
2086   08C6 21 0A 60            ld      hl,GAME_SUBSTATE
2087   08C9 34                  inc     (hl)
2088   08CA                     
2089   08CA CD 64 09            call    L_DISPLAY_HIGH_SCORES
2090   08CD                     
2091   08CD                     ; Initialize the palette to 00
2092   08CD AF                  xor     a
2093   08CE 21 86 7D            ld      hl,PALETTE_1_OUTPUT
2094   08D1 77                  ld      (hl),a
2095   08D2 2C                  inc     l
2096   08D3 77                  ld      (hl),a
2097   08D4                            
2098   08D4                     ; If only 1 play has been paid for, jump ahead to only offer 1 player option
2099   08D4 06 04       l08d5:  ld      b,%00000100					; Filter out every input but 1 player start
2100   08D6 1E 09               ld      e,$09						; = "ONLY 1 PlAYER BUTTON"
2101   08D8 3A 01 60            ld      a,(NUM_PLAYS)
2102   08DB FE 01               cp      1
2103   08DD CA E3 08            jp      z,l08e4
2104   08E0                     
2105   08E0                     ; If more than 1 play has been paid for, offer 1 or 2 player
2106   08E0 06 0C               ld      b,%00001100					; Filter out every input but 1 and 2 player start
2107   08E2 1C                  inc     e							; "1 OR 2 PLAYERS BUTTON"
2108   08E3                     
2109   08E3                     ; Only display 1, or 1 or 2 player prompt when the 3 LSBs of COUNTER_2 are zero?
2110   08E3 3A 1A 60    l08e4:  ld      a,(COUNTER_2)
2111   08E6 E6 07               and     %00000111
2112   08E8 C2 F2 08            jp      nz,l08f3
2113   08EB                     
2114   08EB 7B                  ld      a,e
2115   08EC CD E9 05            call    L_DISPLAY_STRING
2116   08EF CD 16 06            call    L_DISPLAY_CREDITS_2
2117   08F2                     
2118   08F2                     ; Filter MISC_INPUT
2119   08F2 3A 00 7D    l08f3:  ld      a,(MISC_INPUT)
2120   08F5 A0                  and     b
2121   08F6 C9                  ret     
2122   08F7             ;------------------------------------------------------------------------------
2123   08F7             
2124   08F7             
2125   08F7             ;------------------------------------------------------------------------------
2126   08F7             ; Wait for the player to press either 1 player start or 2 player start and
2127   08F7             ; start the game when one of them is pressed.
2128   08F7             ;
2129   08F7             ; passed:	none
2130   08F7             ; return:	none
2131   08F7             L_HANDLE_START_BUTTONS:  
2132   08F7             		; Display "ONLY 1 PLAYER BUTTON" or "1 or 2 PLAYERS BUTTON" and filter
2133   08F7             		; player input accordingly
2134   08F7 CD D4 08    		call    l08d5						; a = misc input
2135   08FA             
2136   08FA             		; If the 1 PLAYER START has been pressed, jump ahead to start 1 player
2137   08FA FE 04               cp      $04
2138   08FC CA 05 09            jp      z,l0906
2139   08FF             		
2140   08FF             		; If the 2 PLAYER START has been pressed, jump ahead to start 2 players
2141   08FF FE 08               cp      $08	
2142   0901 CA 18 09            jp      z,l0919
2143   0904 C9                  ret     
2144   0905             		
2145   0905             		; Subtract one play from the number of plays that have been paid for
2146   0905 CD 76 09    l0906:  call    L_SUBTRACT_ONE_PLAY
2147   0908             
2148   0908             		; Clear player 2 data
2149   0908 21 48 60            ld      hl,P2_DATA
2150   090B 06 08               ld      b,$08
2151   090D AF                  xor     a
2152   090E 77          l090f:  ld      (hl),a
2153   090F 2C                  inc     l
2154   0910 10 FC               djnz    l090f
2155   0912             		
2156   0912             		; Jump ahead to set SECOND_PLAYER to 0 (indicating that the current player is player 1)
2157   0912             		; and set TWO_PLAYERS to 0 (indicating that one player is playing)
2158   0912 21 00 00            ld      hl,$0000
2159   0915 C3 37 09            jp      l0938
2160   0918             		
2161   0918             		; Subtract two plays from the number of plays that have been paid for
2162   0918 CD 76 09    l0919:  call    L_SUBTRACT_ONE_PLAY
2163   091B CD 76 09            call    L_SUBTRACT_ONE_PLAY
2164   091E             		
2165   091E             		; Initialize player 2's number of lives to the initial number of lives
2166   091E             		; (from the DIP settings)
2167   091E 11 48 60            ld      de,P2_NUMBER_LIVES
2168   0921 3A 20 60            ld      a,(DIP_NUM_LIVES)
2169   0924 12                  ld      (de),a
2170   0925             		
2171   0925             		; Fill player 2's data with the initial data values
2172   0925 1C                  inc     e							; de = P2_LEVEL_NUMBER
2173   0926 21 5D 09            ld      hl,L_INITIAL_PLAYER_DATA_TABLE
2174   0929 01 07 00            ld      bc,7						; 7 bytes of data to copy
2175   092C ED B0               ldir    
2176   092E             		
2177   092E             		; Zero player 2's score
2178   092E 11 01 01            ld      de,$0101
2179   0931 CD 22 30            call    L_ADD_EVENT
2180   0934             		
2181   0934             		; Set SECOND_PLAYER to 0 (indicating that the current player is player 1)
2182   0934             		; and set TWO_PLAYERS to 1 (indicating that two players are playing)
2183   0934 21 00 01            ld      hl,$0100
2184   0937             		
2185   0937             		; Set the values of SECOND_PLAYER (to the value of l) 
2186   0937             		; and TWO_PLAYERS (to the value of h)
2187   0937 22 0E 60    l0938:  ld      (SECOND_PLAYER),hl
2188   093A             
2189   093A             		; Clear the entire stage portion of the screen
2190   093A CD 73 08            call    L_CLEAR_STAGE_SCREEN
2191   093D             		
2192   093D             		; Initialize player 1's number of lives to the initial number of lives
2193   093D             		; (from the DIP settings)
2194   093D 11 40 60            ld      de,P1_NUMBER_LIVES
2195   0940 3A 20 60            ld      a,(DIP_NUM_LIVES)
2196   0943 12                  ld      (de),a
2197   0944             		
2198   0944             		; Fill player 1's data with the initial data values
2199   0944 1C                  inc     e							; de = P1_LEVEL_NUMBER
2200   0945 21 5D 09            ld      hl,L_INITIAL_PLAYER_DATA_TABLE
2201   0948 01 07 00            ld      bc,7						; 7 bytes of data to copy
2202   094B ED B0               ldir    
2203   094D             		
2204   094D             		; Zero player 1's score
2205   094D 11 00 01            ld      de,$0100
2206   0950 CD 22 30            call    L_ADD_EVENT
2207   0953             		
2208   0953             		; Set the game state to playing and game substate to orienting the screen
2209   0953 AF                  xor     a
2210   0954 32 0A 60            ld      (GAME_SUBSTATE),a
2211   0957 3E 03               ld      a,3
2212   0959 32 05 60            ld      (GAME_STATE),a
2213   095C C9                  ret 
2214   095D             ;------------------------------------------------------------------------------
2215   095D             
2216   095D             
2217   095D             
2218   095D             ;------------------------------------------------------------------------------
2219   095D             ; The following table contains the initial values for player data when the game
2220   095D             ; is first beginning
2221   095D             L_INITIAL_PLAYER_DATA_TABLE:  
2222   095D 01          		.byte	1		; LEVEL_NUMBER - Start on level one
2223   095E D7 39       		.word	L_STAGE_ORDER_TABLE	; STAGE_ORDER_POINTER - Address of the stage order for level 1
2224   0960 01          		.byte	1		; INTRO_NOT_DISPLAYED - The introduction stage has not been displayed
2225   0961 00          		.byte	0		; BONUS_AWARDED - The bonus life has not been awarded
2226   0962 00          		.byte	0		; HEIGHT_INDEX - Still working on 25 meters
2227   0963 00          		.byte	0		; STAGE_ORDER_POINTER_LAG - Not initialized
2228   0964             ;------------------------------------------------------------------------------
2229   0964             
2230   0964             
2231   0964             
2232   0964             ;------------------------------------------------------------------------------
2233   0964             ; Display the high score table
2234   0964             L_DISPLAY_HIGH_SCORES:  
2235   0964             		; Display the number of plays that have been paid for
2236   0964 11 00 04    		ld      de,$0400
2237   0967 CD 22 30            call    L_ADD_EVENT	
2238   096A             
2239   096A             		; Display the high score table			
2240   096A 11 14 03            ld      de,$0314
2241   096D 06 06               ld      b,$06
2242   096F CD 22 30    l0970:  call    L_ADD_EVENT
2243   0972 1C                  inc     e
2244   0973 10 FA               djnz    l0970
2245   0975 C9                  ret     
2246   0976             ;------------------------------------------------------------------------------
2247   0976             
2248   0976             
2249   0976             
2250   0976             ;------------------------------------------------------------------------------
2251   0976             ; Subtract one play from the number of plays that have been paid for.
2252   0976             ; 
2253   0976             ; passed:	none
2254   0976             ; return: 	none
2255   0976             L_SUBTRACT_ONE_PLAY:  
2256   0976             		; Interesting way to subtract one play...
2257   0976 21 01 60    		ld      hl,NUM_PLAYS
2258   0979 3E 99               ld      a,$99
2259   097B 86                  add     a,(hl)
2260   097C 27                  daa     
2261   097D 77                  ld      (hl),a
2262   097E             		
2263   097E             		; Redisplay the number of credits paid for
2264   097E 11 00 04            ld      de,$0400
2265   0981 CD 22 30            call    L_ADD_EVENT
2266   0984             		
2267   0984 C9                  ret     
2268   0985             ;------------------------------------------------------------------------------
2269   0985             
2270   0985             
2271   0985             
2272   0985             ;------------------------------------------------------------------------------
2273   0985             ; Orient the screen for the next player.
2274   0985             ; This really only applies to cocktail cabinets, where the screen is flipped
2275   0985             ; when it is the second player's turn.
2276   0985             L_ORIENT_SCREEN:  
2277   0985 CD 51 08    		call    L_CLEAR_SCREEN_AND_SPRITES
2278   0988 CD 1C 01            call    L_SOUNDS_OFF
2279   098B                     
2280   098B                     ; Orient the screen right side up
2281   098B 11 82 7D            ld      de,SCREEN_ORIENTATION
2282   098E 3E 01               ld      a,1
2283   0990 12                  ld      (de),a
2284   0991                     
2285   0991                     ; If the second player is active, jump ahead to invert the screen, if needed
2286   0991 21 0A 60            ld      hl,GAME_SUBSTATE
2287   0994 3A 0E 60            ld      a,(SECOND_PLAYER)
2288   0997 A7                  and     a
2289   0998 C2 9E 09            jp      nz,l099f
2290   099B                     
2291   099B                     ; If this is the first player, set substate to 1
2292   099B 36 01               ld      (hl),1
2293   099D C9                  ret     
2294   099E                     
2295   099E                     ; If this is an upright cabinet, don't flip the screen 
2296   099E                     ; for the second player
2297   099E 3A 26 60    l099f:  ld      a,(CABINET_TYPE)
2298   09A1 3D                  dec     a
2299   09A2 CA A7 09            jp      z,l09a8
2300   09A5                     
2301   09A5                     ; If this is a cocktail cabinet, flip the screen for 
2302   09A5                     ; the second player
2303   09A5 AF                  xor     a
2304   09A6 12                  ld      (de),a
2305   09A7                     
2306   09A7                     ; This is the second player, so set the substate to 3
2307   09A7 36 03       l09a8:  ld      (hl),3
2308   09A9 C9                  ret     
2309   09AA             ;------------------------------------------------------------------------------
2310   09AA             
2311   09AA             
2312   09AA             
2313   09AA             ;------------------------------------------------------------------------------
2314   09AA             ; Initialize player 1 and cause the player 1 prompt to be shown if there are 
2315   09AA             ; two players in the game
2316   09AA             L_INIT_P1:  
2317   09AA             		; Copy player 1 data to the current player data
2318   09AA 21 40 60    		ld      hl,P1_DATA
2319   09AD 11 28 62            ld      de,CP_DATA
2320   09B0 01 08 00            ld      bc,8
2321   09B3 ED B0               ldir    
2322   09B5                     
2323   09B5                     ; Record the current stage
2324   09B5 2A 2A 62            ld      hl,(CP_STAGE_ORDER_POINTER)
2325   09B8 7E                  ld      a,(hl)
2326   09B9 32 27 62            ld      (CURRENT_STAGE),a
2327   09BC                     
2328   09BC                     ; If this is a two player game,
2329   09BC                     ; set the minor timer to 120 and substate to 2 
2330   09BC                     ; to display the 1 player prompt
2331   09BC 3A 0F 60            ld      a,(TWO_PLAYERS)
2332   09BF A7                  and     a
2333   09C0 21 09 60            ld      hl,MINOR_TIMER
2334   09C3 11 0A 60            ld      de,GAME_SUBSTATE
2335   09C6 CA CF 09            jp      z,l09d0
2336   09C9 36 78               ld      (hl),120
2337   09CB EB                  ex      de,hl
2338   09CC 36 02               ld      (hl),2
2339   09CE C9                  ret     
2340   09CF                      
2341   09CF                     ; If this is a one player game,
2342   09CF                     ; set the minor timer to 1 and substate to 5
2343   09CF                     ; to skip the 1 player prompt
2344   09CF 36 01       l09d0:  ld      (hl),1
2345   09D1 EB                  ex      de,hl
2346   09D2 36 05               ld      (hl),5
2347   09D4 C9                  ret     
2348   09D5             ;------------------------------------------------------------------------------
2349   09D5             
2350   09D5             
2351   09D5             
2352   09D5             ;------------------------------------------------------------------------------
2353   09D5             ; Display the player 1 prompt.
2354   09D5             ; This is only done in two player games.
2355   09D5             L_P1_PROMPT_SCREEN:  
2356   09D5             		; Set the palette to 00
2357   09D5 AF          		xor     a
2358   09D6 32 86 7D            ld      (PALETTE_1_OUTPUT),a
2359   09D9 32 87 7D            ld      (PALETTE_2_OUTPUT),a
2360   09DC                     
2361   09DC                     ; Display "PLAYER (I)"
2362   09DC 11 02 03            ld      de,$0302
2363   09DF CD 22 30            call    L_ADD_EVENT
2364   09E2                     
2365   09E2                     ; Display player 2's score?
2366   09E2 11 01 02            ld      de,$0201
2367   09E5 CD 22 30            call    L_ADD_EVENT
2368   09E8                     
2369   09E8                     ; Advance to substate 5
2370   09E8 3E 05               ld      a,5
2371   09EA 32 0A 60            ld      (GAME_SUBSTATE),a
2372   09ED             		
2373   09ED             L_DISPLAY_2UP:  
2374   09ED             		; Display "2UP"
2375   09ED 3E 02       		ld      a,$02						; '2'
2376   09EF 32 E0 74            ld      (TILE_COORD(7,0)),a
2377   09F2 3E 25               ld      a,$25						; 'U'
2378   09F4 32 C0 74            ld      (TILE_COORD(6,0)),a
2379   09F7 3E 20               ld      a,$20						; 'P'
2380   09F9 32 A0 74            ld      (TILE_COORD(5,0)),a
2381   09FC C9                  ret     
2382   09FD             ;------------------------------------------------------------------------------
2383   09FD             
2384   09FD             
2385   09FD             
2386   09FD             ;------------------------------------------------------------------------------
2387   09FD             ; Initialize player 2 and cause the player 2 prompt to be shown 
2388   09FD             L_INIT_P2:  
2389   09FD             		; Copy player 2 data to the current player data
2390   09FD 21 48 60    		ld      hl,P2_NUMBER_LIVES
2391   0A00 11 28 62            ld      de,CP_NUMBER_LIVES
2392   0A03 01 08 00            ld      bc,8
2393   0A06 ED B0               ldir    
2394   0A08                    
2395   0A08                     ; Record the current stage		
2396   0A08 2A 2A 62            ld      hl,(CP_STAGE_ORDER_POINTER)
2397   0A0B 7E                  ld      a,(hl)
2398   0A0C 32 27 62            ld      (CURRENT_STAGE),a
2399   0A0F                     
2400   0A0F                     ; Set the minor timer to 120 and substate to 4 to display the player 2 prompt
2401   0A0F 3E 78               ld      a,120
2402   0A11 32 09 60            ld      (MINOR_TIMER),a
2403   0A14 3E 04               ld      a,GAME_SUBSTATE_PLAY_START_P2
2404   0A16 32 0A 60            ld      (GAME_SUBSTATE),a
2405   0A19 C9                  ret     
2406   0A1A             ;------------------------------------------------------------------------------
2407   0A1A             
2408   0A1A             
2409   0A1A             
2410   0A1A             ;------------------------------------------------------------------------------
2411   0A1A             ; Display the player 2 prompt.
2412   0A1A             L_P2_PROMPT_SCREEN:  
2413   0A1A             		; Set palette 00
2414   0A1A AF          		xor     a
2415   0A1B 32 86 7D            ld      (PALETTE_1_OUTPUT),a
2416   0A1E 32 87 7D            ld      (PALETTE_2_OUTPUT),a
2417   0A21                     
2418   0A21                     ; Display "PLAYER (II)"
2419   0A21 11 03 03            ld      de,$0303
2420   0A24 CD 22 30            call    L_ADD_EVENT
2421   0A27                     
2422   0A27                     ; Display player 2 score
2423   0A27 11 01 02            ld      de,$0201
2424   0A2A CD 22 30            call    L_ADD_EVENT
2425   0A2D CD ED 09            call    L_DISPLAY_2UP
2426   0A30                     
2427   0A30                     ; Set substate to 5
2428   0A30 3E 05               ld      a,5
2429   0A32 32 0A 60            ld      (GAME_SUBSTATE),a
2430   0A35 C9                  ret     
2431   0A36             ;------------------------------------------------------------------------------
2432   0A36             
2433   0A36             
2434   0A36             
2435   0A36             ;------------------------------------------------------------------------------
2436   0A36             ; Display the high score, player 1 score and lives and level
2437   0A36             L_DISPLAY_TURN_DATA:  
2438   0A36             		; Display "HIGH SCORE"
2439   0A36 11 04 03    		ld      de,$0304
2440   0A39 CD 22 30            call    L_ADD_EVENT
2441   0A3C                     
2442   0A3C                     ; Display the high score
2443   0A3C 11 02 02            ld      de,$0202
2444   0A3F CD 22 30            call    L_ADD_EVENT
2445   0A42                     
2446   0A42                     ; Display player 1 score
2447   0A42 11 00 02            ld      de,$0200
2448   0A45 CD 22 30            call    L_ADD_EVENT
2449   0A48                     
2450   0A48                     ; Display lives and level (w/o subtracting a life)
2451   0A48 11 00 06            ld      de,$0600
2452   0A4B CD 22 30            call    L_ADD_EVENT
2453   0A4E                     
2454   0A4E                     ; Advance the substate (to 6)
2455   0A4E 21 0A 60            ld      hl,GAME_SUBSTATE
2456   0A51 34                  inc     (hl)
2457   0A52             		
2458   0A52             L_DISPLAY_1UP:  
2459   0A52             		; Display "1UP"
2460   0A52 3E 01       		ld      a,$01						; '1'
2461   0A54 32 40 77            ld      (TILE_COORD(26,0)),a
2462   0A57 3E 25               ld      a,$25						; 'U'
2463   0A59 32 20 77            ld      (TILE_COORD(25,0)),a
2464   0A5C 3E 20               ld      a,$20						; 'P'
2465   0A5E 32 00 77            ld      (TILE_COORD(24,0)),a
2466   0A61 C9                  ret     
2467   0A62             ;------------------------------------------------------------------------------
2468   0A62             
2469   0A62             
2470   0A62             
2471   0A62             ;------------------------------------------------------------------------------
2472   0A62             ; Prepare for the next turn by clearing the screen and triggering the stage display
2473   0A62             ; or the intro, if needed.
2474   0A62             L_PREPARE_SCREEN_FOR_TURN:  
2475   0A62 DF          		rst     $18						; Return until the minor timer runs down
2476   0A63                     
2477   0A63 CD 73 08            call    L_CLEAR_STAGE_SCREEN
2478   0A66                     
2479   0A66                     ; Set the minor timer to 1
2480   0A66 21 09 60            ld      hl,MINOR_TIMER
2481   0A69 36 01               ld      (hl),1
2482   0A6B                     
2483   0A6B                     ; Advance the substate
2484   0A6B 2C                  inc     l
2485   0A6C 34                  inc     (hl)
2486   0A6D                     
2487   0A6D                     ; If the intro has already been displayed, return
2488   0A6D 11 2C 62            ld      de,CP_INTRO_NOT_DISPLAYED
2489   0A70 1A                  ld      a,(de)
2490   0A71 A7                  and     a
2491   0A72 C0                  ret     nz
2492   0A73                     
2493   0A73                     ; Intro needs to be displayed, so advance the substate again
2494   0A73 34                  inc     (hl)
2495   0A74 C9                  ret     
2496   0A75             ;------------------------------------------------------------------------------
2497   0A75             
2498   0A75             
2499   0A75             
2500   0A75             ;------------------------------------------------------------------------------
2501   0A75             ; Called when GAME_STATE == 3 (player is playing) and GAME_SUBSTATE == 7
2502   0A75             ;
2503   0A75             ; Display each part of the introduction animation
2504   0A75             L_IMPLEMENT_INTRO_STAGE:  
2505   0A75 3A 85 63    		ld      a,(INTRODUCTION_STATE)
2506   0A78 EF                  rst     $28							; Jump to local table address
2507   0A79             		; Jump table
2508   0A79 89 0A       		.word	L_DISPLAY_INTRODUCTION_STAGE	; 0 = display introduction screen
2509   0A7B BE 0A       		.word	L_DISPLAY_DK_CLIMBING	; 1 = prepare sprites
2510   0A7D E7 0A       		.word	L_IMPLEMENT_DK_CLIMB_ANIM	; 2 = animate climbing sequence
2511   0A7F EC 2F       		.word	L_PAUSE_CURRENT_STATE	; 3 = pause
2512   0A81 05 0B       		.word	L_ANIMATE_DK_JUMP_FROM_LAD	; 4 = animate introduction screen
2513   0A83 EC 2F       		.word	L_PAUSE_CURRENT_STATE	; 5 = pause
2514   0A85 67 0B       		.word	L_ANIMATE_DK_PLAT_JUMPS	; 6 = animate Donkey Kong jumping
2515   0A87 B2 0B       		.word	L_ANIMATE_DK_GRIN_TAUNT	; 7 = Donkey Kong grins and laughs
2516   0A89             ;------------------------------------------------------------------------------
2517   0A89             
2518   0A89             
2519   0A89             
2520   0A89             ;------------------------------------------------------------------------------
2521   0A89             ; Display the introduction stage (with straight girders before they are warped
2522   0A89             ; by Donkey Kong) and prepare for Donkey Kong's jumps.
2523   0A89             L_DISPLAY_INTRODUCTION_STAGE:  
2524   0A89             		; Set palette 01
2525   0A89 AF          		xor     a
2526   0A8A 32 86 7D            ld      (PALETTE_1_OUTPUT),a
2527   0A8D 3C                  inc     a
2528   0A8E 32 87 7D            ld      (PALETTE_2_OUTPUT),a
2529   0A91                     
2530   0A91                     ; Display the introduction stage (girder straight before they are warped 
2531   0A91             		; by Donkey Kong)
2532   0A91 11 7F 37            ld      de,L_INTRO_STAGE_DATA
2533   0A94 CD A4 0D            call    L_DISPLAY_STAGE
2534   0A97             		
2535   0A97             		; Blank the tiles at the top of Donkey Kong's escape ladders
2536   0A97             		; Otherwise, girders are drawn at the top of each one
2537   0A97 3E 10               ld      a,$10						; Blank tile
2538   0A99 32 A3 76            ld      (TILE_COORD(21,3)),a
2539   0A9C 32 63 76            ld      (TILE_COORD(19,3)),a
2540   0A9F             		
2541   0A9F             		; Draw a girder at the bottom of the ladder to Pauline's platform
2542   0A9F             		; Otherwise, it is just another ladder
2543   0A9F 3E D4               ld      a,$d4
2544   0AA1 32 AA 75            ld      (TILE_COORD(13,10)),a
2545   0AA4             		
2546   0AA4             		; Clear the climbing counter to 0
2547   0AA4 AF                  xor     a
2548   0AA5 32 AF 62            ld      (DK_CLIMBING_COUNTER),a
2549   0AA8             		
2550   0AA8             		; Initialize Donkey Kong's ladder jump vector pointer to the beginning of the 
2551   0AA8             		; vector data
2552   0AA8 21 26 38            ld      hl,L_DK_JUMP_FROM_LADDER_DATA
2553   0AAB 22 C2 63            ld      (LADDER_JUMP_VECTOR_POINTER),hl
2554   0AAE             		
2555   0AAE             		; Initialize Donkey Kong's platform jump vector pointer to the beginning of the
2556   0AAE             		; vector data
2557   0AAE 21 3D 38            ld      hl,L_DK_JUMP_ACROSS_PLAT_DATA
2558   0AB1 22 C4 63            ld      (PLATFORM_JUMP_VECTOR_POINTER),hl
2559   0AB4             		
2560   0AB4             		; Set the minor timer to 64
2561   0AB4 3E 40               ld      a,64
2562   0AB6 32 09 60            ld      (MINOR_TIMER),a
2563   0AB9             		
2564   0AB9             		; Advance to the next state in the introduction display
2565   0AB9 21 85 63            ld      hl,INTRODUCTION_STATE
2566   0ABC 34                  inc     (hl)
2567   0ABD C9                  ret     
2568   0ABE             ;------------------------------------------------------------------------------
2569   0ABE             
2570   0ABE             
2571   0ABE             
2572   0ABE             ;------------------------------------------------------------------------------
2573   0ABE             ; Load and position Donkey Kong's climbing sprites, and begin playing the 
2574   0ABE             ; introduction song.
2575   0ABE             L_DISPLAY_DK_CLIMBING:  
2576   0ABE DF          		rst     $18							; Return if the minor timer has not reached 0
2577   0ABF             
2578   0ABF             		; Load the Donkey Kong climbing sprites and move them into position
2579   0ABF 21 FE 37            ld      hl,L_DK_SPRITES_CLIMBING
2580   0AC2 CD 4E 00            call    L_LOAD_DK_SPRITES
2581   0AC5 21 08 69            ld      hl,DK_SPRITE_1_X
2582   0AC8 0E 30               ld      c,48
2583   0ACA FF                  rst     $38
2584   0ACB 21 0B 69            ld      hl,DK_SPRITE_1_Y
2585   0ACE 0E 99               ld      c,-103
2586   0AD0 FF                  rst     $38
2587   0AD1             		
2588   0AD1 3E 1F               ld      a,31
2589   0AD3 32 8E 63            ld      (LADDER_ROW_TO_ERASE),a
2590   0AD6             		
2591   0AD6 AF                  xor     a
2592   0AD7 32 0C 69            ld      (DK_SPRITE_2_X),a
2593   0ADA             		
2594   0ADA             		; Trigger the introduction song to play (once)
2595   0ADA 21 8A 60            ld      hl,PENDING_SONG_TRIGGER
2596   0ADD 36 01               ld      (hl),SONG_TRIGGER_INTRODUCTION
2597   0ADF 23                  inc     hl							; PENDING_SONG_TRIGGER_REPEAT
2598   0AE0 36 03               ld      (hl),3
2599   0AE2             		
2600   0AE2             		; Advance to the next introduction state
2601   0AE2 21 85 63            ld      hl,INTRODUCTION_STATE
2602   0AE5 34                  inc     (hl)
2603   0AE6 C9                  ret     
2604   0AE7             ;------------------------------------------------------------------------------
2605   0AE7             
2606   0AE7             
2607   0AE7             
2608   0AE7             ;------------------------------------------------------------------------------
2609   0AE7             ; Animate Donkey Kong climbing the ladders on the introduction stage, including 
2610   0AE7             ; pulling the ladders up behind him
2611   0AE7             L_IMPLEMENT_DK_CLIMB_ANIM:  
2612   0AE7             		; Display the next part of the climbing animation
2613   0AE7 CD F2 2F    		call    L_ANIMATE_CLIMBING_LADDERS
2614   0AEA             		
2615   0AEA             		; If Donkey Kong has climbed 8 pixels (up an entire tile of the ladder)
2616   0AEA             		; then animate the ladder being pulled up behind him
2617   0AEA 3A AF 62            ld      a,(DK_CLIMBING_COUNTER)
2618   0AED E6 0F               and     %1111
2619   0AEF CC CD 2F            call    z,L_ANIMATE_LADDER_PULL_UP
2620   0AF2                     
2621   0AF2                     ; If Donkey Kong has not reached the top of the ladders, then return
2622   0AF2 3A 0B 69            ld      a,(DK_SPRITE_1_Y)
2623   0AF5 FE 5D               cp      93
2624   0AF7 D0                  ret     nc
2625   0AF8                     
2626   0AF8                     ; Set the minor timer to 32
2627   0AF8 3E 20               ld      a,32
2628   0AFA 32 09 60            ld      (MINOR_TIMER),a
2629   0AFD                     
2630   0AFD                     ; Advance to the next introduction state
2631   0AFD 21 85 63            ld      hl,INTRODUCTION_STATE
2632   0B00 34                  inc     (hl)
2633   0B01                     
2634   0B01                     ; Save INTRODUCTION_STATE as the current state variable
2635   0B01 22 C0 63            ld      (CURRENT_STATE_VAR_POINTER),hl
2636   0B04 C9                  ret     
2637   0B05             ;------------------------------------------------------------------------------
2638   0B05             
2639   0B05             
2640   0B05             
2641   0B05             ;------------------------------------------------------------------------------
2642   0B05             ; Animate Donkey Kong's jump from the ladder onto the top platform on the 
2643   0B05             ; introduction stage
2644   0B05             L_ANIMATE_DK_JUMP_FROM_LAD:  
2645   0B05             		; Return until counter 2 reaches 0
2646   0B05 3A 1A 60    		ld      a,(COUNTER_2)
2647   0B08 0F                  rrca    
2648   0B09 D8                  ret     c
2649   0B0A                     
2650   0B0A                     ; Get the next jump vector
2651   0B0A 2A C2 63            ld      hl,(LADDER_JUMP_VECTOR_POINTER)
2652   0B0D 7E                  ld      a,(hl)
2653   0B0E                     
2654   0B0E                     ; If the end of the vector data has been reached, jump ahead
2655   0B0E                     ; to complete the jump
2656   0B0E FE 7F               cp      $7f
2657   0B10 CA 1D 0B            jp      z,l0b1e
2658   0B13                      
2659   0B13                     ; Advance the vector pointer
2660   0B13 23                  inc     hl
2661   0B14 22 C2 63            ld      (LADDER_JUMP_VECTOR_POINTER),hl
2662   0B17                     
2663   0B17                     ; Move Donkey Kong's sprites up by the vector amount
2664   0B17 4F                  ld      c,a
2665   0B18 21 0B 69            ld      hl,DK_SPRITE_1_Y
2666   0B1B FF                  rst     $38
2667   0B1C C9                  ret     
2668   0B1D                     
2669   0B1D                     ; Complete the jump
2670   0B1D                     ; Load Donkey Kong sprites
2671   0B1D 21 CE 37    l0b1e:  ld      hl,L_DK_SPRITES_L_ARM_RAISED
2672   0B20 CD 4E 00            call    L_LOAD_DK_SPRITES
2673   0B23                     
2674   0B23                     ; Load Pauline's sprites
2675   0B23 11 00 69            ld      de,PAULINE_SPRITES
2676   0B26 01 08 00            ld      bc,8
2677   0B29 ED B0               ldir    
2678   0B2B                     
2679   0B2B                     ; Position Donkey Kong
2680   0B2B 21 08 69            ld      hl,DK_SPRITE_1_X
2681   0B2E 0E 50               ld      c,80
2682   0B30 FF                  rst     $38
2683   0B31 21 0B 69            ld      hl,DK_SPRITE_1_Y
2684   0B34 0E FC               ld      c,-4
2685   0B36 FF                  rst     $38
2686   0B37                     
2687   0B37                     ; Pull up the rest of the ladder
2688   0B37 CD CD 2F    l0b38:  call    L_ANIMATE_LADDER_PULL_UP
2689   0B3A 3A 8E 63            ld      a,(LADDER_ROW_TO_ERASE)
2690   0B3D FE 0A               cp      10
2691   0B3F C2 37 0B            jp      nz,l0b38
2692   0B42                     
2693   0B42                     ; Trigger the stomp sound
2694   0B42 3E 03               ld      a,3
2695   0B44 32 82 60            ld      (STOMP_SOUND_TRIGGER),a
2696   0B47                     
2697   0B47                     ; Deform the 6th platform
2698   0B47 11 9E 38            ld      de,L_INTRO_DATA_SLOPE6
2699   0B4A CD A4 0D            call    L_DISPLAY_STAGE
2700   0B4D 3E 10               ld      a,$10						; Blank tile
2701   0B4F 32 AA 74    		ld      (TILE_COORD(5,10)),a
2702   0B52 32 8A 74    		ld      (TILE_COORD(4,10)),a
2703   0B55             		
2704   0B55             		; Mark platform 5 as the next to deform when Donkey Kong jumps again
2705   0B55 3E 05               ld      a,5
2706   0B57 32 8D 63            ld      (STAGE_DEFORM_INDEX),a
2707   0B5A                     
2708   0B5A                     ; Set the minor timer to 32
2709   0B5A 3E 20               ld      a,32
2710   0B5C 32 09 60            ld      (MINOR_TIMER),a
2711   0B5F                     
2712   0B5F                     ; Advance the current state
2713   0B5F 21 85 63            ld      hl,INTRODUCTION_STATE
2714   0B62 34                  inc     (hl)
2715   0B63 22 C0 63            ld      (CURRENT_STATE_VAR_POINTER),hl
2716   0B66 C9                  ret     
2717   0B67             ;------------------------------------------------------------------------------
2718   0B67             
2719   0B67             
2720   0B67             		
2721   0B67             ;------------------------------------------------------------------------------
2722   0B67             ; Animate Donkey Kong's jumps across the top platform and the deformations that
2723   0B67             ; result
2724   0B67             L_ANIMATE_DK_PLAT_JUMPS:  
2725   0B67             		; Return until counter 2 reaches 0
2726   0B67 3A 1A 60    		ld      a,(COUNTER_2)
2727   0B6A 0F                  rrca    
2728   0B6B D8                  ret     c
2729   0B6C                     
2730   0B6C                     ; If the end of the vector data has been reached,
2731   0B6C                     ; then advance to the next state 
2732   0B6C 2A C4 63            ld      hl,(PLATFORM_JUMP_VECTOR_POINTER)
2733   0B6F 7E                  ld      a,(hl)
2734   0B70 FE 7F               cp      $7f
2735   0B72 CA 85 0B            jp      z,l0b86
2736   0B75                     
2737   0B75                     ; Advance the vector data pointer
2738   0B75 23                  inc     hl
2739   0B76 22 C4 63            ld      (PLATFORM_JUMP_VECTOR_POINTER),hl
2740   0B79                     
2741   0B79                     ; Make Donkey Kong jump
2742   0B79 21 0B 69            ld      hl,DK_SPRITE_1_Y
2743   0B7C 4F                  ld      c,a
2744   0B7D FF                  rst     $38						; Move Donkey Kong up or down
2745   0B7E 21 08 69            ld      hl,DK_SPRITE_1_X
2746   0B81 0E FF               ld      c,-1
2747   0B83 FF                  rst     $38						; Move Donkey Kong left
2748   0B84 C9                  ret     
2749   0B85                     
2750   0B85             l0b86:  
2751   0B85             		; Reset the vector data pointer to the start of the vector data
2752   0B85 21 3D 38    		ld      hl,L_DK_JUMP_ACROSS_PLAT_DATA
2753   0B88 22 C4 63            ld      (PLATFORM_JUMP_VECTOR_POINTER),hl
2754   0B8B                     
2755   0B8B                     ; Trigger the stomp sound
2756   0B8B 3E 03               ld      a,3
2757   0B8D 32 82 60            ld      (STOMP_SOUND_TRIGGER),a
2758   0B90                     
2759   0B90                     ; Convert the stage deform index to an offset
2760   0B90 21 4E 38            ld      hl,l38dc
2761   0B93 3A 8D 63            ld      a,(STAGE_DEFORM_INDEX)
2762   0B96 3D                  dec     a
2763   0B97 07                  rlca    
2764   0B98 07                  rlca    
2765   0B99 07                  rlca    
2766   0B9A 07                  rlca    
2767   0B9B 5F                  ld      e,a
2768   0B9C 16 00               ld      d,$00
2769   0B9E 19                  add     hl,de
2770   0B9F EB                  ex      de,hl
2771   0BA0                     
2772   0BA0                     ; Display the deformed platform
2773   0BA0 CD A4 0D            call    L_DISPLAY_STAGE
2774   0BA3                     
2775   0BA3                     ; Decrement the deform index to the next lower platform
2776   0BA3 21 8D 63            ld      hl,STAGE_DEFORM_INDEX
2777   0BA6 35                  dec     (hl)
2778   0BA7                     
2779   0BA7                     ; Return if the next platform is valid
2780   0BA7 C0                  ret     nz
2781   0BA8                     
2782   0BA8                     ; Set the timer
2783   0BA8 3E B0               ld      a,176
2784   0BAA 32 09 60            ld      (MINOR_TIMER),a
2785   0BAD                     
2786   0BAD                     ; Advance to the next (and last) introduction state
2787   0BAD 21 85 63            ld      hl,INTRODUCTION_STATE
2788   0BB0 34                  inc     (hl)
2789   0BB1 C9                  ret     
2790   0BB2             ;------------------------------------------------------------------------------
2791   0BB2             
2792   0BB2             
2793   0BB2             
2794   0BB2             ;------------------------------------------------------------------------------
2795   0BB2             ; Animate Donkey Kong's grin and laugh taunt at the end of the introduction stage
2796   0BB2             L_ANIMATE_DK_GRIN_TAUNT:  
2797   0BB2             		; If the minor timer has not run down to 144, jump ahead
2798   0BB2 21 8A 60    		ld      hl,PENDING_SONG_TRIGGER
2799   0BB5 3A 09 60            ld      a,(MINOR_TIMER)
2800   0BB8 FE 90               cp      144
2801   0BBA 20 0B               jr      nz,l0bc8
2802   0BBC                     
2803   0BBC                     ; Trigger the roaring "song"
2804   0BBC 36 0F               ld      (hl),SONG_TRIGGER_ROAR
2805   0BBE 23                  inc     hl
2806   0BBF 36 03               ld      (hl),3
2807   0BC1                     
2808   0BC1                     ; Show Donkey Kong grinning
2809   0BC1 21 19 69            ld      hl,DK_SPRITE_5_NUM
2810   0BC4 34                  inc     (hl)
2811   0BC5 18 08               jr      l0bd1
2812   0BC7                     
2813   0BC7                     ; If the minor timer has not decremented to 24, skip ahead
2814   0BC7 FE 18       l0bc8:  cp      24
2815   0BC9 20 04               jr      nz,l0bd1
2816   0BCB                     
2817   0BCB                     ; Show Donkey Kong not grinning
2818   0BCB 21 19 69            ld      hl,DK_SPRITE_5_NUM
2819   0BCE 35                  dec     (hl)
2820   0BCF                     
2821   0BCF                     ; Return until the minor timer reaches 0
2822   0BCF DF          l0bd1:  rst     $18
2823   0BD0             
2824   0BD0             		; Reset the introduction state
2825   0BD0 AF                  xor     a
2826   0BD1 32 85 63            ld      (INTRODUCTION_STATE),a
2827   0BD4                     
2828   0BD4                     ; Show Donkey Kong grinning
2829   0BD4 34                  inc     (hl)
2830   0BD5                     
2831   0BD5                     ; Raise Donkey Kong's right arm (to match his left)
2832   0BD5 23                  inc     hl
2833   0BD6 34                  inc     (hl)
2834   0BD7 C9                  ret     
2835   0BD8             ;------------------------------------------------------------------------------
2836   0BD8             
2837   0BD8             
2838   0BD8             
2839   0BD8             ;------------------------------------------------------------------------------
2840   0BD8             ; Display the intermission screen showing the height that the player has reached
2841   0BD8             L_DISPLAY_INTERMISSION:  
2842   0BD8             		; Turn off sounds and return until the minor timer reaches 0
2843   0BD8 CD 1C 01    		call    L_SOUNDS_OFF
2844   0BDB DF                  rst     $18
2845   0BDC                     
2846   0BDC                     ; Display Mario's lives
2847   0BDC CD 73 08            call    L_CLEAR_STAGE_SCREEN
2848   0BDF 16 06               ld      d,$06
2849   0BE1 3A 00 62            ld      a,(MARIO_ALIVE)
2850   0BE4 5F                  ld      e,a
2851   0BE5 CD 22 30            call    L_ADD_EVENT
2852   0BE8                     
2853   0BE8                     ; Palette 10
2854   0BE8 21 86 7D            ld      hl,PALETTE_1_OUTPUT
2855   0BEB 36 01               ld      (hl),$01
2856   0BED 23                  inc     hl
2857   0BEE 36 00               ld      (hl),$00
2858   0BF0                     
2859   0BF0                     ; Trigger the intermission song
2860   0BF0 21 8A 60            ld      hl,PENDING_SONG_TRIGGER
2861   0BF3 36 02               ld      (hl),SONG_TRIGGER_INTERMISSION
2862   0BF5 23                  inc     hl
2863   0BF6 36 03               ld      (hl),3
2864   0BF8                     
2865   0BF8                     ; Initialize the height string index to the first entry in the table
2866   0BF8 21 A7 63            ld      hl,INTERM_HEIGHT_STRING_INDEX
2867   0BFB 36 00               ld      (hl),0
2868   0BFD                     
2869   0BFD                     ; Initialize the height string coord to the bottom of the "stack"
2870   0BFD 21 DC 76            ld      hl,TILE_COORD(22,28)
2871   0C00 22 A8 63            ld      (INTERM_HEIGHT_STRING_COORD),hl
2872   0C03                     
2873   0C03                     ; Limit the height index to 5
2874   0C03 3A 2E 62            ld      a,(CP_HEIGHT_INDEX)
2875   0C06 FE 06               cp      6
2876   0C08 38 05               jr      c,l0c11
2877   0C0A 3E 05               ld      a,5
2878   0C0C 32 2E 62            ld      (CP_HEIGHT_INDEX),a
2879   0C0F                     
2880   0C0F                     ; If the player has not advanced in height 
2881   0C0F                     ; (completed a stage), then jump ahead
2882   0C0F 3A 2F 62    l0c11:  ld      a,(CP_STAGE_ORDER_POINTER_LAG)
2883   0C12 47                  ld      b,a
2884   0C13 3A 2A 62            ld      a,(CP_STAGE_ORDER_POINTER)
2885   0C16 B8                  cp      b
2886   0C17 28 04               jr      z,l0c1f
2887   0C19                     
2888   0C19                     ; Increase the players height by 1 (25 m)
2889   0C19 21 2E 62            ld      hl,CP_HEIGHT_INDEX
2890   0C1C 34                  inc     (hl)
2891   0C1D                     
2892   0C1D                     ; Update the stage order pointer lag
2893   0C1D 32 2F 62    l0c1f:  ld      (CP_STAGE_ORDER_POINTER_LAG),a
2894   0C20             
2895   0C20             		; Get the current player's height
2896   0C20 3A 2E 62            ld      a,(CP_HEIGHT_INDEX)
2897   0C23 47                  ld      b,a
2898   0C24                     
2899   0C24                     ; Start drawing the intermission gorilla at
2900   0C24 21 BC 75            ld      hl,TILE_COORD(13,28)
2901   0C27 0E 50       l0c29:  ld      c,$50
2902   0C29             
2903   0C29             		; Draw one column of the gorilla
2904   0C29 3E 03       l0c29a:	ld		a,3
2905   0C2B 71          l0c2b:  ld      (hl),c
2906   0C2C 0C                  inc     c
2907   0C2D 2B                  dec     hl
2908   0C2E 3D          		dec		a
2909   0C2F 20 FA       		jr		nz,l0c2b
2910   0C31 71                  ld      (hl),c
2911   0C32                     
2912   0C32                     ; If this is the last of the gorilla tiles, jump ahead
2913   0C32 79                  ld      a,c
2914   0C33 FE 67               cp      $67
2915   0C35 CA 40 0C            jp      z,l0c43
2916   0C38                     
2917   0C38                     ; Advance to the bottom of the next column and continue drawing tiles
2918   0C38 0C                  inc     c
2919   0C39 11 23 00            ld      de,35
2920   0C3C 19                  add     hl,de
2921   0C3D C3 29 0C            jp      l0c29a
2922   0C40                     
2923   0C40                     ; Convert the currently displayed height index to an offset in the height string table
2924   0C40 3A A7 63    l0c43:  ld      a,(INTERM_HEIGHT_STRING_INDEX)
2925   0C43 3C                  inc     a
2926   0C44 32 A7 63            ld      (INTERM_HEIGHT_STRING_INDEX),a
2927   0C47 3D                  dec     a
2928   0C48 CB 27               sla     a
2929   0C4A CB 27               sla     a
2930   0C4C E5                  push    hl
2931   0C4D 21 62 3C            ld      hl,L_HEIGHT_STRING_TABLE
2932   0C50                     
2933   0C50 C5                  push    bc
2934   0C51 DD 2A A8 63         ld      ix,(INTERM_HEIGHT_STRING_COORD)
2935   0C55                     
2936   0C55                     ; Convert the height string offset into a table address
2937   0C55 4F                  ld      c,a
2938   0C56 06 00               ld      b,0
2939   0C58 09                  add     hl,bc
2940   0C59                     
2941   0C59                     ; Display the height string
2942   0C59 7E                  ld      a,(hl)
2943   0C5A DD 77 60            ld      (ix+96),a
2944   0C5D 23                  inc     hl
2945   0C5E 7E                  ld      a,(hl)
2946   0C5F DD 77 40            ld      (ix+64),a
2947   0C62 23                  inc     hl
2948   0C63 7E                  ld      a,(hl)
2949   0C64 DD 77 20            ld      (ix+32),a
2950   0C67 DD 36 E0 8B         ld      (ix-32),$8b					; 'm'
2951   0C6B                     
2952   0C6B                     ; Advance to the coord of the next height string to be displayed
2953   0C6B C1                  pop     bc
2954   0C6C DD E5               push    ix
2955   0C6E E1                  pop     hl
2956   0C6F 11 FC FF            ld      de,-4
2957   0C72 19                  add     hl,de
2958   0C73 22 A8 63            ld      (INTERM_HEIGHT_STRING_COORD),hl
2959   0C76                     
2960   0C76                     ; Advance to the coordinate to draw the next gorilla up
2961   0C76 E1                  pop     hl
2962   0C77 11 5F FF            ld      de,-161
2963   0C7A 19                  add     hl,de
2964   0C7B                     
2965   0C7B                     ; If there are more heights to be displayed, jump back up to display them
2966   0C7B 05                  dec     b
2967   0C7C C2 27 0C            jp      nz,l0c29
2968   0C7F                     
2969   0C7F                     ; Display "HOW HIGH CAN YOU GET ? "
2970   0C7F 11 07 03            ld      de,$0307
2971   0C82 CD 22 30            call    L_ADD_EVENT
2972   0C85                     
2973   0C85                     ; Set the minor timer to 160
2974   0C85 21 09 60            ld      hl,MINOR_TIMER
2975   0C88 36 A0               ld      (hl),160
2976   0C8A                     
2977   0C8A                     ; Advance the game substate by two
2978   0C8A 23                  inc     hl
2979   0C8B 34                  inc     (hl)
2980   0C8C 34                  inc     (hl)
2981   0C8D C9                  ret     
2982   0C8E             ;------------------------------------------------------------------------------
2983   0C8E             
2984   0C8E             
2985   0C8E             
2986   0C8E             ;------------------------------------------------------------------------------
2987   0C8E             ; Display the current stage
2988   0C8E             L_DISPLAY_CURRENT_STAGE:  
2989   0C8E             		; Return until the minor timer has reached 0
2990   0C8E DF          		rst     $18
2991   0C8F             L_DISPLAY_CURRENT_STAGE_2:  
2992   0C8F CD 73 08    		call    L_CLEAR_STAGE_SCREEN
2993   0C92             
2994   0C92             		; Display the onscreen timer (forces it to drawn on screen)
2995   0C92 AF                  xor     a
2996   0C93 32 8C 63            ld      (ONSCREEN_TIMER),a
2997   0C96 11 01 05            ld      de,$0501
2998   0C99 CD 22 30            call    L_ADD_EVENT
2999   0C9C             
3000   0C9C             		; Select palette 01
3001   0C9C 21 86 7D            ld      hl,PALETTE_1_OUTPUT
3002   0C9F 36 00               ld      (hl),0
3003   0CA1 23                  inc     hl
3004   0CA2 36 01               ld      (hl),1
3005   0CA4             
3006   0CA4             		; If on the barrels stage, jump ahead to display it
3007   0CA4 3A 27 62            ld      a,(CURRENT_STAGE)
3008   0CA7 3D                  dec     a
3009   0CA8 CA D1 0C            jp      z,l0cd4
3010   0CAB             
3011   0CAB             		; If on the mixer stage, jump ahead to display it
3012   0CAB 3D                  dec     a
3013   0CAC CA DC 0C            jp      z,l0cdf
3014   0CAF             
3015   0CAF             		; If on the elevators stage, jump ahead to display it
3016   0CAF 3D                  dec     a
3017   0CB0 CA EF 0C            jp      z,l0cf2
3018   0CB3             
3019   0CB3             		; Display the rivets stage
3020   0CB3 CD 40 0D            call    L_DRAW_PAULINE_PLAT_POSTS
3021   0CB6             
3022   0CB6             		; Palette 11
3023   0CB6 21 86 7D    		ld      hl,PALETTE_1_OUTPUT
3024   0CB9 36 01               ld      (hl),1
3025   0CBB             
3026   0CBB 3E 0B               ld      a,SONG_TRIGGER_BG_RIVETS
3027   0CBD 32 89 60            ld      (SONG_TRIGGER),a
3028   0CC0                     
3029   0CC0                     ; Display the rivets stage
3030   0CC0 11 FD 3B            ld      de,L_RIVETS_STAGE_DATA
3031   0CC3                     
3032   0CC3 CD A4 0D    l0cc6:  call    L_DISPLAY_STAGE
3033   0CC6             		
3034   0CC6             		; If the current stage is the rivets stage
3035   0CC6 3A 27 62            ld      a,(CURRENT_STAGE)
3036   0CC9 FE 04               cp      4
3037   0CCB CC FD 0C            call    z,L_DISPLAY_RIVETS
3038   0CCE                     
3039   0CCE                     ; Jump ahead to fully initialize the stage
3040   0CCE C3 A1 3E            jp      L_WIERD_DISPLAY_STAGE_FN
3041   0CD1                     
3042   0CD1                     ; Display the barrels stage 
3043   0CD1 11 56 3A    l0cd4:  ld      de,L_BARRELS_STAGE_DATA
3044   0CD4 3E 08               ld      a,SONG_TRIGGER_BG_BARRELS
3045   0CD6 32 89 60            ld      (SONG_TRIGGER),a
3046   0CD9 C3 C3 0C            jp      l0cc6
3047   0CDC                     
3048   0CDC                     ; Display the mixer stage
3049   0CDC 11 CF 3A    l0cdf:  ld      de,L_MIXER_STAGE_DATA
3050   0CDF 21 86 7D            ld      hl,PALETTE_1_OUTPUT
3051   0CE2 36 01               ld      (hl),1
3052   0CE4 23                  inc     hl
3053   0CE5 36 00               ld      (hl),0
3054   0CE7 3E 09               ld      a,SONG_TRIGGER_BG_MIXER
3055   0CE9 32 89 60            ld      (SONG_TRIGGER),a
3056   0CEC C3 C3 0C            jp      l0cc6
3057   0CEF                     
3058   0CEF                     ; Display the elevators stage
3059   0CEF CD 24 0D    l0cf2:  call    L_DRAW_ELEVATOR_SUPPORTS
3060   0CF2 3E 0A               ld      a,SONG_TRIGGER_BG_ELEVATORS
3061   0CF4 32 89 60            ld      (SONG_TRIGGER),a
3062   0CF7 11 57 3B            ld      de,L_ELEVATORS_STAGE_DATA
3063   0CFA C3 C3 0C            jp      l0cc6
3064   0CFD             ;------------------------------------------------------------------------------
3065   0CFD             
3066   0CFD             
3067   0CFD             
3068   0CFD             ;------------------------------------------------------------------------------
3069   0CFD             ; Display the rivets on the rivets level
3070   0CFD             L_DISPLAY_RIVETS:  
3071   0CFD 06 08       		ld      b,8							; For b = 8 to 1
3072   0CFF 21 14 0D            ld      hl,L_RIVET_COORD_DATA					; hl = address of rivet coordinates
3073   0D02 3E B8       l0d05:  ld      a,$b8						; a = rivet tile
3074   0D04 0E 02               ld      c,$02						; For c = 2 to 1
3075   0D06 5E                  ld      e,(hl)						; de = coordinate from table
3076   0D07 23                  inc     hl
3077   0D08 56                  ld      d,(hl)
3078   0D09 23                  inc     hl							; hl = next table entry
3079   0D0A 12          l0d0d:  ld      (de),a						; display the rivet tile at the coordinate in de
3080   0D0B 3D                  dec     a							; --a
3081   0D0C 13                  inc     de							; de = next row down
3082   0D0D 0D                  dec     c							
3083   0D0E C2 0A 0D            jp      nz,l0d0d					; Next c
3084   0D11 10 EF               djnz    l0d05						; Next b
3085   0D13 C9                  ret     
3086   0D14             ;------------------------------------------------------------------------------
3087   0D14             
3088   0D14             
3089   0D14             
3090   0D14             ;------------------------------------------------------------------------------
3091   0D14             ; Coordinates of rivets
3092   0D14             L_RIVET_COORD_DATA:	
3093   0D14 CA 76       		.word	TILE_COORD(22,10)
3094   0D16 CF 76       		.word	TILE_COORD(22,15)
3095   0D18 D4 76       		.word	TILE_COORD(22,20)
3096   0D1A D9 76       		.word	TILE_COORD(22,25)
3097   0D1C 2A 75       		.word	TILE_COORD(9,10)
3098   0D1E 2F 75       		.word	TILE_COORD(9,15)
3099   0D20 34 75       		.word	TILE_COORD(9,20)
3100   0D22 39 75       		.word	TILE_COORD(9,25)
3101   0D24             ;------------------------------------------------------------------------------
3102   0D24             
3103   0D24             
3104   0D24             
3105   0D24             ;------------------------------------------------------------------------------
3106   0D24             ; Draw the elevator supports on the elevators stage
3107   0D24             L_DRAW_ELEVATOR_SUPPORTS:  
3108   0D24 21 0D 77    		ld      hl,TILE_COORD(24,13)
3109   0D27 CD 2D 0D            call    l0d30
3110   0D2A             		
3111   0D2A             		; Draw the right side of the elevator support
3112   0D2A 21 0D 76            ld      hl,TILE_COORD(16,13)
3113   0D2D 06 11       l0d30:  ld      b,17						; For b = 17 to 1 (17 tiles high)
3114   0D2F 36 FD       l0d32:  ld      (hl),$fd					
3115   0D31 23                  inc     hl
3116   0D32 10 FB               djnz    l0d32						; Next b
3117   0D34             		
3118   0D34             		; Draw the left side of the elevator support
3119   0D34 11 0F 00            ld      de,15						; Enough to move back to the top of the left side
3120   0D37 19                  add     hl,de
3121   0D38 06 11               ld      b,17						; For b = 17 to 1 (17 tiles high)
3122   0D3A 36 FC       l0d3d:  ld      (hl),$fc
3123   0D3C 23                  inc     hl
3124   0D3D 10 FB               djnz    l0d3d						; Next b
3125   0D3F C9                  ret     
3126   0D40             ;------------------------------------------------------------------------------
3127   0D40             
3128   0D40             
3129   0D40             
3130   0D40             ;------------------------------------------------------------------------------
3131   0D40             ; Draw the posts that support Pauline's platform on the rivets stage
3132   0D40             L_DRAW_PAULINE_PLAT_POSTS:  
3133   0D40             		; Draw the post at (20,7)-(21,10)
3134   0D40 21 87 76    		ld      hl,TILE_COORD(20,7)
3135   0D43 CD 49 0D            call    l0d4c
3136   0D46             
3137   0D46             		; Draw the post at (10,7)-(11,10)
3138   0D46 21 47 75            ld      hl,TILE_COORD(10,7)
3139   0D49             
3140   0D49             		; Draw the right half of the post supporting Pauline's platform on the rivets stage
3141   0D49 06 04       l0d4c:  ld      b,4						; For b = 4 to 1
3142   0D4B 36 FD       l0d4e:  ld      (hl),$fd
3143   0D4D 23                  inc     hl
3144   0D4E 10 FB               djnz    l0d4e						; Next b
3145   0D50             
3146   0D50             		; Draw the left half of the post
3147   0D50 11 1C 00            ld      de,28						; Move 1 column left
3148   0D53 19                  add     hl,de
3149   0D54 06 04               ld      b,4						; For b = 4 to 1
3150   0D56 36 FC       l0d59:  ld      (hl),$fc
3151   0D58 23                  inc     hl
3152   0D59 10 FB               djnz    l0d59						; Next b
3153   0D5B C9                  ret     
3154   0D5C             ;------------------------------------------------------------------------------
3155   0D5C             
3156   0D5C             
3157   0D5C             
3158   0D5C             ;------------------------------------------------------------------------------
3159   0D5C             ; Complete the initialization of the current stage
3160   0D5C             ; Initializes the ladder data and positions Donkey Kong and Pauline for the stage
3161   0D5C             L_COMPLETE_STAGE_INIT:  
3162   0D5C             		
3163   0D5C CD 53 0F    		call    L_INIT_CURRENT_STAGE
3164   0D5F CD 26 24            call    L_PARSE_STAGE_LADDER_DATA
3165   0D62                     
3166   0D62                     ; Initialize the minor timer to 64
3167   0D62 21 09 60            ld      hl,MINOR_TIMER
3168   0D65 36 40               ld      (hl),64
3169   0D67                     
3170   0D67                     ; Advance the submode
3171   0D67 23                  inc     hl
3172   0D68 34                  inc     (hl)
3173   0D69                     
3174   0D69                     ; Load the Donkey Kong and Pauline sprites
3175   0D69 21 CE 37            ld      hl,L_DK_SPRITES_L_ARM_RAISED
3176   0D6C CD 4E 00            call    L_LOAD_DK_SPRITES
3177   0D6F 11 00 69            ld      de,PAULINE_UPPER_SPRITE_X
3178   0D72 01 08 00            ld      bc,8
3179   0D75 ED B0               ldir    
3180   0D77                     
3181   0D77                     ; If the current stage is the rivets stage, jump ahead
3182   0D77 3A 27 62            ld      a,(CURRENT_STAGE)
3183   0D7A FE 04               cp      4
3184   0D7C 28 0A               jr      z,l0d8b
3185   0D7E                     
3186   0D7E                     ; Return if the stage is the mixer or elevators
3187   0D7E 0F                  rrca    
3188   0D7F 0F                  rrca    
3189   0D80 D8                  ret     c
3190   0D81                     
3191   0D81                     ; Move Donkey Kong in place for the barrels stage
3192   0D81 21 0B 69            ld      hl,DK_SPRITE_1_Y
3193   0D84 0E FC               ld      c,-4
3194   0D86 FF                  rst     $38
3195   0D87 C9                  ret     
3196   0D88                     
3197   0D88                     ; Move Donkey Kong into position for the rivets stage
3198   0D88 21 08 69    l0d8b:  ld      hl,DK_SPRITE_1_X
3199   0D8B 0E 44               ld      c,68
3200   0D8D FF                  rst     $38
3201   0D8E                     
3202   0D8E                     ; Move Pauline into place for the rivets stage
3203   0D8E 11 04 00            ld      de,4						; 4 bytes per sprite structure
3204   0D91 01 10 02            ld      bc,TWO_BYTES(2,16)		; 2 sprites to copy, move by 16 pixels
3205   0D94 21 00 69            ld      hl,PAULINE_UPPER_SPRITE_X
3206   0D97 CD 3D 00            call    L_MOVE_N_SPRITES
3207   0D9A 01 F8 02            ld      bc,TWO_BYTES(2,$f8)		; 2 sprites to copy, move -8 pixels 
3208   0D9D 21 03 69            ld      hl,PAULINE_UPPER_SPRITE_Y
3209   0DA0 CD 3D 00            call    L_MOVE_N_SPRITES
3210   0DA3 C9                  ret     
3211   0DA4             ;------------------------------------------------------------------------------
3212   0DA4             
3213   0DA4             
3214   0DA4             
3215   0DA4             ;------------------------------------------------------------------------------
3216   0DA4             ; Display the game screen for the current stage
3217   0DA4             ;
3218   0DA4             ; The screen data is read in starting at the memory location in de and ending when
3219   0DA4             ; $aa is read in.
3220   0DA4             ;
3221   0DA4             ; The stage data consists of 5 byte entries.  Each entry causes a line of tiles 
3222   0DA4             ; to be drawn on the screen between two coordinates.
3223   0DA4             ;
3224   0DA4             ;	byte 0 = Identifies the type of line to display
3225   0DA4             ;		0 = ladder (vertical)
3226   0DA4             ;		1 = broken ladder (vertical)
3227   0DA4             ;		2 = girders in the barrel's stage
3228   0DA4             ;        3 = Girders with square holes
3229   0DA4             ;        4 = Blank tiles
3230   0DA4             ;        5 = Girders with circular holes
3231   0DA4             ;        6 = X's (tile number $FE)
3232   0DA4             ;		$aa = marks the end of the screen data
3233   0DA4             ;
3234   0DA4             ;	byte 1 = x1 coord
3235   0DA4             ;		5 msbs = the tile x coord
3236   0DA4             ;		3 lsbs = unknown
3237   0DA4             ;		(with the 3 lsbs masked out, this is actually the pixel x coord of the upper left corner of the tile)
3238   0DA4             ;
3239   0DA4             ;	byte 2 = y1 coord
3240   0DA4             ;		5 msbs = the tile y coord
3241   0DA4             ;		3 lsbs = the tile offset (0-7) of the first tile (barrel girders and ladders only)
3242   0DA4             ;		(with the 3 lsbs masked out, this is actually the pixel y coord of the upper left corner of the tile)
3243   0DA4             
3244   0DA4             ;	byte 3 = x2 coord
3245   0DA4             ;		5 msbs = the tile x coord
3246   0DA4             ;		3 lsbs = unknown
3247   0DA4             ;		(with the 3 lsbs masked out, this is actually the pixel x coord of the upper left corner of the tile)
3248   0DA4             ;
3249   0DA4             ;	byte 4 = y2 coord
3250   0DA4             ;		5 msbs = the tile y coord
3251   0DA4             ;		3 lsbs = the tile offset (0-7) of the last tile (barrel girders and ladders only)
3252   0DA4             ;		(with the 3 lsbs masked out, this is actually the pixel y coord of the upper left corner of the tile)
3253   0DA4             ;
3254   0DA4             ; passed:	de - starting ROM address for screen data
3255   0DA4             L_DISPLAY_STAGE:  
3256   0DA4             		; Read in the next tile ID
3257   0DA4 1A          		ld      a,(de)
3258   0DA5 32 B3 63            ld      (STAGE_DATA_TILE_ID),a
3259   0DA8             
3260   0DA8             		; Return if an $aa was found
3261   0DA8 FE AA               cp      $aa
3262   0DAA C8                  ret     z
3263   0DAB             
3264   0DAB             		; Read in the first stage location
3265   0DAB 13                  inc     de
3266   0DAC 1A                  ld      a,(de)
3267   0DAD 67                  ld      h,a
3268   0DAE 44                  ld      b,h						; b = x coord
3269   0DAF 13                  inc     de
3270   0DB0 1A                  ld      a,(de)
3271   0DB1 6F                  ld      l,a
3272   0DB2 4D                  ld      c,l						; c = y coord
3273   0DB3             
3274   0DB3             		; Convert the location data in hl to a tile memory address
3275   0DB3 D5                  push    de
3276   0DB4 CD 73 2F            call    L_STAGE_LOC_TO_ADDRESS
3277   0DB7 D1                  pop     de
3278   0DB8 22 AB 63            ld      (STAGE_DATA_START_ADDRESS),hl
3279   0DBB             
3280   0DBB             		; Isolate and save ??? (no idea what this is used for)
3281   0DBB 78                  ld      a,b
3282   0DBC E6 07               and     %00000111
3283   0DBE 32 B4 63            ld      (STAGE_DATA_UNKNOWN),a
3284   0DC1             
3285   0DC1             		; Isolate and save the y offset of the first tile
3286   0DC1 79                  ld      a,c
3287   0DC2 E6 07               and     %00000111
3288   0DC4 32 AF 63            ld      (STAGE_DATA_FIRST_Y_OFFSET),a
3289   0DC7             
3290   0DC7             		; Read in the ending x location
3291   0DC7 13                  inc     de
3292   0DC8 1A                  ld      a,(de)
3293   0DC9 67                  ld      h,a
3294   0DCA                     
3295   0DCA                     ; Calculate the x difference between the start and end x coordinates
3296   0DCA 90                  sub     b
3297   0DCB D2 D0 0D            jp      nc,l0dd3
3298   0DCE ED 44               neg    
3299   0DD0 32 B1 63    l0dd3:  ld      (STAGE_DATA_X_DIFF),a
3300   0DD3             
3301   0DD3             		; Read the ending y location
3302   0DD3 13                  inc     de
3303   0DD4 1A                  ld      a,(de)
3304   0DD5 6F                  ld      l,a
3305   0DD6                     
3306   0DD6                     ; Calculate the y difference
3307   0DD6 91                  sub     c
3308   0DD7 32 B2 63            ld      (STAGE_DATA_Y_DIFF),a
3309   0DDA                     
3310   0DDA                     ; Determine the bottom y offset?
3311   0DDA 1A                  ld      a,(de)
3312   0DDB E6 07               and     %00000111
3313   0DDD 32 B0 63            ld      (STAGE_DATA_LAST_Y_OFFSET),a
3314   0DE0                     
3315   0DE0                     ; Convert the ending location to a tile memory address
3316   0DE0 D5                  push    de
3317   0DE1 CD 73 2F            call    L_STAGE_LOC_TO_ADDRESS
3318   0DE4 D1                  pop     de
3319   0DE5 22 AD 63            ld      (STAGE_DATA_END_ADDRESS),hl
3320   0DE8             
3321   0DE8             		; If ladders are not being drawn, jump ahead
3322   0DE8 3A B3 63            ld      a,(STAGE_DATA_TILE_ID)
3323   0DEB FE 02               cp      2
3324   0DED F2 4C 0E            jp      p,l0e4f
3325   0DF0             
3326   0DF0             		; Subtract the two tiles that are being drawn
3327   0DF0             		; (the girder and the ladder below it)
3328   0DF0 3A B2 63            ld      a,(STAGE_DATA_Y_DIFF)
3329   0DF3 D6 10               sub     16						; = 2 tiles
3330   0DF5 47                  ld      b,a
3331   0DF6 3A AF 63            ld      a,(STAGE_DATA_FIRST_Y_OFFSET)
3332   0DF9 80                  add     a,b
3333   0DFA 32 B2 63            ld      (STAGE_DATA_Y_DIFF),a
3334   0DFD                     
3335   0DFD                     ; Display the correctly offset girder tile at this location
3336   0DFD 3A AF 63            ld      a,(STAGE_DATA_FIRST_Y_OFFSET)
3337   0E00 C6 F0               add     a,-16
3338   0E02 2A AB 63            ld      hl,(STAGE_DATA_START_ADDRESS)
3339   0E05 77                  ld      (hl),a
3340   0E06                     
3341   0E06                     ; Display the correctly offset top of ladder tile on the next row down
3342   0E06 2C                  inc     l							; ++y
3343   0E07 D6 30               sub     48
3344   0E09 77                  ld      (hl),a
3345   0E0A                     
3346   0E0A                     ; If this is not a broken ladder, skip ahead
3347   0E0A 3A B3 63            ld      a,(STAGE_DATA_TILE_ID)
3348   0E0D FE 01               cp      1
3349   0E0F C2 16 0E            jp      nz,l0e19
3350   0E12                     
3351   0E12                     ; If this is a broken ladder, then force the rest of the ladder to be skipped
3352   0E12 AF                  xor     a
3353   0E13 32 B2 63            ld      (STAGE_DATA_Y_DIFF),a
3354   0E16                     
3355   0E16                     ; Subtract the next tile that is being drawn
3356   0E16 3A B2 63    l0e19:  ld      a,(STAGE_DATA_Y_DIFF)
3357   0E19 D6 08               sub     8							; = 1 tile
3358   0E1B 32 B2 63            ld      (STAGE_DATA_Y_DIFF),a
3359   0E1E                     
3360   0E1E                     ; If this is the bottom of the ladder, jump ahead to draw the bottom of the ladder
3361   0E1E DA 27 0E            jp      c,l0e2a
3362   0E21                     
3363   0E21                     ; Draw a ladder tile on the next row
3364   0E21 2C                  inc     l
3365   0E22 36 C0               ld      (hl),$c0
3366   0E24                     
3367   0E24                     ; Continue drawing the ladder
3368   0E24 C3 16 0E            jp      l0e19
3369   0E27                     
3370   0E27                     ; Determine the correct bottom ladder tile 
3371   0E27 3A B0 63    l0e2a:  ld      a,(STAGE_DATA_LAST_Y_OFFSET)
3372   0E2A C6 D0               add     a,$d0
3373   0E2C                     
3374   0E2C                     ; Draw the bottom tile at the ending screen memory address
3375   0E2C 2A AD 63            ld      hl,(STAGE_DATA_END_ADDRESS)
3376   0E2F 77                  ld      (hl),a
3377   0E30                     
3378   0E30                     ; If not drawing a broken ladder, jump ahead
3379   0E30 3A B3 63            ld      a,(STAGE_DATA_TILE_ID)
3380   0E33 FE 01               cp      1
3381   0E35 C2 3C 0E            jp      nz,l0e3f
3382   0E38                     
3383   0E38                     ; If drawing a broken ladder, draw one extra ladder tile
3384   0E38                     ; just above the bottom
3385   0E38 2D                  dec     l							; --y
3386   0E39 36 C0               ld      (hl),$c0
3387   0E3B 2C                  inc     l							; ++y
3388   0E3C                     
3389   0E3C                     ; If the bottom tile is not offset, jump ahead
3390   0E3C 3A B0 63    l0e3f:  ld      a,(STAGE_DATA_LAST_Y_OFFSET)
3391   0E3F FE 00               cp      $00
3392   0E41 CA 48 0E            jp      z,l0e4b
3393   0E44                     
3394   0E44                     ; Draw the rest of the lower girder on the next row
3395   0E44 C6 E0               add     a,$e0
3396   0E46 2C                  inc     l
3397   0E47 77                  ld      (hl),a
3398   0E48                     
3399   0E48                     ; Move on to the next group of stage data
3400   0E48 13          l0e4b:  inc     de
3401   0E49 C3 A4 0D            jp      L_DISPLAY_STAGE
3402   0E4C                     
3403   0E4C                     ; If barrel stage girders are not being drawn, jump ahead 
3404   0E4C 3A B3 63    l0e4f:  ld      a,(STAGE_DATA_TILE_ID)
3405   0E4F FE 02               cp      2
3406   0E51 C2 E5 0E            jp      nz,l0ee8
3407   0E54                     
3408   0E54                     ; Determine the first tile to draw based on the tile offset
3409   0E54 3A AF 63            ld      a,(STAGE_DATA_FIRST_Y_OFFSET)
3410   0E57 C6 F0               add     a,$f0
3411   0E59 32 B5 63            ld      (STAGE_DATA_CURRENT_TILE),a
3412   0E5C                     
3413   0E5C                     ; Get the first screen memory location to draw the tile to
3414   0E5C 2A AB 63            ld      hl,(STAGE_DATA_START_ADDRESS)
3415   0E5F                     
3416   0E5F                     ; Draw the tile at the current screen address
3417   0E5F 3A B5 63    l0e62:  ld      a,(STAGE_DATA_CURRENT_TILE)
3418   0E62 77                  ld      (hl),a
3419   0E63                     
3420   0E63                     ; If this is the bottom of the screen, jump ahead
3421   0E63 23                  inc     hl
3422   0E64 7D                  ld      a,l
3423   0E65 E6 1F               and     %00011111
3424   0E67 CA 75 0E            jp      z,l0e78
3425   0E6A                     
3426   0E6A                     ; If the the girder tile was not offset, jump ahead
3427   0E6A 3A B5 63            ld      a,(STAGE_DATA_CURRENT_TILE)
3428   0E6D FE F0               cp      $f0
3429   0E6F CA 75 0E            jp      z,l0e78
3430   0E72                     
3431   0E72                     ; Draw the tile to complete the girder
3432   0E72 D6 10               sub     $10
3433   0E74 77                  ld      (hl),a
3434   0E75                     
3435   0E75                     ; Advance to the next column
3436   0E75 01 1F 00    l0e78:  ld      bc,31
3437   0E78 09                  add     hl,bc
3438   0E79                     
3439   0E79                     ; If the end of the line has been reached, jump ahead to operate on the next stage data group
3440   0E79 3A B1 63            ld      a,(STAGE_DATA_X_DIFF)
3441   0E7C D6 08               sub     8							; = 1 tile
3442   0E7E DA CC 0E            jp      c,l0ecf
3443   0E81                     
3444   0E81                     ; If the line is horizontal, jump back up to continue drawing tiles
3445   0E81 32 B1 63            ld      (STAGE_DATA_X_DIFF),a
3446   0E84 3A B2 63            ld      a,(STAGE_DATA_Y_DIFF)
3447   0E87 FE 00               cp      0
3448   0E89 CA 5F 0E            jp      z,l0e62
3449   0E8C                     
3450   0E8C                     ; Display the tile at the current screen address
3451   0E8C 3A B5 63            ld      a,(STAGE_DATA_CURRENT_TILE)
3452   0E8F 77                  ld      (hl),a
3453   0E90                     
3454   0E90                     ; If this is the bottom of the screen, jump ahead
3455   0E90 23                  inc     hl
3456   0E91 7D                  ld      a,l
3457   0E92 E6 1F               and     %00011111
3458   0E94 CA 9D 0E            jp      z,l0ea0
3459   0E97                     
3460   0E97                     ; Draw the tile to complete the girder
3461   0E97 3A B5 63            ld      a,(STAGE_DATA_CURRENT_TILE)
3462   0E9A D6 10               sub     16
3463   0E9C 77                  ld      (hl),a
3464   0E9D                     
3465   0E9D                     ; Advance to the next column right
3466   0E9D 01 1F 00    l0ea0:  ld      bc,$001f
3467   0EA0 09                  add     hl,bc
3468   0EA1                     
3469   0EA1                     ; If the end of the line has been reached, jump ahead to operate on the next stage data group
3470   0EA1 3A B1 63            ld      a,(STAGE_DATA_X_DIFF)
3471   0EA4 D6 08               sub     8							; = 1 tile
3472   0EA6 DA CC 0E            jp      c,l0ecf
3473   0EA9                     
3474   0EA9                     ; If the line is sloping up, jump ahead
3475   0EA9 32 B1 63            ld      (STAGE_DATA_X_DIFF),a
3476   0EAC 3A B2 63            ld      a,(STAGE_DATA_Y_DIFF)
3477   0EAF CB 7F               bit     7,a
3478   0EB1 C2 D0 0E            jp      nz,l0ed3
3479   0EB4                     
3480   0EB4                     ; Handle lines sloping down
3481   0EB4                     
3482   0EB4                     ; Change the tile to the next offset down
3483   0EB4 3A B5 63            ld      a,(STAGE_DATA_CURRENT_TILE)
3484   0EB7 3C                  inc     a
3485   0EB8 32 B5 63            ld      (STAGE_DATA_CURRENT_TILE),a
3486   0EBB                     
3487   0EBB                     ; If it's not time to advance to the next row down, jump ahead
3488   0EBB FE F8               cp      $f8
3489   0EBD C2 C6 0E            jp      nz,l0ec9
3490   0EC0                     
3491   0EC0                     ; Advance to the next row down and reset the tile to the first full girder
3492   0EC0 23                  inc     hl
3493   0EC1 3E F0               ld      a,$f0
3494   0EC3 32 B5 63            ld      (STAGE_DATA_CURRENT_TILE),a
3495   0EC6                     
3496   0EC6                     ; If this is not the bottom of the screen, jump back to continue drawing the line
3497   0EC6 7D          l0ec9:  ld      a,l
3498   0EC7 E6 1F               and     %00011111
3499   0EC9 C2 5F 0E            jp      nz,l0e62
3500   0ECC                     
3501   0ECC                     ; Move on to the next group of stage data
3502   0ECC 13          l0ecf:  inc     de
3503   0ECD C3 A4 0D            jp      L_DISPLAY_STAGE
3504   0ED0                     
3505   0ED0             		; Handle lines sloping up
3506   0ED0             		
3507   0ED0             		; Change the tile to the next offset up
3508   0ED0 3A B5 63    l0ed3:  ld      a,(STAGE_DATA_CURRENT_TILE)
3509   0ED3 3D                  dec     a
3510   0ED4 32 B5 63            ld      (STAGE_DATA_CURRENT_TILE),a
3511   0ED7                     
3512   0ED7                     ; If it's not time to advance to the next row up, jump ahead
3513   0ED7 FE F0               cp      $f0
3514   0ED9 F2 E2 0E            jp      p,l0ee5
3515   0EDC                     
3516   0EDC                     ; Advance to the next row up and reset the tile to the first full girder
3517   0EDC 2B                  dec     hl
3518   0EDD 3E F7               ld      a,$f7
3519   0EDF 32 B5 63            ld      (STAGE_DATA_CURRENT_TILE),a
3520   0EE2                     
3521   0EE2                     ; Jump back up to continue drawing the line
3522   0EE2 C3 5F 0E    l0ee5:  jp      l0e62
3523   0EE5             
3524   0EE5             		; If not drawing ???, jump ahead
3525   0EE5 3A B3 63    l0ee8:  ld      a,(STAGE_DATA_TILE_ID)
3526   0EE8 FE 03               cp      3
3527   0EEA C2 18 0F            jp      nz,l0f1b
3528   0EED                     
3529   0EED                     ; Draw a blank tile at this screen address
3530   0EED 2A AB 63            ld      hl,(STAGE_DATA_START_ADDRESS)
3531   0EF0 3E B3               ld      a,$b3					; blank tile
3532   0EF2 77                  ld      (hl),a
3533   0EF3                     
3534   0EF3                     ; Advance to the next column right
3535   0EF3 01 20 00            ld      bc,32
3536   0EF6 09                  add     hl,bc
3537   0EF7                     
3538   0EF7                     ; If this is the end of the line, jump ahead
3539   0EF7 3A B1 63            ld      a,(STAGE_DATA_X_DIFF)
3540   0EFA D6 10               sub     16						; = 2 tiles
3541   0EFC DA 11 0F    l0eff:  jp      c,l0f14
3542   0EFF 32 B1 63            ld      (STAGE_DATA_X_DIFF),a
3543   0F02                     
3544   0F02                     ; Draw a square-hole girder at this screen address
3545   0F02 3E B1               ld      a,$b1
3546   0F04 77                  ld      (hl),a
3547   0F05                     
3548   0F05                     ; Advance to the next column right
3549   0F05 01 20 00            ld      bc,32
3550   0F08 09                  add     hl,bc
3551   0F09                     
3552   0F09                     ; If this is the end of the line, jump ahead
3553   0F09 3A B1 63            ld      a,(STAGE_DATA_X_DIFF)
3554   0F0C D6 08               sub     8							; = 1 tile
3555   0F0E                     
3556   0F0E                     ; Jump back up to continue drawing the line
3557   0F0E C3 FC 0E            jp      l0eff
3558   0F11                     
3559   0F11                     ; Draw a blank tile at the current screen address
3560   0F11 3E B2       l0f14:  ld      a,$b2
3561   0F13 77                  ld      (hl),a
3562   0F14                     
3563   0F14                     ; Jump back to process the next stage data group
3564   0F14 13                  inc     de
3565   0F15 C3 A4 0D            jp      L_DISPLAY_STAGE
3566   0F18                     
3567   0F18                     ; If tile is ???, then jump back to handle the next group of stage data
3568   0F18 3A B3 63    l0f1b:  ld      a,(STAGE_DATA_TILE_ID)
3569   0F1B FE 07               cp      7
3570   0F1D F2 CC 0E            jp      p,l0ecf	
3571   0F20                     
3572   0F20                     ; If drawing blank tiles, jump ahead
3573   0F20 FE 04               cp      4
3574   0F22 CA 49 0F            jp      z,l0f4c
3575   0F25                     
3576   0F25                     ; If drawing circular-hole girders, jump ahead
3577   0F25 FE 05               cp      5
3578   0F27 CA 4E 0F            jp      z,l0f51
3579   0F2A                     
3580   0F2A                     ; Draw X's, 
3581   0F2A                     
3582   0F2A                     ; Select the 'X' tile
3583   0F2A 3E FE               ld      a,$fe
3584   0F2C 32 B5 63    l0f2f:  ld      (STAGE_DATA_CURRENT_TILE),a
3585   0F2F             
3586   0F2F             		; Draw the til to the current screen address
3587   0F2F 2A AB 63            ld      hl,(STAGE_DATA_START_ADDRESS)
3588   0F32 3A B5 63    l0f35:  ld      a,(STAGE_DATA_CURRENT_TILE)
3589   0F35 77                  ld      (hl),a
3590   0F36                     
3591   0F36                     ; Advance to the next column right
3592   0F36 01 20 00            ld      bc,32
3593   0F39 09                  add     hl,bc
3594   0F3A                     
3595   0F3A                     ; Subtract one tile from the line
3596   0F3A 3A B1 63            ld      a,(STAGE_DATA_X_DIFF)
3597   0F3D D6 08               sub     8						; = 1 tile
3598   0F3F 32 B1 63            ld      (STAGE_DATA_X_DIFF),a
3599   0F42                     
3600   0F42                     ; If this is not the end of the line, jump up to continue processing it
3601   0F42 D2 32 0F            jp      nc,l0f35
3602   0F45                     
3603   0F45                     ; Jump up to process the next group of stage data
3604   0F45 13                  inc     de
3605   0F46 C3 A4 0D            jp      L_DISPLAY_STAGE
3606   0F49                     
3607   0F49                     ; Draw blank tiles?
3608   0F49 3E E0       l0f4c:  ld      a,$e0
3609   0F4B C3 2C 0F            jp      l0f2f
3610   0F4E                     
3611   0F4E                     ; Draw girders with circular holes
3612   0F4E 3E B0       l0f51:  ld      a,$b0
3613   0F50 C3 2C 0F            jp      l0f2f
3614   0F53             ;------------------------------------------------------------------------------
3615   0F53             
3616   0F53             
3617   0F53             
3618   0F53             ;------------------------------------------------------------------------------
3619   0F53             ; Initialize the current stage
3620   0F53             L_INIT_CURRENT_STAGE:  
3621   0F53             		; Zero all of Mario's data
3622   0F53 06 27       		ld      b,39						; For b = 39 to 1
3623   0F55 21 00 62            ld      hl,MARIO_DATA_STRUCT
3624   0F58 AF          l0f5b:  xor     a						; a = 0
3625   0F59 77          l0f5c:  ld      (hl),a					; Zero the current address
3626   0F5A 2C                  inc     l
3627   0F5B 10 FC               djnz    l0f5c					; Next b
3628   0F5D                     
3629   0F5D                     ; Zero $6280 to $6aff
3630   0F5D                     ; (includes all stage data and sprite data structures)
3631   0F5D 0E 11               ld      c,17						; For c = 17 to 1
3632   0F5F 16 80               ld      d,128
3633   0F61 21 80 62            ld      hl,STAGE_DATA_BLOCK
3634   0F64 42          l0f67:  ld      b,d						; For b = 128 to 1
3635   0F65 77          l0f68:  ld      (hl),a					; Zero the current address
3636   0F66 23                  inc     hl
3637   0F67 10 FC               djnz    l0f68					; next b
3638   0F69 0D                  dec     c
3639   0F6A 20 F8               jr      nz,l0f67					; Next c
3640   0F6C                    
3641   0F6C             		; Load the stage variables with their initial values
3642   0F6C 21 0E 3D            ld      hl,L_INITIAL_STAGE_DATA_TABLE
3643   0F6F 11 80 62            ld      de,STAGE_DATA_BLOCK
3644   0F72 01 40 00            ld      bc,64					; 64 bytes of data
3645   0F75 ED B0               ldir    
3646   0F77                     
3647   0F77                     ; Initialize the timer to the (current level number x 10) + 40
3648   0F77 3A 29 62            ld      a,(CP_LEVEL_NUMBER)
3649   0F7A 47                  ld      b,a
3650   0F7B A7                  and     a
3651   0F7C 17                  rla     
3652   0F7D A7                  and     a
3653   0F7E 17                  rla     
3654   0F7F A7                  and     a
3655   0F80 17                  rla     
3656   0F81 80                  add     a,b
3657   0F82 80                  add     a,b						; a = level number x 10
3658   0F83 C6 28               add     a,40
3659   0F85                     
3660   0F85                     ; Cap the timer at 80
3661   0F85 FE 51               cp      81
3662   0F87 38 02               jr      c,l0f8e
3663   0F89 3E 50               ld      a,80
3664   0F8B                     
3665   0F8B 21 B0 62    l0f8e:  ld      hl,INTERNAL_TIMER
3666   0F8E                     
3667   0F8E                     ; Save the timer value to the internal timer, $62b1, and $62b2
3668   0F8E 06 03               ld      b,3						; for b = 3 to 1
3669   0F90 77          l0f93:  ld      (hl),a
3670   0F91 2C                  inc     l
3671   0F92 10 FC               djnz    l0f93					; Next b
3672   0F94                     
3673   0F94                     ; Initialize $62b3
3674   0F94 87                  add     a,a
3675   0F95 47                  ld      b,a
3676   0F96 3E DC               ld      a,220
3677   0F98 90                  sub     b
3678   0F99                     
3679   0F99                     ; Cap $62b3 at 40
3680   0F99 FE 28               cp      40
3681   0F9B 30 02               jr      nc,l0fa2
3682   0F9D 3E 28               ld      a,40
3683   0F9F 77          l0fa2:  ld      (hl),a
3684   0FA0             
3685   0FA0             		; Initialize $62b4
3686   0FA0 2C                  inc     l
3687   0FA1 77                  ld      (hl),a
3688   0FA2                     
3689   0FA2 21 09 62            ld      hl,$6209
3690   0FA5 36 04               ld      (hl),4
3691   0FA7                     
3692   0FA7 2C                  inc     l						; $620a
3693   0FA8 36 08               ld      (hl),8
3694   0FAA                     
3695   0FAA                     ; If current stage is not rivets, jump ahead
3696   0FAA 3A 27 62            ld      a,(CURRENT_STAGE)
3697   0FAD 4F                  ld      c,a
3698   0FAE CB 57               bit     2,a
3699   0FB0 20 16               jr      nz,l0fcb
3700   0FB2                     
3701   0FB2                     ; Initialize 3 sprites
3702   0FB2 21 00 6A            ld      hl,$6a00
3703   0FB5 3E 4F               ld      a,79
3704   0FB7 06 03               ld      b,3						; For b = 3 to 1
3705   0FB9 77          l0fbc:  ld      (hl),a					; Sprite x 
3706   0FBA 2C                  inc     l
3707   0FBB 36 3A               ld      (hl),$3a					; Sprite number = solid block?
3708   0FBD 2C                  inc     l
3709   0FBE 36 0F               ld      (hl),$0f					; Sprite palette
3710   0FC0 2C                  inc     l
3711   0FC1 36 18               ld      (hl),24					; Sprite y				
3712   0FC3 2C                  inc     l
3713   0FC4 C6 10               add     a,16						; Move the next sprite right 16 pixels
3714   0FC6 10 F1               djnz    l0fbc						; Next b
3715   0FC8                     
3716   0FC8                     ; Jump to a function in the table based on the current stage 
3717   0FC8                     ; to setup the current stage
3718   0FC8 79          l0fcb:  ld      a,c
3719   0FC9 EF                  rst     $28							; Jump to local table address
3720   0FCA             		; Jump table
3721   0FCA 00 00       		.word	L_ORG	; 0 = reset game
3722   0FCC D4 0F       		.word	L_INIT_BARRELS_STAGE_SPRITES	; 1 = setup barrels stage sprites
3723   0FCE 1C 10       		.word	L_INIT_MIXER_STAGE_SPRITES	; 2 = setup mixer stage sprites
3724   0FD0 81 10       		.word	L_INIT_ELEVATOR_STAGE_SPRITES	; 3 = setup elevators stage sprites
3725   0FD2 23 11       		.word	L_INIT_RIVETS_STAGE_SPRITES	; 4 = setup rivets stage sprites
3726   0FD4             ;------------------------------------------------------------------------------
3727   0FD4             
3728   0FD4             
3729   0FD4             
3730   0FD4             ;------------------------------------------------------------------------------
3731   0FD4             ; Initialize the sprites for the barrels stage
3732   0FD4             L_INIT_BARRELS_STAGE_SPRITES:	
3733   0FD4             		; Load the sprite data for the four standing barrels next to Donkey Kong
3734   0FD4 21 4E 3D    		ld      hl,L_STANDING_BARRELS_SPRITE_DATA
3735   0FD7 11 A8 69            ld      de,STANDING_BARREL_SPRITE_DATA
3736   0FDA 01 10 00            ld      bc,16
3737   0FDD ED B0               ldir    
3738   0FDF                     
3739   0FDF                     ; Initialize the fire ball data structures
3740   0FDF 21 5E 3D            ld      hl,L_FIREBALL_SPRITE_DATA
3741   0FE2 11 07 64            ld      de,FIREBALL_STRUCTS+7	; Sprite number entry
3742   0FE5 0E 1C               ld      c,28					; Destination blocks are spaces 32 bytes apart
3743   0FE7 06 05               ld      b,5					; Copy 5 blocks of 4 byte data
3744   0FE9 CD 1C 12            call    L_LD_SPRITE_DATA_TO_STRUCT
3745   0FEC             
3746   0FEC             		; Load the initial data for the oil barrel fire
3747   0FEC             		; (fire not lit)
3748   0FEC 21 66 3D            ld      hl,L_BARRELS_FIRE_SPRITE_DATA
3749   0FEF CD EC 11            call    L_LOAD_BARREL_FIRE_DATA
3750   0FF2                     
3751   0FF2                     ; Load the oil barrel sprite
3752   0FF2 21 72 3D            ld      hl,L_OIL_BARREL_SPRITE_DATA_1
3753   0FF5 11 FC 69            ld      de,OIL_BARREL_SPRITE
3754   0FF8 01 04 00            ld      bc,4						; 4 bytes of data
3755   0FFB ED B0               ldir    
3756   0FFD                     
3757   0FFD                     ; Initialize the hammers
3758   0FFD 21 7E 3D            ld      hl,L_BARRELS_HAMMER_COORDS
3759   1000 CD 98 11            call    L_INIT_HAMMER_SPRITES
3760   1003                     
3761   1003                     ; Initialize 10 barrel sprites?
3762   1003                     ; Note: It looks like this code may be consolidated
3763   1003                     ;	   Instead of initializing 8 barrels and then 2 more,
3764   1003                     ;       I should be able to initialize all 10 at once
3765   1003 21 18 10            ld      hl,L_INITIAL_BARREL_DATA
3766   1006 11 07 67            ld      de,BARREL_STRUCTS+7				; Sprite number entry
3767   1009 01 1C 08            ld      bc,TWO_BYTES(8,28)		; 8 blocks, 32 byte data structures
3768   100C CD 1C 12            call    L_LD_SPRITE_DATA_TO_STRUCT
3769   100F 11 07 68            ld      de,BARREL_STRUCTS+(8*32)+7	; Sprite number entry
3770   1012 06 02               ld      b,2						; 2 blocks, 32 byte data structures
3771   1014 CD 1C 12            call    L_LD_SPRITE_DATA_TO_STRUCT
3772   1017 C9                  ret     
3773   1018             ;------------------------------------------------------------------------------
3774   1018             
3775   1018             
3776   1018             
3777   1018             ;------------------------------------------------------------------------------
3778   1018             ; The initial barrel data for barrels on the barrels stage
3779   1018             ; The barrels are initially inactive
3780   1018 00          L_INITIAL_BARREL_DATA:  .byte	0						; Sprite number					; Sprite number
3781   1019 00          		.byte	0						; Palette
3782   101A 02          		.byte	2						
3783   101B 02          		.byte	2
3784   101C             ;------------------------------------------------------------------------------
3785   101C             
3786   101C             
3787   101C             
3788   101C             ;------------------------------------------------------------------------------
3789   101C             ; Initialize the sprites for the mixer stage
3790   101C             L_INIT_MIXER_STAGE_SPRITES:  
3791   101C                     ; Initialize the fire ball data structures
3792   101C 21 5E 3D    		ld      hl,L_FIREBALL_SPRITE_DATA
3793   101F 11 07 64            ld      de,FIREBALL_STRUCTS+7			; Sprite number entry
3794   1022 01 1C 05            ld      bc,TWO_BYTES(5,28)				; 5 bytes, 32 byte data structures
3795   1025 CD 1C 12            call    L_LD_SPRITE_DATA_TO_STRUCT
3796   1028                     
3797   1028                     ; Initialize pie sprites
3798   1028 21 8A 3D            ld      hl,L_PIE_SPRITE_DATA
3799   102B 11 A7 65            ld      de,PIE_STRUCTS+7				; Sprite number entry
3800   102E 01 0C 06            ld      bc,TWO_BYTES(6,12)		; 6 blocks, 16 byte data structures
3801   1031 CD 1C 12            call    L_LD_SPRITE_DATA_TO_STRUCT
3802   1034 DD 21 A0 65         ld      ix,PIE_STRUCTS
3803   1038 21 B8 69            ld      hl,PIE_SPRITES
3804   103B 11 10 00            ld      de,16					; 16 byte data structures
3805   103E 06 06               ld      b,6						; 6 sprites
3806   1040 CD C5 11            call    L_COPY_STRUCT_TO_SPRITE
3807   1043                     
3808   1043                     ; Load the initial data for the oil barrel fire
3809   1043                     ; (Initially lit)
3810   1043 21 6C 3D    		ld      hl,L_MIXER_FIRE_SPRITE_DATA
3811   1046 CD EC 11            call    L_LOAD_BARREL_FIRE_DATA
3812   1049                             
3813   1049                     ; Load the oil barrel sprite
3814   1049 21 76 3D            ld      hl,L_OIL_BARREL_SPRITE_DATA_2
3815   104C 11 FC 69            ld      de,OIL_BARREL_SPRITE
3816   104F 01 04 00            ld      bc,4
3817   1052 ED B0               ldir    
3818   1054                     
3819   1054                     ; Initialize the retractable ladder sprites
3820   1054 21 8E 3D            ld      hl,L_RETRACT_LADDER_SPRITE_DATA
3821   1057 11 44 69            ld      de,RETRACTABLE_LADDER_SPRITES
3822   105A 01 08 00            ld      bc,8						; 2 sprites
3823   105D ED B0               ldir    
3824   105F                     
3825   105F                     ; Initialize the conveyer belt motor sprites
3826   105F 21 96 3D            ld      hl,L_MIXER_MOTOR_SPRITE_DATA
3827   1062 11 E4 69            ld      de,CONVEYER_MOTOR_SPRITES
3828   1065 01 18 00            ld      bc,24					; 6 sprites
3829   1068 ED B0               ldir    
3830   106A                     
3831   106A                     ; Initialize the hammers
3832   106A 21 82 3D            ld      hl,L_MIXER_HAMMER_COORDS
3833   106D CD 98 11            call    L_INIT_HAMMER_SPRITES
3834   1070                     
3835   1070                     ; Initialize the prize sprites
3836   1070 21 AE 3D            ld      hl,L_MIXER_PRIZE_SPRITE_DATA
3837   1073 11 0C 6A            ld      de,PRIZE_SPRITES
3838   1076 01 0C 00            ld      bc,12				; 3 sprites
3839   1079 ED B0               ldir    
3840   107B                     
3841   107B                     ; Mark the oil barrel fire as burning
3842   107B 3E 01               ld      a,1
3843   107D 32 B9 62            ld      (BARREL_FIRE_STATE),a
3844   1080 C9                  ret     
3845   1081             ;------------------------------------------------------------------------------
3846   1081             
3847   1081             
3848   1081             		
3849   1081             ;------------------------------------------------------------------------------
3850   1081             ; Initialize the sprites for the elevators stage
3851   1081             L_INIT_ELEVATOR_STAGE_SPRITES:  
3852   1081             		; Initialize the fire ball data structures
3853   1081 21 5E 3D    		ld      hl,L_FIREBALL_SPRITE_DATA
3854   1084 11 07 64            ld      de,FIREBALL_STRUCTS+7			; Sprite number entry
3855   1087 01 1C 05            ld      bc,TWO_BYTES(5,28)				; 5 bytes, 32 byte data structures
3856   108A CD 1C 12            call    L_LD_SPRITE_DATA_TO_STRUCT
3857   108D                     
3858   108D                     ; Initialize the springs
3859   108D CD 78 11            call    L_INIT_SPRING_DATA
3860   1090                     
3861   1090                     ; Mark the elevator platforms as active
3862   1090 21 00 66            ld      hl,ELEVATOR_STRUCTS
3863   1093 11 10 00            ld      de,16					; 16 byte data structures
3864   1096 3E 01               ld      a,1
3865   1098 06 06               ld      b,6						; For b = 6 to 1
3866   109A 77          l10a0:  ld      (hl),a
3867   109B 19                  add     hl,de
3868   109C 10 FC               djnz    l10a0						; Next b
3869   109E                     
3870   109E 3E 08               ld      a,8
3871   10A0 06 03       l10a8:  ld      b,3						; For b = 3 to 1
3872   10A2 21 0D 66            ld      hl,ELEVATOR_STRUCTS+13
3873   10A5 77          l10ad:  ld      (hl),a
3874   10A6 19                  add     hl,de
3875   10A7 10 FC               djnz    l10ad					; Next b
3876   10A9                     
3877   10A9                     ; Initialize the coordinates of the elevator platforms
3878   10A9 21 D6 3D            ld      hl,L_ELEVATOR_COORDS
3879   10AC 11 03 66            ld      de,ELEVATOR_STRUCTS+3		; X coordinate entry
3880   10AF 01 0E 06            ld      bc,TWO_BYTES(6,14)			; 6 sprites, 16 byte data structures
3881   10B2 CD DE 11            call    L_COPY_COORDS_TO_STRUCTS
3882   10B5                     
3883   10B5 21 D2 3D    l10c3:  ld      hl,L_ELEVATOR_SPRITE_DATA
3884   10B8 11 07 66            ld      de,ELEVATOR_STRUCTS+7					; Sprite number entry
3885   10BB 01 0C 06            ld      bc,TWO_BYTES(6,12)			; 6 sprites, 16 byte data structs
3886   10BE CD 1C 12            call    L_LD_SPRITE_DATA_TO_STRUCT
3887   10C1                     
3888   10C1                     ; Copy elevator data to the sprites
3889   10C1 DD 21 00 66         ld      ix,ELEVATOR_STRUCTS
3890   10C5 21 58 69            ld      hl,ELEVATOR_PLATFORM_SPRITES
3891   10C8 06 06               ld      b,6
3892   10CA 11 10 00            ld      de,16
3893   10CD CD C5 11            call    L_COPY_STRUCT_TO_SPRITE
3894   10D0                     
3895   10D0                     ; Load the prize sprites for the elevator stage
3896   10D0 21 BA 3D            ld      hl,L_ELEV_PRIZE_SPRITE_DATA
3897   10D3 11 0C 6A            ld      de,PRIZE_SPRITES
3898   10D6 01 0C 00            ld      bc,12						; 3 sprites
3899   10D9 ED B0               ldir    
3900   10DB                     
3901   10DB DD 21 00 64         ld      ix,FIREBALL_STRUCTS
3902   10DF DD 36 00 01         ld      (ix+0),1				; Fireball active
3903   10E3 DD 36 03 58         ld      (ix+3),88				; Fireball x coordinate
3904   10E7 DD 36 0E 58         ld      (ix+14),88
3905   10EB DD 36 05 80         ld      (ix+5),128				; Fireball y coordinate
3906   10EF DD 36 0F 80         ld      (ix+15),128
3907   10F3                     
3908   10F3 DD 36 20 01         ld      (ix+32),1				; Fireball active
3909   10F7 DD 36 23 EB         ld      (ix+35),235				; Fireball x coordinate
3910   10FB DD 36 2E EB         ld      (ix+46),235
3911   10FF DD 36 25 60         ld      (ix+37),96				; Fireball y coordinate
3912   1103 DD 36 2F 60         ld      (ix+47),96
3913   1107                     
3914   1107                     ; Load the elevator motor sprites
3915   1107 11 70 69            ld      de,ELEVATOR_MOTOR_SPRITE_DATA
3916   110A 21 13 11            ld      hl,L_ELEV_MOTOR_SPRITE_DATA
3917   110D 01 10 00            ld      bc,16					; 4 sprites
3918   1110 ED B0               ldir    
3919   1112 C9                  ret     
3920   1113             ;------------------------------------------------------------------------------
3921   1113             
3922   1113             
3923   1113             
3924   1113             ;------------------------------------------------------------------------------
3925   1113             ; Sprite data for each of the elevator motors on the elevator level
3926   1113             L_ELEV_MOTOR_SPRITE_DATA:	
3927   1113 37          		.byte	55	; X coordinate
3928   1114 45          		.byte	$45	; Sprite number
3929   1115 0F          		.byte	$0f	; Palette
3930   1116 60          		.byte	96	; Y coordinate
3931   1117             		
3932   1117 37          		.byte	55	; X coordinate
3933   1118 45          		.byte	$45	; Sprite number
3934   1119 8F          		.byte	$8f	; Palette (Flipped vertically)
3935   111A F7          		.byte	247	; Y coordinate
3936   111B             		
3937   111B 77          		.byte	119	; X coordinate
3938   111C 45          		.byte	$45	; Sprite number
3939   111D 0F          		.byte	$0f	; Palette
3940   111E 60          		.byte	96	; Y coordinate
3941   111F             		
3942   111F 77          		.byte	119	; X coordinate
3943   1120 45          		.byte	$45	; Sprite number
3944   1121 8F          		.byte	$8f	; Palette (Flipped vertically)
3945   1122 F7          		.byte	247	; Y coordinate
3946   1123             ; ------------------------------------------------------------------------------
3947   1123             
3948   1123              
3949   1123              
3950   1123             ;------------------------------------------------------------------------------
3951   1123             ; Initialize the sprites for the rivets stage
3952   1123             L_INIT_RIVETS_STAGE_SPRITES:  
3953   1123             		; Initialize the firefox sprites
3954   1123 21 62 3D    		ld      hl,L_FIREFOX_SPRITE_DATA
3955   1126 11 07 64            ld      de,FIREBALL_STRUCTS+7	; Sprite num entry
3956   1129 01 1C 05            ld      bc,TWO_BYTES(5,28)		; 5 sprites, 32 byte data structures
3957   112C CD 1C 12            call    L_LD_SPRITE_DATA_TO_STRUCT
3958   112F                     
3959   112F                     ; Initialize the hammers
3960   112F 21 86 3D            ld      hl,L_RIVETS_HAMMER_COORDS
3961   1132 CD 98 11            call    L_INIT_HAMMER_SPRITES
3962   1135                     
3963   1135                     ; Initialize the prize sprites
3964   1135 21 C6 3D            ld      hl,L_RIVETS_PRIZE_SPRITE_DATA
3965   1138 11 0C 6A            ld      de,PRIZE_SPRITES
3966   113B 01 0C 00            ld      bc,12					; 3 sprites
3967   113E ED B0               ldir    
3968   1140                     
3969   1140                     ; Initialize the two (invisible) collision detection sprites on either 
3970   1140                     ; side of Donkey Kong
3971   1140 21 74 11            ld      hl,L_DK_COL_SPRITE_COORD_DATA
3972   1143 11 A3 64            ld      de,COLLISION_AREA_STRUCT+3	; X coordinate entry
3973   1146 01 1E 02            ld      bc,TWO_BYTES(2,30)		; 2 sprites, 32 byte data structures
3974   1149 CD DE 11            call    L_COPY_COORDS_TO_STRUCTS 
3975   114C 21 70 11            ld      hl,L_DK_COL_SPRITE_DATA
3976   114F 11 A7 64            ld      de,COLLISION_AREA_STRUCT+7	; Sprite number entry
3977   1152 01 1C 02            ld      bc,TWO_BYTES(2,28)		; 2 sprites, 32 byte data structures
3978   1155 CD 1C 12            call    L_LD_SPRITE_DATA_TO_STRUCT
3979   1158                     
3980   1158                     ; Misc data
3981   1158 DD 21 A0 64         ld      ix,COLLISION_AREA_STRUCT
3982   115C DD 36 00 01         ld      (ix+0),1					; Sprite active
3983   1160 DD 36 20 01         ld      (ix+32),1
3984   1164                     
3985   1164                     ; Copy the collision sprite data to the sprite data structures
3986   1164 21 50 69            ld      hl,COLLISION_AREA_SPRITES
3987   1167 06 02               ld      b,2						; 2 sprites
3988   1169 11 20 00            ld      de,32						; 32 byte data structures
3989   116C CD C5 11            call    L_COPY_STRUCT_TO_SPRITE
3990   116F C9                  ret     
3991   1170             ;------------------------------------------------------------------------------
3992   1170             
3993   1170             ;------------------------------------------------------------------------------
3994   1170             ; The following data is for the collision detection sprites on either side of
3995   1170             ; Donkey Kong on the rivets stage
3996   1170             L_DK_COL_SPRITE_DATA:	
3997   1170 3F          		.byte	$3f	; Blank sprite
3998   1171 0C          		.byte	$0c	; Palette
3999   1172 08          		.byte	8
4000   1173 08          		.byte	8
4001   1174             ;------------------------------------------------------------------------------
4002   1174             
4003   1174             
4004   1174             
4005   1174             ;------------------------------------------------------------------------------
4006   1174             ; The following coordinates define the position of the collision detection 
4007   1174             ; sprites on either side of Donkey Kong on the rivets stage 
4008   1174             L_DK_COL_SPRITE_COORD_DATA:	
4009   1174 73          		.byte	115	; X coordinate
4010   1175 50          		.byte	80	; Y coordinate
4011   1176             		
4012   1176 8D          		.byte	141	; X coordinate
4013   1177 50          		.byte	80	; Y coordinate
4014   1178             ;------------------------------------------------------------------------------
4015   1178             
4016   1178             
4017   1178             
4018   1178             ;------------------------------------------------------------------------------
4019   1178             ; Initialize the spring data for the springs on the elevators stage
4020   1178             L_INIT_SPRING_DATA:  
4021   1178             		; Initialize the spring structure data
4022   1178 21 94 11    		ld      hl,L_INITIAL_SPRING_DATA
4023   117B 11 07 65            ld      de,SPRING_STRUCTS+7				; Sprite number entry
4024   117E 01 0C 0A            ld      bc,TWO_BYTES(10,12)				; 10 blocks, 16 byte data structures
4025   1181 CD 1C 12            call    L_LD_SPRITE_DATA_TO_STRUCT
4026   1184                     
4027   1184                     ; Initialize the spring sprites from the spring data structures
4028   1184 DD 21 00 65         ld      ix,SPRING_STRUCTS
4029   1188 21 80 69            ld      hl,SPRING_SPRITES
4030   118B 06 0A               ld      b,10
4031   118D 11 10 00            ld      de,16
4032   1190 CD C5 11            call    L_COPY_STRUCT_TO_SPRITE
4033   1193 C9                  ret     
4034   1194             ;---------------------------------------------- 
4035   1194             
4036   1194             
4037   1194             ;------------------------------------------------------
4038   1194             ; Initial values for some of the spring structure data such as the initial 
4039   1194             ; spring sprite number...
4040   1194             L_INITIAL_SPRING_DATA:	
4041   1194 3B          		.byte	$3b	; Normal spring sprite
4042   1195 00          		.byte	$00	; The sprite palette
4043   1196 02          		.byte	2
4044   1197 02          		.byte	2
4045   1198             ;------------------------------------------------------------------------------
4046   1198             
4047   1198             
4048   1198             
4049   1198             ;-------------------------------------------------------------------
4050   1198             ; Initialize the hammer sprites for the current stage
4051   1198             ;
4052   1198             ; passed:	hl - the ROM address of the two hammer's coordinates
4053   1198             L_INIT_HAMMER_SPRITES:  
4054   1198             		; Initialize the hammer data structures
4055   1198 11 83 66    		ld      de,HAMMER_STRUCTS+3					; First x coord position
4056   119B 01 0E 02            ld      bc,TWO_BYTES(2,14)			; 2 blocks, 14
4057   119E CD DE 11            call    L_COPY_COORDS_TO_STRUCTS
4058   11A1 21 7A 3D            ld      hl,L_HAMMER_SPRITE_DATA
4059   11A4 11 87 66            ld      de,HAMMER_STRUCTS+7			; Sprite number entry
4060   11A7 01 0C 02            ld      bc,TWO_BYTES(2,12)	; 2 blocks, 16 bytes apart
4061   11AA CD 1C 12            call    L_LD_SPRITE_DATA_TO_STRUCT
4062   11AD DD 21 80 66         ld      ix,HAMMER_STRUCTS
4063   11B1                     
4064   11B1                     ; Mark both hammers as active
4065   11B1 DD 36 00 01         ld      (ix+0),1
4066   11B5 DD 36 10 01         ld      (ix+16),1
4067   11B9                     
4068   11B9                     ; Copy hammer sprite data from the data structures to the sprite structures
4069   11B9 21 18 6A            ld      hl,HAMMER_SPRITES
4070   11BC 06 02               ld      b,2						; 2 sprites
4071   11BE 11 10 00            ld      de,16					; Source data structure are 16 bytes long
4072   11C1 CD C5 11            call    L_COPY_STRUCT_TO_SPRITE
4073   11C4 C9                  ret     
4074   11C5             ;------------------------------------------------------------------------------
4075   11C5             
4076   11C5             
4077   11C5             ;------------------------------------------------------------------------------
4078   11C5             ; Copy sprite information from a data structure (ie the spring data structures)
4079   11C5             ; to a sprite data structure.
4080   11C5             ; For example, this function copies the x and y coordinates, and the sprite 
4081   11C5             ; number and palette from the spring data structures to the spring sprites.
4082   11C5             ;
4083   11C5             ; passed:	hl - address of the sprite to copy to
4084   11C5             ;			ix - address of the data structure to copy from
4085   11C5             ;			b - the number of data structures to copy
4086   11C5             ;			de - the distance between source data structures
4087   11C5             L_COPY_STRUCT_TO_SPRITE:  
4088   11C5             		; Copy the x coordinate
4089   11C5 DD 7E 03    		ld      a,(ix+3)
4090   11C8 77                  ld      (hl),a
4091   11C9                     
4092   11C9                     ; Copy the sprite number
4093   11C9 2C                  inc     l
4094   11CA DD 7E 07            ld      a,(ix+7)
4095   11CD 77                  ld      (hl),a
4096   11CE                     
4097   11CE                     ; Copy the sprite palette
4098   11CE 2C                  inc     l
4099   11CF DD 7E 08            ld      a,(ix+8)
4100   11D2 77                  ld      (hl),a
4101   11D3                     
4102   11D3                     ; Copy the y coordinate
4103   11D3 2C                  inc     l
4104   11D4 DD 7E 05            ld      a,(ix+5)
4105   11D7 77                  ld      (hl),a
4106   11D8                     
4107   11D8                     ; Process the next structure
4108   11D8 2C                  inc     l
4109   11D9 DD 19               add     ix,de
4110   11DB 10 E8               djnz    L_COPY_STRUCT_TO_SPRITE
4111   11DD                     
4112   11DD C9                  ret     
4113   11DE             ;------------------------------------------------------------------------------
4114   11DE             
4115   11DE             
4116   11DE             
4117   11DE             ;------------------------------------------------------------------------------
4118   11DE             ; Load x and y coordinates into one or more data structures
4119   11DE             ; The x and y coordinates are spaced two bytes apart
4120   11DE             ; passed:	hl - source address
4121   11DE             ;			de - destination address
4122   11DE             ;			b - the number of 2 byte blocks to copy
4123   11DE             ;			c - the distance between the destination blocks (- 2 bytes)
4124   11DE             L_COPY_COORDS_TO_STRUCTS:  
4125   11DE             		; Copy the x coordinate to the destination structure
4126   11DE 7E          		ld      a,(hl)
4127   11DF 12                  ld      (de),a
4128   11E0 23                  inc     hl
4129   11E1                     
4130   11E1             		; Copy the y coordinate to the destination structure
4131   11E1 1C                  inc     e
4132   11E2 1C                  inc     e
4133   11E3 7E                  ld      a,(hl)
4134   11E4 12                  ld      (de),a
4135   11E5                     
4136   11E5                     ; Advance to the next data structure
4137   11E5 23                  inc     hl
4138   11E6 7B                  ld      a,e
4139   11E7 81                  add     a,c
4140   11E8 5F                  ld      e,a
4141   11E9                     
4142   11E9 10 F3               djnz    L_COPY_COORDS_TO_STRUCTS						; Next b
4143   11EB C9                  ret     
4144   11EC             ;------------------------------------------------------------------------------
4145   11EC             
4146   11EC             
4147   11EC             
4148   11EC             ;------------------------------------------------------------------------------
4149   11EC             ; Load oil fire data into the oil fire sprite and data structure
4150   11EC             ; passed:	hl - source address
4151   11EC             L_LOAD_BARREL_FIRE_DATA:  
4152   11EC DD 21 A0 66 		ld      ix,BARREL_FIRE_STRUCT
4153   11F0 11 28 6A            ld      de,BARREL_FIRE_SPRITE
4154   11F3                     
4155   11F3                     ; Set the barrel fire structure active
4156   11F3 DD 36 00 01         ld      (ix+0),1
4157   11F7                     
4158   11F7                     ; Load the fire x coordinate
4159   11F7 7E                  ld      a,(hl)
4160   11F8 DD 77 03            ld      (ix+3),a
4161   11FB 12                  ld      (de),a
4162   11FC                     
4163   11FC                     ; Load the fire tile number
4164   11FC 1C                  inc     e
4165   11FD 23                  inc     hl
4166   11FE 7E                  ld      a,(hl)
4167   11FF DD 77 07            ld      (ix+7),a
4168   1202 12                  ld      (de),a
4169   1203                     
4170   1203                     ; Load the fire palette
4171   1203 1C                  inc     e
4172   1204 23                  inc     hl
4173   1205 7E                  ld      a,(hl)
4174   1206 DD 77 08            ld      (ix+8),a
4175   1209 12                  ld      (de),a
4176   120A                     
4177   120A                     ; Load the fire y coordinate
4178   120A 1C                  inc     e
4179   120B 23                  inc     hl
4180   120C 7E                  ld      a,(hl)
4181   120D DD 77 05            ld      (ix+5),a
4182   1210 12                  ld      (de),a
4183   1211                     
4184   1211                     ; Load ???
4185   1211 23                  inc     hl
4186   1212 7E                  ld      a,(hl)
4187   1213 DD 77 09            ld      (ix+9),a
4188   1216                     
4189   1216                     ; Load ???
4190   1216 23                  inc     hl
4191   1217 7E                  ld      a,(hl)
4192   1218 DD 77 0A            ld      (ix+10),a
4193   121B C9                  ret     
4194   121C             ;------------------------------------------------------------------------------
4195   121C             
4196   121C             
4197   121C             
4198   121C             ;------------------------------------------------------------------------------
4199   121C             ; Load 4 bytes of basic sprite data (sprite number, palette, etc) from a ROM 
4200   121C             ; address into sequential data structure.
4201   121C             ; The same 4 byte block is copied to each destination
4202   121C             ; passed:	hl - starting source address
4203   121C             ;			de - starting destination address
4204   121C             ;			b - the number of blocks to load
4205   121C             ;			c - the size of the data structure (- 4 bytes)
4206   121C             L_LD_SPRITE_DATA_TO_STRUCT:  
4207   121C E5          		push    hl
4208   121D C5                  push    bc
4209   121E                     
4210   121E                     ; Copy 4 bytes from the the source to the destination
4211   121E 06 04               ld      b,4						; For b = 4 to 1
4212   1220 7E          l122e:  ld      a,(hl)
4213   1221 12                  ld      (de),a
4214   1222 23                  inc     hl
4215   1223 1C                  inc     e
4216   1224 10 FA               djnz    l122e					; Next b
4217   1226                     
4218   1226                     ; Restore the original source address and 
4219   1226 C1                  pop     bc
4220   1227 E1                  pop     hl
4221   1228                     
4222   1228                     ; Advance to the next destination address and continue
4223   1228 7B                  ld      a,e
4224   1229 81                  add     a,c
4225   122A 5F                  ld      e,a
4226   122B 10 EF               djnz    L_LD_SPRITE_DATA_TO_STRUCT
4227   122D C9                  ret     
4228   122E             ;------------------------------------------------------------------------------
4229   122E             
4230   122E             
4231   122E             
4232   122E             ;------------------------------------------------------------------------------
4233   122E             ; Initialize Mario (position and sprite number).  The number of lives are also 
4234   122E             ; displayed (after the current life is deducted)
4235   122E             L_INIT_MARIO:  
4236   122E             		; Return until the minor timer has run down
4237   122E DF          		rst     $18
4238   122F             		
4239   122F             		; If current stage is elevators, set Mario's coordinate to (22,224)
4240   122F 3A 27 62            ld      a,(CURRENT_STAGE)
4241   1232 FE 03               cp      3
4242   1234 01 16 E0            ld      bc,TWO_BYTES(224,22)
4243   1237 CA 3D 12            jp      z,l124b
4244   123A                     
4245   123A                     ; If current stage is not elevators, set Mario's coordinate to (63,240)
4246   123A 01 3F F0            ld      bc,TWO_BYTES(240,63)
4247   123D                     
4248   123D                     ; ix = first byte of Mario structure
4249   123D DD 21 00 62 l124b:  ld      ix,MARIO_DATA_STRUCT
4250   1241 21 4C 69            ld      hl,MARIO_SPRITE
4251   1244 DD 36 00 01         ld      (ix+0),1					; Mario is alive
4252   1248                     
4253   1248                     ; Set Mario's x coordinate
4254   1248 DD 71 03            ld      (ix+3),c					; X coordinate
4255   124B 71                  ld      (hl),c
4256   124C                     
4257   124C                     ; Set Mario's sprite to $00, facing right 
4258   124C 2C                  inc     l
4259   124D DD 36 07 80         ld      (ix+7),$80				; Sprite number
4260   1251 36 80               ld      (hl),$80
4261   1253                     
4262   1253                     ; Set Mario's palette to $02
4263   1253 2C                  inc     l
4264   1254 DD 36 08 02         ld      (ix+8),$02				; Sprite palette
4265   1258 36 02               ld      (hl),$02
4266   125A                     
4267   125A                     ; Set Mario's y coordinate
4268   125A 2C                  inc     l
4269   125B DD 70 05            ld      (ix+5),b					; Y coordinate
4270   125E 70                  ld      (hl),b
4271   125F                     
4272   125F                     ; 
4273   125F DD 36 0F 01         ld      (ix+15),1
4274   1263                     
4275   1263                     ; Advance to the next substate
4276   1263 21 0A 60            ld      hl,GAME_SUBSTATE
4277   1266 34                  inc     (hl)
4278   1267                     
4279   1267                     ; Decrement and display the number of lives
4280   1267 11 01 06            ld      de,$0601
4281   126A CD 22 30            call    L_ADD_EVENT
4282   126D C9                  ret     
4283   126E             ;------------------------------------------------------------------------------
4284   126E             
4285   126E             
4286   126E             
4287   126E             ;------------------------------------------------------------------------------
4288   126E             ; Implement Mario's death animation
4289   126E             L_IMPLEMENT_DEATH_ANIM:  
4290   126E             		; Award any pending pointdfs 
4291   126E CD A7 1D    		call    L_IMPLEMENT_POINT_AWARD
4292   1271             		
4293   1271             		; Jump based on the current animation state
4294   1271 3A 9D 63            ld      a,(DEATH_ANIMATION_STATE)
4295   1274 EF                  rst     $28							; Jump to local table address
4296   1275             		; Jump table
4297   1275 7D 12       		.word	L_PREPARE_DEATH_ANIMATION	; 0 = start death sequence animation
4298   1277 9E 12       		.word	L_ROTATE_MARIO_DEAD_SPRITE	; 1 = advance death sequence
4299   1279 D0 12       		.word	L_CLEAN_UP_DEATH_ANIMATION	; 2 = complete death sequence
4300   127B 00 00       		.word	L_ORG	; 3 = reset game
4301   127D             ;------------------------------------------------------------------------------
4302   127D             
4303   127D             
4304   127D             
4305   127D             ;------------------------------------------------------------------------------
4306   127D             ; Prepare the death animation
4307   127D             L_PREPARE_DEATH_ANIMATION:  
4308   127D DF          		rst     $18						; Return until minor timer times out
4309   127E             		
4310   127E             		; Determine if the Mario sprite needs to be flipped horizontally
4311   127E 21 4D 69            ld      hl,MARIO_SPRITE_NUM
4312   1281 3E F0               ld      a,$f0
4313   1283 CB 16               rl      (hl)
4314   1285 1F                  rra     
4315   1286 77                  ld      (hl),a
4316   1287                     
4317   1287                     ; Advance to the next animation state
4318   1287 21 9D 63            ld      hl,DEATH_ANIMATION_STATE
4319   128A 34                  inc     (hl)
4320   128B                     
4321   128B                     ; Set the death animation counter to 13
4322   128B 3E 0D               ld      a,13
4323   128D 32 9E 63            ld      (DEATH_ANIMATION_COUNTER),a
4324   1290                     
4325   1290                     ; Set the minor timer to 8
4326   1290 3E 08               ld      a,8
4327   1292 32 09 60            ld      (MINOR_TIMER),a
4328   1295                     
4329   1295 CD 40 30            call    L_CLEAR_SPRITES_WHEN_DEAD
4330   1298                     
4331   1298                     ; Trigger the death song
4332   1298 3E 03               ld      a,3
4333   129A 32 88 60            ld      (DEATH_SOUND_TRIGGER),a
4334   129D C9                  ret     
4335   129E             ;------------------------------------------------------------------------------
4336   129E             
4337   129E             
4338   129E             
4339   129E             ;------------------------------------------------------------------------------
4340   129E             ; Rotate Mario's death sprite to animate him spinning
4341   129E             L_ROTATE_MARIO_DEAD_SPRITE:  
4342   129E DF          		rst     $18						; Return until minor timer runs out
4343   129F             		
4344   129F             		; Set the minor timer to 8
4345   129F 3E 08               ld      a,8
4346   12A1 32 09 60            ld      (MINOR_TIMER),a
4347   12A4                     
4348   12A4                     
4349   12A4 21 9E 63            ld      hl,DEATH_ANIMATION_COUNTER
4350   12A7 35                  dec     (hl)
4351   12A8 CA BD 12            jp      z,l12cb
4352   12AB                     
4353   12AB 21 4D 69            ld      hl,MARIO_SPRITE_NUM
4354   12AE 7E                  ld      a,(hl)
4355   12AF 1F                  rra     
4356   12B0 3E 02               ld      a,$02
4357   12B2 1F                  rra     
4358   12B3 47                  ld      b,a
4359   12B4 AE                  xor     (hl)
4360   12B5 77                  ld      (hl),a
4361   12B6                     
4362   12B6 2C                  inc     l
4363   12B7 78                  ld      a,b
4364   12B8 E6 80               and     %10000000
4365   12BA AE                  xor     (hl)
4366   12BB 77                  ld      (hl),a
4367   12BC C9                  ret    
4368   12BD             		
4369   12BD             		; Set Mario's sprite to lying flat on his back,
4370   12BD             		; vertically flipped as appropriate 
4371   12BD 21 4D 69    l12cb:  ld      hl,MARIO_SPRITE_NUM
4372   12C0 3E F4               ld      a,$f4
4373   12C2 CB 16               rl      (hl)
4374   12C4 1F                  rra     
4375   12C5 77                  ld      (hl),a
4376   12C6                     
4377   12C6                     ; Advance the death animation state
4378   12C6 21 9D 63            ld      hl,DEATH_ANIMATION_STATE
4379   12C9 34                  inc     (hl)
4380   12CA                     
4381   12CA                     ; Initialize the minor timer to 128
4382   12CA 3E 80               ld      a,128
4383   12CC 32 09 60            ld      (MINOR_TIMER),a
4384   12CF                     
4385   12CF C9                  ret     
4386   12D0             ;------------------------------------------------------------------------------
4387   12D0             
4388   12D0             
4389   12D0             
4390   12D0             ;------------------------------------------------------------------------------
4391   12D0             ; Clean up the death animation and advance to the next state
4392   12D0             L_CLEAN_UP_DEATH_ANIMATION:	
4393   12D0 DF          		rst     $18						; Return until minor timer runs out
4394   12D1             		
4395   12D1             		; Clear out Mario's sprite
4396   12D1 CD 5E 30            call    L_CLEAR_MARIO_SPRITE
4397   12D4                     
4398   12D4                     ; If this is a one player game, advance the substate by one
4399   12D4 21 0A 60            ld      hl,GAME_SUBSTATE
4400   12D7 3A 0E 60            ld      a,(SECOND_PLAYER)
4401   12DA A7                  and     a
4402   12DB CA DF 12            jp      z,l12ed
4403   12DE                     
4404   12DE                     ; If this is a two player game, advance the substate by two
4405   12DE 34                  inc     (hl)
4406   12DF                     
4407   12DF                     ; Advance the substate
4408   12DF 34          l12ed:  inc     (hl)
4409   12E0             
4410   12E0             		; Set the minor timer to 1
4411   12E0 2B                  dec     hl
4412   12E1 36 01               ld      (hl),1
4413   12E3 C9                  ret     
4414   12E4             ;------------------------------------------------------------------------------
4415   12E4             
4416   12E4             
4417   12E4             
4418   12E4             ;------------------------------------------------------------------------------
4419   12E4             ; After death processing for player 1.  Remove a life, and end the player's 
4420   12E4             ; game if there are no more lives left.
4421   12E4             L_POST_DEATH_PROCESSING_P1:  
4422   12E4 CD 1C 01    		call    L_SOUNDS_OFF
4423   12E7                     
4424   12E7                     ; Set the intro as having been displayed for the current player
4425   12E7 AF                  xor     a
4426   12E8 32 2C 62            ld      (CP_INTRO_NOT_DISPLAYED),a
4427   12EB                     
4428   12EB                     ; Subtract a life
4429   12EB 21 28 62            ld      hl,CP_NUMBER_LIVES
4430   12EE 35                  dec     (hl)
4431   12EF 7E                  ld      a,(hl)
4432   12F0                     
4433   12F0                     ; Save the current player data to the first player data
4434   12F0 11 40 60            ld      de,P1_DATA
4435   12F3 01 08 00            ld      bc,8
4436   12F6 ED B0               ldir    
4437   12F8                     
4438   12F8                     ; If player 1 has more lives, jump ahead
4439   12F8 A7                  and     a
4440   12F9 C2 26 13            jp      nz,l1334
4441   12FC                     
4442   12FC                     ; Check if player 1's score qualifies for the high score list
4443   12FC 3E 01               ld      a,1						; Player 1 ID
4444   12FE 21 B2 60            ld      hl,PREV_P1_SCORE
4445   1301 CD BC 13            call    L_ADD_SCORE_TO_HS_TABLE
4446   1304                     
4447   1304                     ; If there is only 1 player, jump ahead to skip displaying the player I prompt
4448   1304 21 D4 76            ld      hl,TILE_COORD(22,20)
4449   1307 3A 0F 60            ld      a,(TWO_PLAYERS)
4450   130A A7                  and     a
4451   130B 28 07               jr      z,l1322
4452   130D                     
4453   130D                     ; Display the player I string
4454   130D 11 02 03            ld      de,$0302
4455   1310 CD 22 30            call    L_ADD_EVENT
4456   1313 2B                  dec     hl
4457   1314 CD 17 18    l1322:  call    L_CLEAR_AROUND_GAME_OVER
4458   1317             
4459   1317             		; Display "GAME OVER"
4460   1317 11 00 03            ld      de,$0300
4461   131A CD 22 30            call    L_ADD_EVENT
4462   131D                     
4463   131D                     ; Set the minor timer to 192
4464   131D 21 09 60            ld      hl,MINOR_TIMER
4465   1320 36 C0               ld      (hl),192
4466   1322                     
4467   1322                     ; Set game substate to 16 and return
4468   1322 23                  inc     hl
4469   1323 36 10               ld      (hl),16
4470   1325 C9                  ret     
4471   1326                     
4472   1326                     ; If there is only 1 player, jump ahead to advance to substate 8
4473   1326 0E 08       l1334:  ld      c,8
4474   1328 3A 0F 60            ld      a,(TWO_PLAYERS)
4475   132B A7                  and     a
4476   132C CA 31 13            jp      z,l133f
4477   132F                     
4478   132F                     ; If there are 2 players, advance the substate to 23
4479   132F 0E 17               ld      c,23
4480   1331                     
4481   1331 79          l133f:  ld      a,c
4482   1332 32 0A 60            ld      (GAME_SUBSTATE),a
4483   1335 C9                  ret     
4484   1336             ;------------------------------------------------------------------------------
4485   1336             
4486   1336             
4487   1336             ;------------------------------------------------------------------------------
4488   1336             ; After death processing for player 1.  Remove a life, and end the player's 
4489   1336             ; game if there are no more lives left.  
4490   1336             L_POST_DEATH_PROCESSING_P2:  
4491   1336 CD 1C 01    		call    L_SOUNDS_OFF
4492   1339                     
4493   1339                     ; Set the intro as having been displayed for the current player
4494   1339 AF                  xor     a
4495   133A 32 2C 62            ld      (CP_INTRO_NOT_DISPLAYED),a
4496   133D                     
4497   133D                     ; Subtract a life
4498   133D 21 28 62            ld      hl,CP_NUMBER_LIVES
4499   1340 35                  dec     (hl)
4500   1341 7E                  ld      a,(hl)
4501   1342                     
4502   1342                     ; Save the current player data to the first player data
4503   1342 11 48 60            ld      de,P2_NUMBER_LIVES
4504   1345 01 08 00            ld      bc,8
4505   1348 ED B0               ldir    
4506   134A                     
4507   134A                     ; If player 1 has more lives, jump ahead
4508   134A A7                  and     a
4509   134B C2 71 13            jp      nz,l137f
4510   134E                     
4511   134E                     ; Check if player 1's score qualifies for the high score list
4512   134E 3E 03               ld      a,3						; Player 2 ID
4513   1350 21 B5 60            ld      hl,PREV_P2_SCORE
4514   1353 CD BC 13            call    L_ADD_SCORE_TO_HS_TABLE
4515   1356                     
4516   1356                     ; Display the player II string
4517   1356 11 03 03            ld      de,$0303
4518   1359 CD 22 30            call    L_ADD_EVENT
4519   135C                     
4520   135C                     ; Display "GAME OVER"
4521   135C 11 00 03            ld      de,$0300
4522   135F CD 22 30            call    L_ADD_EVENT
4523   1362 21 D3 76            ld      hl,TILE_COORD(22,19)
4524   1365 CD 17 18            call    L_CLEAR_AROUND_GAME_OVER
4525   1368                     
4526   1368                     ; Set the minor timer to 192
4527   1368 21 09 60            ld      hl,MINOR_TIMER
4528   136B 36 C0               ld      (hl),192
4529   136D                     
4530   136D                     ; Set game substate to 17 and return
4531   136D 23                  inc     hl
4532   136E 36 11               ld      (hl),$11
4533   1370 C9                  ret     
4534   1371                     
4535   1371                     ; If player 1 has lives left, jump ahead to advance to game substate 23
4536   1371 0E 17       l137f:  ld      c,$17
4537   1373 3A 40 60            ld      a,(P1_NUMBER_LIVES)
4538   1376 A7                  and     a
4539   1377 C2 7C 13            jp      nz,l138a
4540   137A                     
4541   137A                     ; If player 1 has no more lives, advance to substate 8
4542   137A 0E 08               ld      c,8
4543   137C 79          l138a:  ld      a,c
4544   137D 32 0A 60            ld      (GAME_SUBSTATE),a
4545   1380 C9                  ret     
4546   1381             ;------------------------------------------------------------------------------
4547   1381             
4548   1381             
4549   1381             
4550   1381             ;------------------------------------------------------------------------------
4551   1381             ; This function is called when Player 1's game is over.
4552   1381             ; It checks if Player 2 has lives left and advances to the appropriate substate
4553   1381             L_ADV_FROM_P1_GAME_OVER:  
4554   1381             		; Return until the minor timer runs down
4555   1381 DF          		rst     $18
4556   1382             		
4557   1382             		; If player 2 has more lives, jump ahead to advance to substate 23
4558   1382             		; (move on to the next player)
4559   1382 0E 17               ld      c,23
4560   1384 3A 48 60            ld      a,(P2_NUMBER_LIVES)
4561   1387 34          l1395:  inc     (hl)						; MINOR_TIMER = 1
4562   1388 A7                  and     a
4563   1389 C2 8E 13            jp      nz,l139c
4564   138C                     
4565   138C                     ; If player 2 has no more lives, advance to substate 20
4566   138C                     ; (Check if high scores need to be entered)
4567   138C 0E 14               ld      c,20
4568   138E 79          l139c:  ld      a,c
4569   138F 32 0A 60            ld      (GAME_SUBSTATE),a
4570   1392 C9                  ret     
4571   1393             ;------------------------------------------------------------------------------
4572   1393             
4573   1393             
4574   1393             
4575   1393             ;------------------------------------------------------------------------------
4576   1393             ; This function is called when Player 2's game is over.
4577   1393             ; It checks if Player 1 has lives left and advances to the appropriate substate
4578   1393             L_ADV_FROM_P2_GAME_OVER:  
4579   1393             		; Return until the minor timer runs down
4580   1393 DF          		rst     $18
4581   1394             		
4582   1394                     ; If player 1 has more lives, jump ahead to advance to substate 23
4583   1394             		; (move on to the next player)
4584   1394             		; If player 1 has no more lives left, advance to substate 20 
4585   1394             		; (Check if high scores need to be entered)
4586   1394 0E 17       		ld      c,23
4587   1396 3A 40 60            ld      a,(P1_NUMBER_LIVES)
4588   1399 C3 87 13            jp      l1395
4589   139C             ;------------------------------------------------------------------------------
4590   139C             
4591   139C             
4592   139C             
4593   139C             ;------------------------------------------------------------------------------
4594   139C             ; Prepare for player 2's turn.  
4595   139C             ; Orient the screen and activate player 2. 
4596   139C             L_PREPARE_FOR_P2_TURN:  
4597   139C             		; Orient the screen for player 2
4598   139C             		; (Flipped vertically for cocktail cabinets) 
4599   139C 3A 26 60    		ld      a,(CABINET_TYPE)
4600   139F 32 82 7D            ld      (SCREEN_ORIENTATION),a
4601   13A2                     
4602   13A2                     ; Set substate to 0
4603   13A2 AF                  xor     a
4604   13A3 32 0A 60            ld      (GAME_SUBSTATE),a
4605   13A6                     
4606   13A6                     ; Activate player 2
4607   13A6                     ; Set CURRENT_PLAYER to 1 (player 2)
4608   13A6                     ; and SECOND_PLAYER to 1
4609   13A6 21 01 01            ld      hl,TWO_BYTES(1,1)
4610   13A9 22 0D 60            ld      (CURRENT_PLAYER),hl
4611   13AC C9                  ret     
4612   13AD             ;------------------------------------------------------------------------------
4613   13AD             
4614   13AD             
4615   13AD             
4616   13AD             ;------------------------------------------------------------------------------
4617   13AD             ; Prepare for player 2's turn.  
4618   13AD             ; Orient the screen and activate player 2. 
4619   13AD             L_PREPARE_FOR_P1_TURN:  
4620   13AD             		; Activate player 1
4621   13AD AF          		xor     a
4622   13AE 32 0D 60            ld      (CURRENT_PLAYER),a
4623   13B1 32 0E 60            ld      (SECOND_PLAYER),a
4624   13B4                     
4625   13B4                     ; Set substate to 0
4626   13B4 32 0A 60            ld      (GAME_SUBSTATE),a
4627   13B7                     
4628   13B7                     ; Orient the screen upright
4629   13B7 3C          		inc     a
4630   13B8 32 82 7D            ld      (SCREEN_ORIENTATION),a
4631   13BB C9                  ret     
4632   13BC             ;------------------------------------------------------------------------------
4633   13BC             
4634   13BC             
4635   13BC             
4636   13BC             ;------------------------------------------------------------------------------
4637   13BC             ; Check if the player's score needs to be added to the high score table and
4638   13BC             ; insert it.
4639   13BC             ; I won't pretend that I've actually analyzed this code enough to really 
4640   13BC             ; understand what it's doing...
4641   13BC             ; passed:	a - the number of the player whose score is being checked
4642   13BC             ;				(1 for player 1, 3 for player 2)
4643   13BC             ;			hl - the address of the player's score
4644   13BC             L_ADD_SCORE_TO_HS_TABLE:  
4645   13BC             		
4646   13BC 11 C6 61    		ld      de,$61c6
4647   13BF 12                  ld      (de),a
4648   13C0                     
4649   13C0                     ; Return if the demo mode is active
4650   13C0 CF                  rst     $08
4651   13C1                     
4652   13C1                     ; Copy the current player's score to $61c7
4653   13C1 13                  inc     de
4654   13C2 01 03 00            ld      bc,3						; 3 bytes to copy
4655   13C5 ED B0               ldir    
4656   13C7                     
4657   13C7                     ; Separate and store each digit in the score
4658   13C7 06 03               ld      b,3						; For b = 3 to 1
4659   13C9 21 B1 61            ld      hl,CURRENT_SCORE_STRING
4660   13CC                     
4661   13CC                     ; Isolate the MS nibble of the previous byte of the score
4662   13CC 1B          l13da:  dec     de
4663   13CD 1A                  ld      a,(de)
4664   13CE 0F                  rrca    
4665   13CF 0F                  rrca    
4666   13D0 0F                  rrca    
4667   13D1 0F                  rrca    
4668   13D2 E6 0F               and     %00001111
4669   13D4                     
4670   13D4                     ; Save this digit 
4671   13D4 77                  ld      (hl),a
4672   13D5 23                  inc     hl
4673   13D6                     
4674   13D6                     ; Isolate the LS nibble
4675   13D6 1A                  ld      a,(de)
4676   13D7 E6 0F               and     %00001111
4677   13D9                     
4678   13D9                     ; Save the digit
4679   13D9 77                  ld      (hl),a
4680   13DA 23                  inc     hl
4681   13DB                     
4682   13DB 10 EF               djnz    l13da						; Next b
4683   13DD                     
4684   13DD                     ; Clear the next 14 bytes of the score string
4685   13DD 06 0E               ld      b,14
4686   13DF 36 10       l13ed:  ld      (hl),$10					; Space
4687   13E1 23                  inc     hl
4688   13E2 10 FB               djnz    l13ed
4689   13E4                     
4690   13E4                     ; Mark the end of the high score string
4691   13E4 36 3F               ld      (hl),$3F
4692   13E6                     
4693   13E6 06 05               ld      b,5
4694   13E8                     
4695   13E8                     ; Subtract the current high score entry from the current player's score
4696   13E8                     ; Return if the high score is higher than the player's score
4697   13E8 21 A5 61            ld      hl,$61a5
4698   13EB 11 C7 61            ld      de,$61c7
4699   13EE 1A          l13fc:  ld      a,(de)
4700   13EF 96                  sub     (hl)
4701   13F0 23                  inc     hl
4702   13F1 13                  inc     de
4703   13F2 1A                  ld      a,(de)
4704   13F3 9E                  sbc     a,(hl)
4705   13F4 23                  inc     hl
4706   13F5 13                  inc     de
4707   13F6 1A                  ld      a,(de)
4708   13F7 9E                  sbc     a,(hl)
4709   13F8 D8                  ret     c
4710   13F9                     
4711   13F9                     ; Add the player's score to the high score table
4712   13F9 C5                  push    bc
4713   13FA 06 19               ld      b,25
4714   13FC 4E          l140a:  ld      c,(hl)
4715   13FD 1A                  ld      a,(de)
4716   13FE 77                  ld      (hl),a
4717   13FF 79                  ld      a,c
4718   1400 12                  ld      (de),a
4719   1401 2B                  dec     hl
4720   1402 1B                  dec     de
4721   1403 10 F7               djnz    l140a
4722   1405                     
4723   1405 01 F5 FF            ld      bc,-11
4724   1408 09                  add     hl,bc
4725   1409 EB                  ex      de,hl
4726   140A 09                  add     hl,bc
4727   140B EB                  ex      de,hl
4728   140C C1                  pop     bc
4729   140D 10 DF               djnz    l13fc
4730   140F C9                  ret     
4731   1410             ;------------------------------------------------------------------------------
4732   1410             
4733   1410             
4734   1410             ;------------------------------------------------------------------------------
4735   1410             ; Determines if either player needs to enter high score initials
4736   1410             L_CHECK_FOR_HS_INITIALS:  
4737   1410 CD 16 06    		call    L_DISPLAY_CREDITS_2
4738   1413                     
4739   1413                     ; Return until the minor timer runs down
4740   1413 DF          		rst     $18
4741   1414                     
4742   1414 CD 73 08            call    L_CLEAR_STAGE_SCREEN
4743   1417                     
4744   1417                     ; Activate player 1
4745   1417 3E 00               ld      a,0
4746   1419 32 0E 60            ld      (SECOND_PLAYER),a
4747   141C 32 0D 60            ld      (CURRENT_PLAYER),a
4748   141F                     
4749   141F 21 1C 61            ld      hl,HIGH_SCORE_TABLE_ENTRY_1+28	; Player ID
4750   1422 11 22 00            ld      de,34					; 34 byte data structure
4751   1425 06 05               ld      b,5						; For b = 5 to 1 (5 high score entries)
4752   1427                     
4753   1427                     ; If this score was earned by player 1, jump ahead
4754   1427 3E 01               ld      a,1						; Player 1 ID
4755   1429 BE          l1437:  cp      (hl)
4756   142A CA 4B 14            jp      z,l1459
4757   142D                     
4758   142D                     ; Check the next high score entry
4759   142D 19                  add     hl,de
4760   142E 10 F9               djnz    l1437						; Next b
4761   1430                     
4762   1430 21 1C 61            ld      hl,HIGH_SCORE_TABLE_ENTRY_1+28	; Player ID
4763   1433 06 05               ld      b,5						; For b = 5 to 1 (5 high score entries)
4764   1435                     
4765   1435                     ; If this score was earned by player 2, jump ahead
4766   1435 3E 03               ld      a,3						; Player 2 ID   
4767   1437 BE          l1445:  cp      (hl)
4768   1438 CA 41 14            jp      z,l144f
4769   143B                     
4770   143B                     ; Check the next high score entry
4771   143B 19                  add     hl,de
4772   143C 10 F9               djnz    l1445						; Next b
4773   143E                     
4774   143E                     ; If neither player earned a high score, start the game
4775   143E C3 67 14            jp      L_RESTART_GAME
4776   1441                     
4777   1441                     ; Activate player 2
4778   1441 3E 01       l144f:  ld      a,1
4779   1443 32 0E 60            ld      (SECOND_PLAYER),a
4780   1446 32 0D 60            ld      (CURRENT_PLAYER),a
4781   1449                     
4782   1449                     ; Orient the screen for the player with the high score
4783   1449 3E 00               ld      a,0
4784   144B 21 26 60    l1459:  ld      hl,CABINET_TYPE
4785   144E B6                  or      (hl)
4786   144F 32 82 7D            ld      (SCREEN_ORIENTATION),a
4787   1452                     
4788   1452                     ; Advance to the next substate
4789   1452 3E 00               ld      a,0
4790   1454 32 09 60            ld      (MINOR_TIMER),a
4791   1457 21 0A 60            ld      hl,GAME_SUBSTATE
4792   145A 34                  inc     (hl)
4793   145B                     
4794   145B                     ; Display 
4795   145B                     ; "NAME REGISTRATION"
4796   145B                     ; "NAME:"
4797   145B             		; "---         "
4798   145B             		; "A B C D E F G H I J"
4799   145B             		; "K L M N O P Q R S T"
4800   145B             		; "U V W X Y Z . -RUBEND "
4801   145B             		; "REGI TIME  (30) "
4802   145B             		; and the 5 high scores
4803   145B 11 0D 03    		ld      de,$030d
4804   145E 06 0C               ld      b,12						; For b = 12 to 1 (12 strings to display)
4805   1460 CD 22 30    l146e:  call    L_ADD_EVENT
4806   1463 13                  inc     de						; Next string
4807   1464 10 FA               djnz    l146e					; Next b
4808   1466 C9                  ret     
4809   1467             ;------------------------------------------------------------------------------
4810   1467             
4811   1467             
4812   1467             
4813   1467             ;------------------------------------------------------------------------------
4814   1467             ; Restart the game to waiting for a coin
4815   1467             L_RESTART_GAME:  
4816   1467 3E 01       		ld      a,1
4817   1469 32 82 7D            ld      (SCREEN_ORIENTATION),a
4818   146C 32 05 60            ld      (GAME_STATE),a
4819   146F 32 07 60            ld      (NO_COINS_INSERTED),a
4820   1472 3E 00               ld      a,0
4821   1474 32 0A 60            ld      (GAME_SUBSTATE),a
4822   1477 C9                  ret     
4823   1478             ;------------------------------------------------------------------------------
4824   1478             
4825   1478             
4826   1478             
4827   1478             ;------------------------------------------------------------------------------
4828   1478             ; This function implements the high score initial entry screen
4829   1478             ; The user is allowed to navigate through the initial letters and enter their 
4830   1478             ; initials.
4831   1478             ;
4832   1478             ; Note: it appears that it would not be difficult to alter this code to allow
4833   1478             ;	   names of up to 12 characters to be entered
4834   1478             L_IMPLEMENT_HS_INITIAL_ENTRY:  
4835   1478 CD 16 06    		call    L_DISPLAY_CREDITS_2
4836   147B             
4837   147B             		; Jump ahead if the minor timer has not run out
4838   147B 21 09 60            ld      hl,MINOR_TIMER
4839   147E 7E                  ld      a,(hl)
4840   147F A7                  and     a
4841   1480 C2 CE 14            jp      nz,l14dc
4842   1483                     
4843   1483                     ; Palette 00
4844   1483 32 86 7D            ld      (PALETTE_1_OUTPUT),a
4845   1486 32 87 7D            ld      (PALETTE_2_OUTPUT),a
4846   1489                     
4847   1489                     ; Set minor timer to 1
4848   1489 36 01               ld      (hl),1
4849   148B                     
4850   148B                     ; Initialize JOYSTICK_INPUT_DELAY to 10
4851   148B 21 30 60            ld      hl,JOYSTICK_INPUT_DELAY
4852   148E 36 0A               ld      (hl),10
4853   1490                     
4854   1490                     ; Set 
4855   1490 23                  inc     hl
4856   1491 36 00               ld      (hl),0					; BLANK_CP_HIGH_SCORE
4857   1493                     
4858   1493 23                  inc     hl
4859   1494 36 10               ld      (hl),16					; BLINK_SCORE_TIMER
4860   1496                     
4861   1496 23                  inc     hl
4862   1497 36 1E               ld      (hl),30					; INITIALS_TIMER_VALUE
4863   1499                     
4864   1499 23                  inc     hl
4865   149A 36 3E               ld      (hl),62					; INITIALS_TIMER_DELAY				
4866   149C                     
4867   149C 23                  inc     hl
4868   149D 36 00               ld      (hl),0					; SELECTED_LETTER
4869   149F                     
4870   149F 21 E8 75            ld      hl,TILE_COORD(15,8)
4871   14A2 22 36 60            ld      (INITIALS_COORD),hl
4872   14A5                     
4873   14A5                     ; Determine this player's ID (1 = player 1, 3 = player 2)
4874   14A5 21 1C 61            ld      hl,HIGH_SCORE_TABLE_ENTRY_1+28 ; Player ID
4875   14A8 3A 0E 60            ld      a,(SECOND_PLAYER)
4876   14AB 07                  rlca    
4877   14AC 3C                  inc     a
4878   14AD 4F                  ld      c,a
4879   14AE                     
4880   14AE                     ; Check each high score entry to find the one for this player
4881   14AE 11 22 00            ld      de,34						; 34 byte high score data structure
4882   14B1 06 04               ld      b,4						; For b = 4 to 1
4883   14B3 7E          l14c1:  ld      a,(hl)
4884   14B4 B9                  cp      c
4885   14B5 CA BB 14            jp      z,l14c9
4886   14B8 19                  add     hl,de						; Next high score entry
4887   14B9 10 F8               djnz    l14c1						; Next b
4888   14BB                     
4889   14BB                     ; Save the address of the high score entry player ID
4890   14BB 22 38 60    l14c9:  ld      (PLAYER_ID_ADDRESS),hl
4891   14BE             
4892   14BE             		; Save the position in the string to write the player's initials to
4893   14BE 11 F3 FF            ld      de,-13
4894   14C1 19                  add     hl,de
4895   14C2 22 3A 60            ld      (INITIALS_ADDRESS),hl
4896   14C5             		
4897   14C5             		; Display the letter selection box over the currently selected letter 
4898   14C5             		; (initially 'A')
4899   14C5 06 00               ld      b,0
4900   14C7 3A 35 60            ld      a,(SELECTED_LETTER)
4901   14CA 4F                  ld      c,a
4902   14CB CD EC 15            call    L_UPDATE_LETTER_SEL_BOX
4903   14CE             		
4904   14CE             		; If the initials timer delay has not run down, jump ahead to skip
4905   14CE             		; decrementing and displaying the initials timer value
4906   14CE 21 34 60    l14dc:  ld      hl,INITIALS_TIMER_DELAY
4907   14D1 35                  dec     (hl)
4908   14D2 C2 EE 14            jp      nz,l14fc
4909   14D5             		
4910   14D5             		; Reset the initials timer delay
4911   14D5 36 3E               ld      (hl),62
4912   14D7             		
4913   14D7             		; Decrement the initials countdown timer and jump ahead, if it has reached zero
4914   14D7 2B                  dec     hl
4915   14D8 35                  dec     (hl)
4916   14D9 CA B8 15            jp      z,l15c6
4917   14DC                     
4918   14DC             		; Determine the 10's (a) and 1's (b) digit of the initials timer value
4919   14DC 7E          		ld      a,(hl)
4920   14DD 06 FF               ld      b,255
4921   14DF 04          l14ed:  inc     b
4922   14E0 D6 0A               sub     10
4923   14E2 D2 DF 14            jp      nc,l14ed
4924   14E5 C6 0A               add     a,10
4925   14E7             		
4926   14E7             		; Display the 10's digit
4927   14E7 32 52 75            ld      (TILE_COORD(10,18)),a
4928   14EA             		
4929   14EA             		; Display the 1's digit
4930   14EA 78                  ld      a,b
4931   14EB 32 72 75            ld      (TILE_COORD(11,18)),a
4932   14EE             		
4933   14EE             		; Initialize the joystick input delay to 10
4934   14EE 21 30 60    l14fc:  ld      hl,JOYSTICK_INPUT_DELAY
4935   14F1 46                  ld      b,(hl)
4936   14F2 36 0A               ld      (hl),10
4937   14F4             		
4938   14F4             		; If the player has pushed the JUMP button (to select the current letter),
4939   14F4             		; jump ahead to process it
4940   14F4 3A 10 60            ld      a,(PLAYER_INPUT)
4941   14F7 CB 7F               bit     7,a
4942   14F9 C2 38 15            jp      nz,l1546
4943   14FC             		
4944   14FC             		; If the player has pushed the joystick either LEFT or RIGHT (to change the
4945   14FC             		; current letter), jump ahead to process it
4946   14FC E6 03               and     %00000011
4947   14FE C2 06 15            jp      nz,l1514
4948   1501             		
4949   1501             		; The joystick is not currently being pressed in any direction
4950   1501             		; so set the joystick input delay to 1 so the next time the joystick
4951   1501             		; is used, it will be processed immediately 
4952   1501 3C                  inc     a							; a = 1
4953   1502 77                  ld      (hl),a
4954   1503             		
4955   1503             		; Jump ahead to blink the current player's high score
4956   1503 C3 7C 15            jp      l158a
4957   1506             		
4958   1506             		; Decrement the joystick input delay
4959   1506             		; Jump ahead to handle the input only if the delay has reached 0
4960   1506             		; (Otherwise the input is ignored)
4961   1506 05          l1514:  dec     b
4962   1507 CA 0F 15            jp      z,l151d
4963   150A 78                  ld      a,b
4964   150B 77                  ld      (hl),a
4965   150C             		
4966   150C             		; Jump ahead to blink the current player's high score
4967   150C C3 7C 15            jp      l158a
4968   150F             		
4969   150F             		; If the player pushed the joystick LEFT, jump ahead to process it
4970   150F CB 4F       l151d:  bit     1,a
4971   1511 C2 2B 15            jp      nz,l1539
4972   1514             		
4973   1514             		; The player pushed the joystick RIGHT
4974   1514             		; Select the next letter to the right
4975   1514 3A 35 60            ld      a,(SELECTED_LETTER)
4976   1517 3C                  inc     a
4977   1518                     
4978   1518                     ; If the letter selection does not need to wrap, jump ahead 
4979   1518 FE 1E               cp      30
4980   151A C2 1F 15            jp      nz,l152d
4981   151D                     
4982   151D                     ; Wrap the letter selection back to the first letter
4983   151D 3E 00               ld      a,0
4984   151F                     
4985   151F                     ; Move the letter selection sprite to the newly selected letter
4986   151F 32 35 60    l152d:  ld      (SELECTED_LETTER),a
4987   1522 4F                  ld      c,a
4988   1523 06 00               ld      b,0
4989   1525 CD EC 15            call    L_UPDATE_LETTER_SEL_BOX
4990   1528                     
4991   1528                     ; Jump ahead to blink the current player's high score
4992   1528 C3 7C 15            jp      l158a
4993   152B                     
4994   152B                     ; The player pushed thw joystick LEFT
4995   152B                     ; Select the next letter to the left
4996   152B 3A 35 60    l1539:  ld      a,(SELECTED_LETTER)
4997   152E D6 01               sub     1
4998   1530                     
4999   1530                     ; If the letter selection does not need to be wrapped around, 
5000   1530                     ; jump back up to update the letter selection box sprite
5001   1530 F2 1F 15            jp      p,l152d
5002   1533                     
5003   1533                     ; Wrap the letter selection box around to the last letter
5004   1533 3E 1D               ld      a,29
5005   1535                     
5006   1535                     ; Jump back up to update the letter selection box sprite
5007   1535 C3 1F 15            jp      l152d
5008   1538                     
5009   1538                     ; The player pushed the JUMP button
5010   1538                     ; If "RUB" was selected, jump ahead to process it
5011   1538 3A 35 60    l1546:  ld      a,(SELECTED_LETTER)
5012   153B FE 1C               cp      28
5013   153D CA 5F 15            jp      z,l156d
5014   1540                     
5015   1540                     ; If "END" was selected, jump ahead to process it
5016   1540 FE 1D               cp      29
5017   1542 CA B8 15            jp      z,l15c6
5018   1545                     
5019   1545                     ; If the last initial entry position has been reached, 
5020   1545                     ; jump ahead to skip the letter selection and blink the current player's score
5021   1545 2A 36 60            ld      hl,(INITIALS_COORD)
5022   1548 01 88 75            ld      bc,TILE_COORD(12,8)
5023   154B A7                  and     a						; Clear the carry flag
5024   154C ED 42               sbc     hl,bc
5025   154E CA 7C 15            jp      z,l158a
5026   1551                     
5027   1551                     ; Convert the selected letter index to the actual letter
5028   1551 09                  add     hl,bc
5029   1552 C6 11               add     a,17
5030   1554                     
5031   1554                     ; Display the selected letter
5032   1554 77                  ld      (hl),a
5033   1555                     
5034   1555                     ; Advance to the next initial letter entry coordinate
5035   1555 01 E0 FF            ld      bc,-32
5036   1558 09                  add     hl,bc
5037   1559 22 36 60    l1567:  ld      (INITIALS_COORD),hl
5038   155C             
5039   155C             		; Jump ahead to blink the current player's high score
5040   155C C3 7C 15            jp      l158a
5041   155F                     
5042   155F                     ; "RUB" was selected
5043   155F                     ; Move left one initial letter entry coordinate
5044   155F 2A 36 60    l156d:  ld      hl,(INITIALS_COORD)
5045   1562 01 20 00            ld      bc,32
5046   1565 09                  add     hl,bc
5047   1566                     
5048   1566                     ; If the first initial entry coordinate has not been reached,
5049   1566                     ; jump ahead  
5050   1566 A7                  and     a						; Clear the carry flag
5051   1567 01 08 76            ld      bc,TILE_COORD(16,8)
5052   156A ED 42               sbc     hl,bc
5053   156C C2 78 15            jp      nz,l1586
5054   156F                     
5055   156F                     ; Keep the initial letter entry from going past the first entry coordinate
5056   156F 21 E8 75            ld      hl,TILE_COORD(15,8)
5057   1572                     
5058   1572                     ; Erase the initial letter
5059   1572 3E 10       l1580:  ld      a,$10
5060   1574 77                  ld      (hl),a
5061   1575 C3 59 15            jp      l1567
5062   1578                     
5063   1578                     ; Erase the initial letter to the left
5064   1578 09          l1586:  add     hl,bc
5065   1579 C3 72 15            jp      l1580
5066   157C             				
5067   157C             		; If the blink timer has not run down, jump ahead
5068   157C 21 32 60    l158a:  ld      hl,BLINK_SCORE_TIMER
5069   157F 35                  dec     (hl)
5070   1580 C2 EB 15            jp      nz,l15f9
5071   1583             		
5072   1583             		; If the blank score toggle is currently off, jump ahead to turn it on
5073   1583             		; and display the current player's high score
5074   1583 3A 31 60            ld      a,(BLANK_CP_HIGH_SCORE)
5075   1586 A7                  and     a
5076   1587 C2 AA 15            jp      nz,l15b8
5077   158A             		
5078   158A             		; Turn the blank score toggle on to cause the score to be blinked off
5079   158A 3E 01               ld      a,1
5080   158C 32 31 60            ld      (BLANK_CP_HIGH_SCORE),a
5081   158F             		
5082   158F             		; Load the address of blank score data
5083   158F 11 BF 01            ld      de,L_BLANK_SCORE_DATA
5084   1592             		
5085   1592             		; Load the screen coordinate to display the current player's high score
5086   1592 FD 2A 38 60 l15a0:  ld      iy,(PLAYER_ID_ADDRESS)
5087   1596 FD 6E 04            ld      l,(iy+4)
5088   1599 FD 66 05            ld      h,(iy+5)
5089   159C             		
5090   159C             		; Display the high score (or the blank score data)
5091   159C E5                  push    hl
5092   159D DD E1               pop     ix							; The screen coordinate
5093   159F CD 7C 05            call    L_DISPLAY_HIGH_SCORE_2
5094   15A2             		
5095   15A2             		; Reset the blink score timer to 16
5096   15A2 3E 10               ld      a,16
5097   15A4 32 32 60            ld      (BLINK_SCORE_TIMER),a
5098   15A7             		
5099   15A7 C3 EB 15            jp      l15f9
5100   15AA             		
5101   15AA             		; Toggle display of the score off
5102   15AA AF          l15b8:  xor     a
5103   15AB 32 31 60            ld      (BLANK_CP_HIGH_SCORE),a
5104   15AE             		
5105   15AE             		; Set DE to the last byte of the high score BCD entry
5106   15AE ED 5B 38 60         ld      de,(PLAYER_ID_ADDRESS)
5107   15B2 13                  inc     de
5108   15B3 13                  inc     de
5109   15B4 13                  inc     de
5110   15B5             		
5111   15B5             		; Jump back up to blank the score
5112   15B5 C3 92 15            jp      l15a0
5113   15B8             		
5114   15B8             		; Clear the player ID, for this high score entry as it is no longer needed
5115   15B8 ED 5B 38 60 l15c6:  ld      de,(PLAYER_ID_ADDRESS)
5116   15BC AF                  xor     a
5117   15BD 12                  ld      (de),a
5118   15BE             		
5119   15BE             		; Reset the minor timer to 128
5120   15BE 21 09 60            ld      hl,MINOR_TIMER
5121   15C1 36 80               ld      (hl),128
5122   15C3             		
5123   15C3             		; Decrement the game substate
5124   15C3 23          l15d1:  inc     hl
5125   15C4 35                  dec     (hl)
5126   15C5             		
5127   15C5             		; Copy the initials the player entered to the high score entry
5128   15C5             		; NOTE: Although only 3 initials are accepted, 12 characters are copied
5129   15C5             		;		Is it possible, the programmers originally intended to use all 12
5130   15C5             		;		characters for the player's name?
5131   15C5 06 0C               ld      b,12						; For b = 12 to 1 (12 characters to copy)
5132   15C7 21 E8 75            ld      hl,TILE_COORD(15,8)
5133   15CA FD 2A 3A 60         ld      iy,(INITIALS_ADDRESS)
5134   15CE 11 E0 FF            ld      de,-32
5135   15D1 7E          l15df:  ld      a,(hl)
5136   15D2 FD 77 00            ld      (iy+0),a
5137   15D5 FD 23               inc     iy
5138   15D7 19                  add     hl,de
5139   15D8 10 F7               djnz    l15df						; Next b
5140   15DA             		
5141   15DA             		; Redisplay the high score table
5142   15DA 06 05               ld      b,5							; For b = 5 to 1 (5 high scores to redisplay)
5143   15DC 11 14 03            ld      de,$0314
5144   15DF CD 22 30    l15ed:  call    L_ADD_EVENT
5145   15E2 13                  inc     de
5146   15E3 10 FA               djnz    l15ed						; Next b
5147   15E5             		
5148   15E5             		; Display "YOUR NAME WAS REGISTERED"
5149   15E5 11 1A 03            ld      de,$031a					
5150   15E8 CD 22 30            call    L_ADD_EVENT
5151   15EB             		
5152   15EB C9          l15f9:  ret     
5153   15EC             ;------------------------------------------------------------------------------
5154   15EC             
5155   15EC             
5156   15EC             
5157   15EC             ;------------------------------------------------------------------------------
5158   15EC             ; Update the letter selection sprite on the High Score entry screen over the
5159   15EC             ; currently selected letter
5160   15EC             ;
5161   15EC             ; passed:	bc - the index number of the currently selected letter in the 
5162   15EC             ;				high score letter coordinate table
5163   15EC             L_UPDATE_LETTER_SEL_BOX:  
5164   15EC D5          		push    de
5165   15ED E5                  push    hl
5166   15EE             		
5167   15EE             		; Multiply the letter index by two to convert it to a table offset
5168   15EE CB 21               sla     c
5169   15F0             		
5170   15F0             		; Look up the letter coordinates in the table
5171   15F0 21 81 35            ld      hl,L_HS_LETTER_COORD_TABLE
5172   15F3 09                  add     hl,bc
5173   15F4 EB                  ex      de,hl
5174   15F5             		
5175   15F5             		; Position the letter selection box sprite over the selected letter
5176   15F5 21 74 69            ld      hl,ELEVATOR_MOTOR_SPRITE_2_X	; Used in this case for the letter selection box sprite
5177   15F8 1A                  ld      a,(de)
5178   15F9 13                  inc     de
5179   15FA 77                  ld      (hl),a						; X coordinate
5180   15FB 23                  inc     hl
5181   15FC 36 72               ld      (hl),$72					; Letter selection box sprite
5182   15FE 23                  inc     hl
5183   15FF 36 0C               ld      (hl),$0c					; Palette
5184   1601 23                  inc     hl
5185   1602 1A                  ld      a,(de)						; Y coordinate
5186   1603 77                  ld      (hl),a
5187   1604             		
5188   1604 E1                  pop     hl
5189   1605 D1                  pop     de
5190   1606                     
5191   1606 C9          		ret     
5192   1607             ;------------------------------------------------------------------------------
5193   1607             
5194   1607             
5195   1607             
5196   1607             ;------------------------------------------------------------------------------
5197   1607             ; Display each stage of the standard stage win animation
5198   1607             ; The win animations for the mixer and rivets stages are handled elsewhere
5199   1607             L_IMPLEMENT_STAGE_WIN_ANIM:  
5200   1607 CD 40 30    		call    L_CLEAR_SPRITES_WHEN_DEAD
5201   160A             		
5202   160A             		; If the current stage is mixer or rivets, jump ahead for 
5203   160A             		; their win animations
5204   160A 3A 27 62            ld      a,(CURRENT_STAGE)
5205   160D 0F                  rrca    
5206   160E D2 21 16            jp      nc,L_IMPLEMENT_MIXER_WIN_ANIM
5207   1611                     
5208   1611                     ; Jump based on the state of the win animation
5209   1611 3A 88 63            ld      a,(WIN_ANIMATION_STATE)
5210   1614 EF          l1622:  rst     $28							; Jump to local table address
5211   1615             		; Jump table
5212   1615 46 16               .word	L_WIN_STAGE_ANIM_0	; 0 = Donkey Kong climbing animation 0
5213   1617 62 16       		.word	L_WIN_STAGE_ANIM_1	; 1 = Donkey Kong climbing animation 1
5214   1619 7C 16       		.word	L_WIN_STAGE_ANIM_2	; 2 = Donkey Kong climbing animation 2
5215   161B 24 17       		.word	L_WIN_STAGE_ANIM_3	; 3 = Donkey Kong climbing animation 3 (Donkey Kong grabs Pauline)
5216   161D 49 17       		.word	L_WIN_STAGE_ANIM_4	; 4 = Donkey Kong climbing animation 4
5217   161F 80 17       		.word	L_ADVANCE_TO_NEXT_STAGE	; 5 = Donkey Kong climbing animation 5
5218   1621             ;------------------------------------------------------------------------------
5219   1621             
5220   1621             
5221   1621             
5222   1621             ;------------------------------------------------------------------------------
5223   1621             ; Display each stage of the mixer stage win animation
5224   1621             ; The win animations for the rivets stage is handled elsewhere
5225   1621             L_IMPLEMENT_MIXER_WIN_ANIM:  
5226   1621             		; If this is the rivets stage, jump ahead to implement that win animation
5227   1621 0F          		rrca    
5228   1622 D2 33 16            jp 		nc,L_IMPLEMENT_RIVETS_WIN_ANIM
5229   1625                     
5230   1625 3A 88 63            ld      a,(WIN_ANIMATION_STATE)
5231   1628 EF                  rst     $28							; Jump to local table address
5232   1629             		; Jump table
5233   1629 95 16       		.word	L_MIXER_WIN_STAGE_ANIM_0	; 0 = 
5234   162B AD 16       		.word	L_WAIT_FOR_DK_TO_REACH_LADDERS	; 1 = 
5235   162D 24 17       		.word	L_WIN_STAGE_ANIM_3	; 2 = 
5236   162F 49 17       		.word	L_WIN_STAGE_ANIM_4	; 3 = 
5237   1631 80 17       		.word	L_ADVANCE_TO_NEXT_STAGE	; 4 = 
5238   1633             ;------------------------------------------------------------------------------
5239   1633             
5240   1633             
5241   1633             
5242   1633             ;------------------------------------------------------------------------------
5243   1633             L_IMPLEMENT_RIVETS_WIN_ANIM:  
5244   1633             		
5245   1633 CD A7 1D    		call    L_IMPLEMENT_POINT_AWARD
5246   1636 3A 88 63            ld      a,(WIN_ANIMATION_STATE)
5247   1639 EF                  rst     $28							; Jump to local table address
5248   163A             		; Jump table
5249   163A A8 17       		.word	L_RIVETS_WIN_STAGE_ANIM_0	; 0 = 
5250   163C EC 2F       		.word	L_PAUSE_CURRENT_STATE		; 1 = 
5251   163E 2A 18       		.word	L_RIVETS_WIN_STAGE_ANIM_1	; 2 = 
5252   1640 60 18       		.word	L_RIVETS_WIN_STAGE_ANIM_2	; 3 = 
5253   1642 71 18       		.word	L_RIVETS_WIN_STAGE_ANIM_3	; 4 = 
5254   1644 B7 18       		.word	L_RIVETS_WIN_STAGE_ANIM_4	; 5 = 
5255   1646             ;------------------------------------------------------------------------------
5256   1646             
5257   1646             
5258   1646             
5259   1646             ;------------------------------------------------------------------------------
5260   1646             L_WIN_STAGE_ANIM_0:	
5261   1646             		; Display Pauline standing with a heart next to her
5262   1646             		; Also start playing the standard win stage tune
5263   1646 CD FA 16    		call L_WIN_ANIM_DISPLAY_PAULINE
5264   1649             		
5265   1649             		; Display Donkey Kong with his left arm raised
5266   1649 21 CE 37            ld      hl,L_DK_SPRITES_L_ARM_RAISED
5267   164C CD 4E 00            call    L_LOAD_DK_SPRITES
5268   164F                     
5269   164F                     ; Initialize the minor timer to 32
5270   164F 3E 20               ld      a,32
5271   1651 32 09 60            ld      (MINOR_TIMER),a
5272   1654             
5273   1654             		; Advance to the next stage of the animation
5274   1654 21 88 63    l1662:  ld      hl,WIN_ANIMATION_STATE
5275   1657 34                  inc     (hl)
5276   1658             
5277   1658             		; Return unless this is the barrels stage
5278   1658 3E 01               ld      a,$01
5279   165A F7                  rst     $30							; Return unless this is the barrels stage
5280   165B                     
5281   165B                     ; Move Donkey Kong up 4 pixels
5282   165B 21 0B 69            ld      hl,DK_SPRITE_1_Y
5283   165E 0E FC               ld      c,$fc
5284   1660 FF                  rst     $38
5285   1661 C9                  ret     
5286   1662             ;------------------------------------------------------------------------------
5287   1662             
5288   1662             
5289   1662             
5290   1662             ;------------------------------------------------------------------------------
5291   1662             L_WIN_STAGE_ANIM_1:	
5292   1662             		; Return until the minor timer has reached 0
5293   1662 DF          		rst     $18
5294   1663                     
5295   1663                     ; Change Donkey Kong's sprites
5296   1663 21 A4 38            ld      hl,L_DK_SPRITES_THROW_BARREL
5297   1666 CD 4E 00            call    L_LOAD_DK_SPRITES
5298   1669                     
5299   1669                     ; Reset the minor timer to 32
5300   1669 3E 20               ld      a,32
5301   166B 32 09 60            ld      (MINOR_TIMER),a
5302   166E                     
5303   166E                     ; Advance to the next animation stage
5304   166E 21 88 63            ld      hl,WIN_ANIMATION_STATE
5305   1671 34                  inc     (hl)
5306   1672                     
5307   1672                     ; Return unless this is the elevators stage
5308   1672 3E 04               ld      a,4
5309   1674 F7                  rst     $30
5310   1675                     
5311   1675                     ; Move Donkey Kong up 4 pixels
5312   1675 21 0B 69            ld      hl,DK_SPRITE_1_Y
5313   1678 0E 04       l1686:  ld      c,4
5314   167A FF                  rst     $38
5315   167B                     
5316   167B C9                  ret     
5317   167C             ;------------------------------------------------------------------------------
5318   167C             ;------------------------------------------------------------------------------
5319   167C             L_WIN_STAGE_ANIM_2:  
5320   167C             		; Return until the minor timer has reached 0
5321   167C DF          		rst     $18
5322   167D                     
5323   167D                     ; Change the Donkey Kong sprites
5324   167D 21 FE 37            ld      hl,L_DK_SPRITES_CLIMBING
5325   1680 CD 4E 00            call    L_LOAD_DK_SPRITES
5326   1683                     
5327   1683                     ; Show Donkey Kong's right arm climbing the ladder
5328   1683 3E 66               ld      a,102
5329   1685 32 0C 69            ld      (DK_SPRITE_2_X),a
5330   1688                     
5331   1688                     ; Hide the sprites showing Donkey Kong carrying Pauline
5332   1688 AF                  xor     a						; a = 0
5333   1689 32 24 69            ld      (DK_SPRITE_8_X),a
5334   168C 32 2C 69            ld      (DK_SPRITE_10_X),a
5335   168F 32 AF 62            ld      (DK_CLIMBING_COUNTER),a
5336   1692                     
5337   1692                     ; Jump back to advance the animation state and
5338   1692                     ; move Donkey Kong into position
5339   1692 C3 54 16            jp      l1662
5340   1695             ;------------------------------------------------------------------------------
5341   1695             
5342   1695             
5343   1695             
5344   1695             ;------------------------------------------------------------------------------
5345   1695             L_MIXER_WIN_STAGE_ANIM_0:  
5346   1695             		; Display Pauline standing with a heart next to her
5347   1695 CD FA 16    		call    L_WIN_ANIM_DISPLAY_PAULINE
5348   1698             		
5349   1698             		; Determine where the conveyer has moved Donkey Kong
5350   1698 3A 10 69            ld      a,(DK_SPRITE_3_X)
5351   169B D6 3B               sub     59
5352   169D                     
5353   169D                     ; Load new Donkey Kong sprites
5354   169D 21 CE 37            ld      hl,L_DK_SPRITES_L_ARM_RAISED
5355   16A0 CD 4E 00    		call    L_LOAD_DK_SPRITES
5356   16A3             		
5357   16A3             		; Move Donkey Kong back to where the conveyer has moved him
5358   16A3 21 08 69            ld      hl,DK_SPRITE_1_X
5359   16A6 4F                  ld      c,a
5360   16A7 FF                  rst     $38
5361   16A8                     
5362   16A8                     ; Advance to the next animation state
5363   16A8 21 88 63            ld      hl,WIN_ANIMATION_STATE
5364   16AB 34                  inc     (hl)
5365   16AC C9                  ret     
5366   16AD             ;------------------------------------------------------------------------------
5367   16AD             
5368   16AD             
5369   16AD             ;------------------------------------------------------------------------------
5370   16AD             ; Wait for the conveyer belt to move Donkey Kong to the escape ladders
5371   16AD             L_WAIT_FOR_DK_TO_REACH_LADDERS:  
5372   16AD             		; Set the conveyer reverse timer to 256 (maximum)
5373   16AD AF          		xor     a
5374   16AE 32 A0 62            ld      (TOP_MASTER_REVERSE_TIMER),a
5375   16B1                     
5376   16B1                     ; Save the top conveyer's direction
5377   16B1 3A A3 63            ld      a,(TOP_CONVEYER_DIR)
5378   16B4 4F                  ld      c,a
5379   16B5                     
5380   16B5                     ; If Donkey Kong is to the right of x coordinate 90,
5381   16B5                     ; jump ahead
5382   16B5 3A 10 69            ld      a,(DK_SPRITE_3_X)
5383   16B8 FE 5A               cp      90
5384   16BA D2 D3 16            jp      nc,l16e1
5385   16BD                     
5386   16BD                     ; If Donkey Kong is to the left of x coordinate 90 and
5387   16BD             		; the conveyer is moving right, jump ahead
5388   16BD CB 79               bit     7,c
5389   16BF CA C7 16            jp      z,l16d5
5390   16C2                     
5391   16C2                     ; Set the conveyer reverse timer to 1 so that it will reverse
5392   16C2             		; immediately
5393   16C2 3E 01       l16d0:  ld      a,1
5394   16C4 32 A0 62            ld      (TOP_MASTER_REVERSE_TIMER),a
5395   16C7             		
5396   16C7 CD D6 25    l16d5:  call    L_IMPLEMENT_TOP_CONVEYER
5397   16CA             	
5398   16CA             		; Move Donkey Kong along the conveyer belt
5399   16CA 3A A3 63            ld      a,(TOP_CONVEYER_DIR)
5400   16CD 4F                  ld      c,a
5401   16CE 21 08 69            ld      hl,DK_SPRITE_1_X
5402   16D1 FF                  rst     $38
5403   16D2 C9                  ret     
5404   16D3             		
5405   16D3             		; If Donkey Kong is to the left of x coordinate 93,
5406   16D3             		; jump ahead because he's in the sweet spot
5407   16D3 FE 5D       l16e1:  cp      93
5408   16D5 DA E0 16            jp      c,l16ee
5409   16D8                     
5410   16D8                     ; If Donkey Kong is to the right of x coordinate 93 and
5411   16D8             		; the conveyer is moving right, jump ahead
5412   16D8 CB 79               bit     7,c
5413   16DA CA C2 16            jp      z,l16d0
5414   16DD                     
5415   16DD             		; Jump back up to reverse the conveyer belt
5416   16DD C3 C7 16            jp      l16d5
5417   16E0                     
5418   16E0             		; Change Donkey Kong's sprites to climbing
5419   16E0 21 FE 37    l16ee:  ld      hl,L_DK_SPRITES_CLIMBING
5420   16E3 CD 4E 00            call    L_LOAD_DK_SPRITES
5421   16E6             		
5422   16E6             		; Display Donkey Kong's right climbing arm
5423   16E6 3E 66               ld      a,102
5424   16E8 32 0C 69            ld      (DK_SPRITE_2_X),a
5425   16EB             		
5426   16EB             		; Hide Donkey Kong's right carrying arm and Pauline being carried
5427   16EB AF                  xor     a
5428   16EC 32 24 69            ld      (DK_SPRITE_8_X),a
5429   16EF 32 2C 69            ld      (DK_SPRITE_10_X),a
5430   16F2             		
5431   16F2             		; Zero the climbing counter
5432   16F2 32 AF 62            ld      (DK_CLIMBING_COUNTER),a
5433   16F5             		
5434   16F5             		; Advance the win animation state
5435   16F5 21 88 63            ld      hl,WIN_ANIMATION_STATE
5436   16F8 34                  inc     (hl)
5437   16F9 C9                  ret     
5438   16FA             ;------------------------------------------------------------------------------
5439   16FA             
5440   16FA             
5441   16FA             
5442   16FA             ;------------------------------------------------------------------------------
5443   16FA             ; Update Pauline for the stage win animation
5444   16FA             ; Pauline is displayed with a heart next to her
5445   16FA             L_WIN_ANIM_DISPLAY_PAULINE:  
5446   16FA CD 1C 01    		call    L_SOUNDS_OFF
5447   16FD             
5448   16FD             		; Initialize the heart sprite that appears next to Pauline during the
5449   16FD             		; win stage animation
5450   16FD 21 20 6A            ld      hl,HEART_SPRITE_X
5451   1700 36 80               ld      (hl),128
5452   1702 23                  inc     hl
5453   1703 36 76               ld      (hl),$76					; HEART_SPRITE_NUM
5454   1705 23                  inc     hl
5455   1706 36 09               ld      (hl),$09					; HEART_SPRITE_PAL
5456   1708 23                  inc     hl
5457   1709 36 20               ld      (hl),32					; HEART_SPRITE_Y
5458   170B                     
5459   170B                     ; Display Pauline standing calmly
5460   170B 21 05 69            ld      hl,PAULINE_LOWER_SPRITE_NUM
5461   170E 36 13               ld      (hl),$13
5462   1710                     
5463   1710                     ; Clear the "HELP!" tiles to Pauline's right
5464   1710 21 C4 75            ld      hl,TILE_COORD(14,4)
5465   1713 11 20 00            ld      de,32
5466   1716 3E 10               ld      a,$10						; Blank tile
5467   1718 CD 14 05            call    L_DISPLAY_OR_CLEAR_HELP						; Clear HELP!
5468   171B                     
5469   171B                     ; Play the standard win stage song (triggered three times)
5470   171B 21 8A 60            ld      hl,PENDING_SONG_TRIGGER
5471   171E 36 07               ld      (hl),SONG_TRIGGER_STAGE_END
5472   1720 23                  inc     hl
5473   1721 36 03               ld      (hl),3
5474   1723 C9                  ret     
5475   1724             ;------------------------------------------------------------------------------
5476   1724             
5477   1724             
5478   1724             
5479   1724             ;------------------------------------------------------------------------------
5480   1724             L_WIN_STAGE_ANIM_3:  
5481   1724             		; Animate Donkey Kong climbing up the exit ladders
5482   1724 CD F2 2F    		call    L_ANIMATE_CLIMBING_LADDERS
5483   1727                     
5484   1727                     ; Return if Donkey Kong hasn't yet reached Pauline's platform
5485   1727 3A 13 69            ld      a,(DK_SPRITE_3_Y)
5486   172A FE 2C               cp      44
5487   172C D0                  ret     nc
5488   172D                     
5489   172D                     ; Hide Pauline's sprites
5490   172D AF                  xor     a
5491   172E 32 00 69            ld      (PAULINE_UPPER_SPRITE_X),a
5492   1731 32 04 69            ld      (PAULINE_LOWER_SPRITE_X),a
5493   1734                     
5494   1734                     ; Hide Donkey Kong's climbing right arm sprite
5495   1734 32 0C 69            ld      (DK_SPRITE_2_X),a
5496   1737                     
5497   1737                     ; Display Donkey Kong's right arm carrying sprite
5498   1737 3E 6B               ld      a,107
5499   1739 32 24 69            ld      (DK_SPRITE_8_X),a
5500   173C                     
5501   173C                     ; Display Pauline being carrying sprite
5502   173C 3D                  dec     a
5503   173D 32 2C 69            ld      (DK_SPRITE_10_X),a
5504   1740                     
5505   1740                     ; Replace the heart sprite with the broken heart sprite
5506   1740 21 21 6A            ld      hl,HEART_SPRITE_NUM
5507   1743 34                  inc     (hl)
5508   1744                     
5509   1744                     ; Advance to the next win animation state
5510   1744 21 88 63            ld      hl,WIN_ANIMATION_STATE
5511   1747 34                  inc     (hl)
5512   1748 C9                  ret     
5513   1749             ;------------------------------------------------------------------------------
5514   1749             
5515   1749             
5516   1749             
5517   1749             ;------------------------------------------------------------------------------
5518   1749             L_WIN_STAGE_ANIM_4:  
5519   1749             		; Animate Donkey Kong climbing off the stage
5520   1749 CD F2 2F    		call    L_ANIMATE_CLIMBING_LADDERS
5521   174C CD 5E 17            call    L_HIDE_OFFSCREEN_DK_SPRITES
5522   174F                     
5523   174F                     ; Return until all of Donkey Kong's sprites are hidden 
5524   174F                     ; (Donkey Kong has climbed completely offscreen)
5525   174F 23                  inc     hl						; hl = x coordinate of first Donkey Kong sprite
5526   1750 13                  inc     de						; de = 4
5527   1751 CD 75 17            call    L_CHECK_IF_DK_SPRITES_HIDDEN
5528   1754                     
5529   1754                     ; Set minor timer to 64
5530   1754 3E 40               ld      a,64
5531   1756 32 09 60            ld      (MINOR_TIMER),a
5532   1759                     
5533   1759                     ; Advance to the next animation state
5534   1759 21 88 63            ld      hl,WIN_ANIMATION_STATE
5535   175C 34                  inc     (hl)
5536   175D C9                  ret     
5537   175E             ;------------------------------------------------------------------------------
5538   175E             
5539   175E             
5540   175E             
5541   175E             ;------------------------------------------------------------------------------
5542   175E             ; This function hidesach sprite in Donkey Kong as it goes off screen
5543   175E             L_HIDE_OFFSCREEN_DK_SPRITES:  
5544   175E             		; Check each sprite in Donkey Kong
5545   175E 11 03 00    		ld      de,3
5546   1761 21 2F 69            ld      hl,DK_SPRITE_10_Y
5547   1764 06 0A               ld      b,10						; For b = 10 to 1 (10 sprites in Donkey Kong)
5548   1766             
5549   1766             		; If this Donkey Kong sprite has not gone off the screen yet,
5550   1766             		; jump ahead to process the next sprite
5551   1766 A7          l1774:  and     a							; Clear carry flag
5552   1767 7E                  ld      a,(hl)						; a = sprite y coordinate
5553   1768 ED 52               sbc     hl,de						; hl = sprite x coordinate
5554   176A FE 19               cp      25
5555   176C D2 71 17            jp      nc,l177f
5556   176F                     
5557   176F                     ; Hide this sprite
5558   176F 36 00               ld      (hl),0
5559   1771                     
5560   1771                     ; Move on to the next sprite
5561   1771 2B          l177f:  dec     hl
5562   1772 10 F2               djnz    l1774						; Next b
5563   1774 C9                  ret     
5564   1775             ;------------------------------------------------------------------------------
5565   1775             
5566   1775             
5567   1775             
5568   1775             ;------------------------------------------------------------------------------
5569   1775             ; This function checks each sprite in Donkey Kong to see if they've been hidden
5570   1775             ; If all the sprites have been hidden, the function simply returns
5571   1775             ; If there are still unhidden sprites, the calling function is aborted
5572   1775             L_CHECK_IF_DK_SPRITES_HIDDEN:  
5573   1775             		; Check each Donkey Kong sprite
5574   1775 06 0A       		ld      b,10						; For b = 10 to 1 (10 sprites in Donkey Kong)
5575   1777             
5576   1777             		; If this sprite has not been hidden, return from the calling function
5577   1777 7E          l1785:  ld      a,(hl)
5578   1778 A7                  and     a
5579   1779 C2 26 00            jp      nz,l0026
5580   177C                     
5581   177C                     ; Next sprite
5582   177C 19                  add     hl,de
5583   177D 10 F8               djnz    l1785						; Next b
5584   177F C9                  ret     
5585   1780             ;------------------------------------------------------------------------------
5586   1780             
5587   1780             
5588   1780             
5589   1780             ;------------------------------------------------------------------------------
5590   1780             L_ADVANCE_TO_NEXT_STAGE:  
5591   1780             		; Return until the minor timer expires
5592   1780 DF          		rst     $18
5593   1781             		
5594   1781             		; Advance to the next stage
5595   1781 2A 2A 62            ld      hl,(CP_STAGE_ORDER_POINTER)
5596   1784 23                  inc     hl
5597   1785                     
5598   1785                     ; If the end the stage data has not been reached, jump ahead
5599   1785 7E                  ld      a,(hl)
5600   1786 FE 7F               cp      $7f
5601   1788 C2 8F 17            jp      nz,l179d
5602   178B                     
5603   178B                     ; Repeat level 5's stage order indefinately
5604   178B 21 E5 39            ld      hl,L_STAGE_ORDER_TABLE_LAST
5605   178E 7E                  ld      a,(hl)
5606   178F                     
5607   178F                     ; Update the current stage
5608   178F 22 2A 62    l179d:  ld      (CP_STAGE_ORDER_POINTER),hl
5609   1792 32 27 62            ld      (CURRENT_STAGE),a
5610   1795                     
5611   1795                     ; Display the timer and add it to the player's score
5612   1795 11 00 05            ld      de,$0500
5613   1798 CD 22 30            call    L_ADD_EVENT
5614   179B                     
5615   179B                     ; Reset the win animation state
5616   179B AF                  xor     a
5617   179C 32 88 63            ld      (WIN_ANIMATION_STATE),a
5618   179F                     
5619   179F                     ; Set the minor timer to 48
5620   179F 21 09 60            ld      hl,MINOR_TIMER
5621   17A2 36 30               ld      (hl),48
5622   17A4                     
5623   17A4                     ; Set the game substate to 8
5624   17A4                     ; (Intermission)
5625   17A4 23                  inc     hl
5626   17A5 36 08               ld      (hl),8
5627   17A7 C9                  ret     
5628   17A8             ;------------------------------------------------------------------------------
5629   17A8             
5630   17A8             	
5631   17A8             
5632   17A8             ;------------------------------------------------------------------------------
5633   17A8             L_RIVETS_WIN_STAGE_ANIM_0:  
5634   17A8             		; Trigger the rivet stageg end song
5635   17A8 CD 1C 01    		call    L_SOUNDS_OFF
5636   17AB 21 8A 60            ld      hl,PENDING_SONG_TRIGGER
5637   17AE 36 0E               ld      (hl),SONG_TRIGGER_RIVET_END
5638   17B0 23                  inc     hl
5639   17B1 36 03               ld      (hl),3
5640   17B3                     
5641   17B3                     ; Clear all "HELP!" tiles around Pauline
5642   17B3 3E 10               ld      a,$10						; Blank tile
5643   17B5 11 20 00            ld      de,32
5644   17B8 21 23 76            ld      hl,TILE_COORD(17,3)
5645   17BB CD 14 05            call    L_DISPLAY_OR_CLEAR_HELP		; Clear HELP!
5646   17BE 21 83 75            ld      hl,TILE_COORD(12,3)
5647   17C1 CD 14 05            call    L_DISPLAY_OR_CLEAR_HELP		; Clear HELP!
5648   17C4                     
5649   17C4                     ; Clear each detached platform and redisplay it as fallen
5650   17C4 21 DA 76            ld      hl,TILE_COORD(22,26)
5651   17C7 CD 17 18            call    L_CLEAR_AROUND_GAME_OVER
5652   17CA 11 B9 39            ld      de,L_RIVETS_DATA_FALL1
5653   17CD CD A4 0D            call    L_DISPLAY_STAGE
5654   17D0 21 D5 76            ld      hl,TILE_COORD(22,21)
5655   17D3 CD 17 18            call    L_CLEAR_AROUND_GAME_OVER
5656   17D6 11 BF 39            ld      de,L_RIVETS_DATA_FALL2
5657   17D9 CD A4 0D            call    L_DISPLAY_STAGE
5658   17DC 21 D0 76            ld      hl,TILE_COORD(22,16)
5659   17DF CD 17 18            call    L_CLEAR_AROUND_GAME_OVER
5660   17E2 11 C5 39            ld      de,L_RIVETS_DATA_FALL3
5661   17E5 CD A4 0D            call    L_DISPLAY_STAGE
5662   17E8 21 CB 76            ld      hl,TILE_COORD(22,11)
5663   17EB CD 17 18            call    L_CLEAR_AROUND_GAME_OVER
5664   17EE 11 CB 39            ld      de,L_RIVETS_DATA_FALL4
5665   17F1 CD A4 0D            call    L_DISPLAY_STAGE
5666   17F4                     
5667   17F4                     ; Change Donkey Kong's sprites
5668   17F4 21 CE 37            ld      hl,L_DK_SPRITES_L_ARM_RAISED
5669   17F7 CD 4E 00            call    L_LOAD_DK_SPRITES
5670   17FA 21 08 69            ld      hl,DK_SPRITE_1_X
5671   17FD 0E 44               ld      c,68
5672   17FF FF                  rst     $38
5673   1800                     
5674   1800                     ; Update Pauline
5675   1800 21 05 69            ld      hl,PAULINE_LOWER_SPRITE_NUM
5676   1803 36 13               ld      (hl),$13
5677   1805                     
5678   1805                     ; Set the minor timer to 32
5679   1805 3E 20               ld      a,32
5680   1807 32 09 60            ld      (MINOR_TIMER),a
5681   180A                     
5682   180A                     ; Set the animation timer to 128 to control Donkey Kong and Pauline's animation
5683   180A 3E 80               ld      a,128
5684   180C 32 90 63            ld      (ANIMATION_TIMER),a
5685   180F                     
5686   180F                     ; Increment the animation state
5687   180F 21 88 63            ld      hl,WIN_ANIMATION_STATE
5688   1812 34                  inc     (hl)
5689   1813 22 C0 63            ld      (CURRENT_STATE_VAR_POINTER),hl
5690   1816 C9                  ret     
5691   1817             ;------------------------------------------------------------------------------
5692   1817             
5693   1817             
5694   1817             
5695   1817             ;------------------------------------------------------------------------------
5696   1817             ; Clear the section of the screen around the game over message
5697   1817             ; passed:	hl - the starting tile coordinate
5698   1817             L_CLEAR_AROUND_GAME_OVER:  
5699   1817 11 DB FF    		ld      de,-37
5700   181A 0E 0E               ld      c,14						; For c = 14 to 1 
5701   181C 3E 10               ld      a,$10					; Space
5702   181E 06 05       l182d:  ld      b,5						; For b = 5 to 1
5703   1820 77          l182f:  ld      (hl),a
5704   1821 23                  inc     hl
5705   1822 10 FC               djnz    l182f
5706   1824 19                  add     hl,de					; 
5707   1825 0D                  dec     c
5708   1826 C2 1E 18            jp      nz,l182d					; Next c
5709   1829                     
5710   1829 C9                  ret     
5711   182A             ;------------------------------------------------------------------------------
5712   182A             
5713   182A             
5714   182A             
5715   182A             ;------------------------------------------------------------------------------
5716   182A             L_RIVETS_WIN_STAGE_ANIM_1:  
5717   182A             		; If the animation timer has rolled over, jump ahead
5718   182A 21 90 63    		ld      hl,ANIMATION_TIMER
5719   182D 34                  inc     (hl)
5720   182E CA 4A 18            jp      z,l1859
5721   1831                     
5722   1831                     ; Return if the lowest 3 bits are not 0s
5723   1831 7E                  ld      a,(hl)
5724   1832 E6 07               and     %0000111
5725   1834 C0                  ret     nz
5726   1835                     
5727   1835                     ; If bit 3 of the animation timer is 1,
5728   1835                     ; jump ahead to make Donkey Kong stomp on his left foot
5729   1835 11 41 39            ld      de,L_DK_SPRITES_GRIN_L_STOMP
5730   1838 CB 5E               bit     3,(hl)
5731   183A 20 03               jr      nz,l184e
5732   183C                     
5733   183C                     ; Bit 3 of theganimation timer is 0,
5734   183C                     ; make Donkey Kongfstomp on his right foot 
5735   183C 11 69 39            ld      de,L_DK_SPRITES_GRIN_R_STOMP
5736   183F                     
5737   183F                     ; Change Donkey Kong's sprites
5738   183F EB          l184e:  ex      de,hl
5739   1840 CD 4E 00            call    L_LOAD_DK_SPRITES
5740   1843 21 08 69            ld      hl,DK_SPRITE_1_X
5741   1846 0E 44               ld      c,68
5742   1848 FF                  rst     $38
5743   1849 C9                  ret     
5744   184A                     
5745   184A                     ; Change Donkey Kong's sprites
5746   184A 21 CE 37    l1859:  ld      hl,L_DK_SPRITES_L_ARM_RAISED
5747   184D CD 4E 00            call    L_LOAD_DK_SPRITES
5748   1850 21 08 69            ld      hl,DK_SPRITE_1_X
5749   1853 0E 44               ld      c,68
5750   1855 FF                  rst     $38
5751   1856                     
5752   1856                     ; Set the minor timer to 32
5753   1856 3E 20               ld      a,32
5754   1858 32 09 60            ld      (MINOR_TIMER),a
5755   185B                     
5756   185B                     ; Advance to the next animation state
5757   185B 21 88 63            ld      hl,WIN_ANIMATION_STATE
5758   185E 34                  inc     (hl)
5759   185F C9                  ret 
5760   1860             ;------------------------------------------------------------------------------
5761   1860             
5762   1860                         
5763   1860             
5764   1860             ;------------------------------------------------------------------------------
5765   1860             L_RIVETS_WIN_STAGE_ANIM_2:  
5766   1860             		; Return until the minor timer times out
5767   1860 DF          		rst     $18
5768   1861             		
5769   1861                     ; Change Donkey Kong's sprites
5770   1861 21 91 39            ld      hl,L_DK_SPRITES_GRIN_UD
5771   1864 CD 4E 00            call    L_LOAD_DK_SPRITES
5772   1867                     
5773   1867                     ; Trigger the falling sound
5774   1867 3E 03               ld      a,3
5775   1869 32 84 60            ld      (FALL_SOUND_TRIGGER),a
5776   186C                     
5777   186C                     ; Advance to the next animation state
5778   186C 21 88 63            ld      hl,WIN_ANIMATION_STATE
5779   186F 34                  inc     (hl)
5780   1870 C9                  ret  
5781   1871             ;------------------------------------------------------------------------------
5782   1871             
5783   1871                        
5784   1871             
5785   1871             ;------------------------------------------------------------------------------
5786   1871             L_RIVETS_WIN_STAGE_ANIM_3:  
5787   1871             		; Move Donkey Kong down 1 pixel
5788   1871 21 0B 69    		ld      hl,DK_SPRITE_1_Y
5789   1874 0E 01               ld      c,1
5790   1876 FF                  rst     $38
5791   1877                     
5792   1877                     ; Return if Donkey Kong has not reached the fallen platforms
5793   1877 3A 1B 69            ld      a,(DK_SPRITE_5_Y)
5794   187A FE D0               cp      208
5795   187C C0                  ret     nz
5796   187D                     
5797   187D                     ; Change Donkey Kong's head sprite
5798   187D 3E 20               ld      a,$20
5799   187F 32 19 69            ld      (DK_SPRITE_5_NUM),a
5800   1882                     
5801   1882                     ; Create the stars sprite just below Donkey Kong's head
5802   1882 21 24 6A            ld      hl,DK_STARS_SPRITE_X
5803   1885 36 7F               ld      (hl),127					; X coordinate
5804   1887 2C                  inc     l
5805   1888 36 39               ld      (hl),$39					; Sprite numbet
5806   188A 2C                  inc     l
5807   188B 36 01               ld      (hl),$01					; Palette
5808   188D 2C                  inc     l
5809   188E 36 D8               ld      (hl),216					; Y coordinate
5810   1890                     
5811   1890                     ; Clear Pauline's platform and redraw it lower down
5812   1890 21 C6 76            ld      hl,TILE_COORD(22,6)
5813   1893 CD 17 18            call    L_CLEAR_AROUND_GAME_OVER
5814   1896 11 D1 39            ld      de,L_RIVETS_DATA_FALL_TOP
5815   1899 CD A4 0D            call    L_DISPLAY_STAGE
5816   189C                     
5817   189C                     ; Reposition Pauline
5818   189C 11 04 00            ld      de,4						; 4 byte sprite struct
5819   189F 01 28 02            ld      bc,TWO_BYTES(2,40)			; 2 sprites, 40 pixels
5820   18A2 21 03 69            ld      hl,PAULINE_UPPER_SPRITE_Y
5821   18A5 CD 3D 00            call    L_MOVE_N_SPRITES
5822   18A8                     
5823   18A8                     ; Set the climbing counter to 256 (0) 
5824   18A8                     ; (used in the animation)
5825   18A8 3E 00               ld      a,0
5826   18AA 32 AF 62            ld      (DK_CLIMBING_COUNTER),a
5827   18AD                     
5828   18AD                     ; Trigger the stomp sound
5829   18AD 3E 03               ld      a,3
5830   18AF 32 82 60            ld      (STOMP_SOUND_TRIGGER),a
5831   18B2                     
5832   18B2                     ; Advance to the next animation state
5833   18B2 21 88 63            ld      hl,WIN_ANIMATION_STATE
5834   18B5 34                  inc     (hl)
5835   18B6 C9                  ret     
5836   18B7             ;------------------------------------------------------------------------------
5837   18B7             
5838   18B7                     
5839   18B7             
5840   18B7             ;------------------------------------------------------------------------------
5841   18B7             L_RIVETS_WIN_STAGE_ANIM_4:  
5842   18B7             		; If the climbing counter has reached 0, jump ahead
5843   18B7 21 AF 62    		ld      hl,DK_CLIMBING_COUNTER
5844   18BA 35                  dec     (hl)
5845   18BB CA 2E 19            jp      z,l193d
5846   18BE                     
5847   18BE                     ; Return if the 3 lowest bits are not 0
5848   18BE 7E                  ld      a,(hl)
5849   18BF E6 07               and     %00000111
5850   18C1 C0                  ret     nz
5851   18C2                     
5852   18C2                     ; Flip the star sprite horizontally
5853   18C2 21 25 6A            ld      hl,DK_STARS_SPRITE_NUM
5854   18C5 7E                  ld      a,(hl)
5855   18C6 EE 80               xor     %10000000
5856   18C8 77                  ld      (hl),a
5857   18C9                     
5858   18C9                     ; Convert Donkey Kong's head sprite into the number 0 - 2
5859   18C9 21 19 69    		ld      hl,DK_SPRITE_5_NUM
5860   18CC 46                  ld      b,(hl)
5861   18CD CB A8               res     5,b
5862   18CF                     
5863   18CF             		; The following function essentially advances a from 0 to 1, 1 to 2, and 2 to 0
5864   18CF             		; in an extraordinarily complicated way 
5865   18CF AF          		xor     a							; a = 0
5866   18D0 CD 8C 2F            call    l3009
5867   18D3             		
5868   18D3             		; Convert a (0-2) to Donkey Kong's stunned head sprite ($20-$22)
5869   18D3 F6 20               or      %00100000
5870   18D5 77                  ld      (hl),a
5871   18D6             		
5872   18D6             		; If the animation counter has not reached 224
5873   18D6             		; jump ahead to trigger the level end song
5874   18D6 21 AF 62            ld      hl,DK_CLIMBING_COUNTER
5875   18D9 7E                  ld      a,(hl)
5876   18DA FE E0               cp      224
5877   18DC C2 01 19            jp      nz,l1910
5878   18DF             		
5879   18DF             		; If Mario was on the right side of the screen,
5880   18DF             		; then display Mario to Pauline's right
5881   18DF 3E 50               ld      a,80
5882   18E1 32 4F 69            ld      (MARIO_SPRITE_Y),a
5883   18E4 3E 00               ld      a,0
5884   18E6 32 4D 69            ld      (MARIO_SPRITE_NUM),a
5885   18E9 3E 9F               ld      a,159
5886   18EB 32 4C 69            ld      (MARIO_SPRITE_X),a
5887   18EE 3A 03 62            ld      a,(MARIO_X)
5888   18F1 FE 80               cp      128
5889   18F3 D2 00 19            jp      nc,l190f
5890   18F6             		
5891   18F6             		; Mario was on the left side of the screen,
5892   18F6             		; display Mario to Pauline's left
5893   18F6 3E 80               ld      a,$80
5894   18F8 32 4D 69            ld      (MARIO_SPRITE_NUM),a
5895   18FB 3E 5F               ld      a,$5f
5896   18FD 32 4C 69            ld      (MARIO_SPRITE_X),a
5897   1900             		
5898   1900             		; Return if the animation counter has not reached 192
5899   1900 7E          l190f:  ld      a,(hl)
5900   1901 FE C0       l1910:  cp      192
5901   1903 C0                  ret     nz
5902   1904             		
5903   1904             		; If the current level is odd, trigger the first level end tune
5904   1904 21 8A 60            ld      hl,PENDING_SONG_TRIGGER
5905   1907 36 0C               ld      (hl),SONG_TRIGGER_LEVEL_END_1
5906   1909 3A 29 62            ld      a,(CP_LEVEL_NUMBER)
5907   190C 0F                  rrca    
5908   190D 38 02               jr      c,l1920
5909   190F             		
5910   190F             		; The current level is even, trigger the second level end tune
5911   190F 36 05               ld      (hl),SONG_TRIGGER_LEVEL_END_2
5912   1911             		
5913   1911 23          l1920:  inc     hl
5914   1912 36 03               ld      (hl),3
5915   1914             		
5916   1914             		; If Mario was on the Pauline's right, 
5917   1914             		; then display the heart sprite to Pauline's right
5918   1914 21 23 6A            ld      hl,HEART_SPRITE_Y
5919   1917 36 40               ld      (hl),64
5920   1919 2B                  dec     hl
5921   191A 36 09               ld      (hl),9						; Palette
5922   191C 2B                  dec     hl
5923   191D 36 76               ld      (hl),$76					; Sprite number
5924   191F 2B                  dec     hl
5925   1920 36 8F               ld      (hl),143					; Y coordinate
5926   1922 3A 03 62            ld      a,(MARIO_X)
5927   1925 FE 80               cp      128
5928   1927 D0                  ret     nc
5929   1928             
5930   1928             		; Else if Mario was on Pauline's left,
5931   1928             		; then display the heart sprite to Pauline's left
5932   1928 3E 6F               ld      a,111
5933   192A 32 20 6A            ld      (HEART_SPRITE_X),a
5934   192D C9                  ret     
5935   192E             		
5936   192E             		; Advance to the start of the next level's stage order list
5937   192E 2A 2A 62    l193d:  ld      hl,(CP_STAGE_ORDER_POINTER)
5938   1931 23                  inc     hl
5939   1932             		
5940   1932             		; If the stage order pointer does not need to be wrapped,
5941   1932             		; jump ahead
5942   1932 7E                  ld      a,(hl)
5943   1933 FE 7F               cp      $7f
5944   1935 C2 3C 19            jp      nz,l194b
5945   1938             		
5946   1938             		; Point the stage order pointer to the level 5 stage order
5947   1938 21 E5 39            ld      hl,L_STAGE_ORDER_TABLE_LAST
5948   193B 7E                  ld      a,(hl)
5949   193C 22 2A 62    l194b:  ld      (CP_STAGE_ORDER_POINTER),hl
5950   193F             
5951   193F             		; Set the current stage to the first stage in the new level
5952   193F 32 27 62            ld      (CURRENT_STAGE),a
5953   1942             		
5954   1942             		; Advance the level number
5955   1942 21 29 62            ld      hl,CP_LEVEL_NUMBER
5956   1945 34                  inc     (hl)
5957   1946             		
5958   1946             		; Display the timer and add the value to the player's score
5959   1946 11 00 05            ld      de,$0500
5960   1949 CD 22 30            call    L_ADD_EVENT
5961   194C             		
5962   194C             		; Reset the height index
5963   194C AF                  xor     a							; a = 0
5964   194D 32 2E 62            ld      (CP_HEIGHT_INDEX),a
5965   1950             		
5966   1950             		; Reset the animation state
5967   1950 32 88 63            ld      (WIN_ANIMATION_STATE),a
5968   1953             		
5969   1953             		; Set the minor timer to 
5970   1953 21 09 60            ld      hl,MINOR_TIMER
5971   1956 36 E0               ld      (hl),224
5972   1958             		
5973   1958             		; Set the game substate to 8
5974   1958 23                  inc     hl
5975   1959 36 08               ld      (hl),8
5976   195B C9                  ret     
5977   195C             ;------------------------------------------------------------------------------
5978   195C             
5979   195C             
5980   195C             
5981   195C             ;------------------------------------------------------------------------------
5982   195C             ; Clear the screen (everything) and move on to the next player
5983   195C             L_PREP_FOR_NEXT_PLAYER:  
5984   195C CD 51 08    		call    L_CLEAR_SCREEN_AND_SPRITES
5985   195F 3A 0E 60            ld      a,(SECOND_PLAYER)
5986   1962 C6 12               add     a,18
5987   1964 32 0A 60            ld      (GAME_SUBSTATE),a
5988   1967 C9                  ret     
5989   1968             ;------------------------------------------------------------------------------
5990   1968             
5991   1968             
5992   1968             
5993   1968             ;------------------------------------------------------------------------------
5994   1968             ; This function runs the game, optionally simulating the player's input
5995   1968             L_RUN_GAME_DEMO:  
5996   1968 CD D0 21    		call    L_SIMULATE_DEMO_INPUT
5997   196B             
5998   196B             L_RUN_GAME:  
5999   196B CD A7 1D    		call    L_IMPLEMENT_POINT_AWARD
6000   196E CD 71 1E            call    L_CHECK_FOR_SMASH_ANIM
6001   1971 CD B1 1A            call    l1ac3
6002   1974 CD 57 1F            call    l1f72
6003   1977 CD 12 2C            call    l2c8f
6004   197A CD 86 2B            call    l2c03
6005   197D CD 70 30            call    L_IMPLEMENT_FIREBALLS
6006   1980 CD 87 2D            call    L_IMPLEMENT_SPRINGS
6007   1983 CD BE 24            call    l24ea
6008   1986 CD 5E 2D            call    L_RANDOMLY_RELEASE_FIREBALL
6009   1989 CD 57 2E            call    L_ANIMATE_HAMMER_CYCLE
6010   198C CD E9 21            call    L_IMPLEMENT_RET_LADDERS
6011   198F CD 21 1A            call    l1a33
6012   1992 CD 13 2A            call    l2a85
6013   1995 CD 2B 1F            call    l1f46
6014   1998 CD A1 26            call    L_IMPLEMENT_ELEVATORS
6015   199B CD C6 25            call    L_IMPLEMENT_CONVEYERS
6016   199E CD C8 19            call    L_CHECK_IF_PRIZE_REACHED
6017   19A1 CD FB 03            call    L_ANIMATE_DK_AND_PAULINE
6018   19A4 CD 9D 27            call    L_CHECK_FOR_ENEMY_COLLISION
6019   19A7 CD B2 27            call    L_CHECK_FOR_HAMMER_KILL
6020   19AA CD 3C 1E            call    L_CHECK_FOR_WIN_CONDITIONS
6021   19AD CD F5 19            call    l1a07
6022   19B0 CD 4E 2F            call    l2fcb
6023   19B3                     
6024   19B3                     ; Return if Mario is still alive
6025   19B3 3A 00 62            ld      a,(MARIO_ALIVE)
6026   19B6 A7                  and     a
6027   19B7 C0                  ret     nz
6028   19B8             		
6029   19B8             		; Play the stomping sound
6030   19B8 CD 1C 01            call    L_SOUNDS_OFF
6031   19BB 21 82 60            ld      hl,STOMP_SOUND_TRIGGER
6032   19BE 36 03               ld      (hl),3
6033   19C0             		
6034   19C0             		; Advance to the next game substate
6035   19C0 21 0A 60    l19d2:  ld      hl,GAME_SUBSTATE
6036   19C3 34                  inc     (hl)
6037   19C4             		
6038   19C4             		; Set the minor timer to 64
6039   19C4 2B                  dec     hl							; MINOR_TIMER
6040   19C5 36 40               ld      (hl),64	
6041   19C7 C9                  ret     
6042   19C8             ;------------------------------------------------------------------------------
6043   19C8             
6044   19C8             
6045   19C8             
6046   19C8             ;------------------------------------------------------------------------------
6047   19C8             ; This function checks if Mario is on top of a prize sprite
6048   19C8             ; If so, it triggers the point award system
6049   19C8             L_CHECK_IF_PRIZE_REACHED:  
6050   19C8             		; Check each prize sprite to see if Mario has reached it
6051   19C8 3A 03 62    		ld      a,(MARIO_X)
6052   19CB 06 03               ld      b,3							; For b = 3 to 1 (3 prize sprites)
6053   19CD             
6054   19CD             		; If Mario's x coordinate matches this prize sprite's x coordinate
6055   19CD             		; jump ahead
6056   19CD 21 0C 6A            ld      hl,PRIZE_SPRITES
6057   19D0 BE          l19e2:  cp      (hl)
6058   19D1 CA DB 19            jp      z,l19ed
6059   19D4             		
6060   19D4             		; Examine the next prize sprite
6061   19D4 2C                  inc     l
6062   19D5 2C                  inc     l
6063   19D6 2C                  inc     l
6064   19D7 2C                  inc     l
6065   19D8 10 F6               djnz    l19e2
6066   19DA             		
6067   19DA             		; Return if there are no more prize sprites
6068   19DA C9                  ret     
6069   19DB             
6070   19DB             		; Return if Mario's y coordinate does not match the prize sprite's
6071   19DB             		; y coordinate
6072   19DB 3A 05 62    l19ed:  ld      a,(MARIO_Y)
6073   19DE 2C                  inc     l
6074   19DF 2C                  inc     l
6075   19E0 2C                  inc     l							; x coordinate
6076   19E1 BE                  cp      (hl)
6077   19E2 C0                  ret     nz
6078   19E3             
6079   19E3             		; Return if this prize sprite has already been awarded
6080   19E3             		; (The sprite number is one of the point award sprites)
6081   19E3 2D                  dec     l
6082   19E4 2D                  dec     l							; sprite number
6083   19E5 CB 5E               bit     3,(hl)
6084   19E7 C0                  ret     nz
6085   19E8             		
6086   19E8             		; Record this sprite address as the point award sprite address
6087   19E8 2D                  dec     l							; start of the sprite data
6088   19E9 22 43 63            ld      (SMASHED_SPRITE_POINTER),hl
6089   19EC             		
6090   19EC AF                  xor     a							; 0
6091   19ED 32 42 63            ld      (POINT_AWARD_TYPE),a
6092   19F0             		
6093   19F0 3C                  inc     a							; 1
6094   19F1 32 40 63            ld      (POINT_AWARD_STATE),a
6095   19F4 C9                  ret     
6096   19F5             ;------------------------------------------------------------------------------
6097   19F5             
6098   19F5             
6099   19F5             
6100   19F5             ;------------------------------------------------------------------------------
6101   19F5             l1a07:  
6102   19F5 3A 86 63    		ld      a,($6386)
6103   19F8 EF                  rst     $28							; Jump to local table address
6104   19F9             		; Jump table
6105   19F9 0C 1A       		.word 	l1a1e	; 0 = 
6106   19FB 03 1A       		.word	l1a15	; 1 = 
6107   19FD 0D 1A       		.word	l1a1f	; 2 = 
6108   19FF 18 1A       		.word	l1a2a	; 3 = 
6109   1A01 00 00       		.word	L_ORG	; 4 = reset game
6110   1A03             ;------------------------------------------------------------------------------
6111   1A03             
6112   1A03             
6113   1A03                     
6114   1A03             ;------------------------------------------------------------------------------
6115   1A03             l1a15:	
6116   1A03 AF          		xor     a
6117   1A04 32 87 63            ld      ($6387),a
6118   1A07 3E 02               ld      a,$02
6119   1A09 32 86 63            ld      ($6386),a
6120   1A0C C9          l1a1e:  ret     
6121   1A0D             ;------------------------------------------------------------------------------
6122   1A0D                     
6123   1A0D             
6124   1A0D             
6125   1A0D             ;------------------------------------------------------------------------------
6126   1A0D             l1a1f:	
6127   1A0D 21 87 63    		ld      hl,$6387
6128   1A10 35                  dec     (hl)
6129   1A11 C0                  ret     nz
6130   1A12                     
6131   1A12 3E 03       		ld      a,$03
6132   1A14 32 86 63            ld      ($6386),a
6133   1A17 C9                  ret     
6134   1A18             ;------------------------------------------------------------------------------
6135   1A18                     
6136   1A18             
6137   1A18             
6138   1A18             ;------------------------------------------------------------------------------
6139   1A18             l1a2a:	
6140   1A18 3A 16 62    		ld      a,(MARIO_IS_JUMPING)
6141   1A1B A7                  and     a
6142   1A1C C0                  ret     nz
6143   1A1D             		
6144   1A1D E1                  pop     hl
6145   1A1E C3 C0 19            jp      l19d2
6146   1A21 3E 08       l1a33:  ld      a,$08
6147   1A23 F7                  rst     $30							; Return unless this is the rivets stage
6148   1A24 3A 03 62            ld      a,(MARIO_X)
6149   1A27 FE 4B               cp      $4b
6150   1A29 CA 39 1A            jp      z,l1a4b
6151   1A2C FE B3               cp      $b3
6152   1A2E CA 39 1A            jp      z,l1a4b
6153   1A31 3A 91 62            ld      a,($6291)
6154   1A34 3D                  dec     a
6155   1A35 CA 3F 1A            jp      z,l1a51
6156   1A38 C9                  ret     
6157   1A39             
6158   1A39 3E 01       l1a4b:  ld      a,$01
6159   1A3B 32 91 62            ld      ($6291),a
6160   1A3E C9                  ret     
6161   1A3F             
6162   1A3F 32 91 62    l1a51:  ld      ($6291),a
6163   1A42 47                  ld      b,a
6164   1A43 3A 05 62            ld      a,(MARIO_Y)
6165   1A46 3D                  dec     a
6166   1A47 FE D0               cp      $d0
6167   1A49 D0                  ret     nc
6168   1A4A             		
6169   1A4A 07                  rlca    
6170   1A4B D2 50 1A            jp      nc,l1a62
6171   1A4E CB D0               set     2,b
6172   1A50 07          l1a62:  rlca    
6173   1A51 07                  rlca    
6174   1A52 D2 57 1A            jp      nc,l1a69
6175   1A55 CB C8               set     1,b
6176   1A57 E6 07       l1a69:  and     $07
6177   1A59 FE 06               cp      $06
6178   1A5B C2 60 1A            jp      nz,l1a72
6179   1A5E CB C8               set     1,b
6180   1A60 3A 03 62    l1a72:  ld      a,(MARIO_X)
6181   1A63 07                  rlca    
6182   1A64 D2 69 1A            jp      nc,l1a7b
6183   1A67 CB C0               set     0,b
6184   1A69 21 92 62    l1a7b:  ld      hl,$6292
6185   1A6C 78                  ld      a,b
6186   1A6D 85                  add     a,l
6187   1A6E 6F                  ld      l,a
6188   1A6F 7E                  ld      a,(hl)
6189   1A70 A7                  and     a
6190   1A71 C8                  ret     z
6191   1A72 36 00               ld      (hl),$00
6192   1A74 21 90 62            ld      hl,REMAINING_RIVETS
6193   1A77 35                  dec     (hl)
6194   1A78 78                  ld      a,b
6195   1A79 01 05 00            ld      bc,$0005
6196   1A7C 1F                  rra     
6197   1A7D DA AB 1A            jp      c,l1abd
6198   1A80 21 CB 02            ld      hl,$02cb
6199   1A83 A7          l1a95:  and     a
6200   1A84 CA 8C 1A            jp      z,l1a9e
6201   1A87 09          l1a99:  add     hl,bc
6202   1A88 3D                  dec     a
6203   1A89 C2 87 1A            jp      nz,l1a99
6204   1A8C 01 00 74    l1a9e:  ld      bc,TILE_COORD(0,0)
6205   1A8F 09                  add     hl,bc
6206   1A90 3E 10               ld      a,$10
6207   1A92 77                  ld      (hl),a
6208   1A93 2D                  dec     l
6209   1A94 77                  ld      (hl),a
6210   1A95 2C                  inc     l
6211   1A96 2C                  inc     l
6212   1A97 77                  ld      (hl),a
6213   1A98 3E 01               ld      a,1
6214   1A9A 32 40 63            ld      (POINT_AWARD_STATE),a
6215   1A9D 32 42 63            ld      (POINT_AWARD_TYPE),a
6216   1AA0 32 25 62            ld      ($6225),a
6217   1AA3 3A 16 62            ld      a,(MARIO_IS_JUMPING)
6218   1AA6 A7                  and     a
6219   1AA7 CC 7F 1D            call    z,l1d95
6220   1AAA C9                  ret     
6221   1AAB             		
6222   1AAB 21 2B 01    l1abd:  ld      hl,$012b
6223   1AAE C3 83 1A            jp      l1a95
6224   1AB1             ;------------------------------------------------------------------------------
6225   1AB1             
6226   1AB1             		
6227   1AB1             
6228   1AB1             ;------------------------------------------------------------------------------
6229   1AB1             l1ac3:  
6230   1AB1             		; If Mario is still in a jump, 
6231   1AB1             		; jump ahead
6232   1AB1 3A 16 62    		ld      a,(MARIO_IS_JUMPING)
6233   1AB4 3D                  dec     a
6234   1AB5 CA 9D 1B            jp      z,l1bb2
6235   1AB8                     
6236   1AB8                     ; If the hammer cycle delay is active, jump ahead to handle it
6237   1AB8 3A 1E 62            ld      a,(MARIO_HAMMER_CYCLE_DELAY)
6238   1ABB A7                  and     a
6239   1ABC C2 40 1B            jp      nz,l1b55
6240   1ABF                     
6241   1ABF                     ; If the hammer cycle is active, jump ahead
6242   1ABF 3A 17 62            ld      a,(HAMMER_CYCLE_ACTIVE)
6243   1AC2 3D                  dec     a
6244   1AC3 CA D4 1A            jp      z,l1ae6
6245   1AC6                     
6246   1AC6                     ; If Mario is climbing, jump ahead
6247   1AC6 3A 15 62            ld      a,(MARIO_IS_CLIMBING)
6248   1AC9 3D                  dec     a
6249   1ACA CA 23 1B            jp      z,l1b38
6250   1ACD                     
6251   1ACD                     ; If the jump button is pressed, jump ahead
6252   1ACD 3A 10 60            ld      a,(PLAYER_INPUT)
6253   1AD0 17                  rla     
6254   1AD1 DA 59 1B            jp      c,l1b6e
6255   1AD4                     
6256   1AD4                     ; d will be 1 if Mario can't move left
6257   1AD4                     ; e will be 1 if Mario can't move right
6258   1AD4 CD 04 24    l1ae6:  call    L_IMPLEMENT_BARRIERS
6259   1AD7                     
6260   1AD7                     ; If Mario is blocked to the right, 
6261   1AD7                     ; jump ahead to ignore the joystick right input  
6262   1AD7 3A 10 60            ld      a,(PLAYER_INPUT)
6263   1ADA 1D                  dec     e
6264   1ADB CA E3 1A            jp      z,l1af5
6265   1ADE                     
6266   1ADE                     ; If the joystick is pressed to the right, jump ahead to process it
6267   1ADE CB 47               bit     0,a						; right input
6268   1AE0 C2 79 1C            jp      nz,l1c8f
6269   1AE3                     
6270   1AE3                     ; If Mario is blocked to the left, 
6271   1AE3                     ; jump ahead to ignore the joystick left input  
6272   1AE3 15          l1af5:  dec     d
6273   1AE4 CA EC 1A            jp      z,l1afe
6274   1AE7                     
6275   1AE7                     ; If the joystick is pressed to the left, jump ahead to process it
6276   1AE7 CB 4F               bit     1,a
6277   1AE9 C2 95 1C            jp      nz,l1cab
6278   1AEC                     
6279   1AEC                     ; If the hammer cycle is active (can't climb ladders), 
6280   1AEC             		; then return
6281   1AEC 3A 17 62    l1afe:  ld      a,(HAMMER_CYCLE_ACTIVE)
6282   1AEF 3D                  dec     a
6283   1AF0 C8          		ret     z
6284   1AF1             		
6285   1AF1             		; Add 8 pixels to Mario's y coordinate to where his feet are
6286   1AF1 3A 05 62            ld      a,(MARIO_Y)
6287   1AF4 C6 08               add     a,8
6288   1AF6 57                  ld      d,a
6289   1AF7                     
6290   1AF7                     ; Fudge Mario's x coordinate a bit to make it easier to get 
6291   1AF7             		; on a ladder
6292   1AF7 3A 03 62            ld      a,(MARIO_X)
6293   1AFA F6 03               or      %00000011
6294   1AFC CB 97               res     2,a
6295   1AFE                     
6296   1AFE                     ; Check if Mario is on a ladder
6297   1AFE                     ; a will be 0 if at the bottom, 1 if at the top
6298   1AFE                     ; This function will be aborted if no ladder
6299   1AFE CD 50 23            call    L_CHECK_IF_ON_LADDER
6300   1B01                     
6301   1B01                     ; Set Mario's sprite to $06, flipped horizontally 
6302   1B01                     ; to match the current sprite number
6303   1B01 F5                  push    af
6304   1B02 21 07 62            ld      hl,MARIO_DATA_SPRITE_NUM
6305   1B05 7E                  ld      a,(hl)
6306   1B06 E6 80               and     %10000000
6307   1B08 F6 06               or      %00000110
6308   1B0A 77                  ld      (hl),a
6309   1B0B                     
6310   1B0B                     ; If Mario is standing over a normal ladder,
6311   1B0B                     ; set $621a to 1
6312   1B0B 21 1A 62            ld      hl,$621a
6313   1B0E 3E 04               ld      a,4
6314   1B10 B9                  cp      c
6315   1B11 36 01               ld      (hl),1
6316   1B13 D2 17 1B            jp      nc,l1b2c
6317   1B16                     
6318   1B16                     ; If Mario is standing over a broken ladder,
6319   1B16                     ; set $621a to 0
6320   1B16 35                  dec     (hl)
6321   1B17                     
6322   1B17                     ; If Mario is at the bottom of a ladder,
6323   1B17                     ; jump ahead
6324   1B17 F1          l1b2c:  pop     af
6325   1B18 A7                  and     a
6326   1B19 CA 39 1B            jp      z,l1b4e
6327   1B1C                     
6328   1B1C                     ; Mario is at the top of a ladder
6329   1B1C                     ; If this is a normal ladder, return
6330   1B1C 7E                  ld      a,(hl)
6331   1B1D A7                  and     a
6332   1B1E C0                  ret     nz
6333   1B1F                     
6334   1B1F                     ; Save the coordinate of the top of the ladder
6335   1B1F 2C                  inc     l						; TOP_OF_CURRENT_LADDER
6336   1B20 72                  ld      (hl),d
6337   1B21                     
6338   1B21                     ; Save the coordinate of the bottom of the ladder
6339   1B21 2C                  inc     l						; BOT_OF_CURRENT_LADDER
6340   1B22 70                  ld      (hl),b
6341   1B23                     
6342   1B23                     ; If the joystick is being pressed down, jump ahead
6343   1B23 3A 10 60    l1b38:  ld      a,(PLAYER_INPUT)
6344   1B26 CB 5F               bit     3,a
6345   1B28 C2 DC 1C            jp      nz,l1cf2
6346   1B2B                     
6347   1B2B                     ; Return if Mario is not climbing a ladder
6348   1B2B 3A 15 62            ld      a,(MARIO_IS_CLIMBING)
6349   1B2E A7                  and     a
6350   1B2F C8                  ret     z
6351   1B30             		
6352   1B30             		; If the joystick is being pressed up, jump ahead
6353   1B30 3A 10 60    l1b45:  ld      a,(PLAYER_INPUT)
6354   1B33 CB 57               bit     2,a
6355   1B35 C2 ED 1C            jp      nz,l1d03
6356   1B38 C9                  ret     
6357   1B39             		
6358   1B39             		; Mario is at the bottom of a ladder
6359   1B39 2C          l1b4e:  inc     l							; TOP_OF_CURRENT_LADDER
6360   1B3A 70                  ld      (hl),b
6361   1B3B 2C                  inc     l							; BOT_OF_CURRENT_LADDER
6362   1B3C 72                  ld      (hl),d
6363   1B3D C3 30 1B            jp      l1b45
6364   1B40                     
6365   1B40             		; Decrement the hammer cycle delay and return if it hasn't
6366   1B40             		; reached 0
6367   1B40 21 1E 62    l1b55:  ld      hl,MARIO_HAMMER_CYCLE_DELAY
6368   1B43 35                  dec     (hl)
6369   1B44 C0                  ret     nz
6370   1B45             		
6371   1B45             		; Activate the hammer cycle
6372   1B45 3A 18 62            ld      a,(HAMMER_GRABBED)
6373   1B48 32 17 62            ld      (HAMMER_CYCLE_ACTIVE),a
6374   1B4B             		
6375   1B4B             		; Face Mario's sprite in the correct direction
6376   1B4B 21 07 62            ld      hl,MARIO_DATA_SPRITE_NUM
6377   1B4E 7E                  ld      a,(hl)
6378   1B4F E6 80               and     $80
6379   1B51 77                  ld      (hl),a
6380   1B52 AF                  xor     a
6381   1B53 32 02 62            ld      ($6202),a
6382   1B56                     
6383   1B56                     ; Jump ahead to update Mario's coordinate and sprite data
6384   1B56                     ; and return
6385   1B56 C3 90 1D            jp      l1da6
6386   1B59                     
6387   1B59                     ; Jump button is pressed
6388   1B59             		
6389   1B59             		; Flag Mario as jumping
6390   1B59 3E 01       l1b6e:  ld      a,1
6391   1B5B 32 16 62            ld      (MARIO_IS_JUMPING),a
6392   1B5E             		
6393   1B5E             		; If the joystick is pressed right, 
6394   1B5E             		; set MARIO_JUMPING_LEFT to $00 
6395   1B5E             		; and MARIO_JUMPING_RIGHT to $80
6396   1B5E 21 10 62            ld      hl,MARIO_JUMPING_LEFT
6397   1B61 3A 10 60            ld      a,(PLAYER_INPUT)
6398   1B64 01 80 00            ld      bc,$0080
6399   1B67 1F                  rra     
6400   1B68 DA 75 1B            jp      c,l1b8a
6401   1B6B             		; If the joystick is pressed left
6402   1B6B             		; set MARIO_JUMPING_LEFT to $ff 
6403   1B6B             		; and MARIO_JUMPING_RIGHT to $80
6404   1B6B 01 80 FF            ld      bc,$ff80
6405   1B6E 1F                  rra     
6406   1B6F DA 75 1B            jp      c,l1b8a
6407   1B72             		; If the joystick is centered
6408   1B72             		; set MARIO_JUMPING_LEFT to $00 
6409   1B72             		; and MARIO_JUMPING_RIGHT to $00
6410   1B72 01 00 00            ld      bc,$0000
6411   1B75 AF          l1b8a:  xor     a
6412   1B76 70                  ld      (hl),b
6413   1B77 2C                  inc     l							; MARIO_JUMPING_RIGHT
6414   1B78 71                  ld      (hl),c
6415   1B79             		
6416   1B79 2C                  inc     l							; $6212
6417   1B7A 36 01               ld      (hl),$01
6418   1B7C 2C                  inc     l							; $6213
6419   1B7D 36 48               ld      (hl),$48
6420   1B7F 2C                  inc     l							; $6214
6421   1B80 77                  ld      (hl),a
6422   1B81 32 04 62            ld      ($6204),a
6423   1B84 32 06 62            ld      ($6206),a
6424   1B87                     
6425   1B87             		; Change Mario's sprite to him jumping, flipped to the correct direction
6426   1B87 3A 07 62    		ld      a,(MARIO_DATA_SPRITE_NUM)
6427   1B8A E6 80               and     %10000000
6428   1B8C F6 0E               or      $0e							; Jumping sprite
6429   1B8E 32 07 62            ld      (MARIO_DATA_SPRITE_NUM),a
6430   1B91             		
6431   1B91             		; Save the y coordinate of the start of the jump
6432   1B91 3A 05 62            ld      a,(MARIO_Y)
6433   1B94 32 0E 62            ld      (MARIO_JUMP_Y_COORD),a
6434   1B97             		
6435   1B97             		; Trigger the jumping sound
6436   1B97 21 81 60            ld      hl,JUMP_SOUND_TRIGGER
6437   1B9A 36 03               ld      (hl),3
6438   1B9C C9                  ret    
6439   1B9D             		
6440   1B9D             		; Mario is jumping
6441   1B9D             		
6442   1B9D DD 21 00 62 l1bb2:  ld      ix,MARIO_DATA_STRUCT
6443   1BA1 3A 03 62            ld      a,(MARIO_X)
6444   1BA4 DD 77 0B            ld      (ix+11),a
6445   1BA7 3A 05 62            ld      a,(MARIO_Y)
6446   1BAA DD 77 0C            ld      (ix+12),a
6447   1BAD                     
6448   1BAD CD 81 23            call    l239c
6449   1BB0                     
6450   1BB0             		; Check for barriers
6451   1BB0 CD 04 24            call    L_IMPLEMENT_BARRIERS
6452   1BB3                     
6453   1BB3                     ; If Mario can move left, jump ahead
6454   1BB3 15                  dec     d
6455   1BB4 C2 DD 1B            jp      nz,l1bf2
6456   1BB7                     
6457   1BB7             		; Mario is blocked to the left
6458   1BB7             		; Force Mario to bounce to the right
6459   1BB7 DD 36 10 00         ld      (ix+16),0					; MARIO_JUMPING_LEFT
6460   1BBB DD 36 11 80         ld      (ix+17),$80					; MARIO_JUMPING_RIGHT
6461   1BBF DD CB 07 FE         set     7,(ix+7)					; Sprite number
6462   1BC3                     
6463   1BC3 3A 20 62    l1bd8:  ld      a,($6220)
6464   1BC6 3D                  dec     a
6465   1BC7 CA D7 1B            jp      z,l1bec
6466   1BCA                     
6467   1BCA CD EC 23            call    l2407
6468   1BCD                     
6469   1BCD DD 74 12            ld      (ix+18),h
6470   1BD0 DD 75 13            ld      (ix+19),l
6471   1BD3 DD 36 14 00         ld      (ix+20),0
6472   1BD7                     
6473   1BD7 CD 81 23    l1bec:  call    l239c
6474   1BDA C3 F0 1B            jp      l1c05
6475   1BDD                     
6476   1BDD                     ; If Mario can move right, jump ahead
6477   1BDD 1D          l1bf2:  dec     e
6478   1BDE C2 F0 1B            jp      nz,l1c05
6479   1BE1                     
6480   1BE1             		; Mario is blocked to the right
6481   1BE1             		; Force Mario to bounce to the left
6482   1BE1 DD 36 10 FF         ld      (ix+16),$FF					; MARIO_JUMPING_LEFT
6483   1BE5 DD 36 11 80         ld      (ix+17),$80					; MARIO_JUMPING_RIGHT
6484   1BE9 DD CB 07 BE         res     7,(ix+7)					; Mario's sprite number
6485   1BED C3 C3 1B            jp      l1bd8
6486   1BF0                     
6487   1BF0                     
6488   1BF0 CD 9F 2A    l1c05:  call    l2b1c
6489   1BF3 3D                  dec     a
6490   1BF4 CA 24 1C            jp      z,l1c3a
6491   1BF7 3A 1F 62            ld      a,($621f)
6492   1BFA 3D                  dec     a
6493   1BFB CA 60 1C            jp      z,l1c76
6494   1BFE 3A 14 62            ld      a,($6214)
6495   1C01 D6 14               sub     $14
6496   1C03 C2 1D 1C            jp      nz,l1c33
6497   1C06 3E 01               ld      a,$01
6498   1C08 32 1F 62            ld      ($621f),a
6499   1C0B CD E8 27            call    L_CHECK_FOR_ENEMY_JUMP
6500   1C0E A7                  and     a
6501   1C0F                     
6502   1C0F                     ; If an enemy has not been jumped,
6503   1C0F             		; jump ahead to update Mario's coordinate and sprite data
6504   1C0F                     ; and return
6505   1C0F CA 90 1D            jp      z,l1da6
6506   1C12                     
6507   1C12             		; Initiate a point reward for jumping an enemy
6508   1C12 32 42 63            ld      (POINT_AWARD_TYPE),a
6509   1C15 3E 01               ld      a,1
6510   1C17 32 40 63            ld      (POINT_AWARD_STATE),a
6511   1C1A 32 25 62            ld      ($6225),a
6512   1C1D             		
6513   1C1D 3C          l1c33:  inc     a
6514   1C1E CC E4 28            call    z,L_IMPLEMENT_HAMMER_GRAB
6515   1C21                     
6516   1C21                     ; Jump ahead to update Mario's coordinate and sprite data
6517   1C21                     ; and return
6518   1C21 C3 90 1D            jp      l1da6
6519   1C24                     
6520   1C24 05          l1c3a:  dec     b
6521   1C25 CA 39 1C            jp      z,l1c4f
6522   1C28 3C                  inc     a
6523   1C29 32 1F 62            ld      ($621f),a
6524   1C2C AF                  xor     a
6525   1C2D 21 10 62            ld      hl,MARIO_JUMPING_LEFT
6526   1C30 06 05               ld      b,$05
6527   1C32 77          l1c48:  ld      (hl),a
6528   1C33 2C                  inc     l
6529   1C34 10 FC               djnz    l1c48
6530   1C36                     
6531   1C36                     ; Jump ahead to update Mario's coordinate and sprite data
6532   1C36                     ; and return
6533   1C36 C3 90 1D            jp      l1da6
6534   1C39                     
6535   1C39 32 16 62    l1c4f:  ld      (MARIO_IS_JUMPING),a
6536   1C3C 3A 20 62            ld      a,($6220)
6537   1C3F EE 01               xor     1
6538   1C41 32 00 62            ld      (MARIO_ALIVE),a
6539   1C44 21 07 62            ld      hl,MARIO_DATA_SPRITE_NUM
6540   1C47 7E                  ld      a,(hl)
6541   1C48 E6 80               and     $80
6542   1C4A F6 0F               or      $0f
6543   1C4C 77                  ld      (hl),a
6544   1C4D 3E 04               ld      a,$04
6545   1C4F 32 1E 62            ld      (MARIO_HAMMER_CYCLE_DELAY),a
6546   1C52 AF                  xor     a
6547   1C53 32 1F 62            ld      ($621f),a
6548   1C56 3A 25 62            ld      a,($6225)
6549   1C59 3D                  dec     a
6550   1C5A CC 7F 1D            call    z,l1d95
6551   1C5D                     
6552   1C5D                     ; Jump ahead to update Mario's coordinate and sprite data
6553   1C5D                     ; and return
6554   1C5D C3 90 1D            jp      l1da6
6555   1C60                     
6556   1C60 3A 05 62    l1c76:  ld      a,(MARIO_Y)
6557   1C63 21 0E 62            ld      hl,MARIO_JUMP_Y_COORD
6558   1C66 D6 0F               sub     $0f
6559   1C68 BE                  cp      (hl)
6560   1C69                     
6561   1C69                     ; Jump ahead to update Mario's coordinate and sprite data
6562   1C69                     ; and return
6563   1C69 DA 90 1D            jp      c,l1da6
6564   1C6C                     
6565   1C6C 3E 01               ld      a,$01
6566   1C6E 32 20 62            ld      ($6220),a
6567   1C71 21 84 60            ld      hl,FALL_SOUND_TRIGGER
6568   1C74 36 03               ld      (hl),$03
6569   1C76                     
6570   1C76                     ; Jump ahead to update Mario's coordinate and sprite data
6571   1C76                     ; and return
6572   1C76 C3 90 1D            jp      l1da6
6573   1C79                     
6574   1C79 06 01       l1c8f:  ld      b,1
6575   1C7B 3A 0F 62            ld      a,($620f)
6576   1C7E A7                  and     a
6577   1C7F C2 BC 1C            jp      nz,l1cd2
6578   1C82 3A 02 62            ld      a,($6202)
6579   1C85 47                  ld      b,a
6580   1C86 3E 05               ld      a,5
6581   1C88 CD 8C 2F            call    l3009
6582   1C8B 32 02 62            ld      ($6202),a
6583   1C8E E6 03               and     $03
6584   1C90 F6 80               or      $80
6585   1C92 C3 AC 1C            jp      l1cc2
6586   1C95 06 FF       l1cab:  ld      b,$ff
6587   1C97 3A 0F 62            ld      a,($620f)
6588   1C9A A7                  and     a
6589   1C9B C2 BC 1C            jp      nz,l1cd2
6590   1C9E 3A 02 62            ld      a,($6202)
6591   1CA1 47                  ld      b,a
6592   1CA2 3E 01               ld      a,1
6593   1CA4 CD 8C 2F            call    l3009
6594   1CA7 32 02 62            ld      ($6202),a
6595   1CAA E6 03               and     $03
6596   1CAC 21 07 62    l1cc2:  ld      hl,MARIO_DATA_SPRITE_NUM
6597   1CAF 77                  ld      (hl),a
6598   1CB0 1F                  rra     
6599   1CB1 DC 79 1D            call    c,l1d8f
6600   1CB4 3E 02               ld      a,$02
6601   1CB6 32 0F 62            ld      ($620f),a
6602   1CB9                     
6603   1CB9                     ; Jump ahead to update Mario's coordinate and sprite data
6604   1CB9                     ; and return
6605   1CB9 C3 90 1D            jp      l1da6
6606   1CBC                     
6607   1CBC 21 03 62    l1cd2:  ld      hl,MARIO_X
6608   1CBF 7E                  ld      a,(hl)
6609   1CC0 80                  add     a,b
6610   1CC1 77                  ld      (hl),a
6611   1CC2 3A 27 62            ld      a,(CURRENT_STAGE)
6612   1CC5 3D                  dec     a
6613   1CC6 C2 D5 1C            jp      nz,l1ceb
6614   1CC9 66                  ld      h,(hl)
6615   1CCA 3A 05 62            ld      a,(MARIO_Y)
6616   1CCD 6F                  ld      l,a
6617   1CCE CD 15 23            call    L_MOVE_SPRITE_ALONG_PLAT
6618   1CD1 7D                  ld      a,l
6619   1CD2 32 05 62            ld      (MARIO_Y),a
6620   1CD5 21 0F 62    l1ceb:  ld      hl,$620f
6621   1CD8 35                  dec     (hl)
6622   1CD9                     
6623   1CD9                     ; Jump ahead to update Mario's coordinate and sprite data
6624   1CD9                     ; and return
6625   1CD9 C3 90 1D            jp      l1da6
6626   1CDC                     
6627   1CDC                     ; If $620f is not 0, jump ahead
6628   1CDC 3A 0F 62    l1cf2:  ld      a,($620f)
6629   1CDF A7                  and     a
6630   1CE0 C2 74 1D            jp      nz,l1d8a
6631   1CE3                     
6632   1CE3                     ; Reset $620f to 3
6633   1CE3 3E 03               ld      a,3
6634   1CE5 32 0F 62            ld      ($620f),a
6635   1CE8                     
6636   1CE8                     ; Jump ahead to move Mario Mario down 2 pixels
6637   1CE8 3E 02               ld      a,2
6638   1CEA C3 FB 1C            jp      l1d11
6639   1CED                     
6640   1CED 3A 0F 62    l1d03:  ld      a,($620f)
6641   1CF0 A7                  and     a
6642   1CF1 C2 60 1D            jp      nz,l1d76
6643   1CF4 3E 04               ld      a,$04
6644   1CF6 32 0F 62            ld      ($620f),a
6645   1CF9 3E FE               ld      a,-2
6646   1CFB                     
6647   1CFB                     ; Move Mario up or down the ladder
6648   1CFB 21 05 62    l1d11:  ld      hl,MARIO_Y
6649   1CFE 86                  add     a,(hl)
6650   1CFF 77                  ld      (hl),a
6651   1D00                     
6652   1D00 47                  ld      b,a
6653   1D01 3A 22 62            ld      a,($6222)
6654   1D04 EE 01               xor     %00000001
6655   1D06 32 22 62            ld      ($6222),a
6656   1D09                     
6657   1D09 C2 3B 1D            jp      nz,l1d51
6658   1D0C                     
6659   1D0C                     ; If Mario (Mario's y coordinate + 8) has reached the bottom of the ladder,
6660   1D0C                     ; jump ahead
6661   1D0C 78                  ld      a,b
6662   1D0D C6 08               add     a,8
6663   1D0F 21 1C 62            ld      hl,BOT_OF_CURRENT_LADDER
6664   1D12 BE                  cp      (hl)
6665   1D13 CA 51 1D            jp      z,l1d67
6666   1D16                     
6667   1D16                     ; If Mario (Mario's y coordinate + 8) has reached the top of the ladder,
6668   1D16                     ; jump ahead
6669   1D16 2D                  dec     l						; TOP_OF_CURRENT_LADDER
6670   1D17 96                  sub     (hl)
6671   1D18 CA 51 1D            jp      z,l1d67
6672   1D1B                     
6673   1D1B                     ; Determine what Mario sprite to use
6674   1D1B                     ; If Mario is still near the top of the ladder, 
6675   1D1B                     ; one of the "just starting to climb down the ladder"
6676   1D1B                     ; sprites is used; otherwise the "climbing the ladder"
6677   1D1B                     ; sprite is used
6678   1D1B 06 05               ld      b,$05
6679   1D1D D6 08               sub     8
6680   1D1F CA 29 1D            jp      z,l1d3f
6681   1D22 05                  dec     b	; $04
6682   1D23 D6 04               sub     4
6683   1D25 CA 29 1D            jp      z,l1d3f
6684   1D28 05                  dec     b	; $03
6685   1D29                     
6686   1D29                     ; Set Mario's sprite number flipped horizontally to match the 
6687   1D29                     ; current sprite's orientation
6688   1D29 3E 80       l1d3f:  ld      a,%10000000
6689   1D2B 21 07 62            ld      hl,MARIO_DATA_SPRITE_NUM
6690   1D2E A6                  and     (hl)
6691   1D2F EE 80               xor     $80
6692   1D31 B0                  or      b
6693   1D32 77                  ld      (hl),a
6694   1D33                     
6695   1D33                     ; Flag Mario as climbing a ladder
6696   1D33 3E 01       l1d49:  ld      a,1
6697   1D35 32 15 62            ld      (MARIO_IS_CLIMBING),a
6698   1D38                     
6699   1D38                     ; Jump ahead to update Mario's coordinate and sprite data
6700   1D38                     ; and return
6701   1D38 C3 90 1D            jp      l1da6
6702   1D3B                     
6703   1D3B 2D          l1d51:  dec     l
6704   1D3C 2D                  dec     l
6705   1D3D 7E                  ld      a,(hl)
6706   1D3E F6 03               or      $03
6707   1D40 CB 97               res     2,a
6708   1D42 77                  ld      (hl),a
6709   1D43 3A 24 62            ld      a,($6224)
6710   1D46 EE 01               xor     $01
6711   1D48 32 24 62            ld      ($6224),a
6712   1D4B CC 79 1D            call    z,l1d8f
6713   1D4E C3 33 1D            jp      l1d49
6714   1D51 3E 06       l1d67:  ld      a,$06
6715   1D53 32 07 62            ld      (MARIO_DATA_SPRITE_NUM),a
6716   1D56 AF                  xor     a
6717   1D57 32 19 62            ld      ($6219),a
6718   1D5A 32 15 62            ld      (MARIO_IS_CLIMBING),a
6719   1D5D                     
6720   1D5D                     ; Jump ahead to update Mario's coordinate and sprite data
6721   1D5D                     ; and return
6722   1D5D C3 90 1D            jp      l1da6
6723   1D60                     
6724   1D60 3A 1A 62    l1d76:  ld      a,($621a)
6725   1D63 A7                  and     a
6726   1D64 CA 74 1D            jp      z,l1d8a
6727   1D67 32 19 62            ld      ($6219),a
6728   1D6A 3A 1C 62            ld      a,(BOT_OF_CURRENT_LADDER)
6729   1D6D D6 13               sub     $13
6730   1D6F 21 05 62            ld      hl,MARIO_Y
6731   1D72 BE                  cp      (hl)
6732   1D73 D0                  ret     nc
6733   1D74             		
6734   1D74 21 0F 62    l1d8a:  ld      hl,$620f
6735   1D77 35                  dec     (hl)
6736   1D78 C9                  ret     
6737   1D79             		
6738   1D79 3E 03       l1d8f:  ld      a,$03
6739   1D7B 32 80 60            ld      (WALK_SOUND_TRIGGER),a
6740   1D7E C9                  ret     
6741   1D7F             
6742   1D7F 32 25 62    l1d95:  ld      ($6225),a
6743   1D82 3A 27 62            ld      a,(CURRENT_STAGE)
6744   1D85 3D                  dec     a
6745   1D86 C8                  ret     z
6746   1D87             		
6747   1D87 21 8A 60            ld      hl,PENDING_SONG_TRIGGER
6748   1D8A 36 0D               ld      (hl),SONG_TRIGGER_RIVET_REMOVED
6749   1D8C 2C                  inc     l
6750   1D8D 36 03               ld      (hl),3
6751   1D8F C9                  ret     
6752   1D90             		
6753   1D90             		; Update Mario's x coordinate
6754   1D90 21 4C 69    l1da6:  ld      hl,MARIO_SPRITE_X
6755   1D93 3A 03 62            ld      a,(MARIO_X)
6756   1D96 77                  ld      (hl),a
6757   1D97                     
6758   1D97                     ; Update Mario's sprite number
6759   1D97 3A 07 62            ld      a,(MARIO_DATA_SPRITE_NUM)
6760   1D9A 2C                  inc     l						; MARIO_SPRITE_NUM
6761   1D9B 77                  ld      (hl),a
6762   1D9C                     
6763   1D9C                     ; Update Mario's palette
6764   1D9C 3A 08 62            ld      a,(MARIO_DATA_PALETTE)
6765   1D9F 2C                  inc     l						; MARIO_SPRITE_PAL
6766   1DA0 77                  ld      (hl),a
6767   1DA1                     
6768   1DA1                     ; Update Mario's y coordinate
6769   1DA1 3A 05 62            ld      a,(MARIO_Y)
6770   1DA4 2C                  inc     l						; MARIO_SPRITE_Y
6771   1DA5 77                  ld      (hl),a
6772   1DA6 C9                  ret   
6773   1DA7             ;------------------------------------------------------------------------------
6774   1DA7             
6775   1DA7             
6776   1DA7             	
6777   1DA7             ;------------------------------------------------------------------------------
6778   1DA7             ; Implement the awarding of points to the player.
6779   1DA7             L_IMPLEMENT_POINT_AWARD:  
6780   1DA7 3A 40 63    		ld      a,(POINT_AWARD_STATE)
6781   1DAA EF                  rst     $28							; Jump to local table address
6782   1DAB             		; Jump table
6783   1DAB 2E 1E       		.word	L_NO_POINTS_TO_DISPLAY	; 0 = no points to award
6784   1DAD B3 1D       		.word	L_GIVE_POINT_AWARD	; 1 = award points
6785   1DAF 2F 1E       		.word	L_DISPLAY_POINT_AWARD_SPRITE	; 2 = display points until timeout
6786   1DB1 00 00       		.word	L_ORG	; 3 = reset game
6787   1DB3             ;------------------------------------------------------------------------------
6788   1DB3             
6789   1DB3             
6790   1DB3             
6791   1DB3             ;------------------------------------------------------------------------------
6792   1DB3             ; Determine how many points should be awarded to the player and
6793   1DB3             ; award them and display the award sprite
6794   1DB3             L_GIVE_POINT_AWARD:  
6795   1DB3             		; Initialize the point award display timer
6796   1DB3 3E 40       		ld      a,64
6797   1DB5 32 41 63            ld      (POINT_AWARD_DISPLAY_TIMER),a
6798   1DB8             		
6799   1DB8             		; Advance the point award state (display points)
6800   1DB8 3E 02               ld      a,2
6801   1DBA 32 40 63            ld      (POINT_AWARD_STATE),a
6802   1DBD             		
6803   1DBD             		; If the point award type is 1, 
6804   1DBD             		; jump ahead
6805   1DBD 3A 42 63            ld      a,(POINT_AWARD_TYPE)
6806   1DC0 1F                  rra    
6807   1DC1 DA E2 3D            jp      c,DETERMINE_POINT_AWARD_AMT
6808   1DC4             		
6809   1DC4             		; If the point award type is 2, 
6810   1DC4             		; jump ahead to award 300 points
6811   1DC4 1F                  rra     
6812   1DC5 DA EA 1D            jp      c,l1e00
6813   1DC8             		
6814   1DC8             		; If the point award type is 4, 
6815   1DC8             		; jump ahead to award random points
6816   1DC8 1F                  rra     
6817   1DC9 DA DF 1D            jp      c,l1df5
6818   1DCC             		
6819   1DCC             		
6820   1DCC             		; The point award type is 0
6821   1DCC             		
6822   1DCC             		; Trigger the award sound
6823   1DCC 21 85 60            ld      hl,AWARD_SOUND_TRIGGER
6824   1DCF 36 03               ld      (hl),3
6825   1DD1             		
6826   1DD1             		; If the level number is 1, 
6827   1DD1             		; award 300 points
6828   1DD1 3A 29 62            ld      a,(CP_LEVEL_NUMBER)
6829   1DD4 3D                  dec     a
6830   1DD5 CA EA 1D            jp      z,l1e00
6831   1DD8             		
6832   1DD8             		; If the level number is 2,
6833   1DD8             		; Award 500 points
6834   1DD8 3D                  dec     a
6835   1DD9 CA F2 1D            jp      z,l1e08
6836   1DDC             		
6837   1DDC             		; Jump ahead to award 800 points
6838   1DDC C3 FA 1D            jp      l1e10
6839   1DDF             		
6840   1DDF             		
6841   1DDF             		
6842   1DDF             		; Randomly award 300, 500, or 800 points
6843   1DDF 3A 18 60    l1df5:  ld      a,(RANDOM_NUMBER)
6844   1DE2 1F                  rra     
6845   1DE3 DA F2 1D            jp      c,l1e08						; Award 500 points
6846   1DE6 1F                  rra     
6847   1DE7 DA FA 1D            jp      c,l1e10						; Award 800 points
6848   1DEA             		
6849   1DEA             		
6850   1DEA             		
6851   1DEA             		; Award 300 points
6852   1DEA 06 7D       l1e00:  ld      b,$7d
6853   1DEC 11 03 00            ld      de,$0003					; Award 300 points
6854   1DEF C3 FF 1D            jp      l1e15
6855   1DF2             		
6856   1DF2             		
6857   1DF2             		
6858   1DF2             		; Award 500 points
6859   1DF2 06 7E       l1e08:  ld      b,$7e
6860   1DF4 11 05 00            ld      de,$0005					; Award 500 points
6861   1DF7 C3 FF 1D            jp      l1e15
6862   1DFA             		
6863   1DFA             		
6864   1DFA             		
6865   1DFA             		; Award 800 points
6866   1DFA 06 7F       l1e10:  ld      b,$7f
6867   1DFC 11 08 00            ld      de,$0008					; Award 800 points
6868   1DFF             		
6869   1DFF             		
6870   1DFF             		
6871   1DFF             		; Award the points
6872   1DFF CD 22 30    l1e15:  call    L_ADD_EVENT
6873   1E02             
6874   1E02             		; Get the x and y coordinate of the smashed sprite
6875   1E02 2A 43 63            ld      hl,(SMASHED_SPRITE_POINTER)
6876   1E05 7E                  ld      a,(hl)						; X coordinate
6877   1E06 36 00               ld      (hl),0						; Hide the sprite
6878   1E08 2C                  inc     l
6879   1E09 2C                  inc     l
6880   1E0A 2C                  inc     l
6881   1E0B 4E                  ld      c,(hl)						; Y coordinate
6882   1E0C             		
6883   1E0C C3 1B 1E            jp      l1e36
6884   1E0F                     
6885   1E0F             		; Award the points
6886   1E0F CD 22 30    l1e28:  call    L_ADD_EVENT
6887   1E12             
6888   1E12             		; Get Mario's x and y coordinates (+20 pixels down)
6889   1E12 3A 05 62            ld      a,(MARIO_Y)
6890   1E15 C6 14               add     a,20
6891   1E17 4F                  ld      c,a
6892   1E18 3A 03 62            ld      a,(MARIO_X)
6893   1E1B             		
6894   1E1B             		; At this point:
6895   1E1B             		; 	a = x coordinate of award sprite
6896   1E1B             		;	b = award sprite image
6897   1E1B             		;	c = y coordinate of award sprite
6898   1E1B             		
6899   1E1B             		; Initialize the award sprite
6900   1E1B 21 30 6A    l1e36:  ld      hl,AWARD_SPRITE
6901   1E1E 77                  ld      (hl),a						; X coordinate
6902   1E1F 2C                  inc     l
6903   1E20 70                  ld      (hl),b						; Sprite image
6904   1E21 2C                  inc     l
6905   1E22 36 07               ld      (hl),7						; Sprite palette
6906   1E24 2C                  inc     l
6907   1E25 71                  ld      (hl),c						; Y coordinate
6908   1E26             		
6909   1E26                     ; Return unless this is the barrels stage or elevator stage
6910   1E26 3E 05       		ld      a,%00000101
6911   1E28 F7                  rst     $30							
6912   1E29             		
6913   1E29             		; Trigger the award sound
6914   1E29 21 85 60            ld      hl,AWARD_SOUND_TRIGGER
6915   1E2C 36 03               ld      (hl),3
6916   1E2E             		
6917   1E2E             		; Return
6918   1E2E             L_NO_POINTS_TO_DISPLAY:  
6919   1E2E C9          		ret     
6920   1E2F             ;------------------------------------------------------------------------------
6921   1E2F             
6922   1E2F             
6923   1E2F             ;------------------------------------------------------------------------------
6924   1E2F             ; This function continues to display the point award sprite until
6925   1E2F             ; the display timer runs down
6926   1E2F             L_DISPLAY_POINT_AWARD_SPRITE:  
6927   1E2F             		; If the point display timer has not reached 0,
6928   1E2F             		; return
6929   1E2F 21 41 63    		ld      hl,POINT_AWARD_DISPLAY_TIMER
6930   1E32 35                  dec     (hl)
6931   1E33 C0                  ret     nz
6932   1E34             		
6933   1E34             		; Remove the sprite
6934   1E34 AF                  xor     a
6935   1E35 32 30 6A            ld      (AWARD_SPRITE_X),a
6936   1E38             		
6937   1E38             		; Reset the point award state
6938   1E38 32 40 63            ld      (POINT_AWARD_STATE),a
6939   1E3B C9                  ret     
6940   1E3C             ;------------------------------------------------------------------------------
6941   1E3C             
6942   1E3C             
6943   1E3C             
6944   1E3C             ;------------------------------------------------------------------------------
6945   1E3C             ; Check if the current stage win conditions have been met
6946   1E3C             L_CHECK_FOR_WIN_CONDITIONS:
6947   1E3C 3A 27 62    		ld      a,(CURRENT_STAGE)
6948   1E3F CB 57               bit     2,a
6949   1E41 C2 65 1E            jp      nz,l1e80					; Jump ahead if this is the rivets stage
6950   1E44 1F                  rra     
6951   1E45 3A 05 62            ld      a,(MARIO_Y)
6952   1E48 DA 5F 1E            jp      c,l1e7a						; Jump ahead if this is the barrels stage or elevators stage
6953   1E4B             		
6954   1E4B             		; Processing for mixer stage
6955   1E4B             		; Check if Mario has reached the top conveyer
6956   1E4B FE 51               cp      81
6957   1E4D D0                  ret     nc							; Return if Mario y coordinate is below the top platform
6958   1E4E             		
6959   1E4E             		; Face Mario left if he is on the right side of the screen
6960   1E4E 3A 03 62            ld      a,(MARIO_X)
6961   1E51 17                  rla     
6962   1E52 3E 00       l1e6d:  ld      a,0	
6963   1E54 DA 59 1E            jp      c,l1e74						
6964   1E57             		
6965   1E57             		; Face Mario right if he is on the left side of the screen
6966   1E57 3E 80               ld      a,$80
6967   1E59             		
6968   1E59 32 4D 69    l1e74:  ld      (MARIO_SPRITE_NUM),a
6969   1E5C C3 6A 1E            jp      l1e85
6970   1E5F             		
6971   1E5F             		; Processing for barrels stage and elevators stage
6972   1E5F             		; Check if Mario has reached Pauline's platform
6973   1E5F FE 31       l1e7a:  cp      49
6974   1E61 D0                  ret     nc
6975   1E62 C3 52 1E            jp      l1e6d						; Face Mario right (towards Pauline)
6976   1E65             		
6977   1E65             		; Processing for rivets stage
6978   1E65             		; Check if all rivets have been removed
6979   1E65 3A 90 62    l1e80:  ld      a,(REMAINING_RIVETS)
6980   1E68 A7                  and     a
6981   1E69 C0                  ret     nz							; Return if there are still rivets to be removed
6982   1E6A             		
6983   1E6A 3E 16       l1e85:  ld      a,22
6984   1E6C 32 0A 60            ld      (GAME_SUBSTATE),a
6985   1E6F E1                  pop     hl
6986   1E70 C9                  ret     
6987   1E71             ;------------------------------------------------------------------------------
6988   1E71             
6989   1E71             
6990   1E71             
6991   1E71             ;------------------------------------------------------------------------------
6992   1E71             ; Check if the smash animation is running.  If it is, implement it and abort
6993   1E71             ; any other game processing.
6994   1E71             L_CHECK_FOR_SMASH_ANIM:  
6995   1E71             		; Return if a smash animation is not active
6996   1E71 3A 50 63    		ld      a,(SMASH_ANIMATION_ACTIVE)
6997   1E74 A7                  and     a
6998   1E75 C8                  ret     z
6999   1E76                     
7000   1E76                     ; Return 
7001   1E76 CD 7B 1E            call    L_IMPLEMENT_SMASH_ANIM
7002   1E79                     
7003   1E79                     ; Return from the calling function
7004   1E79 E1                  pop     hl
7005   1E7A C9                  ret     
7006   1E7B             ;------------------------------------------------------------------------------
7007   1E7B             
7008   1E7B             
7009   1E7B             
7010   1E7B             ;------------------------------------------------------------------------------
7011   1E7B             ; Implement the smash animation
7012   1E7B             L_IMPLEMENT_SMASH_ANIM:  
7013   1E7B 3A 45 63    		ld      a,(SMASH_ANIMATION_STATE)
7014   1E7E EF                  rst     $28							; Jump to local table address
7015   1E7F             		; Jump table
7016   1E7F 85 1E       		.word	L_INIT_SMASH_ANIM	; 0 = smash animation 0
7017   1E81 EE 1E       		.word	L_SMASH_ANIM_PHASE_1	; 1 = smash animation 1
7018   1E83 08 1F       		.word	L_COMPLETE_SMASH_ANIM	; 2 = smash animation 2
7019   1E85             ;------------------------------------------------------------------------------
7020   1E85             
7021   1E85             
7022   1E85             
7023   1E85             ;------------------------------------------------------------------------------
7024   1E85             ; This function initializes the smash animation
7025   1E85             L_INIT_SMASH_ANIM:  
7026   1E85             		; If the lower byte of the smash enemy class pointer
7027   1E85             		; == $65, set hl to point to the pie sprites
7028   1E85 3A 52 63    		ld      a,(SMASH_ENEMY_CLASS_POINTER+1)
7029   1E88 FE 65               cp      $65
7030   1E8A 21 B8 69            ld      hl,PIE_SPRITES
7031   1E8D CA 99 1E            jp      z,l1eb4
7032   1E90                     
7033   1E90                     ; If the lower byte of the smash enemy class pointer
7034   1E90             		; == $65, set hl to point to the fireball sprites 
7035   1E90 21 D0 69            ld      hl,FIREBALL_SPRITES
7036   1E93 DA 99 1E            jp      c,l1eb4
7037   1E96                     
7038   1E96                     ; If the lower byte of the smash enemy class pointer
7039   1E96             		; == $65, set hl to point to the spring sprites
7040   1E96 21 80 69            ld      hl,SPRING_SPRITES
7041   1E99                     
7042   1E99                     ; Prepare to locate the smashed sprite
7043   1E99 DD 2A 51 63 l1eb4:  ld      ix,(SMASH_ENEMY_CLASS_POINTER)
7044   1E9D 16 00               ld      d,0
7045   1E9F 3A 53 63            ld      a,(SMASH_ENEMY_DATA_SIZE)
7046   1EA2 5F                  ld      e,a							; de = size of the enemy data structure
7047   1EA3 01 04 00            ld      bc,4						; bc = size of sprite data
7048   1EA6             
7049   1EA6             		; If the enemy index is 0, nothing more needs to be done so
7050   1EA6             		; jump ahead
7051   1EA6 3A 54 63            ld      a,(SMASH_ANIMATION_ENEMY_INDEX)
7052   1EA9 A7                  and     a
7053   1EAA CA B4 1E            jp      z,l1ecf
7054   1EAD                     
7055   1EAD             		; Advance to the sprite and data structure of the enemy
7056   1EAD             		; that was smashed
7057   1EAD 09          l1ec8:  add     hl,bc
7058   1EAE DD 19               add     ix,de
7059   1EB0 3D                  dec     a
7060   1EB1 C2 AD 1E            jp      nz,l1ec8
7061   1EB4             
7062   1EB4             		; Mark the enemy data structure as inactive
7063   1EB4 DD 36 00 00 l1ecf:  ld      (ix+0),0					; Inactive
7064   1EB8             
7065   1EB8             		; If this is not a special sprite, 
7066   1EB8             		; award 300 points
7067   1EB8 DD 7E 15            ld      a,(ix+21)
7068   1EBB A7                  and     a
7069   1EBC 3E 02               ld      a,2
7070   1EBE CA C3 1E            jp      z,l1ede
7071   1EC1             		
7072   1EC1             		; If this is a special sprite,
7073   1EC1             		; randomly award 300, 500, or 800 points
7074   1EC1 3E 04               ld      a,4
7075   1EC3             		
7076   1EC3             		; Record the type of award
7077   1EC3 32 42 63    l1ede:  ld      (POINT_AWARD_TYPE),a
7078   1EC6             
7079   1EC6             		; Set the smash sprite's x coordinate to that of the
7080   1EC6             		; smashed enemy
7081   1EC6 01 2C 6A            ld      bc,SMASH_SPRITE
7082   1EC9 7E                  ld      a,(hl)
7083   1ECA 36 00               ld      (hl),0						; Hide the enemy sprite
7084   1ECC 02                  ld      (bc),a
7085   1ECD             		
7086   1ECD             		; Set the smash sprite's image to the first image in the
7087   1ECD             		; smash sprite animation
7088   1ECD 0C                  inc     c
7089   1ECE 2C                  inc     l
7090   1ECF 3E 60               ld      a,$60
7091   1ED1 02                  ld      (bc),a
7092   1ED2             		
7093   1ED2             		; Set the smash sprite's palette to 12
7094   1ED2 0C                  inc     c
7095   1ED3 2C                  inc     l
7096   1ED4 3E 0C               ld      a,12
7097   1ED6 02                  ld      (bc),a
7098   1ED7             		
7099   1ED7             		; Set the smash sprite's y coordinate to that of the
7100   1ED7             		; smashed enemy
7101   1ED7 0C                  inc     c
7102   1ED8 2C                  inc     l
7103   1ED9 7E                  ld      a,(hl)
7104   1EDA 02                  ld      (bc),a
7105   1EDB             
7106   1EDB             		; Advance the smash animation state
7107   1EDB 21 45 63            ld      hl,SMASH_ANIMATION_STATE
7108   1EDE 34                  inc     (hl)
7109   1EDF             		
7110   1EDF             		; Set the smash animation frame delay to 6
7111   1EDF 2C                  inc     l							; SMASH_ANIMATION_FRAME_DELAY
7112   1EE0 36 06               ld      (hl),6
7113   1EE2             
7114   1EE2             		; Set the smash animation cycle counter to 5
7115   1EE2 2C                  inc     l							; SMASH_ANIMATION_CYCLE_COUNTER
7116   1EE3 36 05               ld      (hl),5	
7117   1EE5             		
7118   1EE5             		; Trigger the hammet hit song
7119   1EE5 21 8A 60            ld      hl,PENDING_SONG_TRIGGER
7120   1EE8 36 06               ld      (hl),SONG_TRIGGER_HAMMER_HIT
7121   1EEA 2C                  inc     l
7122   1EEB 36 03               ld      (hl),3
7123   1EED             		
7124   1EED C9                  ret     
7125   1EEE             ;------------------------------------------------------------------------------
7126   1EEE             
7127   1EEE             
7128   1EEE             
7129   1EEE             ;------------------------------------------------------------------------------
7130   1EEE             ; This function displays the first phase of the smash animation by cycling 
7131   1EEE             ; between the first two images in the animation until the cycle counter
7132   1EEE             ; reaches 0
7133   1EEE             L_SMASH_ANIM_PHASE_1:  
7134   1EEE             		; If the smash animation frame delay has not reached 0, 
7135   1EEE             		; return
7136   1EEE 21 46 63    		ld      hl,SMASH_ANIMATION_FRAME_DELAY
7137   1EF1 35                  dec     (hl)
7138   1EF2 C0                  ret     nz
7139   1EF3             		
7140   1EF3             		; Reset the smash animation frame delay to 6
7141   1EF3 36 06               ld      (hl),6
7142   1EF5             		
7143   1EF5             		; If the smash animation cycle counter has reached 0,
7144   1EF5             		; jump ahead
7145   1EF5 2C                  inc     l
7146   1EF6 35                  dec     (hl)
7147   1EF7 CA 02 1F            jp      z,l1f1d
7148   1EFA             		
7149   1EFA             		; Cycle between the first two sprite images in the smash
7150   1EFA             		; animation
7151   1EFA 21 2D 6A            ld      hl,SMASH_SPRITE_NUM
7152   1EFD 7E                  ld      a,(hl)
7153   1EFE EE 01               xor     1
7154   1F00 77                  ld      (hl),a
7155   1F01 C9                  ret     
7156   1F02             		
7157   1F02             		; Reset the smash animation cycle counter
7158   1F02 36 04       l1f1d:  ld      (hl),4
7159   1F04             
7160   1F04             		; Advance the smash animation state
7161   1F04 2D                  dec     l
7162   1F05 2D                  dec     l
7163   1F06 34                  inc     (hl)
7164   1F07             		
7165   1F07 C9                  ret     
7166   1F08             ;------------------------------------------------------------------------------
7167   1F08             
7168   1F08             
7169   1F08             ;------------------------------------------------------------------------------
7170   1F08             ; This function completes the smash animation by advancing through the rest of 
7171   1F08             ; the images in the animation
7172   1F08             L_COMPLETE_SMASH_ANIM:  
7173   1F08             		; If the smah animation frame delay has not reached 0,
7174   1F08             		; return
7175   1F08 21 46 63    		ld      hl,SMASH_ANIMATION_FRAME_DELAY
7176   1F0B 35                  dec     (hl)
7177   1F0C C0                  ret     nz
7178   1F0D             		
7179   1F0D             		; Reset the frame delay to 12
7180   1F0D 36 0C               ld      (hl),12
7181   1F0F             		
7182   1F0F             		; If the smash animation cycle counter has reached 0,
7183   1F0F             		; jump ahead
7184   1F0F 2C                  inc     l							; SMASH_ANIMATION_CYCLE_COUNTER
7185   1F10 35                  dec     (hl)
7186   1F11 CA 19 1F            jp      z,l1f34
7187   1F14             		
7188   1F14             		; Advance to the next sprite in the animation 
7189   1F14 21 2D 6A            ld      hl,SMASH_SPRITE_NUM
7190   1F17 34                  inc     (hl)
7191   1F18 C9                  ret     
7192   1F19             		
7193   1F19             		; Reset the smash animation
7194   1F19 2D          l1f34:  dec     l
7195   1F1A 2D                  dec     l							; SMASH_ANIMATION_STATE
7196   1F1B AF                  xor     a
7197   1F1C 77                  ld      (hl),a
7198   1F1D 32 50 63            ld      (SMASH_ANIMATION_ACTIVE),a
7199   1F20 3C                  inc     a
7200   1F21 32 40 63            ld      (POINT_AWARD_STATE),a
7201   1F24 21 2C 6A            ld      hl,SMASH_SPRITE
7202   1F27 22 43 63            ld      (SMASHED_SPRITE_POINTER),hl
7203   1F2A C9                  ret     
7204   1F2B             ;------------------------------------------------------------------------------
7205   1F2B             
7206   1F2B             
7207   1F2B             ;------------------------------------------------------------------------------
7208   1F2B             l1f46:  
7209   1F2B             		; If Mario is not falling,
7210   1F2B             		; return
7211   1F2B 3A 21 62    		ld      a,(MARIO_IS_FALLING)
7212   1F2E A7                  and     a
7213   1F2F C8                  ret     z
7214   1F30             		
7215   1F30             		; 
7216   1F30 AF                  xor     a
7217   1F31 32 04 62            ld      ($6204),a
7218   1F34 32 06 62            ld      ($6206),a
7219   1F37 32 21 62            ld      (MARIO_IS_FALLING),a
7220   1F3A 32 10 62            ld      (MARIO_JUMPING_LEFT),a
7221   1F3D 32 11 62            ld      (MARIO_JUMPING_RIGHT),a
7222   1F40 32 12 62            ld      ($6212),a
7223   1F43 32 13 62            ld      ($6213),a
7224   1F46 32 14 62            ld      ($6214),a
7225   1F49             		
7226   1F49 3C                  inc     a
7227   1F4A 32 16 62            ld      (MARIO_IS_JUMPING),a
7228   1F4D 32 1F 62            ld      ($621f),a
7229   1F50 3A 05 62            ld      a,(MARIO_Y)
7230   1F53 32 0E 62            ld      (MARIO_JUMP_Y_COORD),a
7231   1F56 C9                  ret     
7232   1F57             ;------------------------------------------------------------------------------
7233   1F57             
7234   1F57             
7235   1F57             
7236   1F57             ;------------------------------------------------------------------------------
7237   1F57             l1f72:  
7238   1F57             		; Return unless this is the barrels stage
7239   1F57             		; Note: I can save 2 bytes by using rst $30
7240   1F57 3A 27 62    		ld      a,(CURRENT_STAGE)
7241   1F5A 3D                  dec     a
7242   1F5B C0                  ret     nz
7243   1F5C             		
7244   1F5C DD 21 00 67         ld      ix,BARREL_STRUCTS
7245   1F60 21 80 69            ld      hl,SPRING_SPRITES
7246   1F63 11 20 00            ld      de,32					; 32 byte data structure
7247   1F66 06 0A               ld      b,10					; For b = 10 to 1 (10 barrels)
7248   1F68             
7249   1F68             		; If the barrel is active, jump ahead
7250   1F68 DD 7E 00    l1f83:  ld      a,(ix+0)
7251   1F6B 3D                  dec     a
7252   1F6C CA 78 1F            jp      z,l1f93
7253   1F6F                     
7254   1F6F                     ; Advance to the next barrel
7255   1F6F                     ; Note: change this to add a,3
7256   1F6F 2C                  inc     l
7257   1F70 2C                  inc     l
7258   1F71 2C                  inc     l
7259   1F72             
7260   1F72             		; Process the next barrel
7261   1F72 2C          l1f8d:  inc     l
7262   1F73 DD 19               add     ix,de
7263   1F75 10 F1               djnz    l1f83					; Next b
7264   1F77 C9                  ret     
7265   1F78             
7266   1F78             		; If ??? has reached 0, jump ahead
7267   1F78 DD 7E 01    l1f93:  ld      a,(ix+1)
7268   1F7B 3D                  dec     a
7269   1F7C CA D1 20            jp      z,l20ec
7270   1F7F                     
7271   1F7F                     ; If bit 0 of ??? is 1, jump ahead
7272   1F7F DD 7E 02            ld      a,(ix+2)
7273   1F82 1F                  rra     
7274   1F83 DA 91 1F            jp      c,l1fac
7275   1F86                     
7276   1F86                     ; If bit 1 of ??? is 1, jump ahead
7277   1F86 1F                  rra     
7278   1F87 DA CA 1F            jp      c,l1fe5
7279   1F8A                     
7280   1F8A                     ; If bit 2 of ??? is 1, jump ahead
7281   1F8A 1F                  rra     
7282   1F8B DA D4 1F            jp      c,l1fef
7283   1F8E                     
7284   1F8E                     ; Jump ahead
7285   1F8E C3 38 20            jp      l2053
7286   1F91                     
7287   1F91                     ; Move the barrel down 1 pixel
7288   1F91 D9          l1fac:  exx     
7289   1F92 DD 34 05            inc     (ix+5)						; Y coordinate entry
7290   1F95                     
7291   1F95                     ; If the barrel y coordinate has not reached ???, jump ahead
7292   1F95 DD 7E 17            ld      a,(ix+23)
7293   1F98 DD BE 05            cp      (ix+5)						; Y coordinate
7294   1F9B C2 B3 1F            jp      nz,l1fce
7295   1F9E                     
7296   1F9E                     ; Advance the barrel rolling animation
7297   1F9E                     ; Select either the normal barrel graphics (barrel type == 0)
7298   1F9E             		; or the oil barrel graphics (barrel type == 1)
7299   1F9E DD 7E 15    		ld      a,(ix+21)					; Barrel type
7300   1FA1 07                  rlca    							
7301   1FA2 07                  rlca    
7302   1FA3 C6 15               add     a,$15						; The first normal barrel sprite image
7303   1FA5 DD 77 07            ld      (ix+7),a					; Sprite number entry
7304   1FA8                     
7305   1FA8 DD 7E 02            ld      a,(ix+2)
7306   1FAB EE 07               xor     %00000111
7307   1FAD DD 77 02            ld      (ix+2),a
7308   1FB0 C3 9C 21            jp      L_LD_SPRITE_DATA_TO_STRUCT_2
7309   1FB3                     
7310   1FB3                     
7311   1FB3                     ; If ??? has not reached 0, jump ahead
7312   1FB3 DD 7E 0F    l1fce:  ld      a,(ix+15)
7313   1FB6 3D                  dec     a
7314   1FB7 C2 C4 1F            jp      nz,l1fdf
7315   1FBA                     
7316   1FBA                     ; Toggle the barrel falling sprite
7317   1FBA                     ; (Between $16 and $17 or $1a and $1b)
7318   1FBA DD 7E 07            ld      a,(ix+7)					; Sprite number
7319   1FBD EE 01               xor     %00000001
7320   1FBF DD 77 07            ld      (ix+7),a
7321   1FC2                     
7322   1FC2                     ; Reset the ??? counter to 4
7323   1FC2 3E 04               ld      a,4
7324   1FC4                     
7325   1FC4                     ; Update the ??? counter
7326   1FC4 DD 77 0F    l1fdf:  ld      (ix+15),a
7327   1FC7 C3 9C 21            jp      L_LD_SPRITE_DATA_TO_STRUCT_2
7328   1FCA                     
7329   1FCA                     
7330   1FCA                     
7331   1FCA D9          l1fe5:  exx     
7332   1FCB 01 00 01            ld      bc,$0100
7333   1FCE                     
7334   1FCE                     ; Move the barrel right 1 pixel
7335   1FCE DD 34 03            inc     (ix+3)						; X coordinate entry
7336   1FD1 C3 DB 1F            jp      l1ff6
7337   1FD4                     
7338   1FD4                     
7339   1FD4 D9          l1fef:  exx     
7340   1FD5 01 04 FF            ld      bc,$ff04
7341   1FD8                     
7342   1FD8                     ; Move the barrel left 1 pixel
7343   1FD8 DD 35 03            dec     (ix+3)						; X coordinate entry
7344   1FDB                     
7345   1FDB DD 66 03    l1ff6:  ld      h,(ix+3)					; X coordinate entry
7346   1FDE DD 6E 05            ld      l,(ix+5)					; Y coordinate entry
7347   1FE1 7C                  ld      a,h
7348   1FE2 E6 07               and     %00000111
7349   1FE4 FE 03               cp      3
7350   1FE6 CA 44 21            jp      z,l215f
7351   1FE9                     
7352   1FE9                     ; Make the barrel follow the countours of the platforms
7353   1FE9 2D                  dec     l
7354   1FEA 2D                  dec     l
7355   1FEB 2D                  dec     l
7356   1FEC CD 15 23            call    L_MOVE_SPRITE_ALONG_PLAT
7357   1FEF 2C                  inc     l
7358   1FF0 2C                  inc     l
7359   1FF1 2C                  inc     l
7360   1FF2                     
7361   1FF2 7D                  ld      a,l
7362   1FF3 DD 77 05            ld      (ix+5),a
7363   1FF6                     
7364   1FF6 CD C3 23            call    l23de
7365   1FF9                     
7366   1FF9 CD 88 24            call    l24b4
7367   1FFC                     
7368   1FFC DD 7E 03            ld      a,(ix+3)
7369   1FFF FE 1C               cp      %00011100
7370   2001 DA 14 20            jp      c,l202f
7371   2004 FE E4               cp      $e4
7372   2006 DA 9C 21            jp      c,L_LD_SPRITE_DATA_TO_STRUCT_2
7373   2009 AF                  xor     a
7374   200A DD 77 10            ld      (ix+16),a
7375   200D DD 36 11 60         ld      (ix+17),$60
7376   2011 C3 1D 20            jp      l2038
7377   2014                     
7378   2014 AF          l202f:  xor     a
7379   2015 DD 36 10 FF         ld      (ix+16),$ff
7380   2019 DD 36 11 A0         ld      (ix+17),$a0
7381   201D DD 36 12 FF l2038:  ld      (ix+18),$ff
7382   2021 DD 36 13 F0         ld      (ix+19),$f0
7383   2025 DD 77 14            ld      (ix+20),a
7384   2028 DD 77 0E            ld      (ix+14),a
7385   202B DD 77 04            ld      (ix+4),a
7386   202E DD 77 06            ld      (ix+6),a
7387   2031 DD 36 02 08         ld      (ix+2),8
7388   2035 C3 9C 21            jp      L_LD_SPRITE_DATA_TO_STRUCT_2
7389   2038                     
7390   2038 D9          l2053:  exx     
7391   2039 CD 81 23            call    l239c
7392   203C CD BD 29            call    l2a2f
7393   203F A7                  and     a
7394   2040 C2 68 20            jp      nz,l2083
7395   2043 DD 7E 03            ld      a,(ix+3)
7396   2046 C6 08               add     a,8
7397   2048 FE 10               cp      $10
7398   204A DA 5E 20            jp      c,l2079
7399   204D CD 88 24            call    l24b4
7400   2050 DD 7E 10            ld      a,(ix+16)
7401   2053 E6 01               and     1
7402   2055 07                  rlca    
7403   2056 07                  rlca    
7404   2057 4F                  ld      c,a
7405   2058 CD C3 23            call    l23de
7406   205B C3 9C 21            jp      L_LD_SPRITE_DATA_TO_STRUCT_2
7407   205E AF          l2079:  xor     a
7408   205F DD 77 00            ld      (ix+0),a
7409   2062 DD 77 03            ld      (ix+3),a
7410   2065 C3 9C 21            jp      L_LD_SPRITE_DATA_TO_STRUCT_2
7411   2068 DD 34 0E    l2083:  inc     (ix+14)
7412   206B DD 7E 0E            ld      a,(ix+14)
7413   206E 3D                  dec     a
7414   206F CA 87 20            jp      z,l20a2
7415   2072 3D                  dec     a
7416   2073 CA A8 20            jp      z,l20c3
7417   2076 DD 7E 10            ld      a,(ix+16)
7418   2079 3D                  dec     a
7419   207A 3E 04               ld      a,4
7420   207C C2 81 20            jp      nz,l209c
7421   207F 3E 02               ld      a,2
7422   2081 DD 77 02    l209c:  ld      (ix+2),a
7423   2084 C3 9C 21            jp      L_LD_SPRITE_DATA_TO_STRUCT_2
7424   2087 DD 7E 15    l20a2:  ld      a,(ix+21)
7425   208A A7                  and     a
7426   208B C2 9A 20            jp      nz,l20b5
7427   208E 21 05 62            ld      hl,MARIO_Y
7428   2091 DD 7E 05            ld      a,(ix+5)
7429   2094 D6 16               sub     $16
7430   2096 BE                  cp      (hl)
7431   2097 D2 A8 20            jp      nc,l20c3
7432   209A DD 7E 10    l20b5:  ld      a,(ix+16)
7433   209D A7                  and     a
7434   209E C2 C6 20            jp      nz,l20e1
7435   20A1 DD 77 11            ld      (ix+17),a
7436   20A4 DD 36 10 FF         ld      (ix+16),$ff
7437   20A8 CD EC 23    l20c3:  call    l2407
7438   20AB CB 3C               srl     h
7439   20AD CB 1D               rr      l
7440   20AF CB 3C               srl     h
7441   20B1 CB 1D               rr      l
7442   20B3 DD 74 12            ld      (ix+18),h
7443   20B6 DD 75 13            ld      (ix+19),l
7444   20B9 AF                  xor     a
7445   20BA DD 77 14            ld      (ix+20),a
7446   20BD DD 77 04            ld      (ix+4),a
7447   20C0 DD 77 06            ld      (ix+6),a
7448   20C3 C3 9C 21            jp      L_LD_SPRITE_DATA_TO_STRUCT_2
7449   20C6 DD 36 10 01 l20e1:  ld      (ix+16),1
7450   20CA DD 36 11 00         ld      (ix+17),0
7451   20CE C3 A8 20            jp      l20c3
7452   20D1                     
7453   20D1 D9          l20ec:  exx     
7454   20D2 CD 81 23            call    l239c
7455   20D5 7C                  ld      a,h
7456   20D6 D6 1A               sub     $1a
7457   20D8 DD 46 19            ld      b,(ix+25)
7458   20DB B8                  cp      b
7459   20DC DA E9 20            jp      c,l2104
7460   20DF CD BD 29            call    l2a2f
7461   20E2 A7                  and     a
7462   20E3 C2 FD 20            jp      nz,l2118
7463   20E6 CD 88 24            call    l24b4
7464   20E9                     
7465   20E9                     ; If the x coordinate (+8) is > 16
7466   20E9                     ; jump back to animate the sprite
7467   20E9 DD 7E 03    l2104:  ld      a,(ix+3)
7468   20EC C6 08               add     a,8
7469   20EE FE 10               cp      16
7470   20F0 D2 B3 1F            jp      nc,l1fce
7471   20F3                     
7472   20F3                     ; The x coordinate is <= 16
7473   20F3                     ; Deactivate the sprite
7474   20F3 AF                  xor     a
7475   20F4 DD 77 00            ld      (ix+0),a
7476   20F7 DD 77 03            ld      (ix+3),a
7477   20FA                     
7478   20FA                     ; Update the sprite and process the next object
7479   20FA C3 9C 21            jp      L_LD_SPRITE_DATA_TO_STRUCT_2
7480   20FD                     
7481   20FD DD 7E 05    l2118:  ld      a,(ix+5)
7482   2100 FE E0               cp      $e0
7483   2102 DA 2B 21            jp      c,l2146
7484   2105 DD 7E 07            ld      a,(ix+7)
7485   2108 E6 FC               and     $fc
7486   210A F6 01               or      1
7487   210C DD 77 07            ld      (ix+7),a
7488   210F AF                  xor     a
7489   2110 DD 77 01            ld      (ix+1),a
7490   2113 DD 77 02            ld      (ix+2),a
7491   2116 DD 36 10 FF         ld      (ix+16),$ff
7492   211A DD 77 11            ld      (ix+17),a
7493   211D DD 77 12            ld      (ix+18),a
7494   2120 DD 36 13 B0         ld      (ix+19),$b0
7495   2124 DD 36 0E 01         ld      (ix+14),1
7496   2128 C3 38 21            jp      l2153
7497   212B CD EC 23    l2146:  call    l2407
7498   212E CD AD 22            call    l22cb
7499   2131 DD 7E 05            ld      a,(ix+5)
7500   2134 DD 77 19            ld      (ix+25),a
7501   2137 AF                  xor     a
7502   2138 DD 77 14    l2153:  ld      (ix+20),a
7503   213B DD 77 04            ld      (ix+4),a
7504   213E DD 77 06            ld      (ix+6),a
7505   2141 C3 9C 21    l215c:  jp      L_LD_SPRITE_DATA_TO_STRUCT_2
7506   2144 7D          l215f:  ld      a,l
7507   2145 C6 05       l2160:  add     a,5
7508   2147 57                  ld      d,a
7509   2148 7C                  ld      a,h
7510   2149 CD 4F 21            call    l216d
7511   214C C3 9C 21            jp      L_LD_SPRITE_DATA_TO_STRUCT_2
7512   214F             
7513   214F CD 50 23    l216d:  call    L_CHECK_IF_ON_LADDER
7514   2152 3D                  dec     a
7515   2153 C0                  ret     nz
7516   2154 78                  ld      a,b
7517   2155 D6 05               sub     5
7518   2157 DD 77 17            ld      (ix+23),a
7519   215A             		
7520   215A             		; If the barrel fire is not lit, then jump ahead
7521   215A             		; (barrel will always take ladders before the barrel is lit)
7522   215A 3A 48 63            ld      a,(BARREL_FIRE_STATUS)
7523   215D A7                  and     a
7524   215E CA 94 21            jp      z,l21b2
7525   2161             		
7526   2161             		; Return if the barrel is below or on the same level as Mario
7527   2161             		; (barrel will never take the ladder)
7528   2161 3A 05 62            ld      a,(MARIO_Y)
7529   2164 D6 04               sub     4
7530   2166 BA                  cp      d
7531   2167 D8                  ret     c
7532   2168             		
7533   2168             		; Convert the difficulty (1 to 5) to a modified difficulty number between 1 and 3
7534   2168 3A 80 63            ld      a,(CP_DIFFICULTY)
7535   216B 1F                  rra     
7536   216C 3C                  inc     a
7537   216D 47                  ld      b,a
7538   216E             		
7539   216E             		; Get a random number between 0 and 3
7540   216E 3A 18 60            ld      a,(RANDOM_NUMBER)
7541   2171 4F                  ld      c,a
7542   2172 E6 03               and     %00000011
7543   2174             		
7544   2174             		; If random number is greater than the modified difficulty number, then return
7545   2174             		; (barrel will not take the ladder)
7546   2174 B8                  cp      b
7547   2175 D0                  ret     nc
7548   2176             		
7549   2176             		; If Mario is directly below the barrel, then go down the ladder
7550   2176 21 10 60            ld      hl,PLAYER_INPUT
7551   2179 3A 03 62            ld      a,(MARIO_X)
7552   217C BB                  cp      e
7553   217D CA 94 21            jp      z,l21b2
7554   2180             	
7555   2180             		; If the barrel is to the right of Mario, check if Mario is moving left
7556   2180 D2 8B 21            jp      nc,l21a9
7557   2183             		
7558   2183             		; If Mario is not moving right, then skip ahead
7559   2183 CB 46               bit     0,(hl)
7560   2185 CA 90 21            jp      z,l21ae
7561   2188             		
7562   2188             		; If the barrel is to the left of Mario and Mario is moving right, 
7563   2188             		; then the barrel will go down the ladder
7564   2188 C3 94 21            jp      l21b2
7565   218B             		
7566   218B             		; If the barrel is to the right of Mario and Mario is moving left, 
7567   218B             		; then the barrel will go down the ladder
7568   218B CB 4E       l21a9:  bit     1,(hl)
7569   218D C2 94 21            jp      nz,l21b2
7570   2190             		
7571   2190             		; 25% chance of the barrel going down the ladder on its own
7572   2190 79          l21ae:  ld      a,c
7573   2191 E6 18               and     $18
7574   2193 C0                  ret     nz
7575   2194             		
7576   2194             		; Advance the barrel animation
7577   2194 DD 34 07    l21b2:  inc     (ix+7)
7578   2197             
7579   2197             		; Set the barrel to take the ladder
7580   2197 DD CB 02 C6         set     0,(ix+2)
7581   219B C9                  ret     
7582   219C             ;------------------------------------------------------------------------------
7583   219C             
7584   219C             
7585   219C             		
7586   219C             ;------------------------------------------------------------------------------
7587   219C             ; Copy data from an object data structure to a sprite structure
7588   219C             L_LD_SPRITE_DATA_TO_STRUCT_2:  
7589   219C D9          		exx     
7590   219D DD 7E 03            ld      a,(ix+3)					; X coordinate
7591   21A0 77                  ld      (hl),a
7592   21A1 2C                  inc     l
7593   21A2 DD 7E 07            ld      a,(ix+7)					; Sprite number
7594   21A5 77                  ld      (hl),a
7595   21A6 2C                  inc     l
7596   21A7 DD 7E 08            ld      a,(ix+8)					; Palette
7597   21AA 77                  ld      (hl),a
7598   21AB 2C                  inc     l
7599   21AC DD 7E 05            ld      a,(ix+5)					; Y coordinate
7600   21AF 77                  ld      (hl),a
7601   21B0             
7602   21B0                     ; Jump back to process the next object
7603   21B0 C3 72 1F            jp      l1f8d
7604   21B3             ;------------------------------------------------------------------------------
7605   21B3             
7606   21B3             
7607   21B3             
7608   21B3             ;------------------------------------------------------------------------------
7609   21B3             ; Input data for the attract mode game play demonstration
7610   21B3             ;
7611   21B3             ; The first byte of data is the first demo input value, which is repeated ???
7612   21B3             ; times.
7613   21B3             ;
7614   21B3             ; The two byte pairs that follow are:
7615   21B3             ;	byte 0 = the input data
7616   21B3             ;	byte 1 = repeat count for the following input
7617   21B3             ;		bit 0 = right
7618   21B3             ;		bit 1 = left
7619   21B3             ;		bit 2 = up
7620   21B3             ;		bit 3 = down
7621   21B3             ;		bit 7 = jump
7622   21B3             ;
7623   21B3             ; The expectation seems to be that Mario will be dead before the input runs out.
7624   21B3             ; Interesting things heppen, however, if he doesn't and the rest of the code that
7625   21B3             ; follows is treated as input data...
7626   21B3             L_DEMO_INPUT_DATA:	
7627   21B3 80          		.byte	$80	         	; jump
7628   21B4 FE 01       		.word	TWO_BYTES($01, 254) ; right
7629   21B6 C0 04       		.word	TWO_BYTES($04, 192) ; up
7630   21B8 50 02       		.word	TWO_BYTES($02, 80)  ; left
7631   21BA 10 82       		.word	TWO_BYTES($82, 16)  ; jump left 
7632   21BC 60 02       		.word	TWO_BYTES($02, 96)  ; left
7633   21BE 10 82       		.word	TWO_BYTES($82, 16)  ; jump left
7634   21C0 CA 01       		.word	TWO_BYTES($01, 202) ; right
7635   21C2 10 81       		.word	TWO_BYTES($81, 16)  ; jump right
7636   21C4 FF 02       		.word	TWO_BYTES($02, 255) ; left
7637   21C6 38 01       		.word	TWO_BYTES($01, 56)  ; right 
7638   21C8 80 02       		.word	TWO_BYTES($02, 128) ; left
7639   21CA FF 04       		.word	TWO_BYTES($04, 255) ; up
7640   21CC 80 04       		.word	TWO_BYTES($04, 128) ; up
7641   21CE 60 80       		.word	TWO_BYTES($80, 96)  ; jump
7642   21D0             ;------------------------------------------------------------------------------
7643   21D0             
7644   21D0             
7645   21D0             ;------------------------------------------------------------------------------
7646   21D0             ; Simulate player input for the demo mode
7647   21D0             L_SIMULATE_DEMO_INPUT:  
7648   21D0             		; Convert the input index number to a memory offset in de
7649   21D0 11 B3 21    		ld      de,L_DEMO_INPUT_DATA
7650   21D3 21 CC 63            ld      hl,DEMO_INPUT_INDEX
7651   21D6 7E                  ld      a,(hl)
7652   21D7 07                  rlca    
7653   21D8 83                  add     a,e
7654   21D9 5F                  ld      e,a
7655   21DA                     
7656   21DA                     ; Get the byte of simulated input
7657   21DA 1A                  ld      a,(de)
7658   21DB 32 10 60            ld      (PLAYER_INPUT),a
7659   21DE                     
7660   21DE                     ; Decrement the input repeat, and return if it has not reached zero
7661   21DE 2C                  inc     l
7662   21DF 7E                  ld      a,(hl)
7663   21E0 35                  dec     (hl)
7664   21E1 A7                  and     a
7665   21E2 C0                  ret     nz
7666   21E3             		
7667   21E3             		; Read the next input repeat
7668   21E3 1C                  inc     e
7669   21E4 1A                  ld      a,(de)
7670   21E5 77                  ld      (hl),a
7671   21E6                     
7672   21E6                     ; Increment the input index
7673   21E6 2D                  dec     l
7674   21E7 34                  inc     (hl)
7675   21E8 C9                  ret     
7676   21E9             ;------------------------------------------------------------------------------
7677   21E9             
7678   21E9             
7679   21E9             
7680   21E9             ;------------------------------------------------------------------------------
7681   21E9             ; Implement the logic for the retractin ladders on the mixer stage
7682   21E9 3E 02       L_IMPLEMENT_RET_LADDERS:  ld      a,2
7683   21EB F7                  rst     $30							; Return unless this is the mixer stage
7684   21EC                     
7685   21EC                     ; If counter 2 is odd, process the left ladder
7686   21EC 3A 1A 60            ld      a,(COUNTER_2)
7687   21EF 1F                  rra
7688   21F0 21 80 62            ld      hl,L_RETRACT_LADDER_DATA
7689   21F3 7E                  ld      a,(hl)
7690   21F4 DA FB 21            jp      c,l2219
7691   21F7                     
7692   21F7                     ; Counter 2 is even; process the right ladder
7693   21F7 21 88 62            ld      hl,R_RETRACT_LADDER_STATE
7694   21FA 7E                  ld      a,(hl)
7695   21FB                     
7696   21FB E5          l2219:  push    hl
7697   21FC EF                  rst     $28							; Jump to local table address
7698   21FD             		; Jump table
7699   21FD 09 22       		.word	L_LADDER_STATE_0	; 0 = ladder in up position
7700   21FF 3B 22       		.word	L_LADDER_STATE_1	; 1 = ladder moving down
7701   2201 7B 22       		.word	L_LADDER_STATE_2	; 2 = ladder in down position
7702   2203 84 22       		.word	L_LADDER_STATE_3	; 3 = ladder moving up
7703   2205 00 00       		.word	L_ORG	; 4 = reset game
7704   2207 00 00       		.word	L_ORG	; 5 = reset game
7705   2209             ;------------------------------------------------------------------------------
7706   2209             
7707   2209             
7708   2209             
7709   2209             ;------------------------------------------------------------------------------
7710   2209             ; This function controls the retractable ladders on the mixer level
7711   2209             ; when they are in the up position, waiting to descend
7712   2209             ;
7713   2209             ; passed:	hl (on the stack) - the address of the ladder data
7714   2209             L_LADDER_STATE_0:  
7715   2209             		; Decrement the ladder delay and jump ahead if it has reached
7716   2209             		; 0, to skip moving on to the next ladder state
7717   2209 E1          		pop     hl
7718   220A 2C                  inc     l							; RETRACT_LADDER_DELAY	
7719   220B 35                  dec     (hl)
7720   220C C2 1C 22            jp      nz,l223a
7721   220F             
7722   220F             		; Advance to the next ladder state
7723   220F 2D                  dec     l							; RETRACT_LADDER_STATE
7724   2210 34                  inc     (hl)				
7725   2211             		
7726   2211             		; If Mario is on this ladder, set $621a to 1 and return
7727   2211 2C                  inc     l
7728   2212 2C                  inc     l							; RETRACT_LADDER_X
7729   2213 CD 25 22            call    L_CHECK_IF_MARIO_ON_LADDER
7730   2216 3E 01               ld      a,1
7731   2218 32 1A 62            ld      ($621a),a
7732   221B C9                  ret   
7733   221C             		
7734   221C             		; The ladder is still waiting to descend
7735   221C             		; If Mario is on the ladder, set $621a to 0 and return
7736   221C 2C          l223a:  inc     l
7737   221D CD 25 22            call    L_CHECK_IF_MARIO_ON_LADDER
7738   2220 AF                  xor     a
7739   2221 32 1A 62            ld      ($621a),a
7740   2224 C9                  ret     
7741   2225             ;------------------------------------------------------------------------------
7742   2225             
7743   2225             
7744   2225             
7745   2225             ;------------------------------------------------------------------------------
7746   2225             ; This function checks if Mario is on the current retractable 
7747   2225             ; ladder.
7748   2225             ; Abort the calling function if:
7749   2225             ; 	Mario's y coordinate is > 122 or
7750   2225             ;	MARIO_IS_JUMPING is not 0 or
7751   2225             ;	Mario's x coordinate does not match the ladder's x coordinate
7752   2225             ;
7753   2225             ; passed:	hl - the address of the current retractable ladder's
7754   2225             ;				x coordinate
7755   2225             L_CHECK_IF_MARIO_ON_LADDER:  
7756   2225             		; If Mario's y coordinate is 122 or more,
7757   2225             		; jump ahead to abort the calling function
7758   2225 3A 05 62    		ld      a,(MARIO_Y)
7759   2228 FE 7A               cp      122
7760   222A D2 39 22            jp      nc,l2257
7761   222D                     
7762   222D                     ; If Mario is jumping, 
7763   222D                     ; jump ahead to abort the calling function
7764   222D 3A 16 62    		ld      a,(MARIO_IS_JUMPING)
7765   2230 A7                  and     a
7766   2231 C2 39 22            jp      nz,l2257
7767   2234                     
7768   2234                     ; If Mari 's x coordinate is equal to (hl),
7769   2234                     ; return
7770   2234 3A 03 62            ld      a,(MARIO_X)
7771   2237 BE                  cp      (hl)
7772   2238 C8                  ret     z
7773   2239                     
7774   2239                     ; Return from the calling function
7775   2239 E1          l2257:  pop     hl
7776   223A C9                  ret     
7777   223B             ;------------------------------------------------------------------------------
7778   223B             
7779   223B             
7780   223B             ;------------------------------------------------------------------------------
7781   223B             ; This function moves the ladder down one pixel every 4th call.
7782   223B             ; It also forces Mario down with it, if Mario is on the ladder
7783   223B             ;
7784   223B             ; If Mario is above the stationary part of the ladder, he is moved
7785   223B             ; down at the same speed as the retractable ladder; otherwise, he
7786   223B             ; is moved down at half speed.
7787   223B             ;
7788   223B             ; passed:	hl (on the stack) - the address of the ladder's state
7789   223B             L_LADDER_STATE_1:  
7790   223B             		; Decrement the ladder movement delay
7791   223B             		; Return if it has not reached 0
7792   223B E1          		pop     hl
7793   223C 2C                  inc     l
7794   223D 2C                  inc     l
7795   223E 2C                  inc     l
7796   223F 2C                  inc     l							; RETRACT_LADDER_MOVE_DELAY
7797   2240 35                  dec     (hl)
7798   2241 C0                  ret     nz
7799   2242             		
7800   2242             		; Reset the movement delay to 4
7801   2242 3E 04               ld      a,4
7802   2244 77                  ld      (hl),a
7803   2245             		
7804   2245             		; Lower the ladder 1 pixel
7805   2245 2D                  dec     l							; RETRACT_LADDER_Y
7806   2246 34                  inc     (hl)
7807   2247             		
7808   2247             		; Update the y coordinate of the sprite for the current ladder
7809   2247 CD 9F 22            call    L_UPDATE_LADDER_SPRITE_COORD
7810   224A             		
7811   224A             		; If the ladder has not reached its lowest point, jump ahead
7812   224A 3E 78               ld      a,120
7813   224C BE                  cp      (hl)
7814   224D C2 57 22            jp      nz,l2275
7815   2250             		
7816   2250             		; Advance to the next ladder state
7817   2250 2D                  dec     l
7818   2251 2D                  dec     l
7819   2252 2D                  dec     l
7820   2253 34                  inc     (hl)
7821   2254             		
7822   2254 2C                  inc     l
7823   2255 2C                  inc     l
7824   2256 2C                  inc     l
7825   2257             
7826   2257             		; Return if Mario is not on this ladder
7827   2257 2D          l2275:  dec     l							; RETRACT_LADDER_X
7828   2258 CD 25 22    l2276:  call    L_CHECK_IF_MARIO_ON_LADDER
7829   225B             
7830   225B             		; If Mario is above the stationary part of the ladder, jump ahead
7831   225B 3A 05 62            ld      a,(MARIO_Y)
7832   225E FE 68               cp      104
7833   2260 D2 6C 22            jp      nc,l228a
7834   2263             		
7835   2263             		; Mario is below the stationary part of the ladder;
7836   2263             		; Move Mario down 1 pixel
7837   2263 21 05 62    l2281:  ld      hl,MARIO_Y
7838   2266 34                  inc     (hl)
7839   2267             		
7840   2267             		; Display Mario's sprite as climbing
7841   2267 CD BB 3E            call    L_SET_MARIO_SPRITE_TO_CLIMBING
7842   226A             		
7843   226A             		; Move Mario down 1 pixel
7844   226A 34                  inc     (hl)						; MARIO_SPRITE_Y
7845   226B C9                  ret     
7846   226C             
7847   226C             		; If bit 0 Mario's y coordinate is a 1, jump back up to move him
7848   226C             		; down 1 pizel
7849   226C 1F          l228a:  rra     
7850   226D DA 63 22            jp      c,l2281
7851   2270             		
7852   2270             		; If bit 1 of Mario's y coordinate is a 1, set $6222 to 1
7853   2270 1F                  rra     
7854   2271 3E 01               ld      a,1
7855   2273 DA 77 22            jp      c,l2295
7856   2276             		
7857   2276             		; Bit 1 of Mario's y coordinate is a 0, set $6222 to 0
7858   2276 AF                  xor     a
7859   2277 32 22 62    l2295:  ld      ($6222),a
7860   227A C9                  ret     
7861   227B             ;------------------------------------------------------------------------------
7862   227B             
7863   227B             
7864   227B             
7865   227B             ;------------------------------------------------------------------------------
7866   227B             ; This function leaves the ladder in the down position for a random time
7867   227B             ; before advancing to the next state
7868   227B             L_LADDER_STATE_2:  
7869   227B E1          		pop     hl
7870   227C 3A 18 60            ld      a,(RANDOM_NUMBER)
7871   227F E6 3C               and     %00111100
7872   2281 C0                  ret     nz
7873   2282 34                  inc     (hl)
7874   2283 C9                  ret     
7875   2284             ;------------------------------------------------------------------------------
7876   2284             
7877   2284             
7878   2284             
7879   2284             ;------------------------------------------------------------------------------
7880   2284             ; This function moves the ladder back into the up position 1 pixel at a time
7881   2284             L_LADDER_STATE_3:  
7882   2284             		; Decrement the movement delay
7883   2284             		; Return if it has not reached 0
7884   2284 E1          		pop     hl
7885   2285 2C                  inc     l
7886   2286 2C                  inc     l
7887   2287 2C                  inc     l
7888   2288 2C                  inc     l						; RETRACT_LADDER_MOVE_DELAY
7889   2289 35                  dec     (hl)
7890   228A C0                  ret     nz
7891   228B             		
7892   228B             		; Reset the movement delay to 2
7893   228B 36 02               ld      (hl),2
7894   228D                     
7895   228D                     ; Move the ladder up 1 pixel
7896   228D 2D                  dec     l						; RETRACT_LADDER_Y
7897   228E 35                  dec     (hl)
7898   228F                     
7899   228F                     ; Update the sprite
7900   228F CD 9F 22            call    L_UPDATE_LADDER_SPRITE_COORD
7901   2292                     
7902   2292                     ; Return if the ladder is not completely up
7903   2292 3E 68               ld      a,104
7904   2294 BE                  cp      (hl)
7905   2295 C0                  ret     nz
7906   2296             		
7907   2296             		; Reset the ladder delay (time before retracting again)
7908   2296 AF                  xor     a
7909   2297 06 80               ld      b,128
7910   2299 2D                  dec     l
7911   229A 2D                  dec     l						; RETRACT_LADDER_DELAY
7912   229B 70                  ld      (hl),b
7913   229C                     
7914   229C                     ; Reset the ladder state to 0
7915   229C 2D                  dec     l						; RETRACT_LADDER_STATE
7916   229D 77                  ld      (hl),a
7917   229E C9                  ret     
7918   229F             ;------------------------------------------------------------------------------
7919   229F             
7920   229F             
7921   229F             ;------------------------------------------------------------------------------
7922   229F             ; Update the address of the y coordinate of the ladder sprite corresponding to 
7923   229F             ; the currently processed ladder
7924   229F             ;
7925   229F             ; passed:	hl - address of the retractable ladder's y coordinate
7926   229F             L_UPDATE_LADDER_SPRITE_COORD:  
7927   229F             		; If this is the right ladder, set the y coordinate of the right ladder
7928   229F             		; sprite
7929   229F 7E          		ld      a,(hl)
7930   22A0 CB 5D               bit     3,l
7931   22A2 11 4B 69            ld      de,R_RETRACT_LADDER_SPRITE_Y
7932   22A5 C2 AB 22            jp      nz,l22c9
7933   22A8             		
7934   22A8             		; Update the coordinate of the left ladder sprite
7935   22A8 11 47 69            ld      de,L_RETRACT_LADDER_SPRITE_Y
7936   22AB             		
7937   22AB 12          l22c9:  ld      (de),a
7938   22AC C9                  ret     
7939   22AD             ;------------------------------------------------------------------------------
7940   22AD             
7941   22AD             
7942   22AD             
7943   22AD             ;------------------------------------------------------------------------------
7944   22AD 3A 48 63    l22cb:  ld      a,(BARREL_FIRE_STATUS)
7945   22B0 A7                  and     a
7946   22B1 CA C3 22            jp      z,l22e1
7947   22B4 3A 80 63            ld      a,(CP_DIFFICULTY)
7948   22B7 3D                  dec     a
7949   22B8 EF                  rst     $28							; Jump to local table address
7950   22B9             		; Jump table
7951   22B9 D8 22       		.word	l22f6	; 0 = 
7952   22BB D8 22       		.word	l22f6	; 1 = 
7953   22BD E5 22       		.word	l2303	; 2 = 
7954   22BF E5 22       		.word	l2303	; 3 = 
7955   22C1 FC 22       		.word	l231a	; 4 = 
7956   22C3             ;------------------------------------------------------------------------------
7957   22C3             
7958   22C3             
7959   22C3             
7960   22C3             ;------------------------------------------------------------------------------
7961   22C3 3A 29 62    l22e1:  ld      a,(CP_LEVEL_NUMBER)
7962   22C6 47                  ld      b,a
7963   22C7 05                  dec     b
7964   22C8 3E 01               ld      a,1
7965   22CA CA DB 22            jp      z,l22f9
7966   22CD 05                  dec     b
7967   22CE 3E B1               ld      a,$b1
7968   22D0 CA DB 22            jp      z,l22f9
7969   22D3             		
7970   22D3 3E E9               ld      a,$e9
7971   22D5 C3 DB 22            jp      l22f9
7972   22D8 3A 18 60    l22f6:  ld      a,(RANDOM_NUMBER)
7973   22DB DD 77 11    l22f9:  ld      (ix+17),a
7974   22DE E6 01               and     1
7975   22E0 3D                  dec     a
7976   22E1 DD 77 10            ld      (ix+16),a
7977   22E4 C9                  ret     
7978   22E5             ;------------------------------------------------------------------------------
7979   22E5             
7980   22E5             
7981   22E5             
7982   22E5             ;------------------------------------------------------------------------------
7983   22E5 3A 18 60    l2303:  ld      a,(RANDOM_NUMBER)
7984   22E8 DD 77 11            ld      (ix+17),a
7985   22EB 3A 03 62            ld      a,(MARIO_X)
7986   22EE DD BE 03            cp      (ix+3)
7987   22F1 3E 01               ld      a,1
7988   22F3 D2 F8 22            jp      nc,l2316
7989   22F6 3D                  dec     a
7990   22F7 3D                  dec     a
7991   22F8 DD 77 10    l2316:  ld      (ix+16),a
7992   22FB C9                  ret     
7993   22FC             ;------------------------------------------------------------------------------
7994   22FC             
7995   22FC             
7996   22FC             
7997   22FC             ;------------------------------------------------------------------------------
7998   22FC 3A 03 62    l231a:  ld      a,(MARIO_X)
7999   22FF DD 96 03            sub     (ix+3)
8000   2302 0E FF               ld      c,$ff
8001   2304 DA 08 23            jp      c,l2326
8002   2307 0C                  inc     c
8003   2308 07          l2326:  rlca    
8004   2309 CB 11               rl      c
8005   230B 07                  rlca    
8006   230C CB 11               rl      c
8007   230E DD 71 10            ld      (ix+16),c
8008   2311 DD 77 11            ld      (ix+17),a
8009   2314 C9                  ret     
8010   2315             ;------------------------------------------------------------------------------
8011   2315             
8012   2315             
8013   2315             
8014   2315             ;------------------------------------------------------------------------------
8015   2315             ; This function contains the logic the rolls the barrels along the girder
8016   2315             ; platforms and makes the barrels follow the slope of the platforms.
8017   2315             ; passed:	h - sprite x coordinate
8018   2315             ;			l - sprite y coordinate
8019   2315             ;			b - 1 if the barrel is rolling right,
8020   2315             ;			  - -1 if the barrel is rolling left
8021   2315             ; return:	l - the sprite's new y coordinate
8022   2315             L_MOVE_SPRITE_ALONG_PLAT:  
8023   2315 3E 0F       		ld      a,%00001111
8024   2317 A4                  and     h
8025   2318                     
8026   2318                     ; If the barrel is rolling right, jump ahead
8027   2318 05                  dec     b
8028   2319 CA 24 23            jp      z,l2342
8029   231C             
8030   231C             		; If the barrel is rolling left
8031   231C             		; and is not at the edge of a tile grid space, return
8032   231C FE 0F               cp      %00001111
8033   231E D8                  ret     c
8034   231F                     
8035   231F                     ; Mark the barrel as rolling left, and jump ahead
8036   231F 06 FF               ld      b,-1
8037   2321 C3 29 23            jp      l2347
8038   2324             
8039   2324                     ; Return unless the barrel is at the edge of a tile grid space    
8040   2324 FE 01       l2342:  cp      1
8041   2326 D0                  ret     nc
8042   2327             		
8043   2327             		; Mark the barrel as rolling right
8044   2327 06 01               ld      b,1
8045   2329                     
8046   2329                     ; Jump ahead if the barrel has reached the straight part of the bottom platform
8047   2329 3E F0       l2347:  ld      a,240
8048   232B BD                  cp      l
8049   232C CA 42 23            jp      z,l2360
8050   232F                     
8051   232F                     ; Jump ahead if the barrel is on the straight part of the top platform
8052   232F 3E 4C               ld      a,76
8053   2331 BD                  cp      l
8054   2332 CA 48 23            jp      z,l2366
8055   2335                     
8056   2335                     ; Jump ahead if the barrel has ???
8057   2335 7D                  ld      a,l
8058   2336 CB 6F               bit     5,a
8059   2338 CA 3E 23            jp      z,l235c
8060   233B                     
8061   233B 90          l2359:  sub     b
8062   233C             
8063   233C             		; Update the barrel's y coordinate and return
8064   233C 6F          l235a:  ld      l,a
8065   233D C9                  ret     
8066   233E             		
8067   233E             		; Move the barrel down 1 pixel
8068   233E 80          l235c:  add     a,b
8069   233F C3 3C 23            jp      l235a
8070   2342             
8071   2342 CB 7C       l2360:  bit     7,h
8072   2344 C2 3B 23            jp      nz,l2359
8073   2347 C9                  ret     
8074   2348             		
8075   2348             		; Return if the barrel has not reached the sloped portion
8076   2348             		; of the top platform
8077   2348 7C          l2366:  ld      a,h
8078   2349 FE 98               cp      152
8079   234B D8                  ret     c
8080   234C             		
8081   234C             		; Jump back up to move the barrel down 1 pixel
8082   234C 7D                  ld      a,l
8083   234D C3 3E 23            jp      l235c		
8084   2350             ;------------------------------------------------------------------------------
8085   2350             
8086   2350                      
8087   2350             		
8088   2350             ;------------------------------------------------------------------------------
8089   2350             ; This function checks if Mario is at the top or bottom of a ladder.
8090   2350             ; If Mario is not at the top or bottom of a ladder, the calling function is 
8091   2350             ; aborted
8092   2350             ;
8093   2350             ; passed:	a - Mario's x coordinate
8094   2350             ;			d - Mario's y coordinate (+8)
8095   2350             ; return:	a - 0 if Mario is at the bottom of a ladder,
8096   2350             ;				1 if Mario is at the top of a ladder
8097   2350             ;			b - the y coordinate of the other end of the ladder
8098   2350             ;				(bottom if Mario is at the top of the ladder,
8099   2350             ;				top if Mario is at the bottom of the ladder)
8100   2350             L_CHECK_IF_ON_LADDER:
8101   2350             		; Load bc with the number of normal ladders + 1
8102   2350 01 15 00    		ld		bc,21
8103   2353             		; If there is not a normal ladder under Mario,
8104   2353             		; jump ahead to return from the calling function
8105   2353 21 00 63    		ld      hl,NORMAL_LADDER_X_COORD_DATA
8106   2356 ED B1       l2371:  cpir    
8107   2358 C2 7F 23            jp      nz,l239a
8108   235B                     
8109   235B                     ; Save hl and bc
8110   235B E5                  push    hl
8111   235C C5                  push    bc
8112   235D                     
8113   235D                     ; Advance hl to this ladder's y1 coordinate
8114   235D 01 14 00            ld      bc,20
8115   2360 09                  add     hl,bc
8116   2361                     
8117   2361 0C                  inc     c
8118   2362                     
8119   2362                     ; If Mario is at the bottom of this ladder,
8120   2362                     ; jump ahead
8121   2362 5F                  ld      e,a						; Save Mario x in e
8122   2363 7A                  ld      a,d						; Load Mario y from d
8123   2364 BE                  cp      (hl)
8124   2365 CA 74 23            jp      z,l238f
8125   2368                     
8126   2368                     ; Advance hl to this ladder's y2 coordinate
8127   2368 09                  add     hl,bc
8128   2369                     
8129   2369                     ; If Mario is at the top of this ladder, jump ahead
8130   2369 BE                  cp      (hl)
8131   236A CA 7A 23            jp      z,l2395
8132   236D                     
8133   236D                     ; Search again for another ladder
8134   236D 57                  ld      d,a						; Save Mario y in d Note: this may not be neccessary - d already contains the y coordinate
8135   236E 7B                  ld      a,e						; Load Mario x from e
8136   236F C1                  pop     bc
8137   2370 E1                  pop     hl
8138   2371 C3 56 23            jp      l2371
8139   2374             
8140   2374             		; Advance hl to the ladder's y2 coordinate
8141   2374 09          l238f:  add     hl,bc
8142   2375             
8143   2375             		; Jump ahead to return a as 1
8144   2375 3E 01               ld      a,1
8145   2377 C3 7D 23            jp      l2398
8146   237A                     
8147   237A                     ; Return a as 0
8148   237A AF          l2395:  xor     a						; a = 0
8149   237B                     
8150   237B                     ; Backup hl to the ladder's y1 coordinate
8151   237B ED 42               sbc     hl,bc
8152   237D                     
8153   237D                     ; Store the ladder's other y coordinate in b
8154   237D C1          l2398:  pop     bc
8155   237E 46                  ld      b,(hl)
8156   237F                     
8157   237F E1          l239a:  pop     hl
8158   2380 C9                  ret     
8159   2381             ;------------------------------------------------------------------------------
8160   2381             		
8161   2381             
8162   2381             		
8163   2381             ;------------------------------------------------------------------------------
8164   2381             l239c:  
8165   2381 DD 7E 04    		ld      a,(ix+4)
8166   2384 DD 86 11            add     a,(ix+17)
8167   2387 DD 77 04            ld      (ix+4),a
8168   238A DD 7E 03            ld      a,(ix+3)					; X coordinate
8169   238D DD 8E 10            adc     a,(ix+16)
8170   2390 DD 77 03            ld      (ix+3),a
8171   2393                     
8172   2393 DD 7E 06            ld      a,(ix+6)
8173   2396 DD 96 13            sub     (ix+19)
8174   2399 6F                  ld      l,a
8175   239A DD 7E 05            ld      a,(ix+5)					; Y coordinate
8176   239D DD 9E 12            sbc     a,(ix+18)
8177   23A0 67                  ld      h,a
8178   23A1 DD 7E 14            ld      a,(ix+20)
8179   23A4 A7                  and     a						; Clear the carry bit
8180   23A5 17                  rla     						; Bit 7 to carry flag
8181   23A6 3C                  inc     a
8182   23A7 06 00               ld      b,0
8183   23A9 CB 10               rl      b
8184   23AB CB 27               sla     a
8185   23AD CB 10               rl      b
8186   23AF CB 27               sla     a
8187   23B1 CB 10               rl      b
8188   23B3 CB 27               sla     a
8189   23B5 CB 10               rl      b
8190   23B7 4F                  ld      c,a
8191   23B8 09                  add     hl,bc
8192   23B9 DD 74 05            ld      (ix+5),h				; Y coordinate
8193   23BC DD 75 06            ld      (ix+6),l				
8194   23BF DD 34 14            inc     (ix+20)
8195   23C2 C9                  ret     
8196   23C3             ;------------------------------------------------------------------------------
8197   23C3             
8198   23C3             
8199   23C3             
8200   23C3             ;------------------------------------------------------------------------------
8201   23C3             ; passed;	c - 
8202   23C3             l23de:  
8203   23C3             		; Decrement the ??? counter
8204   23C3             		; If it has not reached 0, jump ahead to skip this function
8205   23C3 DD 7E 0F    		ld      a,(ix+15)
8206   23C6 3D                  dec     a
8207   23C7 C2 E8 23            jp      nz,l2403
8208   23CA                     
8209   23CA AF                  xor     a						; a = 0
8210   23CB DD CB 07 26         sla     (ix+7)
8211   23CF 17                  rla     
8212   23D0 DD CB 08 26         sla     (ix+8)
8213   23D4 17                  rla     
8214   23D5 47                  ld      b,a
8215   23D6 3E 03               ld      a,3
8216   23D8 B1                  or      c
8217   23D9 CD 8C 2F            call    l3009
8218   23DC                     
8219   23DC 1F                  rra     
8220   23DD DD CB 08 1E         rr      (ix+8)
8221   23E1 1F                  rra     
8222   23E2 DD CB 07 1E         rr      (ix+7)
8223   23E6                     
8224   23E6                     ; Reset the ??? to 4
8225   23E6 3E 04               ld      a,4
8226   23E8 DD 77 0F    l2403:  ld      (ix+15),a
8227   23EB C9                  ret     
8228   23EC             ;------------------------------------------------------------------------------
8229   23EC             
8230   23EC             
8231   23EC             
8232   23EC             ;------------------------------------------------------------------------------
8233   23EC DD 7E 14    l2407:  ld      a,(ix+20)
8234   23EF 07                  rlca    
8235   23F0 07                  rlca    
8236   23F1 07                  rlca    
8237   23F2 07                  rlca    
8238   23F3 4F                  ld      c,a
8239   23F4 E6 0F               and     %00001111
8240   23F6 67                  ld      h,a
8241   23F7 79                  ld      a,c
8242   23F8 E6 F0               and     %11110000
8243   23FA 6F                  ld      l,a
8244   23FB DD 4E 13            ld      c,(ix+19)
8245   23FE DD 46 12            ld      b,(ix+18)
8246   2401 ED 42               sbc     hl,bc
8247   2403 C9                  ret     
8248   2404             ;------------------------------------------------------------------------------
8249   2404             
8250   2404             
8251   2404             
8252   2404             ;------------------------------------------------------------------------------
8253   2404             ; Implement the barriers that stop Mario from moving past the edges of the screen
8254   2404             ; or past the invisible barriers surrounding Donkey Kong on the barrels and 
8255   2404             ; elevators stages.
8256   2404             ;
8257   2404             ; passed:	none
8258   2404             ; return:	d = 1 if Mario can't move left
8259   2404             ;			e = 1 if Mario can't move right
8260   2404             L_IMPLEMENT_BARRIERS:  
8261   2404             		; Check if Mario is at the left edge of the stage
8262   2404 11 00 01    		ld      de,$0100					
8263   2407 3A 03 62            ld      a,(MARIO_X)
8264   240A FE 16       		cp		22
8265   240C D8                  ret     c							; Return if Mario X < 22
8266   240D             		
8267   240D             		; Check if Mario is at the right edge of the stage
8268   240D 15                  dec     d
8269   240E 1C                  inc     e
8270   240F FE EA               cp      234
8271   2411 D0                  ret     nc							; Return if Mario X > 234
8272   2412             
8273   2412             		; Return if not the barrels stage or elevators stage
8274   2412 1D                  dec     e
8275   2413 3A 27 62            ld      a,(CURRENT_STAGE)
8276   2416 0F                  rrca    
8277   2417 D0                  ret     nc
8278   2418             		
8279   2418             		; Return if Mario is below the top platform
8280   2418 3A 05 62            ld      a,(MARIO_Y)
8281   241B FE 58               cp      88
8282   241D D0                  ret     nc							; Return if Mario Y > 88
8283   241E             		
8284   241E             		; Check if Mario is approaching Donkey Kong
8285   241E             		; (There is an invisible barrier preventing Mario from approaching the two ladders)
8286   241E 3A 03 62            ld      a,(MARIO_X)
8287   2421 FE 6C               cp      108
8288   2423 D0                  ret     nc							; Return if Mario X > 108
8289   2424 14                  inc     d
8290   2425 C9                  ret     
8291   2426             ;------------------------------------------------------------------------------
8292   2426             
8293   2426             
8294   2426             
8295   2426             ;------------------------------------------------------------------------------
8296   2426             ; Parse the stage data for the current stage and use it to fill in the ladder
8297   2426             ; data structures (type, x coordinate, and y1 - y2 coordinates)
8298   2426             L_PARSE_STAGE_LADDER_DATA:  
8299   2426 FD 21 10 63         ld      iy,BROKEN_LADDER_X_COORD_DATA
8300   242A                     
8301   242A                     ; If the current stage is barrels,
8302   242A                     ; point to the barrels stage data
8303   242A 3A 27 62    		ld      a,(CURRENT_STAGE)
8304   242D 3D                  dec     a
8305   242E 21 56 3A            ld      hl,L_BARRELS_STAGE_DATA
8306   2431 CA 45 24            jp      z,l2471
8307   2434                     
8308   2434                     ; If the current stage is the mixer,
8309   2434                     ; point to the mixer stage data
8310   2434 3D                  dec     a
8311   2435 21 CF 3A            ld      hl,L_MIXER_STAGE_DATA
8312   2438 CA 45 24            jp      z,l2471
8313   243B                     
8314   243B                     ; If the current stage is the elevators,
8315   243B                     ; point to the elevators stage data
8316   243B 3D                  dec     a
8317   243C 21 57 3B            ld      hl,L_ELEVATORS_STAGE_DATA
8318   243F CA 45 24            jp      z,l2471
8319   2442                     
8320   2442                     ; Point to the rivets stage data
8321   2442 21 FD 3B            ld      hl,L_RIVETS_STAGE_DATA
8322   2445                     
8323   2445 DD 21 00 63 l2471:  ld      ix,NORMAL_LADDER_X_COORD_DATA
8324   2449 11 05 00            ld      de,5
8325   244C                     
8326   244C                     ; If the first tile type of stage data is $00,
8327   244C                     ; (normal ladder),
8328   244C                     ; then jump ahead
8329   244C 7E          l2478:  ld      a,(hl)
8330   244D A7                  and     a
8331   244E CA 5C 24            jp      z,l2488
8332   2451                     
8333   2451                     ; If the first tile type of stage data is $01,
8334   2451                     ; (broken ladder),
8335   2451                     ; then jump ahead
8336   2451 3D                  dec     a
8337   2452 CA 72 24            jp      z,l249e
8338   2455                     
8339   2455                     ; If the end of the data has been reached, return
8340   2455 FE A9               cp      $a9
8341   2457 C8                  ret     z
8342   2458             		
8343   2458             		; Check out the next tile type
8344   2458 19                  add     hl,de
8345   2459 C3 4C 24            jp      l2478
8346   245C                     
8347   245C             		; Record the coordinates of the normal ladder
8348   245C 23          l2488:  inc     hl						; X1 coordinate
8349   245D 7E                  ld      a,(hl)
8350   245E DD 77 00            ld      (ix+0),a
8351   2461 23                  inc     hl						; Y1 coordinate
8352   2462 7E                  ld      a,(hl)
8353   2463 DD 77 15            ld      (ix+21),a
8354   2466 23                  inc     hl
8355   2467 23                  inc     hl						; Y2 coordinate
8356   2468 7E                  ld      a,(hl)
8357   2469 DD 77 2A            ld      (ix+42),a
8358   246C                     
8359   246C             		; Advance to the next ladder data structure 
8360   246C             		; and the next block of tile data
8361   246C DD 23               inc     ix
8362   246E 23                  inc     hl
8363   246F                     
8364   246F             		; Process the next block of tile data
8365   246F C3 4C 24            jp      l2478
8366   2472                     
8367   2472             		; Record the coordinates of the broken ladder
8368   2472 23          l249e:  inc     hl						; X1 coordinate
8369   2473 7E                  ld      a,(hl)
8370   2474 FD 77 00            ld      (iy+0),a
8371   2477 23                  inc     hl						; Y1 coordinate
8372   2478 7E                  ld      a,(hl)
8373   2479 FD 77 15            ld      (iy+21),a
8374   247C 23                  inc     hl
8375   247D 23                  inc     hl						; Y2 coordinate
8376   247E 7E                  ld      a,(hl)
8377   247F FD 77 2A            ld      (iy+42),a
8378   2482                     
8379   2482             		; Advance to the next ladder data structure 
8380   2482             		; and the next block of tile data
8381   2482 FD 23               inc     iy
8382   2484 23                  inc     hl
8383   2485                     
8384   2485             		; Process the next block of tile data
8385   2485 C3 4C 24            jp      l2478
8386   2488             ;------------------------------------------------------------------------------
8387   2488             
8388   2488             
8389   2488             ;------------------------------------------------------------------------------
8390   2488             l24b4:  
8391   2488             		; Return if ??? is above 232
8392   2488 DD 7E 05    		ld      a,(ix+5)					; Y coordinate
8393   248B FE E8               cp      232
8394   248D D8                  ret     c
8395   248E             		
8396   248E                     ; Returm if ??? is right of 42 or left of 32
8397   248E DD 7E 03            ld      a,(ix+3)					; X coordinate
8398   2491 FE 2A               cp      42
8399   2493 D0                  ret     nc
8400   2494 FE 20               cp      32
8401   2496 D8                  ret     c
8402   2497             		
8403   2497             		; If this is not an oil barrel, jump ahead
8404   2497             		; to skip the fire flare up
8405   2497 DD 7E 15            ld      a,(ix+21)				; Barrel type
8406   249A A7                  and     a
8407   249B CA A4 24            jp      z,l24d0
8408   249E                     
8409   249E                     ; Flare up the oil fire
8410   249E 3E 03               ld      a,3
8411   24A0 32 B9 62            ld      (BARREL_FIRE_STATE),a
8412   24A3                     
8413   24A3                     ; Mark the barrel as inactive
8414   24A3 AF                  xor     a
8415   24A4 DD 77 00    l24d0:  ld      (ix+0),a					; Active
8416   24A7 DD 77 03            ld      (ix+3),a					; X coordinate
8417   24AA                     
8418   24AA                     ; Trigger Donkey Kong's stomp sound
8419   24AA 21 82 60            ld      hl,STOMP_SOUND_TRIGGER
8420   24AD 36 03               ld      (hl),3
8421   24AF                     
8422   24AF E1                  pop     hl
8423   24B0                     
8424   24B0                     ; If the barrel fire is marked as burning, jump ahead
8425   24B0 3A 48 63            ld      a,(BARREL_FIRE_STATUS)
8426   24B3 A7                  and     a
8427   24B4 C2 9C 21            jp      nz,L_LD_SPRITE_DATA_TO_STRUCT_2
8428   24B7                     
8429   24B7                     ; Mark the fire as burning
8430   24B7 3C                  inc     a
8431   24B8 32 48 63            ld      (BARREL_FIRE_STATUS),a
8432   24BB                     
8433   24BB C3 9C 21            jp      L_LD_SPRITE_DATA_TO_STRUCT_2
8434   24BE             
8435   24BE             		
8436   24BE             		; Return unless this is the mixer stage
8437   24BE 3E 02       l24ea:  ld      a,%00000010
8438   24C0 F7                  rst     $30							
8439   24C1             		
8440   24C1 CD F7 24            call    l2523
8441   24C4 CD 65 25            call    L_MOVE_PIES_ON_CONVEYERS
8442   24C7 DD 21 A0 65         ld      ix,PIE_STRUCTS
8443   24CB 06 06               ld      b,6
8444   24CD 21 B8 69            ld      hl,PIE_SPRITES
8445   24D0 DD 7E 00    l24fc:  ld      a,(ix+0)
8446   24D3 A7                  and     a
8447   24D4 CA F0 24            jp      z,l251c
8448   24D7 DD 7E 03            ld      a,(ix+3)
8449   24DA 77                  ld      (hl),a
8450   24DB 2C                  inc     l
8451   24DC DD 7E 07            ld      a,(ix+7)
8452   24DF 77                  ld      (hl),a
8453   24E0 2C                  inc     l
8454   24E1 DD 7E 08            ld      a,(ix+8)
8455   24E4 77                  ld      (hl),a
8456   24E5 2C                  inc     l
8457   24E6 DD 7E 05            ld      a,(ix+5)
8458   24E9 77                  ld      (hl),a
8459   24EA 2C                  inc     l
8460   24EB DD 19       l2517:  add     ix,de
8461   24ED 10 E1               djnz    l24fc
8462   24EF C9                  ret     
8463   24F0             		
8464   24F0 7D          l251c:  ld      a,l
8465   24F1 C6 04               add     a,$04
8466   24F3 6F                  ld      l,a
8467   24F4 C3 EB 24            jp      l2517
8468   24F7 21 9B 63    l2523:  ld      hl,$639b
8469   24FA 7E                  ld      a,(hl)
8470   24FB A7                  and     a
8471   24FC C2 63 25            jp      nz,l258f
8472   24FF 3A 9A 63            ld      a,($639a)
8473   2502 A7                  and     a
8474   2503 C8                  ret     z
8475   2504             		
8476   2504 06 06               ld      b,$06
8477   2506 11 10 00            ld      de,$0010
8478   2509 DD 21 A0 65         ld      ix,PIE_STRUCTS
8479   250D DD CB 00 46 l2539:  bit     0,(ix+0)
8480   2511 CA 19 25            jp      z,l2545
8481   2514 DD 19               add     ix,de
8482   2516 10 F5               djnz    l2539
8483   2518 C9                  ret     
8484   2519             		
8485   2519 CD 57 00    l2545:  call    L_UPDATE_RAND_NUM
8486   251C FE 60               cp      $60
8487   251E DD 36 05 7C         ld      (ix+5),$7c
8488   2522 DA 2C 25            jp      c,l2558
8489   2525 3A A3 62            ld      a,(RIGHT_MASTER_CONVEYER_DIR)
8490   2528 3D                  dec     a
8491   2529 C2 42 25            jp      nz,l256e
8492   252C DD 36 05 CC l2558:  ld      (ix+5),$cc
8493   2530 3A A6 62            ld      a,(BOT_MASTER_CONVEYER_DIR)
8494   2533 07                  rlca    
8495   2534 DD 36 03 07 l2560:  ld      (ix+3),$07
8496   2538 D2 4A 25            jp      nc,l2576
8497   253B DD 36 03 F8         ld      (ix+3),$f8
8498   253F C3 4A 25            jp      l2576
8499   2542 CD 57 00    l256e:  call    L_UPDATE_RAND_NUM
8500   2545 FE 68               cp      $68
8501   2547 C3 34 25            jp      l2560
8502   254A DD 36 00 01 l2576:  ld      (ix+0),$01
8503   254E DD 36 07 4B         ld      (ix+7),$4b
8504   2552 DD 36 09 08         ld      (ix+9),$08
8505   2556 DD 36 0A 03         ld      (ix+10),$03
8506   255A 3E 7C               ld      a,$7c
8507   255C 32 9B 63            ld      ($639b),a
8508   255F AF                  xor     a
8509   2560 32 9A 63            ld      ($639a),a
8510   2563 35          l258f:  dec     (hl)
8511   2564 C9                  ret     
8512   2565             ;------------------------------------------------------------------------------
8513   2565             
8514   2565             
8515   2565             
8516   2565             ;------------------------------------------------------------------------------
8517   2565             ; This function moves the pies along the conveyers on the mixer stage
8518   2565             ; Note: It should be possible to optomize this function to gain a few bytes
8519   2565             L_MOVE_PIES_ON_CONVEYERS:  
8520   2565 DD 21 A0 65 		ld      ix,PIE_STRUCTS
8521   2569 11 10 00            ld      de,16					; 16 byte data structures
8522   256C 06 06               ld      b,6						; For b = 6 to 1 (6 pies)
8523   256E                     
8524   256E                     ; If this pie is not active, jump ahead to process the next one
8525   256E DD CB 00 46 l259a:  bit     0,(ix+0)
8526   2572 CA 8F 25            jp      z,l25bb
8527   2575                     
8528   2575                     ; If the pie is off the left edge of the scen, jump ahead
8529   2575 DD 7E 03            ld      a,(ix+3)					; x coordinate
8530   2578 67                  ld      h,a
8531   2579 C6 07               add     a,7
8532   257B FE 0E               cp      14
8533   257D DA AA 25            jp      c,l25d6
8534   2580                     
8535   2580                     ; If the pie is on the left or right conveyers
8536   2580 DD 7E 05            ld      a,(ix+5)					; y coordinate
8537   2583 FE 7C               cp      124
8538   2585 CA 94 25            jp      z,l25c0
8539   2588                     
8540   2588                     ; The pie is on the bottom conveye r
8541   2588                     ; Move the pie along the bottom conveyer
8542   2588 3A A6 63            ld      a,(BOT_CONVEYER_DIR)
8543   258B 84                  add     a,h
8544   258C DD 77 03            ld      (ix+3),a					; x coordinate
8545   258F                     
8546   258F                     ; Move on to the next pie
8547   258F DD 19       l25bb:  add     ix,de
8548   2591 10 DB               djnz    l259a
8549   2593 C9                  ret     
8550   2594             		
8551   2594             		; The pie is on the left or right conveyer
8552   2594             		; If the pie has reached the oil barrel, jump ahead
8553   2594 7C          l25c0:  ld      a,h
8554   2595 FE 80               cp      128
8555   2597 CA AA 25            jp      z,l25d6
8556   259A                     
8557   259A                     ; If the pie is on the right conveyer belt,
8558   259A                     ; use the right conveyer belt direction
8559   259A 3A A5 63            ld      a,(RIGHT_CONVEYER_DIR)
8560   259D D2 A3 25            jp      nc,l25cf
8561   25A0                     
8562   25A0                     ; If the pie is on the left conveyer belt,
8563   25A0                     ; use the left conveyer belt direction
8564   25A0 3A A4 63            ld      a,(LEFT_CONVEYER_DIR)
8565   25A3                     
8566   25A3                     ; Move the pie along this conveyer belt
8567   25A3 84          l25cf:  add     a,h
8568   25A4 DD 77 03            ld      (ix+3),a
8569   25A7                     
8570   25A7                     ; Jump back to process the next pie
8571   25A7 C3 8F 25            jp      l25bb
8572   25AA                     
8573   25AA                     ; Get the address of the pie sprite that went offscreen
8574   25AA                     ; and jump ahead to inactivate it
8575   25AA 21 B8 69    l25d6:  ld      hl,PIE_SPRITES
8576   25AD 3E 06               ld      a,6
8577   25AF 90                  sub     b
8578   25B0 CA BB 25    l25dc:  jp      z,l25e7
8579   25B3             
8580   25B3                     ; Advance to the next pie sprite
8581   25B3 2C                  inc     l
8582   25B4 2C                  inc     l
8583   25B5 2C                  inc     l
8584   25B6 2C                  inc     l
8585   25B7                     
8586   25B7                     ; Jump back up to continue searching for the correct sprite
8587   25B7 3D                  dec     a
8588   25B8 C3 B0 25            jp      l25dc
8589   25BB                     
8590   25BB                     ; Deactivate the sprite structure
8591   25BB AF          l25e7:  xor     a
8592   25BC DD 77 00            ld      (ix+0),a					; Sprite active
8593   25BF DD 77 03            ld      (ix+3),a					; X coordinate
8594   25C2                     
8595   25C2                     ; Hide the sprite
8596   25C2 77                  ld      (hl),a
8597   25C3                     
8598   25C3                     ; Jump back up to process the next pie
8599   25C3 C3 8F 25            jp      l25bb
8600   25C6             ;------------------------------------------------------------------------------
8601   25C6             
8602   25C6             
8603   25C6             
8604   25C6             ;------------------------------------------------------------------------------
8605   25C6             ; This function performs conveyer handling for the mixer stage
8606   25C6             L_IMPLEMENT_CONVEYERS:  
8607   25C6 3E 02       		ld      a,2
8608   25C8 F7                  rst     $30							; Return unless this is the mixer stage
8609   25C9 CD D6 25            call    L_IMPLEMENT_TOP_CONVEYER
8610   25CC CD 03 26            call    L_IMPLEMENT_MID_CONVEYERS
8611   25CF CD 20 26            call    L_IMPLEMENT_BOT_CONVEYERS
8612   25D2 CD 61 2A            call    L_MOVE_MARIO_ON_CONVEYERS
8613   25D5 C9                  ret     
8614   25D6             ;------------------------------------------------------------------------------
8615   25D6             
8616   25D6             
8617   25D6             
8618   25D6             ;------------------------------------------------------------------------------
8619   25D6             ; This function controls the top conveyer belt and causes it to change directions
8620   25D6             ; periodically.
8621   25D6             ;
8622   25D6             ; It also calls the animate motor function to animate the top two conveyer belt
8623   25D6             ; motor sprite to simulate them rotating.
8624   25D6             L_IMPLEMENT_TOP_CONVEYER:  
8625   25D6             		; If counter 2 is odd, jump ahead to skip the conveyer reverse logic
8626   25D6 3A 1A 60    		ld      a,(COUNTER_2)
8627   25D9 0F                  rrca    
8628   25DA DA EA 25            jp      c,l2616
8629   25DD             		
8630   25DD             		; If the conveyer reverse timer has not reached zero, jump ahead to
8631   25DD             		; skip the conveyer reverse logic
8632   25DD 21 A0 62            ld      hl,TOP_MASTER_REVERSE_TIMER
8633   25E0 35                  dec     (hl)
8634   25E1 C2 EA 25            jp      nz,l2616
8635   25E4             		
8636   25E4             		; Reset the conveyer reverse timer to 128
8637   25E4 36 80               ld      (hl),128
8638   25E6             		
8639   25E6             		; Reverse the conveyer belt
8640   25E6 2C                  inc     l							; TOP_MASTER_CONVEYER_DIR
8641   25E7 CD 85 26            call    L_REVERSE_CONVEYER_DIR
8642   25EA             		
8643   25EA             		; Set the conveyer belt speed to 1 in the current direction
8644   25EA 21 A1 62    l2616:  ld      hl,TOP_MASTER_CONVEYER_DIR
8645   25ED CD 90 26            call    L_SET_CONVEYER_SPEED_TO_1
8646   25F0             		
8647   25F0             		; Set the top conveyer belt direction and speed to match the master
8648   25F0             		; animation conveyer belt direction
8649   25F0 32 A3 63            ld      (TOP_CONVEYER_DIR),a
8650   25F3             		
8651   25F3             		; If it is not time to update the motor animation, then return
8652   25F3 3A 1A 60            ld      a,(COUNTER_2)
8653   25F6 E6 1F               and     %00011111
8654   25F8 FE 01               cp      1
8655   25FA C0                  ret     nz
8656   25FB             		
8657   25FB             		; Animate the two conveyer belt motors
8658   25FB 11 E4 69            ld      de,CONV_MOTOR_SPRITE_TL
8659   25FE EB                  ex      de,hl
8660   25FF CD 4D 26            call    L_ANIMATE_MOTOR_SPRITES
8661   2602 C9                  ret     
8662   2603             ;------------------------------------------------------------------------------
8663   2603             
8664   2603             
8665   2603             
8666   2603             ;------------------------------------------------------------------------------
8667   2603             ; This function controls the left and right conveyer belts on the mixer stage
8668   2603             ; These two conveyer belts always move inwards.  
8669   2603             ;
8670   2603             ; It also calls the animate motor function to animate the top two conveyer belt
8671   2603             ; motor sprite to simulate them rotating.
8672   2603             L_IMPLEMENT_MID_CONVEYERS:  
8673   2603 21 A3 62    l264c:  ld      hl,RIGHT_MASTER_CONVEYER_DIR
8674   2606 CD 90 26            call    L_SET_CONVEYER_SPEED_TO_1	; a = RIGHT_MASTER_CONVEYER_DIR speed and dir
8675   2609             
8676   2609                     ; Set the right and left conveyer belt directions
8677   2609                     ; (opposite of each other)
8678   2609 32 A5 63            ld      (RIGHT_CONVEYER_DIR),a
8679   260C ED 44               neg     
8680   260E 32 A4 63            ld      (LEFT_CONVEYER_DIR),a
8681   2611                     
8682   2611                     ; If it is not time to update the motor animation, then return
8683   2611 3A 1A 60            ld      a,(COUNTER_2)
8684   2614 E6 1F               and     %00011111
8685   2616 C0                  ret     nz
8686   2617             		
8687   2617             		; Update the animation of the left and right conveyer motors
8688   2617 2D                  dec     l							; MID_MASTER_REVERSE_TIMER
8689   2618 11 EC 69            ld      de,CONV_MOTOR_SPRITE_MR
8690   261B EB                  ex      de,hl
8691   261C CD 4D 26            call    L_ANIMATE_MOTOR_SPRITES
8692   261F             
8693   261F C9                  ret    
8694   2620             ;------------------------------------------------------------------------------
8695   2620             
8696   2620             
8697   2620             		
8698   2620             ;------------------------------------------------------------------------------
8699   2620             ; This function controls the bottom conveyer belt and causes it to change directions
8700   2620             ; periodically.
8701   2620             ;
8702   2620             ; It also calls the animate motor function to animate the bottom two conveyer belt
8703   2620             ; motor sprite to simulate them rotating.
8704   2620             L_IMPLEMENT_BOT_CONVEYERS:  
8705   2620             		; If counter 2 is odd, jump ahead
8706   2620 3A 1A 60    		ld      a,(COUNTER_2)
8707   2623 0F                  rrca    
8708   2624 DA 34 26            jp      c,l268d
8709   2627                     
8710   2627                     ; Decrement the conveyer reverse countdown timer
8711   2627                     ; If it has not reached 0, jump ahead to skip reinitializing it
8712   2627                     ; and reversing the conveyer
8713   2627 21 A5 62            ld      hl,BOT_MASTER_REVERSE_TIMER
8714   262A 35                  dec     (hl)
8715   262B C2 34 26            jp      nz,l268d
8716   262E                     
8717   262E                     ; Reinitialize the timer
8718   262E 36 FF               ld      (hl),255
8719   2630                     
8720   2630                     ; Reverse the conveyer belt
8721   2630 2C                  inc     l
8722   2631 CD 85 26            call    L_REVERSE_CONVEYER_DIR
8723   2634                     
8724   2634                     
8725   2634 21 A6 62    l268d:  ld      hl,BOT_MASTER_CONVEYER_DIR
8726   2637 CD 90 26            call    L_SET_CONVEYER_SPEED_TO_1
8727   263A                     
8728   263A                     ; Set the direction and speed of the bottom conveyer
8729   263A 32 A6 63            ld      (BOT_CONVEYER_DIR),a
8730   263D                     
8731   263D                     ; If it is not time to update the conveyer motor animation
8732   263D                     ; return
8733   263D 3A 1A 60            ld      a,(COUNTER_2)
8734   2640 E6 1F               and     %00011111
8735   2642 FE 02               cp      2
8736   2644 C0                  ret     nz
8737   2645             		
8738   2645             		; Animate the two bottom conveyer motors
8739   2645 11 F4 69            ld      de,CONV_MOTOR_SPRITE_BL
8740   2648 EB                  ex      de,hl
8741   2649 CD 4D 26            call    L_ANIMATE_MOTOR_SPRITES
8742   264C C9                  ret     
8743   264D             ;------------------------------------------------------------------------------
8744   264D             
8745   264D             
8746   264D             ;------------------------------------------------------------------------------
8747   264D             ; Animate a pair of conveyer belt motor sprites by advancing them in the 
8748   264D             ; direction matching the conveyer belt's direction.
8749   264D             ;
8750   264D             ; passed:	hl - the address of the first of the two conveyer belt motor 
8751   264D             ;				sprites
8752   264D             ;			de - the address of the conveyer belt direction variable
8753   264D             ; Return:	a - the new motor sprite number
8754   264D             L_ANIMATE_MOTOR_SPRITES:  
8755   264D             		; If the conveyer belt is moving left, jump ahead
8756   264D 2C          		inc     l							; Sprite number
8757   264E 1A                  ld      a,(de)
8758   264F 17                  rla     
8759   2650 DA 6C 26            jp      c,l26c5
8760   2653             		
8761   2653             		; Handle the motor sprites when the conveyer belt it moving right
8762   2653             		
8763   2653             		; Advance to the next motor sprite to give the illusion that it is 
8764   2653             		; rotating
8765   2653 7E                  ld      a,(hl)
8766   2654 3C                  inc     a
8767   2655             		
8768   2655             		; If the motor sprite number does not need to be wrapped, jump ahead
8769   2655             		; to skip it
8770   2655 FE 53               cp      $53
8771   2657 C2 5C 26            jp      nz,l26b5
8772   265A             		
8773   265A             		; Wrap the motor sprite number to the first motor sprite
8774   265A 3E 50               ld      a,$50
8775   265C             		
8776   265C             		; Save the new motor sprite number
8777   265C 77          l26b5:  ld      (hl),a
8778   265D             
8779   265D             		; Advance to the opposite motor sprite sprite (it is flipped horizontally)
8780   265D 7D                  ld      a,l
8781   265E C6 04               add     a,4
8782   2660             		
8783   2660             		; Reverse to the previous motor sprite to give the illusion that it is
8784   2660             		; rotating
8785   2660 6F                  ld      l,a
8786   2661 7E                  ld      a,(hl)
8787   2662 3D                  dec     a
8788   2663             		
8789   2663             		; If the motor sprite number does not need to be wrapped, jump ahead
8790   2663             		; to skip it
8791   2663 FE CF               cp      $cf							; $4f flipped horizontally
8792   2665 C2 6A 26            jp      nz,l26c3
8793   2668             		
8794   2668             		; Wrap the motor sprite number
8795   2668 3E D2               ld      a,$d2						; $52 flipped horizontally
8796   266A             		
8797   266A             				
8798   266A             								
8799   266A             		; Handle the motor sprites when the conveyer belt is moving left
8800   266A             		
8801   266A             		; Save the new motor sprite
8802   266A 77          l26c3:  ld      (hl),a
8803   266B C9                  ret     
8804   266C             		
8805   266C             		; Reverse to the previous motor sprite to give the illusion that it is
8806   266C             		; rotating
8807   266C 7E          l26c5:  ld      a,(hl)
8808   266D 3D                  dec     a
8809   266E             		
8810   266E             		; If the motor sprite number does not need to be wrapped, jump ahead
8811   266E             		; to skip it
8812   266E FE 4F               cp      $4f
8813   2670 C2 75 26            jp      nz,l26ce
8814   2673             		
8815   2673             		; Wrap the motor sprite
8816   2673 3E 52               ld      a,$52
8817   2675             		
8818   2675             		; Save the new motor sprite
8819   2675 77          l26ce:  ld      (hl),a
8820   2676             
8821   2676             		; Advance to the opposite motor sprite (it is flipped horizontally)
8822   2676 7D                  ld      a,l
8823   2677 C6 04               add     a,4
8824   2679             		
8825   2679             		; Advance to the next motor sprite to give the illusion that it is
8826   2679             		; rotating
8827   2679 6F                  ld      l,a
8828   267A 7E                  ld      a,(hl)
8829   267B 3C                  inc     a
8830   267C             		
8831   267C             		; If the motor sprite number does not need to be wrapped, jump ahead
8832   267C             		; to skip it
8833   267C FE D3               cp      $d3							; $53 flipped horizontally
8834   267E C2 83 26            jp      nz,l26dc
8835   2681             		
8836   2681             		; Wrap the motor sprite number
8837   2681 3E D0               ld      a,$d0						; $50 flipped horizontally
8838   2683             		
8839   2683             		; Save the new motor sprite
8840   2683 77          l26dc:  ld      (hl),a
8841   2684 C9                  ret     
8842   2685             ;------------------------------------------------------------------------------
8843   2685             
8844   2685             
8845   2685             
8846   2685             ;------------------------------------------------------------------------------
8847   2685             ; Reverse the direction of a conveyer belt
8848   2685             ; passed:	hl - the address of the conveyer belt direction variable
8849   2685             L_REVERSE_CONVEYER_DIR:  
8850   2685             		; If the conveyer belt is moving right, jump ahead
8851   2685 CB 7E       		bit     7,(hl)
8852   2687 CA 8D 26            jp      z,l26e6
8853   268A             		
8854   268A             		; The conveyer belt is moving left, so reverse it to move right
8855   268A 36 02               ld      (hl),2
8856   268C C9                  ret  
8857   268D             		
8858   268D             		; The conveyer belt is moving right, so reverse it to move left
8859   268D 36 FE       l26e6:  ld      (hl),-2
8860   268F C9                  ret     
8861   2690             ;------------------------------------------------------------------------------
8862   2690             
8863   2690             
8864   2690             
8865   2690             ;------------------------------------------------------------------------------
8866   2690             ; Slow a conveyer belt speed to 1 pixel in the current direction
8867   2690             ;
8868   2690             ; passed:	hl - the address of the conveyer belt direction variable
8869   2690             ; return:	a - the conveyer belt speed and direction
8870   2690             L_SET_CONVEYER_SPEED_TO_1:  
8871   2690             		; Return if counter 2 is even
8872   2690 3A 1A 60    		ld      a,(COUNTER_2)
8873   2693 E6 01               and     %00000001
8874   2695 C8                  ret     z
8875   2696             		
8876   2696             		; If the conveyer belt is moving left, set the direction to -1
8877   2696 CB 7E               bit     7,(hl)
8878   2698 3E FF               ld      a,-1
8879   269A C2 9F 26            jp      nz,l26f8
8880   269D             		
8881   269D             		; The conveyer belt is moving right, so set the direction to 1
8882   269D 3E 01               ld      a,1
8883   269F 77          l26f8:  ld      (hl),a
8884   26A0 C9                  ret     
8885   26A1             ;------------------------------------------------------------------------------
8886   26A1             
8887   26A1             
8888   26A1             
8889   26A1             ;------------------------------------------------------------------------------
8890   26A1             ; Handle the elevators
8891   26A1             ; Move the elevators
8892   26A1             ; Detect when Mario is on an elevator
8893   26A1             ; Move Mario with the elevator
8894   26A1             ; Kill Mario if he reaches the bottom of the screen or is crushed at the top 
8895   26A1             ;	of the elevator
8896   26A1             ; Make Mario fall if he steps of the elevator
8897   26A1             L_IMPLEMENT_ELEVATORS:  
8898   26A1             		; Return unless this is the elevators stage
8899   26A1 3E 04       		ld      a,%00000100
8900   26A3 F7                  rst     $30		
8901   26A4                     
8902   26A4                     ; If Mario has reached the bottom of the screen,
8903   26A4                     ; jump ahead to kill him				
8904   26A4 3A 05 62            ld      a,(MARIO_Y)
8905   26A7 FE F0               cp      240
8906   26A9 D2 14 27            jp      nc,l277f
8907   26AC                     
8908   26AC             		; On odd cycles, 
8909   26AC             		; jump ahead to move the elevators
8910   26AC 3A 1A 60            ld      a,(COUNTER_2)
8911   26AF 0F          l271a:  rrca    
8912   26B0 DA B7 26            jp      c,l2722
8913   26B3                     
8914   26B3                     ; On even cycles,
8915   26B3                     ; jump ahead to move Mario on the elevators
8916   26B3 CD DA 26    l271e:  call    L_MOVE_MARIO_ON_ELEVATORS
8917   26B6 C9                  ret    
8918   26B7             		
8919   26B7             		; Move the elevators
8920   26B7 CD 2C 27    l2722:  call    L_MOVE_ELEVATORS
8921   26BA             		; Spawn a new elevator if it is time
8922   26BA CD 6F 27            call    L_SPAWN_NEW_ELEVATOR
8923   26BD                     
8924   26BD                     ; Update the elevator sprite coordinates to match the data structures
8925   26BD 06 06               ld      b,6							; 6 elevator platforms
8926   26BF 11 10 00            ld      de,16						; 16 byte data structures 
8927   26C2 21 58 69            ld      hl,ELEVATOR_PLATFORM_SPRITES
8928   26C5 DD 21 00 66         ld      ix,ELEVATOR_STRUCTS
8929   26C9 DD 7E 03    l2734:  ld      a,(ix+3)					; X coordinate
8930   26CC 77                  ld      (hl),a						; Sprite x coordinate
8931   26CD 2C                  inc     l
8932   26CE 2C                  inc     l
8933   26CF 2C                  inc     l							; Sprite y coordinate
8934   26D0 DD 7E 05            ld      a,(ix+5)					; Y coordinate
8935   26D3 77                  ld      (hl),a
8936   26D4 2C                  inc     l
8937   26D5                     
8938   26D5                     ; Advance to the next sprite
8939   26D5 DD 19               add     ix,de
8940   26D7 10 F0               djnz    l2734
8941   26D9 C9                  ret     
8942   26DA             ;------------------------------------------------------------------------------
8943   26DA             
8944   26DA             
8945   26DA             
8946   26DA             ;------------------------------------------------------------------------------
8947   26DA             ; Move Mario up or down with the elevators
8948   26DA             ; Checks if Mario has reached the very top or bottom of the elevator shaft
8949   26DA             ;	and kills him
8950   26DA             ; Make Mario fall if he steps off the platform
8951   26DA             L_MOVE_MARIO_ON_ELEVATORS:  
8952   26DA             		; Return if Mario is not riding an elevator
8953   26DA 3A 98 63    		ld      a,(MARIO_ON_ELEVATOR)
8954   26DD A7                  and     a
8955   26DE C8                  ret     z
8956   26DF             		
8957   26DF             		; Return if Mario is jumping
8958   26DF 3A 16 62            ld      a,(MARIO_IS_JUMPING)
8959   26E2 A7                  and     a
8960   26E3 C0                  ret     nz
8961   26E4             		
8962   26E4             		; If Mario has stepped off the left edge of the lefT elevator column,
8963   26E4             		; jump ahead to make him fall
8964   26E4 3A 03 62            ld      a,(MARIO_X)
8965   26E7 FE 2C               cp      44
8966   26E9 DA FB 26            jp      c,l2766
8967   26EC                     
8968   26EC                     ; If Mario is still on the left elevator column,
8969   26EC                     ; jump ahead to move him up with the elevators
8970   26EC FE 43               cp      67
8971   26EE DA 04 27            jp      c,l276f
8972   26F1                     
8973   26F1                     ; If Mario has stepped off the right edge of the left elevator column,
8974   26F1                     ; or the left edge of the right elevator column,
8975   26F1                     ; jump ahead to make him fall
8976   26F1 FE 6C               cp      108
8977   26F3 DA FB 26            jp      c,l2766
8978   26F6                     
8979   26F6                     ; If Mario is still on the right elevator column,
8980   26F6                     ; jump ahead to move him down with the elevators
8981   26F6 FE 83               cp      131
8982   26F8 DA 1C 27            jp      c,l2787
8983   26FB                     
8984   26FB                     ; Mario has stepped off the right edge of the right elevator column
8985   26FB             		; Mark Mario as no longer riding the elevators
8986   26FB AF          l2766:  xor     a
8987   26FC 32 98 63            ld      (MARIO_ON_ELEVATOR),a
8988   26FF                     
8989   26FF                     ; Mark Mario as falling
8990   26FF 3C                  inc     a
8991   2700 32 21 62            ld      (MARIO_IS_FALLING),a
8992   2703 C9                  ret     
8993   2704             		
8994   2704             		; Mario is riding the left elevator column
8995   2704             		
8996   2704             		; If Mario has been smashed at the top of the elevator,
8997   2704             		; jump ahead to kill him
8998   2704 3A 05 62    l276f:  ld      a,(MARIO_Y)
8999   2707 FE 71               cp      113
9000   2709 DA 14 27            jp      c,l277f
9001   270C 3D                  dec     a
9002   270D             		
9003   270D             		; Move Mario up with the elevator
9004   270D 32 05 62            ld      (MARIO_Y),a
9005   2710 32 4F 69            ld      (MARIO_SPRITE_Y),a
9006   2713 C9                  ret   
9007   2714             		
9008   2714             		; Mark Mario as dead
9009   2714 AF          l277f:  xor     a
9010   2715 32 00 62            ld      (MARIO_ALIVE),a
9011   2718             		
9012   2718             		; Mark Mario as no longer on the elevator
9013   2718 32 98 63            ld      (MARIO_ON_ELEVATOR),a
9014   271B C9                  ret     
9015   271C             		
9016   271C             		; Mario is riding the right elevator column
9017   271C             		
9018   271C             		; If Mario has reached the bottom of the the elevator column,
9019   271C             		; jump back up to kill him
9020   271C 3A 05 62    l2787:  ld      a,(MARIO_Y)
9021   271F FE E8               cp      232
9022   2721 D2 14 27            jp      nc,l277f
9023   2724             		
9024   2724             		; Move Mario down with the elevator
9025   2724 3C                  inc     a
9026   2725 32 05 62            ld      (MARIO_Y),a
9027   2728 32 4F 69            ld      (MARIO_SPRITE_Y),a
9028   272B C9                  ret     
9029   272C             ;------------------------------------------------------------------------------
9030   272C             
9031   272C             
9032   272C             
9033   272C             ;------------------------------------------------------------------------------
9034   272C             ; Move the elevators
9035   272C             ; When an elevator reaches the top of the left column it is sent to the top of
9036   272C             ; the right column
9037   272C             ; When an elevator reaches the bottom of the right column, it is deactivated
9038   272C             L_MOVE_ELEVATORS:  
9039   272C             		; Iterate over each elevator platform
9040   272C 06 06       		ld      b,6							; 6 elevator sprites
9041   272E 11 10 00            ld      de,16						; 16 byte data structures
9042   2731 DD 21 00 66         ld      ix,ELEVATOR_STRUCTS
9043   2735             		
9044   2735             		; If this elevator is inactive,
9045   2735             		; jump ahead to process the next one
9046   2735 DD CB 00 46 l27a0:  bit     0,(ix+0)					
9047   2739 CA 57 27            jp      z,l27c2
9048   273C             		
9049   273C             		; If the elevator is moving down,
9050   273C             		; jump ahead to skip the moving up logic
9051   273C DD CB 0D 5E         bit     3,(ix+13)					; Direction
9052   2740 CA 5C 27            jp      z,l27c7
9053   2743             
9054   2743             		; The elevator is moving up
9055   2743             		
9056   2743             		; Move the elevator one pixel up
9057   2743 DD 7E 05            ld      a,(ix+5)					; Y coordinate
9058   2746 3D                  dec     a
9059   2747 DD 77 05    		ld      (ix+5),a
9060   274A             		
9061   274A             		; If the elevator has not reached the top, 
9062   274A             		; jump ahead
9063   274A FE 60               cp      96
9064   274C C2 57 27            jp      nz,l27c2
9065   274F             		
9066   274F             		; Move the elevator to the top of the right column
9067   274F DD 36 03 77         ld      (ix+3),119					; X coordinate
9068   2753 DD 36 0D 04         ld      (ix+13),4					; Direction
9069   2757             		
9070   2757             		; Process the next elevator platform
9071   2757 DD 19       l27c2:  add     ix,de
9072   2759 10 DA               djnz    l27a0
9073   275B C9                  ret  
9074   275C             		
9075   275C             		; The elevator is moving down
9076   275C             		
9077   275C             		; Move the elevator one pixel down
9078   275C DD 7E 05    l27c7:  ld      a,(ix+5)
9079   275F 3C                  inc     a
9080   2760 DD 77 05            ld      (ix+5),a
9081   2763             		
9082   2763             		; If the elevator has not reached the bottom,
9083   2763             		; jump back up to process the next elevator
9084   2763 FE F8               cp      248
9085   2765 C2 57 27            jp      nz,l27c2
9086   2768             		
9087   2768             		; Deactivate this elevator and process the next one
9088   2768 DD 36 00 00         ld      (ix+0),0					; Inactive
9089   276C C3 57 27            jp      l27c2
9090   276F             ;------------------------------------------------------------------------------
9091   276F             
9092   276F             
9093   276F             		
9094   276F             ;------------------------------------------------------------------------------
9095   276F             ; Spawns a new elevator when the elevator spawn timer reaches 0
9096   276F             L_SPAWN_NEW_ELEVATOR:  
9097   276F             		; If it is not time to spawn an elevator, 
9098   276F             		; jump ahead to decrement the spawn timer
9099   276F 21 A7 62    		ld      hl,ELEVATOR_SPAWN_TIMER
9100   2772 7E                  ld      a,(hl)
9101   2773 A7                  and     a
9102   2774 C2 9B 27            jp      nz,l2806
9103   2777             		
9104   2777             		; Search for the first available elevator data structure
9105   2777 06 06               ld      b,6							; 6 elevator platforms
9106   2779 DD 21 00 66         ld      ix,ELEVATOR_STRUCTS
9107   277D             
9108   277D             		; If this elevator is inactive, 
9109   277D             		; jump ahead to use it
9110   277D DD CB 00 46 l27e8:  bit     0,(ix+0)
9111   2781 CA 89 27            jp      z,l27f4
9112   2784             		
9113   2784             		; Check the next elevator
9114   2784 DD 19               add     ix,de
9115   2786 10 F5               djnz    l27e8
9116   2788 C9                  ret   
9117   2789             		
9118   2789             		; Spawn the elevator at the bottom of the left column
9119   2789 DD 36 00 01 l27f4:  ld      (ix+0),1					; Active
9120   278D DD 36 03 37         ld      (ix+3),55					; X coordinate
9121   2791 DD 36 05 F8         ld      (ix+5),248					; Y coordinate
9122   2795 DD 36 0D 08         ld      (ix+13),8					; Moving up
9123   2799 36 34               ld      (hl),52						; ELEVATOR_SPAWN_TIMER
9124   279B             		
9125   279B             		; Decrement the elevator spawn timer
9126   279B 35          l2806:  dec     (hl)						; ELEVATOR_SPAWN_TIMER
9127   279C C9                  ret     
9128   279D             ;------------------------------------------------------------------------------
9129   279D             
9130   279D             
9131   279D             ;------------------------------------------------------------------------------
9132   279D             ; Check if Mario has come in contact with an enemy and kill him
9133   279D             L_CHECK_FOR_ENEMY_COLLISION:  
9134   279D             		; If Mario has not contacted any enemy,
9135   279D             		; return
9136   279D FD 21 00 62 		ld      iy,MARIO_DATA_STRUCT
9137   27A1 3A 05 62            ld      a,(MARIO_Y)
9138   27A4 4F                  ld      c,a
9139   27A5 21 07 04            ld      hl,$0407					; 8x14 collision boundary
9140   27A8 CD 04 28            call    L_IMPL_ENEMY_COLL_FOR_STAGE
9141   27AB A7                  and     a
9142   27AC C8                  ret     z
9143   27AD             		
9144   27AD             		; Mario has contacted an enemy
9145   27AD             		
9146   27AD             		; Mark Mario as dead
9147   27AD 3D                  dec     a
9148   27AE 32 00 62            ld      (MARIO_ALIVE),a
9149   27B1 C9                  ret     
9150   27B2             ;------------------------------------------------------------------------------
9151   27B2             
9152   27B2             
9153   27B2             ;------------------------------------------------------------------------------
9154   27B2             ; Check if Mario has struck an enemy with the hammer
9155   27B2             L_CHECK_FOR_HAMMER_KILL:  
9156   27B2             		; Examine each hammer
9157   27B2 06 02       		ld      b,2							; 2 hammers
9158   27B4 11 10 00            ld      de,16						; 16 byte data structures
9159   27B7 FD 21 80 66         ld      iy,HAMMER_STRUCTS
9160   27BB             
9161   27BB             		; If Mario has this hammer, jump ahead to handle it
9162   27BB FD CB 01 46 l2826:  bit     0,(iy+1)
9163   27BF C2 C7 27            jp      nz,l2832
9164   27C2             		
9165   27C2             		; Check the next hammer
9166   27C2 FD 19               add     iy,de
9167   27C4 10 F5               djnz    l2826						; Next b
9168   27C6 C9                  ret     
9169   27C7             
9170   27C7             		; If the hammer has not hit an enemy, 
9171   27C7             		; return
9172   27C7 FD 4E 05    l2832:  ld      c,(iy+5)					; Hammer y coordinate
9173   27CA FD 66 09            ld      h,(iy+9)					; Collision boundary x radius
9174   27CD FD 6E 0A            ld      l,(iy+10)					; Collision boundary y radius
9175   27D0 CD 04 28            call    L_IMPL_ENEMY_COLL_FOR_STAGE
9176   27D3 A7                  and     a
9177   27D4 C8                  ret     z
9178   27D5             		
9179   27D5             		; The hammer has struck an enemy
9180   27D5             		
9181   27D5             		; Activate the smash animation sequence
9182   27D5 32 50 63            ld      (SMASH_ANIMATION_ACTIVE),a
9183   27D8             		
9184   27D8             		; Calculate the index of the enemy that was struck
9185   27D8 3A B9 63            ld      a,(NUM_ENEMIES_OF_CURRENT_CLASS)
9186   27DB 90                  sub     b
9187   27DC 32 54 63            ld      (SMASH_ANIMATION_ENEMY_INDEX),a
9188   27DF             		
9189   27DF             		; Save the structure size
9190   27DF 7B                  ld      a,e							; Data structure size in bytes
9191   27E0 32 53 63            ld      (SMASH_ENEMY_DATA_SIZE),a
9192   27E3             		
9193   27E3             		; Save a pointer to the first entry in the enemy's class data structures
9194   27E3 DD 22 51 63         ld      (SMASH_ENEMY_CLASS_POINTER),ix
9195   27E7 C9                  ret     
9196   27E8             ;------------------------------------------------------------------------------
9197   27E8             
9198   27E8             
9199   27E8             
9200   27E8             ;------------------------------------------------------------------------------
9201   27E8             ; Check if Mario has jumped over an enemy
9202   27E8             L_CHECK_FOR_ENEMY_JUMP:  
9203   27E8             		; Setup the collision check
9204   27E8 FD 21 00 62 		ld      iy,MARIO_DATA_STRUCT
9205   27EC 3A 05 62            ld      a,(MARIO_Y)
9206   27EF             		
9207   27EF             		; Setup the boundary 12 pixels below Mario
9208   27EF C6 0C               add     a,12
9209   27F1 4F                  ld      c,a
9210   27F2             		
9211   27F2             		; If the player is not pressing left or right, 
9212   27F2             		; jump ahead to use a normal sized boundary
9213   27F2 3A 10 60            ld      a,(PLAYER_INPUT)
9214   27F5 E6 03               and     %00000011
9215   27F7 21 08 05            ld      hl,TWO_BYTES(5, 8)			; 10x16 boundary
9216   27FA CA 00 28            jp      z,l286b
9217   27FD             		
9218   27FD             		; If the player is pressing left or right,
9219   27FD             		; use a wider boundary
9220   27FD 21 08 13            ld      hl,TWO_BYTES(19,8)			; 28x16 boundary
9221   2800             
9222   2800             		; Check if Mario has jumped over an enemy
9223   2800 CD FA 3D    l286b:  call    l3e88
9224   2803 C9                  ret     
9225   2804             ;------------------------------------------------------------------------------
9226   2804             
9227   2804             
9228   2804             
9229   2804             ;------------------------------------------------------------------------------
9230   2804             ; Check for collisions with enemies specific to the current stage
9231   2804             L_IMPL_ENEMY_COLL_FOR_STAGE:  
9232   2804 3A 27 62    		ld      a,(CURRENT_STAGE)
9233   2807 E5                  push    hl
9234   2808 EF                  rst     $28							; Jump to local table address
9235   2809                     ; Jump table
9236   2809 00 00       		.word	L_ORG	; 0 = reset game
9237   280B 15 28       		.word	L_BARREL_ENEMY_COLLISION	; 1 = barrels stage
9238   280D 43 28       		.word	L_MIXER_ENEMY_COLLISION		; 2 = mixer stage
9239   280F 71 28       		.word	L_ELEVATOR_ENEMY_COLLISION	; 3 = elevators stage
9240   2811 92 28       		.word	L_RIVETS_ENEMY_COLLISION	; 4 = rivets stage
9241   2813 00 00       		.word	L_ORG	; 5 = reset game
9242   2815             ;------------------------------------------------------------------------------
9243   2815             
9244   2815             
9245   2815             
9246   2815             ;------------------------------------------------------------------------------
9247   2815             ; Check for collisions with enemies on the barrels stage
9248   2815             L_BARREL_ENEMY_COLLISION:  
9249   2815 E1          		pop     hl							; Collision boundary size
9250   2816             		
9251   2816             		; Return if there has been a collision with a barrel
9252   2816 06 0A               ld      b,10						; 10 barrels
9253   2818 78                  ld      a,b
9254   2819 32 B9 63            ld      (NUM_ENEMIES_OF_CURRENT_CLASS),a
9255   281C 11 20 00            ld      de,32						; 32 byte data size
9256   281F DD 21 00 67         ld      ix,BARREL_STRUCTS
9257   2823 CD A4 28            call    L_CHECK_FOR_COLLISION
9258   2826             		
9259   2826             		; Return if there has been a collision with a fire ball
9260   2826 06 05               ld      b,5							; 5 fire balls
9261   2828 78                  ld      a,b
9262   2829 32 B9 63            ld      (NUM_ENEMIES_OF_CURRENT_CLASS),a
9263   282C 1E 20               ld      e,32						; 32 byte data size
9264   282E DD 21 00 64         ld      ix,FIREBALL_STRUCTS
9265   2832 CD A4 28            call    L_CHECK_FOR_COLLISION
9266   2835             		
9267   2835             		; Return if there has been a collision with the barrel fire
9268   2835 06 01               ld      b,1							; 1 barrel fire
9269   2837 78                  ld      a,b
9270   2838 32 B9 63            ld      (NUM_ENEMIES_OF_CURRENT_CLASS),a
9271   283B             		; NOTE: The following instruction can probably be removed
9272   283B             ;        ld      e,0							; Only 1 structure - this is not needed
9273   283B DD 21 A0 66         ld      ix,BARREL_FIRE_STRUCT
9274   283F CD A4 28            call    L_CHECK_FOR_COLLISION
9275   2842             
9276   2842             		; Return with no collision detected
9277   2842 C9                  ret     
9278   2843             ;------------------------------------------------------------------------------
9279   2843             
9280   2843             
9281   2843             
9282   2843             ;------------------------------------------------------------------------------
9283   2843             ; Check for collisions on the mixer stage
9284   2843             L_MIXER_ENEMY_COLLISION:  
9285   2843 E1          		pop     hl							; Collision boundary size
9286   2844             		
9287   2844             		; Return if there has been a collision with a fire ball
9288   2844 06 05               ld      b,5							; 5 fire balls	
9289   2846 78                  ld      a,b
9290   2847 32 B9 63            ld      (NUM_ENEMIES_OF_CURRENT_CLASS),a
9291   284A 11 20 00            ld      de,32						; 32 byte data size
9292   284D DD 21 00 64         ld      ix,FIREBALL_STRUCTS
9293   2851 CD A4 28            call    L_CHECK_FOR_COLLISION
9294   2854             		
9295   2854             		; Return if there has been a collision with a "pie"
9296   2854 06 06               ld      b,6							; 6 pies
9297   2856 78                  ld      a,b
9298   2857 32 B9 63            ld      (NUM_ENEMIES_OF_CURRENT_CLASS),a
9299   285A 1E 10               ld      e,16						; 16 byte data structure
9300   285C DD 21 A0 65         ld      ix,PIE_STRUCTS
9301   2860 CD A4 28            call    L_CHECK_FOR_COLLISION
9302   2863             		
9303   2863             		; Return if there has been a collision with the barrel fire
9304   2863 06 01               ld      b,1							; 1 barrel fire
9305   2865 78                  ld      a,b
9306   2866 32 B9 63            ld      (NUM_ENEMIES_OF_CURRENT_CLASS),a
9307   2869             		; NOTE: The following instruction can probably be removed
9308   2869             ;        ld      e,0							; Only 1 structure - this is not needed
9309   2869 DD 21 A0 66         ld      ix,BARREL_FIRE_STRUCT
9310   286D CD A4 28            call    L_CHECK_FOR_COLLISION
9311   2870             		
9312   2870             		; Return with no collision detected
9313   2870 C9                  ret     
9314   2871             ;------------------------------------------------------------------------------
9315   2871             
9316   2871             
9317   2871             
9318   2871             ;------------------------------------------------------------------------------
9319   2871             ; Check for collisions on the elevators stage
9320   2871             L_ELEVATOR_ENEMY_COLLISION:  
9321   2871 E1          		pop     hl							; Collision boundary size
9322   2872             		
9323   2872             		; Return if there has been a collision with a fire ball
9324   2872 06 05               ld      b,5							; 5 fire balls
9325   2874 78                  ld      a,b
9326   2875 32 B9 63            ld      (NUM_ENEMIES_OF_CURRENT_CLASS),a
9327   2878 11 20 00            ld      de,32						; 32 byte data size
9328   287B DD 21 00 64         ld      ix,FIREBALL_STRUCTS
9329   287F CD A4 28            call    L_CHECK_FOR_COLLISION
9330   2882             		
9331   2882             		; Return if there has been a collision with a spring
9332   2882 06 0A               ld      b,10						; 10 springs
9333   2884 78                  ld      a,b
9334   2885 32 B9 63            ld      (NUM_ENEMIES_OF_CURRENT_CLASS),a
9335   2888 1E 10               ld      e,16						; 16 byte data size
9336   288A DD 21 00 65         ld      ix,SPRING_STRUCTS
9337   288E CD A4 28            call    L_CHECK_FOR_COLLISION
9338   2891             		
9339   2891             		; Return with no collision detected
9340   2891 C9                  ret     
9341   2892             ;------------------------------------------------------------------------------
9342   2892             
9343   2892             		
9344   2892             		
9345   2892             ;------------------------------------------------------------------------------
9346   2892             ; Check for collisions on the rivets stage
9347   2892             L_RIVETS_ENEMY_COLLISION:  
9348   2892 E1          		pop     hl							; Collision boundary size
9349   2893             		
9350   2893             		; Return if there has been a collision with a fire ball
9351   2893 06 07               ld      b,7							; 7 fire balls
9352   2895 78                  ld      a,b
9353   2896 32 B9 63            ld      (NUM_ENEMIES_OF_CURRENT_CLASS),a
9354   2899 11 20 00            ld      de,32						; 32 byte data size
9355   289C DD 21 00 64         ld      ix,FIREBALL_STRUCTS
9356   28A0 CD A4 28            call    L_CHECK_FOR_COLLISION
9357   28A3             		
9358   28A3             		; Return with no collision detected
9359   28A3 C9                  ret     
9360   28A4             ;------------------------------------------------------------------------------
9361   28A4             
9362   28A4             
9363   28A4             
9364   28A4             ;------------------------------------------------------------------------------
9365   28A4             ; Check for collision between 1 sprite (Mario/Hammer) and a group of sprites
9366   28A4             ; (enemies)
9367   28A4             ; passed:	b - the number of enemies to process
9368   28A4             ;			c - y coordinate
9369   28A4             ;			de - the size of the structure
9370   28A4             ;			h - the collision boundary width (radius)
9371   28A4             ;			l - the collision boundary height (radius)
9372   28A4             ;			ix - pointer to the first enemy sprite
9373   28A4             ;			iy - pointer to the start of the prime sprite data structure
9374   28A4             ; return:	a - 1 if a collision occurred,
9375   28A4             ;				0 otherwise
9376   28A4             L_CHECK_FOR_COLLISION:  
9377   28A4 DD E5       		push    ix
9378   28A6             
9379   28A6             		; If the current enemy sprite is inactive, jump ahead to check the next one
9380   28A6 DD CB 00 46 l2915:  bit     0,(ix+0)					; Active flag
9381   28AA CA DC 28            jp      z,l294c
9382   28AD             		
9383   28AD             		; Calculate the absolute difference between 
9384   28AD             		; the primary sprite's y coordinate and
9385   28AD             		; the enemy sprite's y coordinate
9386   28AD 79                  ld      a,c
9387   28AE DD 96 05            sub     (ix+5)						; Y coordinate
9388   28B1 D2 B6 28            jp      nc,l2925
9389   28B4 ED 44               neg     
9390   28B6             
9391   28B6             		; If the primary sprite's vertical collision boundary 
9392   28B6             		; encompasses the center of the enemy sprite,
9393   28B6             		; jump ahead
9394   28B6 3C          l2925:  inc     a
9395   28B7 95                  sub     l							; Boundary height
9396   28B8 DA C1 28            jp      c,l2930
9397   28BB             		
9398   28BB             		; If the boundaries don't overlap vertically, 
9399   28BB             		; jump ahead to process the next enemy
9400   28BB DD 96 0A            sub     (ix+10)						; Enemy boundary height
9401   28BE D2 DC 28            jp      nc,l294c
9402   28C1             		
9403   28C1             		; Calculate the absolute difference between 
9404   28C1             		; the primary sprite's x coordinate and
9405   28C1             		; the enemy sprite's x coordinate
9406   28C1 FD 7E 03    l2930:  ld      a,(iy+3)					; X coordinate
9407   28C4 DD 96 03            sub     (ix+3)						; X coordinate
9408   28C7 D2 CC 28    		jp      nc,l293b
9409   28CA ED 44       		neg     
9410   28CC             		
9411   28CC             		; If the primary sprite's horizontal collision boundary
9412   28CC             		; encompasses the center of the enemy sprite
9413   28CC             		; jump ahead
9414   28CC 94          l293b:  sub     h							; Boundary width
9415   28CD DA D6 28            jp      c,l2945
9416   28D0             		
9417   28D0             		; If the boundaries don't ovelap horizontally,
9418   28D0             		; jump ahead to process the next enemy
9419   28D0 DD 96 09            sub     (ix+9)						; Enemy boundary width
9420   28D3 D2 DC 28            jp      nc,l294c
9421   28D6             		
9422   28D6             		; Indicate that a collision has ocurred
9423   28D6 3E 01       l2945:  ld      a,1
9424   28D8 DD E1               pop     ix
9425   28DA             		
9426   28DA             		; Return from the calling function
9427   28DA E1                  pop		hl
9428   28DB C9                  ret  
9429   28DC             		
9430   28DC             		; Process the next enemy sprite
9431   28DC DD 19       l294c:  add     ix,de
9432   28DE 10 C6               djnz    l2915
9433   28E0                     
9434   28E0                     ; Indicate that a collision did not occur
9435   28E0 AF                  xor     a
9436   28E1 DD E1               pop     ix
9437   28E3 C9                  ret     
9438   28E4             ;------------------------------------------------------------------------------
9439   28E4             
9440   28E4             
9441   28E4             
9442   28E4             ;------------------------------------------------------------------------------
9443   28E4             ; Implements the logic that checks for Mario grabbing a hammer and then 
9444   28E4             ; triggers the hammer cycle to start
9445   28E4             L_IMPLEMENT_HAMMER_GRAB:  
9446   28E4             		; Return unless this is the barrels stage, mixer stage, or rivets stage
9447   28E4 3E 0B       		ld      a,%00001011
9448   28E6 F7                  rst     $30							
9449   28E7                     
9450   28E7             		; Check if a hammer has been grabbed
9451   28E7             		; Return if no hammer has been grabbed
9452   28E7 CD 04 29    		call    L_CHECK_FOR_HAMMER_GRAB
9453   28EA             
9454   28EA             		; Set the hammer grabbed flag to true
9455   28EA 32 18 62            ld      (HAMMER_GRABBED),a
9456   28ED             		
9457   28ED             		; Trigger the award sound to play
9458   28ED 0F                  rrca    
9459   28EE 0F                  rrca    							; $04
9460   28EF 32 85 60            ld      (AWARD_SOUND_TRIGGER),a
9461   28F2             		
9462   28F2             		; If no hammer was grabbed, return?
9463   28F2 78                  ld      a,b
9464   28F3 A7                  and     a
9465   28F4 C8                  ret     z
9466   28F5             		
9467   28F5             		; If the second hammer was grabbed, jump ahead to mark it as taken
9468   28F5 FE 01               cp      1
9469   28F7 CA FF 28            jp      z,l296f
9470   28FA             		
9471   28FA             		; Mark the first hammer as grabbed
9472   28FA DD 36 01 01         ld      (ix+1),1					; Hammer grabbed
9473   28FE C9                  ret     
9474   28FF             		
9475   28FF             		; Mark the second hammer as grabbed
9476   28FF DD 36 11 01 l296f:  ld      (ix+17),1					; Hammer grabbed
9477   2903 C9                  ret     
9478   2904             ;------------------------------------------------------------------------------
9479   2904             
9480   2904             
9481   2904             
9482   2904             ;------------------------------------------------------------------------------
9483   2904             ; Detect when a hammer has been grabbed by checking if Mario has "collided" 
9484   2904             ; with a hammer.
9485   2904             ; 
9486   2904             ; return:	a - 1 if a hammer has been grabbed
9487   2904             ;			b - 0 if no hammer was grabbed
9488   2904             ;				1 if the second hammer was grabbed
9489   2904             ;				2 if the first hammer was grabbed
9490   2904             ;			ix - pointing to the first hammer data structure
9491   2904             L_CHECK_FOR_HAMMER_GRAB:  
9492   2904 FD 21 00 62 		ld      iy,MARIO_DATA_STRUCT
9493   2908 3A 05 62            ld      a,(MARIO_Y)
9494   290B 4F                  ld      c,a
9495   290C 21 08 04            ld      hl,TWO_BYTES(4,8)			; 8x16 collision area
9496   290F 06 02               ld      b,2							; 2 hammers
9497   2911 11 10 00            ld      de,16						; 16 byte data structures
9498   2914 DD 21 80 66         ld      ix,HAMMER_STRUCTS
9499   2918 CD A4 28            call    L_CHECK_FOR_COLLISION
9500   291B C9                  ret     
9501   291C             ;------------------------------------------------------------------------------
9502   291C             
9503   291C             
9504   291C             
9505   291C             ;------------------------------------------------------------------------------
9506   291C             ; Checks if the current fireball is attempting to move off a girder into
9507   291C             ; empty air.  
9508   291C             ; return:	a - 0 if the tile the fireball is moving onto is a girder
9509   291C             ;				1 if it is not
9510   291C             L_CHECK_IF_NOT_SUPPORTED:  
9511   291C             		; Get the fireball's next intended x coordinate
9512   291C 2A C8 63    		ld      hl,(CURRENT_FIREBALL)
9513   291F 7D                  ld      a,l
9514   2920 C6 0E               add     a,14						; Next intended x coordinate
9515   2922 6F                  ld      l,a
9516   2923 56                  ld      d,(hl)
9517   2924             		
9518   2924             		; Get the fireball's y coordinate + 12
9519   2924 2C                  inc     l							; Next intended y coordinate
9520   2925 7E                  ld      a,(hl)
9521   2926 C6 0C               add     a,12
9522   2928 5F                  ld      e,a
9523   2929             		
9524   2929             		; Convert the fireball coordinate to a screen memory address
9525   2929 EB                  ex      de,hl
9526   292A CD 73 2F            call    L_STAGE_LOC_TO_ADDRESS
9527   292D 7E                  ld      a,(hl)
9528   292E             		
9529   292E             		; If the tile is less than the girder tiles,
9530   292E             		; jump ahead to return a as 1
9531   292E FE B0               cp      $b0
9532   2930 DA 3C 29            jp      c,l29ac
9533   2933             		
9534   2933             		; If the tile is outside the block of girder tiles,
9535   2933             		; jump ahead to return a as 1
9536   2933 E6 0F               and     %00001111
9537   2935 FE 08               cp      $08
9538   2937 D2 3C 29            jp      nc,l29ac
9539   293A             		
9540   293A             		; The tile is a girder tile
9541   293A             		; Return a as 0
9542   293A AF                  xor     a
9543   293B C9                  ret     
9544   293C             
9545   293C             		; The tile is not a girder
9546   293C             		; Return a as 1
9547   293C 3E 01       l29ac:  ld      a,1
9548   293E C9                  ret     
9549   293F             ;------------------------------------------------------------------------------
9550   293F             
9551   293F             
9552   293F             
9553   293F             ;------------------------------------------------------------------------------
9554   293F             ; Handle Mario's interaction with the elevators.
9555   293F             ; Detect when Mario has landed on an elevator platform and flag him as riding it
9556   293F             ; Detect when Mario has struck the bottom of an elevator platform with his head
9557   293F             ;	and kill him
9558   293F             ; Detect when Mario has hit the side of an elevator? and stop him?
9559   293F             ; return:	a - 1 if Mario has interacted with an elevator
9560   293F             ;			b - 1 if Mario is riding an elevator?
9561   293F             L_INTERACT_WITH_ELEVATORS:  
9562   293F             		; Return unless this is the elevators stage
9563   293F 3E 04       		ld      a,%00000100
9564   2941 F7                  rst     $30		
9565   2942                     
9566   2942             		; If Mario has not collided with an elevator platform,
9567   2942             		; jump ahead to return a and b as 0
9568   2942 FD 21 00 62         ld      iy,MARIO_DATA_STRUCT
9569   2946 3A 05 62            ld      a,(MARIO_Y)
9570   2949 4F                  ld      c,a
9571   294A 21 08 04            ld      hl,TWO_BYTES(4,8)			; 8x16 collision area
9572   294D CD B0 29            call    L_CHECK_FOR_ELEVATOR_COLLISION
9573   2950 A7                  and     a
9574   2951 CA AE 29            jp      z,l2a20
9575   2954             		
9576   2954             		; Calculate the index of the elevator Mario has collided with
9577   2954 3E 06               ld      a,6
9578   2956             		
9579   2956             		; If the correct index has been found, jump ahead
9580   2956 90                  sub     b
9581   2957 CA 60 29    l29c7:  jp      z,l29d0
9582   295A             
9583   295A             		; Advance to the next elevator index
9584   295A DD 19               add     ix,de
9585   295C 3D                  dec     a
9586   295D C3 57 29            jp      l29c7
9587   2960             
9588   2960             		; If Mario is not above the top of the elevator platform,
9589   2960             		; jump ahead
9590   2960             		; (This is a rough and generous collision detection, as the boundaries
9591   2960             		; are shifted to make it easier for Mario to get onto the platform)
9592   2960 DD 7E 05    l29d0:  ld      a,(ix+5)					; Y coordinate of elevator
9593   2963 D6 04               sub     4							; Shift the boundary up 4 pixels
9594   2965 57                  ld      d,a
9595   2966 3A 0C 62            ld      a,($620c)
9596   2969 C6 05               add     a,5							; Allow Mario to overlap the elevator by 3 pixels
9597   296B BA                  cp      d
9598   296C D2 7D 29            jp      nc,l29ee
9599   296F             		
9600   296F             		; Move Mario to stand directly on the platform
9601   296F 7A                  ld      a,d
9602   2970 D6 08               sub     8
9603   2972 32 05 62            ld      (MARIO_Y),a
9604   2975             		
9605   2975             		; Indicate that Mario is now riding an elevator platform
9606   2975 3E 01               ld      a,1
9607   2977 47                  ld      b,a
9608   2978 32 98 63            ld      (MARIO_ON_ELEVATOR),a
9609   297B             		
9610   297B             		; Return from the calling function
9611   297B E1                  pop		hl
9612   297C C9                  ret     
9613   297D             
9614   297D             		; If Mario has struck the bottom of a platform with his head,
9615   297D             		; jump ahead to kill him
9616   297D 3A 0C 62    l29ee:  ld      a,($620c)
9617   2980 D6 0E               sub     14							; Allow some overlap
9618   2982 BA                  cp      d
9619   2983 D2 A9 29            jp      nc,l2a1b
9620   2986             		
9621   2986             		; Detect if Mario has struck the side of an elevator platform
9622   2986             		
9623   2986             		; If Mario is jumping to the right, jump ahead to handle it
9624   2986 3A 10 62            ld      a,(MARIO_JUMPING_LEFT)
9625   2989 A7                  and     a
9626   298A 3A 03 62            ld      a,(MARIO_X)
9627   298D CA 97 29            jp      z,l2a08
9628   2990             		
9629   2990             		; Mario is jumping left
9630   2990             		; Adjust his x coordinate to stop at the right edge of the platform
9631   2990 F6 07               or      %00000111
9632   2992 D6 04               sub     4
9633   2994             		
9634   2994             		; Jump ahead to update Mario's x coordinate
9635   2994 C3 9D 29            jp      l2a0e
9636   2997             		
9637   2997             		; Mario is jumping right
9638   2997             		; Adjust his x coordinate to stop at the left edge of the platform
9639   2997 D6 08       l2a08:  sub     8
9640   2999 F6 07               or      %00000111
9641   299B C6 04               add     a,4
9642   299D             		
9643   299D             		; Update Mario's x coordinate
9644   299D 32 03 62    l2a0e:  ld      (MARIO_X),a
9645   29A0 32 4C 69            ld      (MARIO_SPRITE_X),a
9646   29A3                     
9647   29A3             		; Return a = 1 and b = 0
9648   29A3 3E 01       		ld      a,1
9649   29A5 06 00               ld      b,0
9650   29A7             		
9651   29A7             		; Return from the calling function
9652   29A7 E1                  pop		hl
9653   29A8 C9                  ret     
9654   29A9             		
9655   29A9             		; Mark Mario as dead and return a and b = 0
9656   29A9 AF          l2a1b:  xor     a
9657   29AA 32 00 62            ld      (MARIO_ALIVE),a
9658   29AD C9                  ret     
9659   29AE             
9660   29AE             		; Return a and b = 0
9661   29AE 47          l2a20:  ld      b,a
9662   29AF C9                  ret     
9663   29B0             ;------------------------------------------------------------------------------
9664   29B0             
9665   29B0             
9666   29B0             
9667   29B0             ;------------------------------------------------------------------------------
9668   29B0             ; Check for a collision between Mario and an elevator platform
9669   29B0             ; return: 	a - 1 if a collision has occurred
9670   29B0             L_CHECK_FOR_ELEVATOR_COLLISION:  
9671   29B0 06 06       		ld      b,6								; 6 elevator platforms
9672   29B2 11 10 00            ld      de,16							; 16 byte data structures
9673   29B5 DD 21 00 66         ld      ix,ELEVATOR_STRUCTS
9674   29B9 CD A4 28            call    L_CHECK_FOR_COLLISION
9675   29BC C9                  ret     
9676   29BD             ;------------------------------------------------------------------------------
9677   29BD             
9678   29BD             
9679   29BD             
9680   29BD             ;------------------------------------------------------------------------------
9681   29BD DD 7E 03    l2a2f:  ld      a,(ix+3)
9682   29C0 67                  ld      h,a
9683   29C1 DD 7E 05            ld      a,(ix+5)
9684   29C4 C6 04               add     a,$04
9685   29C6 6F                  ld      l,a
9686   29C7 E5                  push    hl
9687   29C8 CD 73 2F            call    L_STAGE_LOC_TO_ADDRESS
9688   29CB D1                  pop     de
9689   29CC 7E                  ld      a,(hl)
9690   29CD FE B0               cp      $b0
9691   29CF DA 09 2A            jp      c,l2a7b
9692   29D2 E6 0F               and     $0f
9693   29D4 FE 08               cp      $08
9694   29D6 D2 09 2A            jp      nc,l2a7b
9695   29D9 7E                  ld      a,(hl)
9696   29DA FE C0               cp      $c0
9697   29DC CA 09 2A            jp      z,l2a7b
9698   29DF DA F7 29            jp      c,l2a69
9699   29E2 FE D0               cp      $d0
9700   29E4 DA FC 29            jp      c,l2a6e
9701   29E7 FE E0               cp      $e0
9702   29E9 DA F1 29            jp      c,l2a63
9703   29EC FE F0               cp      $f0
9704   29EE DA FC 29            jp      c,l2a6e
9705   29F1 E6 0F       l2a63:  and     $0f
9706   29F3 3D                  dec     a
9707   29F4 C3 00 2A            jp      l2a72
9708   29F7 3E FF       l2a69:  ld      a,$ff
9709   29F9 C3 00 2A            jp      l2a72
9710   29FC E6 0F       l2a6e:  and     $0f
9711   29FE D6 09               sub     $09
9712   2A00 4F          l2a72:  ld      c,a
9713   2A01 7B                  ld      a,e
9714   2A02 E6 F8               and     $f8
9715   2A04 81                  add     a,c
9716   2A05 BB                  cp      e
9717   2A06 DA 0B 2A            jp      c,l2a7d
9718   2A09 AF          l2a7b:  xor     a
9719   2A0A C9                  ret     
9720   2A0B             
9721   2A0B D6 04       l2a7d:  sub     $04
9722   2A0D DD 77 05            ld      (ix+5),a
9723   2A10 3E 01               ld      a,$01
9724   2A12 C9                  ret     
9725   2A13             ;------------------------------------------------------------------------------
9726   2A13             
9727   2A13             
9728   2A13             
9729   2A13             ;------------------------------------------------------------------------------
9730   2A13             l2a85:  
9731   2A13 3A 15 62    		ld      a,(MARIO_IS_CLIMBING)
9732   2A16 A7                  and     a
9733   2A17 C0                  ret     nz
9734   2A18             		
9735   2A18 3A 16 62            ld      a,(MARIO_IS_JUMPING)
9736   2A1B A7                  and     a
9737   2A1C C0                  ret     nz
9738   2A1D             		
9739   2A1D 3A 98 63            ld      a,(MARIO_ON_ELEVATOR)
9740   2A20 FE 01               cp      $01
9741   2A22 C8                  ret     z
9742   2A23             		
9743   2A23 3A 03 62            ld      a,(MARIO_X)
9744   2A26 D6 03               sub     $03
9745   2A28 67                  ld      h,a
9746   2A29 3A 05 62            ld      a,(MARIO_Y)
9747   2A2C C6 0C               add     a,$0c
9748   2A2E 6F                  ld      l,a
9749   2A2F E5                  push    hl
9750   2A30 CD 73 2F            call    L_STAGE_LOC_TO_ADDRESS
9751   2A33 D1                  pop     de
9752   2A34 7E                  ld      a,(hl)
9753   2A35 FE B0               cp      $b0
9754   2A37 DA 42 2A            jp      c,l2ab4
9755   2A3A E6 0F               and     $0f
9756   2A3C FE 08               cp      $08
9757   2A3E D2 42 2A            jp      nc,l2ab4
9758   2A41 C9                  ret    
9759   2A42             		
9760   2A42 7A          l2ab4:  ld      a,d
9761   2A43 E6 07               and     $07
9762   2A45 CA 5B 2A            jp      z,l2acd
9763   2A48 01 20 00            ld      bc,$0020
9764   2A4B ED 42               sbc     hl,bc
9765   2A4D 7E                  ld      a,(hl)
9766   2A4E FE B0               cp      $b0
9767   2A50 DA 5B 2A            jp      c,l2acd
9768   2A53 E6 0F               and     $0f
9769   2A55 FE 08               cp      $08
9770   2A57 D2 5B 2A            jp      nc,l2acd
9771   2A5A C9                  ret     
9772   2A5B             		
9773   2A5B 3E 01       l2acd:  ld      a,1
9774   2A5D 32 21 62            ld      (MARIO_IS_FALLING),a
9775   2A60 C9                  ret     
9776   2A61             ;------------------------------------------------------------------------------
9777   2A61             
9778   2A61             
9779   2A61             ;------------------------------------------------------------------------------
9780   2A61             ; This function moves Mario along the conveyer belts on the mixer stage
9781   2A61             L_MOVE_MARIO_ON_CONVEYERS:  
9782   2A61                     ; If Mario is standing on the left or right conveyer, jump ahead
9783   2A61 3A 03 62    		ld      a,(MARIO_X)
9784   2A64 47                  ld      b,a
9785   2A65 3A 05 62            ld      a,(MARIO_Y)
9786   2A68 FE 78       		cp      120
9787   2A6A CA 79 2A            jp      z,l2af6
9788   2A6D                     
9789   2A6D                     ; If Mario is standing on the bottom conveyer, jump ahead
9790   2A6D FE C8       		cp      $c8
9791   2A6F CA 73 2A            jp      z,l2af0
9792   2A72 C9                  ret     
9793   2A73             
9794   2A73             		; Move Mario along the bottom conveyer
9795   2A73 3A A6 63    l2af0:  ld      a,(BOT_CONVEYER_DIR)
9796   2A76 C3 85 2A            jp      l2b02
9797   2A79                     
9798   2A79                     ; If Mario is on the right conveyer, move him along it
9799   2A79 78          l2af6:  ld      a,b
9800   2A7A FE 80               cp      128
9801   2A7C 3A A5 63            ld      a,(RIGHT_CONVEYER_DIR)
9802   2A7F D2 85 2A            jp      nc,l2b02
9803   2A82                     
9804   2A82                     ; If Mario is on the left conveyer, move him along it
9805   2A82 3A A4 63            ld      a,(LEFT_CONVEYER_DIR)
9806   2A85                     
9807   2A85                     ; Move Mario
9808   2A85 80          l2b02:  add     a,b
9809   2A86 32 03 62            ld      (MARIO_X),a
9810   2A89 32 4C 69            ld      (MARIO_SPRITE_X),a
9811   2A8C                     
9812   2A8C                     ; Check if Mario has hit the edge of the screen
9813   2A8C CD 04 24            call    L_IMPLEMENT_BARRIERS
9814   2A8F                     
9815   2A8F                     ; If Mario has hit the right edge, jump ahead to correct his position
9816   2A8F 21 03 62            ld      hl,MARIO_X
9817   2A92 1D                  dec     e
9818   2A93 CA 9B 2A            jp      z,l2b18
9819   2A96                     
9820   2A96                     ; If Mario has hit the left edge, jump ahead to correct his position
9821   2A96 15                  dec     d
9822   2A97 CA 9D 2A            jp      z,l2b1a
9823   2A9A                     
9824   2A9A C9                  ret     
9825   2A9B             		
9826   2A9B             		; Stop Mario from moving into the right edge of the screen
9827   2A9B 35          l2b18:  dec     (hl)
9828   2A9C C9                  ret     
9829   2A9D             
9830   2A9D             		
9831   2A9D             		; Stop Mario from moving into the left edge of the screen
9832   2A9D 34          l2b1a:  inc     (hl)
9833   2A9E C9                  ret     
9834   2A9F             ;------------------------------------------------------------------------------
9835   2A9F             
9836   2A9F             
9837   2A9F             
9838   2A9F             ;------------------------------------------------------------------------------
9839   2A9F             l2b1c:  
9840   2A9F DD 21 00 62 		ld      ix,MARIO_DATA_STRUCT
9841   2AA3 CD AC 2A            call    l2b29
9842   2AA6 CD 3F 29            call    L_INTERACT_WITH_ELEVATORS
9843   2AA9 AF                  xor     a
9844   2AAA 47                  ld      b,a
9845   2AAB C9                  ret     
9846   2AAC             ;------------------------------------------------------------------------------
9847   2AAC             
9848   2AAC             
9849   2AAC             
9850   2AAC             ;------------------------------------------------------------------------------
9851   2AAC             ; passed:	ix - MARIO_DATA_STRUCT
9852   2AAC             l2b29:  
9853   2AAC             		; If the current stage is not barrels, 
9854   2AAC             		; jump ahead
9855   2AAC 3A 27 62    		ld      a,(CURRENT_STAGE)
9856   2AAF 3D                  dec     a
9857   2AB0 C2 D6 2A            jp      nz,l2b53
9858   2AB3                     
9859   2AB3                     ; Save Mario's coordinate to hl
9860   2AB3                     ; (Y coordinate + 7)
9861   2AB3 3A 03 62            ld      a,(MARIO_X)
9862   2AB6 67                  ld      h,a
9863   2AB7 3A 05 62            ld      a,(MARIO_Y)
9864   2ABA C6 07               add     a,7
9865   2ABC 6F                  ld      l,a
9866   2ABD                     
9867   2ABD CD 1E 2B            call    l2b9b
9868   2AC0                     
9869   2AC0                     ; If a is 0, jump ahead
9870   2AC0 A7                  and     a
9871   2AC1 CA D4 2A            jp      z,l2b51
9872   2AC4                     
9873   2AC4                     
9874   2AC4 7B                  ld      a,e
9875   2AC5 91                  sub     c
9876   2AC6 FE 04               cp      4
9877   2AC8 D2 F7 2A            jp      nc,l2b74
9878   2ACB                     
9879   2ACB 79                  ld      a,c
9880   2ACC D6 07               sub     $07
9881   2ACE 32 05 62            ld      (MARIO_Y),a
9882   2AD1 3E 01               ld      a,$01
9883   2AD3 47                  ld      b,a
9884   2AD4 E1          l2b51:  pop     hl
9885   2AD5 C9                  ret     
9886   2AD6             		
9887   2AD6 3A 03 62    l2b53:  ld      a,(MARIO_X)
9888   2AD9 D6 03               sub     $03
9889   2ADB 67                  ld      h,a
9890   2ADC 3A 05 62            ld      a,(MARIO_Y)
9891   2ADF C6 07               add     a,$07
9892   2AE1 6F                  ld      l,a
9893   2AE2 CD 1E 2B            call    l2b9b
9894   2AE5 FE 02               cp      2
9895   2AE7 CA FD 2A            jp      z,l2b7a
9896   2AEA 7A                  ld      a,d
9897   2AEB C6 07               add     a,%00000111
9898   2AED 67                  ld      h,a
9899   2AEE 6B                  ld      l,e
9900   2AEF CD 1E 2B            call    l2b9b
9901   2AF2 A7                  and     a
9902   2AF3 C8                  ret     z
9903   2AF4             		
9904   2AF4 C3 FD 2A            jp      l2b7a
9905   2AF7 3E 00       l2b74:  ld      a,$00
9906   2AF9 06 00               ld      b,$00
9907   2AFB E1                  pop     hl
9908   2AFC C9                  ret     
9909   2AFD             		
9910   2AFD 3A 10 62    l2b7a:  ld      a,(MARIO_JUMPING_LEFT)
9911   2B00 A7                  and     a
9912   2B01 3A 03 62            ld      a,(MARIO_X)
9913   2B04 CA 0E 2B            jp      z,l2b8b
9914   2B07 F6 07               or      $07
9915   2B09 D6 04               sub     $04
9916   2B0B C3 14 2B            jp      l2b91
9917   2B0E D6 08       l2b8b:  sub     $08
9918   2B10 F6 07               or      $07
9919   2B12 C6 04               add     a,$04
9920   2B14 32 03 62    l2b91:  ld      (MARIO_X),a
9921   2B17 32 4C 69            ld      (MARIO_SPRITE_X),a
9922   2B1A 3E 01               ld      a,$01
9923   2B1C E1                  pop     hl
9924   2B1D C9                  ret     
9925   2B1E             ;------------------------------------------------------------------------------
9926   2B1E             
9927   2B1E             
9928   2B1E             
9929   2B1E             ;------------------------------------------------------------------------------
9930   2B1E             ; passed:	hl - x,y coordinate
9931   2B1E             ;			ix - 
9932   2B1E             ; return:	a - 
9933   2B1E             ;			b -
9934   2B1E             ;			c - The y coordinate of the top of the supporting tile surface
9935   2B1E             ;			de - the original x,y coordinate
9936   2B1E             l2b9b:  
9937   2B1E E5          		push    hl
9938   2B1F             		
9939   2B1F             		; Convert the x,y coordinate to a screen tile memory address
9940   2B1F CD 73 2F            call    L_STAGE_LOC_TO_ADDRESS
9941   2B22                     
9942   2B22 D1                  pop     de
9943   2B23                     
9944   2B23                     ; Get the tile at the coordinate passed in
9945   2B23 7E                  ld      a,(hl)
9946   2B24                     
9947   2B24                     ; If the tile cannot support weight,
9948   2B24                     ; jump ahead
9949   2B24 FE B0               cp      $b0
9950   2B26 DA 5C 2B            jp      c,l2bd9
9951   2B29 E6 0F               and     %00001111
9952   2B2B FE 08               cp      8
9953   2B2D D2 5C 2B            jp      nc,l2bd9
9954   2B30                 
9955   2B30                         
9956   2B30                     ; If the tile is the ladder tile,
9957   2B30                     ; jump ahead
9958   2B30 7E                  ld      a,(hl)
9959   2B31 FE C0               cp      $c0
9960   2B33 CA 5C 2B            jp      z,l2bd9
9961   2B36                     
9962   2B36                     ; If the tile is less than the ladder tile, 
9963   2B36                     ; jump ahead
9964   2B36 DA 5F 2B            jp      c,l2bdc
9965   2B39                     
9966   2B39                     ; If the tile is one of the upper porion barrel girders with ladders, 
9967   2B39                     ; jump ahead
9968   2B39 FE D0               cp      $d0
9969   2B3B DA 4E 2B            jp      c,l2bcb
9970   2B3E                     
9971   2B3E                     ; If the tile is one of the barrel girders with a ladder,
9972   2B3E                     ; jump ahead
9973   2B3E FE E0               cp      $e0
9974   2B40 DA 48 2B            jp      c,l2bc5
9975   2B43                     
9976   2B43                     ; If the tile is one of the upper porion barrel girders, 
9977   2B43                     ; jump ahead
9978   2B43 FE F0               cp      $f0
9979   2B45 DA 4E 2B            jp      c,l2bcb
9980   2B48                     
9981   2B48                     ; The tile is one of the lower barrel girders
9982   2B48                     
9983   2B48                     ; Isolate the offset of the girder
9984   2B48 E6 0F       l2bc5:  and     %00001111
9985   2B4A 3D                  dec     a
9986   2B4B C3 52 2B            jp      l2bcf
9987   2B4E                     
9988   2B4E                     ; Isolate the offset of the girder - 9
9989   2B4E E6 0F       l2bcb:  and     %00001111
9990   2B50 D6 09               sub     9
9991   2B52             
9992   2B52 4F          l2bcf:  ld      c,a
9993   2B53                     
9994   2B53                     ; Round the y coordinate to the nearest tile boundary
9995   2B53 7B                  ld      a,e
9996   2B54 E6 F8               and     %11111000
9997   2B56                     
9998   2B56                     ; Add the tile offset
9999   2B56 81                  add     a,c
10000  2B57 4F                  ld      c,a
10001  2B58                     
10002  2B58                     ; If the original y coordinate is below the top of the girder,
10003  2B58                     ; jump ahead
10004  2B58 BB                  cp      e
10005  2B59 DA 64 2B            jp      c,l2be1
10006  2B5C                     
10007  2B5C                     ; Report that there is no supporting surface?
10008  2B5C AF          l2bd9:  xor     a
10009  2B5D 47                  ld      b,a
10010  2B5E C9                  ret     
10011  2B5F             		
10012  2B5F             		; Round the y coordinate to the nearest tile boundary - 1
10013  2B5F 7B          l2bdc:  ld      a,e
10014  2B60 E6 F8               and     %11111000
10015  2B62 3D                  dec     a
10016  2B63 4F                  ld      c,a
10017  2B64                     
10018  2B64 3A 0C 62    l2be1:  ld      a,($620c)
10019  2B67 DD 96 05            sub     (ix+5)							; Y coordinate
10020  2B6A 83                  add     a,e
10021  2B6B B9                  cp      c
10022  2B6C CA 72 2B            jp      z,l2bef
10023  2B6F D2 7B 2B            jp      nc,l2bf8
10024  2B72 79          l2bef:  ld      a,c
10025  2B73 D6 07               sub     7
10026  2B75 32 05 62            ld      (MARIO_Y),a
10027  2B78 C3 80 2B            jp      l2bfd
10028  2B7B                     
10029  2B7B 3E 02       l2bf8:  ld      a,2
10030  2B7D 06 00               ld      b,0
10031  2B7F C9                  ret     
10032  2B80             		
10033  2B80 3E 01       l2bfd:  ld      a,$01
10034  2B82 47                  ld      b,a
10035  2B83 E1                  pop     hl
10036  2B84 E1                  pop     hl
10037  2B85 C9                  ret     
10038  2B86             ;------------------------------------------------------------------------------
10039  2B86             
10040  2B86             
10041  2B86             
10042  2B86             ;------------------------------------------------------------------------------
10043  2B86             l2c03:  
10044  2B86             		; Return unless this is the barrels stage
10045  2B86 3E 01       		ld      a,%00000001
10046  2B88 F7                  rst     $30							
10047  2B89                     
10048  2B89             		; Return if Mario is dead
10049  2B89 D7                  rst     $10
10050  2B8A             		
10051  2B8A             		; If Donkey Kong is stomping,
10052  2B8A             		; return
10053  2B8A 3A 93 63            ld      a,(DK_STOMPING)
10054  2B8D 0F                  rrca    
10055  2B8E D8                  ret     c
10056  2B8F             		
10057  2B8F 3A B1 62            ld      a,($62b1)
10058  2B92 A7                  and     a
10059  2B93 C8                  ret     z
10060  2B94             		
10061  2B94 4F                  ld      c,a
10062  2B95 3A B0 62            ld      a,(INTERNAL_TIMER)
10063  2B98 D6 02               sub     2
10064  2B9A B9                  cp      c
10065  2B9B DA FE 2B            jp      c,l2c7b
10066  2B9E 3A 82 63            ld      a,($6382)
10067  2BA1 CB 4F               bit     1,a
10068  2BA3 C2 09 2C            jp      nz,l2c86
10069  2BA6 3A 80 63            ld      a,(CP_DIFFICULTY)
10070  2BA9 47                  ld      b,a
10071  2BAA 3A 1A 60            ld      a,(COUNTER_2)
10072  2BAD E6 1F               and     %00011111
10073  2BAF B8          l2c2c:  cp      b
10074  2BB0 CA B6 2B            jp      z,l2c33
10075  2BB3 10 FA               djnz    l2c2c
10076  2BB5 C9                  ret     
10077  2BB6             		
10078  2BB6 3A B0 62    l2c33:  ld      a,(INTERNAL_TIMER)
10079  2BB9 CB 3F               srl     a
10080  2BBB B9                  cp      c
10081  2BBC DA C4 2B            jp      c,l2c41
10082  2BBF 3A 19 60            ld      a,(COUNTER_1)
10083  2BC2 0F                  rrca    
10084  2BC3 D0                  ret     nc
10085  2BC4             		
10086  2BC4 CD 57 00    l2c41:  call    L_UPDATE_RAND_NUM
10087  2BC7 E6 0F               and     %00001111
10088  2BC9 C2 09 2C            jp      nz,l2c86
10089  2BCC 3E 01       l2c49:  ld      a,1
10090  2BCE 32 82 63    l2c4b:  ld      ($6382),a
10091  2BD1 3C                  inc     a
10092  2BD2 32 8F 63    l2c4f:  ld      ($638f),a
10093  2BD5 3E 01               ld      a,1
10094  2BD7 32 92 63            ld      ($6392),a
10095  2BDA 3A B2 62            ld      a,($62b2)
10096  2BDD B9                  cp      c
10097  2BDE C0                  ret     nz
10098  2BDF             		
10099  2BDF D6 08               sub     8
10100  2BE1 32 B2 62            ld      ($62b2),a
10101  2BE4 11 20 00            ld      de,32
10102  2BE7 21 00 64            ld      hl,FIREBALL_STRUCTS
10103  2BEA 06 05               ld      b,5
10104  2BEC 7E          l2c69:  ld      a,(hl)
10105  2BED A7                  and     a
10106  2BEE CA F5 2B            jp      z,l2c72
10107  2BF1 19                  add     hl,de
10108  2BF2 10 F8               djnz    l2c69
10109  2BF4 C9                  ret    
10110  2BF5             		
10111  2BF5 3A 82 63    l2c72:  ld      a,($6382)
10112  2BF8 F6 80               or      %10000000
10113  2BFA 32 82 63            ld      ($6382),a
10114  2BFD C9                  ret     
10115  2BFE             ;------------------------------------------------------------------------------
10116  2BFE             
10117  2BFE             
10118  2BFE             
10119  2BFE             ;------------------------------------------------------------------------------
10120  2BFE             ; passed:	a - 
10121  2BFE             ;			c - 
10122  2BFE C6 02       l2c7b:  add     a,2
10123  2C00 B9                  cp      c
10124  2C01 CA CC 2B            jp      z,l2c49
10125  2C04                     
10126  2C04 3E 02               ld      a,$02
10127  2C06 C3 CE 2B            jp      l2c4b
10128  2C09 AF          l2c86:  xor     a
10129  2C0A 32 82 63            ld      ($6382),a
10130  2C0D 3E 03               ld      a,$03
10131  2C0F C3 D2 2B            jp      l2c4f
10132  2C12 3E 01       l2c8f:  ld      a,$01
10133  2C14 F7                  rst     $30							; Return unless this is the barrels stage
10134  2C15                     ; Return if Mario is dead
10135  2C15 D7                  rst     $10
10136  2C16 3A 93 63            ld      a,(DK_STOMPING)
10137  2C19 0F                  rrca    
10138  2C1A DA 98 2C            jp      c,l2d15
10139  2C1D 3A 92 63            ld      a,($6392)
10140  2C20 0F                  rrca    
10141  2C21 D0                  ret     nc
10142  2C22             		
10143  2C22 DD 21 00 67         ld      ix,BARREL_STRUCTS
10144  2C26 11 20 00            ld      de,32
10145  2C29 06 0A               ld      b,10
10146  2C2B DD 7E 00    l2ca8:  ld      a,(ix+0)
10147  2C2E 0F                  rrca    
10148  2C2F DA 36 2C            jp      c,l2cb3
10149  2C32 0F                  rrca    
10150  2C33 D2 3B 2C            jp      nc,l2cb8
10151  2C36 DD 19       l2cb3:  add     ix,de
10152  2C38 10 F1               djnz    l2ca8
10153  2C3A C9                  ret     
10154  2C3B             		
10155  2C3B DD 22 AA 62 l2cb8:  ld      ($62aa),ix
10156  2C3F DD 36 00 02         ld      (ix+0),$02
10157  2C43 16 00               ld      d,$00
10158  2C45 3E 0A               ld      a,$0a
10159  2C47 90                  sub     b
10160  2C48 87                  add     a,a
10161  2C49 87                  add     a,a
10162  2C4A 5F                  ld      e,a
10163  2C4B 21 80 69            ld      hl,SPRING_SPRITES
10164  2C4E 19                  add     hl,de
10165  2C4F 22 AC 62            ld      ($62ac),hl
10166  2C52 3E 01               ld      a,1
10167  2C54 32 93 63            ld      (DK_STOMPING),a
10168  2C57 11 01 05            ld      de,$0501
10169  2C5A CD 22 30            call    L_ADD_EVENT
10170  2C5D 21 B1 62            ld      hl,$62b1
10171  2C60 35                  dec     (hl)
10172  2C61 C2 69 2C            jp      nz,l2ce6
10173  2C64 3E 01               ld      a,$01
10174  2C66 32 86 63            ld      ($6386),a
10175  2C69 7E          l2ce6:  ld      a,(hl)
10176  2C6A FE 04               cp      $04
10177  2C6C D2 79 2C            jp      nc,l2cf6
10178  2C6F 21 A8 69            ld      hl,STANDING_BARREL_SPRITE_DATA
10179  2C72 87                  add     a,a
10180  2C73 87                  add     a,a
10181  2C74 5F                  ld      e,a
10182  2C75 16 00               ld      d,$00
10183  2C77 19                  add     hl,de
10184  2C78 72                  ld      (hl),d
10185  2C79 DD 36 07 15 l2cf6:  ld      (ix+7),$15
10186  2C7D DD 36 08 0B         ld      (ix+8),$0b
10187  2C81 DD 36 15 00         ld      (ix+21),$00
10188  2C85 3A 82 63            ld      a,($6382)
10189  2C88 07                  rlca    
10190  2C89 D2 98 2C            jp      nc,l2d15
10191  2C8C DD 36 07 19         ld      (ix+7),$19
10192  2C90 DD 36 08 0C         ld      (ix+8),$0c
10193  2C94 DD 36 15 01         ld      (ix+21),$01
10194  2C98 21 AF 62    l2d15:  ld      hl,DK_CLIMBING_COUNTER
10195  2C9B 35                  dec     (hl)
10196  2C9C C0                  ret     nz
10197  2C9D             		
10198  2C9D 36 18               ld      (hl),$18
10199  2C9F 3A 8F 63            ld      a,($638f)
10200  2CA2 A7                  and     a
10201  2CA3 CA D4 2C            jp      z,l2d51
10202  2CA6 4F                  ld      c,a
10203  2CA7 21 A4 38            ld      hl,L_DK_SPRITES_THROW_BARREL
10204  2CAA 3A 82 63            ld      a,($6382)
10205  2CAD 0F                  rrca    
10206  2CAE DA B2 2C            jp      c,l2d2f
10207  2CB1 0D                  dec     c
10208  2CB2 79          l2d2f:  ld      a,c
10209  2CB3 87                  add     a,a
10210  2CB4 87                  add     a,a
10211  2CB5 87                  add     a,a
10212  2CB6 4F                  ld      c,a
10213  2CB7 87                  add     a,a
10214  2CB8 87                  add     a,a
10215  2CB9 81                  add     a,c
10216  2CBA 5F                  ld      e,a
10217  2CBB 16 00               ld      d,$00
10218  2CBD 19                  add     hl,de
10219  2CBE CD 4E 00            call    L_LOAD_DK_SPRITES
10220  2CC1 21 8F 63            ld      hl,$638f
10221  2CC4 35                  dec     (hl)
10222  2CC5 C2 D4 2C            jp      nz,l2d51
10223  2CC8 3E 01               ld      a,1
10224  2CCA 32 AF 62            ld      (DK_CLIMBING_COUNTER),a
10225  2CCD 3A 82 63            ld      a,($6382)
10226  2CD0 0F                  rrca    
10227  2CD1 DA 06 2D            jp      c,l2d83
10228  2CD4 2A A8 62    l2d51:  ld      hl,($62a8)
10229  2CD7 7E          l2d54:  ld      a,(hl)
10230  2CD8 DD 2A AA 62         ld      ix,($62aa)
10231  2CDC ED 5B AC 62         ld      de,($62ac)
10232  2CE0 FE 7F               cp      $7f
10233  2CE2 CA 0F 2D            jp      z,l2d8c
10234  2CE5 4F                  ld      c,a
10235  2CE6 E6 7F               and     $7f
10236  2CE8 12                  ld      (de),a
10237  2CE9 DD 7E 07            ld      a,(ix+7)
10238  2CEC CB 79               bit     7,c
10239  2CEE CA F3 2C            jp      z,l2d70
10240  2CF1 EE 03               xor     $03
10241  2CF3 13          l2d70:  inc     de
10242  2CF4 12                  ld      (de),a
10243  2CF5 DD 77 07            ld      (ix+7),a
10244  2CF8 DD 7E 08            ld      a,(ix+8)
10245  2CFB 13                  inc     de
10246  2CFC 12                  ld      (de),a
10247  2CFD 23                  inc     hl
10248  2CFE 7E                  ld      a,(hl)
10249  2CFF 13                  inc     de
10250  2D00 12                  ld      (de),a
10251  2D01 23                  inc     hl
10252  2D02 22 A8 62            ld      ($62a8),hl
10253  2D05 C9                  ret     
10254  2D06             		
10255  2D06 21 3E 39    l2d83:  ld      hl,l39cc
10256  2D09 22 A8 62            ld      ($62a8),hl
10257  2D0C C3 D7 2C            jp      l2d54
10258  2D0F 21 35 39    l2d8c:  ld      hl,l39c3
10259  2D12 22 A8 62            ld      ($62a8),hl
10260  2D15 DD 36 01 01         ld      (ix+1),$01
10261  2D19 3A 82 63            ld      a,($6382)
10262  2D1C 0F                  rrca    
10263  2D1D DA 28 2D            jp      c,l2da5
10264  2D20 DD 36 01 00         ld      (ix+1),$00
10265  2D24 DD 36 02 02         ld      (ix+2),$02
10266  2D28 DD 36 00 01 l2da5:  ld      (ix+0),$01
10267  2D2C DD 36 0F 01         ld      (ix+15),$01
10268  2D30 AF                  xor     a
10269  2D31 DD 77 10            ld      (ix+16),a
10270  2D34 DD 77 11            ld      (ix+17),a
10271  2D37 DD 77 12            ld      (ix+18),a
10272  2D3A DD 77 13            ld      (ix+19),a
10273  2D3D DD 77 14            ld      (ix+20),a
10274  2D40 32 93 63            ld      (DK_STOMPING),a
10275  2D43 32 92 63            ld      ($6392),a
10276  2D46 1A                  ld      a,(de)
10277  2D47 DD 77 03            ld      (ix+3),a
10278  2D4A 13                  inc     de
10279  2D4B 13                  inc     de
10280  2D4C 13                  inc     de
10281  2D4D 1A                  ld      a,(de)
10282  2D4E DD 77 05            ld      (ix+5),a
10283  2D51 21 CE 37            ld      hl,L_DK_SPRITES_L_ARM_RAISED
10284  2D54 CD 4E 00            call    L_LOAD_DK_SPRITES
10285  2D57 21 0B 69            ld      hl,DK_SPRITE_1_Y
10286  2D5A 0E FC               ld      c,$fc
10287  2D5C FF                  rst     $38
10288  2D5D C9                  ret     
10289  2D5E             ;------------------------------------------------------------------------------
10290  2D5E             
10291  2D5E             
10292  2D5E             
10293  2D5E             ;------------------------------------------------------------------------------
10294  2D5E             ; This function causes a fireball or firefox to randomly be released 
10295  2D5E             ; on the mixer or rivets stage
10296  2D5E             L_RANDOMLY_RELEASE_FIREBALL:  
10297  2D5E             		; Return unless this is the mixer stage or rivets stage
10298  2D5E 3E 0A       		ld      a,%00001010
10299  2D60 F7                  rst     $30		
10300  2D61             
10301  2D61             		; Return if Mario is dead
10302  2D61 D7                  rst     $10
10303  2D62             		
10304  2D62             		; Calculate the modified difficulty 
10305  2D62             		; by incrementing the current difficulty and multiplying by 2
10306  2D62 3A 80 63            ld      a,(CP_DIFFICULTY)
10307  2D65 3C                  inc     a
10308  2D66 A7                  and     a
10309  2D67 1F                  rra     
10310  2D68 47                  ld      b,a
10311  2D69             		
10312  2D69             		; Increment the modified difficulty by one 
10313  2D69             		; if this is the mixer stage
10314  2D69 3A 27 62            ld      a,(CURRENT_STAGE)
10315  2D6C FE 02               cp      2
10316  2D6E 20 01               jr      nz,l2dee		
10317  2D70 04                  inc     b  							; ++b if this is the mixer stage
10318  2D71             
10319  2D71             		; For b = modified difficulty to 1
10320  2D71             		; Convert the modified difficulty into a random bit mask
10321  2D71             		; The bit mask makes it more likely that a fireball is released
10322  2D71             		; on higher difficulty settings
10323  2D71 3E FE       l2dee:  ld      a,254
10324  2D73 37                  scf        							; Set the carry flag
10325  2D74             		
10326  2D74 1F          l2df1:  rra     
10327  2D75 A7                  and     a							; Clear the carry flag
10328  2D76 10 FC               djnz    l2df1						; Next b
10329  2D78             
10330  2D78             		; Use the random bit mask to randomly release a fireball
10331  2D78             		; Return if a fireball should not be released
10332  2D78 47                  ld      b,a
10333  2D79 3A 1A 60            ld      a,(COUNTER_2)
10334  2D7C A0                  and     b
10335  2D7D C0                  ret     nz
10336  2D7E             		
10337  2D7E             		; Trigger a fireball to be released
10338  2D7E 3E 01               ld      a,1
10339  2D80 32 A0 63            ld      (RELEASE_A_FIREBALL),a
10340  2D83 32 9A 63            ld      ($639a),a
10341  2D86 C9                  ret     
10342  2D87             ;------------------------------------------------------------------------------
10343  2D87             
10344  2D87             
10345  2D87             
10346  2D87             ;------------------------------------------------------------------------------
10347  2D87             ; Process the springs on the elevators level
10348  2D87             ; This function spawns new springs, makes them bounce, and then causes them to 
10349  2D87             ; fall when they reach the gap in the top platform
10350  2D87             L_IMPLEMENT_SPRINGS:  
10351  2D87             		; Return unless this is the elevators stage
10352  2D87 3E 04       		ld      a,%00000100
10353  2D89 F7                  rst     $30	
10354  2D8A                     						
10355  2D8A                     ; Return if Mario is dead
10356  2D8A D7                  rst     $10
10357  2D8B                     
10358  2D8B DD 21 00 65         ld      ix,SPRING_STRUCTS			; ix points to the first spring data structure
10359  2D8F FD 21 80 69         ld      iy,SPRING_SPRITES			; iy points to the first spring sprite?
10360  2D93 06 0A               ld      b,10						; For b = 10 to 1 (10 springs)
10361  2D95             
10362  2D95             		; If this spring is not active, jump ahead to process the next spring
10363  2D95 DD 7E 00    l2e12:  ld      a,(ix+0)					
10364  2D98 0F                  rrca    
10365  2D99 D2 2A 2E            jp      nc,l2ea7					; If the spring is inactive, don't process it
10366  2D9C             
10367  2D9C 3A 1A 60            ld      a,(COUNTER_2)
10368  2D9F E6 0F               and     %00001111
10369  2DA1 C2 AC 2D            jp      nz,l2e29
10370  2DA4             
10371  2DA4 FD 7E 01            ld      a,(iy+1)					; Swap between extended and compressed sprites every 16 counter cycles
10372  2DA7 EE 07               xor     %00000111
10373  2DA9 FD 77 01            ld      (iy+1),a
10374  2DAC             
10375  2DAC             		; If the spring is falling, jump ahead to skip the bounce logic
10376  2DAC DD 7E 0D    l2e29:  ld      a,(ix+13)					; Spring state
10377  2DAF FE 04               cp      4
10378  2DB1 CA 07 2E            jp      z,l2e84						; If the spring is falling, skip bounce processing
10379  2DB4             
10380  2DB4             		; Move the spring two pixels right
10381  2DB4 DD 34 03            inc     (ix+3)						; X coordinate
10382  2DB7 DD 34 03            inc     (ix+3)							
10383  2DBA             
10384  2DBA             		; Get the next bounce vector
10385  2DBA DD 6E 0E            ld      l,(ix+14)					; hl = address of next bounce vector
10386  2DBD DD 66 0F            ld      h,(ix+15)
10387  2DC0 7E                  ld      a,(hl)						; a = next bounce vector
10388  2DC1 4F                  ld      c,a							; c = next bounce vector as well
10389  2DC2                     
10390  2DC2                     ; If this is the end of the vecor data, jump ahead
10391  2DC2                     ; to process the end of the bounce
10392  2DC2 FE 7F               cp      $7f
10393  2DC4 CA 1F 2E            jp      z,l2e9c						; If the end of the bounce sequence has been reached, restart the sequence
10394  2DC7             		
10395  2DC7             		; Advance to next bounce vector
10396  2DC7 23                  inc     hl				
10397  2DC8                     					
10398  2DC8             		; Move the spring up or down by the vector
10399  2DC8 DD 86 05            add     a,(ix+5)
10400  2DCB DD 77 05            ld      (ix+5),a
10401  2DCE             
10402  2DCE             		; Resave the address of the next bounce vector
10403  2DCE DD 75 0E    l2e4b:  ld      (ix+14),l
10404  2DD1 DD 74 0F            ld      (ix+15),h
10405  2DD4             		
10406  2DD4             		; If the spring has not reached the gap in the platform,
10407  2DD4             		; jump ahead to skip the falling logic
10408  2DD4 DD 7E 03            ld      a,(ix+3)					; X coordinate
10409  2DD7 FE B7               cp      183
10410  2DD9 DA EF 2D            jp      c,l2e6c						; If the spring has not reached the gap, simply update the sprite position
10411  2DDC             
10412  2DDC                     ; If the end of the bounce has not been reached,
10413  2DDC                     ; jump ahead to skip the falling logic
10414  2DDC 79                  ld      a,c
10415  2DDD FE 7F               cp      $7f
10416  2DDF C2 EF 2D            jp      nz,l2e6c	
10417  2DE2                     
10418  2DE2                     ; Trigger the spring's falling state
10419  2DE2 DD 36 0D 04         ld      (ix+13),4					; Enter the falling state
10420  2DE6             		
10421  2DE6             		; Turn off spring bounce sound
10422  2DE6 AF                  xor     a
10423  2DE7 32 83 60            ld      (SPRING_SOUND_TRIGGER),a
10424  2DEA             		
10425  2DEA             		; Trigger the falling sound
10426  2DEA 3E 03               ld      a,3
10427  2DEC 32 84 60            ld      (FALL_SOUND_TRIGGER),a
10428  2DEF             		
10429  2DEF             		; Move the sprite to the new coordinate
10430  2DEF DD 7E 03    l2e6c:  ld      a,(ix+3)					; Data structure x coordinate				
10431  2DF2 FD 77 00            ld      (iy+0),a					; Sprite x coordinate
10432  2DF5 DD 7E 05            ld      a,(ix+5)					; Data structure y coordinate
10433  2DF8 FD 77 03            ld      (iy+3),a					; Sprite y coordinate
10434  2DFB             
10435  2DFB             		; Advance to the next spring structure
10436  2DFB 11 10 00    l2e78:  ld      de,16
10437  2DFE DD 19               add     ix,de	
10438  2E00                     
10439  2E00             		; Advance to the next spring sprite							
10440  2E00 1E 04               ld      e,4
10441  2E02 FD 19               add     iy,de	
10442  2E04                     
10443  2E04                     ; Process the next spring
10444  2E04 10 8F               djnz    l2e12						; Next b
10445  2E06 C9                  ret     
10446  2E07             		
10447  2E07             		; Move the spring 3 pixels down
10448  2E07 3E 03       l2e84:  ld      a,3
10449  2E09 DD 86 05            add     a,(ix+5)					; y coordinate
10450  2E0C DD 77 05            ld      (ix+5),a
10451  2E0F             
10452  2E0F             		; If the spring has not reached the bottom of the screen, jump back up
10453  2E0F             		; to update the sprite position
10454  2E0F FE F8               cp      248
10455  2E11 DA EF 2D            jp      c,l2e6c
10456  2E14             
10457  2E14             		; Inactivate the spring
10458  2E14 DD 36 03 00         ld      (ix+3),0					; x coordinate
10459  2E18 DD 36 00 00         ld      (ix+0),0					; Sprite inactive
10460  2E1C                     
10461  2E1C                     ; Jump back up to update the sprite posituon
10462  2E1C C3 EF 2D            jp      l2e6c
10463  2E1F             		
10464  2E1F             		; Restart the bounce sequence
10465  2E1F 21 1C 39    l2e9c:  ld      hl,L_SPRING_VECTOR_DATA	
10466  2E22             
10467  2E22             		; Play the spring bounce sound					
10468  2E22 3E 03               ld      a,3
10469  2E24 32 83 60            ld      (SPRING_SOUND_TRIGGER),a
10470  2E27                     
10471  2E27                     ; Jump back up to continue processing the bounce logic
10472  2E27 C3 CE 2D            jp      l2e4b						; Continue the bounce sequence processing
10473  2E2A             		
10474  2E2A             		; If it is not time to release a spring, 
10475  2E2A             		; jump back up to process the next spring
10476  2E2A 3A 96 63    l2ea7:  ld      a,(RELEASE_SPRING)
10477  2E2D 0F                  rrca    
10478  2E2E D2 FB 2D            jp      nc,l2e78								
10479  2E31             
10480  2E31             		; Release a new spring
10481  2E31 AF                  xor     a
10482  2E32 32 96 63            ld      (RELEASE_SPRING),a			; Reset the release spring flag
10483  2E35 DD 36 05 50         ld      (ix+5),80					; Y coordinate
10484  2E39 DD 36 0D 01         ld      (ix+13),1					; Spring state = bouncing
10485  2E3D             
10486  2E3D             		; Get a random number between -8 and 7
10487  2E3D CD 57 00            call    L_UPDATE_RAND_NUM
10488  2E40 E6 0F               and     %00001111
10489  2E42 C6 F8               add     a,-8
10490  2E44             
10491  2E44             		; Initialize spring
10492  2E44 DD 77 03            ld      (ix+3),a					; Spring x coord = -8 to 7
10493  2E47 DD 36 00 01         ld      (ix+0),1					; Activate spring
10494  2E4B 21 1C 39            ld      hl,L_SPRING_VECTOR_DATA		; Point to start of bounce vector data
10495  2E4E DD 75 0E            ld      (ix+14),l
10496  2E51 DD 74 0F            ld      (ix+15),h
10497  2E54                     
10498  2E54                     ; Jump back up to process the next spring
10499  2E54 C3 FB 2D            jp      l2e78						; Process next spring
10500  2E57             ;------------------------------------------------------------------------------
10501  2E57             		
10502  2E57             
10503  2E57             
10504  2E57             ;------------------------------------------------------------------------------
10505  2E57             ; This function animates the hammer cycle if it is active.
10506  2E57             ; This involves:
10507  2E57             ;	Displaying the hammer in Mario's hands when he first grabs it
10508  2E57             ; 	Animating the up/down pounding of the hammer when Mario reaches the ground
10509  2E57             ;	Playing the hammer time song
10510  2E57             ;	Alternating the hammer color when time is running out
10511  2E57             ;	Deactivating the hammer when the cycle is over
10512  2E57             L_ANIMATE_HAMMER_CYCLE:  
10513  2E57             		; Note: this stage check could probably be eliminated without affecting game play
10514  2E57 3E 0B       		ld      a,%1011
10515  2E59 F7                  rst     $30							; Return unless this is the barrels stage, mixer stage, or rivets stage
10516  2E5A                     
10517  2E5A                     ; Return if Mario is dead
10518  2E5A D7                  rst     $10
10519  2E5B             
10520  2E5B                     ; Determine which hammer is being held
10521  2E5B 11 18 6A            ld      de,HAMMER_SPRITE_1			
10522  2E5E DD 21 80 66         ld      ix,HAMMER_STRUCT_1
10523  2E62 DD 7E 01            ld      a,(ix+1)					; Mario has hammer
10524  2E65 0F                  rrca    
10525  2E66 DA 70 2E            jp      c,l2eed
10526  2E69 11 1C 6A            ld      de,HAMMER_SPRITE_2
10527  2E6C DD 21 90 66         ld      ix,HAMMER_STRUCT_2
10528  2E70             
10529  2E70             		; Indicate that the hammer is above Mario
10530  2E70 DD 36 0E 00 l2eed:  ld      (ix+14),0					; X offset
10531  2E74 DD 36 0F F0         ld      (ix+15),-16					; Y offset
10532  2E78             
10533  2E78             		; If the hammer cycle is not active, jump ahead to skip 
10534  2E78             		; running the cycle (raising and lowering the hammer)
10535  2E78 3A 17 62            ld      a,(HAMMER_CYCLE_ACTIVE)
10536  2E7B 0F                  rrca    
10537  2E7C D2 1A 2F            jp      nc,l2f97
10538  2E7F             
10539  2E7F             		; The hammer cycle is active
10540  2E7F             		; Clear the hammer grabbed flag as it is no longer needed
10541  2E7F AF                  xor     a
10542  2E80 32 18 62            ld      (HAMMER_GRABBED),a
10543  2E83                     
10544  2E83             		; Trigger the hammer time tune
10545  2E83 21 89 60            ld      hl,SONG_TRIGGER
10546  2E86 36 04               ld      (hl),SONG_TRIGGER_HAMMER
10547  2E88                     
10548  2E88 DD 36 09 06         ld      (ix+9),6
10549  2E8C DD 36 0A 03         ld      (ix+10),3
10550  2E90                     
10551  2E90                     ; Convert Mario's sprite to a version holding the hammer in the air
10552  2E90                     ; (Current sprite * 2 with bit 3 set, properly flipped)
10553  2E90 06 1E               ld      b,$1e						; Hammer up sprite number
10554  2E92 3A 07 62            ld      a,(MARIO_DATA_SPRITE_NUM)
10555  2E95 CB 27               sla     a
10556  2E97 D2 9E 2E            jp      nc,l2f1b
10557  2E9A F6 80               or      %10000000					; Flip horizontally
10558  2E9C CB F8               set     7,b
10559  2E9E F6 08       l2f1b:  or      %00001000					; Set the sprite to one of the hammer-carrying sprites
10560  2EA0 4F                  ld      c,a
10561  2EA1                     
10562  2EA1                     ; If it is not time to lower the hammer, jump ahead
10563  2EA1 3A 94 63            ld      a,(HAMMER_CYCLE_COUNTER)
10564  2EA4 CB 5F               bit     3,a
10565  2EA6 CA C6 2E            jp      z,l2f43
10566  2EA9                     
10567  2EA9                     ; Set the Mario and hammer sprites to their lowered positions
10568  2EA9 CB C0               set     0,b
10569  2EAB CB C1               set     0,c
10570  2EAD             
10571  2EAD DD 36 09 05         ld      (ix+9),5
10572  2EB1 DD 36 0A 06         ld      (ix+10),6
10573  2EB5                     
10574  2EB5                     ; Indicate the hammer is lowered to Mario's left
10575  2EB5 DD 36 0F 00         ld      (ix+15),0					; Y offset
10576  2EB9 DD 36 0E F0         ld      (ix+14),-16					; X offset
10577  2EBD                     
10578  2EBD                     ; If Mario is facing left, jump ahead to skip flipping the hammer 
10579  2EBD CB 79               bit     7,c
10580  2EBF CA C6 2E            jp      z,l2f43
10581  2EC2             
10582  2EC2             		; Indicatd the hammer is lowered to Mario's right
10583  2EC2 DD 36 0E 10         ld      (ix+14),16					; X offset
10584  2EC6                     
10585  2EC6                     ; Save the sprite number
10586  2EC6 79          l2f43:  ld      a,c
10587  2EC7 32 4D 69            ld      (MARIO_SPRITE_NUM),a
10588  2ECA                     
10589  2ECA                     ; Use palette 7
10590  2ECA 0E 07               ld      c,7
10591  2ECC                     
10592  2ECC                     ; Advance the hammer cycle
10593  2ECC 21 94 63            ld      hl,HAMMER_CYCLE_COUNTER
10594  2ECF 34                  inc     (hl)
10595  2ED0                     
10596  2ED0                     ; If the cycle has not wrapped around back to 0, jump ahead
10597  2ED0 C2 3A 2F            jp      nz,l2fb7
10598  2ED3                     
10599  2ED3                     ; Increment the hammer cycle wrap counter
10600  2ED3 21 95 63            ld      hl,HAMMER_CYCLE_WRAP_COUNTER
10601  2ED6 34                  inc     (hl)
10602  2ED7 7E                  ld      a,(hl)
10603  2ED8                     
10604  2ED8                     ; If the hammer cycle has not wrapped twice, jump ahead
10605  2ED8 FE 02               cp      2
10606  2EDA C2 41 2F            jp      nz,l2fbe
10607  2EDD                     
10608  2EDD                     ; Reset hammer cycle data
10609  2EDD AF                  xor     a
10610  2EDE 32 95 63            ld      (HAMMER_CYCLE_WRAP_COUNTER),a
10611  2EE1 32 17 62            ld      (HAMMER_CYCLE_ACTIVE),a
10612  2EE4 DD 77 01            ld      (ix+1),a					; Mario no longer has the hammer
10613  2EE7 3A 03 62            ld      a,(MARIO_X)
10614  2EEA ED 44               neg     
10615  2EEC DD 77 0E            ld      (ix+14),a					; X offset = -MARIO_X (this is used lower down to set the hammer's x coordinate to 0)
10616  2EEF                     
10617  2EEF                     ; Update Mario's sprite 
10618  2EEF 3A 07 62            ld      a,(MARIO_DATA_SPRITE_NUM)
10619  2EF2 32 4D 69            ld      (MARIO_SPRITE_NUM),a
10620  2EF5                     
10621  2EF5                     ; Mark the hammer as inactive
10622  2EF5 DD 36 00 00         ld      (ix+0),0					; Sprite inactive
10623  2EF9             
10624  2EF9             		; Play the previously active tune
10625  2EF9 3A 89 63            ld      a,(PRE_HAMMER_TUNE)
10626  2EFC 32 89 60            ld      (SONG_TRIGGER),a
10627  2EFF                     
10628  2EFF                     ; Set the hammer's x coordinate based on
10629  2EFF                     ; the hammer's offset from Mario
10630  2EFF EB          l2f7c:  ex      de,hl
10631  2F00 3A 03 62            ld      a,(MARIO_X)
10632  2F03 DD 86 0E            add     a,(ix+14)					; X offset					; X offset
10633  2F06 77                  ld      (hl),a						; Hammer sprite x coordinate
10634  2F07 DD 77 03            ld      (ix+3),a					; X coordinate
10635  2F0A                     
10636  2F0A                     ; Update the hammer sprite number and palette
10637  2F0A 23                  inc     hl							; Sprite number
10638  2F0B 70                  ld      (hl),b					
10639  2F0C 23                  inc     hl							; Sprite palette
10640  2F0D 71                  ld      (hl),c
10641  2F0E                     
10642  2F0E                     ; Set the hammer y coordinate based on the offset from Mario
10643  2F0E 23                  inc     hl							; Y coordinate
10644  2F0F 3A 05 62            ld      a,(MARIO_Y)
10645  2F12 DD 86 0F            add     a,(ix+15)					; Y offset
10646  2F15 77                  ld      (hl),a
10647  2F16 DD 77 05            ld      (ix+5),a					; Y coordinate
10648  2F19 C9                  ret     
10649  2F1A                     
10650  2F1A             		; If the hammer has not been grabbed, return
10651  2F1A 3A 18 62    l2f97:  ld      a,(HAMMER_GRABBED)
10652  2F1D 0F                  rrca    
10653  2F1E D0                  ret     nc
10654  2F1F             		
10655  2F1F DD 36 09 06         ld      (ix+9),6
10656  2F23 DD 36 0A 03         ld      (ix+10),3
10657  2F27                     
10658  2F27                     ; Set b to the upright hammer sprite horizontally flipped to match Mario
10659  2F27 3A 07 62            ld      a,(MARIO_DATA_SPRITE_NUM)
10660  2F2A 07                  rlca    
10661  2F2B 3E 3C               ld      a,$3c						; $1e shifted left 1 bit
10662  2F2D 1F                  rra     
10663  2F2E 47                  ld      b,a
10664  2F2F                     
10665  2F2F                     ; Use palette 7
10666  2F2F 0E 07               ld      c,7							; Palette 7
10667  2F31                     
10668  2F31             		; Save the current tune so that it can be restored after the hammer cycle is over
10669  2F31 3A 89 60            ld      a,(SONG_TRIGGER)
10670  2F34 32 89 63            ld      (PRE_HAMMER_TUNE),a
10671  2F37                     
10672  2F37                     ; Jump back up to update the hammer sprite
10673  2F37 C3 FF 2E            jp      l2f7c
10674  2F3A                     
10675  2F3A             		; If the hammer cycle counter has not yet wrapped once,
10676  2F3A             		; jump back up to update the hammer sprite
10677  2F3A 3A 95 63    l2fb7:  ld      a,(HAMMER_CYCLE_WRAP_COUNTER)
10678  2F3D A7                  and     a
10679  2F3E CA FF 2E            jp      z,l2f7c
10680  2F41             		
10681  2F41             		; Cycle the hammer palette to provide a visual indication that
10682  2F41             		; the hammer will disappear soon
10683  2F41             		
10684  2F41             		; If it is not time to change the hammer color,
10685  2F41             		; Jump back up to update the hammer sprite
10686  2F41 3A 1A 60    l2fbe:  ld      a,(COUNTER_2)
10687  2F44 CB 5F               bit     3,a
10688  2F46 CA FF 2E            jp      z,l2f7c
10689  2F49             		
10690  2F49             		; Set the palette to 1 and jump back up to update the hammer sprite
10691  2F49 0E 01               ld      c,1
10692  2F4B C3 FF 2E            jp      l2f7c
10693  2F4E             ;------------------------------------------------------------------------------
10694  2F4E             		
10695  2F4E             
10696  2F4E             		
10697  2F4E             ;------------------------------------------------------------------------------
10698  2F4E             l2fcb:  
10699  2F4E             		; Return unless this is the mixer stage, elevators stage, or rivets stage
10700  2F4E 3E 0E       		ld      a,%00001110
10701  2F50 F7                  rst     $30			
10702  2F51             		
10703  2F51 21 B4 62            ld      hl,$62b4
10704  2F54 35                  dec     (hl)
10705  2F55 C0                  ret     nz
10706  2F56             		
10707  2F56             		; Make the barrel fire flare up 
10708  2F56 3E 03               ld      a,3
10709  2F58 32 B9 62            ld      (BARREL_FIRE_STATE),a
10710  2F5B             		
10711  2F5B             		
10712  2F5B 32 96 63            ld      (RELEASE_SPRING),a
10713  2F5E             		
10714  2F5E             		; Redisplay the timer
10715  2F5E 11 01 05            ld      de,$0501
10716  2F61 CD 22 30            call    L_ADD_EVENT
10717  2F64             
10718  2F64             		
10719  2F64 3A B3 62            ld      a,($62b3)
10720  2F67 77                  ld      (hl),a
10721  2F68             		
10722  2F68 21 B1 62            ld      hl,$62b1
10723  2F6B 35                  dec     (hl)
10724  2F6C                     
10725  2F6C C0          		ret     nz
10726  2F6D             
10727  2F6D 3E 01               ld      a,1
10728  2F6F 32 86 63            ld      ($6386),a
10729  2F72 C9                  ret     
10730  2F73             ;------------------------------------------------------------------------------
10731  2F73             
10732  2F73             
10733  2F73             
10734  2F73             ;------------------------------------------------------------------------------
10735  2F73             ; Convert a two byte tile location into a tile memory address
10736  2F73             ; passed:  hl - the stage location data
10737  2F73             ; return:  hl - the tile memory address
10738  2F73             L_STAGE_LOC_TO_ADDRESS:  
10739  2F73             		; Isolate the x coord (5 MSBs in l)
10740  2F73 7D          		ld      a,l
10741  2F74 0F                  rrca    
10742  2F75 0F                  rrca    
10743  2F76 0F                  rrca    
10744  2F77 E6 1F               and     %00011111
10745  2F79 6F                  ld      l,a
10746  2F7A             
10747  2F7A             		; Isolate the y coord (5 MSBs in h)
10748  2F7A 7C                  ld      a,h
10749  2F7B 2F                  cpl     							; Invert a
10750  2F7C E6 F8               and     %11111000
10751  2F7E 5F                  ld      e,a
10752  2F7F             
10753  2F7F             		; Convert the x and y to a tile memory address
10754  2F7F AF                  xor     a
10755  2F80 67                  ld      h,a
10756  2F81 CB 13               rl      e						
10757  2F83 17                  rla     
10758  2F84 CB 13               rl      e
10759  2F86 17                  rla     							; a = 2 MSBs in e
10760  2F87 C6 74               add     a,$74
10761  2F89 57                  ld      d,a
10762  2F8A 19                  add     hl,de
10763  2F8B C9                  ret     
10764  2F8C             ;------------------------------------------------------------------------------
10765  2F8C             
10766  2F8C             
10767  2F8C             
10768  2F8C             ;------------------------------------------------------------------------------
10769  2F8C             ; I have absolutely no idea what this function does...
10770  2F8C             ; passed:	a - 
10771  2F8C             ;			b - 
10772  2F8C             ; return:	a
10773  2F8C             l3009:  
10774  2F8C             		; Copy a to d
10775  2F8C 57          		ld      d,a
10776  2F8D             		
10777  2F8D             		; If a is 1, 3, or 5, jump ahead
10778  2F8D 0F                  rrca    
10779  2F8E DA A5 2F            jp      c,l3022
10780  2F91             
10781  2F91             		; If a is 0 or 2, set c to $93
10782  2F91 0E 93               ld      c,$93
10783  2F93 0F                  rrca    
10784  2F94 0F                  rrca    
10785  2F95 D2 9A 2F            jp      nc,l3017
10786  2F98             		
10787  2F98             		; If a is 4, set c to $6c
10788  2F98 0E 6C               ld      c,$6c
10789  2F9A             		
10790  2F9A             		; If a is 2, jump ahead
10791  2F9A 07          l3017:  rlca    
10792  2F9B DA B4 2F            jp      c,l3031
10793  2F9E             		
10794  2F9E             		; Isolate the 4 MSBs of c
10795  2F9E 79                  ld      a,c
10796  2F9F E6 F0               and     %11110000
10797  2FA1 4F                  ld      c,a
10798  2FA2             		
10799  2FA2 C3 B4 2F            jp      l3031
10800  2FA5             		
10801  2FA5             		; If a is 1 or 3, set c to $b4
10802  2FA5 0E B4       l3022:  ld      c,$b4
10803  2FA7 0F                  rrca    
10804  2FA8 0F                  rrca    
10805  2FA9 D2 AE 2F            jp      nc,l302b
10806  2FAC             		
10807  2FAC             		; If a is 5, set c to $1e
10808  2FAC 0E 1E               ld      c,$1e
10809  2FAE             		
10810  2FAE             		; If b is >= 4, jump ahead to skip decrementing b
10811  2FAE CB 50       l302b:  bit     2,b
10812  2FB0 CA B4 2F            jp      z,l3031
10813  2FB3             		
10814  2FB3 05                  dec     b
10815  2FB4             		
10816  2FB4             		; Rotate c two bits right
10817  2FB4 79          l3031:  ld      a,c
10818  2FB5 0F                  rrca    
10819  2FB6 0F                  rrca    
10820  2FB7 4F                  ld      c,a
10821  2FB8             		
10822  2FB8             		; If the 2 LSBs of c are not equal to b, 
10823  2FB8             		; jump back up to rotate it again
10824  2FB8 E6 03               and     %00000011
10825  2FBA B8                  cp      b		
10826  2FBB C2 B4 2F            jp      nz,l3031
10827  2FBE             		
10828  2FBE             		; Rotate c two bits right
10829  2FBE 79                  ld      a,c
10830  2FBF 0F                  rrca    
10831  2FC0 0F                  rrca    
10832  2FC1             		
10833  2FC1             		; If the 2 LSBs of c are not both 1's, retrun
10834  2FC1 E6 03               and     %00000011
10835  2FC3 FE 03               cp      3
10836  2FC5 C0                  ret     nz		
10837  2FC6             		
10838  2FC6 CB 92               res     2,d
10839  2FC8 15                  dec     d
10840  2FC9 C0                  ret     nz
10841  2FCA                     
10842  2FCA 3E 04       		ld      a,4
10843  2FCC C9                  ret     
10844  2FCD             ;------------------------------------------------------------------------------
10845  2FCD             
10846  2FCD             
10847  2FCD             
10848  2FCD             ;------------------------------------------------------------------------------
10849  2FCD             ; Animate the ladder being pulled up on the introduction stage by erasing each 
10850  2FCD             ; row of the ladder one by one
10851  2FCD             L_ANIMATE_LADDER_PULL_UP:  
10852  2FCD 11 E0 FF    		ld      de,-32
10853  2FD0             		
10854  2FD0             		; Get the current ladder row to erase
10855  2FD0 3A 8E 63            ld      a,(LADDER_ROW_TO_ERASE)
10856  2FD3 4F                  ld      c,a
10857  2FD4 06 00               ld      b,0						; bc = row
10858  2FD6                     
10859  2FD6                     ; Erase each ladder tile at the current row
10860  2FD6 21 00 76            ld      hl,TILE_COORD(16,0)
10861  2FD9 CD E7 2F            call    L_ERASE_INTRO_LADDER_TILE
10862  2FDC 21 C0 75            ld      hl,TILE_COORD(14,0)
10863  2FDF CD E7 2F            call    L_ERASE_INTRO_LADDER_TILE
10864  2FE2                     
10865  2FE2                     ; Advance to the next row
10866  2FE2 21 8E 63            ld      hl,LADDER_ROW_TO_ERASE
10867  2FE5 35                  dec     (hl)
10868  2FE6 C9                  ret     
10869  2FE7             ;------------------------------------------------------------------------------
10870  2FE7             
10871  2FE7             
10872  2FE7             
10873  2FE7             ;------------------------------------------------------------------------------
10874  2FE7             ; Animate the ladders on the introduction stage being pulled up by overwriting 
10875  2FE7             ; a ladder tile with the tile to the left of it
10876  2FE7             ; passed:  hl - screen memory address of the tile just to the left of the one to
10877  2FE7             ;				overwrite
10878  2FE7             ;			bc - the row to act on
10879  2FE7             ;			de - -32
10880  2FE7             L_ERASE_INTRO_LADDER_TILE:  
10881  2FE7             		; Overwrite the ladder tile with the tile to the left
10882  2FE7 09          		add     hl,bc
10883  2FE8 7E                  ld      a,(hl)
10884  2FE9 19                  add     hl,de
10885  2FEA 77                  ld      (hl),a
10886  2FEB C9                  ret     
10887  2FEC             ;------------------------------------------------------------------------------
10888  2FEC             
10889  2FEC             
10890  2FEC             
10891  2FEC             ;------------------------------------------------------------------------------
10892  2FEC             ; Advances the current game state variable once the minor timer runs down
10893  2FEC             L_PAUSE_CURRENT_STATE:  
10894  2FEC DF          		rst     $18						; Return until the minor timer has run down
10895  2FED             		
10896  2FED             		; Advance the current state variable
10897  2FED 2A C0 63            ld      hl,(CURRENT_STATE_VAR_POINTER)
10898  2FF0 34                  inc     (hl)
10899  2FF1 C9                  ret     
10900  2FF2             ;------------------------------------------------------------------------------
10901  2FF2             
10902  2FF2             
10903  2FF2             
10904  2FF2             ;------------------------------------------------------------------------------
10905  2FF2             ; Animate Donkey Kong carrying Pauline up the ladders on the introduction stage
10906  2FF2             L_ANIMATE_CLIMBING_LADDERS:  
10907  2FF2             		; Return until 8 increments of counter have occured
10908  2FF2 21 AF 62    		ld      hl,DK_CLIMBING_COUNTER
10909  2FF5 34                  inc     (hl)
10910  2FF6 7E                  ld      a,(hl)
10911  2FF7 E6 07               and     %0111
10912  2FF9 C0                  ret     nz
10913  2FFA                     
10914  2FFA                     ; Move Donkey Kong up 4 pixels
10915  2FFA 21 0B 69            ld      hl,DK_SPRITE_1_Y
10916  2FFD 0E FC               ld      c,-4
10917  2FFF FF                  rst     $38
10918  3000                     
10919  3000                     ; Alternate between Donkey Kong's climbing arm sprites
10920  3000 0E 81               ld      c,%10000001
10921  3002 21 09 69            ld      hl,DK_SPRITE_1_NUM
10922  3005 CD 19 30            call    L_ALT_DK_ARMS_AND_LEGS
10923  3008              
10924  3008                     ; Alternate between Donkey Kong's climbing leg sprites
10925  3008 21 1D 69            ld      hl,DK_SPRITE_6_NUM
10926  300B CD 19 30            call    L_ALT_DK_ARMS_AND_LEGS
10927  300E                     
10928  300E                     ; Randomly flip Pauline's struggling legs
10929  300E CD 57 00            call    L_UPDATE_RAND_NUM
10930  3011 E6 80               and     %10000000
10931  3013 21 2D 69            ld      hl,DK_SPRITE_10_NUM
10932  3016 AE                  xor     (hl)
10933  3017 77                  ld      (hl),a
10934  3018                     
10935  3018 C9                  ret     
10936  3019             ;------------------------------------------------------------------------------
10937  3019             
10938  3019             
10939  3019             
10940  3019             ;------------------------------------------------------------------------------
10941  3019             ; Alternate Donkey Kong's arm or leg sprites to animate Donkey Kong's climb up
10942  3019             ; the ladders 
10943  3019             ; passed:  a - $81
10944  3019             ;			hl - address of a Donkey Kong sprite y coord
10945  3019             ;			de - 4
10946  3019             L_ALT_DK_ARMS_AND_LEGS:  
10947  3019             		; Alternate Donkey Kong's arms between sprites $34 and $35
10948  3019             		; to animate Donkey Kong climbing the ladders
10949  3019 06 02       		ld      b,2						; For b = 2 to 1
10950  301B 79          l3098:  ld      a,c						; %1001
10951  301C AE                  xor     (hl)
10952  301D 77                  ld      (hl),a
10953  301E 19                  add     hl,de					; Next arm sprite y coord
10954  301F 10 FA               djnz    l3098					; Next b
10955  3021 C9                  ret     
10956  3022             ;------------------------------------------------------------------------------
10957  3022             
10958  3022             
10959  3022             
10960  3022             ;------------------------------------------------------------------------------
10961  3022             ; Add function to circular event buffer to be processed and called during the
10962  3022             ; next interrupt
10963  3022             ; Event numbers:
10964  3022             ;	0 = Award points
10965  3022             ;		0 = 0 points
10966  3022             ;		1 = 100 points
10967  3022             ;		2 = 200 points
10968  3022             ;		...
10969  3022             ;		9 = 900 points
10970  3022             ;		10 = 0 points
10971  3022             ;		11 = 1000 points
10972  3022             ;		12 = 2000 points
10973  3022             ;		...
10974  3022             ;		19 = 9000 points
10975  3022             ;
10976  3022             ;	1 = Clear scores
10977  3022             ;
10978  3022             ;	2 = Display scores
10979  3022             ;		0 = Display player 1 score
10980  3022             ;		1 = Display player 2 score
10981  3022             ;		2 = Display high score
10982  3022             ;		3 = Display all scored
10983  3022             ;
10984  3022             ;	3 = Display a string from the string table
10985  3022             ;		
10986  3022             ;	4 = Display the number of plays earned
10987  3022             ;
10988  3022             ;	5 = Display the timer
10989  3022             ;		0 = Add the timer to the player's score
10990  3022             ;		1 = Don't add the timer to the player's score
10991  3022             ;
10992  3022             ;	6 = Display current lives and level number
10993  3022             ;		0 = Don't subtract a life first
10994  3022             ;		1 = Do subtract a life first
10995  3022             ;
10996  3022             ; passed:	d - the event number
10997  3022             ;			e - the argument to pass to the function
10998  3022             L_ADD_EVENT:  
10999  3022 E5          		push    hl
11000  3023 21 C0 60            ld      hl,$60c0
11001  3026 3A B0 60            ld      a,(ACTION_BUFFER_WRITE_POS)
11002  3029 6F                  ld      l,a
11003  302A CB 7E               bit     7,(hl)
11004  302C CA 3E 30            jp      z,l30bb
11005  302F 72                  ld      (hl),d
11006  3030 2C                  inc     l
11007  3031 73                  ld      (hl),e
11008  3032 2C                  inc     l
11009  3033 7D                  ld      a,l
11010  3034 FE C0               cp      $c0
11011  3036 D2 3B 30            jp      nc,l30b8
11012  3039 3E C0               ld      a,$c0
11013  303B 32 B0 60    l30b8:  ld      (ACTION_BUFFER_WRITE_POS),a
11014  303E E1          l30bb:  pop     hl
11015  303F C9                  ret     
11016  3040             ;------------------------------------------------------------------------------
11017  3040             
11018  3040             
11019  3040             
11020  3040             ;------------------------------------------------------------------------------
11021  3040             ; Clear sprites before running the death animation
11022  3040             L_CLEAR_SPRITES_WHEN_DEAD:  
11023  3040             		; Clear the collision detection sprites
11024  3040 21 50 69    		ld      hl,COLLISION_AREA_SPRITES
11025  3043 06 02               ld      b,2						; For b = 2 to 1
11026  3045 CD 67 30            call    l30e4
11027  3048                     
11028  3048                     ; Clear $6980 through $69a4
11029  3048 2E 80               ld      l,$80					; hl = $6980
11030  304A 06 0A               ld      b,10						; For b = 10 to 1
11031  304C CD 67 30            call    l30e4
11032  304F                     
11033  304F                     ; Clear the pie and conveyer motor sprites
11034  304F 2E B8               ld      l,$b8					; hl = PIE_SPRITES
11035  3051 06 0B               ld      b,11						; For b = 11 to 1
11036  3053 CD 67 30            call    l30e4
11037  3056                     
11038  3056                     ; Clear the prize and hammer sprites
11039  3056 21 0C 6A            ld      hl,PRIZE_SPRITES
11040  3059 06 05               ld      b,5						; For b = 5 to 1
11041  305B C3 67 30            jp      l30e4
11042  305E                     
11043  305E                     
11044  305E             L_CLEAR_MARIO_SPRITE:  
11045  305E             		; Clear the Mario sprite
11046  305E 21 4C 69    		ld      hl,MARIO_SPRITE_X
11047  3061 36 00               ld      (hl),0
11048  3063                     
11049  3063                     ; Clear the elevator platform sprites
11050  3063 2E 58               ld      l,$58					; hl = ELEVATOR_PLATFORM_SPRITES
11051  3065 06 06               ld      b,6
11052  3067                     
11053  3067 7D          l30e4:  ld      a,l
11054  3068             
11055  3068             		; Set the current sprite's x coordinate to 0
11056  3068 36 00       l30e5:  ld      (hl),0
11057  306A             
11058  306A             		; Advance to the next sprite
11059  306A C6 04               add     a,4
11060  306C 6F                  ld      l,a
11061  306D 10 F9               djnz    l30e5					; Next b
11062  306F                     
11063  306F C9                  ret     
11064  3070             ;------------------------------------------------------------------------------
11065  3070             
11066  3070             
11067  3070             ;------------------------------------------------------------------------------
11068  3070             L_IMPLEMENT_FIREBALLS:  
11069  3070             		; Return if it is not time to update the fireballs
11070  3070             		; (Fireballs are updated faster on higher difficulty levels)
11071  3070 CD 7D 30    		call    L_CONTROL_FIREBALL_SPEED
11072  3073             
11073  3073             		; Spawn new fireballs if it is time
11074  3073             		; Return from this function if there are no active fireballs
11075  3073 CD BB 30            call    L_SPAWN_FIREBALLS
11076  3076             		
11077  3076             		; Make the fireballs move
11078  3076 CD 27 31            call    L_PROCESS_EACH_FIREBALL
11079  3079             		
11080  3079             		; Update the fireball sprites to match the fireball data structures
11081  3079 CD 65 34            call    L_UPDATE_FIREBALL_SPRITES
11082  307C C9                  ret     
11083  307D             ;------------------------------------------------------------------------------
11084  307D             
11085  307D             
11086  307D             
11087  307D             ;------------------------------------------------------------------------------
11088  307D             ; This function controls how often the fireballs are updated
11089  307D             ; based on the current difficulty level (up to a maximum of 5).
11090  307D             ; The fireballs are updated slower (and, thus, move slower) on
11091  307D             ; slower difficulty levels.  As the difficulty level increases,
11092  307D             ; so does the fireball speed.
11093  307D             L_CONTROL_FIREBALL_SPEED:  
11094  307D             		; Jump to one of the following functions based on the
11095  307D             		; difficulty level (up to a maximum of 5)
11096  307D 3A 80 63    		ld      a,(CP_DIFFICULTY)
11097  3080 FE 06               cp      6
11098  3082 38 02               jr      c,l3103
11099  3084 3E 05               ld      a,5
11100  3086 EF          l3103:  rst     $28							; Jump to local table address
11101  3087             		; Jump table
11102  3087 93 30       		.word	L_CONTROL_FIREBALL_SPEED_0_1	; 0 = 
11103  3089 93 30       		.word	L_CONTROL_FIREBALL_SPEED_0_1	; 1 = 
11104  308B 9D 30       		.word	L_CONTROL_FIREBALL_SPEED_2	; 2 = 
11105  308D A7 30       		.word	L_CONTROL_FIREBALL_SPEED_3_4	; 3 = 
11106  308F A7 30       		.word	L_CONTROL_FIREBALL_SPEED_3_4	; 4 = 
11107  3091 B1 30       		.word	L_CONTROL_FIREBALL_SPEED_5 	; 5 = 
11108  3093             ;------------------------------------------------------------------------------
11109  3093             
11110  3093             
11111  3093             ;------------------------------------------------------------------------------
11112  3093             ; Difficulty levels 0 and 1
11113  3093             ; Fireballs are processed one out of two calls
11114  3093             L_CONTROL_FIREBALL_SPEED_0_1:  
11115  3093             		; Return if counter 2 is odd
11116  3093 3A 1A 60    		ld      a,(COUNTER_2)
11117  3096 E6 01               and     %00000001
11118  3098 FE 01               cp      1
11119  309A C8                  ret     z
11120  309B             		
11121  309B             		; Return from the calling function if counter 2 is even
11122  309B E1                  pop		hl
11123  309C C9                  ret     
11124  309D             ;------------------------------------------------------------------------------
11125  309D             
11126  309D             
11127  309D             
11128  309D             ;------------------------------------------------------------------------------
11129  309D             ; Difficulty level 2
11130  309D             ; Fireballs are processed 5 out of 8 times
11131  309D             L_CONTROL_FIREBALL_SPEED_2: 	
11132  309D             		; Return if the 3 LSBs of counter 2 are less than 5
11133  309D 3A 1A 60    		ld      a,(COUNTER_2)
11134  30A0 E6 07               and     %00000111
11135  30A2 FE 05               cp      5
11136  30A4 F8                  ret     m
11137  30A5             		
11138  30A5             		; Return from the calling function 
11139  30A5             		; if the 3 LSBs of counter 2 are greater than or equal to 5
11140  30A5 E1                  pop		hl
11141  30A6 C9                  ret     
11142  30A7             ;------------------------------------------------------------------------------
11143  30A7             
11144  30A7             
11145  30A7             
11146  30A7             ;------------------------------------------------------------------------------
11147  30A7             ; Difficulty levels 3 and 4
11148  30A7             ; Fireballs are processed 3 out of 4 times?
11149  30A7             L_CONTROL_FIREBALL_SPEED_3_4:  
11150  30A7             		; Return if the 2 LSBs of counter 2 are not equal to 3
11151  30A7 3A 1A 60    		ld      a,(COUNTER_2)
11152  30AA E6 03               and     %00000011
11153  30AC FE 03               cp      3
11154  30AE F8                  ret     m
11155  30AF             		
11156  30AF             		; Return from the calling function 
11157  30AF             		; if the 2 LSBs of counter 2 are 3
11158  30AF E1                  pop		hl
11159  30B0 C9                  ret     
11160  30B1             ;------------------------------------------------------------------------------
11161  30B1             
11162  30B1             
11163  30B1             
11164  30B1             ;------------------------------------------------------------------------------
11165  30B1             ; Difficulty level 5
11166  30B1             ; Fireballs are processed 7 out of 8 times
11167  30B1             L_CONTROL_FIREBALL_SPEED_5:	
11168  30B1             		; Return if the 3 LSBs of counter 2 are not equal to 7
11169  30B1 3A 1A 60    		ld      a,(COUNTER_2)
11170  30B4 E6 07               and     %00000111
11171  30B6 FE 07               cp      7
11172  30B8 F8                  ret     m
11173  30B9             
11174  30B9             		; Return from the calling function
11175  30B9             		; if the 3 LSBs of counter 2 are 7
11176  30B9 E1          		pop		hl
11177  30BA C9                  ret     
11178  30BB             ;------------------------------------------------------------------------------
11179  30BB             
11180  30BB             
11181  30BB             
11182  30BB             ;------------------------------------------------------------------------------
11183  30BB             ; This function counts the number of active fireballs,
11184  30BB             ; Spawns new ones when it is time to and there are open fireball
11185  30BB             ; data structures,
11186  30BB             ; Returns from the calling function if there are no active 
11187  30BB             ; fireballs
11188  30BB             ;
11189  30BB             ; NOTE: Apparently, the number of active fireballs on the mixer
11190  30BB             ;		stage is limited by the current difficulty level.  
11191  30BB             ;		I did not know that...
11192  30BB             L_SPAWN_FIREBALLS:  
11193  30BB DD 21 00 64 		ld      ix,FIREBALL_STRUCTS
11194  30BF             		
11195  30BF             		; Set the active fireball count to 0
11196  30BF AF                  xor     a
11197  30C0 32 A1 63            ld      (ACTIVE_FIREBALL_COUNT),a
11198  30C3             		
11199  30C3             		; Examine each fireball data structure
11200  30C3 06 05               ld      b,5							; 5 fireballs
11201  30C5 11 20 00            ld      de,32						; 32 byte data structures
11202  30C8             
11203  30C8             		; If this fireball is not active, jump ahead
11204  30C8 DD 7E 00    l3149:  ld      a,(ix+0)
11205  30CB FE 00               cp      0
11206  30CD CA FA 30            jp      z,l317c
11207  30D0             		
11208  30D0             		; Increment the fireball index
11209  30D0 3A A1 63            ld      a,(ACTIVE_FIREBALL_COUNT)
11210  30D3 3C                  inc     a
11211  30D4 32 A1 63            ld      (ACTIVE_FIREBALL_COUNT),a
11212  30D7             		
11213  30D7             		; If the hammer cycle is not active,
11214  30D7             		; set the fireball sprite palette to 1
11215  30D7             		; (normal fireball colors)
11216  30D7 3E 01               ld      a,1
11217  30D9 DD 77 08            ld      (ix+8),a
11218  30DC 3A 17 62            ld      a,(HAMMER_CYCLE_ACTIVE)
11219  30DF FE 01               cp      1
11220  30E1 C2 E9 30            jp      nz,l316a
11221  30E4             		
11222  30E4             		; If the hammer cycle is active,
11223  30E4             		; set the fireball sprite palette to 0
11224  30E4             		; (inverted fireball colors)
11225  30E4 3E 00               ld      a,0
11226  30E6 DD 77 08            ld      (ix+8),a
11227  30E9             		
11228  30E9             		; Process the next fireball
11229  30E9 DD 19       l316a:  add     ix,de
11230  30EB 10 DB               djnz    l3149						; Next b
11231  30ED             
11232  30ED             		; Set the fireball release trigger to 0
11233  30ED 21 A0 63            ld      hl,RELEASE_A_FIREBALL
11234  30F0 36 00               ld      (hl),0
11235  30F2             		
11236  30F2             		; If there are active fireballs, return
11237  30F2 3A A1 63            ld      a,(ACTIVE_FIREBALL_COUNT)
11238  30F5 FE 00               cp      0
11239  30F7 C0                  ret     nz
11240  30F8             		
11241  30F8             		; If there are no active fireballs, 
11242  30F8             		; return from the calling function
11243  30F8 E1                  pop		hl
11244  30F9 C9                  ret     
11245  30FA             		
11246  30FA             		
11247  30FA             		; The current fireball data structure (in ix)
11248  30FA             		; is not being used
11249  30FA             l317c:  ; If this is not the mixer stage, jump ahead
11250  30FA 3A 27 62            ld      a,(CURRENT_STAGE)
11251  30FD FE 02               cp      2
11252  30FF C2 0B 31            jp      nz,l3195
11253  3102             		
11254  3102             		; If the number of active fireballs 
11255  3102             		; already matches the difficulty level, return
11256  3102 3A A1 63            ld      a,(ACTIVE_FIREBALL_COUNT)
11257  3105 4F                  ld      c,a
11258  3106 3A 80 63            ld      a,(CP_DIFFICULTY)
11259  3109 B9                  cp      c
11260  310A C8                  ret     z
11261  310B             		
11262  310B             		; If it is not time to release a fireball,
11263  310B             		; jump back up to process the next fireball
11264  310B             		; data structure
11265  310B 3A A0 63    l3195:  ld      a,(RELEASE_A_FIREBALL)
11266  310E FE 01               cp      1
11267  3110 C2 E9 30            jp      nz,l316a
11268  3113             		
11269  3113             		; Set this fireball active
11270  3113 DD 77 00            ld      (ix+0),a					; Active
11271  3116             		
11272  3116             		; Mark that this fireball needs to be initialized
11273  3116 DD 77 18            ld      (ix+24),a					; Not initialized
11274  3119             		
11275  3119             		; Turn off the fireball release flag
11276  3119 AF                  xor     a
11277  311A 32 A0 63            ld      (RELEASE_A_FIREBALL),a
11278  311D             		
11279  311D             		; Increment the number of active fireballs
11280  311D 3A A1 63            ld      a,(ACTIVE_FIREBALL_COUNT)
11281  3120 3C                  inc     a
11282  3121 32 A1 63            ld      (ACTIVE_FIREBALL_COUNT),a
11283  3124             		
11284  3124             		; Jump back up to process the next fireball
11285  3124 C3 E9 30            jp      l316a
11286  3127             ;------------------------------------------------------------------------------
11287  3127             
11288  3127             
11289  3127             
11290  3127             ;------------------------------------------------------------------------------
11291  3127             ; Update each fireball in turn
11292  3127             L_PROCESS_EACH_FIREBALL:  
11293  3127             		; Make fireballs 2 and 4 move left roughly 25% of the time
11294  3127 CD 53 31    		call    L_FIREBALLS_ABRUPT_LEFT
11295  312A             		
11296  312A             		; Initialize the count of updated fireballs
11297  312A AF                  xor     a
11298  312B 32 A2 63            ld      (UPDATED_FIREBALL_COUNT),a
11299  312E             		
11300  312E             		; Process each fireball
11301  312E 21 E0 63            ld      hl,FIREBALL_STRUCTS - 32	; 32 bytes before the first fireball data structure
11302  3131 22 C8 63            ld      (CURRENT_FIREBALL),hl
11303  3134 2A C8 63    l31be:  ld      hl,(CURRENT_FIREBALL)
11304  3137 01 20 00            ld      bc,32
11305  313A 09                  add     hl,bc
11306  313B 22 C8 63            ld      (CURRENT_FIREBALL),hl
11307  313E             		
11308  313E             		; If this fireball is not active, 
11309  313E             		; jump ahead to skip processing it
11310  313E 7E                  ld      a,(hl)
11311  313F A7                  and     a
11312  3140 CA 46 31            jp      z,l31d0
11313  3143             		
11314  3143             		; Update this fireball
11315  3143             		; Make it move, climb ladders, etc
11316  3143 CD 78 31            call    L_UPDATE_CURRENT_FIREBALL
11317  3146             
11318  3146             		; Increment the number of fireballs that have been processed
11319  3146 3A A2 63    l31d0:  ld      a,(UPDATED_FIREBALL_COUNT)
11320  3149 3C                  inc     a
11321  314A 32 A2 63            ld      (UPDATED_FIREBALL_COUNT),a
11322  314D             		
11323  314D             		; If there are still more fireballs to process,
11324  314D             		; jump back up to process the next one
11325  314D FE 05               cp      5
11326  314F C2 34 31            jp      nz,l31be
11327  3152             		
11328  3152 C9                  ret     
11329  3153             ;------------------------------------------------------------------------------
11330  3153             
11331  3153             
11332  3153             
11333  3153             ;------------------------------------------------------------------------------
11334  3153             ; This function makes the 2nd and 4th fireballs turn left roughly 25% of the 
11335  3153             ; time on difficulty level 3 or higher
11336  3153             ; I have no idea why
11337  3153             L_FIREBALLS_ABRUPT_LEFT:  
11338  3153             		; Return if the difficulty level is less than 3
11339  3153 3A 80 63    		ld      a,(CP_DIFFICULTY)
11340  3156 FE 03               cp      3
11341  3158 F8                  ret     m
11342  3159             		
11343  3159             		; Roughly a 25% chance of continuing 
11344  3159 CD 6C 31            call    L_ROUGH_25_P_CHANCE
11345  315C FE 01               cp      1
11346  315E C0                  ret     nz
11347  315F             		
11348  315F             		; Make fireballs 2 and 4 move left
11349  315F 21 39 64            ld      hl,FIREBALL_STRUCT_2+25		; Direction
11350  3162 3E 02               ld      a,2
11351  3164 77                  ld      (hl),a
11352  3165 21 79 64            ld      hl,FIREBALL_STRUCT_4+25		; Direction
11353  3168 3E 02               ld      a,2
11354  316A 77                  ld      (hl),a
11355  316B C9                  ret     
11356  316C             ;------------------------------------------------------------------------------
11357  316C             
11358  316C             
11359  316C             
11360  316C             ;------------------------------------------------------------------------------
11361  316C             ; This function returns a 1 roughly 25% of the time
11362  316C             L_ROUGH_25_P_CHANCE:  
11363  316C             		; 25% chance of returning a 1
11364  316C 3A 18 60    		ld      a,(RANDOM_NUMBER)
11365  316F E6 03               and     %00000011
11366  3171 FE 01               cp      1
11367  3173 C0                  ret     nz
11368  3174             		
11369  3174             		; Return the value of counter 2
11370  3174 3A 1A 60            ld      a,(COUNTER_2)
11371  3177 C9                  ret     
11372  3178             ;------------------------------------------------------------------------------
11373  3178             
11374  3178             
11375  3178             
11376  3178             ;------------------------------------------------------------------------------
11377  3178             ; This function updates the current fireball's state and position
11378  3178             L_UPDATE_CURRENT_FIREBALL:  
11379  3178             		; Work with the currently active fireball
11380  3178 DD 2A C8 63 		ld      ix,(CURRENT_FIREBALL)
11381  317C             
11382  317C             		; If the fireball has not been initialized yet
11383  317C DD 7E 18            ld      a,(ix+24)					; Not initialized
11384  317F FE 01               cp      1
11385  3181 CA F0 31            jp      z,l327a
11386  3184             		
11387  3184             		; If the fireball is moving up or down,
11388  3184             		; jump ahead to skip handling horizontal movement
11389  3184 DD 7E 0D            ld      a,(ix+13)					; Fireball direction
11390  3187 FE 04               cp      4
11391  3189 F2 A6 31            jp      p,l3230
11392  318C             		
11393  318C             		; If the fireball needs to pause, 
11394  318C             		; jump ahead to handle it
11395  318C DD 7E 19            ld      a,(ix+25)
11396  318F FE 02               cp      2
11397  3191 CA F4 31            jp      z,l327e
11398  3194                     
11399  3194             		; Make the fireball change direction periodically
11400  3194 CD 85 32    		call    L_CHANGE_FIREBALL_DIR
11401  3197                     
11402  3197 3A 18 60    		ld      a,(RANDOM_NUMBER)
11403  319A E6 03               and     %00000011
11404  319C C2 A9 31            jp      nz,l3233
11405  319F             		
11406  319F             		; If the fireball is standing still, 
11407  319F             		; jump ahead to make the fireball bob without moving
11408  319F DD 7E 0D    l3229:  ld      a,(ix+13)					; Fireball direction
11409  31A2 A7                  and     a
11410  31A3 CA CD 31            jp      z,l3257
11411  31A6             		
11412  31A6             		; Handle the fireball climbing up and down ladders
11413  31A6             		; If the fireball can climb a ladder, this function decides
11414  31A6             		; if it should
11415  31A6 CD B3 32    l3230:  call    L_HANDLE_FIREBALLS_AND_LADDERS
11416  31A9             
11417  31A9             		; If the fireball is moving up or down,
11418  31A9             		; jump (way) ahead 
11419  31A9 DD 7E 0D    l3233:  ld      a,(ix+13)					; Fireball direction
11420  31AC FE 04               cp      4
11421  31AE F2 07 32            jp      p,l3291
11422  31B1             		
11423  31B1             		; Update the fireball's position while its walking
11424  31B1 CD 1F 33            call    L_UPDATE_FIREBALL_WALK
11425  31B4             		
11426  31B4             		; If the fireball is attempting to move off a girder,
11427  31B4             		; jump ahead to reverse its direction
11428  31B4 CD 1C 29            call    L_CHECK_IF_NOT_SUPPORTED
11429  31B7 FE 01               cp      1
11430  31B9 CA 0D 32            jp      z,l3297
11431  31BC             		
11432  31BC             		; Work with the current fireball
11433  31BC DD 2A C8 63         ld      ix,(CURRENT_FIREBALL)
11434  31C0             		
11435  31C0             		; If the fireball is attempting to move off the left side
11436  31C0             		; of the screen, 
11437  31C0             		; jump ahead to make it reverse its direction
11438  31C0             		; NOTE: Some code could be saved by jumping to the same
11439  31C0             		;		address used when the fireball attempts to move
11440  31C0             		;		off the girder (just above here)
11441  31C0             		;		It would slightly change the game mechanics, 
11442  31C0             		;		but shouldn't be noticeable
11443  31C0 DD 7E 0E            ld      a,(ix+14)					; Next intended x coordinate
11444  31C3 FE 10               cp      16
11445  31C5 DA 02 32            jp      c,l328c
11446  31C8             		
11447  31C8             		; If the fireball is attempting to move off the right side
11448  31C8             		; of the screen,
11449  31C8             		; jump ahead to reverse its direction
11450  31C8             		; NOTE: Some code could be saved the same as above
11451  31C8 FE F0               cp		240
11452  31CA D2 FA 31            jp      nc,l3284
11453  31CD             		
11454  31CD             		; If the bob table index has not reached the start of the table,
11455  31CD             		; jump ahead to decrement the index
11456  31CD DD 7E 13    l3257:  ld      a,(ix+19)					; Bob table index
11457  31D0 FE 00               cp      0
11458  31D2 C2 2F 32            jp      nz,l32b9
11459  31D5             		
11460  31D5             		; Reset the fireball bob table index to the end of the table
11461  31D5 3E 11               ld      a,FIREBALL_BOB_TABLE_LENGTH-1
11462  31D7             		
11463  31D7             		; Save the new fireball bob table index
11464  31D7 DD 77 13    l3261:  ld      (ix+19),a					; Bob table index
11465  31DA             
11466  31DA             		; Load the fireball bob y offset
11467  31DA 16 00               ld      d,0
11468  31DC 5F                  ld      e,a
11469  31DD 21 EC 39            ld      hl,L_FIREBALL_BOB_TABLE
11470  31E0 19                  add     hl,de
11471  31E1 7E                  ld      a,(hl)
11472  31E2             		
11473  31E2             		; Move the fireball to its next intended x coordinate
11474  31E2 DD 46 0E            ld      b,(ix+14)					; Next intended x coordinate
11475  31E5 DD 70 03            ld      (ix+3),b					; X coordinate
11476  31E8             		
11477  31E8             		; Move the fireball to its next y coordinate plus the
11478  31E8             		; bob offset
11479  31E8 DD 4E 0F            ld      c,(ix+15)					; Next intended y coordinate
11480  31EB 81                  add     a,c
11481  31EC DD 77 05            ld      (ix+5),a					; Y coordinate
11482  31EF C9                  ret     
11483  31F0             		
11484  31F0             		
11485  31F0             		; The current fireball has not been initialized yet
11486  31F0 CD 33 32    l327a:  call    L_INIT_FIREBALL_FOR_STAGE
11487  31F3 C9                  ret     
11488  31F4             		
11489  31F4             		
11490  31F4             		; Handle the fireball while it is paused
11491  31F4 CD 4C 32    l327e:  call    L_HANDLE_FIREBALL_PAUSED
11492  31F7             
11493  31F7             		; Jump back up to continue processing the fireball movement
11494  31F7 C3 9F 31            jp      l3229
11495  31FA             		
11496  31FA             		; Make the fireball move left next
11497  31FA 3E 02       l3284:  ld      a,2
11498  31FC             
11499  31FC             		; Update the fireball direction
11500  31FC DD 77 0D    l3286:  ld      (ix+13),a					; Fireball direction
11501  31FF             
11502  31FF             		; Jump up to move the fireball to its next intended coordinate
11503  31FF C3 CD 31            jp      l3257
11504  3202             		
11505  3202             		; Make the fireball move right next
11506  3202 3E 01       l328c:  ld      a,1
11507  3204             
11508  3204             		; Jump up to update the fireball direction and
11509  3204             		; move the fireball
11510  3204 C3 FC 31            jp      l3286
11511  3207             		
11512  3207             		; Update the fireball climbing up or down the current ladder
11513  3207 CD 59 33    l3291:  call    L_UPDATE_FIREBALL_CLIMB
11514  320A             
11515  320A             		; Jump up to move the fireball to its next intended coordinate
11516  320A C3 CD 31            jp      l3257
11517  320D             		
11518  320D             		; Work with the currently active fireball
11519  320D DD 2A C8 63 l3297:  ld      ix,(CURRENT_FIREBALL)
11520  3211             
11521  3211             		; If the fireball is moving left, 
11522  3211             		; jump ahead to reverse its direction
11523  3211 DD 7E 0D            ld      a,(ix+13)					; Fireball direction
11524  3214 FE 01               cp      1
11525  3216 C2 27 32            jp      nz,l32b1
11526  3219             		
11527  3219             		; The fireball is moving right
11528  3219             		; Make the fireball move left immediately
11529  3219 3E 02               ld      a,2
11530  321B DD 35 0E            dec     (ix+14)						; Next intended x coordinate
11531  321E             
11532  321E             		; Update the fireball direction
11533  321E DD 77 0D    l32a8:  ld      (ix+13),a					; Fireball direction
11534  3221             
11535  3221             		; If the current stage is barrels, 
11536  3221             		; make the fireball follow the contours of the platforms
11537  3221 CD 35 33            call    L_HANDLE_BARREL_PLATS
11538  3224             
11539  3224             		; Jump up to move the fireball to its next intended coordinate
11540  3224 C3 CD 31            jp      l3257
11541  3227             		
11542  3227             		; Make the fireball move right immediately
11543  3227 3E 01       l32b1:  ld      a,1
11544  3229 DD 34 0E            inc     (ix+14)						; Next intended x coordinate
11545  322C             		
11546  322C             		; Jump back up to update the fireball direction
11547  322C             		; and to move the fireball
11548  322C C3 1E 32            jp      l32a8
11549  322F             		
11550  322F             		; Decrement the bob table index and jump back up
11551  322F             		; to make the fireball bob as it moves
11552  322F 3D          l32b9:  dec     a
11553  3230 C3 D7 31            jp      l3261
11554  3233             ;------------------------------------------------------------------------------
11555  3233             
11556  3233             
11557  3233                     
11558  3233             ;------------------------------------------------------------------------------
11559  3233             ; This function calls the correct function to initialize the fireball depending
11560  3233             ; on the current stage
11561  3233             ; passed:	ix - the address of the current fireball
11562  3233             L_INIT_FIREBALL_FOR_STAGE:  
11563  3233                     ; If the current stage is the barrels stage, 
11564  3233             		; jump ahead
11565  3233 3A 27 62    		ld      a,(CURRENT_STAGE)
11566  3236 FE 01               cp      1
11567  3238 CA 44 32            jp      z,l32ce
11568  323B             		
11569  323B             		; If the current stage is the mixer stage
11570  323B             		; jump ahead
11571  323B FE 02               cp      2
11572  323D CA 48 32            jp      z,l32d2
11573  3240             		
11574  3240             		; If the current stage is the elevators or rivets stage,
11575  3240             		; initialize the fireball for the rivets stage
11576  3240             		; NOTE: If the current stage is elevators, this function
11577  3240             		;		returns immediately
11578  3240 CD 2B 34            call    L_INIT_FIREBALL_RIVETS
11579  3243 C9                  ret     
11580  3244             		
11581  3244             		; The current stage is barrels
11582  3244             		; Initialize the fireball for the barrels stage
11583  3244 CD 9E 33    l32ce:  call    L_INIT_FIREBALL_BARRELS
11584  3247 C9                  ret   
11585  3248             		
11586  3248             		; The current stage is the mixer
11587  3248             		; Initialize the fireball for the mixer stage
11588  3248 CD EA 33    l32d2:  call    L_INIT_FIREBALL_MIXER
11589  324B C9                  ret     
11590  324C             ;------------------------------------------------------------------------------
11591  324C             
11592  324C             
11593  324C             
11594  324C             ;------------------------------------------------------------------------------
11595  324C             ; This function controls fireballs while they are paused.
11596  324C             L_HANDLE_FIREBALL_PAUSED:  
11597  324C             		; If the pause timer is not 0, jump ahead to decrement it
11598  324C DD 7E 1C    		ld      a,(ix+28)					; Pause timer
11599  324F FE 00               cp      0
11600  3251 C2 73 32            jp      nz,l32fd
11601  3254             
11602  3254             		; If the fireball is not paused,
11603  3254             		; jump ahead to change direction
11604  3254 DD 7E 1D            ld      a,(ix+29)
11605  3257 FE 01               cp      1
11606  3259 C2 81 32            jp      nz,l330b
11607  325C             		
11608  325C             		; NOTE: Is this needed?  If the comparison to 1 fails above,
11609  325C             		; does that mean ix+29 is 0?
11610  325C DD 36 1D 00         ld      (ix+29),0
11611  3260                     
11612  3260             		; If the fireball is lower than Mario,
11613  3260             		; jump ahead to unpause it
11614  3260 3A 05 62    		ld      a,(MARIO_Y)
11615  3263 DD 46 0F            ld      b,(ix+15)
11616  3266 90                  sub     b
11617  3267 DA 79 32            jp      c,l3303
11618  326A             		
11619  326A             		; Reset the pause timer
11620  326A DD 36 1C FF         ld      (ix+28),255					; Pause timer
11621  326E             		
11622  326E             		; Make the fireball stand still
11623  326E DD 36 0D 00 l32f8:  ld      (ix+13),0
11624  3272 C9                  ret     
11625  3273             
11626  3273             		; Decrement the timer
11627  3273 DD 35 1C    l32fd:  dec     (ix+28)						; Pause timer
11628  3276             
11629  3276             		; If the timer has not reached 0, 
11630  3276             		; jump up to keep the fireball standing still
11631  3276 C2 6E 32            jp      nz,l32f8
11632  3279             		
11633  3279             		; Mark the fireball as no longer paused
11634  3279 DD 36 19 00 l3303:  ld      (ix+25),0
11635  327D             
11636  327D             		; Reset the pause timer to 0
11637  327D DD 36 1C 00         ld      (ix+28),0					; Pause timer
11638  3281             		
11639  3281             		; Periodically change the fireball's direction
11640  3281 CD 85 32    l330b:  call    L_CHANGE_FIREBALL_DIR
11641  3284 C9                  ret     
11642  3285             ;------------------------------------------------------------------------------
11643  3285             
11644  3285             
11645  3285             
11646  3285             ;------------------------------------------------------------------------------
11647  3285             ; This function makes the fireball change direction periodically.
11648  3285             ; The fireball continues moving in the current direction (left or right) for a 
11649  3285             ; set period of time and then has a chance of changing direction.
11650  3285             L_CHANGE_FIREBALL_DIR:  
11651  3285             		; If the direction counter has not reached 0, 
11652  3285             		; jump ahead to decrement it and return
11653  3285 DD 7E 16    		ld      a,(ix+22)
11654  3288 FE 00               cp      0
11655  328A C2 A8 32            jp      nz,l3332
11656  328D                     
11657  328D             		; Reset the direction counter to 43
11658  328D DD 36 16 2B         ld      (ix+22),43
11659  3291                     
11660  3291                     ; Make the fireball stand still
11661  3291 DD 36 0D 00         ld      (ix+13),0
11662  3295                     
11663  3295                     ; 50% chance of jumping ahead and keep moving in the
11664  3295             		; same direction until the direction counter reaches
11665  3295             		; 0 again
11666  3295 3A 18 60            ld      a,(RANDOM_NUMBER)
11667  3298 0F                  rrca    
11668  3299 D2 A8 32            jp      nc,l3332
11669  329C                     
11670  329C                     ; If the fireball is moving right,
11671  329C                     ; jump ahead
11672  329C             		; NOTE: Because the fireball was made to stand still up
11673  329C             		; above, this compare will always be non-zero, so the 
11674  329C             		; fireball will always end up moving right at this point.
11675  329C             		; This appears to be a bug, but some code could be shaved 
11676  329C             		; off here by just making the fireball move right without
11677  329C             		; affecting the game play
11678  329C DD 7E 0D            ld      a,(ix+13)
11679  329F FE 01               cp      1
11680  32A1 CA AC 32            jp      z,l3336
11681  32A4                     
11682  32A4             		; Make the fireball move right
11683  32A4 DD 36 0D 01         ld      (ix+13),1
11684  32A8             		
11685  32A8             		; Decrement the direction counter
11686  32A8 DD 35 16    l3332:  dec     (ix+22)
11687  32AB C9                  ret     
11688  32AC             		
11689  32AC             		; Make the fireball move left
11690  32AC             		; NOTE: Execution will never reach here
11691  32AC DD 36 0D 02 l3336:  ld      (ix+13),2
11692  32B0             
11693  32B0             		; Jump back up to decrement the direction counter and return
11694  32B0 C3 A8 32            jp      l3332
11695  32B3             ;------------------------------------------------------------------------------
11696  32B3             
11697  32B3             
11698  32B3             
11699  32B3             ;------------------------------------------------------------------------------
11700  32B3             ; This functions checks if the fireball is standing on the top or bottom of a
11701  32B3             ; ladder.  If so and the fireball can get closer to Mario by climbing the
11702  32B3             ; ladder, then it will take it; otherwise, the ladder will be ignored.
11703  32B3             ;
11704  32B3             ; This function also makes the fireball continue climbing a ladder if one is 
11705  32B3             ; currently being climbed.
11706  32B3             L_HANDLE_FIREBALLS_AND_LADDERS:  
11707  32B3             		; If the fireball is moving up, jump ahead
11708  32B3 DD 7E 0D    		ld      a,(ix+13)					; Fireball direction
11709  32B6 FE 08               cp      8
11710  32B8 CA E4 32            jp      z,l3371
11711  32BB             		
11712  32BB             		; If the fireball is moving down, jump ahead
11713  32BB FE 04               cp      4
11714  32BD CA FD 32            jp      z,l338a
11715  32C0             		
11716  32C0             		; Return if the fireball is attempting to move above
11717  32C0             		; the top platform
11718  32C0             		; This prevents the fireball from 
11719  32C0             		; climbing the escape ladders, I believe
11720  32C0 CD 14 33            call    L_ABORT_IF_FIREBALL_TOO_HIGH
11721  32C3             		
11722  32C3                     ; Check if the fireball is on a ladder
11723  32C3                     ; a will be 0 if at the bottom, 1 if at the top
11724  32C3                     ; This function will be aborted if no ladder
11725  32C3 DD 7E 0F            ld      a,(ix+15)					; Next intended y coordinate
11726  32C6 C6 08               add     a,8
11727  32C8 57                  ld      d,a
11728  32C9 DD 7E 0E            ld      a,(ix+14)					; Next intended x coordinate
11729  32CC CD 50 23            call    L_CHECK_IF_ON_LADDER
11730  32CF             		
11731  32CF             		; If the fireball is at the bottom of a ladder,
11732  32CF             		; jump ahead
11733  32CF A7                  and     a
11734  32D0 CA 0C 33            jp      z,l3399
11735  32D3             		
11736  32D3             		; The fireball is at the top of a ladder
11737  32D3             		; Save the coordinate of the bottom of the ladder
11738  32D3 DD 70 1F            ld      (ix+31),b
11739  32D6             		
11740  32D6             		; Return (don't climb down) if the fireball is below Mario
11741  32D6 3A 05 62            ld      a,(MARIO_Y)
11742  32D9 47                  ld      b,a
11743  32DA DD 7E 0F            ld      a,(ix+15)					; The next intended y coordinate
11744  32DD 90                  sub     b
11745  32DE D0                  ret     nc
11746  32DF             		
11747  32DF             		; Mark the fireball as moving down
11748  32DF DD 36 0D 04         ld      (ix+13),4					; Direction
11749  32E3 C9                  ret     
11750  32E4             
11751  32E4             		
11752  32E4             		
11753  32E4             		; The fireball is moving up
11754  32E4             		; If the fireball has not reached the top of the ladder 
11755  32E4             		; being climbed, return
11756  32E4 DD 7E 0F    l3371:  ld      a,(ix+15)					; Next intended y coordinate
11757  32E7 C6 08               add     a,8
11758  32E9 DD 46 1F            ld      b,(ix+31)
11759  32EC B8                  cp      b
11760  32ED C0                  ret     nz
11761  32EE             		
11762  32EE             		; Mark the fireball as standing still
11763  32EE DD 36 0D 00         ld      (ix+13),0					; Direction
11764  32F2             		
11765  32F2             		; Return if the fireball is not paused (standing without moving)
11766  32F2 DD 7E 19            ld      a,(ix+25)
11767  32F5 FE 02               cp      2
11768  32F7 C0                  ret     nz
11769  32F8             		
11770  32F8             		; Mark the fireball as paused
11771  32F8 DD 36 1D 01         ld      (ix+29),1
11772  32FC C9                  ret     
11773  32FD             		
11774  32FD             		
11775  32FD             		
11776  32FD             		; The fireball is moving down
11777  32FD             		; If the fireball has not reached the bottom of the ladder
11778  32FD             		; being climbed, return
11779  32FD DD 7E 0F    l338a:  ld      a,(ix+15)
11780  3300 C6 08               add     a,8
11781  3302 DD 46 1F            ld      b,(ix+31)
11782  3305 B8                  cp      b
11783  3306 C0                  ret     nz
11784  3307             		
11785  3307             		; Mark the fireball as standing still
11786  3307 DD 36 0D 00         ld      (ix+13),0
11787  330B C9                  ret     
11788  330C             		
11789  330C             		
11790  330C             		
11791  330C             		; The fireball is at the bottom of a ladder
11792  330C             		; Record the y coordinate of the top of the ladder
11793  330C DD 70 1F    l3399:  ld      (ix+31),b
11794  330F             
11795  330F             		; Mark the fireball as moving up
11796  330F DD 36 0D 08         ld      (ix+13),8
11797  3313 C9                  ret     
11798  3314             ;------------------------------------------------------------------------------
11799  3314             
11800  3314             
11801  3314             
11802  3314             ;------------------------------------------------------------------------------
11803  3314             ; This function checks if the current fireball is attempting to move too high
11804  3314             ; on the barrels, mixer, or elevators stages.  If the fireball attempts to move
11805  3314             ; onto the top platform, 
11806  3314             ; passed:	ix - pointer to the fireball structure to process
11807  3314             ; return:	none
11808  3314             L_ABORT_IF_FIREBALL_TOO_HIGH:  
11809  3314             		; Return unless this is the barrels stage, mixer stage, or elevators stage
11810  3314 3E 07       		ld      a,%00000111
11811  3316 F7                  rst     $30			
11812  3317             		
11813  3317             		; Return if the fireball is not trying to move onto the top
11814  3317             		; platform on the stage
11815  3317 DD 7E 0F            ld      a,(ix+15)
11816  331A FE 59               cp      89
11817  331C D0                  ret     nc
11818  331D             		
11819  331D             		; If the fireball is trying to move onto the top platform on the stage,
11820  331D             		; return from the calling function
11821  331D E1                  pop		hl
11822  331E C9                  ret     
11823  331F             ;------------------------------------------------------------------------------
11824  331F             
11825  331F             
11826  331F             
11827  331F             ;------------------------------------------------------------------------------
11828  331F             ; This function updates the fireball's position while it is walking
11829  331F             ; The fireball is forced to follow the contours of the platforms on the barrels
11830  331F             ; stage
11831  331F             L_UPDATE_FIREBALL_WALK:  
11832  331F             		; If the fireball is moving right, jump ahead
11833  331F DD 7E 0D    		ld      a,(ix+13)					; Direction
11834  3322 FE 01               cp      1
11835  3324 CA 4B 33            jp      z,l33d9
11836  3327             		
11837  3327             		; The fireball is moving left
11838  3327             		; Face the fireball to the left
11839  3327 DD 7E 07            ld      a,(ix+7)					; Sprite image
11840  332A E6 7F               and     %01111111					; Clear the flipped bit
11841  332C DD 77 07            ld      (ix+7),a					; Sprite image
11842  332F             		
11843  332F             		; Move the fireball 1 pixel to the left
11844  332F DD 35 0E            dec     (ix+14)						; Next intended x coordinate
11845  3332             		
11846  3332             		; Update the sprite image
11847  3332 CD 7B 33    l33c0:  call    L_UPDATE_FIREBALL_SPRITE
11848  3335             
11849  3335             		; If the current stage is not the barrels,
11850  3335             		; return
11851  3335             L_HANDLE_BARREL_PLATS:  
11852  3335 3A 27 62    		ld      a,(CURRENT_STAGE)
11853  3338 FE 01               cp      STAGE_BARRELS
11854  333A C0                  ret     nz
11855  333B             		
11856  333B             		; Make the fireball move along the platforms
11857  333B DD 66 0E            ld      h,(ix+14)					; Next intended x coordinate
11858  333E DD 6E 0F            ld      l,(ix+15)					; Next intended y coordinate
11859  3341 DD 46 0D            ld      b,(ix+13)					; Direction
11860  3344 CD 15 23            call    L_MOVE_SPRITE_ALONG_PLAT
11861  3347 DD 75 0F            ld      (ix+15),l					; Next intended y corodinate
11862  334A C9                  ret     
11863  334B             		
11864  334B             		; The fireball is moving right
11865  334B             		; Face the fireball to the right
11866  334B DD 7E 07    l33d9:  ld      a,(ix+7)					; Sprite image
11867  334E F6 80               or      %10000000					; Set the flipped bit
11868  3350 DD 77 07            ld      (ix+7),a					; Sprite image
11869  3353             		
11870  3353             		; Move the fireball 1 pixel to the right
11871  3353 DD 34 0E            inc     (ix+14)						; Next intended x coordinate
11872  3356             		
11873  3356             		; Jump back up to continue updating the fireball's position
11874  3356 C3 32 33            jp      l33c0
11875  3359             ;------------------------------------------------------------------------------
11876  3359             
11877  3359             
11878  3359             
11879  3359             ;------------------------------------------------------------------------------
11880  3359             ; This function moves the fireball up or down the current ladder
11881  3359             ; (depending, of course, on which direction the fireball is climbing)
11882  3359             ; It does not check if the fireball has reached the top or bottom of the
11883  3359             ; ladder - this is handled elsewhere
11884  3359             ; passed:	ix - pointer to the current fireball
11885  3359             L_UPDATE_FIREBALL_CLIMB:  
11886  3359             		; Update the fireball's sprite image
11887  3359 CD 7B 33    		call    L_UPDATE_FIREBALL_SPRITE
11888  335C             		
11889  335C             		; If the fireball is moving down
11890  335C DD 7E 0D            ld      a,(ix+13)					; Direction
11891  335F FE 08               cp      8
11892  3361 C2 77 33            jp      nz,l3405
11893  3364             		
11894  3364             		; If the ladder climb counter has not reached 0,
11895  3364             		; jump ahead to decrement it and return
11896  3364 DD 7E 14            ld      a,(ix+20)					; Climb update counter
11897  3367 A7                  and     a
11898  3368 C2 73 33            jp      nz,l3401
11899  336B             		
11900  336B             		; Reset the sprite update counter to 2
11901  336B DD 36 14 02         ld      (ix+20),2					; Climb update counter
11902  336F             		
11903  336F             		; Move the fireball up 1 pixel
11904  336F DD 35 0F            dec     (ix+15)						; Y coordinate
11905  3372 C9                  ret     
11906  3373             		
11907  3373             		; Decrement the ladder climb counter
11908  3373 DD 35 14    l3401:  dec     (ix+20)						; Climb update counter
11909  3376 C9                  ret    
11910  3377             		
11911  3377             		; Move the fireball down 1 pixel
11912  3377 DD 34 0F    l3405:  inc     (ix+15)						; Y coordinate
11913  337A C9                  ret     
11914  337B             ;------------------------------------------------------------------------------
11915  337B             
11916  337B             
11917  337B             
11918  337B             ;------------------------------------------------------------------------------
11919  337B             ; This function updates the fireball sprite image, cycling it periodically 
11920  337B             ; between the two sprite images for the fireball (either $3d and $3e, or $4d 
11921  337B             ; and $4e)
11922  337B             ; passed:	ix - pointer to the fireball to process
11923  337B             L_UPDATE_FIREBALL_SPRITE:  
11924  337B             		; If the sprite update counter has not reached 0,
11925  337B             		; jump ahead to decrement it and return
11926  337B DD 7E 15    		ld      a,(ix+21)					; The sprite update counter
11927  337E A7                  and     a
11928  337F C2 9A 33            jp      nz,l3428
11929  3382                     
11930  3382             		; Reset the sprite update counter to 2
11931  3382 DD 36 15 02 		ld      (ix+21),2					; The sprite update counter
11932  3386                     
11933  3386             		; Advance the sprite number
11934  3386 DD 34 07    		inc     (ix+7)						; The sprite number
11935  3389             		
11936  3389             		; If the sprite does not need to be wrapped,
11937  3389             		; return
11938  3389 DD 7E 07            ld      a,(ix+7)					; The sprite number
11939  338C E6 0F               and     %00001111
11940  338E FE 0F               cp      $0f
11941  3390 C0                  ret     nz
11942  3391             		
11943  3391             		; Wrap the fireball sprite to the first of the two sprite
11944  3391             		; images (either $3d or $4d)
11945  3391 DD 7E 07            ld      a,(ix+7)					; The sprite number
11946  3394 EE 02               xor     %00000010
11947  3396 DD 77 07            ld      (ix+7),a					; The sprite number
11948  3399 C9                  ret     
11949  339A             
11950  339A             		; Decrement the sprite update counter
11951  339A DD 35 15    l3428:  dec     (ix+21)						; The sprite update counter
11952  339D C9                  ret     
11953  339E             ;------------------------------------------------------------------------------
11954  339E             
11955  339E             
11956  339E             
11957  339E             ;------------------------------------------------------------------------------
11958  339E             ; This function initializes the current fireball for the barrels stage
11959  339E             ; passed:	ix - pointer to the fireball structure to process
11960  339E             L_INIT_FIREBALL_BARRELS:  
11961  339E             		; If the oil barrel jump pointer has not been set,
11962  339E             		; jump ahead to initialize it
11963  339E DD 6E 1A    		ld      l,(ix+26)					; Oil barrel jump pointer
11964  33A1 DD 66 1B            ld      h,(ix+27)					; Oil barrel jump pointer
11965  33A4 AF                  xor     a							; Clear the carry flag
11966  33A5 01 00 00            ld      bc,0
11967  33A8 ED 4A               adc     hl,bc
11968  33AA C2 B4 33            jp      nz,l3442
11969  33AD             		
11970  33AD             		; Set the oil barrel jump pointer to the beginning of the table
11971  33AD 21 FE 39            ld      hl,L_OIL_BARREL_JUMP_TABLE_BARRELS
11972  33B0             		
11973  33B0             		; Initialize the fireball's x coordinate to 38
11974  33B0 DD 36 03 26         ld      (ix+3),38
11975  33B4             
11976  33B4             		; Move the fireball right 1 pixel
11977  33B4 DD 34 03    l3442:  inc     (ix+3)
11978  33B7             		
11979  33B7             		; If the end of the oil barrel jump table has been reached,
11980  33B7             		; jump ahead to finish initializing the fireball
11981  33B7 7E          l3445:  ld      a,(hl)
11982  33B8 FE AA               cp      $aa							; End of data
11983  33BA CA C8 33            jp      z,l3456
11984  33BD             		
11985  33BD             		; Update the fireball's y coordinate
11986  33BD DD 77 05            ld      (ix+5),a
11987  33C0             		
11988  33C0             		; Advance to the next entry in the oil barrel jump table
11989  33C0 23                  inc     hl
11990  33C1 DD 75 1A            ld      (ix+26),l
11991  33C4 DD 74 1B            ld      (ix+27),h
11992  33C7 C9                  ret     
11993  33C8             		
11994  33C8             		; The end of the oil barrel jump table has been reached
11995  33C8             		; Initialize the fireball's data
11996  33C8 AF          l3456:  xor     a
11997  33C9 DD 77 13            ld      (ix+19),a					; Bob table index
11998  33CC DD 77 18            ld      (ix+24),a					; The fireball has now been initialized
11999  33CF DD 77 0D            ld      (ix+13),a					; The fireball is standing still
12000  33D2 DD 77 1C            ld      (ix+28),a					; The fireball is not paused
12001  33D5             
12002  33D5             		; Next intended x and y coordinates equal the current 
12003  33D5             		; x and y coordinates
12004  33D5 DD 7E 03            ld      a,(ix+3)					
12005  33D8 DD 77 0E            ld      (ix+14),a
12006  33DB DD 7E 05            ld      a,(ix+5)
12007  33DE DD 77 0F            ld      (ix+15),a
12008  33E1             		
12009  33E1             		; Clear the oil barrel jump table pointer
12010  33E1 DD 36 1A 00         ld      (ix+26),0
12011  33E5 DD 36 1B 00         ld      (ix+27),0
12012  33E9 C9                  ret     
12013  33EA             ;------------------------------------------------------------------------------
12014  33EA             
12015  33EA             
12016  33EA             
12017  33EA             ;------------------------------------------------------------------------------
12018  33EA             ; This function initializes the current fireball for the mixer stage
12019  33EA             ; passed:	ix - pointer to the fireball structure to process
12020  33EA             L_INIT_FIREBALL_MIXER:  
12021  33EA             		; If the oil barrel jump pointer has already been initialized,
12022  33EA             		; jump ahead to skip initializing it
12023  33EA DD 6E 1A    		ld      l,(ix+26)					; Oil barrel jump index
12024  33ED DD 66 1B            ld      h,(ix+27)					; Oil barrel jump index
12025  33F0 AF                  xor     a
12026  33F1 01 00 00            ld      bc,0
12027  33F4 ED 4A               adc     hl,bc
12028  33F6 C2 0C 34            jp      nz,l349a
12029  33F9             		
12030  33F9             		; Initialize the oil barrel jump pointer to the start of the table
12031  33F9 21 1E 3A            ld      hl,L_OIL_BARREL_JUMP_TABLE_MIXER
12032  33FC             		
12033  33FC             		; If Mario is on the left side of the screen, 
12034  33FC             		; jump ahead
12035  33FC 3A 03 62            ld      a,(MARIO_X)
12036  33FF CB 7F               bit     7,a
12037  3401 CA 1A 34            jp      z,l34a8
12038  3404             		
12039  3404             		; Mario is on the right side of the screen
12040  3404             		; Mark the fireball as moving right
12041  3404 DD 36 0D 01         ld      (ix+13),1
12042  3408             		
12043  3408             		; Fireball x coordinate starts at 126
12044  3408 DD 36 03 7E         ld      (ix+3),126
12045  340C             		
12046  340C             		; If the fireball is moving left,
12047  340C             		; jump ahead
12048  340C DD 7E 0D    l349a:  ld      a,(ix+13)
12049  340F FE 01               cp      1
12050  3411 C2 25 34            jp      nz,l34b3
12051  3414             		
12052  3414             		; Move the fireball 1 pixel right
12053  3414 DD 34 03            inc     (ix+3)
12054  3417             		
12055  3417             		; Jump up to the barrels stage initialization function
12056  3417             		; to continue the oil barrel jump processing
12057  3417 C3 B7 33            jp      l3445
12058  341A             		
12059  341A             		; Mark the fireball as moving left
12060  341A DD 36 0D 02 l34a8:  ld      (ix+13),2
12061  341E             
12062  341E             		; Fireball x coordinate starts at 128
12063  341E DD 36 03 80         ld      (ix+3),128
12064  3422             		
12065  3422             		; Jump back up to continue the oil barrel jump processing
12066  3422 C3 0C 34            jp      l349a
12067  3425             		
12068  3425             		; Move the fireball 1 pixel left
12069  3425 DD 35 03    l34b3:  dec     (ix+3)
12070  3428             
12071  3428             		; Jump up to the barrels stage initialization function
12072  3428             		; to continue the oil barrel jump processing
12073  3428 C3 B7 33            jp      l3445
12074  342B             ;------------------------------------------------------------------------------
12075  342B             
12076  342B             
12077  342B             
12078  342B             ;------------------------------------------------------------------------------
12079  342B             ; Initialize the fireball on the rivets stage
12080  342B             ; Place it in its initial position
12081  342B             ; passed:	ix - the address of the current fireball
12082  342B             L_INIT_FIREBALL_RIVETS:  
12083  342B             		; If the current stage is the elevators stage,
12084  342B             		; return
12085  342B             		; NOTE: This function is only called when the current stage
12086  342B             		;		is elevators or rivets, so the rest of this function
12087  342B             		;		is only run when on the rivets stage
12088  342B             		; NOTE: May be able to save a byte or two by using RST $30
12089  342B 3A 27 62    		ld      a,(CURRENT_STAGE)
12090  342E FE 03               cp      3
12091  3430 C8                  ret     z
12092  3431             		
12093  3431             		; If Mario is on the right side of the screen,
12094  3431             		; jump ahead
12095  3431 3A 03 62            ld      a,(MARIO_X)
12096  3434 CB 7F               bit     7,a
12097  3436 C2 5F 34            jp      nz,l34ed
12098  3439             		
12099  3439             		; Mario is on the left side of the screen
12100  3439             		; Pick a random starting location on the right side of
12101  3439             		; the screen
12102  3439 21 36 3A            ld      hl,L_L_RIVET_SPAWN_COORDS
12103  343C 06 00       l34ca:  ld      b,0
12104  343E 3A 19 60            ld      a,(COUNTER_1)
12105  3441 E6 06               and     %00000110
12106  3443 4F                  ld      c,a							; bc = random offset (multiple of 2)
12107  3444 09                  add     hl,bc						; hl = random coordinate
12108  3445             
12109  3445             		; Set the fireball's coordinate
12110  3445 7E                  ld      a,(hl)
12111  3446 DD 77 03            ld      (ix+3),a					; X coordinate
12112  3449 DD 77 0E            ld      (ix+14),a					; Next intended x coordinate
12113  344C 23                  inc     hl
12114  344D 7E                  ld      a,(hl)
12115  344E DD 77 05            ld      (ix+5),a					; Y coordinate
12116  3451 DD 77 0F            ld      (ix+15),a					; Next intended y coordinate
12117  3454             
12118  3454             		; Mark the fireball as standing still
12119  3454 AF                  xor     a							; a = 0
12120  3455 DD 77 0D            ld      (ix+13),a					; Fireball direction
12121  3458             		
12122  3458             		; Mark that the fireball has been initialized
12123  3458 DD 77 18            ld      (ix+24),a					; Not initialized
12124  345B                     
12125  345B             		; Clear the pause timer
12126  345B DD 77 1C    		ld      (ix+28),a					; Pause timer
12127  345E C9                  ret     
12128  345F             		
12129  345F             		; Mario is on the right side of the screen
12130  345F             		; Pick a random starting location on the left side of
12131  345F             		; the screen
12132  345F 21 46 3A    l34ed:  ld      hl,L_R_RIVET_SPAWN_COORDS
12133  3462 C3 3C 34            jp      l34ca
12134  3465             ;------------------------------------------------------------------------------
12135  3465             
12136  3465             
12137  3465             
12138  3465             ;------------------------------------------------------------------------------
12139  3465             ; Copy the data from the fireball data structures to the fireball sprites
12140  3465             L_UPDATE_FIREBALL_SPRITES:  
12141  3465 21 00 64    		ld      hl,FIREBALL_STRUCTS
12142  3468 11 D0 69            ld      de,FIREBALL_SPRITES
12143  346B 06 05               ld      b,5							; 5 fireballs
12144  346D             
12145  346D             		; If this fireball is not active,
12146  346D             		; jump ahead to skip
12147  346D 7E          l34fb:  ld      a,(hl)
12148  346E A7                  and     a
12149  346F CA 90 34            jp      z,l351e
12150  3472             		
12151  3472             		; Copy the x coordinate to the spirte
12152  3472 2C                  inc     l
12153  3473 2C                  inc     l
12154  3474 2C                  inc     l							; X coordinate
12155  3475 7E                  ld      a,(hl)
12156  3476 12                  ld      (de),a						; X coordinate
12157  3477             
12158  3477             		; Copy the sprite image number to the sprite
12159  3477 3E 04               ld      a,4
12160  3479 85                  add     a,l
12161  347A 6F                  ld      l,a							; Sprite image number
12162  347B 1C                  inc     e							; Sprite image number
12163  347C 7E                  ld      a,(hl)
12164  347D 12                  ld      (de),a
12165  347E             		
12166  347E             		; Copy the sprite palette to the sprite
12167  347E 2C                  inc     l							; Sprite palette number
12168  347F 1C                  inc     e							; Sprite palette number
12169  3480 7E                  ld      a,(hl)
12170  3481 12                  ld      (de),a
12171  3482             		
12172  3482             		; Copy the y coordinate to the sprite
12173  3482 2D                  dec     l
12174  3483 2D                  dec     l
12175  3484 2D                  dec     l							; Y coordinate
12176  3485 1C                  inc     e							; Y coordinate
12177  3486 7E                  ld      a,(hl)
12178  3487 12                  ld      (de),a
12179  3488             
12180  3488             		; Advance to the next fireball sprite 
12181  3488 13                  inc     de
12182  3489             		
12183  3489             		; Advance to the next fireball data structure
12184  3489 3E 1B       l3517:  ld      a,27
12185  348B 85                  add     a,l
12186  348C 6F                  ld      l,a
12187  348D             		
12188  348D             		; Process the next fireball data structure
12189  348D 10 DE               djnz    l34fb						; Next b
12190  348F C9                  ret     
12191  3490             		
12192  3490             		; Advance to the next fireball data structure and sprite
12193  3490 3E 05       l351e:  ld      a,5
12194  3492 85                  add     a,l
12195  3493 6F                  ld      l,a
12196  3494 3E 04               ld      a,4
12197  3496 83                  add     a,e
12198  3497 5F                  ld      e,a
12199  3498             		
12200  3498             		; Jump back to process the next fireball
12201  3498 C3 89 34            jp      l3517
12202  349B             ;------------------------------------------------------------------------------
12203  349B             
12204  349B             
12205  349B             
12206  349B             ;------------------------------------------------------------------------------
12207  349B             ; Points table
12208  349B             ; Lists possible points values to award the player
12209  349B             L_POINT_AWARD_TABLE:  
12210  349B 00 00 00    		.byte	$00, $00, $00	; Entry 0 (000000)
12211  349E             		
12212  349E 00 01 00            .byte	$00, $01, $00	; Entry 1 (000100)
12213  34A1             		
12214  34A1 00 02 00    		.byte	$00, $02, $00	; Entry 2 (000200)
12215  34A4             		
12216  34A4 00 03 00    		.byte	$00, $03, $00	; Entry 3 (000300)
12217  34A7             		
12218  34A7 00 04 00    		.byte	$00, $04, $00	; Entry 4 (000400)
12219  34AA             		
12220  34AA 00 05 00    		.byte	$00, $05, $00	; Entry 5 (000500)
12221  34AD             		
12222  34AD 00 06 00    		.byte	$00, $06, $00	; Entry 6 (000600)
12223  34B0             		
12224  34B0 00 07 00    		.byte	$00, $07, $00	; Entry 7 (000700)
12225  34B3             		
12226  34B3 00 08 00    		.byte	$00, $08, $00	; Entry 8 (000800)
12227  34B6             		
12228  34B6 00 09 00    		.byte	$00, $09, $00	; Entry 9 (000900)
12229  34B9             		
12230  34B9 00 00 00    		.byte	$00, $00, $00	; Entry 10 (001000)
12231  34BC             		
12232  34BC 00 10 00    		.byte	$00, $10, $00	; Entry 11 (001100)
12233  34BF             		
12234  34BF 00 20 00    		.byte	$00, $20, $00	; Entry 12 (001200)
12235  34C2             		
12236  34C2 00 30 00    		.byte	$00, $30, $00	; Entry 13 (001300)
12237  34C5             		
12238  34C5 00 40 00    		.byte	$00, $40, $00	; Entry 14 (001400)
12239  34C8             		
12240  34C8 00 50 00    		.byte	$00, $50, $00	; Entry 15 (001500)
12241  34CB             		
12242  34CB 00 60 00    		.byte	$00, $60, $00	; Entry 16 (001500)
12243  34CE             		
12244  34CE 00 70 00    		.byte	$00, $70, $00	; Entry 17 (001700)
12245  34D1             		
12246  34D1 00 80 00    		.byte	$00, $80, $00	; Entry 18 (001800)
12247  34D4             		
12248  34D4 00 90 00    		.byte	$00, $90, $00	; Entry 19 (001900)
12249  34D7             ;------------------------------------------------------------------------------
12250  34D7             
12251  34D7             
12252  34D7             
12253  34D7             ;------------------------------------------------------------------------------
12254  34D7             ; Default high score data
12255  34D7             ; "1ST  007650              "
12256  34D7             L_DEFAULT_HIGH_SCORE_DATA:	
12257  34D7             L_DEFAULT_HIGH_SCORE_DATA_1:
12258  34D7 94 77       		.word	TILE_COORD(28,20)	; High score string coordinate
12259  34D9             
12260  34D9 01 23 24 10 		.byte 	$01, $23, $24, $10, $10, $00, $00, $07, $06, $05, $00, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10
12260  34DD 10 00 00 07 
12260  34E1 06 05 00 10 
12260  34E5 10 10 10 10 
12260  34E9 10 10 10 10 
12260  34ED 10 10 10 10 
12260  34F1 10 
12261  34F2 3F          		.byte 	$3f		; End string
12262  34F3             		
12263  34F3 00          		.byte	$00		; High score player ID ($00 = not earned by any current player)
12264  34F4             		
12265  34F4 50          		.byte	$50		; High score (007650)
12266  34F5 76          		.byte	$76
12267  34F6 00          		.byte	$00
12268  34F7             		
12269  34F7 F4 76       		.word	TILE_COORD(23,20)	; High score coordinate (23, 20)
12270  34F9             
12271  34F9             ; 2ND  006100              "
12272  34F9 96 77       		.word	TILE_COORD(28,22)	; High score string coordinate (28,22)
12273  34FB             
12274  34FB 02 1E 14 10 		.byte	$02, $1E, $14, $10, $10, $00, $00, $06, $01, $00, $00, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10
12274  34FF 10 00 00 06 
12274  3503 01 00 00 10 
12274  3507 10 10 10 10 
12274  350B 10 10 10 10 
12274  350F 10 10 10 10 
12274  3513 10 
12275  3514 3F          		.byte	$3f		; End string
12276  3515             		
12277  3515 00          		.byte	$00		; High score player ID ($00 = not earned by any current player)
12278  3516             		
12279  3516 00          		.byte	$00		; High score (006100)
12280  3517 61          		.byte	$61
12281  3518 00          		.byte	$00
12282  3519             		
12283  3519 F6 76       		.word	TILE_COORD(23,22)	; High score coordinate (23,22)
12284  351B             
12285  351B             ; "3RD  005950              "
12286  351B 98 77       		.word	TILE_COORD(28,24)	; High score string coordinate (28,24)
12287  351D             
12288  351D 03 22 14 10 		.byte	$03, $22, $14, $10, $10, $00, $00, $05, $09, $05, $00, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10
12288  3521 10 00 00 05 
12288  3525 09 05 00 10 
12288  3529 10 10 10 10 
12288  352D 10 10 10 10 
12288  3531 10 10 10 10 
12288  3535 10 
12289  3536 3F          		.byte	$3f		; End string
12290  3537             		
12291  3537 00          		.byte	$00		; High score player ID ($00 = not earned by any current player)
12292  3538             		
12293  3538 50          		.byte	$50		; High score (005950)
12294  3539 59          		.byte	$59
12295  353A 00          		.byte	$00
12296  353B             		
12297  353B F8 76       		.word	TILE_COORD(23,24)	; High score coordinate (23, 24)
12298  353D             		
12299  353D             ; "4TH  005050              "
12300  353D 9A 77       		.word	TILE_COORD(28,26) 	; High score string coordinate (28,26)
12301  353F             		
12302  353F 04 24 18 10 		.byte	$04, $24, $18, $10, $10, $00, $00, $05, $00, $05, $00, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10
12302  3543 10 00 00 05 
12302  3547 00 05 00 10 
12302  354B 10 10 10 10 
12302  354F 10 10 10 10 
12302  3553 10 10 10 10 
12302  3557 10 
12303  3558 3F          		.byte	$3f		; End string
12304  3559             		
12305  3559 00          		.byte	$00		; High score player ID ($00 = not earned by any current player)
12306  355A             		
12307  355A 50          		.byte	$50		; High score (005050)
12308  355B 50          		.byte	$50
12309  355C 00          		.byte	$00
12310  355D             
12311  355D FA 76       		.word 	TILE_COORD(23,26) 	; High score coordinate (23,26)		
12312  355F             
12313  355F             ; "5TH  004300              "
12314  355F 9C 77       		.word	TILE_COORD(28,28) 	; High score string coordinate (28, 28)
12315  3561             		
12316  3561 05 24 18 10 		.byte	$05, $24, $18, $10, $10, $00, $00, $04, $03, $00, $00, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10, $10
12316  3565 10 00 00 04 
12316  3569 03 00 00 10 
12316  356D 10 10 10 10 
12316  3571 10 10 10 10 
12316  3575 10 10 10 10 
12316  3579 10 
12317  357A 3F          		.byte	$3f		; End string
12318  357B             		
12319  357B             		
12320  357B 00          		.byte	$00		; High score player ID ($00 = not earned by any current player)
12321  357C             				
12322  357C 00          		.byte	$00		; High score (004300)
12323  357D 43          		.byte	$43
12324  357E 00          		.byte	$00
12325  357F             		
12326  357F FC 76       		.word 	TILE_COORD(23,28) 	; High score coordinate (23, 28)		
12327  3581             ;------------------------------------------------------------------------------
12328  3581             
12329  3581             
12330  3581             
12331  3581             ;------------------------------------------------------------------------------
12332  3581             ; The following data is used on the high score initial entry screen to display
12333  3581             ; the letter selection box around $eac letter.  Each two byte pair is an x,y
12334  3581             ; coordinate.  
12335  3581             ; The MSB is the x coordinate and the LSB is the y coordinate.
12336  3581             ; Row 1
12337  3581 3B 5C       L_HS_LETTER_COORD_TABLE:	.word	$5c3b	; 'A' = (59,92)
12338  3583 4B 5C       		.word	$5c4b	; 'B' = (75,92)
12339  3585 5B 5C       		.word	$5c5b	; 'C' =
12340  3587 6B 5C       		.word	$5c6b	; 'D' =
12341  3589 7B 5C       		.word	$5c7b	; 'E' =
12342  358B 8B 5C       		.word	$5c8b	; 'F' =
12343  358D 9B 5C       		.word	$5c9b	; 'G' =
12344  358F AB 5C       		.word	$5cAb	; 'H' =
12345  3591 BB 5C       		.word	$5cBb	; 'I' =
12346  3593 CB 5C       		.word	$5cCb	; 'J' =
12347  3595             
12348  3595             ; Row 2
12349  3595 3B 6C       		.word	$6c3b	; 'K' =
12350  3597 4B 6C       		.word	$6c4b	; 'L' =
12351  3599 5B 6C       		.word	$6c5b	; 'M' =
12352  359B 6B 6C       		.word	$6c6b	; 'N' =
12353  359D 7B 6C       		.word	$6c7b	; 'O' =
12354  359F 8B 6C       		.word	$6c8b	; 'P' =
12355  35A1 9B 6C       		.word	$6c9b	; 'Q' =
12356  35A3 AB 6C       		.word	$6cAb	; 'R' =
12357  35A5 BB 6C       		.word	$6cBb	; 'S' =
12358  35A7 CB 6C       		.word	$6cCb	; 'T' =
12359  35A9             
12360  35A9             ; Row 3
12361  35A9 3B 7C       		.word	$7c3b	; 'U' =
12362  35AB 4B 7C       		.word	$7c4b	; 'V' =
12363  35AD 5B 7C       		.word	$7c5b	; 'W' =
12364  35AF 6B 7C       		.word	$7c6b	; 'X' =
12365  35B1 7B 7C       		.word	$7c7b	; 'Y' =
12366  35B3 8B 7C       		.word	$7c8b	; 'Z' =
12367  35B5 9B 7C       		.word	$7c9b	; '.' =
12368  35B7 AB 7C       		.word	$7cAb	; '-' =
12369  35B9 BB 7C       		.word	$7cBb	; 'RUB' =
12370  35BB CB 7C       		.word	$7cCb	; 'END' =
12371  35BD             ;------------------------------------------------------------------------------
12372  35BD             
12373  35BD             		
12374  35BD             ;------------------------------------------------------------------------------
12375  35BD             ; String table
12376  35BD             ; Strings are looked up by index number and a memory location is returned 
12377  35BD             L_STRING_TABLE:	
12378  35BD FD 35       		.word	L_GAME_OVER_STRING_DATA 	; 0 = "GAME OVER"
12379  35BF 01 00       		.word	1 		; unused
12380  35C1 0A 36       		.word	L_PLAYER_1_STRING_DATA 	; 2 = "PLAYER (I)"
12381  35C3 17 36       		.word	L_PLAYER_2_STRING_DATA 	; 3 = "PLAYER (II)"
12382  35C5 24 36       		.word	L_HIGH_SCORE_STRING_DATA 	; 4 = "HIGH SCORE"
12383  35C7 31 36       		.word	L_CREDIT_STRING_DATA 	; 5 = "CREDIT    "
12384  35C9 06 00       		.word	6 		; unused
12385  35CB 3E 36       		.word	L_HOW_HIGH_STRING_DATA 	; 7 = "HOW HIGH CAN YOU GET ? "
12386  35CD 08 00       		.word	8 		; unused
12387  35CF 58 36       		.word	L_ONLY_1_STRING_DATA 	; 9 = "ONLY 1 PlAYER BUTTON"
12388  35D1 6F 36       		.word	L_1_OR_2_STRING_DATA 	; 10 = "1 OR 2 PLAYERS BUTTON"
12389  35D3 0B 00       		.word	11		; unused
12390  35D5 87 36       		.word	L_PUSH_STRING_DATA 	; 12 = "PUSH"
12391  35D7 8E 36       		.word	L_REGIS_STRING_DATA 	; 13 = "NAME REGISTRATION"
12392  35D9 A2 36       		.word	L_NAME_STRING_DATA 	; 14 = "NAME:"
12393  35DB AA 36       		.word	L_UNDERLINE_STRING_DATA 	; 15 = "---         "
12394  35DD B9 36       		.word	L_A_TO_J_STRING_DATA 	; 16 = "A B C D E F G H I J"
12395  35DF CF 36       		.word	L_K_TO_T_STRING_DATA 	; 17 = "K L M N O P Q R S T"
12396  35E1 E5 36       		.word	L_U_TO_END_STRING_DATA 	; 18 = "U V W X Y Z . -RUBEND "
12397  35E3 FD 36       		.word	L_REGI_TIME_STRING_DATA 	; 19 = "REGI TIME  (30) "
12398  35E5 00 61       		.word	HIGH_SCORE_TABLE_ENTRY_1 ; 20 = HIGH_SCORE_TABLE_ENTRY_1
12399  35E7 22 61       		.word	HIGH_SCORE_TABLE_ENTRY_2 ; 21 = HIGH_SCORE_TABLE_ENTRY_2
12400  35E9 44 61       		.word	HIGH_SCORE_TABLE_ENTRY_3 ; 22 = HIGH_SCORE_TABLE_ENTRY_3
12401  35EB 66 61       		.word	HIGH_SCORE_TABLE_ENTRY_4 ; 23 = HIGH_SCORE_TABLE_ENTRY_4
12402  35ED 88 61       		.word	HIGH_SCORE_TABLE_ENTRY_5 ; 24 = HIGH_SCORE_TABLE_ENTRY_5
12403  35EF 10 37       		.word	l379e 	; 25 = "RANK  SCORE  NAME    "
12404  35F1 28 37       		.word	l37b6 	; 26 = "YOUR NAME WAS REGISTERED."
12405  35F3 44 37       		.word	l37d2 	; 27 = "INSERT COIN "
12406  35F5 53 37       		.word	l37e1 	; 28 = "  PLAYER    COIN"
12407  35F7 1D 00       		.word	29		; unused
12408  35F9 71 3E       		.word	L_1981_STRING_DATA 	; 30 = "1981"
12409  35FB 7A 3E       		.word	L_NINTENDO_STRING_DATA 	; 31 = "NINTENDO OF AMERICA"
12410  35FD             ;------------------------------------------------------------------------------
12411  35FD             
12412  35FD             
12413  35FD             
12414  35FD             ;------------------------------------------------------------------------------
12415  35FD             ; Static strings
12416  35FD             ; "GAME  OVER" 
12417  35FD             L_GAME_OVER_STRING_DATA: 	
12418  35FD 96 76       		.word	TILE_COORD(20,22) 	; (20, 22) 
12419  35FF 17 11 1D 15 		.byte	$17, $11, $1d, $15, $10, $10, $1f, $26, $15, $22
12419  3603 10 10 1F 26 
12419  3607 15 22 
12420  3609 3F          		.byte	$3f		; End string
12421  360A             		
12422  360A             ; "PLAYER (I)" 
12423  360A             L_PLAYER_1_STRING_DATA: 	
12424  360A 94 76       		.word	TILE_COORD(20,20) 	; (20, 20)
12425  360C 20 1C 11 29 		.byte	$20, $1C, $11, $29, $15, $22, $10, $30, $32, $31
12425  3610 15 22 10 30 
12425  3614 32 31 
12426  3616 3F          		.byte	$3F
12427  3617             				
12428  3617             ; "PLAYER (II)"
12429  3617             L_PLAYER_2_STRING_DATA: 	
12430  3617 94 76       		.word   TILE_COORD(20,20)	; (20, 20)
12431  3619 20 1C 11 29 		.byte	$20, $1C, $11, $29, $15, $22, $10, $30, $33, $31
12431  361D 15 22 10 30 
12431  3621 33 31 
12432  3623 3F          		.byte	$3F
12433  3624             				
12434  3624             ; "HIGH SCORE" 
12435  3624             L_HIGH_SCORE_STRING_DATA: 	
12436  3624 80 76       		.word   TILE_COORD(20,0)	; (20, 0)  
12437  3626 18 19 17 18 		.byte	$18, $19, $17, $18, $10, $23, $13, $1F, $22, $15
12437  362A 10 23 13 1F 
12437  362E 22 15 
12438  3630 3F          		.byte	$3F
12439  3631             				
12440  3631             ; "CREDIT    "
12441  3631             L_CREDIT_STRING_DATA: 	
12442  3631 9F 75       		.word   TILE_COORD(12,31) 	; (12, 31)
12443  3633 13 22 15 14 		.byte	$13, $22, $15, $14, $19, $24, $10, $10, $10, $10
12443  3637 19 24 10 10 
12443  363B 10 10 
12444  363D 3F          		.byte	$3F
12445  363E             				
12446  363E             ; "HOW HIGH CAN YOU GET ? "
12447  363E             L_HOW_HIGH_STRING_DATA: 	
12448  363E 5E 77       		.word   TILE_COORD(26,30)	; (25, 31)
12449  3640 18 1F 27 10 		.byte	$18, $1F, $27, $10, $18, $19, $17, $18, $10, $13, $11, $1E, $10, $29, $1F, $25, $10, $17, $15, $24, $10, $FB, $10
12449  3644 18 19 17 18 
12449  3648 10 13 11 1E 
12449  364C 10 29 1F 25 
12449  3650 10 17 15 24 
12449  3654 10 FB 10 
12450  3657 3F          		.byte	$3F
12451  3658             				
12452  3658             ; "ONLY 1 PlAYER BUTTON"
12453  3658             L_ONLY_1_STRING_DATA: 	
12454  3658 29 77       		.word   TILE_COORD(25,9)	; (25, 9)
12455  365A 1F 1E 1C 29 		.byte	$1F, $1E, $1C, $29, $10, $01, $10, $20, $1C, $11, $29, $15, $22, $10, $12, $25, $24, $24, $1F, $1E
12455  365E 10 01 10 20 
12455  3662 1C 11 29 15 
12455  3666 22 10 12 25 
12455  366A 24 24 1F 1E 
12456  366E 3F          		.byte	$3F
12457  366F             				
12458  366F             ; "1 OR 2 PLAYERS BUTTON"
12459  366F             L_1_OR_2_STRING_DATA: 	
12460  366F 29 77       		.word   TILE_COORD(25,9)	; (25, 9)
12461  3671 01 10 1F 22 		.byte	$01, $10, $1F, $22, $10, $02, $10, $20, $1C, $11, $29, $15, $22, $23, $10, $12, $25, $24, $24, $1F, $1E
12461  3675 10 02 10 20 
12461  3679 1C 11 29 15 
12461  367D 22 23 10 12 
12461  3681 25 24 24 1F 
12461  3685 1E 
12462  3686 3F          		.byte	$3F
12463  3687             				
12464  3687             ; "PUSH"
12465  3687             L_PUSH_STRING_DATA: 	
12466  3687 27 76       		.word   TILE_COORD(17,7)	; (17, 7)
12467  3689 20 25 23 18 		.byte	$20, $25, $23, $18
12468  368D 3F          		.byte	$3F
12469  368E             		
12470  368E             ; "NAME REGISTRATION"
12471  368E             L_REGIS_STRING_DATA: 	
12472  368E 06 77       		.word   TILE_COORD(24,6)	; (24, 6)
12473  3690 1E 11 1D 15 		.byte	$1E, $11, $1D, $15, $10, $22, $15, $17, $19, $23, $24, $22, $11, $24, $19, $1F, $1E
12473  3694 10 22 15 17 
12473  3698 19 23 24 22 
12473  369C 11 24 19 1F 
12473  36A0 1E 
12474  36A1 3F          		.byte	$3F
12475  36A2             		
12476  36A2             ; "NAME:"
12477  36A2             L_NAME_STRING_DATA: 	
12478  36A2 88 76       		.word   TILE_COORD(20,8)	; (20, 8)
12479  36A4 1E 11 1D 15 		.byte	$1E, $11, $1D, $15, $2E
12479  36A8 2E 
12480  36A9 3F          		.byte	$3F
12481  36AA             				
12482  36AA             ; "---         " ('-''s are underlines)
12483  36AA             L_UNDERLINE_STRING_DATA: 	
12484  36AA E9 75       		.word   TILE_COORD(15,9)	; (15, 9)
12485  36AC 2D 2D 2D 10 		.byte	$2D, $2D, $2D, $10, $10, $10, $10, $10, $10, $10, $10, $10
12485  36B0 10 10 10 10 
12485  36B4 10 10 10 10 
12486  36B8 3F          		.byte	$3F
12487  36B9             				
12488  36B9             ; "A B C D E F G H I J"
12489  36B9             L_A_TO_J_STRING_DATA: 	
12490  36B9 0B 77       		.word   TILE_COORD(24,11)	; (24, 11)
12491  36BB 11 10 12 10 		.byte	$11, $10, $12, $10, $13, $10, $14, $10, $15, $10, $16, $10, $17, $10, $18, $10, $19, $10, $1A
12491  36BF 13 10 14 10 
12491  36C3 15 10 16 10 
12491  36C7 17 10 18 10 
12491  36CB 19 10 1A 
12492  36CE 3F          		.byte	$3F
12493  36CF             		
12494  36CF             ; "K L M N O P Q R S T"
12495  36CF             L_K_TO_T_STRING_DATA: 	
12496  36CF 0D 77       		.word   TILE_COORD(24,13)	; (24, 13)
12497  36D1 1B 10 1C 10 		.byte	$1B, $10, $1C, $10, $1D, $10, $1E, $10, $1F, $10, $20, $10, $21, $10, $22, $10, $23, $10, $24
12497  36D5 1D 10 1E 10 
12497  36D9 1F 10 20 10 
12497  36DD 21 10 22 10 
12497  36E1 23 10 24 
12498  36E4 3F          		.byte	$3F
12499  36E5             				
12500  36E5             ; "U V W X Y Z . -RUBEND "
12501  36E5             L_U_TO_END_STRING_DATA: 	
12502  36E5 0F 77       		.word   TILE_COORD(24,15)	; (24, 15)
12503  36E7 25 10 26 10 		.byte	$25, $10, $26, $10, $27, $10, $28, $10, $29, $10, $2A, $10, $2B, $10, $2C, $44, $45, $46, $47, $48, $10
12503  36EB 27 10 28 10 
12503  36EF 29 10 2A 10 
12503  36F3 2B 10 2C 44 
12503  36F7 45 46 47 48 
12503  36FB 10 
12504  36FC 3F          		.byte	$3F
12505  36FD             				
12506  36FD             ; "REGI TIME  (30) "
12507  36FD             L_REGI_TIME_STRING_DATA: 	
12508  36FD F2 76       		.word   TILE_COORD(23,18)	; (23, 18)
12509  36FF 22 15 17 19 		.byte	$22, $15, $17, $19, $10, $24, $19, $1D, $15, $10, $10, $30, $03, $00, $31, $10
12509  3703 10 24 19 1D 
12509  3707 15 10 10 30 
12509  370B 03 00 31 10 
12510  370F 3F          		.byte	$3F
12511  3710             				
12512  3710             ; "RANK  SCORE  NAME    "
12513  3710             l379e: 	
12514  3710 92 77       		.word   TILE_COORD(28,18)	; (28, 18)
12515  3712 22 11 1E 1B 		.byte	$22, $11, $1E, $1B, $10, $10, $23, $13, $1F, $22, $15, $10, $10, $1E, $11, $1D, $15, $10, $10, $10, $10
12515  3716 10 10 23 13 
12515  371A 1F 22 15 10 
12515  371E 10 1E 11 1D 
12515  3722 15 10 10 10 
12515  3726 10 
12516  3727 3F          		.byte	$3F
12517  3728             		
12518  3728             ; "YOUR NAME WAS REGISTERED."
12519  3728             l37b6: 	
12520  3728 72 77       		.word   TILE_COORD(27,18)	; (27, 18)
12521  372A 29 1F 25 22 		.byte	$29, $1F, $25, $22, $10, $1E, $11, $1D, $15, $10, $27, $11, $23, $10, $22, $15, $17, $19, $23, $24, $15, $22, $15, $14, $42
12521  372E 10 1E 11 1D 
12521  3732 15 10 27 11 
12521  3736 23 10 22 15 
12521  373A 17 19 23 24 
12521  373E 15 22 15 14 
12521  3742 42 
12522  3743 3F          		.byte	$3F
12523  3744             		
12524  3744             ; "INSERT COIN "
12525  3744             l37d2: 	
12526  3744 A7 76       		.word   TILE_COORD(21,7)	; (21, 7)
12527  3746 19 1E 23 15 		.byte	$19, $1E, $23, $15, $22, $24, $10, $13, $1F, $19, $1E, $10
12527  374A 22 24 10 13 
12527  374E 1F 19 1E 10 
12528  3752 3F          		.byte	$3F
12529  3753             				
12530  3753             ; "  PLAYER    COIN"
12531  3753             l37e1: 	
12532  3753 0A 77       		.word   TILE_COORD(24,10)	; (24, 10)
12533  3755 10 10 20 1C 		.byte	$10, $10, $20, $1C, $11, $29, $15, $22, $10, $10, $10, $10, $13, $1F, $19, $1E
12533  3759 11 29 15 22 
12533  375D 10 10 10 10 
12533  3761 13 1F 19 1E 
12534  3765 3F          		.byte	$3F
12535  3766             				
12536  3766             ; " NINTENDO    "
12537  3766             l37f4: 	
12538  3766 FC 76       		.word   TILE_COORD(23,28)	; (23, 28)
12539  3768 49 4A 10 1E 		.byte	$49, $4A, $10, $1E, $19, $1E, $24, $15, $1E, $14, $1F, $10, $10, $10, $10
12539  376C 19 1E 24 15 
12539  3770 1E 14 1F 10 
12539  3774 10 10 10 
12540  3777 3F          		.byte	$3F
12541  3778             				
12542  3778             ; "1981"
12543  3778             l3806: 	
12544  3778 7C 75       		.word   TILE_COORD(11,28)	; (11, 28)
12545  377A 01 09 08 01 		.byte	$01, $09, $08, $01
12546  377E 3F          		.byte	$3F
12547  377F             ;------------------------------------------------------------------------------
12548  377F             
12549  377F             
12550  377F             ;------------------------------------------------------------------------------
12551  377F             ; Introduction stage data
12552  377F             ; (This is essentially the barrels level before Donkey Kong stomps and warps
12553  377F             ; it)
12554  377F             L_INTRO_STAGE_DATA: 	
12555  377F             		; Pauline's platform
12556  377F 02          		.byte	$02		; Barrels girders
12557  3780 97 38       		.word	$3897	; (18,7) offset 0
12558  3782 68 38       		.word	$3868	; (13,7) offset 0
12559  3784             
12560  3784             		; 5th platform		
12561  3784 02          		.byte	$02		; Barrels girders
12562  3785 DF 54       		.word	$54DF	; (27,10) offset 4
12563  3787 10 54       		.word	$5410	; (2,10) offset 4
12564  3789             		
12565  3789             		; 4th platform
12566  3789 02          		.byte	$02		; Barrels girders
12567  378A EF 6D       		.word	$6DEF	; (29,13) offset 5
12568  378C 20 6D       		.word	$6D20	; (4,13) offset 5
12569  378E             		
12570  378E             		; 3rd platform
12571  378E 02          		.byte	$02		; Barrels girders
12572  378F DF 8E       		.word	$8EDF	; (27,17) offset 6
12573  3791 10 8E       		.word	$8E10	; (2,17) offset 6
12574  3793             		
12575  3793             		; 2nd platform
12576  3793 02          		.byte	$02		; Barrels girders
12577  3794 EF AF       		.word	$AFEF	; (29,21) offset 7
12578  3796 20 AF       		.word	$AF20	; (4,21) offset 7
12579  3798             		
12580  3798             		; 1st platform
12581  3798 02          		.byte	$02		; Barrels girders
12582  3799 DF D0       		.word	$D0DF	; (27,26) offset 0
12583  379B 10 D0       		.word	$D010	; (2,26) offset 0
12584  379D             
12585  379D             		; Floor		
12586  379D 02          		.byte	$02		; Barrels girders
12587  379E EF F1       		.word	$F1EF	; (29,30) offset 1
12588  37A0 10 F1       		.word	$F110	; (4,30) offset 1
12589  37A2             		
12590  37A2 00          		.byte	$00		; Ladder
12591  37A3 53 18       		.word	$1853	; (10,3) offset 0
12592  37A5 53 54       		.word	$5453	; (10,10) offset 4
12593  37A7             		
12594  37A7 00          		.byte	$00		; Ladder
12595  37A8 63 18       		.word	$1863	; (12,3) offset 0
12596  37AA 63 54       		.word	$5463	; (12,10) offset 4
12597  37AC             		
12598  37AC 00          		.byte	$00		; Ladder
12599  37AD 93 38       		.word	$3893	; (18,7) offset 0
12600  37AF 93 54       		.word	$5493	; (18,10) offset 4
12601  37B1             		
12602  37B1 00          		.byte	$00		; Ladder
12603  37B2 83 54       		.word	$5483	; (16,10) offset 4
12604  37B4 83 F1       		.word	$F183	; (16,30) offset 1
12605  37B6             		
12606  37B6 00          		.byte	$00		; Ladder
12607  37B7 93 54       		.word	$5493	; (18,10) offset 4
12608  37B9 93 F1       		.word	$F193	; (18,30) offset 1
12609  37BB             		
12610  37BB AA          		.byte   $aa		; End of data
12611  37BC             ;------------------------------------------------------------------------------
12612  37BC             
12613  37BC             
12614  37BC             
12615  37BC             ;------------------------------------------------------------------------------
12616  37BC             ; The characters that make up the timer display
12617  37BC             ;					|BONUS|
12618  37BC             ;					|0000 |
12619  37BC             ;					 -----
12620  37BC             L_TIMER_BOX_TILE_DATA: 	
12621  37BC 8D          		.byte   $8D     ; upper-right corner
12622  37BD 7D          		.byte   $7D 	; right edge
12623  37BE 8C          		.byte   $8C 	; lower-right corner
12624  37BF 6F          		.byte   $6F 	; top edge
12625  37C0 00          		.byte   $00 	; '0'
12626  37C1 7C          		.byte   $7C 	; bottom edge
12627  37C2 6E          		.byte   $6E 	; top edge
12628  37C3 00          		.byte   $00 	; '0'
12629  37C4 7C          		.byte   $7C 	; bottom edge
12630  37C5 6D          		.byte   $6D 	; top edge
12631  37C6 00          		.byte   $00 	; '0'
12632  37C7 7C          		.byte   $7C 	; bottom edge
12633  37C8 6C          		.byte   $6C 	; top edge
12634  37C9 00          		.byte   $00 	; '0'
12635  37CA 7C          		.byte   $7C 	; bottom edge
12636  37CB 8F          		.byte   $8F 	; upper-left corner
12637  37CC 7F          		.byte   $7F 	; left edge
12638  37CD 8E          		.byte   $8E 	; lower-left corner
12639  37CE             ;------------------------------------------------------------------------------
12640  37CE             
12641  37CE             
12642  37CE             
12643  37CE             ;------------------------------------------------------------------------------
12644  37CE             ; Sprite data for Donkey Kong standing with his left arm raised
12645  37CE             L_DK_SPRITES_L_ARM_RAISED:	
12646  37CE 47          		.byte	$47		; DK front right leg 
12647  37CF 27          		.byte	$27
12648  37D0 08          		.byte	$08
12649  37D1 50          		.byte	$50
12650  37D2             		
12651  37D2 2F          		.byte	$2F		; DK front left leg (flipped h.)
12652  37D3 A7          		.byte	$A7 
12653  37D4 08          		.byte	$08 
12654  37D5 50          		.byte	$50 
12655  37D6             		
12656  37D6 3B          		.byte	$3B		; DK front chest
12657  37D7 25          		.byte	$25 
12658  37D8 08          		.byte	$08 
12659  37D9 50          		.byte	$50 
12660  37DA             		
12661  37DA 00          		.byte	$00		; unused
12662  37DB 70          		.byte	$70 
12663  37DC 08          		.byte	$08 
12664  37DD 48          		.byte	$48 
12665  37DE             		
12666  37DE 3B          		.byte	$3B		; DK front head
12667  37DF 23          		.byte	$23		; Mouth closed 
12668  37E0 07          		.byte	$07 
12669  37E1 40          		.byte	$40 
12670  37E2             		
12671  37E2 46          		.byte	$46		; DK front left arm (flipped h.)
12672  37E3 A9          		.byte	$A9		; ($29 - right arm lowered and curled)
12673  37E4 08          		.byte	$08 
12674  37E5 44          		.byte	$44 
12675  37E6             		
12676  37E6 00          		.byte	$00		; unused
12677  37E7 70          		.byte	$70 
12678  37E8 08          		.byte	$08 
12679  37E9 48          		.byte	$48 
12680  37EA             		
12681  37EA 30          		.byte	$30		; DK front right arm
12682  37EB 29          		.byte	$29 
12683  37EC 08          		.byte	$08 
12684  37ED 44          		.byte	$44 
12685  37EE             		
12686  37EE 00          		.byte	$00		; unused
12687  37EF 70          		.byte	$70 
12688  37F0 08          		.byte	$08 
12689  37F1 48          		.byte	$48 
12690  37F2             		
12691  37F2 00          		.byte	$00		; unused
12692  37F3 70          		.byte	$70 
12693  37F4 0A          		.byte	$0A 
12694  37F5 48          		.byte	$48 
12695  37F6             ;------------------------------------------------------------------------------
12696  37F6             
12697  37F6             
12698  37F6             
12699  37F6             ;------------------------------------------------------------------------------
12700  37F6             ; Sprite data for Pauline standing, facing right
12701  37F6             L_PAULINE_SPRITES_FACE_RIGHT:	
12702  37F6 6F          		.byte	$6F
12703  37F7 10          		.byte	$10		; $10 (Pauline's head facing right) 
12704  37F8 09          		.byte	$09 
12705  37F9 23          		.byte	$23 
12706  37FA             		
12707  37FA 6F          		.byte	$6F
12708  37FB 11          		.byte	$11		; $11 (Pauline's body facing right) 
12709  37FC 0A          		.byte	$0A 
12710  37FD 33          		.byte	$33 
12711  37FE             ;------------------------------------------------------------------------------
12712  37FE             
12713  37FE             
12714  37FE             
12715  37FE             ;------------------------------------------------------------------------------
12716  37FE             ; Sprite data for Donkey Kong climbing
12717  37FE             L_DK_SPRITES_CLIMBING:	
12718  37FE 50          		.byte	$50		; DK Left Arm
12719  37FF 34          		.byte	$34 
12720  3800 08          		.byte	$08 
12721  3801 3C          		.byte	$3C 
12722  3802             		
12723  3802 00          		.byte	$00		; DK Right Arm (hidden initially)
12724  3803 35          		.byte	$35 
12725  3804 08          		.byte	$08 
12726  3805 3C          		.byte	$3C 
12727  3806             		
12728  3806 53          		.byte	$53		; DK Left Head
12729  3807 32          		.byte	$32 
12730  3808 08          		.byte	$08 
12731  3809 40          		.byte	$40 
12732  380A             		
12733  380A 63          		.byte	$63		; DK Right Head
12734  380B 33          		.byte	$33 
12735  380C 08          		.byte	$08 
12736  380D 40          		.byte	$40 
12737  380E             		
12738  380E 00          		.byte	$00		; 
12739  380F 70          		.byte	$70 
12740  3810 08          		.byte	$08 
12741  3811 48          		.byte	$48 
12742  3812             		
12743  3812 53          		.byte	$53		; DK Left Leg
12744  3813 36          		.byte	$36 
12745  3814 08          		.byte	$08 
12746  3815 50          		.byte	$50 
12747  3816             		
12748  3816 63          		.byte	$63		; DK Right Leg
12749  3817 37          		.byte	$37 
12750  3818 08          		.byte	$08 
12751  3819 50          		.byte	$50 
12752  381A             		
12753  381A 6B          		.byte	$6B		; DK Right Arm carrying Pauline
12754  381B 31          		.byte	$31 
12755  381C 08          		.byte	$08 
12756  381D 41          		.byte	$41 
12757  381E             		
12758  381E 00          		.byte	$00		; 
12759  381F 70          		.byte	$70 
12760  3820 08          		.byte	$08 
12761  3821 48          		.byte	$48 
12762  3822             		
12763  3822 6A          		.byte	$6A		; Pauline being carried
12764  3823 14          		.byte	$14 
12765  3824 0A          		.byte	$0A 
12766  3825 48          		.byte	$48 
12767  3826             ;------------------------------------------------------------------------------
12768  3826             
12769  3826             
12770  3826             
12771  3826             ;------------------------------------------------------------------------------
12772  3826             ; Data describing Donkey Kong's jump from the top of the ladders onto the top
12773  3826             ; platform on the intro screen
12774  3826             L_DK_JUMP_FROM_LADDER_DATA:	
12775  3826 FD FD FD FD 		.byte	-3, -3, -3, -3, -3, -3, -3
12775  382A FD FD FD 
12776  382D FE FE FE FE 		.byte	-2, -2, -2, -2, -2, -2
12776  3831 FE FE 
12777  3833 FF FF FF FF 		.byte	-1, -1, -1, -1
12778  3837 00 00       		.byte	 0,  0
12779  3839 01 01 01    		.byte	 1,  1,  1
12780  383C 7F          		.byte	$7F 	; End of data
12781  383D             ;------------------------------------------------------------------------------
12782  383D             
12783  383D             
12784  383D             
12785  383D             ;------------------------------------------------------------------------------
12786  383D             ; Data describing Donkey Kong's jumps across the top platform in the intro
12787  383D             ; screen
12788  383D             L_DK_JUMP_ACROSS_PLAT_DATA:	
12789  383D FF FF FF FF 		.byte	-1, -1, -1, -1, -1,  0, -1,  0
12789  3841 FF 00 FF 00 
12790  3845 00 01 00 01 		.byte	 0,  1,  0,  1,  1,  1,  1,  1
12790  3849 01 01 01 01 
12791  384D 7F          		.byte	$7f		; End of data
12792  384E             
12793  384E             ;------------------------------------------------------------------------------
12794  384E             		
12795  384E             		
12796  384E             		
12797  384E             ;------------------------------------------------------------------------------
12798  384E             l38dc:	
12799  384E             		; First set of deformation data
12800  384E 04          		.byte	$04		; Blank tiles
12801  384F 7F F0       		.word	$F07F	; (15,30)
12802  3851 10 F0       		.word	$F010	; (2,30)
12803  3853             		     
12804  3853 02          		.byte	$02		; Barrel girders
12805  3854 DF F2       		.word	$F2DF	; (27,30) offset 2
12806  3856 70 F8       		.word	$F870	; (14,31) offset 0
12807  3858             		
12808  3858 02          		.byte	$02		; Barrel girders
12809  3859 6F F8       		.word	$F86F	; (13,14) offset 0
12810  385B 10 F8       		.word	$F810	; (2,14) offset 0
12811  385D             		
12812  385D AA          		.byte	$AA		; End of data
12813  385E             		
12814  385E             		
12815  385E             		; Second set of deformation data
12816  385E 04          		.byte	$04		; Blank tiles
12817  385F DF D0       		.word	$D0DF	; (27,26)
12818  3861 90 D0       		.word	$D090	; 18,26)
12819  3863             		
12820  3863 02          		.byte	$02		; Barrel girders
12821  3864 DF DC       		.word	$DCDF	; (27,27) offset 4
12822  3866 20 D1       		.word	$D120	; (4,26) offset 1
12823  3868             		
12824  3868 AA          		.byte	$AA		; End of data
12825  3869             		
12826  3869 FF FF FF FF 		.byte	$FF, $FF, $FF, $FF, $FF	; Filler
12826  386D FF 
12827  386E             		
12828  386E             		
12829  386E             		; Third set of deformation data
12830  386E 04          		.byte	$04		; Blank tiles
12831  386F DF A8       		.word	$A8DF	; (27,21)
12832  3871 20 A8       		.word	$A820	; (4,21)
12833  3873             		
12834  3873 04          		.byte	$04		; Blank tiles
12835  3874 5F B0       		.word	$B05F	; (11,22)
12836  3876 20 B0       		.word	$B020	; (21,22)
12837  3878             		
12838  3878 02          		.byte	$02		; Barrel girders
12839  3879 DF B0       		.word	$B0DF	; (27,22) offset 0
12840  387B 20 BB       		.word	$BB20	; (21,23) offset 3
12841  387D             		
12842  387D AA          		.byte	$AA		; End of data
12843  387E             		
12844  387E             		
12845  387E             		; Fourth set of deformation data
12846  387E 04          		.byte	$04		; Blank tiles
12847  387F DF 88       		.word	$88DF	; (27,17)
12848  3881 30 88       		.word	$8830	; (6,17)
12849  3883             		
12850  3883 04          		.byte	$04		; Blank tiles
12851  3884 DF 90       		.word	$90DF	; (27,18)
12852  3886 B0 90       		.word	$90B0	; (27,18)
12853  3888             		
12854  3888 02          		.byte	$02		; Barrel girders
12855  3889 DF 9A       		.word	$9ADF	; (27,19) offset 2
12856  388B 20 8F       		.word	$8F20	; (21,17) offset 7
12857  388D             		
12858  388D AA          		.byte	$AA		; End of data
12859  388E             		
12860  388E             		
12861  388E             		; Fifth set of deformation data
12862  388E 04          		.byte	$04		; Blank tiles
12863  388F BF 68       		.word	$68BF	; (23,13)
12864  3891 20 68       		.word	$6820	; (21,13)
12865  3893             		
12866  3893 04          		.byte	$04		; Blank tiles
12867  3894 3F 70       		.word	$703F	; (7,14)
12868  3896 20 70       		.word	$7020	; (21,14)
12869  3898             		
12870  3898 02          		.byte	$02		; Barrel girders
12871  3899 DF 6E       		.word	$6EDF	; (27,13) offset 6
12872  389B 20 79       		.word	$7920	; (21,15) offset 1
12873  389D             		
12874  389D AA          		.byte	$AA		; End of data
12875  389E             ;------------------------------------------------------------------------------
12876  389E             
12877  389E             
12878  389E             
12879  389E             ;------------------------------------------------------------------------------
12880  389E             ; Data defining the sloped portion of the 6th platform on the intro and barrels
12881  389E             ; stage
12882  389E             L_INTRO_DATA_SLOPE6: 	
12883  389E 02          		.byte	$02	; Barrels girder
12884  389F DF 58       		.word	$58DF	; (27,11) offset 0
12885  38A1 A0 55       		.word	$55A0	; (20,10) offset 5
12886  38A3 AA          		.byte	$AA	; End of data
12887  38A4             ;------------------------------------------------------------------------------
12888  38A4             
12889  38A4             
12890  38A4             
12891  38A4             ;------------------------------------------------------------------------------
12892  38A4             ; Sprite data for Donkey Kong facing right, left arm reaching out
12893  38A4             L_DK_SPRITES_THROW_BARREL: 	
12894  38A4 00          		.byte	$00		; x coord 
12895  38A5 70          		.byte	$70		; sprite number
12896  38A6 08          		.byte	$08		; palette
12897  38A7 44          		.byte	$44		; y coord
12898  38A8             		
12899  38A8 2B          		.byte	$2B		; x coord 
12900  38A9 AC          		.byte	$AC		; sprite number ($2c - left leg back)
12901  38AA 08          		.byte	$08		; palette 
12902  38AB 4C          		.byte	$4C		; y coord
12903  38AC             		
12904  38AC 3B          		.byte	$3B		; x coord 
12905  38AD AE          		.byte	$AE		; sprite number ($2e - body sideways)
12906  38AE 08          		.byte	$08		; palette 
12907  38AF 4C          		.byte	$4C		; y coord 
12908  38B0             		
12909  38B0 3B          		.byte	$3B		; x coord 
12910  38B1 AF          		.byte	$AF		; sprite number ($2f - back sideways)
12911  38B2 08          		.byte	$08		; palette 
12912  38B3 3C          		.byte	$3C		; y coord
12913  38B4             		
12914  38B4 4B          		.byte	$4B		; x coord 
12915  38B5 B0          		.byte	$B0		; sprite number ($30 - head sideways)
12916  38B6 07          		.byte	$07		; palette 
12917  38B7 3C          		.byte	$3C		; y coord
12918  38B8             		
12919  38B8 4B          		.byte	$4B		; x coord 
12920  38B9 AD          		.byte	$AD		; sprite number ($2d - head sideways)
12921  38BA 08          		.byte	$08		; palette 
12922  38BB 4C          		.byte	$4C		; y coord
12923  38BC             		
12924  38BC 00          		.byte	$00		; x coord 
12925  38BD 70          		.byte	$70		; sprite number 
12926  38BE 08          		.byte	$08		; palette 
12927  38BF 44          		.byte	$44		; y coord 
12928  38C0             		
12929  38C0 00          		.byte	$00		; x coord 
12930  38C1 70          		.byte	$70		; sprite number 
12931  38C2 08          		.byte	$08		; palette 
12932  38C3 44          		.byte	$44		; y coord 
12933  38C4             		
12934  38C4 00          		.byte	$00		; x coord 
12935  38C5 70          		.byte	$70		; sprite number 
12936  38C6 08          		.byte	$08		; palette 
12937  38C7 44          		.byte	$44		; y coord 
12938  38C8             		
12939  38C8 00          		.byte	$00		; x coord 
12940  38C9 70          		.byte	$70		; sprite number 
12941  38CA 0A          		.byte	$0A		; palette 
12942  38CB 44          		.byte	$44		; y coord 
12943  38CC             ;------------------------------------------------------------------------------
12944  38CC             
12945  38CC             
12946  38CC             
12947  38CC             ;------------------------------------------------------------------------------
12948  38CC             ; Sprite data for Donkey Kong standing with arms down
12949  38CC             L_DK_SPRITES_ARMS_DOWN:	
12950  38CC 47          		.byte	$47		; x coord 
12951  38CD 27          		.byte	$27		; sprite number ($27 - left leg)
12952  38CE 08          		.byte	$08		; palette 
12953  38CF 4C          		.byte	$4C		; y coord
12954  38D0             		
12955  38D0 2F          		.byte	$2F		; x coord 
12956  38D1 A7          		.byte	$A7		; sprite number ($27 - right leg)
12957  38D2 08          		.byte	$08		; palette 
12958  38D3 4C          		.byte	$4C		; y coord
12959  38D4             		
12960  38D4 3B          		.byte	$3B		; x coord
12961  38D5 25          		.byte	$25		; sprite number ($25 - torso)
12962  38D6 08          		.byte	$08		; palette
12963  38D7 4C          		.byte	$4C		; y coord
12964  38D8             		
12965  38D8 00          		.byte	$00		; x coord
12966  38D9 70          		.byte	$70		; sprite number
12967  38DA 08          		.byte	$08		; palette
12968  38DB 44          		.byte	$44		; y coord
12969  38DC             		
12970  38DC 3B          		.byte	$3B		; x coord
12971  38DD 23          		.byte	$23		; sprite number ($23 - face frowning)
12972  38DE 07          		.byte	$07		; palette
12973  38DF 3C          		.byte	$3C		; y coord
12974  38E0             		
12975  38E0 4B          		.byte	$4B		; x coord
12976  38E1 2A          		.byte	$2A		; sprite number ($2a - right shoulder)
12977  38E2 08          		.byte	$08		; palette
12978  38E3 3C          		.byte	$3C		; y coord
12979  38E4             		
12980  38E4 4B          		.byte	$4B		; x coord
12981  38E5 2B          		.byte	$2B		; sprite number ($2b - right arm)
12982  38E6 08          		.byte	$08		; palette
12983  38E7 4C          		.byte	$4C		; y coord
12984  38E8             		
12985  38E8 2B          		.byte	$2B		; x coord
12986  38E9 AA          		.byte	$AA		; sprite number ($2a - left shoulder)
12987  38EA 08          		.byte	$08		; palette
12988  38EB 3C          		.byte	$3C		; y coord
12989  38EC             		
12990  38EC 2B          		.byte	$2B		; x coord
12991  38ED AB          		.byte	$AB		; sprite number ($2b - left arm)
12992  38EE 08          		.byte	$08		; palette
12993  38EF 4C          		.byte	$4C		; y coord
12994  38F0             		
12995  38F0 00          		.byte	$00		; x coord
12996  38F1 70          		.byte	$70		; sprite number
12997  38F2 0A          		.byte	$0A		; palette
12998  38F3 44          		.byte	$44		; y coord
12999  38F4             ;------------------------------------------------------------------------------
13000  38F4             
13001  38F4             
13002  38F4             ;------------------------------------------------------------------------------
13003  38F4             ; Sprite data for Donkey Kong
13004  38F4             L_DK_SPRITES_GRAB_BARREL:	
13005  38F4 00          		.byte	$00		; x coord
13006  38F5 70          		.byte	$70		; sprite number
13007  38F6 08          		.byte	$08		; palette
13008  38F7 44          		.byte	$44		; y coord
13009  38F8             		
13010  38F8 4B          		.byte	$4B		; x coord
13011  38F9 2C          		.byte	$2C		; sprite number ($2c - left leg back)
13012  38FA 08          		.byte	$08		; palette
13013  38FB 4C          		.byte	$4C		; y coord
13014  38FC             		
13015  38FC 3B          		.byte	$3B		; x coord
13016  38FD 2E          		.byte	$2E		; sprite number  ($2e - torso)
13017  38FE 08          		.byte	$08		; palette
13018  38FF 4C          		.byte	$4C		; y coord
13019  3900             		
13020  3900 3B          		.byte	$3B		; x coord
13021  3901 2F          		.byte	$2F		; sprite number ($2f - back)
13022  3902 08          		.byte	$08		; palette
13023  3903 3C          		.byte	$3C		; y coord
13024  3904             		
13025  3904 2B          		.byte	$2B		; x coord
13026  3905 30          		.byte	$30		; sprite number ($30 - head facing left)
13027  3906 07          		.byte	$07		; palette
13028  3907 3C          		.byte	$3C		; y coord
13029  3908             		
13030  3908 2B          		.byte	$2B		; x coord
13031  3909 2D          		.byte	$2D		; sprite number ($2d - right leg, left arm forward, reaching)
13032  390A 08          		.byte	$08		; palette
13033  390B 4C          		.byte	$4C		; y coord
13034  390C             		
13035  390C 00          		.byte	$00		; x coord
13036  390D 70          		.byte	$70		; sprite number
13037  390E 08          		.byte	$08		; palette
13038  390F 44          		.byte	$44		; y coord
13039  3910             		
13040  3910 00          		.byte	$00		; x coord
13041  3911 70          		.byte	$70		; sprite number
13042  3912 08          		.byte	$08		; palette
13043  3913 44          		.byte	$44		; y coord
13044  3914             		
13045  3914 00          		.byte	$00		; x coord
13046  3915 70          		.byte	$70		; sprite number
13047  3916 08          		.byte	$08		; palette
13048  3917 44          		.byte	$44		; y coord
13049  3918             		
13050  3918 00          		.byte	$00		; x coord
13051  3919 70          		.byte	$70		; sprite number
13052  391A 0A          		.byte	$0A		; palette
13053  391B 44          		.byte	$44		; y coord
13054  391C             ;------------------------------------------------------------------------------
13055  391C             
13056  391C             
13057  391C             
13058  391C             ;------------------------------------------------------------------------------
13059  391C             ; Vector data describing the bounce of the springs on the elevators stage
13060  391C             L_SPRING_VECTOR_DATA:	
13061  391C FD FD FD FE 		.byte	-3, -3, -3, -2, -2, -2, -2, -1, -1,  0, -1,  0 ; Rising
13061  3920 FE FE FE FF 
13061  3924 FF 00 FF 00 
13062  3928 00 01 00 01 		.byte	 0,  1,  0,  1,  1,  2,  2,  2,  2,  3,  3,  3 ; Falling
13062  392C 01 02 02 02 
13062  3930 02 03 03 03 
13063  3934 7F          		.byte	127 ; End of data
13064  3935             ;------------------------------------------------------------------------------
13065  3935             
13066  3935             
13067  3935             
13068  3935             ;------------------------------------------------------------------------------
13069  3935             l39c3:	
13070  3935 1E          		.byte	$1E
13071  3936 4E          		.byte	$4E
13072  3937 BB          		.byte	$BB
13073  3938 4C          		.byte	$4C
13074  3939 D8          		.byte	$D8
13075  393A 4E          		.byte	$4e
13076  393B 59                  .byte	$59
13077  393C 4E                  .byte	$4e
13078  393D 7F                  .byte	127 ; End of data
13079  393E             ;------------------------------------------------------------------------------
13080  393E             
13081  393E             
13082  393E             ;------------------------------------------------------------------------------
13083  393E BB          l39cc:  .byte   $bb
13084  393F 4D                  .byte   $4d
13085  3940 7F                  .byte   $7f
13086  3941             ;------------------------------------------------------------------------------
13087  3941             
13088  3941             
13089  3941             
13090  3941             ;------------------------------------------------------------------------------
13091  3941             ; Sprite data for Donkey Kong standing grinning with his right leg and left
13092  3941             ; arm raised.
13093  3941             L_DK_SPRITES_GRIN_L_STOMP: 	
13094  3941 47          		.byte	$47		; x coord
13095  3942 27          		.byte	$27		; sprite number ($27 - left leg)
13096  3943 08          		.byte	$08		; palette 
13097  3944 50          		.byte	$50		; y coord 
13098  3945             		
13099  3945 2D          		.byte	$2D		; x coord 
13100  3946 26          		.byte	$26		; sprite number ($26 - right leg raised)
13101  3947 08          		.byte	$08		; palette
13102  3948 50          		.byte	$50		; y coord
13103  3949             		
13104  3949 3B          		.byte	$3B		; x coord
13105  394A 25          		.byte	$25		; sprite number ($25 - torso)
13106  394B 08          		.byte	$08		; palette
13107  394C 50          		.byte	$50		; y coord
13108  394D             		
13109  394D 00          		.byte	$00 	; x coord
13110  394E 70          		.byte	$70 	; sprite number
13111  394F 08          		.byte	$08 	; palette
13112  3950 48          		.byte	$48		; y coord
13113  3951             		
13114  3951 3B          		.byte	$3B 	; x coord
13115  3952 24          		.byte	$24 	; sprite number ($24 - head - grinning)
13116  3953 07          		.byte	$07 	; palette
13117  3954 40          		.byte	$40 	; y coord
13118  3955             		
13119  3955 4B          		.byte	$4B 	; x coord
13120  3956 28          		.byte	$28 	; sprite number ($28 - left arm raised)
13121  3957 08          		.byte	$08 	; palette
13122  3958 40          		.byte	$40 	; y coord
13123  3959             		
13124  3959 00          		.byte	$00 	; x coord
13125  395A 70          		.byte	$70 	; sprite number
13126  395B 08          		.byte	$08 	; palette
13127  395C 48          		.byte	$48		; y coord
13128  395D             		
13129  395D 30          		.byte	$30 	; x coord
13130  395E 29          		.byte	$29 	; sprite number ($29 - right arm curled)
13131  395F 08          		.byte	$08 	; palette
13132  3960 44          		.byte	$44		; y coord
13133  3961             		
13134  3961 00          		.byte	$00 	; x coord
13135  3962 70          		.byte	$70 	; sprite number
13136  3963 08          		.byte	$08 	; palette
13137  3964 48          		.byte	$48		; y coord
13138  3965             		
13139  3965 00          		.byte	$00 	; x coord
13140  3966 70          		.byte	$70 	; sprite number
13141  3967 0A          		.byte	$0A 	; palette
13142  3968 48          		.byte	$48		; y coord
13143  3969             ;------------------------------------------------------------------------------
13144  3969             
13145  3969             
13146  3969             ;------------------------------------------------------------------------------
13147  3969             ; Sprite data for Donkey Kong standing grinning with his left leg and right
13148  3969             ; arm raised.
13149  3969             L_DK_SPRITES_GRIN_R_STOMP:	
13150  3969 49          		.byte	$49 	; x coord
13151  396A A6          		.byte	$A6 	; sprite number ($26 - left leg)
13152  396B 08          		.byte	$08 	; palette
13153  396C 50          		.byte	$50		; y coord
13154  396D             		
13155  396D 2F          		.byte	$2F 	; x coord
13156  396E A7          		.byte	$A7 	; sprite number	($27 - right leg raised)
13157  396F 08          		.byte	$08 	; palette
13158  3970 50          		.byte	$50		; y coord
13159  3971             		
13160  3971 3B          		.byte	$3B 	; x coord
13161  3972 25          		.byte	$25 	; sprite number ($25 - torso)
13162  3973 08          		.byte	$08 	; palette
13163  3974 50          		.byte	$50		; y coord
13164  3975             		
13165  3975 00          		.byte	$00 	; x coord
13166  3976 70          		.byte	$70 	; sprite number
13167  3977 08          		.byte	$08 	; palette
13168  3978 48          		.byte	$48		; y coord
13169  3979             		
13170  3979 3B          		.byte	$3B 	; x coord
13171  397A 24          		.byte	$24 	; sprite number ($24 - head grinning)
13172  397B 07          		.byte	$07 	; palette
13173  397C 40          		.byte	$40		; y coord
13174  397D             		
13175  397D 46          		.byte	$46 	; x coord
13176  397E A9          		.byte	$A9 	; sprite number ($29 - left arm curled)
13177  397F 08          		.byte	$08 	; palette
13178  3980 44          		.byte	$44		; y coord
13179  3981             		
13180  3981 00          		.byte	$00 	; x coord
13181  3982 70          		.byte	$70 	; sprite number
13182  3983 08          		.byte	$08 	; palette
13183  3984 48          		.byte	$48		; y coord
13184  3985             		
13185  3985 2B          		.byte	$2B 	; x coord
13186  3986 A8          		.byte	$A8 	; sprite number ($28 - right arm raised)
13187  3987 08          		.byte	$08 	; palette
13188  3988 40          		.byte	$40		; y coord
13189  3989             		
13190  3989 00          		.byte	$00 	; x coord
13191  398A 70          		.byte	$70 	; sprite number
13192  398B 08          		.byte	$08 	; palette
13193  398C 48          		.byte	$48		; y coord
13194  398D             		
13195  398D 00          		.byte	$00 	; x coord
13196  398E 70          		.byte	$70 	; sprite number
13197  398F 0A          		.byte	$0A 	; palette
13198  3990 48          		.byte	$48		; y coord
13199  3991             ;------------------------------------------------------------------------------
13200  3991             
13201  3991             
13202  3991             
13203  3991             ;------------------------------------------------------------------------------
13204  3991             ; Sprite data for Donkey Kong grinning and falling upside-down
13205  3991             L_DK_SPRITES_GRIN_UD:	
13206  3991 73          		.byte	$73 	; x coord
13207  3992 A7          		.byte	$A7 	; sprite number ($27 - leg)
13208  3993 88          		.byte	$88 	; palette
13209  3994 60          		.byte	$60		; y coord
13210  3995             		
13211  3995 8B          		.byte	$8B 	; x coord
13212  3996 27          		.byte	$27 	; sprite number ($27 - leg)
13213  3997 88          		.byte	$88 	; palette
13214  3998 60          		.byte	$60		; y coord
13215  3999             		
13216  3999 7F          		.byte	$7F 	; x coord
13217  399A 25          		.byte	$25 	; sprite number ($25 - torso)
13218  399B 88          		.byte	$88 	; palette
13219  399C 60          		.byte	$60		; y coord
13220  399D             		
13221  399D 00          		.byte	$00 	; x coord
13222  399E 70          		.byte	$70 	; sprite number
13223  399F 88          		.byte	$88 	; palette
13224  39A0 68          		.byte	$68		; y coord
13225  39A1             		
13226  39A1 7F          		.byte	$7F 	; x coord
13227  39A2 24          		.byte	$24 	; sprite number ($24 - head grinning)
13228  39A3 87          		.byte	$87 	; palette
13229  39A4 70          		.byte	$70		; y coord
13230  39A5             		
13231  39A5 74          		.byte	$74 	; x coord
13232  39A6 29          		.byte	$29 	; sprite number ($29 - arm curled)
13233  39A7 88          		.byte	$88 	; palette
13234  39A8 6C          		.byte	$6C		; y coord
13235  39A9             		
13236  39A9 00          		.byte	$00 	; x coord
13237  39AA 70          		.byte	$70 	; sprite number
13238  39AB 88          		.byte	$88 	; palette
13239  39AC 68          		.byte	$68		; y coord
13240  39AD             		
13241  39AD 8A          		.byte	$8A 	; x coord
13242  39AE A9          		.byte	$A9 	; sprite number ($29 - arm curled)
13243  39AF 88          		.byte	$88 	; palette
13244  39B0 6C          		.byte	$6C		; y coord
13245  39B1             		
13246  39B1 00          		.byte	$00 	; x coord
13247  39B2 70          		.byte	$70 	; sprite number
13248  39B3 88          		.byte	$88 	; palette
13249  39B4 68          		.byte	$68		; y coord
13250  39B5             		
13251  39B5 00          		.byte	$00 	; x coord
13252  39B6 70          		.byte	$70 	; sprite number
13253  39B7 8A          		.byte	$8A 	; palette
13254  39B8 68          		.byte	$68		; y coord
13255  39B9             ;------------------------------------------------------------------------------
13256  39B9             
13257  39B9             
13258  39B9             
13259  39B9             ;------------------------------------------------------------------------------
13260  39B9             ; Data describing how to draw the first fallen platform on the pies level when
13261  39B9             ; the stage has has been completed
13262  39B9             L_RIVETS_DATA_FALL1: 	
13263  39B9 05          		.byte	$05 	; Girders with circular holes
13264  39BA AF F0       		.word	$F0AF	; (21,30)
13265  39BC 50 F0       		.word	$F050	; (10,30)
13266  39BE AA          		.byte	$AA	; End of data
13267  39BF             ;------------------------------------------------------------------------------
13268  39BF             
13269  39BF             
13270  39BF             
13271  39BF             ;------------------------------------------------------------------------------
13272  39BF             ; Data describing how to draw the second fallen platform on the pies level when
13273  39BF             ; the stage has has been completed
13274  39BF             L_RIVETS_DATA_FALL2:	
13275  39BF 05          		.byte	$05 	; Girders with circular holes
13276  39C0 AF E8       		.word	$E8AF	; (21,29)
13277  39C2 50 E8       		.word	$E850	; (10,29)
13278  39C4 AA          		.byte	$AA	; End of data
13279  39C5             ;------------------------------------------------------------------------------
13280  39C5             
13281  39C5             
13282  39C5             
13283  39C5             ;------------------------------------------------------------------------------
13284  39C5             ; Data describing how to draw the third fallen platform on the pies level when
13285  39C5             ; the stage has has been completed
13286  39C5             L_RIVETS_DATA_FALL3:	
13287  39C5 05          		.byte	$05 	; Girders with circular holes
13288  39C6 AF E0       		.word	$E0AF	; (21,28)
13289  39C8 50 E0       		.word	$E050	; (10,28)
13290  39CA AA          		.byte	$AA	; End of data
13291  39CB             ;------------------------------------------------------------------------------
13292  39CB             
13293  39CB             				
13294  39CB             
13295  39CB             ;------------------------------------------------------------------------------
13296  39CB             ; Data describing how to draw the fourth fallen platform on the pies level when
13297  39CB             ; the stage has has been completed
13298  39CB             L_RIVETS_DATA_FALL4:	
13299  39CB 05          		.byte	$05 	; Girders with circular holes
13300  39CC AF D8       		.word	$D8AF	; (21,27)
13301  39CE 50 D8       		.word	$D850	; (10,27)
13302  39D0 AA          		.byte	$AA	; End of data
13303  39D1             ;------------------------------------------------------------------------------
13304  39D1             
13305  39D1             
13306  39D1             
13307  39D1             ;------------------------------------------------------------------------------
13308  39D1             ; Data describing how to draw the top fallen platform on the pies level when
13309  39D1             ; the stage has has been completed		
13310  39D1             L_RIVETS_DATA_FALL_TOP:	
13311  39D1 05          		.byte	$05 	; Girders with circular holes
13312  39D2 B7 58       		.word	$58B7	; (22,11)
13313  39D4 48 58       		.word	$5848	; (9,11)
13314  39D6 AA          		.byte	$AA	; End of data
13315  39D7             ;------------------------------------------------------------------------------
13316  39D7             
13317  39D7             
13318  39D7             ;------------------------------------------------------------------------------
13319  39D7             ; Table defining the stages and the order they will appear in each level
13320  39D7             ; Level 1
13321  39D7             L_STAGE_ORDER_TABLE: 	
13322  39D7 01 04       		.byte	1, 4				; Barrels, Rivets
13323  39D9             		
13324  39D9             ; Level 2	
13325  39D9 01 03 04    		.byte	1, 3, 4				; Barrels, Elevators, Rivets
13326  39DC             
13327  39DC             ; Level 3
13328  39DC 01 02 03 04 		.byte	1, 2, 3, 4			; Barrels, Mixer, Elevators, Rivets
13329  39E0             		
13330  39E0             ; Level 4
13331  39E0 01 02 01 03 		.byte	1, 2, 1, 3, 4		; Barrels, Mixer, Barrels, Elevators, Rivets
13331  39E4 04 
13332  39E5             
13333  39E5             ; Level 5+		
13334  39E5             L_STAGE_ORDER_TABLE_LAST: 	
13335  39E5 01 02 01 03 		.byte	1, 2, 1, 3, 1, 4	; Barrels, Mixer, Barrels, Elevators, Barrels, Rivets
13335  39E9 01 04 
13336  39EB             
13337  39EB 7F          		.byte	$7F		; End of data marker
13338  39EC             ;------------------------------------------------------------------------------
13339  39EC             
13340  39EC             
13341  39EC             
13342  39EC             ;------------------------------------------------------------------------------
13343  39EC             ; The fireballs in the game don't just move left and right, they
13344  39EC             ; bob up and down as they do it, so they look more like real fire
13345  39EC             ; as they travel.  The following table controls this behavior.
13346  39EC             L_FIREBALL_BOB_TABLE:	
13347  39EC FF          		.byte	-1        
13348  39ED 00          		.byte	 0        
13349  39EE FF          		.byte	-1        
13350  39EF FF          		.byte	-1        
13351  39F0 FE          		.byte	-2
13352  39F1 FE          		.byte	-2      
13353  39F2 FE          		.byte	-2
13354  39F3 FE          		.byte	-2
13355  39F4 FE          		.byte	-2
13356  39F5 FE          		.byte	-2
13357  39F6 FE          		.byte	-2
13358  39F7 FE          		.byte	-2      
13359  39F8 FE          		.byte	-2
13360  39F9 FE          		.byte	-2      
13361  39FA FE          		.byte	-2
13362  39FB FF          		.byte	-1      
13363  39FC FF          		.byte	-1        
13364  39FD 00          		.byte	 0   
13365  39FE             FIREBALL_BOB_TABLE_LENGTH = $ - L_FIREBALL_BOB_TABLE
13366  39FE             ;------------------------------------------------------------------------------
13367  39FE             
13368  39FE             
13369  39FE             ;------------------------------------------------------------------------------
13370  39FE             ; The following data contains the y coordinates for the fireballs as they first 
13371  39FE             ; jump out of the oil barrel on the barrels stage
13372  39FE             L_OIL_BARREL_JUMP_TABLE_BARRELS:	
13373  39FE E8          		.byte	232        
13374  39FF E5          		.byte	229        
13375  3A00 E3          		.byte	227        
13376  3A01 E2          		.byte	226
13377  3A02 E1          		.byte	225
13378  3A03 E0          		.byte	224    
13379  3A04 DF          		.byte	223        
13380  3A05 DE          		.byte	222
13381  3A06 DD          		.byte	221      
13382  3A07 DD          		.byte	221
13383  3A08 DC          		.byte	220
13384  3A09 DC          		.byte	220
13385  3A0A DC          		.byte	220  
13386  3A0B DC          		.byte	220
13387  3A0C DC          		.byte	220
13388  3A0D DC          		.byte	220    
13389  3A0E DD          		.byte	221
13390  3A0F DD          		.byte	221
13391  3A10 DE          		.byte	222
13392  3A11 DF          		.byte	223  
13393  3A12 E0          		.byte	224        
13394  3A13 E1          		.byte	225        
13395  3A14 E2          		.byte	226
13396  3A15 E3          		.byte	227
13397  3A16 E4          		.byte	228    
13398  3A17 E5          		.byte	229        
13399  3A18 E7          		.byte	231        
13400  3A19 E9          		.byte	233        
13401  3A1A EB          		.byte	235        
13402  3A1B ED          		.byte	237
13403  3A1C F0          		.byte	240     
13404  3A1D AA          		.byte	$aa							; End of data        
13405  3A1E             ;------------------------------------------------------------------------------
13406  3A1E             
13407  3A1E             
13408  3A1E             
13409  3A1E             ;------------------------------------------------------------------------------
13410  3A1E             ; The following data contains the y coordinates for the fireballs as they first 
13411  3A1E             ; jump out of the oil barrel on the barrels stage
13412  3A1E             L_OIL_BARREL_JUMP_TABLE_MIXER:	
13413  3A1E 80          		.byte	128        
13414  3A1F 7B          		.byte	123        
13415  3A20 78          		.byte	120        
13416  3A21 76          		.byte	118        
13417  3A22 74          		.byte	116        
13418  3A23 73          		.byte	115        
13419  3A24 72          		.byte	114       
13420  3A25 71          		.byte	113        
13421  3A26 70          		.byte	112        
13422  3A27 70          		.byte	112        
13423  3A28 6F          		.byte	111        
13424  3A29 6F          		.byte	111        
13425  3A2A 6F          		.byte	111        
13426  3A2B 70          		.byte	112        
13427  3A2C 70          		.byte	112        
13428  3A2D 71          		.byte	113        
13429  3A2E 72          		.byte	114        
13430  3A2F 73          		.byte	115        
13431  3A30 74          		.byte	116        
13432  3A31 75          		.byte	117        
13433  3A32 76          		.byte	118        
13434  3A33 77          		.byte	119        
13435  3A34 78          		.byte	120        
13436  3A35 AA          		.byte	$aa							; End of data        
13437  3A36             ;------------------------------------------------------------------------------
13438  3A36             
13439  3A36             
13440  3A36             
13441  3A36             ;------------------------------------------------------------------------------
13442  3A36             ; The spawning coordinates for fireballs appearing on the right side of the 
13443  3A36             ; screen on the rivets stage
13444  3A36             ; NOTE: x,y are reversed?
13445  3A36             L_L_RIVET_SPAWN_COORDS:	
13446  3A36 EE F0       		.word	TWO_BYTES(240,238)
13447  3A38 DB A0       		.word	TWO_BYTES(160,219) 
13448  3A3A E6 C8       		.word	TWO_BYTES(200,230)
13449  3A3C D6 78       		.word	TWO_BYTES(120,214)    
13450  3A3E EB F0       		.word	TWO_BYTES(240,235)      
13451  3A40 DB A0       		.word	TWO_BYTES(160,219)  
13452  3A42 E6 C8       		.word	TWO_BYTES(200,230)
13453  3A44 E6 C8       		.word	TWO_BYTES(200,230)  
13454  3A46             ;------------------------------------------------------------------------------
13455  3A46             
13456  3A46             
13457  3A46             
13458  3A46             ;------------------------------------------------------------------------------
13459  3A46             ; The spawning coordinates for fireballs appearing on the left side of the 
13460  3A46             ; screen on the rivets stage
13461  3A46             ; NOTE: x,y are reversed?
13462  3A46             L_R_RIVET_SPAWN_COORDS:	
13463  3A46 1B C8       		.word	TWO_BYTES(200,27)    
13464  3A48 23 A0       		.word	TWO_BYTES(160,35)     
13465  3A4A 2B 78       		.word	TWO_BYTES(120,43)      
13466  3A4C 12 F0       		.word	TWO_BYTES(240,18)      
13467  3A4E 1B C8       		.word	TWO_BYTES(200,27)     
13468  3A50 23 A0       		.word	TWO_BYTES(160,35)     
13469  3A52 12 F0       		.word	TWO_BYTES(240,18)    
13470  3A54 1B C8       		.word	TWO_BYTES(200,27)
13471  3A56             ;------------------------------------------------------------------------------
13472  3A56             
13473  3A56             
13474  3A56             ;------------------------------------------------------------------------------
13475  3A56             ; Stage data for the barrels stage
13476  3A56             L_BARRELS_STAGE_DATA:	
13477  3A56 02          		.byte	$02 	; tile type
13478  3A57 97 38       		.word	$3897 	; coord 1 (13,7)
13479  3A59 68 38       		.word	$3868 	; coord 2 (18,7)
13480  3A5B             		
13481  3A5B 02          		.byte	$02 	; tile type
13482  3A5C 9F 54       		.word	$549F 	; coord 1 (12,10)
13483  3A5E 10 54       		.word	$5410 	; coord 2 (29,10)
13484  3A60             		
13485  3A60 02          		.byte	$02 	; tile type
13486  3A61 DF 58       		.word	$58DF 	; coord 1 (4,11)
13487  3A63 A0 55       		.word	$55A0 	; coord 2 (11,10)
13488  3A65             		
13489  3A65 02          		.byte	$02 	; tile type
13490  3A66 EF 6D       		.word	$6DEF 	; coord 1 (2,13)
13491  3A68 20 79       		.word	$7920 	; coord 2 (27,15)
13492  3A6A             		
13493  3A6A 02          		.byte	$02 	; tile type
13494  3A6B DF 9A       		.word	$9ADF 	; coord 1 (4, 19)
13495  3A6D 10 8E       		.word	$8E10 	; coord 2 (29,17)
13496  3A6F             		
13497  3A6F 02          		.byte	$02 	; tile type
13498  3A70 EF AF       		.word	$AFEF 	; coord 1 (2,21)
13499  3A72 20 BB       		.word	$BB20 	; coord 2 (27,23)
13500  3A74             		
13501  3A74 02          		.byte	$02 	; tile type
13502  3A75 DF DC       		.word	$DCDF 	; coord 1 (4,27)
13503  3A77 10 D0       		.word	$D010 	; coord 2 (29,26)
13504  3A79             		
13505  3A79 02          		.byte	$02 	; tile type
13506  3A7A FF F0       		.word	$F0FF 	; coord 1 (0,30)
13507  3A7C 80 F7       		.word	$F780 	; coord 2 (15,30)
13508  3A7E             		
13509  3A7E 02          		.byte	$02 	; tile type
13510  3A7F 7F F8       		.word	$F87F 	; coord 1 (16,31)
13511  3A81 00 F8       		.word	$F800 	; coord 2 (31,31)
13512  3A83             		
13513  3A83 00          		.byte	$00 
13514  3A84 CB 57       		.word	$57CB 
13515  3A86 CB 6F       		.word	$6FCB 
13516  3A88             		
13517  3A88 00          		.byte	$00 
13518  3A89 CB 99       		.word	$99CB 
13519  3A8B CB B1       		.word	$B1CB 
13520  3A8D             		
13521  3A8D 00          		.byte	$00 
13522  3A8E CB DB       		.word	$DBCB 
13523  3A90 CB F3       		.word	$F3CB 
13524  3A92             		
13525  3A92 00          		.byte	$00 
13526  3A93 63 18       		.word	$1863 
13527  3A95 63 54       		.word	$5463 
13528  3A97             		
13529  3A97 01          		.byte	$01 
13530  3A98 63 D5       		.word	$D563 
13531  3A9A 63 F8       		.word	$F863 
13532  3A9C             		
13533  3A9C 00          		.byte	$00 
13534  3A9D 33 78       		.word	$7833 
13535  3A9F 33 90       		.word	$9033 
13536  3AA1             		
13537  3AA1 00          		.byte	$00 
13538  3AA2 33 BA       		.word	$BA33 
13539  3AA4 33 D2       		.word	$D233 
13540  3AA6             		
13541  3AA6 00          		.byte	$00 
13542  3AA7 53 18       		.word	$1853 
13543  3AA9 53 54       		.word	$5453 
13544  3AAB             		
13545  3AAB 01          		.byte	$01 
13546  3AAC 53 92       		.word	$9253 
13547  3AAE 53 B8       		.word	$B853 
13548  3AB0             		
13549  3AB0 00          		.byte	$00 
13550  3AB1 5B 76       		.word	$765B 
13551  3AB3 5B 92       		.word	$925B 
13552  3AB5             		
13553  3AB5 00          		.byte	$00 
13554  3AB6 73 B6       		.word	$B673 
13555  3AB8 73 D6       		.word	$D673 
13556  3ABA             		
13557  3ABA 00          		.byte	$00 
13558  3ABB 83 95       		.word	$9583 
13559  3ABD 83 B5       		.word	$B583 
13560  3ABF             		
13561  3ABF 00          		.byte	$00 
13562  3AC0 93 38       		.word	$3893 
13563  3AC2 93 54       		.word	$5493 
13564  3AC4             		
13565  3AC4 01          		.byte	$01 
13566  3AC5 BB 70       		.word	$70BB 
13567  3AC7 BB 98       		.word	$98BB 
13568  3AC9             		
13569  3AC9 01          		.byte	$01 
13570  3ACA 6B 54       		.word	$546B 
13571  3ACC 6B 75       		.word	$756B 
13572  3ACE             		
13573  3ACE AA          		.byte	$AA		; End of data
13574  3ACF             ;------------------------------------------------------------------------------
13575  3ACF             
13576  3ACF             
13577  3ACF             
13578  3ACF             ;------------------------------------------------------------------------------
13579  3ACF             ; Stage data for the mixer stage
13580  3ACF             L_MIXER_STAGE_DATA: 	
13581  3ACF 06          		.byte	$06 
13582  3AD0 8F 90       		.word	$908F 
13583  3AD2 70 90       		.word	$9070
13584  3AD4             		
13585  3AD4 06          		.byte	$06 
13586  3AD5 8F 98       		.word	$988F 
13587  3AD7 70 98       		.word	$9870
13588  3AD9             		
13589  3AD9 06          		.byte	$06 
13590  3ADA 8F A0       		.word	$A08F 
13591  3ADC 70 A0       		.word	$A070
13592  3ADE             		
13593  3ADE 00          		.byte	$00 
13594  3ADF 63 18       		.word	$1863 
13595  3AE1 63 58       		.word	$5863
13596  3AE3             		
13597  3AE3 00          		.byte	$00 
13598  3AE4 63 80       		.word	$8063 
13599  3AE6 63 A8       		.word	$A863
13600  3AE8             		
13601  3AE8 00          		.byte	$00 
13602  3AE9 63 D0       		.word	$D063 
13603  3AEB 63 F8       		.word	$F863
13604  3AED             		
13605  3AED 00          		.byte	$00 
13606  3AEE 53 18       		.word	$1853 
13607  3AF0 53 58       		.word	$5853
13608  3AF2             		
13609  3AF2 00          		.byte	$00 
13610  3AF3 53 A8       		.word	$A853 
13611  3AF5 53 D0       		.word	$D053
13612  3AF7             		
13613  3AF7 00          		.byte	$00 
13614  3AF8 9B 80       		.word	$809B 
13615  3AFA 9B A8       		.word	$A89B
13616  3AFC             		
13617  3AFC 00          		.byte	$00 
13618  3AFD 9B D0       		.word	$D09B 
13619  3AFF 9B F8       		.word	$F89B
13620  3B01             		
13621  3B01 01          		.byte	$01 
13622  3B02 23 58       		.word	$5823 
13623  3B04 23 80       		.word	$8023
13624  3B06             		
13625  3B06 01          		.byte	$01 
13626  3B07 DB 58       		.word	$58DB 
13627  3B09 DB 80       		.word	$80DB
13628  3B0B             		
13629  3B0B 00          		.byte	$00 
13630  3B0C 2B 80       		.word	$802B 
13631  3B0E 2B A8       		.word	$A82B
13632  3B10             		
13633  3B10 00          		.byte	$00 
13634  3B11 D3 80       		.word	$80D3 
13635  3B13 D3 A8       		.word	$A8D3
13636  3B15             		
13637  3B15 00          		.byte	$00 
13638  3B16 A3 A8       		.word	$A8A3 
13639  3B18 A3 D0       		.word	$D0A3
13640  3B1A             		
13641  3B1A 00          		.byte	$00 
13642  3B1B 2B D0       		.word	$D02B 
13643  3B1D 2B F8       		.word	$F82B
13644  3B1F             		
13645  3B1F 00          		.byte	$00 
13646  3B20 D3 D0       		.word	$D0D3 
13647  3B22 D3 F8       		.word	$F8D3
13648  3B24             		
13649  3B24 00          		.byte	$00 
13650  3B25 93 38       		.word	$3893 
13651  3B27 93 58       		.word	$5893
13652  3B29             		
13653  3B29 02          		.byte	$02 
13654  3B2A 97 38       		.word	$3897 
13655  3B2C 68 38       		.word	$3868
13656  3B2E             		
13657  3B2E 03          		.byte	$03 
13658  3B2F EF 58       		.word	$58EF 
13659  3B31 10 58       		.word	$5810
13660  3B33             		
13661  3B33 03          		.byte	$03 
13662  3B34 F7 80       		.word	$80F7 
13663  3B36 88 80       		.word	$8088
13664  3B38             		
13665  3B38 03          		.byte	$03 
13666  3B39 77 80       		.word	$8077 
13667  3B3B 08 80       		.word	$8008
13668  3B3D             		
13669  3B3D 02          		.byte	$02 
13670  3B3E A7 A8       		.word	$A8A7 
13671  3B40 50 A8       		.word	$A850
13672  3B42             		
13673  3B42 02          		.byte	$02 
13674  3B43 E7 A8       		.word	$A8E7 
13675  3B45 B8 A8       		.word	$A8B8
13676  3B47             		
13677  3B47 02          		.byte	$02 
13678  3B48 3F A8       		.word	$A83F 
13679  3B4A 18 A8       		.word	$A818
13680  3B4C             		
13681  3B4C 03          		.byte	$03 
13682  3B4D EF D0       		.word	$D0EF 
13683  3B4F 10 D0       		.word	$D010
13684  3B51             		
13685  3B51 02          		.byte	$02 
13686  3B52 EF F8       		.word	$F8EF 
13687  3B54 10 F8       		.word	$F810
13688  3B56             		
13689  3B56 AA          		.byte	$aa		; End of data
13690  3B57             ;------------------------------------------------------------------------------
13691  3B57             
13692  3B57             
13693  3B57             
13694  3B57             ;------------------------------------------------------------------------------
13695  3B57             ; Stage data for the elevators stage
13696  3B57             L_ELEVATORS_STAGE_DATA:
13697  3B57 00          		.byte	$00 
13698  3B58 63 18       		.word	$1863 
13699  3B5A 63 58       		.word	$5863
13700  3B5C             		
13701  3B5C 00          		.byte	$00 
13702  3B5D 63 88       		.word	$8863 
13703  3B5F 63 D0       		.word	$D063
13704  3B61             		
13705  3B61 00          		.byte	$00 
13706  3B62 53 18       		.word	$1853 
13707  3B64 53 58       		.word	$5853
13708  3B66             		
13709  3B66 00          		.byte	$00 
13710  3B67 53 88       		.word	$8853 
13711  3B69 53 D0       		.word	$D053
13712  3B6B             		
13713  3B6B 00          		.byte	$00 
13714  3B6C E3 68       		.word	$68E3 
13715  3B6E E3 90       		.word	$90E3
13716  3B70             		
13717  3B70 00          		.byte	$00 
13718  3B71 E3 B8       		.word	$B8E3 
13719  3B73 E3 D0       		.word	$D0E3
13720  3B75             		
13721  3B75 00          		.byte	$00 
13722  3B76 CB 90       		.word	$90CB 
13723  3B78 CB B0       		.word	$B0CB
13724  3B7A             		
13725  3B7A 00          		.byte	$00 
13726  3B7B B3 58       		.word	$58B3 
13727  3B7D B3 78       		.word	$78B3
13728  3B7F             		
13729  3B7F 00          		.byte	$00 
13730  3B80 9B 80       		.word	$809B 
13731  3B82 9B A0       		.word	$A09B
13732  3B84             		
13733  3B84 00          		.byte	$00 
13734  3B85 93 38       		.word	$3893 
13735  3B87 93 58       		.word	$5893
13736  3B89             		
13737  3B89 00          		.byte	$00 
13738  3B8A 23 88       		.word	$8823 
13739  3B8C 23 C0       		.word	$C023
13740  3B8E             		
13741  3B8E 00          		.byte	$00 
13742  3B8F 1B C0       		.word	$C01B 
13743  3B91 1B E8       		.word	$E81B
13744  3B93             		
13745  3B93 02          		.byte	$02 
13746  3B94 97 38       		.word	$3897 
13747  3B96 68 38       		.word	$3868
13748  3B98             		
13749  3B98 02          		.byte	$02 
13750  3B99 B7 58       		.word	$58B7 
13751  3B9B 10 58       		.word	$5810
13752  3B9D             		
13753  3B9D 02          		.byte	$02 
13754  3B9E EF 68       		.word	$68EF 
13755  3BA0 E0 68       		.word	$68E0
13756  3BA2             		
13757  3BA2 02          		.byte	$02 
13758  3BA3 D7 70       		.word	$70D7 
13759  3BA5 C8 70       		.word	$70C8
13760  3BA7             		
13761  3BA7 02          		.byte	$02 
13762  3BA8 BF 78       		.word	$78BF 
13763  3BAA B0 78       		.word	$78B0
13764  3BAC             		
13765  3BAC 02          		.byte	$02 
13766  3BAD A7 80       		.word	$80A7 
13767  3BAF 90 80       		.word	$8090
13768  3BB1             		
13769  3BB1 02          		.byte	$02 
13770  3BB2 67 88       		.word	$8867 
13771  3BB4 48 88       		.word	$8848
13772  3BB6             		
13773  3BB6 02          		.byte	$02 
13774  3BB7 27 88       		.word	$8827 
13775  3BB9 10 88       		.word	$8810
13776  3BBB             		
13777  3BBB 02          		.byte	$02 
13778  3BBC EF 90       		.word	$90EF 
13779  3BBE C8 90       		.word	$90C8
13780  3BC0             		
13781  3BC0 02          		.byte	$02 
13782  3BC1 A7 A0       		.word	$A0A7 
13783  3BC3 98 A0       		.word	$A098
13784  3BC5             		
13785  3BC5 02          		.byte	$02 
13786  3BC6 BF A8       		.word	$A8BF 
13787  3BC8 B0 A8       		.word	$A8B0
13788  3BCA             		
13789  3BCA 02          		.byte	$02 
13790  3BCB D7 B0       		.word	$B0D7 
13791  3BCD C8 B0       		.word	$B0C8
13792  3BCF             		
13793  3BCF 02          		.byte	$02 
13794  3BD0 EF B8       		.word	$B8EF 
13795  3BD2 E0 B8       		.word	$B8E0
13796  3BD4             		
13797  3BD4 02          		.byte	$02 
13798  3BD5 27 C0       		.word	$C027 
13799  3BD7 10 C0       		.word	$C010
13800  3BD9             		
13801  3BD9 02          		.byte	$02 
13802  3BDA EF D0       		.word	$D0EF 
13803  3BDC D8 D0       		.word	$D0D8
13804  3BDE             		
13805  3BDE 02          		.byte	$02 
13806  3BDF 67 D0       		.word	$D067 
13807  3BE1 50 D0       		.word	$D050
13808  3BE3             		
13809  3BE3 02          		.byte	$02 
13810  3BE4 CF D8       		.word	$D8CF 
13811  3BE6 C0 D8       		.word	$D8C0
13812  3BE8             		
13813  3BE8 02          		.byte	$02 
13814  3BE9 B7 E0       		.word	$E0B7 
13815  3BEB A8 E0       		.word	$E0A8
13816  3BED             		
13817  3BED 02          		.byte	$02 
13818  3BEE 9F E8       		.word	$E89F 
13819  3BF0 88 E8       		.word	$E888
13820  3BF2             		
13821  3BF2 02          		.byte	$02 
13822  3BF3 27 E8       		.word	$E827 
13823  3BF5 10 E8       		.word	$E810
13824  3BF7             		
13825  3BF7 02          		.byte	$02 
13826  3BF8 EF F8       		.word	$F8EF 
13827  3BFA 10 F8       		.word	$F810
13828  3BFC             		
13829  3BFC AA          		.byte	$AA		; End of stage data
13830  3BFD             ;------------------------------------------------------------------------------
13831  3BFD             
13832  3BFD             
13833  3BFD             
13834  3BFD             ;------------------------------------------------------------------------------
13835  3BFD             ; Stage data for the rivets stage
13836  3BFD             L_RIVETS_STAGE_DATA:
13837  3BFD 00          		.byte	$00 
13838  3BFE 7B 80       		.word	$807B 
13839  3C00 7B A8       		.word	$A87B
13840  3C02             		
13841  3C02 00          		.byte	$00 
13842  3C03 7B D0       		.word	$D07B 
13843  3C05 7B F8       		.word	$F87B
13844  3C07             		
13845  3C07 00          		.byte	$00 
13846  3C08 33 58       		.word	$5833 
13847  3C0A 33 80       		.word	$8033
13848  3C0C             		
13849  3C0C 00          		.byte	$00 
13850  3C0D 53 58       		.word	$5853 
13851  3C0F 53 80       		.word	$8053
13852  3C11             		
13853  3C11 00          		.byte	$00 
13854  3C12 AB 58       		.word	$58AB 
13855  3C14 AB 80       		.word	$80AB
13856  3C16             		
13857  3C16 00          		.byte	$00 
13858  3C17 CB 58       		.word	$58CB 
13859  3C19 CB 80       		.word	$80CB
13860  3C1B             		
13861  3C1B 00          		.byte	$00 
13862  3C1C 2B 80       		.word	$802B 
13863  3C1E 2B A8       		.word	$A82B
13864  3C20             		
13865  3C20 00          		.byte	$00 
13866  3C21 D3 80       		.word	$80D3 
13867  3C23 D3 A8       		.word	$A8D3
13868  3C25             		
13869  3C25 00          		.byte	$00 
13870  3C26 23 A8       		.word	$A823 
13871  3C28 23 D0       		.word	$D023
13872  3C2A             		
13873  3C2A 00          		.byte	$00 
13874  3C2B 5B A8       		.word	$A85B 
13875  3C2D 5B D0       		.word	$D05B
13876  3C2F             		
13877  3C2F 00          		.byte	$00 
13878  3C30 A3 A8       		.word	$A8A3 
13879  3C32 A3 D0       		.word	$D0A3
13880  3C34             		
13881  3C34 00          		.byte	$00 
13882  3C35 DB A8       		.word	$A8DB 
13883  3C37 DB D0       		.word	$D0DB
13884  3C39             		
13885  3C39 00          		.byte	$00 
13886  3C3A 1B D0       		.word	$D01B 
13887  3C3C 1B F8       		.word	$F81B
13888  3C3E             		
13889  3C3E 00          		.byte	$00 
13890  3C3F E3 D0       		.word	$D0E3 
13891  3C41 E3 F8       		.word	$F8E3
13892  3C43             		
13893  3C43 05          		.byte	$05 
13894  3C44 B7 30       		.word	$30B7 
13895  3C46 48 30       		.word	$3048
13896  3C48             		
13897  3C48 05          		.byte	$05 
13898  3C49 CF 58       		.word	$58CF 
13899  3C4B 30 58       		.word	$5830
13900  3C4D             		
13901  3C4D 05          		.byte	$05 
13902  3C4E D7 80       		.word	$80D7 
13903  3C50 28 80       		.word	$8028
13904  3C52             		
13905  3C52 05          		.byte	$05 
13906  3C53 DF A8       		.word	$A8DF 
13907  3C55 20 A8       		.word	$A820
13908  3C57             		
13909  3C57 05          		.byte	$05 
13910  3C58 E7 D0       		.word	$D0E7 
13911  3C5A 18 D0       		.word	$D018
13912  3C5C             		
13913  3C5C 05          		.byte	$05 
13914  3C5D EF F8       		.word	$F8EF 
13915  3C5F 10 F8       		.word	$F810
13916  3C61             		
13917  3C61 AA          		.byte	$AA		; End of stage data
13918  3C62             ;------------------------------------------------------------------------------
13919  3C62             
13920  3C62             
13921  3C62             
13922  3C62             ;------------------------------------------------------------------------------
13923  3C62             ; The following strings are used to display the height of the next stage on
13924  3C62             ; the intermission screen
13925  3C62             ; " 25m"
13926  3C62             L_HEIGHT_STRING_TABLE:  
13927  3C62 10 82 85 8B 		.byte	$10, $82, $85, $8B
13928  3C66             
13929  3C66              ; " 50m"
13930  3C66 10 85 80 8B l3cf4:  .byte	$10, $85, $80, $8B
13931  3C6A             
13932  3C6A              ; " 75m"
13933  3C6A 10 87 85 8B l3cf8:  .byte	$10, $87, $85, $8B
13934  3C6E             
13935  3C6E              ; "100m"
13936  3C6E 81 80 80 8B l3cfc:  .byte	$81, $80, $80, $8B
13937  3C72             		
13938  3C72              ; "125m"
13939  3C72 81 82 85 8B l3d00:  .byte	$81, $82, $85, $8B
13940  3C76             		
13941  3C76              ; "150m"
13942  3C76 81 85 80 8B l3d04:  .byte	$81, $85, $80, $8B
13943  3C7A             ;------------------------------------------------------------------------------
13944  3C7A             
13945  3C7A             
13946  3C7A             
13947  3C7A             ;------------------------------------------------------------------------------
13948  3C7A             ; The following data describes how to draw the "DONKEY KONG" title in large
13949  3C7A             ; letters on the title screen.
13950  3C7A             ;
13951  3C7A             ; Each entry consists of a one-byte number of tiles to draw and a two-byte
13952  3C7A             ; screen coordinate.  The tiles are drawn starting at the coordinate and 
13953  3C7A             ; moving down for the indicated number of tiles.
13954  3C7A             ; 
13955  3C7A             L_LARGE_DK_LETTER_DATA:	
13956  3C7A             		; 'D'
13957  3C7A 05          		.byte	5
13958  3C7B 88 77       		.word	TILE_COORD(28,8)
13959  3C7D 01          		.byte	1
13960  3C7E 68 77       		.word	TILE_COORD(27,8)
13961  3C80 01          		.byte	1
13962  3C81 6C 77       		.word	TILE_COORD(27,12)
13963  3C83 03          		.byte	3
13964  3C84 49 77       		.word	TILE_COORD(26,9)
13965  3C86             		
13966  3C86             		; 'O'
13967  3C86 05          		.byte	5 
13968  3C87 08 77       		.word	TILE_COORD(24,8) 
13969  3C89 01          		.byte	1 
13970  3C8A E8 76       		.word	TILE_COORD(23,8) 
13971  3C8C 01          		.byte	1 
13972  3C8D EC 76       		.word	TILE_COORD(23,12) 
13973  3C8F 05          		.byte	5 
13974  3C90 C8 76       		.word	TILE_COORD(22,8) 
13975  3C92             
13976  3C92             		; 'N'
13977  3C92 05          		.byte	5 
13978  3C93 88 76       		.word	TILE_COORD(20,8) 
13979  3C95 02          		.byte	2 
13980  3C96 69 76       		.word	TILE_COORD(19,9) 
13981  3C98 02          		.byte	2 
13982  3C99 4A 76       		.word	TILE_COORD(18,10) 
13983  3C9B 05          		.byte	5 
13984  3C9C 28 76       		.word	TILE_COORD(17,8) 
13985  3C9E             
13986  3C9E             		; 'K'
13987  3C9E 05          		.byte	5 
13988  3C9F E8 75       		.word	TILE_COORD(15,8) 
13989  3CA1 01          		.byte	1 
13990  3CA2 CA 75       		.word	TILE_COORD(14,10) 
13991  3CA4 03          		.byte	3 
13992  3CA5 A9 75       		.word	TILE_COORD(13,9) 
13993  3CA7 01          		.byte	1 
13994  3CA8 88 75       		.word	TILE_COORD(12,8) 
13995  3CAA 01          		.byte	1 
13996  3CAB 8C 75       		.word	TILE_COORD(12,12) 
13997  3CAD             
13998  3CAD             		; 'E'
13999  3CAD 05          		.byte	5 
14000  3CAE 48 75       		.word	TILE_COORD(10,8) 
14001  3CB0 01          		.byte	1 
14002  3CB1 28 75       		.word	TILE_COORD(9,8)
14003  3CB3 01          		.byte	1 
14004  3CB4 2A 75       		.word	TILE_COORD(9,10)
14005  3CB6 01          		.byte	1 
14006  3CB7 2C 75       		.word	TILE_COORD(9,12)
14007  3CB9 01          		.byte	1 
14008  3CBA 08 75       		.word	TILE_COORD(8,8)
14009  3CBC 01          		.byte	1 
14010  3CBD 0A 75       		.word	TILE_COORD(8,10)
14011  3CBF 01          		.byte	1 
14012  3CC0 0C 75       		.word	TILE_COORD(8,12)
14013  3CC2             
14014  3CC2             		; 'Y'
14015  3CC2 03          		.byte	3 
14016  3CC3 C8 74       		.word	TILE_COORD(6,8)
14017  3CC5 03          		.byte	3 
14018  3CC6 AA 74       		.word	TILE_COORD(5,10)
14019  3CC8 03          		.byte	3 
14020  3CC9 88 74       		.word	TILE_COORD(4,8)
14021  3CCB             
14022  3CCB             		; 'K'
14023  3CCB 05          		.byte	5 
14024  3CCC 2F 77       		.word	TILE_COORD(25,15)
14025  3CCE 05          		.byte	5 
14026  3CCF 0F 77       		.word	TILE_COORD(24,15)
14027  3CD1 02          		.byte	2 
14028  3CD2 F0 76       		.word	TILE_COORD(23,16)
14029  3CD4 02          		.byte	2 
14030  3CD5 CF 76       		.word	TILE_COORD(22,15)
14031  3CD7 02          		.byte	2 
14032  3CD8 D2 76       		.word	TILE_COORD(22,18)
14033  3CDA             
14034  3CDA             		; 'O'
14035  3CDA 05          		.byte	5 
14036  3CDB 8F 76       		.word	TILE_COORD(20,15)
14037  3CDD 05          		.byte	5 
14038  3CDE 6F 76       		.word	TILE_COORD(19,15)
14039  3CE0 01          		.byte	1 
14040  3CE1 4F 76       		.word	TILE_COORD(18,15)
14041  3CE3 01          		.byte	1 
14042  3CE4 53 76       		.word	TILE_COORD(18,19)
14043  3CE6 05          		.byte	5 
14044  3CE7 2F 76       		.word	TILE_COORD(17,15)
14045  3CE9             
14046  3CE9             		; 'N'  
14047  3CE9 05          		.byte	5 
14048  3CEA EF 75       		.word	TILE_COORD(15,15)
14049  3CEC 02          		.byte	2 
14050  3CED D0 75       		.word	TILE_COORD(14,16)
14051  3CEF 02          		.byte	2 
14052  3CF0 B1 75       		.word	TILE_COORD(13,17)
14053  3CF2 05          		.byte	5 
14054  3CF3 8F 75       		.word	TILE_COORD(12,15)
14055  3CF5             
14056  3CF5             		; 'G'
14057  3CF5 03          		.byte	3 
14058  3CF6 50 75       		.word	TILE_COORD(10,16)
14059  3CF8 05          		.byte	5 
14060  3CF9 2F 75       		.word	TILE_COORD(9,15)
14061  3CFB 01          		.byte	1 
14062  3CFC 0F 75       		.word	TILE_COORD(8,15)
14063  3CFE 01          		.byte	1 
14064  3CFF 13 75       		.word	TILE_COORD(8,19)
14065  3D01 01          		.byte	1 
14066  3D02 EF 74       		.word	TILE_COORD(7,15)
14067  3D04 01          		.byte	1 
14068  3D05 F1 74       		.word	TILE_COORD(7,17)
14069  3D07 01          		.byte	1 
14070  3D08 F3 74       		.word	TILE_COORD(7,19)
14071  3D0A 02          		.byte	2 
14072  3D0B D1 74       		.word	TILE_COORD(6,17)
14073  3D0D             
14074  3D0D 00          		.byte	$00		; End of data
14075  3D0E             ;------------------------------------------------------------------------------
14076  3D0E              
14077  3D0E             
14078  3D0E             
14079  3D0E             ;------------------------------------------------------------------------------
14080  3D0E             ; The following data is used to initialize the value of game variables ($6280 -
14081  3D0E             ; $62bf) before every stage
14082  3D0E             L_INITIAL_STAGE_DATA_TABLE:	
14083  3D0E 00          		.byte	0	; L_RETRACT_LADDER_STATE = up
14084  3D0F 00          		.byte	0	; L_RETRACT_LADDER_DELAY (minimum)
14085  3D10 23          		.byte	35	; L_RETRACT_LADDER_X
14086  3D11 68          		.byte	104	; L_RETRACT_LADDER_Y (all the way up)
14087  3D12 01          		.byte	1	; L_RETRACT_LADDER_MOVE_DELAY
14088  3D13 11          		.byte	17	; $6285
14089  3D14 00          		.byte	0	; $6286
14090  3D15 00          		.byte	0	; $6287
14091  3D16 00          		.byte	0	; R_RETRACT_LADDER_STATE = up
14092  3D17 10          		.byte	16	; R_RETRACT_LADDER_DELAY
14093  3D18 DB          		.byte	219	; R_RETRACT_LADDER_X
14094  3D19 68          		.byte	104	; R_RETRACT_LADDER_Y (all the way up)
14095  3D1A 01          		.byte	1	; R_RETRACT_LADDER_MOVE_DELAY
14096  3D1B 40          		.byte	64	; $628D
14097  3D1C 00          		.byte	0	; $628E
14098  3D1D 00          		.byte	0	; $628F
14099  3D1E 08          		.byte	8	; REMAINING_RIVETS
14100  3D1F 01          		.byte	1	; $6291
14101  3D20 01          		.byte	1	; $6292
14102  3D21 01          		.byte	1	; $6293
14103  3D22 01          		.byte	1	; $6294
14104  3D23 01          		.byte	1	; $6295
14105  3D24 01          		.byte	1	; $6296
14106  3D25 01          		.byte	1	; $6297
14107  3D26 01          		.byte	1	; $6298
14108  3D27 01          		.byte	1	; $6299
14109  3D28 00          		.byte	0	; $629A
14110  3D29 00          		.byte	0	; $629B
14111  3D2A 00          		.byte	0	; $629C
14112  3D2B 00          		.byte	0	; $629D
14113  3D2C 00          		.byte	0	; $629E
14114  3D2D 00          		.byte	0	; $629F
14115  3D2E 80          		.byte	128	; TOP_MASTER_REVERSE_TIMER
14116  3D2F 01          		.byte	1	; TOP_MASTER_CONVEYER_DIR (moving right)
14117  3D30 C0          		.byte	192	; MID_MASTER_REVERSE_TIMER
14118  3D31 FF          		.byte	-1	; RIGHT_MASTER_CONVEYER_DIR (moving left)
14119  3D32 01          		.byte	1	; LEFT_MASTER_CONVEYER_DIR
14120  3D33 FF          		.byte	255	; BOT_MASTER_REVERSE_TIMER
14121  3D34 FF          		.byte	-1	; BOT_MASTER_CONVEYER_DIR (moving left)
14122  3D35 34          		.byte	52	; ELEVATOR_SPAWN_TIMER
14123  3D36 35 39       		.word	l39c3	; $62A8
14124  3D38 00 67       		.word	BARREL_STRUCTS	; $62AA
14125  3D3A 80 69       		.word	$6980	; $62AC
14126  3D3C 1A          		.byte	26	; $62AE
14127  3D3D 01          		.byte	1 	; DK_CLIMBING_COUNTER
14128  3D3E 00          		.byte	0 	; INTERNAL_TIMER
14129  3D3F 00          		.byte	0 	; $62B1
14130  3D40 00          		.byte	0 	; $62B2
14131  3D41 00          		.byte	0 	; $62B3
14132  3D42 00          		.byte	0	; $62B4
14133  3D43 00          		.byte	0	; $62B5
14134  3D44 00          		.byte	0	; $62B6
14135  3D45 00          		.byte	0 	; $62B7
14136  3D46 04          		.byte	4 	; BARREL_FIRE_FREEZE
14137  3D47 00          		.byte	0 	; BARREL_FIRE_STATE
14138  3D48 10          		.byte	16 	; BARREL_FIRE_FLARE_UP_TIME
14139  3D49 00          		.byte	0 	; $62BB
14140  3D4A 00          		.byte	0 	; $62BC
14141  3D4B 00          		.byte	0 	; $62BD
14142  3D4C 00          		.byte	0 	; $62BE
14143  3D4D 00          		.byte	0 	; $62BF
14144  3D4E             ;------------------------------------------------------------------------------
14145  3D4E              
14146  3D4E             
14147  3D4E             
14148  3D4E             ;------------------------------------------------------------------------------
14149  3D4E             ; Sprite data for the four upright barrels standing to Donkey Kong's left on the
14150  3D4E             ; barrels stage.
14151  3D4E             L_STANDING_BARRELS_SPRITE_DATA:	
14152  3D4E 1E          		.byte	30 		; x coord
14153  3D4F 18          		.byte	$18		; sprite number ($18 - upright barrel)
14154  3D50 0B          		.byte	$0B 	; palette
14155  3D51 4B          		.byte	75 		; y coord
14156  3D52             
14157  3D52 14          		.byte	20 		; x coord
14158  3D53 18          		.byte	$18		; sprite number ($18 - upright barrel)
14159  3D54 0B          		.byte	$0B 	; palette
14160  3D55 4B          		.byte	75 		; y coord
14161  3D56             
14162  3D56 1E          		.byte	30 		; x coord
14163  3D57 18          		.byte	$18		; sprite number ($18 - upright barrel)
14164  3D58 0B          		.byte	$0B 	; palette
14165  3D59 3B          		.byte	59 		; y coord
14166  3D5A             
14167  3D5A 14          		.byte	20 		; x coord
14168  3D5B 18          		.byte	$18		; sprite number ($18 - upright barrel)
14169  3D5C 0B          		.byte	$0B 	; palette
14170  3D5D 3B          		.byte	59 		; y coord
14171  3D5E             ;------------------------------------------------------------------------------
14172  3D5E             
14173  3D5E             
14174  3D5E             
14175  3D5E             ;------------------------------------------------------------------------------
14176  3D5E             ; Initial sprite data for fire balls
14177  3D5E             L_FIREBALL_SPRITE_DATA:	
14178  3D5E 3D          		.byte	$3D	; Fire ball sprite
14179  3D5F 01          		.byte	$01	; Palette
14180  3D60 03          		.byte	3
14181  3D61 02          		.byte	2
14182  3D62             ;------------------------------------------------------------------------------
14183  3D62             
14184  3D62             
14185  3D62             
14186  3D62             ;------------------------------------------------------------------------------
14187  3D62             ; Initial sprite data for firefoxes
14188  3D62             L_FIREFOX_SPRITE_DATA:	
14189  3D62 4D          		.byte	$4D	; Firefox sprite
14190  3D63 01          		.byte	$01	; Palette
14191  3D64 04          		.byte	4
14192  3D65 01          		.byte	1
14193  3D66             ;------------------------------------------------------------------------------
14194  3D66             
14195  3D66             
14196  3D66             
14197  3D66             ;------------------------------------------------------------------------------
14198  3D66             ; Initial sprite data for the oil barrel fire on the barrels stage
14199  3D66             ; This is before the fire is lit
14200  3D66             L_BARRELS_FIRE_SPRITE_DATA:	
14201  3D66 27          		.byte	39	; X coordinate
14202  3D67 70          		.byte	$70	; Blank sprite
14203  3D68 01          		.byte	$01	; Palette
14204  3D69 E0          		.byte	224	; Y coordinate
14205  3D6A 00          		.byte	0
14206  3D6B 00          		.byte	0
14207  3D6C             ;------------------------------------------------------------------------------
14208  3D6C             
14209  3D6C             
14210  3D6C             
14211  3D6C             ;------------------------------------------------------------------------------
14212  3D6C             ; Initial sprite data for the oil barrel fire on the mixer stage
14213  3D6C             ; The fire is initially burning
14214  3D6C             L_MIXER_FIRE_SPRITE_DATA:	
14215  3D6C 7F          		.byte	127	; X coordinate
14216  3D6D 40          		.byte	$40	; Burning fire sprite
14217  3D6E 01          		.byte	$01	; Palette
14218  3D6F 78          		.byte	120	; Y coordinate
14219  3D70 02          		.byte	2
14220  3D71 00          		.byte	0
14221  3D72             ;------------------------------------------------------------------------------
14222  3D72             
14223  3D72             
14224  3D72             
14225  3D72             ;------------------------------------------------------------------------------
14226  3D72             ; Sprite data for the oil barrel on the barrels stage
14227  3D72             L_OIL_BARREL_SPRITE_DATA_1: 
14228  3D72 27          		.byte	39		; x coord 
14229  3D73 49          		.byte	$49		; sprite number 
14230  3D74 0C          		.byte	$0C		; palette
14231  3D75 F0          		.byte	240		; y coord
14232  3D76             ;------------------------------------------------------------------------------
14233  3D76             
14234  3D76             
14235  3D76             
14236  3D76             ;------------------------------------------------------------------------------
14237  3D76             ; Sprite data for the oil can on the mixer stage
14238  3D76             L_OIL_BARREL_SPRITE_DATA_2: 	
14239  3D76 7F          		.byte	127		; x coord 
14240  3D77 49          		.byte	$49		; sprite number 
14241  3D78 0C          		.byte	$0C		; palette
14242  3D79 88          		.byte	136		; y coord
14243  3D7A             ;------------------------------------------------------------------------------
14244  3D7A             
14245  3D7A             
14246  3D7A             ;------------------------------------------------------------------------------
14247  3D7A             ; Sprite data for the hammers that Mario can grab
14248  3D7A             L_HAMMER_SPRITE_DATA:	
14249  3D7A 1E          		.byte	$1E	; Upright Hammer
14250  3D7B 07          		.byte	$07	; Palette
14251  3D7C 03          		.byte	3
14252  3D7D 09          		.byte	9
14253  3D7E             ;------------------------------------------------------------------------------
14254  3D7E             
14255  3D7E             
14256  3D7E             
14257  3D7E             ;------------------------------------------------------------------------------
14258  3D7E             ; Initial coordinates for the hammers on the barrels stage
14259  3D7E             L_BARRELS_HAMMER_COORDS:	
14260  3D7E 24          		.byte	36	; X coordinate
14261  3D7F 64          		.byte	100	; Y coordinate
14262  3D80             		
14263  3D80 BB          		.byte	187	; X coordinate
14264  3D81 C0          		.byte	192	; Y coordinate
14265  3D82             ;------------------------------------------------------------------------------
14266  3D82             
14267  3D82             
14268  3D82             
14269  3D82             ;------------------------------------------------------------------------------
14270  3D82             ; Initial coordinates for the hammers on the mixer stage
14271  3D82             L_MIXER_HAMMER_COORDS:	
14272  3D82 23          		.byte	35	; X coordinate
14273  3D83 8D          		.byte	141	; Y coordinate
14274  3D84             		
14275  3D84 7B          		.byte	123	; X coordinate
14276  3D85 B4          		.byte	180	; Y coordinate
14277  3D86             ;------------------------------------------------------------------------------
14278  3D86             
14279  3D86             
14280  3D86             
14281  3D86             ;------------------------------------------------------------------------------
14282  3D86             ; Initial coordinates for the hammers on the rivets stage
14283  3D86             L_RIVETS_HAMMER_COORDS:	
14284  3D86 1B          		.byte	27	; X coordinate
14285  3D87 8C          		.byte	140	; Y coordinate
14286  3D88             		
14287  3D88 7C          		.byte	124	; X coordinate
14288  3D89 64          		.byte	100	; Y coordinate
14289  3D8A             ;------------------------------------------------------------------------------
14290  3D8A             
14291  3D8A             
14292  3D8A             
14293  3D8A             ;------------------------------------------------------------------------------
14294  3D8A             ; Sprite data for pies on the mixer stage
14295  3D8A             L_PIE_SPRITE_DATA:	
14296  3D8A 4B          		.byte	$4B	; Pie sprite
14297  3D8B 0E          		.byte	$0E	; Palette
14298  3D8C 04          		.byte	4
14299  3D8D 02          		.byte	2
14300  3D8E             ;------------------------------------------------------------------------------
14301  3D8E             
14302  3D8E             
14303  3D8E             
14304  3D8E             ;------------------------------------------------------------------------------
14305  3D8E             ; Sprite data for the retractable ladders on the mixer level
14306  3D8E             L_RETRACT_LADDER_SPRITE_DATA:	
14307  3D8E 23          		.byte	35		; x coord 
14308  3D8F 46          		.byte	$46 	; sprite number
14309  3D90 03          		.byte	$03 	; palette
14310  3D91 68          		.byte	104		; y coord
14311  3D92             		
14312  3D92 DB          		.byte	219		; x coord 
14313  3D93 46          		.byte	$46 	; sprite number
14314  3D94 03          		.byte	$03 	; palette
14315  3D95 68          		.byte	104		; y coord
14316  3D96             ;------------------------------------------------------------------------------
14317  3D96             
14318  3D96             
14319  3D96             
14320  3D96             ;------------------------------------------------------------------------------
14321  3D96             ; Sprite data for the conveyer motors on the mixer level
14322  3D96             L_MIXER_MOTOR_SPRITE_DATA:	
14323  3D96             		; CONV_MOTOR_SPRITE_TL (Top left)
14324  3D96 17          		.byte	23		; x coord 
14325  3D97 50          		.byte	$50 	; sprite number
14326  3D98 00          		.byte	$00 	; palette
14327  3D99 5C          		.byte	92		; y coord
14328  3D9A             		
14329  3D9A             		; CONV_MOTOR_SPRITE_TR (Top right)
14330  3D9A E7          		.byte	231		; x coord 
14331  3D9B D0          		.byte	$D0 	; sprite number ($50 - horizontally reversed)
14332  3D9C 00          		.byte	$00 	; palette
14333  3D9D 5C          		.byte	92		; y coord
14334  3D9E             		
14335  3D9E             		; CONV_MOTOR_SPRITE_MR (Middle right)
14336  3D9E 8C          		.byte	140		; x coord 
14337  3D9F 50          		.byte	$50 	; sprite number
14338  3DA0 00          		.byte	$00 	; palette
14339  3DA1 84          		.byte	132		; y coord
14340  3DA2             		
14341  3DA2             		; CONV_MOTOR_SPRITE_ML (Middle left)
14342  3DA2 73          		.byte	115		; x coord 
14343  3DA3 D0          		.byte	$D0 	; sprite number ($50 - horizontally reversed)
14344  3DA4 00          		.byte	$00 	; palette
14345  3DA5 84          		.byte	132		; y coord
14346  3DA6             		
14347  3DA6             		; CONV_MOTOR_SPRITE_BL (Bottom left)
14348  3DA6 17          		.byte	23		; x coord 
14349  3DA7 50          		.byte	$50 	; sprite number
14350  3DA8 00          		.byte	$00 	; palette
14351  3DA9 D4          		.byte	212		; y coord
14352  3DAA             		
14353  3DAA             		; CONV_MOTOR_SPRITE_BR (Bottom right)
14354  3DAA E7          		.byte	231		; x coord 
14355  3DAB D0          		.byte	$D0 	; sprite number ($50 - horizontally reversed)
14356  3DAC 00          		.byte	$00 	; palette
14357  3DAD D4          		.byte	212		; y coord
14358  3DAE             ;------------------------------------------------------------------------------
14359  3DAE             
14360  3DAE             
14361  3DAE             
14362  3DAE             ;------------------------------------------------------------------------------
14363  3DAE             ; Sprite data for bonus prizes on the mixer stage
14364  3DAE             L_MIXER_PRIZE_SPRITE_DATA:	
14365  3DAE 53          		.byte	83		; x coord 
14366  3DAF 73          		.byte	$73 	; sprite number (Pauline's hat)
14367  3DB0 0A          		.byte	$0A 	; palette
14368  3DB1             
14369  3DB1 A0          		.byte	160		; y coord
14370  3DB2             		
14371  3DB2 8B          		.byte	139		; x coord 
14372  3DB3 74          		.byte	$74 	; sprite number	(Pauline's purse)
14373  3DB4 0A          		.byte	$0A 	; palette
14374  3DB5 F0          		.byte	240		; y coord
14375  3DB6             		
14376  3DB6 DB          		.byte	219		; x coord 
14377  3DB7 75          		.byte	$75 	; sprite number (Pauline's umbrella)
14378  3DB8 0A          		.byte	$0A 	; palette
14379  3DB9 A0          		.byte	160		; y coord
14380  3DBA             ;------------------------------------------------------------------------------
14381  3DBA             
14382  3DBA             
14383  3DBA             
14384  3DBA             ;------------------------------------------------------------------------------
14385  3DBA             ; Sprite data for bonus prizes on the elevators stage
14386  3DBA             L_ELEV_PRIZE_SPRITE_DATA:	
14387  3DBA 5B          		.byte	91		; x coord 
14388  3DBB 73          		.byte	$73 	; sprite number (Pauline's hat)
14389  3DBC 0A          		.byte	$0A 	; palette
14390  3DBD C8          		.byte	200		; y coord
14391  3DBE             		
14392  3DBE E3          		.byte	227		; x coord 
14393  3DBF 74          		.byte	$74 	; sprite number	(Pauline's purse)
14394  3DC0 0A          		.byte	$0A 	; palette
14395  3DC1 60          		.byte	96		; y coord
14396  3DC2             		
14397  3DC2 1B          		.byte	27		; x coord 
14398  3DC3 75          		.byte	$75 	; sprite number (Pauline's umbrella)
14399  3DC4 0A          		.byte	$0A 	; palette
14400  3DC5 80          		.byte	128		; y coord
14401  3DC6             ;------------------------------------------------------------------------------
14402  3DC6             
14403  3DC6             
14404  3DC6             
14405  3DC6             ;------------------------------------------------------------------------------
14406  3DC6             ; Sprite data for bonus prizes on the rivets stage
14407  3DC6             L_RIVETS_PRIZE_SPRITE_DATA:	
14408  3DC6 DB          		.byte	219		; x coord 
14409  3DC7             		
14410  3DC7 73          .byte	$73 	; sprite number (Pauline's hat)
14411  3DC8 0A          		.byte	$0A 	; palette
14412  3DC9 C8          		.byte	200		; y coord
14413  3DCA             		
14414  3DCA 93          		.byte	147		; x coord 
14415  3DCB 74          		.byte	$74 	; sprite number	(Pauline's purse)
14416  3DCC 0A          		.byte	$0A 	; palette
14417  3DCD F0          		.byte	240		; y coord
14418  3DCE             		
14419  3DCE 33          		.byte	51		; x coord 
14420  3DCF 75          		.byte	$75 	; sprite number (Pauline's umbrella)
14421  3DD0 0A          		.byte	$0A 	; palette
14422  3DD1 50          		.byte	80		; y coord
14423  3DD2             ;------------------------------------------------------------------------------
14424  3DD2             
14425  3DD2             
14426  3DD2             
14427  3DD2             ;------------------------------------------------------------------------------
14428  3DD2             ; Sprite data for the elevator platforms on the elevators stage
14429  3DD2             L_ELEVATOR_SPRITE_DATA:	
14430  3DD2 44          		.byte	$44		; Elevator platform sprite
14431  3DD3 03          		.byte	$03		; Palette
14432  3DD4 08          		.byte	8
14433  3DD5 04          		.byte	4
14434  3DD6             ;------------------------------------------------------------------------------
14435  3DD6             
14436  3DD6             
14437  3DD6             
14438  3DD6             ;------------------------------------------------------------------------------
14439  3DD6             ; The initial coordinates for the elevators on the elevators stage
14440  3DD6             L_ELEVATOR_COORDS:	
14441  3DD6 37          		.byte	55	; X coordinate
14442  3DD7 F4          		.byte	244	; Y coordinate
14443  3DD8             		
14444  3DD8 37          		.byte	55	; X coordinate
14445  3DD9 C0          		.byte	192	; Y coordinate
14446  3DDA             		
14447  3DDA 37          		.byte	55	; X coordinate
14448  3DDB 8C          		.byte	140	; Y coordinate
14449  3DDC             		
14450  3DDC 77          		.byte	119	; X coordinate
14451  3DDD 70          		.byte	112	; Y coordinate
14452  3DDE             		
14453  3DDE 77          		.byte	119	; X coordinate
14454  3DDF A4          		.byte	164	; Y coordinate
14455  3DE0             		
14456  3DE0 77          		.byte	119	; X coordinate
14457  3DE1 D8          		.byte	$D8	; Y coordinate
14458  3DE2             ;------------------------------------------------------------------------------
14459  3DE2             
14460  3DE2             
14461  3DE2             
14462  3DE2             ;------------------------------------------------------------------------------
14463  3DE2             ; Determine the amount of points to award the player
14464  3DE2             ; passed: 	a - (pointAwardType) rotated right 1 bit
14465  3DE2             ; return: 	de - function call to pass to the AddFunctionToUpdateList function
14466  3DE2             ;             	 ($0001 = award 100 points
14467  3DE2             ;             	  $0003 = award 300 points
14468  3DE2             ;             	  $0005 = award 500 points)
14469  3DE2             ;         	b - the point sprite to display
14470  3DE2             DETERMINE_POINT_AWARD_AMT: 	
14471  3DE2 11 01 00    		ld		de,1		
14472  3DE5 06 7B       		ld		b,$7b						; 200 point award sprite
14473  3DE7 1F          		rra
14474  3DE8 D2 0F 1E    		jp		nc,l1e28
14475  3DEB             		
14476  3DEB 1E 03       		ld		e,3
14477  3DED 06 7D       		ld		b,$7d						; 300 point award sprite
14478  3DEF 1F          		rra
14479  3DF0 D2 0F 1E    		jp		nc,l1e28
14480  3DF3             		
14481  3DF3             		; NOTE: There appears to be a bug here
14482  3DF3             		;       500 points are awarded, but the
14483  3DF3             		;       800 point sprite is displayed
14484  3DF3             		;       (de is set to 5 = 500 points,
14485  3DF3             		;        but b is set to $7f = 800 point sprite)
14486  3DF3 1E 05       		ld		e,5
14487  3DF5 06 7F       		ld		b,$7f						; 800 point award sprite
14488  3DF7 C3 0F 1E    		jp		l1e28
14489  3DFA             ;------------------------------------------------------------------------------
14490  3DFA             
14491  3DFA             
14492  3DFA             
14493  3DFA             ;------------------------------------------------------------------------------
14494  3DFA 3A 27 62    l3e88: 	ld		a,($6227)
14495  3DFD E5          		push	hl
14496  3DFE EF          		rst		$28
14497  3DFF             		; Jump table
14498  3DFF 00 00       		.word	L_ORG	; 0 = reset game
14499  3E01 0B 3E       		.word	l3e99	; 1 = 
14500  3E03 43 28       		.word	L_MIXER_ENEMY_COLLISION	; 2 = 
14501  3E05 71 28       		.word	L_ELEVATOR_ENEMY_COLLISION	; 3 =
14502  3E07 92 28       		.word	L_RIVETS_ENEMY_COLLISION	; 4 = 
14503  3E09 00 00       		.word	L_ORG	; 5 = reset game
14504  3E0B             ;------------------------------------------------------------------------------
14505  3E0B             
14506  3E0B             
14507  3E0B             ;------------------------------------------------------------------------------
14508  3E0B             l3e99:	
14509  3E0B E1          		pop		hl
14510  3E0C AF          		xor		a
14511  3E0D 32 60 60    		ld 		($6060),a
14512  3E10 06 0A       		ld 		b,10
14513  3E12 11 20 00    		ld 		de,32
14514  3E15 DD 21 00 67 		ld 		ix,BARREL_STRUCTS
14515  3E19 CD 35 3E    		call	l3ec3
14516  3E1C 06 05       		ld		b,5
14517  3E1E DD 21 00 64 		ld		ix,FIREBALL_STRUCTS
14518  3E22 CD 35 3E    		call	l3ec3
14519  3E25 3A 60 60    		ld		a,($6060)
14520  3E28 A7          		and		a
14521  3E29 C8          		ret		z
14522  3E2A             
14523  3E2A FE 01       		cp		$01
14524  3E2C C8          		ret		z
14525  3E2D             
14526  3E2D FE 03       		cp		$03
14527  3E2F 3E 03       		ld		a,$03
14528  3E31 D8          		ret		c
14529  3E32             
14530  3E32 3E 07       		ld 		a,$07
14531  3E34 C9          		ret
14532  3E35             ;------------------------------------------------------------------------------
14533  3E35             
14534  3E35             
14535  3E35             
14536  3E35             ;------------------------------------------------------------------------------
14537  3E35 DD CB 00 46 l3ec3:	bit		0,(ix+0)
14538  3E39 CA 6C 3E    		jp		z,l3efa
14539  3E3C 79          		ld		a,c
14540  3E3D DD 96 05    		sub		(ix+5)
14541  3E40 D2 45 3E    		jp		nc,l3ed3
14542  3E43 ED 44       		neg
14543  3E45 3C          l3ed3:	inc		a
14544  3E46 95          		sub		l
14545  3E47 DA 50 3E    		jp		c,l3ede
14546  3E4A DD 96 0A    		sub		(ix+10)
14547  3E4D D2 6C 3E    		jp		nc,l3efa
14548  3E50 FD 7E 03    l3ede:	ld		a,(iy+3)
14549  3E53 DD 96 03    		sub		(ix+3)
14550  3E56 D2 5B 3E    		jp		nc,l3ee9
14551  3E59 ED 44       		neg
14552  3E5B 94          l3ee9:	sub		h
14553  3E5C DA 65 3E    		jp		c,l3ef3
14554  3E5F DD 96 09    		sub		(ix+9)
14555  3E62 D2 6C 3E    		jp		nc,l3efa
14556  3E65 3A 60 60    l3ef3:	ld		a,($6060)
14557  3E68 3C          		inc		a
14558  3E69 32 60 60    		ld		($6060),a
14559  3E6C DD 19       l3efa:	add		ix,de
14560  3E6E 10 C5       		djnz	l3ec3
14561  3E70 C9                  ret
14562  3E71             ;------------------------------------------------------------------------------
14563  3E71             
14564  3E71             
14565  3E71             
14566  3E71             ;------------------------------------------------------------------------------
14567  3E71             ; "1981"
14568  3E71             L_1981_STRING_DATA: 	
14569  3E71 5C 76       		.word	TILE_COORD(18, 28)
14570  3E73 49 4A 01 09 		.byte	$49, $4A, $01, $09, $08, $01
14570  3E77 08 01 
14571  3E79 3F          		.byte	$3F		; End of string
14572  3E7A             		
14573  3E7A             
14574  3E7A             ; "NINTENDO OF AMERICA INC."
14575  3E7A             L_NINTENDO_STRING_DATA: 	
14576  3E7A 7D 77       		.word	$TILE_COORD(27, 29)
14577  3E7C 1E          		.byte	$1E
14578  3E7D             L_NINTENDO_STRING_DATA_1:	
14579  3E7D 19 1E 24 15 		.byte	$19, $1E, $24, $15, $1E, $14, $1F, $10, $1F, $16, $10, $11, $1d, $15, $22, $19, $13, $11, $10, $19, $1E, $13, $2B
14579  3E81 1E 14 1F 10 
14579  3E85 1F 16 10 11 
14579  3E89 1D 15 22 19 
14579  3E8D 13 11 10 19 
14579  3E91 1E 13 2B 
14580  3E94 3F          		.byte	$3F		; End of string		
14581  3E95             ;------------------------------------------------------------------------------
14582  3E95             
14583  3E95             
14584  3E95             
14585  3E95             ;------------------------------------------------------------------------------
14586  3E95             ; Display (TM)
14587  3E95             L_DISPLAY_TM:	
14588  3E95 21 AF 74    		ld      hl,TILE_COORD(5,15)
14589  3E98 11 E0 FF    		ld      de,-32
14590  3E9B 36 9F       		ld      (hl),$9f    ; Display '(T'
14591  3E9D 19          		add     hl,de       ; hl=(4, 15)
14592  3E9E 36 9E       		ld      (hl),$9e    ; Display 'M)'
14593  3EA0 C9          		ret     
14594  3EA1             ;------------------------------------------------------------------------------
14595  3EA1             
14596  3EA1             
14597  3EA1             
14598  3EA1             ;------------------------------------------------------------------------------
14599  3EA1             ; I don't quite understand why this function is needed
14600  3EA1             ; It just displays the retractable ladders in the mixers level and jumps 
14601  3EA1             ; to the routine that completes the stage initialization
14602  3EA1             L_WIERD_DISPLAY_STAGE_FN:	
14603  3EA1 CD A7 3E    		call	L_DISPLAY_MIXER_LADDERS
14604  3EA4 C3 5C 0D    		jp		L_COMPLETE_STAGE_INIT
14605  3EA7             ;------------------------------------------------------------------------------
14606  3EA7             		
14607  3EA7             
14608  3EA7             
14609  3EA7             ;------------------------------------------------------------------------------
14610  3EA7             ; If the current stage is the mixer stage (2), draw the ladders for that level
14611  3EA7             ; otherwise return immediately.
14612  3EA7             L_DISPLAY_MIXER_LADDERS:  
14613  3EA7             		; Return unless this is the rivets stage
14614  3EA7 3E 02       		ld      a,2		
14615  3EA9 F7                  rst     $30							
14616  3EAA             		
14617  3EAA 06 02               ld      b,2							; For b = 2 to 1
14618  3EAC 21 6C 77            ld      hl,TILE_COORD(27,12)
14619  3EAF 36 10       l3fae:  ld      (hl),$10					; Display ' ' at hl
14620  3EB1 23                  inc     hl			
14621  3EB2 23          l3fb1:  inc     hl							; hl += 2 rows
14622  3EB3 36 C0               ld      (hl),$c0					; Display ladder at hl
14623  3EB5 21 8C 74            ld      hl,TILE_COORD(4,12)
14624  3EB8 10 F5               djnz    l3fae						; next b
14625  3EBA C9                  ret     
14626  3EBB             ;------------------------------------------------------------------------------
14627  3EBB             
14628  3EBB             
14629  3EBB             
14630  3EBB             ;------------------------------------------------------------------------------
14631  3EBB             ; Called when Mario starts climbing a ladder.
14632  3EBB             ; Set Mario's sprite to the climbing sprite and returns the address of
14633  3EBB             ; marioSpriteY
14634  3EBB             ;
14635  3EBB             ; passed:	none
14636  3EBB             ; return:	hl - address of Mario's sprite y coordinate
14637  3EBB             L_SET_MARIO_SPRITE_TO_CLIMBING:  
14638  3EBB             		; Set Mario's sprite to 3
14639  3EBB 21 4D 69    		ld      hl,MARIO_SPRITE_NUM
14640  3EBE 36 03               ld      (hl),3
14641  3EC0 2C                  inc     l
14642  3EC1 2C                  inc     l							; MARIO_SPRITE_Y
14643  3EC2 C9                  ret     
14644  3EC3             ;------------------------------------------------------------------------------
14645  3EC3             
14646  3EC3             
14647  3EC3             
14648  3EC3             ;------------------------------------------------------------------------------
14649  3EC3             ; Generate an error if the program goes over the 16K limit
14650  3EC3             	.echo "NOTE: ROM size is "
14651  3EC3             	.echo $
14652  3EC3             	.echo " bytes"
14653  3EC3~            #if ($ > $4000)
14654  3EC3~            	.echo "\nERROR: 16K limit exceeded!\n"
14655  3EC3~            	!!!ERROR:_16K_LIMIT_EXCEEDED!!!
14656  3EC3             #else
14657  3EC3             	.echo ", leaving "
14658  3EC3             	.echo $4000 - $
14659  3EC3             	.echo " bytes free\n"
14660  3EC3             #endif
14661  3EC3             ;------------------------------------------------------------------------------
14662  3EC3             
14663  3EC3             
14664  3EC3             
14665  3EC3             ;------------------------------------------------------------------------------
14666  3EC3             ; Many routines jump here to abort the game
14667  4000             		.org $4000
14668  4000             l4000:
14669  4000                     .end
14670  4000             ;------------------------------------------------------------------------------
14671  4000             



Label        Value      Label        Value      Label        Value
------------------      ------------------      ------------------
AWARD_SOUND_TRIGGER 6085      ACTION_BUFFER_WRITE_POS 60B0      ACTION_BUFFER_READ_POS 60B1      
ANIMATION_TIMER 6390      ACTIVE_FIREBALL_COUNT 63A1      AWARD_SPRITE  6A30      
AWARD_SPRITE_X 6A30      AWARD_SPRITE_NUM 6A31      AWARD_SPRITE_PAL 6A32      
AWARD_SPRITE_Y 6A33      BRK_LADDER_TILE 0001      BLANK_TILE    0004      
BLANK_CP_HIGH_SCORE 6031      BLINK_SCORE_TIMER 6032      BOT_OF_CURRENT_LADDER 621C      
BOT_MASTER_REVERSE_TIMER 62A5      BOT_MASTER_CONVEYER_DIR 62A6      BARREL_FIRE_FREEZE 62B8      
BARREL_FIRE_STATE 62B9      BARREL_FIRE_FLARE_UP_TIME 62BA      BROKEN_LADDER_X_COORD_DATA 6310      
BROKEN_LADDER_Y1_COORD_DATA 6325      BROKEN_LADDER_Y2_COORD_DATA 633A      BARREL_FIRE_STATUS 6348      
BOT_CONVEYER_DIR 63A6      BARREL_FIRE_STRUCT 66A0      BARREL_STRUCTS 6700      
BARREL_FIRE_SPRITE 6A28      BARREL_FIRE_SPRITE_X 6A28      BARREL_FIRE_SPRITE_NUM 6A29      
BARREL_FIRE_SPRITE_PAL 6A2A      BARREL_FIRE_SPRITE_Y 6A2B      CIR_GIRDER_TILE 0005      
COIN_VALID    6003      CURRENT_PLAYER 600D      COUNTER_1     6019      
COUNTER_2     601A      CABINET_TYPE  6026      CABINET_TYPE_COCKTAIL 0000      
CABINET_TYPE_UPRIGHT 0001      CURRENT_SCORE_STRING 61B1      CURRENT_STAGE 6227      
CP_DATA       6228      CP_NUMBER_LIVES 6228      CP_LEVEL_NUMBER 6229      
CP_STAGE_ORDER_POINTER 622A      CP_INTRO_NOT_DISPLAYED 622C      CP_BONUS_LIFE_AWARDED 622D      
CP_HEIGHT_INDEX 622E      CP_STAGE_ORDER_POINTER_LAG 622F      CP_DIFFICULTY 6380      
CURRENT_STATE_VAR_POINTER 63C0      CURRENT_FIREBALL 63C8      COLLISION_AREA_STRUCT 64A0      
COLLISION_AREA_SPRITES 6950      COLLISION_AREA_SPRITE_1 6950      COLLISION_AREA_SPRITE_2 6954      
CONVEYER_MOTOR_SPRITES 69E4      CONV_MOTOR_SPRITE_TL 69E4      CONV_MOTOR_SPRITE_TL_X 69E4      
CONV_MOTOR_SPRITE_TL_NUM 69E5      CONV_MOTOR_SPRITE_TL_PAL 69E6      CONV_MOTOR_SPRITE_TL_Y 69E7      
CONV_MOTOR_SPRITE_TR 69E8      CONV_MOTOR_SPRITE_TR_X 69E8      CONV_MOTOR_SPRITE_TR_NUM 69E9      
CONV_MOTOR_SPRITE_TR_PAL 69EA      CONV_MOTOR_SPRITE_TR_Y 69EB      CONV_MOTOR_SPRITE_MR 69EC      
CONV_MOTOR_SPRITE_MR_X 69EC      CONV_MOTOR_SPRITE_MR_NUM 69ED      CONV_MOTOR_SPRITE_MR_PAL 69EE      
CONV_MOTOR_SPRITE_MR_Y 69EF      CONV_MOTOR_SPRITE_ML 69F0      CONV_MOTOR_SPRITE_ML_X 69F0      
CONV_MOTOR_SPRITE_ML_NUM 69F1      CONV_MOTOR_SPRITE_ML_PAL 69F2      CONV_MOTOR_SPRITE_ML_Y 69F3      
CONV_MOTOR_SPRITE_BL 69F4      CONV_MOTOR_SPRITE_BL_X 69F4      CONV_MOTOR_SPRITE_BL_NUM 69F5      
CONV_MOTOR_SPRITE_BL_PAL 69F6      CONV_MOTOR_SPRITE_BL_Y 69F7      CONV_MOTOR_SPRITE_BR 69F8      
CONV_MOTOR_SPRITE_BR_X 69F8      CONV_MOTOR_SPRITE_BR_NUM 69F9      CONV_MOTOR_SPRITE_BR_PAL 69FA      
CONV_MOTOR_SPRITE_BR_Y 69FB      DIP_NUM_LIVES 6020      DIP_BONUS_LIFE 6021      
DIP_COINS_PER_CREDIT 6024      DIP_PLAYS_PER_CREDIT 6025      DEATH_SOUND_TRIGGER 6088      
DK_CLIMBING_COUNTER 62AF      DK_STOMPING   6393      DEATH_ANIMATION_STATE 639D      
DEATH_ANIMATION_COUNTER 639E      DK_DISTANCE_TO_LADDER 63B7      DEMO_INPUT_INDEX 63CC      
DEMO_INPUT_REPEAT 63CD      DK_SPRITES    6908      DK_SPRITE_1_X 6908      
DK_SPRITE_1_NUM 6909      DK_SPRITE_1_PAL 690A      DK_SPRITE_1_Y 690B      
DK_SPRITE_2_X 690C      DK_SPRITE_2_NUM 690D      DK_SPRITE_2_PAL 690E      
DK_SPRITE_2_Y 690F      DK_SPRITE_3_X 6910      DK_SPRITE_3_NUM 6911      
DK_SPRITE_3_PAL 6912      DK_SPRITE_3_Y 6913      DK_SPRITE_4_X 6914      
DK_SPRITE_4_NUM 6915      DK_SPRITE_4_PAL 6916      DK_SPRITE_4_Y 6917      
DK_SPRITE_5_X 6918      DK_SPRITE_5_NUM 6919      DK_SPRITE_5_PAL 691A      
DK_SPRITE_5_Y 691B      DK_SPRITE_6_X 691C      DK_SPRITE_6_NUM 691D      
DK_SPRITE_6_PAL 691E      DK_SPRITE_6_Y 691F      DK_SPRITE_7_X 6920      
DK_SPRITE_7_NUM 6921      DK_SPRITE_7_PAL 6922      DK_SPRITE_7_Y 6923      
DK_SPRITE_8_X 6924      DK_SPRITE_8_NUM 6925      DK_SPRITE_8_PAL 6926      
DK_SPRITE_8_Y 6927      DK_SPRITE_9_X 6928      DK_SPRITE_9_NUM 6929      
DK_SPRITE_9_PAL 692A      DK_SPRITE_9_Y 692B      DK_SPRITE_10_X 692C      
DK_SPRITE_10_NUM 692D      DK_SPRITE_10_PAL 692E      DK_SPRITE_10_Y 692F      
DK_STARS_SPRITE 6A24      DK_STARS_SPRITE_X 6A24      DK_STARS_SPRITE_NUM 6A25      
DK_STARS_SPRITE_PAL 6A26      DK_STARS_SPRITE_Y 6A27      DIP_INPUT     7D80      
DEATH_SOUND_OUTPUT 7D80      DETERMINE_POINT_AWARD_AMT 3DE2      ELEVATOR_SPAWN_TIMER 62A7      
ELEVATOR_STRUCTS 6600      ELEVATOR_STRUCT_1 6600      ELEVATOR_STRUCT_2 6610      
ELEVATOR_STRUCT_3 6620      ELEVATOR_STRUCT_4 6630      ELEVATOR_STRUCT_5 6640      
ELEVATOR_STRUCT_6 6650      ELEVATOR_PLATFORM_SPRITES 6958      ELEVATOR_PLATFORM_SPRITE_1 6958      
ELEVATOR_PLATFORM_SPRITE_2 695C      ELEVATOR_PLATFORM_SPRITE_3 6960      ELEVATOR_PLATFORM_SPRITE_4 6964      
ELEVATOR_PLATFORM_SPRITE_5 6968      ELEVATOR_PLATFORM_SPRITE_6 696C      ELEVATOR_MOTOR_SPRITE_DATA 6970      
ELEVATOR_MOTOR_SPRITE_1 6970      ELEVATOR_MOTOR_SPRITE_1_X 6970      ELEVATOR_MOTOR_SPRITE_1_NUM 6971      
ELEVATOR_MOTOR_SPRITE_1_PAL 6972      ELEVATOR_MOTOR_SPRITE_1_Y 6973      ELEVATOR_MOTOR_SPRITE_2 6974      
ELEVATOR_MOTOR_SPRITE_2_X 6974      ELEVATOR_MOTOR_SPRITE_2_NUM 6975      ELEVATOR_MOTOR_SPRITE_2_PAL 6976      
ELEVATOR_MOTOR_SPRITE_2_Y 6977      ELEVATOR_MOTOR_SPRITE_3 6978      ELEVATOR_MOTOR_SPRITE_3_X 6978      
ELEVATOR_MOTOR_SPRITE_3_NUM 6979      ELEVATOR_MOTOR_SPRITE_3_PAL 697A      ELEVATOR_MOTOR_SPRITE_3_Y 697B      
ELEVATOR_MOTOR_SPRITE_4 697C      ELEVATOR_MOTOR_SPRITE_4_X 697C      ELEVATOR_MOTOR_SPRITE_4_NUM 697D      
ELEVATOR_MOTOR_SPRITE_4_PAL 697E      ELEVATOR_MOTOR_SPRITE_4_Y 697F      FALL_SOUND_TRIGGER 6084      
FIREBALL_STRUCTS 6400      FIREBALL_STRUCT_1 6400      FIREBALL_STRUCT_2 6420      
FIREBALL_STRUCT_3 6440      FIREBALL_STRUCT_4 6460      FIREBALL_STRUCT_5 6480      
FIREBALL_SPRITES 69D0      FIREBALL_SPRITE_1 69D0      FIREBALL_SPRITE_2 69D4      
FIREBALL_SPRITE_3 69D8      FIREBALL_SPRITE_4 69DC      FIREBALL_SPRITE_5 69E0      
FALL_SOUND_OUTPUT 7D04      FIREBALL_BOB_TABLE_LENGTH 0012      GAME_STATE    6005      
GAME_STATE_INIT 0000      GAME_STATE_ATTRACT 0001      GAME_STATE_COIN 0002      
GAME_STATE_PLAY 0003      GAME_SUBSTATE 600A      GAME_SUBSTATE_ATTRACT_COIN 0000      
GAME_SUBSTATE_ATTRACT_INIT 0001      GAME_SUBSTATE_ATTRACT_MARIO 0002      GAME_SUBSTATE_ATTRACT_RUN 0003      
GAME_SUBSTATE_PLAY_ORIENT 0000      GAME_SUBSTATE_PLAY_INIT_P1 0001      GAME_SUBSTATE_PLAY_START_P1 0002      
GAME_SUBSTATE_PLAY_INIT_P2 0003      GAME_SUBSTATE_PLAY_START_P2 0004      GAME_SUBSTATE_PLAY_PLAYER_INFO 0005      
GAME_SUBSTATE_PLAY_PREPARE 0006      GAME_SUBSTATE_PLAY_INTRO 0007      GAME_SUBSTATE_PLAY_INTERMISSION 0008      
GAME_SUBSTATE_PLAY_STAGE 000A      GAME_SUBSTATE_PLAY_MARIO 000B      HIGH_SCORE_TABLE 6100      
HIGH_SCORE_TABLE_ENTRY_1 6100      HIGH_SCORE_TABLE_ENTRY_2 6122      HIGH_SCORE_TABLE_ENTRY_3 6144      
HIGH_SCORE_TABLE_ENTRY_4 6166      HIGH_SCORE_TABLE_ENTRY_5 6188      HAMMER_CYCLE_ACTIVE 6217      
HAMMER_GRABBED 6218      HEIGHT_25M    0000      HEIGHT_50M    0001      
HEIGHT_75M    0002      HEIGHT_100M   0003      HEIGHT_125M   0004      
HEIGHT_150M   0005      HAMMER_CYCLE_COUNTER 6394      HAMMER_CYCLE_WRAP_COUNTER 6395      
HAMMER_STRUCTS 6680      HAMMER_STRUCT_1 6680      HAMMER_STRUCT_2 6690      
HAMMER_SPRITES 6A18      HAMMER_SPRITE_1 6A18      HAMMER_SPRITE_2 6A1C      
HEART_SPRITE  6A20      HEART_SPRITE_X 6A20      HEART_SPRITE_NUM 6A21      
HEART_SPRITE_PAL 6A22      HEART_SPRITE_Y 6A23      INITIALS_TIMER_VALUE 6033      
INITIALS_TIMER_DELAY 6034      INITIALS_COORD 6036      INITIALS_ADDRESS 603A      
INTERNAL_TIMER 62B0      INTRODUCTION_STATE 6385      INTERM_HEIGHT_STRING_INDEX 63A7      
INTERM_HEIGHT_STRING_COORD 63A8      INTERRUPT_ENABLE 7D84      JOYSTICK_INPUT_DELAY 6030      
JUMP_SOUND_TRIGGER 6081      JUMP_SOUND_OUTPUT 7D01      LADDER_TILE   0000      
L_RETRACT_LADDER_DATA 6280      L_RETRACT_LADDER_STATE 6280      L_RETRACT_LADDER_DELAY 6281      
L_RETRACT_LADDER_X 6282      L_RETRACT_LADDER_Y 6283      L_RETRACT_LADDER_MOVE_DELAY 6284      
LEFT_MASTER_CONVEYER_DIR 62A4      LADDER_ROW_TO_ERASE 638E      LEFT_CONVEYER_DIR 63A4      
LADDER_JUMP_VECTOR_POINTER 63C2      L_RETRACT_LADDER_SPRITE 6944      L_RETRACT_LADDER_SPRITE_X 6944      
L_RETRACT_LADDER_SPRITE_NUM 6945      L_RETRACT_LADDER_SPRITE_PAL 6946      L_RETRACT_LADDER_SPRITE_Y 6947      
L_ORG         0000      L_MOVE_N_SPRITES 003D      L_LOAD_DK_SPRITES 004E      
L_UPDATE_RAND_NUM 0057      L_INTERRUPT_HANDLER 0066      L_POP_REGISTERS_FROM_STACK 00D2      
L_PLAY_SOUNDS 00E0      L_SOUNDS_OFF  011C      L_P8257_REGISTER_DATA 0138      
L_CONFIG_P8257 0141      L_CHECK_FOR_COIN 017B      L_INITIAL_SCORE_DATA 01BA      
L_BLANK_SCORE_DATA 01BF      L_INIT_ATTRACT_MODE 01C3      L_LOAD_DIP_SETTINGS 0207      
L_INIT_GAME   0266      L_MAIN_LOOP   02BD      L_PROCESS_ACTION_BUFFER 02E3      
L_DISPLAY_NUP 0315      L_RETURN_NUP_COORD 0347      L_AWARD_BONUS_LIFE 0350      
L_INCREASE_DIFFICULTY 037F      L_IMPLEMENT_BARREL_FIRE 03A2      L_TOGGLE_FIRE_SPRITES 03F2      
L_ANIMATE_DK_AND_PAULINE 03FB      L_DISPLAY_OR_CLEAR_HELP 0514      L_AWARD_POINTS 051C      
L_GET_PLAYER_SCORE 055F      L_DISPLAY_PLAYER_SCORE 056B      L_DISPLAY_HIGH_SCORE 0578      
L_DISPLAY_HIGH_SCORE_2 057C      L_DISPLAY_SCORE_DIGIT 0593      L_ZERO_SCORES 059B      
L_DISPLAY_SCORES 05C6      L_DISPLAY_STRING 05E9      L_DISPLAY_CREDITS 0611      
L_DISPLAY_CREDITS_2 0616      L_PROCESS_TIMER 062A      L_DISPLAY_LIVES_AND_LEVEL 06B8      
L_IMPLEMENT_GAME_PLAY 06FE      L_IMPLEMENT_ATTRACT_MODE 073C      L_PROMPT_FOR_START 075C      
L_PREPARE_DEMO_MODE 0763      L_INSERT_COINS_SCREEN 0779      L_CLEAN_UP_DEMO_MODE 07C3      
L_FLASH_DK_TITLE_SCREEN 07CB      L_FREEZE_DK_TITLE_SCREEN 084A      L_CLEAR_SCREEN_AND_SPRITES 0851      
L_CLEAR_STAGE_SCREEN 0873      L_WAITING_FOR_START_MODE 08B1      L_DISPLAY_PUSH_START_SCREEN 08B9      
L_HANDLE_START_BUTTONS 08F7      L_INITIAL_PLAYER_DATA_TABLE 095D      L_DISPLAY_HIGH_SCORES 0964      
L_SUBTRACT_ONE_PLAY 0976      L_ORIENT_SCREEN 0985      L_INIT_P1     09AA      
L_P1_PROMPT_SCREEN 09D5      L_DISPLAY_2UP 09ED      L_INIT_P2     09FD      
L_P2_PROMPT_SCREEN 0A1A      L_DISPLAY_TURN_DATA 0A36      L_DISPLAY_1UP 0A52      
L_PREPARE_SCREEN_FOR_TURN 0A62      L_IMPLEMENT_INTRO_STAGE 0A75      L_DISPLAY_INTRODUCTION_STAGE 0A89      
L_DISPLAY_DK_CLIMBING 0ABE      L_IMPLEMENT_DK_CLIMB_ANIM 0AE7      L_ANIMATE_DK_JUMP_FROM_LAD 0B05      
L_ANIMATE_DK_PLAT_JUMPS 0B67      L_ANIMATE_DK_GRIN_TAUNT 0BB2      L_DISPLAY_INTERMISSION 0BD8      
L_DISPLAY_CURRENT_STAGE 0C8E      L_DISPLAY_CURRENT_STAGE_2 0C8F      L_DISPLAY_RIVETS 0CFD      
L_RIVET_COORD_DATA 0D14      L_DRAW_ELEVATOR_SUPPORTS 0D24      L_DRAW_PAULINE_PLAT_POSTS 0D40      
L_COMPLETE_STAGE_INIT 0D5C      L_DISPLAY_STAGE 0DA4      L_INIT_CURRENT_STAGE 0F53      
L_INIT_BARRELS_STAGE_SPRITES 0FD4      L_INITIAL_BARREL_DATA 1018      L_INIT_MIXER_STAGE_SPRITES 101C      
L_INIT_ELEVATOR_STAGE_SPRITES 1081      L_ELEV_MOTOR_SPRITE_DATA 1113      L_INIT_RIVETS_STAGE_SPRITES 1123      
L_DK_COL_SPRITE_DATA 1170      L_DK_COL_SPRITE_COORD_DATA 1174      L_INIT_SPRING_DATA 1178      
L_INITIAL_SPRING_DATA 1194      L_INIT_HAMMER_SPRITES 1198      L_COPY_STRUCT_TO_SPRITE 11C5      
L_COPY_COORDS_TO_STRUCTS 11DE      L_LOAD_BARREL_FIRE_DATA 11EC      L_LD_SPRITE_DATA_TO_STRUCT 121C      
L_INIT_MARIO  122E      L_IMPLEMENT_DEATH_ANIM 126E      L_PREPARE_DEATH_ANIMATION 127D      
L_ROTATE_MARIO_DEAD_SPRITE 129E      L_CLEAN_UP_DEATH_ANIMATION 12D0      L_POST_DEATH_PROCESSING_P1 12E4      
L_POST_DEATH_PROCESSING_P2 1336      L_ADV_FROM_P1_GAME_OVER 1381      L_ADV_FROM_P2_GAME_OVER 1393      
L_PREPARE_FOR_P2_TURN 139C      L_PREPARE_FOR_P1_TURN 13AD      L_ADD_SCORE_TO_HS_TABLE 13BC      
L_CHECK_FOR_HS_INITIALS 1410      L_RESTART_GAME 1467      L_IMPLEMENT_HS_INITIAL_ENTRY 1478      
L_UPDATE_LETTER_SEL_BOX 15EC      L_IMPLEMENT_STAGE_WIN_ANIM 1607      L_IMPLEMENT_MIXER_WIN_ANIM 1621      
L_IMPLEMENT_RIVETS_WIN_ANIM 1633      L_WIN_STAGE_ANIM_0 1646      L_WIN_STAGE_ANIM_1 1662      
L_WIN_STAGE_ANIM_2 167C      L_MIXER_WIN_STAGE_ANIM_0 1695      L_WAIT_FOR_DK_TO_REACH_LADDERS 16AD      
L_WIN_ANIM_DISPLAY_PAULINE 16FA      L_WIN_STAGE_ANIM_3 1724      L_WIN_STAGE_ANIM_4 1749      
L_HIDE_OFFSCREEN_DK_SPRITES 175E      L_CHECK_IF_DK_SPRITES_HIDDEN 1775      L_ADVANCE_TO_NEXT_STAGE 1780      
L_RIVETS_WIN_STAGE_ANIM_0 17A8      L_CLEAR_AROUND_GAME_OVER 1817      L_RIVETS_WIN_STAGE_ANIM_1 182A      
L_RIVETS_WIN_STAGE_ANIM_2 1860      L_RIVETS_WIN_STAGE_ANIM_3 1871      L_RIVETS_WIN_STAGE_ANIM_4 18B7      
L_PREP_FOR_NEXT_PLAYER 195C      L_RUN_GAME_DEMO 1968      L_RUN_GAME    196B      
L_CHECK_IF_PRIZE_REACHED 19C8      L_IMPLEMENT_POINT_AWARD 1DA7      L_GIVE_POINT_AWARD 1DB3      
L_NO_POINTS_TO_DISPLAY 1E2E      L_DISPLAY_POINT_AWARD_SPRITE 1E2F      L_CHECK_FOR_WIN_CONDITIONS 1E3C      
L_CHECK_FOR_SMASH_ANIM 1E71      L_IMPLEMENT_SMASH_ANIM 1E7B      L_INIT_SMASH_ANIM 1E85      
L_SMASH_ANIM_PHASE_1 1EEE      L_COMPLETE_SMASH_ANIM 1F08      L_LD_SPRITE_DATA_TO_STRUCT_2 219C      
L_DEMO_INPUT_DATA 21B3      L_SIMULATE_DEMO_INPUT 21D0      L_IMPLEMENT_RET_LADDERS 21E9      
L_LADDER_STATE_0 2209      L_CHECK_IF_MARIO_ON_LADDER 2225      L_LADDER_STATE_1 223B      
L_LADDER_STATE_2 227B      L_LADDER_STATE_3 2284      L_UPDATE_LADDER_SPRITE_COORD 229F      
L_MOVE_SPRITE_ALONG_PLAT 2315      L_CHECK_IF_ON_LADDER 2350      L_IMPLEMENT_BARRIERS 2404      
L_PARSE_STAGE_LADDER_DATA 2426      L_MOVE_PIES_ON_CONVEYERS 2565      L_IMPLEMENT_CONVEYERS 25C6      
L_IMPLEMENT_TOP_CONVEYER 25D6      L_IMPLEMENT_MID_CONVEYERS 2603      L_IMPLEMENT_BOT_CONVEYERS 2620      
L_ANIMATE_MOTOR_SPRITES 264D      L_REVERSE_CONVEYER_DIR 2685      L_SET_CONVEYER_SPEED_TO_1 2690      
L_IMPLEMENT_ELEVATORS 26A1      L_MOVE_MARIO_ON_ELEVATORS 26DA      L_MOVE_ELEVATORS 272C      
L_SPAWN_NEW_ELEVATOR 276F      L_CHECK_FOR_ENEMY_COLLISION 279D      L_CHECK_FOR_HAMMER_KILL 27B2      
L_CHECK_FOR_ENEMY_JUMP 27E8      L_IMPL_ENEMY_COLL_FOR_STAGE 2804      L_BARREL_ENEMY_COLLISION 2815      
L_MIXER_ENEMY_COLLISION 2843      L_ELEVATOR_ENEMY_COLLISION 2871      L_RIVETS_ENEMY_COLLISION 2892      
L_CHECK_FOR_COLLISION 28A4      L_IMPLEMENT_HAMMER_GRAB 28E4      L_CHECK_FOR_HAMMER_GRAB 2904      
L_CHECK_IF_NOT_SUPPORTED 291C      L_INTERACT_WITH_ELEVATORS 293F      L_CHECK_FOR_ELEVATOR_COLLISION 29B0      
L_MOVE_MARIO_ON_CONVEYERS 2A61      L_RANDOMLY_RELEASE_FIREBALL 2D5E      L_IMPLEMENT_SPRINGS 2D87      
L_ANIMATE_HAMMER_CYCLE 2E57      L_STAGE_LOC_TO_ADDRESS 2F73      L_ANIMATE_LADDER_PULL_UP 2FCD      
L_ERASE_INTRO_LADDER_TILE 2FE7      L_PAUSE_CURRENT_STATE 2FEC      L_ANIMATE_CLIMBING_LADDERS 2FF2      
L_ALT_DK_ARMS_AND_LEGS 3019      L_ADD_EVENT   3022      L_CLEAR_SPRITES_WHEN_DEAD 3040      
L_CLEAR_MARIO_SPRITE 305E      L_IMPLEMENT_FIREBALLS 3070      L_CONTROL_FIREBALL_SPEED 307D      
L_CONTROL_FIREBALL_SPEED_0_1 3093      L_CONTROL_FIREBALL_SPEED_2 309D      L_CONTROL_FIREBALL_SPEED_3_4 30A7      
L_CONTROL_FIREBALL_SPEED_5 30B1      L_SPAWN_FIREBALLS 30BB      L_PROCESS_EACH_FIREBALL 3127      
L_FIREBALLS_ABRUPT_LEFT 3153      L_ROUGH_25_P_CHANCE 316C      L_UPDATE_CURRENT_FIREBALL 3178      
L_INIT_FIREBALL_FOR_STAGE 3233      L_HANDLE_FIREBALL_PAUSED 324C      L_CHANGE_FIREBALL_DIR 3285      
L_HANDLE_FIREBALLS_AND_LADDERS 32B3      L_ABORT_IF_FIREBALL_TOO_HIGH 3314      L_UPDATE_FIREBALL_WALK 331F      
L_HANDLE_BARREL_PLATS 3335      L_UPDATE_FIREBALL_CLIMB 3359      L_UPDATE_FIREBALL_SPRITE 337B      
L_INIT_FIREBALL_BARRELS 339E      L_INIT_FIREBALL_MIXER 33EA      L_INIT_FIREBALL_RIVETS 342B      
L_UPDATE_FIREBALL_SPRITES 3465      L_POINT_AWARD_TABLE 349B      L_DEFAULT_HIGH_SCORE_DATA 34D7      
L_DEFAULT_HIGH_SCORE_DATA_1 34D7      L_HS_LETTER_COORD_TABLE 3581      L_STRING_TABLE 35BD      
L_GAME_OVER_STRING_DATA 35FD      L_PLAYER_1_STRING_DATA 360A      L_PLAYER_2_STRING_DATA 3617      
L_HIGH_SCORE_STRING_DATA 3624      L_CREDIT_STRING_DATA 3631      L_HOW_HIGH_STRING_DATA 363E      
L_ONLY_1_STRING_DATA 3658      L_1_OR_2_STRING_DATA 366F      L_PUSH_STRING_DATA 3687      
L_REGIS_STRING_DATA 368E      L_NAME_STRING_DATA 36A2      L_UNDERLINE_STRING_DATA 36AA      
L_A_TO_J_STRING_DATA 36B9      L_K_TO_T_STRING_DATA 36CF      L_U_TO_END_STRING_DATA 36E5      
L_REGI_TIME_STRING_DATA 36FD      L_INTRO_STAGE_DATA 377F      L_TIMER_BOX_TILE_DATA 37BC      
L_DK_SPRITES_L_ARM_RAISED 37CE      L_PAULINE_SPRITES_FACE_RIGHT 37F6      L_DK_SPRITES_CLIMBING 37FE      
L_DK_JUMP_FROM_LADDER_DATA 3826      L_DK_JUMP_ACROSS_PLAT_DATA 383D      L_INTRO_DATA_SLOPE6 389E      
L_DK_SPRITES_THROW_BARREL 38A4      L_DK_SPRITES_ARMS_DOWN 38CC      L_DK_SPRITES_GRAB_BARREL 38F4      
L_SPRING_VECTOR_DATA 391C      L_DK_SPRITES_GRIN_L_STOMP 3941      L_DK_SPRITES_GRIN_R_STOMP 3969      
L_DK_SPRITES_GRIN_UD 3991      L_RIVETS_DATA_FALL1 39B9      L_RIVETS_DATA_FALL2 39BF      
L_RIVETS_DATA_FALL3 39C5      L_RIVETS_DATA_FALL4 39CB      L_RIVETS_DATA_FALL_TOP 39D1      
L_STAGE_ORDER_TABLE 39D7      L_STAGE_ORDER_TABLE_LAST 39E5      L_FIREBALL_BOB_TABLE 39EC      
L_OIL_BARREL_JUMP_TABLE_BARRELS 39FE      L_OIL_BARREL_JUMP_TABLE_MIXER 3A1E      L_L_RIVET_SPAWN_COORDS 3A36      
L_R_RIVET_SPAWN_COORDS 3A46      L_BARRELS_STAGE_DATA 3A56      L_MIXER_STAGE_DATA 3ACF      
L_ELEVATORS_STAGE_DATA 3B57      L_RIVETS_STAGE_DATA 3BFD      L_HEIGHT_STRING_TABLE 3C62      
L_LARGE_DK_LETTER_DATA 3C7A      L_INITIAL_STAGE_DATA_TABLE 3D0E      L_STANDING_BARRELS_SPRITE_DATA 3D4E      
L_FIREBALL_SPRITE_DATA 3D5E      L_FIREFOX_SPRITE_DATA 3D62      L_BARRELS_FIRE_SPRITE_DATA 3D66      
L_MIXER_FIRE_SPRITE_DATA 3D6C      L_OIL_BARREL_SPRITE_DATA_1 3D72      L_OIL_BARREL_SPRITE_DATA_2 3D76      
L_HAMMER_SPRITE_DATA 3D7A      L_BARRELS_HAMMER_COORDS 3D7E      L_MIXER_HAMMER_COORDS 3D82      
L_RIVETS_HAMMER_COORDS 3D86      L_PIE_SPRITE_DATA 3D8A      L_RETRACT_LADDER_SPRITE_DATA 3D8E      
L_MIXER_MOTOR_SPRITE_DATA 3D96      L_MIXER_PRIZE_SPRITE_DATA 3DAE      L_ELEV_PRIZE_SPRITE_DATA 3DBA      
L_RIVETS_PRIZE_SPRITE_DATA 3DC6      L_ELEVATOR_SPRITE_DATA 3DD2      L_ELEVATOR_COORDS 3DD6      
L_1981_STRING_DATA 3E71      L_NINTENDO_STRING_DATA 3E7A      L_NINTENDO_STRING_DATA_1 3E7D      
L_DISPLAY_TM  3E95      L_WIERD_DISPLAY_STAGE_FN 3EA1      L_DISPLAY_MIXER_LADDERS 3EA7      
L_SET_MARIO_SPRITE_TO_CLIMBING 3EBB      MAJOR_TIMER   6008      MINOR_TIMER   6009      
MARIO_DATA_STRUCT 6200      MARIO_ALIVE   6200      MARIO_X       6203      
MARIO_Y       6205      MARIO_DATA_SPRITE_NUM 6207      MARIO_DATA_PALETTE 6208      
MARIO_JUMP_Y_COORD 620E      MARIO_JUMPING_LEFT 6210      MARIO_JUMPING_RIGHT 6211      
MARIO_IS_CLIMBING 6215      MARIO_IS_JUMPING 6216      MARIO_HAMMER_CYCLE_DELAY 621E      
MARIO_IS_FALLING 6221      MID_MASTER_REVERSE_TIMER 62A2      MAJOR_COUNTER 6381      
MINOR_COUNTER 6384      MARIO_ON_ELEVATOR 6398      MARIO_SPRITE  694C      
MARIO_SPRITE_X 694C      MARIO_SPRITE_NUM 694D      MARIO_SPRITE_PAL 694E      
MARIO_SPRITE_Y 694F      MISC_INPUT    7D00      MISC_INPUT_COIN_BIT 0007      
MISC_INPUT_START_2P_BIT 0003      MISC_INPUT_START_1P_BIT 0002      MISC_INPUT_TAMPER_BIT 0000      
NUM_PLAYS     6001      NUM_COINS_PENDING 6002      NO_COINS_INSERTED 6007      
NUM_COINS_FOR_1P 6022      NUM_COINS_FOR_2P 6023      NORMAL_LADDER_X_COORD_DATA 6300      
NORMAL_LADDER_Y1_COORD_DATA 6315      NORMAL_LADDER_Y2_COORD_DATA 632A      NUM_ENEMIES_OF_CURRENT_CLASS 63B9      
ONSCREEN_TIMER 638C      OIL_BARREL_SPRITE 69FC      OIL_BARREL_SPRITE_X 69FC      
OIL_BARREL_SPRITE_NUM 69FD      OIL_BARREL_SPRITE_PAL 69FE      OIL_BARREL_SPRITE_Y 69FF      
PLAYER_1      0000      PLAYER_2      0001      PLAYER_INPUT  6010      
PLAYER_INPUT_JUMP_BIT 0007      PLAYER_INPUT_DOWN_BIT 0003      PLAYER_INPUT_UP_BIT 0002      
PLAYER_INPUT_LEFT_BIT 0001      PLAYER_INPUT_RIGHT_BIT 0000      PLAYER_INPUT_LAG 6011      
PLAYER_ID_ADDRESS 6038      P1_DATA       6040      P1_NUMBER_LIVES 6040      
P1_LEVEL_NUMBER 6041      P1_STAGE_ORDER_POINTER 6042      P1_INTRO_NOT_DISPLAYED 6044      
P1_BONUS_AWARDED 6045      P1_HEIGHT_INDEX 6046      P1_STAGE_ORDER_POINTER_LAG 6047      
P2_DATA       6048      P2_NUMBER_LIVES 6048      P2_LEVEL_NUMBER 6049      
P2_STAGE_ORDER_POINTER 604A      P2_INTRO_NOT_DISPLAYED 604C      P2_BONUS_AWARDED 604D      
P2_HEIGHT_INDEX 604E      P2_STAGE_ORDER_POINTER_LAG 604F      PENDING_SONG_TRIGGER 608A      
PENDING_SONG_TRIGGER_REPEAT 608B      PREV_P1_SCORE 60B2      PREV_P2_SCORE 60B5      
PREV_HIGH_SCORE 60B8      POINT_AWARD_STATE 6340      POINT_AWARD_DISPLAY_TIMER 6341      
POINT_AWARD_TYPE 6342      PRE_HAMMER_TUNE 6389      PLATFORM_JUMP_VECTOR_POINTER 63C4      
PIE_STRUCTS   65A0      PAULINE_SPRITES 6900      PAULINE_UPPER_SPRITE_X 6900      
PAULINE_UPPER_SPRITE_NUM 6901      PAULINE_UPPER_SPRITE_PAL 6902      PAULINE_UPPER_SPRITE_Y 6903      
PAULINE_LOWER_SPRITE_X 6904      PAULINE_LOWER_SPRITE_NUM 6905      PAULINE_LOWER_SPRITE_PAL 6906      
PAULINE_LOWER_SPRITE_Y 6907      PIE_SPRITES   69B8      PIE_SPRITE_1  69B8      
PIE_SPRITE_2  69BC      PIE_SPRITE_3  69C0      PIE_SPRITE_4  69C4      
PIE_SPRITE_5  69C8      PIE_SPRITE_6  69CC      PRIZE_SPRITES 6A0C      
PRIZE_SPRITE_1 6A0C      PRIZE_SPRITE_2 6A10      PRIZE_SPRITE_3 6A14      
P1_INPUT      7C00      P1_INPUT_RESET_BIT 0006      P1_INPUT_JUMP_BIT 0005      
P1_INPUT_DOWN_BIT 0003      P1_INPUT_UP_BIT 0002      P1_INPUT_LEFT_BIT 0001      
P1_INPUT_RIGHT_BIT 0000      P2_INPUT      7C80      P2_INPUT_RESET_BIT 0006      
P2_INPUT_JUMP_BIT 0005      P2_INPUT_DOWN_BIT 0003      P2_INPUT_UP_BIT 0002      
P2_INPUT_LEFT_BIT 0001      P2_INPUT_RIGHT_BIT 0000      PALETTE_1_OUTPUT 7D86      
PALETTE_2_OUTPUT 7D87      RANDOM_NUMBER 6018      RETRACTABLE_LADDER_DATA 6280      
R_RETRACT_LADDER_STATE 6288      R_RETRACT_LADDER_DELAY 6289      R_RETRACT_LADDER_X 628A      
R_RETRACT_LADDER_Y 628B      R_RETRACT_LADDER_MOVE_DELAY 628C      REMAINING_RIVETS 6290      
RIGHT_MASTER_CONVEYER_DIR 62A3      RELEASE_SPRING 6396      RELEASE_A_FIREBALL 63A0      
RIGHT_CONVEYER_DIR 63A5      RETRACTABLE_LADDER_SPRITES 6944      R_RETRACT_LADDER_SPRITE 6948      
R_RETRACT_LADDER_SPRITE_X 6948      R_RETRACT_LADDER_SPRITE_NUM 6949      R_RETRACT_LADDER_SPRITE_PAL 694A      
R_RETRACT_LADDER_SPRITE_Y 694B      SLP_GIRDER_TILE 0002      SQR_GIRDER_TILE 0003      
SECOND_PLAYER 600E      SELECTED_LETTER 6035      STOMP_SOUND_TRIGGER 6082      
SPRING_SOUND_TRIGGER 6083      SONG_TRIGGER  6089      SONG_TRIGGER_NONE 0000      
SONG_TRIGGER_INTRODUCTION 0001      SONG_TRIGGER_INTERMISSION 0002      SONG_TRIGGER_OUT_OF_TIME 0003      
SONG_TRIGGER_HAMMER 0004      SONG_TRIGGER_LEVEL_END_2 0005      SONG_TRIGGER_HAMMER_HIT 0006      
SONG_TRIGGER_STAGE_END 0007      SONG_TRIGGER_BG_BARRELS 0008      SONG_TRIGGER_BG_MIXER 0009      
SONG_TRIGGER_BG_ELEVATORS 000A      SONG_TRIGGER_BG_RIVETS 000B      SONG_TRIGGER_LEVEL_END_1 000C      
SONG_TRIGGER_RIVET_REMOVED 000D      SONG_TRIGGER_RIVET_END 000E      SONG_TRIGGER_ROAR 000F      
STAGE_BARRELS 0001      STAGE_MIXER   0002      STAGE_ELEVATORS 0003      
STAGE_RIVETS  0004      STAGE_DATA_BLOCK 6280      SMASHED_SPRITE_POINTER 6343      
SMASH_ANIMATION_STATE 6345      SMASH_ANIMATION_FRAME_DELAY 6346      SMASH_ANIMATION_CYCLE_COUNTER 6347      
SMASH_ANIMATION_ACTIVE 6350      SMASH_ENEMY_CLASS_POINTER 6351      SMASH_ENEMY_DATA_SIZE 6353      
SMASH_ANIMATION_ENEMY_INDEX 6354      STAGE_DEFORM_INDEX 638D      STAGE_DATA_START_ADDRESS 63AB      
STAGE_DATA_END_ADDRESS 63AD      STAGE_DATA_FIRST_Y_OFFSET 63AF      STAGE_DATA_LAST_Y_OFFSET 63B0      
STAGE_DATA_X_DIFF 63B1      STAGE_DATA_Y_DIFF 63B2      STAGE_DATA_TILE_ID 63B3      
STAGE_DATA_UNKNOWN 63B4      STAGE_DATA_CURRENT_TILE 63B5      SPRING_STRUCTS 6500      
SPRITE_STRUCTS 6900      SPRING_SPRITES 6980      SPRING_SPRITE_1 6980      
SPRING_SPRITE_2 6984      SPRING_SPRITE_3 6988      SPRING_SPRITE_4 698C      
SPRING_SPRITE_5 6990      SPRING_SPRITE_6 6994      SPRING_SPRITE_7 6998      
SPRING_SPRITE_8 699C      SPRING_SPRITE_9 69A0      SPRING_SPRITE_10 69A4      
STANDING_BARREL_SPRITE_DATA 69A8      STANDING_BARREL_SPRITE_1 69A8      STANDING_BARREL_SPRITE_1_X 69A8      
STANDING_BARREL_SPRITE_1_NUM 69A9      STANDING_BARREL_SPRITE_1_PAL 69AA      STANDING_BARREL_SPRITE_1_Y 69AB      
STANDING_BARREL_SPRITE_2 69AC      STANDING_BARREL_SPRITE_2_X 69AC      STANDING_BARREL_SPRITE_2_NUM 69AD      
STANDING_BARREL_SPRITE_2_PAL 69AE      STANDING_BARREL_SPRITE_2_Y 69AF      STANDING_BARREL_SPRITE_3 69B0      
STANDING_BARREL_SPRITE_3_X 69B0      STANDING_BARREL_SPRITE_3_NUM 69B1      STANDING_BARREL_SPRITE_3_PAL 69B2      
STANDING_BARREL_SPRITE_3_Y 69B3      STANDING_BARREL_SPRITE_4 69B4      STANDING_BARREL_SPRITE_4_X 69B4      
STANDING_BARREL_SPRITE_4_NUM 69B5      STANDING_BARREL_SPRITE_4_PAL 69B6      STANDING_BARREL_SPRITE_4_Y 69B7      
SMASH_SPRITE  6A2C      SMASH_SPRITE_X 6A2C      SMASH_SPRITE_NUM 6A2D      
SMASH_SPRITE_PAL 6A2E      SMASH_SPRITE_Y 6A2F      SONG_OUTPUT   7C00      
STOMP_SOUND_OUTPUT 7D02      SPRING_SOUND_OUTPUT 7D03      SCREEN_ORIENTATION 7D82      
TWO_PLAYERS   600F      TOP_OF_CURRENT_LADDER 621B      TOP_MASTER_REVERSE_TIMER 62A0      
TOP_MASTER_CONVEYER_DIR 62A1      TITLE_PALETTE_CYCLE_COUNTER 638A      TITLE_PALETTE_PATTERN 638B      
TIME_FOR_DK_ACTION 6391      TOP_CONVEYER_DIR 63A3      TIMER_HAS_RUN_DOWN 63B8      
TIME_RUNNING_OUT_SOUND_OUTPUT 7D09      UPDATED_FIREBALL_COUNT 63A2      WALK_SOUND_TRIGGER 6080      
WIN_ANIMATION_STATE 6388      WALK_SOUND_OUTPUT 7D00      X_TILE        0006      
l0008         0008      l0010         0010      l0018         0018      
l0026         0026      l0032         0032      l0038         0038      
l0044         0044      l0048         0048      l0098         0098      
l009b         009B      l00b5         00B5      l00ed         00ED      
l00f5         00F5      l0108         0108      l010b         010B      
l0118         0118      l0125         0125      l012d         012D      
l0189         0189      l019d         019D      l0221         0221      
l0226         0226      l0241         0241      l0247         0247      
l0259         0259      l026c         026C      l026d         026D      
l0279         0279      l027a         027A      l0288         0288      
l028a         028A      l0298         0298      l02f6         02F6      
l0307         0307      l033e         033E      l0361         0361      
l039e         039E      l03de         03DE      l03e4         03E4      
l0413         0413      l0426         0426      l0448         0448      
l0450         0450      l0464         0464      l0478         0478      
l0485         0485      l0486         0486      l04a1         04A1      
l04a3         04A3      l04ac         04AC      l04be         04BE      
l04e1         04E1      l04f1         04F1      l04f9         04F9      
l0509         0509      l0516         0516      l052e         052E      
l0545         0545      l0550         0550      l0556         0556      
l0583         0583      l05ab         05AB      l05b3         05B3      
l05bd         05BD      l05cb         05CB      l05d5         05D5      
l05da         05DA      l05e0         05E0      l0600         0600      
l060c         060C      l0640         0640      l0655         0655      
l066a         066A      l0689         0689      l0691         0691      
l06a8         06A8      l06b1         06B1      l06c2         06C2      
l06d2         06D2      l06d7         06D7      l06ed         06ED      
l06f0         06F0      l07ad         07AD      l07bc         07BC      
l07da         07DA      l07eb         07EB      l07f4         07F4      
l07fa         07FA      l0801         0801      l082d         082C      
l083b         083A      l0857         0856      l085b         085A      
l0868         0867      l086b         086A      l0879         0878      
l0880         087F      l0893         0892      l0895         0894      
l08a7         08A6      l08ad         08AC      l08d5         08D4      
l08e4         08E3      l08f3         08F2      l0906         0905      
l090f         090E      l0919         0918      l0938         0937      
l0970         096F      l099f         099E      l09a8         09A7      
l09d0         09CF      l0b1e         0B1D      l0b38         0B37      
l0b86         0B85      l0bc8         0BC7      l0bd1         0BCF      
l0c11         0C0F      l0c1f         0C1D      l0c29         0C27      
l0c29a        0C29      l0c2b         0C2B      l0c43         0C40      
l0cc6         0CC3      l0cd4         0CD1      l0cdf         0CDC      
l0cf2         0CEF      l0d05         0D02      l0d0d         0D0A      
l0d30         0D2D      l0d32         0D2F      l0d3d         0D3A      
l0d4c         0D49      l0d4e         0D4B      l0d59         0D56      
l0d8b         0D88      l0dd3         0DD0      l0e19         0E16      
l0e2a         0E27      l0e3f         0E3C      l0e4b         0E48      
l0e4f         0E4C      l0e62         0E5F      l0e78         0E75      
l0ea0         0E9D      l0ec9         0EC6      l0ecf         0ECC      
l0ed3         0ED0      l0ee5         0EE2      l0ee8         0EE5      
l0eff         0EFC      l0f14         0F11      l0f1b         0F18      
l0f2f         0F2C      l0f35         0F32      l0f4c         0F49      
l0f51         0F4E      l0f5b         0F58      l0f5c         0F59      
l0f67         0F64      l0f68         0F65      l0f8e         0F8B      
l0f93         0F90      l0fa2         0F9F      l0fbc         0FB9      
l0fcb         0FC8      l10a0         109A      l10a8         10A0      
l10ad         10A5      l10c3         10B5      l122e         1220      
l124b         123D      l12cb         12BD      l12ed         12DF      
l1322         1314      l1334         1326      l133f         1331      
l137f         1371      l138a         137C      l1395         1387      
l139c         138E      l13da         13CC      l13ed         13DF      
l13fc         13EE      l140a         13FC      l1437         1429      
l1445         1437      l144f         1441      l1459         144B      
l146e         1460      l14c1         14B3      l14c9         14BB      
l14dc         14CE      l14ed         14DF      l14fc         14EE      
l1514         1506      l151d         150F      l152d         151F      
l1539         152B      l1546         1538      l1567         1559      
l156d         155F      l1580         1572      l1586         1578      
l158a         157C      l15a0         1592      l15b8         15AA      
l15c6         15B8      l15d1         15C3      l15df         15D1      
l15ed         15DF      l15f9         15EB      l1622         1614      
l1662         1654      l1686         1678      l16d0         16C2      
l16d5         16C7      l16e1         16D3      l16ee         16E0      
l1774         1766      l177f         1771      l1785         1777      
l179d         178F      l182d         181E      l182f         1820      
l184e         183F      l1859         184A      l190f         1900      
l1910         1901      l1920         1911      l193d         192E      
l194b         193C      l19d2         19C0      l19e2         19D0      
l19ed         19DB      l1a07         19F5      l1a15         1A03      
l1a1e         1A0C      l1a1f         1A0D      l1a2a         1A18      
l1a33         1A21      l1a4b         1A39      l1a51         1A3F      
l1a62         1A50      l1a69         1A57      l1a72         1A60      
l1a7b         1A69      l1a95         1A83      l1a99         1A87      
l1a9e         1A8C      l1abd         1AAB      l1ac3         1AB1      
l1ae6         1AD4      l1af5         1AE3      l1afe         1AEC      
l1b2c         1B17      l1b38         1B23      l1b45         1B30      
l1b4e         1B39      l1b55         1B40      l1b6e         1B59      
l1b8a         1B75      l1bb2         1B9D      l1bd8         1BC3      
l1bec         1BD7      l1bf2         1BDD      l1c05         1BF0      
l1c33         1C1D      l1c3a         1C24      l1c48         1C32      
l1c4f         1C39      l1c76         1C60      l1c8f         1C79      
l1cab         1C95      l1cc2         1CAC      l1cd2         1CBC      
l1ceb         1CD5      l1cf2         1CDC      l1d03         1CED      
l1d11         1CFB      l1d3f         1D29      l1d49         1D33      
l1d51         1D3B      l1d67         1D51      l1d76         1D60      
l1d8a         1D74      l1d8f         1D79      l1d95         1D7F      
l1da6         1D90      l1df5         1DDF      l1e00         1DEA      
l1e08         1DF2      l1e10         1DFA      l1e15         1DFF      
l1e28         1E0F      l1e36         1E1B      l1e6d         1E52      
l1e74         1E59      l1e7a         1E5F      l1e80         1E65      
l1e85         1E6A      l1eb4         1E99      l1ec8         1EAD      
l1ecf         1EB4      l1ede         1EC3      l1f1d         1F02      
l1f34         1F19      l1f46         1F2B      l1f72         1F57      
l1f83         1F68      l1f8d         1F72      l1f93         1F78      
l1fac         1F91      l1fce         1FB3      l1fdf         1FC4      
l1fe5         1FCA      l1fef         1FD4      l1ff6         1FDB      
l202f         2014      l2038         201D      l2053         2038      
l2079         205E      l2083         2068      l209c         2081      
l20a2         2087      l20b5         209A      l20c3         20A8      
l20e1         20C6      l20ec         20D1      l2104         20E9      
l2118         20FD      l2146         212B      l2153         2138      
l215c         2141      l215f         2144      l2160         2145      
l216d         214F      l21a9         218B      l21ae         2190      
l21b2         2194      l2219         21FB      l223a         221C      
l2257         2239      l2275         2257      l2276         2258      
l2281         2263      l228a         226C      l2295         2277      
l22c9         22AB      l22cb         22AD      l22e1         22C3      
l22f6         22D8      l22f9         22DB      l2303         22E5      
l2316         22F8      l231a         22FC      l2326         2308      
l2342         2324      l2347         2329      l2359         233B      
l235a         233C      l235c         233E      l2360         2342      
l2366         2348      l2371         2356      l238f         2374      
l2395         237A      l2398         237D      l239a         237F      
l239c         2381      l23de         23C3      l2403         23E8      
l2407         23EC      l2471         2445      l2478         244C      
l2488         245C      l249e         2472      l24b4         2488      
l24d0         24A4      l24ea         24BE      l24fc         24D0      
l2517         24EB      l251c         24F0      l2523         24F7      
l2539         250D      l2545         2519      l2558         252C      
l2560         2534      l256e         2542      l2576         254A      
l258f         2563      l259a         256E      l25bb         258F      
l25c0         2594      l25cf         25A3      l25d6         25AA      
l25dc         25B0      l25e7         25BB      l2616         25EA      
l264c         2603      l268d         2634      l26b5         265C      
l26c3         266A      l26c5         266C      l26ce         2675      
l26dc         2683      l26e6         268D      l26f8         269F      
l271a         26AF      l271e         26B3      l2722         26B7      
l2734         26C9      l2766         26FB      l276f         2704      
l277f         2714      l2787         271C      l27a0         2735      
l27c2         2757      l27c7         275C      l27e8         277D      
l27f4         2789      l2806         279B      l2826         27BB      
l2832         27C7      l286b         2800      l2915         28A6      
l2925         28B6      l2930         28C1      l293b         28CC      
l2945         28D6      l294c         28DC      l296f         28FF      
l29ac         293C      l29c7         2957      l29d0         2960      
l29ee         297D      l2a08         2997      l2a0e         299D      
l2a1b         29A9      l2a20         29AE      l2a2f         29BD      
l2a63         29F1      l2a69         29F7      l2a6e         29FC      
l2a72         2A00      l2a7b         2A09      l2a7d         2A0B      
l2a85         2A13      l2ab4         2A42      l2acd         2A5B      
l2af0         2A73      l2af6         2A79      l2b02         2A85      
l2b18         2A9B      l2b1a         2A9D      l2b1c         2A9F      
l2b29         2AAC      l2b51         2AD4      l2b53         2AD6      
l2b74         2AF7      l2b7a         2AFD      l2b8b         2B0E      
l2b91         2B14      l2b9b         2B1E      l2bc5         2B48      
l2bcb         2B4E      l2bcf         2B52      l2bd9         2B5C      
l2bdc         2B5F      l2be1         2B64      l2bef         2B72      
l2bf8         2B7B      l2bfd         2B80      l2c03         2B86      
l2c2c         2BAF      l2c33         2BB6      l2c41         2BC4      
l2c49         2BCC      l2c4b         2BCE      l2c4f         2BD2      
l2c69         2BEC      l2c72         2BF5      l2c7b         2BFE      
l2c86         2C09      l2c8f         2C12      l2ca8         2C2B      
l2cb3         2C36      l2cb8         2C3B      l2ce6         2C69      
l2cf6         2C79      l2d15         2C98      l2d2f         2CB2      
l2d51         2CD4      l2d54         2CD7      l2d70         2CF3      
l2d83         2D06      l2d8c         2D0F      l2da5         2D28      
l2dee         2D71      l2df1         2D74      l2e12         2D95      
l2e29         2DAC      l2e4b         2DCE      l2e6c         2DEF      
l2e78         2DFB      l2e84         2E07      l2e9c         2E1F      
l2ea7         2E2A      l2eed         2E70      l2f1b         2E9E      
l2f43         2EC6      l2f7c         2EFF      l2f97         2F1A      
l2fb7         2F3A      l2fbe         2F41      l2fcb         2F4E      
l3009         2F8C      l3017         2F9A      l3022         2FA5      
l302b         2FAE      l3031         2FB4      l3098         301B      
l30b8         303B      l30bb         303E      l30e4         3067      
l30e5         3068      l3103         3086      l3149         30C8      
l316a         30E9      l317c         30FA      l3195         310B      
l31be         3134      l31d0         3146      l3229         319F      
l3230         31A6      l3233         31A9      l3257         31CD      
l3261         31D7      l327a         31F0      l327e         31F4      
l3284         31FA      l3286         31FC      l328c         3202      
l3291         3207      l3297         320D      l32a8         321E      
l32b1         3227      l32b9         322F      l32ce         3244      
l32d2         3248      l32f8         326E      l32fd         3273      
l3303         3279      l330b         3281      l3332         32A8      
l3336         32AC      l3371         32E4      l338a         32FD      
l3399         330C      l33c0         3332      l33d9         334B      
l3401         3373      l3405         3377      l3428         339A      
l3442         33B4      l3445         33B7      l3456         33C8      
l349a         340C      l34a8         341A      l34b3         3425      
l34ca         343C      l34ed         345F      l34fb         346D      
l3517         3489      l351e         3490      l379e         3710      
l37b6         3728      l37d2         3744      l37e1         3753      
l37f4         3766      l3806         3778      l38dc         384E      
l39c3         3935      l39cc         393E      l3cf4         3C66      
l3cf8         3C6A      l3cfc         3C6E      l3d00         3C72      
l3d04         3C76      l3e88         3DFA      l3e99         3E0B      
l3ec3         3E35      l3ed3         3E45      l3ede         3E50      
l3ee9         3E5B      l3ef3         3E65      l3efa         3E6C      
l3fae         3EAF      l3fb1         3EB2      l4000         4000      

tasm: Number of errors = 0
